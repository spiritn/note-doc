- 为了减少每次上线前测试的工作量，有一些基础和重要的功能，必须要测试，如设备的配网，房间体系，分享，设备的告警，设备的升级这些，模拟设备和手机端到端的。我用python 基于pytest 写了测试类，主要基于主干的业务流程，也就是把测试的test case 拿过来，测试整个业务流程，减少测试每次上线前的工作量。以前测试要一天多，现在基于我的测试，测试人员半天就可以准备上线了。基本覆盖了90%的场景，有些注册邮箱，验证码的没法测试。 整个测试类总共5个区，耗时600多秒，retry，连接mq接受消息，解密等。领导部署到jekins，每天执行一次，测试报告发邮件出来，就是这样一个流程

- header头添加时间戳和nonce ，sha算法防止重放攻击，只允许5分钟内的请求。按照restful 风格。

- 美区emqx挂了，自动恢复，一个是机器质量不好，然后增加机器呗。elb自动把连接数转到另一台机器上

- 推送push消息到手机端，push就是系统通知。苹果APNS。FCM 谷歌的firebase Umeng

- 并发编程的semphore的使用处，比如推送apns 时控制下同时的个数，防止内存溢出。mq消息处理

- 普罗米修斯做监控，可以监控多个软件如redismysql,linux还有自己服务的运行状态 .

- grafana 进行性能的监控，

- superset做业务逻辑的监控.每天发邮件通知相关的负责人jedis连接db2数据库，然后再get时会被重置为默认的db0，导致get 失败。nginx 会将http的post请求转为get，很神奇，但是https 就没问题。crdb 负责多个时区之间数据库同步用的okhttp3，然后用retrite 利用注解来实现。kafka设置的批量获取为true ，但是注解监听的单个message ，而不是list，所以极端频繁情况下会丢消息

- 互联网要考虑的事情很多，像是网络抖动真的存在，一个月来那么三四次，把人吓死。这边有良好的监控和测试e2e，出现问题，钉钉日志报错提醒，过一会就好了。找金山云和阿里云，人家就说是网络波动

- 还有遇到有人用各种的请求方式来攻击，领导后来决定用slb 提供的来屏蔽掉请求方式性能测试使用locustio ，mqtt 使用eqmx ，代码开发使用github ，黑苹果系统

- import 注解的作用，gradle的使用

- listutils.patition用来分批插入，不用自己去分集合。pg的upset是指批量插入时可以on conflict do nothing returning xmin，唯一索引冲突时不报错回滚事务，而且可以返回实际插入的行数，xmin表示插入的事务号，更新时为0。注意这时mybatis 的注解要使用select而不能insert，否则拿不到返回的list。

- corturn实现视频的传输，监控流量哪个地区观看视频多验证码用的captcha

- 钉钉因为日志报错太多频繁，有些错误就没提示，坑！业务的频繁的空指针异常把502bad gateway 网关异常给挤掉了，幸亏查找elk日志看到了。云服务器提供的负载均衡emqx ，

  # code review

  总体设计：

  1.如开始是ephyra-manager调用commander，然后调用messenger的流程，对模块划为及模块之间的依赖关系不清晰

  2.ephyra调用messenger，开始设计的通过mq削峰，但这样引入了kafka模块，不合理。

- 类都有自己的职责与功能，不能为了之前的代码，就把新功能放在之前的类里。类太大了也要注意拆分，保持类的简洁与清晰性

- naming和log不要很奇怪，注意逻辑的正确。

- 如何记录日志需要仔细考虑。性能可能出现问题的地方要前后记录，出现分支的关键地方要记录，操作结果，错误信息及要调用其他系统API的地方等反正是关键的地方要记录。日志也要写的清晰点，一个方法是三个月后或者别人看日志能看懂啥意思吗

- 注意合适的方法抽取定义，不要hard code，方法便于测试。如判断当前区域是否是美国，不要hard code，抽取个方法就很合适

- sql语句都保持全部大写，join联结查询时，select 哪个就把哪个表放在前面，并且每个字段都要注明是哪个表的

- 重点也要把握，不要想太多，业务上保证不会出现的问题不必考虑。退一步即使出问题了报错也可以接受。

- 使用stream时最好把每个流操作分行写，这样哪一步流操作出问题，方便在日志里查看哪一行出现错误

- 合适的地方可以使用BeanUtils，减少代码重复

  #  



