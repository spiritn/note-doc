{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Welcome to MkDocs","text":"<p>For full documentation visit mkdocs.org.</p>"},{"location":"#commands","title":"Commands","text":"<ul> <li><code>mkdocs new [dir-name]</code> - Create a new project.</li> <li><code>mkdocs serve</code> - Start the live-reloading docs server.</li> <li><code>mkdocs build</code> - Build the documentation site.</li> <li><code>mkdocs -h</code> - Print help message and exit.</li> </ul>"},{"location":"#project-layout","title":"Project layout","text":"<pre><code>mkdocs.yml    # The configuration file.\ndocs/\n    index.md  # The documentation homepage.\n    ...       # Other markdown pages, images and other files.\n</code></pre>"},{"location":"database/00-%E5%9F%BA%E7%A1%80/","title":"\u57fa\u7840","text":""},{"location":"database/00-%E5%9F%BA%E7%A1%80/#_1","title":"\u6570\u636e\u5e93\u4e09\u8303\u5f0f","text":""},{"location":"database/00-%E5%9F%BA%E7%A1%80/#_2","title":"\u7b2c\u4e00\u8303\u5f0f","text":"<p>\u6240\u6709\u7684\u5b57\u6bb5\u90fd\u662f\u57fa\u672c\u5b57\u6bb5\uff0c\u6700\u5c0f\u7684\u4fe1\u606f\u5355\u5143\uff0c\u4e0d\u53ef\u8fdb\u4e00\u6b65\u62c6\u5206</p>"},{"location":"database/00-%E5%9F%BA%E7%A1%80/#_3","title":"\u7b2c\u4e8c\u8303\u5f0f","text":"<p>\u5728\u6ee1\u8db3\u7b2c\u4e00\u8303\u5f0f\u7684\u57fa\u7840\u4e0a\uff0c\u6bcf\u4e00\u6761\u8bb0\u5f55\u90fd\u6709\u4e3b\u5173\u952e\u5b57\u6bb5\uff08\u53ef\u80fd\u7531\u4e24\u4e2a\u5b57\u6bb5\u7ec4\u5408\u800c\u6210\uff09\u3002\u800c\u4e14\u6240\u6709\u5b57\u6bb5\u90fd\u5fc5\u987b\u5b8c\u5168\u4f9d\u8d56\u4e3b\u952e\uff0c\u4e0d\u80fd\u90e8\u5206\u4f9d\u8d56\u4e3b\u952e</p> <p>\u4e0d\u7b26\u5408\u7b2c\u4e8c\u8303\u5f0f\u7684\u4f8b\u5b50</p> \u8d27\u7269\u7c7b\u578b \u8d27\u7269ID \u8d27\u7269\u540d\u79f0 \u6ce8\u610f\u4e8b\u9879 \u74f7\u7897 1 \u767d\u8272\u74f7\u7897 \u6613\u788e\u54c1 \u74f7\u7897 2 \u9752\u82b1\u74f7\u7897 \u6613\u788e\u54c1 \u74f7\u7897 3 \u96d5\u82b1\u74f7\u7897 \u6613\u788e\u54c1 \u4e09\u5408\u677f 4 \u666e\u901a\u4e09\u5408\u677f \u6613\u71c3\u7269\u54c1\uff0c\u6ce8\u610f\u9632\u706b <p>\u5728\u8be5\u8868\u4e2d\u4e3b\u952e\u4e3a\uff08\u8d27\u7269\u7c7b\u578b\uff0c\u8d27\u7269ID\uff09\uff0c\u8d27\u7269\u540d\u79f0\u5b57\u6bb5\u5b8c\u5168\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u4e3b\u952e\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u8d27\u7269\u7684\u540d\u79f0\u5b8c\u5168\u662f\u53d6\u51b3\u4e8e\u8fd9\u4e2a\u4e3b\u952e\u7684\u503c\u7684\u3002\u4f46\u201c\u6ce8\u610f\u4e8b\u9879\u201d\u8fd9\u4e00\u5217\uff0c\u4ec5\u4f9d\u8d56\u4e8e\u4e00\u4e2a\u4e3b\u952e\u4e2d\u201d\u8d27\u7269\u7c7b\u578b\u201c\u8fd9\u4e00\u4e2a\u5c5e\u6027\u3002\u7b80\u5355\u5730\u8bf4\uff0c\u7b2c\u4e8c\u8303\u5f0f\u8981\u6c42\u6bcf\u4e2a\u975e\u4e3b\u5c5e\u6027\u5b8c\u5168\u4f9d\u8d56\u4e8e\u4e3b\u952e\uff0c\u800c\u4e0d\u662f\u4ec5\u4f9d\u8d56\u4e8e\u5176\u4e2d\u4e00\u90e8\u5206\u5c5e\u6027\u3002</p>"},{"location":"database/00-%E5%9F%BA%E7%A1%80/#_4","title":"\u7b2c\u4e09\u8303\u5f0f","text":"<p>\u5728\u6ee1\u8db3\u7b2c\u4e8c\u8303\u5f0f\u7684\u57fa\u7840\u4e0a\uff0c\u4e0d\u80fd\u5305\u542b\u90a3\u4e9b\u4f9d\u8d56\u975e\u4e3b\u952e\u5b57\u6bb5\u7684\u5b57\u6bb5\uff0c\u6216\u8005\u8bf4\u7531\u975e\u4e3b\u952e\u5b57\u6bb5\u884d\u751f\u51fa\u6765\u7684\u5b57\u6bb5</p> <p>\u4f46\u662f\u6211\u4eec\u6709\u65f6\u4f1a\u6839\u636e\u4e1a\u52a1\u4f18\u5148\u7684\u539f\u5219\uff0c\u8fdb\u884c\u53cd\u8303\u5f0f\u7684\u5904\u7406\u3002\u6bd4\u5982\u8fdd\u53cd\u7b2c\u4e09\u8303\u5f0f\uff0c\u505a\u4e00\u4e9b\u5197\u4f59\u5b57\u6bb5\uff0c\u6bd4\u5982\u4e00\u5f20\u8868\u9664\u4e86person_id\u5b57\u6bb5\uff0c\u6211\u4eec\u8fd8\u5197\u4f59person_name\u5b57\u6bb5\uff0c\u65b9\u4fbf\u4e1a\u52a1\u67e5\u8be2\uff0c\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002</p> <p>select version();\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u7248\u672c 5.7.26-301001001-log</p>"},{"location":"database/00-%E5%9F%BA%E7%A1%80/#er","title":"ER\u56fe","text":"<p>\u4e00\u822c\u7528\u4e8e\u6570\u636e\u5e93\u7684\u8bbe\u8ba1\u9636\u6bb5\uff0c\u7528\u6765\u5e2e\u52a9\u68b3\u7406\u548c\u7406\u89e3\u8868\u7ed3\u6784\u548c\u5173\u7cfb\u3002</p> <p>\u5305\u542b\u5b9e\u4f53\uff0c\u5c5e\u6027\u548c\u5173\u7cfb\u3002</p> <p>\u5f3a\u5b9e\u4f53\uff1a\u4e0d\u4f9d\u8d56\u4e8e\u5176\u4ed6\u5b9e\u4f53\u7684\u5b9e\u4f53\u3002</p> <p>\u5f31\u5b9e\u4f53\uff1a\u4f9d\u8d56\u4e8e\u53e6\u4e00\u4e2a\u5b9e\u4f53\uff0c\u4e0d\u80fd\u72ec\u7acb\u5b58\u5728</p> <p>\u5173\u7cfb\u5305\u542b \u4e00\u5bf9\u4e00\uff0c\u4e00\u5bf9\u591a\uff0c\u591a\u5bf9\u591a\u3002</p> <p>InnoDB_buffer_pool_size \u8868\u793a\u7528\u4e8e\u7f13\u5b58\u7684\u5927\u5c0f\uff0c\u4e00\u822c\u6570\u636e\u5e93\u7528\u7684\u90fd\u662f\u4e13\u7528\u670d\u52a1\u5668\uff0c\u751a\u81f3128G\u3002\u9002\u5f53\u8c03\u5927\u53ef\u4ee5\u5145\u5206\u5229\u7528\u5185\u5b58</p> <p>InnoDB_buffer_pool_instances\u8868\u793abuffer pool\u5212\u5206\u4e3a\u51e0\u4e2a\u90e8\u5206\uff0c</p> <p>InnoDB_flush_log_at_trx_commit\u9ed8\u8ba41\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u90fd\u5199\u5165binlog\u5199\u5165\u78c1\u76d8\u3002\u53ef\u4ee5\u6539\u62102\uff0c\u8868\u793a\u6bcf\u6b21\u63d0\u4ea4\u4e8b\u52a1\u90fd\u5199\u5165binlog\uff0c\u4f46\u662f\u6bcf\u9694\u4e00\u79d2\u5199\u5165\u78c1\u76d8\u3002</p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/","title":"MySQL\u7684\u67b6\u6784","text":"<p>\u5927\u4f53\u6765\u8bf4\uff0cMySQL\u53ef\u4ee5\u5206\u4e3aServer\u5c42\u548c\u5b58\u50a8\u5f15\u64ce\u5c42\u4e24\u90e8\u5206\u3002</p> <ul> <li>Server\u5c42\u662fMySQL\u7684\"\u5927\u8111\"\uff0c\u8d1f\u8d23\u6240\u6709\u8de8\u5b58\u50a8\u5f15\u64ce\u7684\u6838\u5fc3\u529f\u80fd\uff0c \u6db5\u76d6MySQL\u7684\u5927\u591a\u6570\u6838\u5fc3\u670d\u52a1\u529f\u80fd\uff0c\u4ee5\u53ca\u6240\u6709\u7684\u5185\u7f6e\u51fd\u6570\uff08\u5982\u65e5\u671f\u3001\u65f6\u95f4\u3001\u6570\u5b66\u548c\u52a0\u5bc6\u51fd\u6570\u7b49\uff09\u6bd4\u5982\u5b58\u50a8\u8fc7\u7a0b\u3001\u89e6\u53d1\u5668\u3001\u89c6\u56fe\u7b49\u3002Server\u5c42\u5305\u62ec\u8fde\u63a5\u5668\u3001\u5206\u6790\u5668\u3001\u4f18\u5316\u5668\u3001\u6267\u884c\u5668\u7b49\u3002</li> <li>\u800c\u5b58\u50a8\u5f15\u64ce\u5c42\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\u3002\u5176\u67b6\u6784\u6a21\u5f0f\u662f\u63d2\u4ef6\u5f0f\u7684\uff0c\u652f\u6301InnoDB\u3001MyISAM\u3001Memory\u7b49\u591a\u4e2a\u5b58\u50a8\u5f15\u64ce</li> </ul> <p></p> <p>mySQL server\u5c42\u548c\u5b58\u50a8\u5f15\u64ce\u5c42\u80af\u5b9a\u5fc5\u987b\u8981\u5728\u540c\u4e00\u4e2a\u673a\u5668\u4e0a\u540c\u4e00\u4e2a\u8fdb\u7a0b\u5185\uff0c\u4fdd\u8bc1\u8fdb\u7a0b\u5185\u901a\u4fe1\u3002</p> <p>\u673a\u5668\u7684CPU\uff0c\u4e3b\u8981\u7528\u4e8eserver\u5c42\uff0c\u56e0\u4e3aserver\u5c42\u8981\u8d1f\u8d23\u94fe\u63a5\u7ba1\u7406\u548cSQL\u89e3\u6790\uff0c\u6392\u5e8f\u3001\u5206\u7ec4\uff0c\u94fe\u63a5\u8ba1\u7b97\u7b49\u7b49\uff0c\u4e34\u65f6\u8868\u3002</p> <p>\u673a\u5668\u5185\u5b58\u4e3b\u8981\u7528\u4e8e\u5f15\u64ce\u5c42\u7684bufferpoll\uff0c\u8fd9\u7edd\u5bf9\u662f\u5185\u5b58\u5927\u5934\u3002\u5f15\u64ce\u5c42\u4e3b\u8981\u8d1f\u8d23\u5feb\u901f\u5b9a\u4f4d\u6570\u636e\uff0c\u8bfb\u53d6\u6570\u636e\u5230\u5185\u5b58\u9875\uff0c\u66f4\u65b0\u810f\u9875\u7b49\u3002\u5982\u679c\u6709\u5927\u91cf\u5199\u5165\uff0c\u5f15\u64ce\u5c42\u4e5f\u4f1a\u6d88\u8017\u5927\u91cfCPU\u3002</p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#server","title":"\u4e00\u3001server \u6838\u5fc3\u670d\u52a1\u5c42","text":""},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#connector","title":"\u8fde\u63a5\u5668\uff08Connector\uff09\uff1a","text":"<p>\u529f\u80fd\uff1a\u7ba1\u7406\u5ba2\u6237\u7aef\u8fde\u63a5\u3001\u8eab\u4efd\u8ba4\u8bc1\u3001\u6743\u9650\u9a8c\u8bc1 \u5de5\u4f5c\u6d41\u7a0b\uff1a 1. \u5ba2\u6237\u7aef\u53d1\u8d77\u8fde\u63a5\u8bf7\u6c42  2. \u8fde\u63a5\u5668\u8fdb\u884c\u7528\u6237\u540d\u5bc6\u7801\u9a8c\u8bc1  3. \u9a8c\u8bc1\u6210\u529f\u540e\uff0c\u8bfb\u53d6\u8be5\u7528\u6237\u7684\u6743\u9650\u4fe1\u606f\u5e76\u7f13\u5b58  4. \u7ef4\u6301\u8fde\u63a5\u7ba1\u7406\uff0c\u5904\u7406\u8fde\u63a5\u8d85\u65f6\uff08wait_timeout \u53c2\u6570\u63a7\u5236\uff09 \u7279\u70b9\uff1a \u8fde\u63a5\u5efa\u7acb\u540e\uff0c\u5373\u4f7f\u7ba1\u7406\u5458\u4fee\u6539\u4e86\u8be5\u7528\u6237\u6743\u9650\uff0c\u5df2\u5b58\u5728\u7684\u8fde\u63a5\u4e5f\u4e0d\u4f1a\u53d7\u5f71\u54cd\uff0c\u9700\u8981\u91cd\u65b0\u8fde\u63a5\u624d\u4f1a\u751f\u6548 \u4f7f\u7528show processlist\u53ef\u4ee5\u67e5\u770b\u6240\u6709\u8fde\u63a5\u72b6\u6001 \u5ba2\u6237\u7aef\u5982\u679c\u592a\u957f\u65f6\u95f4\u6ca1\u52a8\u9759\uff0c\u8fde\u63a5\u5668\u5c31\u4f1a\u81ea\u52a8\u5c06\u5b83\u65ad\u5f00\u3002\u8fd9\u4e2a\u65f6\u95f4\u662f\u7531\u53c2\u6570wait_timeout\u63a7\u5236\u7684\uff0c\u9ed8\u8ba4\u503c\u662f8\u5c0f\u65f6\u3002 <code>mysql -h$ip -P$\u200bport -u$user -p</code>\u7136\u540e\u8f93\u5165\u5bc6\u7801\u540e\uff0c\u6821\u9a8c\u901a\u8fc7\uff0c\u8fde\u63a5\u5668\u5c31\u4f1a\u5230\u6743\u9650\u8868\u91cc\u67e5\u5904\u4f60\u62e5\u6709\u7684\u6240\u6709\u6743\u9650\uff0c\u4e4b\u540e\uff0c\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u7684\u6743\u9650\u5224\u65ad\u903b\u8f91\uff0c\u90fd\u5c06\u4f9d\u8d56\u4e8e\u6b64\u65f6\u8bfb\u5230\u7684\u6743\u9650\uff0c\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u4e00\u4e2a\u7528\u6237\u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u5373\u4f7f\u4f60\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u5bf9\u8fd9\u4e2a\u7528\u6237\u7684\u6743\u9650\u505a\u4e86\u4fee\u6539\uff0c\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5df2\u7ecf\u5b58\u5728\u8fde\u63a5\u7684\u6743\u9650\u3002\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u53ea\u6709\u518d\u65b0\u5efa\u7684\u8fde\u63a5\u624d\u4f1a\u4f7f\u7528\u65b0\u7684\u6743\u9650\u8bbe\u7f6e\u3002\u8fde\u63a5\u5b8c\u6210\u540e\uff0c\u5982\u679c\u4f60\u6ca1\u6709\u540e\u7eed\u7684\u52a8\u4f5c\uff0c\u8fd9\u4e2a\u8fde\u63a5\u5c31\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u5728show processlist\u547d\u4ee4\u4e2d\u770b\u5230\u5b83</p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#-mysql-80","title":"\u67e5\u8be2\u7f13\u5b58-MySQL 8.0\u5df2\u79fb\u9664","text":"<p>\u529f\u80fd\uff1a\u7f13\u5b58SELECT\u67e5\u8be2\u8bed\u53e5\u53ca\u5176\u7ed3\u679c\u96c6 \u5927\u591a\u6570\u60c5\u51b5\u4e0b\u6211\u4f1a\u5efa\u8bae\u4f60\u4e0d\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\uff0c\u4e3a\u4ec0\u4e48\u5462\uff1f\u56e0\u4e3a\u67e5\u8be2\u7f13\u5b58\u5f80\u5f80\u5f0a\u5927\u4e8e\u5229\u3002 \u67e5\u8be2\u7f13\u5b58\u7684\u5931\u6548\u975e\u5e38\u9891\u7e41\uff0c\u53ea\u8981\u6709\u5bf9\u4e00\u4e2a\u8868\u7684\u66f4\u65b0\uff0c\u8fd9\u4e2a\u8868\u4e0a\u6240\u6709\u7684\u67e5\u8be2\u7f13\u5b58\u90fd\u4f1a\u88ab\u6e05\u7a7a\u3002\u56e0\u6b64\u5f88\u53ef\u80fd\u4f60\u8d39\u52b2\u5730\u628a\u7ed3\u679c\u5b58\u8d77\u6765\uff0c\u8fd8\u6ca1\u4f7f\u7528\u5462\uff0c\u5c31\u88ab\u4e00\u4e2a\u66f4\u65b0\u5168\u6e05\u7a7a\u4e86\u3002\u5bf9\u4e8e\u66f4\u65b0\u538b\u529b\u5927\u7684\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u67e5\u8be2\u7f13\u5b58\u7684\u547d\u4e2d\u7387\u4f1a\u975e\u5e38\u4f4e\u3002\u9664\u975e\u4f60\u7684\u4e1a\u52a1\u5c31\u662f\u6709\u4e00\u5f20\u9759\u6001\u8868\uff0c\u5f88\u957f\u65f6\u95f4\u624d\u4f1a\u66f4\u65b0\u4e00\u6b21\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a\u7cfb\u7edf\u914d\u7f6e\u8868\uff0c\u90a3\u8fd9\u5f20\u8868\u4e0a\u7684\u67e5\u8be2\u624d\u9002\u5408\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58</p> <p>\u800c\u5bf9\u4e8e\u4f60\u786e\u5b9a\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u8bed\u53e5\uff0c\u53ef\u4ee5\u7528SQL_CACHE\u663e\u5f0f\u6307\u5b9a\uff0c\u50cf\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e00\u6837\uff1a mysql&gt; select SQL_CACHE * from T where ID=10\uff1b</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cMySQL 8.0\u7248\u672c\u76f4\u63a5\u5c06\u67e5\u8be2\u7f13\u5b58\u7684\u6574\u5757\u529f\u80fd\u5220\u6389\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf48.0\u5f00\u59cb\u5f7b\u5e95\u6ca1\u6709\u8fd9\u4e2a\u529f\u80fd\u4e86\u3002</p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#_1","title":"\u89e3\u6790\u5668","text":"<p>\u529f\u80fd\uff1a\u8fdb\u884c\u8bed\u6cd5\u5206\u6790\u3002\u8bc6\u522bSQL\u8bed\u53e5\u4e2d\u7684\u5173\u952e\u5b57\u3001\u8868\u540d\u3001\u5217\u540d\u7b49\uff0c\u6839\u636e\u8bed\u6cd5\u89c4\u5219\u9a8c\u8bc1\u8bed\u53e5\u662f\u5426\u6b63\u786e\u3002 \u751f\u6210\u8bed\u6cd5\u89e3\u6790\u6811\u3002</p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#_2","title":"\u4f18\u5316\u5668","text":"<p>\u529f\u80fd\uff1a\u751f\u6210\u6700\u4f18\u7684\u6267\u884c\u8ba1\u5212 \u51b3\u7b56\u5185\u5bb9\uff1a 1. \u9009\u62e9\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\uff08\u5982\u679c\u6709\u591a\u4e2a\u7d22\u5f15\u53ef\u9009\uff09 2. \u51b3\u5b9a\u8868\u7684\u8fde\u63a5\u987a\u5e8f 3. \u662f\u5426\u4f7f\u7528\u8986\u76d6\u7d22\u5f15 4. \u662f\u5426\u4f7f\u7528\u7d22\u5f15\u6761\u4ef6\u4e0b\u63a8</p> <p>\u5982\u4e0b\u5217SQL\uff0c\u4f18\u5316\u5668\u9700\u8981\u51b3\u5b9a\uff1a\u5148\u67e5t1\u8fd8\u662ft2\uff1f\u7528\u4ec0\u4e48\u7d22\u5f15\uff1f <pre><code>SELECT * FROM t1 JOIN t2 ON t1.id = t2.id WHERE t1.a = 1 AND t2.b = 2;\n</code></pre></p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#_3","title":"\u6267\u884c\u5668","text":"<p>\u529f\u80fd\uff1a\u6309\u7167\u4f18\u5316\u5668\u751f\u6210\u7684\u6267\u884c\u8ba1\u5212\u8c03\u7528\u5b58\u50a8\u5f15\u64ce\u63a5\u53e3\u3002 \u5de5\u4f5c\u6d41\u7a0b\uff1a 1. \u68c0\u67e5\u7528\u6237\u5bf9\u8868\u7684\u6267\u884c\u6743\u9650  2. \u8c03\u7528\u5b58\u50a8\u5f15\u64ce\u63a5\u53e3\u6267\u884c\u67e5\u8be2  3. \u5904\u7406\u8fd4\u56de\u7684\u7ed3\u679c\u96c6  4. \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684\u8868T\u4e2d\uff0cID\u5b57\u6bb5\u6ca1\u6709\u7d22\u5f15\uff0c\u90a3\u4e48\u6267\u884c\u5668\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a \u200b   1.  \u8c03\u7528InnoDB\u5f15\u64ce\u63a5\u53e3\u53d6\u8fd9\u4e2a\u8868\u7684\u7b2c\u4e00\u884c\uff0c\u5224\u65adID\u503c\u662f\u4e0d\u662f10\uff0c\u5982\u679c\u4e0d\u662f\u5219\u8df3\u8fc7\uff0c\u5982\u679c\u662f\u5219\u5c06\u8fd9\u884c\u5b58\u5728\u7ed3\u679c\u96c6\u4e2d\uff1b \u200b   2.  \u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u53d6\u201c\u4e0b\u4e00\u884c\u201d\uff0c\u91cd\u590d\u76f8\u540c\u7684\u5224\u65ad\u903b\u8f91\uff0c\u76f4\u5230\u53d6\u5230\u8fd9\u4e2a\u8868\u7684\u6700\u540e\u4e00\u884c\u3002 \u200b   3.  \u6267\u884c\u5668\u5c06\u4e0a\u8ff0\u904d\u5386\u8fc7\u7a0b\u4e2d\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u7ec4\u6210\u7684\u8bb0\u5f55\u96c6\u4f5c\u4e3a\u7ed3\u679c\u96c6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002 \u81f3\u6b64\uff0c\u8fd9\u4e2a\u8bed\u53e5\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002</p> <p>\u5bf9\u4e8e\u6709\u7d22\u5f15\u7684\u8868\uff0c\u6267\u884c\u7684\u903b\u8f91\u4e5f\u5dee\u4e0d\u591a\u3002\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u662f\u201c\u53d6\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u4e4b\u540e\u5faa\u73af\u53d6\u201c\u6ee1\u8db3\u6761\u4ef6\u7684\u4e0b\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u8fd9\u4e9b\u63a5\u53e3\u90fd\u662f\u5f15\u64ce\u4e2d\u5df2\u7ecf\u5b9a\u4e49\u597d\u7684\u3002</p> <p>\u4f60\u4f1a\u5728\u6570\u636e\u5e93\u7684\u6162\u67e5\u8be2\u65e5\u5fd7\u4e2d\u770b\u5230\u4e00\u4e2arows_examined\u7684\u5b57\u6bb5\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u4e86\u591a\u5c11\u884c\u3002\u8fd9\u4e2a\u503c\u5c31\u662f\u5728\u6267\u884c\u5668\u6bcf\u6b21\u8c03\u7528\u5f15\u64ce\u83b7\u53d6\u6570\u636e\u884c\u7684\u65f6\u5019\u7d2f\u52a0\u7684\u3002 \u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6267\u884c\u5668\u8c03\u7528\u4e00\u6b21\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u5219\u626b\u63cf\u4e86\u591a\u884c\uff0c\u56e0\u6b64\u5f15\u64ce\u626b\u63cf\u884c\u6570\u8ddfrows_examined\u5e76\u4e0d\u662f\u5b8c\u5168\u76f8\u540c\u7684</p>"},{"location":"database/02-mysql%E6%9E%B6%E6%9E%84/#_4","title":"\u4e8c\u3001\u5b58\u50a8\u5f15\u64ce\u5c42","text":"<p>\u5b58\u50a8\u5f15\u64ce\u5c42\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\uff0c\u662fMySQL\u7684\"\u624b\u811a\"\u3002\u8d1f\u8d23\u6570\u636e\u7684\u8bfb\u53d6\u548c\u5199\u5165\u3001\u7d22\u5f15\u7684\u521b\u5efa\u548c\u641c\u7d22\u3001\u4e8b\u52a1\u7ba1\u7406\u3001\u9501\u7ba1\u7406\u3002 \u6838\u5fc3\u5f15\u64ce\uff1a InnoDB\uff08\u9ed8\u8ba4\uff09\uff1a\u652f\u6301\u4e8b\u52a1\u3001\u884c\u7ea7\u9501\u3001\u5916\u952e\uff0c\u9002\u7528\u4e8e\u5927\u591a\u6570\u573a\u666f MyISAM\uff1a\u4e0d\u652f\u6301\u4e8b\u52a1\uff0c\u8868\u7ea7\u9501\uff0c\u9002\u7528\u4e8e\u8bfb\u591a\u5199\u5c11\u7684\u573a\u666f Memory\uff1a\u6570\u636e\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u901f\u5ea6\u5feb\u4f46\u91cd\u542f\u540e\u6570\u636e\u4e22\u5931</p> <p>\u4ee5 SELECT * FROM users WHERE id = 1; \u4e3a\u4f8b\uff1a \u8fde\u63a5\u5668\uff1a\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8fde\u63a5\u6743\u9650 \u5206\u6790\u5668\uff1a\u8bc6\u522b\u8fd9\u662fSELECT\u8bed\u53e5\uff0c\u68c0\u67e5\u8bed\u6cd5\u6b63\u786e\u6027 \u4f18\u5316\u5668\uff1a\u51b3\u5b9a\u4f7f\u7528\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2 \u6267\u884c\u5668\uff1a \u68c0\u67e5\u5bf9users\u8868\u7684\u67e5\u8be2\u6743\u9650 \u8c03\u7528InnoDB\u5f15\u64ce\u7684\"\u8bfb\u63a5\u53e3\" \u5b58\u50a8\u5f15\u64ce\uff1a \u5728\u805a\u96c6\u7d22\u5f15B+Tree\u4e2d\u67e5\u627eid=1\u7684\u8bb0\u5f55 \u8fd4\u56de\u5b8c\u6574\u884c\u6570\u636e \u6267\u884c\u5668\uff1a\u63a5\u6536\u6570\u636e\uff0c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef</p> <p>\u529f\u80fd\u6a21\u5757    \u6240\u5c5e\u5c42\u7ea7    \u8bf4\u660e \u8fde\u63a5\u7ba1\u7406    Server\u5c42 \u5904\u7406\u5ba2\u6237\u7aef\u8fde\u63a5 \u6743\u9650\u9a8c\u8bc1    Server\u5c42 \u9a8c\u8bc1\u7528\u6237\u6743\u9650 SQL\u89e3\u6790   Server\u5c42 \u8bcd\u6cd5\u3001\u8bed\u6cd5\u5206\u6790 \u67e5\u8be2\u4f18\u5316    Server\u5c42 \u751f\u6210\u6267\u884c\u8ba1\u5212 \u7d22\u5f15\u9009\u62e9    Server\u5c42 \u4f18\u5316\u5668\u51b3\u5b9a \u6570\u636e\u5b58\u50a8    \u5b58\u50a8\u5f15\u64ce\u5c42   \u6570\u636e\u6587\u4ef6\u7ec4\u7ec7 \u7d22\u5f15\u5b9e\u73b0    \u5b58\u50a8\u5f15\u64ce\u5c42   B+Tree\u7d22\u5f15\u7b49 \u4e8b\u52a1ACID  \u5b58\u50a8\u5f15\u64ce\u5c42   InnoDB\u652f\u6301 \u9501\u673a\u5236 \u5b58\u50a8\u5f15\u64ce\u5c42   \u884c\u9501\u3001\u8868\u9501\u7b49</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/","title":"InnoDB\u5b58\u50a8\u5f15\u64ce","text":"<p>\u672c\u6587\u57fa\u4e8emysql 5.7 \u5b98\u65b9\u53c2\u8003\u624b\u518c</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#141-innodb","title":"14.1 InnoDB\u7b80\u4ecb","text":"<p>InnoDB\u662f\u4e00\u79cd\u517c\u987e\u9ad8\u53ef\u9760\u6027\u548c\u9ad8\u6027\u80fd\u7684\u901a\u7528\u5b58\u50a8\u5f15\u64ce\u3002\u5728 MySQL5.7 \u4e2d\uff0cInnoDB\u662f\u9ed8\u8ba4\u7684 MySQL \u5b58\u50a8\u5f15\u64ce\u3002\u9664\u975e\u60a8\u914d\u7f6e\u4e86\u4e0d\u540c\u7684\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce\uff0c\u5426\u5219\u53d1\u51fa<code>CREATE TABLE</code>\u4e0d\u5e26<code>ENGINE</code> \u5b50\u53e5\u7684\u8bed\u53e5\u4f1a\u521b\u5efa\u4e00\u4e2aInnoDB\u8868\u3002  </p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#innodb","title":"InnoDB \u7684\u4e3b\u8981\u4f18\u52bf","text":"<ul> <li>\u5b83\u7684 DML \u64cd\u4f5c\u9075\u5faa ACID \u6a21\u578b\uff0c\u4e8b\u52a1\u5177\u6709\u63d0\u4ea4\u3001\u56de\u6eda\u548c\u5d29\u6e83\u6062\u590d\u529f\u80fd\uff0c\u4ee5\u4fdd\u62a4\u7528\u6237\u6570\u636e\u3002\u8bf7\u53c2\u9605\u7b2c 14.2 \u8282\uff0c\u201cInnoDB \u548c ACID \u6a21\u578b\u201d\u3002</li> <li>\u884c\u7ea7\u9501\u548c Oracle \u98ce\u683c\u7684\u4e00\u81f4\u8bfb\u53d6\u63d0\u9ad8\u4e86\u591a\u7528\u6237\u7684\u5e76\u53d1\u6027\u548c\u6027\u80fd\u3002\u8bf7\u53c2\u9605 \u7b2c 14.7 \u8282\uff0c\u201cInnoDB \u9501\u5b9a\u548c\u4e8b\u52a1\u6a21\u578b\u201d\u3002</li> <li>InnoDB\u8868\u5c06\u60a8\u7684\u6570\u636e\u4ee5\u57fa\u4e8e\u4e3b\u952e\u7684\u65b9\u5f0f\u6392\u5217\u5728\u78c1\u76d8\u4e0a\u6765\u4f18\u5316\u67e5\u8be2\u3002\u6bcf\u4e2aInnoDB\u8868\u90fd\u6709\u4e00\u4e2a\u79f0\u4e3a\u805a\u96c6\u7d22\u5f15\uff08clustered index\uff09\u7684\u4e3b\u952e\u7d22\u5f15\uff0c\u7528\u4e8e\u7ec4\u7ec7\u6570\u636e\uff0c\u8fd9\u6837\u53ef\u4ee5\u5728\u4e3b\u952e\u67e5\u627e\u65f6\u7684\u6700\u5c0f\u5316 I/O\u3002\u8bf7\u53c2\u9605\u7b2c 14.6.2.1 \u8282\uff0c\u201c\u805a\u96c6\u7d22\u5f15\u548c\u4e8c\u7ea7\u7d22\u5f15\u201d\u3002</li> <li>\u4e3a\u7ef4\u62a4\u6570\u636e\u5b8c\u6574\u6027\uff0cInnoDB\u652f\u6301 <code>FOREIGN KEY</code>\u7ea6\u675f\u3002\u4f7f\u7528\u5916\u952e\uff0c\u68c0\u67e5\u63d2\u5165\u3001\u66f4\u65b0\u548c\u5220\u9664\u4ee5\u786e\u4fdd\u5b83\u4eec\u4e0d\u4f1a\u5bfc\u81f4\u76f8\u5173\u8868\u4e4b\u95f4\u7684\u4e0d\u4e00\u81f4\u3002\u8bf7\u53c2\u89c1 \u7b2c 13.1.18.5 \u8282\uff0c\u201c\u5916\u952e\u7ea6\u675f\u201d\u3002</li> </ul> <p>\u8868 14.1 InnoDB \u5b58\u50a8\u5f15\u64ce\u7279\u6027</p> \u7279\u5f81 \u652f\u6301 B\u6811\u7d22\u5f15 Yes \u5907\u4efd/\u65f6\u95f4\u70b9\u6062\u590d\uff08\u5728\u670d\u52a1\u5668\u4e2d\u5b9e\u73b0\uff0c\u800c\u4e0d\u662f\u5728\u5b58\u50a8\u5f15\u64ce\u4e2d\u3002\uff09 Yes \u96c6\u7fa4\u6570\u636e\u5e93\u652f\u6301 \u4e0d Clustered indexes\u805a\u96c6\u7d22\u5f15 Yes \u538b\u7f29\u6570\u636e Yes \u6570\u636e\u7f13\u5b58 Yes \u52a0\u5bc6\u6570\u636e Yes\uff08\u901a\u8fc7\u52a0\u5bc6\u51fd\u6570\u5728\u670d\u52a1\u5668\u4e2d\u5b9e\u73b0\uff1b\u5728 MySQL 5.7 \u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\uff0c\u652f\u6301\u9759\u6001\u6570\u636e\u52a0\u5bc6\u3002\uff09 \u5916\u952e\u652f\u6301 Yes \u5168\u6587\u68c0\u7d22\u7d22\u5f15 Yes\uff08MySQL 5.6 \u53ca\u66f4\u9ad8\u7248\u672c\u652f\u6301 FULLTEXT \u7d22\u5f15\u3002\uff09 \u5730\u7406\u7a7a\u95f4\u6570\u636e\u7c7b\u578b\u652f\u6301 Yes \u5730\u7406\u7a7a\u95f4\u7d22\u5f15\u652f\u6301 Yes\uff08MySQL 5.7 \u53ca\u66f4\u9ad8\u7248\u672c\u652f\u6301\u5730\u7406\u7a7a\u95f4\u7d22\u5f15\u3002\uff09 \u54c8\u5e0c\u7d22\u5f15 NO\uff08InnoDB \u5728\u5185\u90e8\u5229\u7528\u54c8\u5e0c\u7d22\u5f15\u6765\u5b9e\u73b0\u5176\u81ea\u9002\u5e94\u54c8\u5e0c\u7d22\u5f15\u529f\u80fd\uff09 \u7d22\u5f15\u7f13\u5b58 Yes \u9501\u5b9a\u7c92\u5ea6 \u884c MVCC Yes \u590d\u5236\u652f\u6301\uff08\u5728\u670d\u52a1\u5668\u4e2d\u5b9e\u73b0\uff0c\u800c\u4e0d\u662f\u5728\u5b58\u50a8\u5f15\u64ce\u4e2d\uff09 Yes \u5b58\u50a8\u9650\u5236 64TB T-tree \u7d22\u5f15 \u4e0d Transactions\u4e8b\u52a1 Yes \u66f4\u65b0\u6570\u636e\u5b57\u5178\u7684\u7edf\u8ba1\u4fe1\u606f Yes <p>\u6ce8\u610f\uff0cInnoDB\u4e0d\u652f\u6301hash\u7d22\u5f15\uff0c\u4f1a\u6839\u636e\u8868\u7684\u4f7f\u7528\u60c5\u51b5\u81ea\u52a8\u4e3a\u8868\u751f\u6210\u54c8\u5e0c\u7d22\u5f15\u6765\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\uff0c\u4e0d\u80fd\u4eba\u4e3a\u5e72\u9884\u662f\u5426\u5728\u4e00\u5f20\u8868\u4e2d\u751f\u6210\u54c8\u5e0c\u7d22\u5f15\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1411-innodb","title":"14.1.1 \u4f7f\u7528InnoDB\u8868\u7684\u597d\u5904","text":"<p>InnoDB \u8868\u6709\u4ee5\u4e0b\u597d\u5904\uff1a</p> <ul> <li>\u5982\u679c\u670d\u52a1\u5668\u7531\u4e8e\u786c\u4ef6\u6216\u8f6f\u4ef6\u95ee\u9898\u800c\u610f\u5916\u9000\u51fa\uff0c\u65e0\u8bba\u5f53\u65f6\u6570\u636e\u5e93\u4e2d\u53d1\u751f\u4e86\u4ec0\u4e48\uff0c\u60a8\u90fd\u65e0\u9700\u5728\u91cd\u65b0\u542f\u52a8\u6570\u636e\u5e93\u540e\u6267\u884c\u4efb\u4f55\u7279\u6b8a\u64cd\u4f5c\u3002InnoDB\u5d29\u6e83\u6062\u590d\u4f1a\u81ea\u52a8\u5b8c\u6210\u5d29\u6e83\u4e4b\u524d\u63d0\u4ea4\u7684\u66f4\u6539\uff0c\u5e76\u64a4\u6d88\u6b63\u5728\u8fdb\u884c\u4f46\u672a\u63d0\u4ea4\u7684\u66f4\u6539\uff0c\u5141\u8bb8\u60a8\u91cd\u65b0\u542f\u52a8\u5e76\u4ece\u4e0a\u6b21\u4e2d\u65ad\u7684\u5730\u65b9\u7ee7\u7eed\u3002\u8bf7\u53c2\u9605 \u7b2c 14.19.2 \u8282\uff0c\u201cInnoDB \u6062\u590d\u201d\u3002</li> <li>\u8be5InnoDB\u5b58\u50a8\u5f15\u64ce\u7ef4\u62a4\u81ea\u5df1\u7684\u7f13\u51b2\u6c60\uff0c\u5728\u4e3b\u5185\u5b58\u7f13\u5b58\u8868\u548c\u7d22\u5f15\u6570\u636e\u4f5c\u4e3a\u6570\u636e\u88ab\u8bbf\u95ee\u3002\u7ecf\u5e38\u4f7f\u7528\u7684\u6570\u636e\u76f4\u63a5\u4ece\u5185\u5b58\u4e2d\u5904\u7406\u3002\u6b64\u7f13\u5b58\u9002\u7528\u4e8e\u591a\u79cd\u7c7b\u578b\u7684\u4fe1\u606f\u5e76\u52a0\u5feb\u5904\u7406\u901f\u5ea6\u3002\u5728\u4e13\u7528\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e0a\uff0c\u591a\u8fbe 80% \u7684\u7269\u7406\u5185\u5b58\u901a\u5e38\u5206\u914d\u7ed9\u7f13\u51b2\u6c60\u3002\u8bf7\u53c2\u89c1\u7b2c 14.5.1 \u8282\uff0c\u201c\u7f13\u51b2\u6c60\u201d\u3002</li> <li>\u5982\u679c\u5c06\u76f8\u5173\u6570\u636e\u62c6\u5206\u5230\u4e0d\u540c\u7684\u8868\u4e2d\uff0c\u5219\u53ef\u4ee5\u8bbe\u7f6e\u5f3a\u5236\u53c2\u7167\u5b8c\u6574\u6027\u7684\u5916\u952e\u3002\u8bf7\u53c2\u89c1 \u7b2c 13.1.18.5 \u8282\uff0c\u201c\u5916\u952e\u7ea6\u675f\u201d\u3002</li> <li>\u5982\u679c\u78c1\u76d8\u6216\u5185\u5b58\u4e2d\u7684\u6570\u636e\u635f\u574f\uff0c\u6821\u9a8c\u548c\u673a\u5236\u4f1a\u5728\u60a8\u4f7f\u7528\u4e4b\u524d\u63d0\u9192\u60a8\u6ce8\u610f\u865a\u5047\u6570\u636e\u3002\u8be5 <code>innodb_checksum_algorithm</code> \u53d8\u91cf\u5b9a\u4e49\u4e86 \u4f7f\u7528\u7684\u6821\u9a8c\u548c\u7b97\u6cd5InnoDB\u3002</li> <li>\u5f53\u60a8\u4e3a\u6bcf\u4e2a\u8868\u8bbe\u8ba1\u5177\u6709\u9002\u5f53\u4e3b\u952e\u5217\u7684\u6570\u636e\u5e93\u65f6\uff0c\u4f1a\u81ea\u52a8\u4f18\u5316\u6d89\u53ca\u8fd9\u4e9b\u5217\u7684\u64cd\u4f5c\u3002\u5728<code>WHERE</code> \u5b50\u53e5\u3001<code>ORDER BY</code>\u5b50\u53e5\u3001 <code>GROUP BY</code> \u5b50\u53e5\u548c\u8fde\u63a5\u64cd\u4f5c\u4e2d\u5f15\u7528\u4e3b\u952e\u5217\u7684\u901f\u5ea6\u975e\u5e38\u5feb \u3002\u8bf7\u53c2\u9605 \u7b2c 14.6.2.1 \u8282\uff0c\u201c\u805a\u96c6\u7d22\u5f15\u548c\u4e8c\u7ea7\u7d22\u5f15\u201d\u3002</li> <li>\u63d2\u5165\u3001\u66f4\u65b0\u548c\u5220\u9664\u901a\u8fc7\u79f0\u4e3a\u66f4\u6539\u7f13\u51b2\u7684\u81ea\u52a8\u673a\u5236\u8fdb\u884c\u4f18\u5316\u3002InnoDB \u4e0d\u4ec5\u5141\u8bb8\u5bf9\u540c\u4e00\u8868\u8fdb\u884c\u5e76\u53d1\u8bfb\u5199\u8bbf\u95ee\uff0c\u5b83\u8fd8\u7f13\u5b58\u66f4\u6539\u7684\u6570\u636e\u4ee5\u7b80\u5316\u78c1\u76d8 I/O\u3002\u8bf7\u53c2\u9605 \u7b2c 14.5.2 \u8282\uff0c\u201c\u66f4\u6539\u7f13\u51b2\u533a\u201d\u3002</li> <li>\u6027\u80fd\u4f18\u52bf\u4e0d\u4ec5\u9650\u4e8e\u5177\u6709\u957f\u65f6\u95f4\u8fd0\u884c\u67e5\u8be2\u7684\u5927\u578b\u8868\u3002\u5f53\u4ece\u8868\u4e2d\u4e00\u904d\u53c8\u4e00\u904d\u5730\u8bbf\u95ee\u76f8\u540c\u7684\u884c\u65f6\uff0c\u81ea\u9002\u5e94\u54c8\u5e0c\u7d22\u5f15\u4f1a\u63a5\u7ba1\u4ee5\u4f7f\u8fd9\u4e9b\u67e5\u627e\u66f4\u5feb\uff0c\u5c31\u597d\u50cf\u5b83\u4eec\u6765\u81ea\u54c8\u5e0c\u8868\u4e00\u6837\u3002\u8bf7\u53c2\u9605\u7b2c 14.5.3 \u8282\uff0c\u201c\u81ea\u9002\u5e94\u54c8\u5e0c\u7d22\u5f15\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u538b\u7f29\u8868\u548c\u5173\u8054\u7684\u7d22\u5f15\u3002\u8bf7\u53c2\u9605 \u7b2c 14.9 \u8282\uff0c\u201cInnoDB \u8868\u548c\u9875\u9762\u538b\u7f29\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u52a0\u5bc6\u60a8\u7684\u6570\u636e\u3002\u8bf7\u53c2\u9605 \u7b2c 14.14 \u8282\uff0c\u201cInnoDB \u9759\u6001\u6570\u636e\u52a0\u5bc6\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u521b\u5efa\u548c\u5220\u9664\u7d22\u5f15\u4ee5\u53ca\u6267\u884c\u5176\u4ed6 DDL \u64cd\u4f5c\uff0c\u800c\u5bf9\u6027\u80fd\u548c\u53ef\u7528\u6027\u7684\u5f71\u54cd\u8981\u5c0f\u5f97\u591a\u3002\u8bf7\u53c2\u9605 \u7b2c 14.13.1 \u8282\uff0c\u201c\u5728\u7ebf DDL \u64cd\u4f5c\u201d\u3002</li> <li>\u622a\u65ad\u6bcf\u4e2a\u8868\u7684\u6587\u4ef6\u8868\u7a7a\u95f4\u975e\u5e38\u5feb\uff0c\u53ef\u4ee5\u91ca\u653e\u78c1\u76d8\u7a7a\u95f4\u4f9b\u64cd\u4f5c\u7cfb\u7edf\u91cd\u7528\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662fInnoDB. \u8bf7\u53c2\u9605 \u7b2c 14.6.3.2 \u8282\uff0c\u201c\u6bcf\u4e2a\u8868\u7684\u6587\u4ef6\u8868\u7a7a\u95f4\u201d\u3002</li> <li>\u8868\u6570\u636e\u7684\u5b58\u50a8\u5e03\u5c40\u5bf9\u4e8e<code>BLOB</code>\u957f\u6587\u672c\u5b57\u6bb5\u548c<code>DYNAMIC</code>\u884c\u683c\u5f0f\u66f4\u6709\u6548 \u3002\u8bf7\u53c2\u9605 \u7b2c 14.11 \u8282\uff0c\u201cInnoDB \u884c\u683c\u5f0f\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2<code>INFORMATION_SCHEMA</code>\u8868\u6765\u76d1\u63a7\u5b58\u50a8\u5f15\u64ce\u7684\u5185\u90e8\u5de5\u4f5c\u3002\u8bf7\u53c2\u9605 \u7b2c 14.16 \u8282\uff0c\u201cInnoDB INFORMATION_SCHEMA \u8868\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2 Performance Schema \u8868\u6765\u76d1\u63a7\u5b58\u50a8\u5f15\u64ce\u7684\u6027\u80fd\u8be6\u7ec6\u4fe1\u606f\u3002\u8bf7\u53c2\u9605 \u7b2c 14.17 \u8282\uff0c\u201cInnoDB \u4e0e MySQL Performance Schema \u7684\u96c6\u6210\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u5c06InnoDB\u8868\u4e0e\u6765\u81ea\u5176\u4ed6 MySQL \u5b58\u50a8\u5f15\u64ce\u7684\u8868\u6df7\u5408\u4f7f\u7528\uff0c\u5373\u4f7f\u5728\u540c\u4e00\u8bed\u53e5\u4e2d\u4e5f\u662f\u5982\u6b64\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8fde\u63a5\u64cd\u4f5c\u5728\u5355\u4e2a\u67e5\u8be2\u4e2d\u7ec4\u5408\u6765\u81ea\u8868InnoDB\u548c <code>MEMORY</code>\u8868\u7684\u6570\u636e \u3002</li> <li>InnoDB \u4e13\u4e3a\u5904\u7406\u5927\u91cf\u6570\u636e\u65f6\u7684 CPU \u6548\u7387\u548c\u6700\u5927\u6027\u80fd\u800c\u8bbe\u8ba1\u3002</li> <li>InnoDB \u8868\u53ef\u4ee5\u5904\u7406\u5927\u91cf\u6570\u636e\uff0c\u5373\u4f7f\u5728\u6587\u4ef6\u5927\u5c0f\u9650\u5236\u4e3a 2GB \u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u4e5f\u662f\u5982\u6b64\u3002</li> </ul> <p>\u5bf9\u4e8eInnoDB\u53ef\u4ee5\u5e94\u7528\u4e8eMySQL\u670d\u52a1\u5668\u548c\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u7684\u7279\u5b9a\u8c03\u6574\u6280\u672f\uff0c\u8bf7\u53c2\u9605 \u7b2c 8.5 \u8282\u201c\u4f18\u5316 InnoDB \u8868\u201d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1412-innodb","title":"14.1.2 InnoDB \u8868\u7684\u6700\u4f73\u5b9e\u8df5","text":"<p>\u672c\u8282\u4ecb\u7ecd\u4f7f\u7528InnoDB\u8868\u683c\u65f6\u7684\u6700\u4f73\u505a\u6cd5 </p> <ul> <li>\u4f7f\u7528\u6700\u5e38\u67e5\u8be2\u7684\u4e00\u5217\u6216\u591a\u5217\u4e3a\u6bcf\u4e2a\u8868\u6307\u5b9a\u4e00\u4e2a\u4e3b\u952e\uff0c\u5982\u679c\u6ca1\u6709\u660e\u663e\u7684\u4e3b\u952e\uff0c\u5219\u6307\u5b9a\u4e00\u4e2a\u81ea\u589e\u503c\u3002</li> <li>\u5728\u6839\u636e\u591a\u4e2a\u8868\u4e2d\u7684\u76f8\u540c ID \u503c\u4ece\u591a\u4e2a\u8868\u4e2d\u63d0\u53d6\u6570\u636e\u7684\u5730\u65b9\u4f7f\u7528\u8fde\u63a5\u3002\u4e3a\u4e86\u5feb\u901f\u8fde\u63a5\u6027\u80fd\uff0c\u5728\u8fde\u63a5\u5217\u4e0a\u5b9a\u4e49\u5916\u952e\uff0c\u5e76\u5728\u6bcf\u4e2a\u8868\u4e2d\u7528\u76f8\u540c\u7684\u6570\u636e\u7c7b\u578b\u58f0\u660e\u8fd9\u4e9b\u5217\u3002\u6dfb\u52a0\u5916\u952e\u786e\u4fdd\u5f15\u7528\u7684\u5217\u88ab\u7d22\u5f15\uff0c\u8fd9\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002\u5916\u952e\u8fd8\u4f1a\u5c06\u5220\u9664\u548c\u66f4\u65b0\u4f20\u64ad\u5230\u6240\u6709\u53d7\u5f71\u54cd\u7684\u8868\uff0c\u5e76\u5728\u7236\u8868\u4e2d\u4e0d\u5b58\u5728\u76f8\u5e94 ID \u65f6\u963b\u6b62\u5728\u5b50\u8868\u4e2d\u63d2\u5165\u6570\u636e\u3002</li> <li>\u5173\u95ed\u81ea\u52a8\u63d0\u4ea4\u3002\u6bcf\u79d2\u63d0\u4ea4\u6570\u767e\u6b21\u4f1a\u9650\u5236\u6027\u80fd\uff08\u53d7\u5b58\u50a8\u8bbe\u5907\u7684\u5199\u5165\u901f\u5ea6\u9650\u5236\uff09\u3002</li> <li>\u901a\u8fc7\u7528<code>START TRANSACTION</code>\u548c <code>COMMIT</code>\u8bed\u53e5\u5c06\u76f8\u5173\u7684 DML \u64cd\u4f5c\u96c6\u5206\u7ec4\u5230\u4e8b\u52a1\u4e2d\u3002\u867d\u7136\u60a8\u4e0d\u60f3\u592a\u9891\u7e41\u5730\u63d0\u4ea4\uff0c\u4f46\u60a8\u4e5f\u4e0d\u60f3\u53d1\u51fa\u5927\u91cf\u8fd0\u884c\u6570\u5c0f\u65f6\u800c\u4e0d\u63d0\u4ea4\u7684 <code>INSERT</code>\u3001 UPDATE\u3001 \u6216 <code>DELETE</code>\u8bed\u53e5\u3002</li> <li>\u4e0d\u8981\u4f7f\u7528<code>LOCK TABLES</code> \u8bed\u53e5\u3002InnoDB\u53ef\u4ee5\u5728\u4e0d\u727a\u7272\u53ef\u9760\u6027\u6216\u9ad8\u6027\u80fd\u7684\u60c5\u51b5\u4e0b\u540c\u65f6\u5904\u7406\u5bf9\u540c\u4e00\u4e2a\u8868\u7684\u6240\u6709\u8bfb\u53d6\u548c\u5199\u5165\u7684\u591a\u4e2a\u4f1a\u8bdd\u3002\u8981\u83b7\u5f97\u5bf9\u4e00\u7ec4\u884c\u7684\u72ec\u5360\u5199\u8bbf\u95ee\u6743\u9650\uff0c\u8bf7\u4f7f\u7528 <code>SELECT ... FOR UPDATE</code>\u8bed\u6cd5\u9501\u5b9a\u60a8\u6253\u7b97\u66f4\u65b0\u7684\u884c\u3002</li> <li>\u542f\u7528 <code>innodb_file_per_table</code> \u53d8\u91cf\u6216\u4f7f\u7528\u901a\u7528\u8868\u7a7a\u95f4\u5c06\u8868\u7684\u6570\u636e\u548c\u7d22\u5f15\u653e\u5165\u5355\u72ec\u7684\u6587\u4ef6\u800c\u4e0d\u662f\u7cfb\u7edf\u8868\u7a7a\u95f4\u3002<code>innodb_file_per_table</code> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u542f\u7528\u8be5 \u53d8\u91cf\u3002</li> <li>\u8bc4\u4f30\u60a8\u7684\u6570\u636e\u548c\u8bbf\u95ee\u6a21\u5f0f\u662f\u5426\u53d7\u76ca\u4e8eInnoDB\u8868\u6216\u9875\u9762\u538b\u7f29\u529f\u80fd\u3002\u60a8\u53ef\u4ee5\u5728InnoDB\u4e0d\u727a\u7272\u8bfb/\u5199\u80fd\u529b\u7684\u60c5\u51b5\u4e0b\u538b\u7f29\u8868\u3002</li> <li>\u4f7f\u7528<code>--sql_mode=NO_ENGINE_SUBSTITUTION</code> \u9009\u9879\u8fd0\u884c\u670d\u52a1\u5668 \u4ee5\u9632\u6b62\u4f7f\u7528\u60a8\u4e0d\u60f3\u4f7f\u7528\u7684\u5b58\u50a8\u5f15\u64ce\u521b\u5efa\u8868\u3002</li> </ul>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1413-innodb","title":"14.1.3 \u9a8c\u8bc1InnoDB\u662f\u5426\u4e3a\u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce","text":"<pre><code>mysql&gt; SHOW ENGINES;\n</code></pre> <p>\u5728default\u4e2dsupport\u5217\u67e5\u627e</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#143-innodbmvcc","title":"14.3 InnoDB\u7684MVCC","text":"<p>InnoDB\u662f\u4e00\u4e2a\u591a\u7248\u672c\u5b58\u50a8\u5f15\u64ce\u3002\u5b83\u4fdd\u7559\u4e86\u5173\u4e8e\u6539\u53d8\u884c\u7684\u65e7\u7248\u672c\u7684\u4fe1\u606f\uff0c\u4ee5\u652f\u6301\u4e8b\u52a1\u6027\u529f\u80fd\uff0c\u5982\u5e76\u53d1\u548c\u56de\u6eda\u3002\u8fd9\u4e9b\u4fe1\u606f\u88ab\u5b58\u50a8\u5728\u7cfb\u7edf\u8868\u7a7a\u95f4\u6216undo\u8868\u7a7a\u95f4\u4e2d\u7684\u4e00\u4e2a\u53eb\u505a\u56de\u6eda\u6bb5\u7684\u6570\u636e\u7ed3\u6784\u4e2d\u3002InnoDB\u4f7f\u7528\u56de\u6eda\u6bb5\u4e2d\u7684\u4fe1\u606f\u6765\u6267\u884c\u4e8b\u52a1\u56de\u6eda\u4e2d\u9700\u8981\u7684\u64a4\u9500\u64cd\u4f5c\u3002\u5b83\u8fd8\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u6765\u5efa\u7acb\u4e00\u4e2a\u884c\u7684\u65e9\u671f\u7248\u672c\uff0c\u4ee5\u4fbf\u8fdb\u884c\u4e00\u81f4\u8bfb\u53d6\u3002\u53c2\u89c1\u7ae0\u828214.7.2.3, \"\u4e00\u81f4\u7684\u65e0\u9501\u8bfb\u53d6\"\u3002</p> <p>\u5728\u5185\u90e8\uff0cInnoDB\u4e3a\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\u7684\u6bcf\u4e00\u6761\u8bb0\u5f55\u6dfb\u52a0\u4e09\u4e2a\u5b57\u6bb5\uff1a</p> <ul> <li> <p>\u4e00\u4e2a6\u5b57\u8282\u7684DB_TRX_ID\u5b57\u6bb5\u8868\u793a\u63d2\u5165\u6216\u66f4\u65b0\u8be5\u884c\u7684\u6700\u540e\u4e00\u4e2a\u4e8b\u52a1\u7684\u6807\u8bc6\u7b26\u3002\u53e6\u5916\uff0c\u4e00\u4e2a\u5220\u9664\u5728\u5185\u90e8\u88ab\u89c6\u4e3a\u4e00\u4e2a\u66f4\u65b0\uff0c\u5728\u884c\u4e2d\u7684\u4e00\u4e2a\u7279\u6b8a\u4f4d\u8bbe\u7f6e\u6807\u8bb0\u4e3a\u5220\u9664\u3002</p> </li> <li> <p>\u4e00\u4e2a7\u5b57\u8282\u7684DB_ROLL_PTR\u5b57\u6bb5\u79f0\u4e3aroll pointer\u3002roll pointer\u6307\u5411\u5199\u5728\u56de\u6eda\u6bb5\u4e0a\u7684undo\u65e5\u5fd7\u8bb0\u5f55\u3002\u5982\u679c\u8be5\u884c\u88ab\u66f4\u65b0\u4e86\uff0cundo\u65e5\u5fd7\u8bb0\u5f55\u5305\u542b\u4e86\u91cd\u5efa\u8be5\u884c\u88ab\u66f4\u65b0\u524d\u5185\u5bb9\u7684\u5fc5\u8981\u4fe1\u606f\u3002</p> </li> <li> <p>\u4e00\u4e2a6\u5b57\u8282\u7684DB_ROW_ID\u5b57\u6bb5\u5305\u542b\u4e00\u4e2a\u884c\u7684ID\uff0c\u8fd9\u4e2aID\u968f\u7740\u65b0\u884c\u7684\u63d2\u5165\u800c\u5355\u8c03\u5730\u589e\u52a0\u3002\u5982\u679cInnoDB\u81ea\u52a8\u751f\u6210\u4e86\u4e00\u4e2a\u805a\u96c6\u7d22\u5f15\uff0c\u90a3\u4e48\u8be5\u7d22\u5f15\u5c31\u5305\u542b\u4e86\u884cID\u503c\u3002\u5426\u5219\uff0cDB_ROW_ID\u5217\u4e0d\u4f1a\u51fa\u73b0\u5728\u4efb\u4f55\u7d22\u5f15\u4e2d\u3002</p> </li> </ul> <p>\u5728\u56de\u6eda\u6bb5\u7684undo\u65e5\u5fd7\u88ab\u5206\u4e3ainsert\u548cupdate undoLog\u3002insert undoLog\u53ea\u5728\u4e8b\u52a1\u56de\u6eda\u4e2d\u9700\u8981\uff0c\u5e76\u4e14\u5728\u4e8b\u52a1\u63d0\u4ea4\u540e\u53ef\u4ee5\u7acb\u5373\u4e22\u5f03\u3002update undoLog\u4e5f\u7528\u4e8e\u4e00\u81f4\u8bfb\u53d6\uff0c\u4f46\u662f\u5b83\u4eec\u53ea\u80fd\u5728\u6ca1\u6709InnoDB\u4e3a\u5176\u5206\u914d\u5feb\u7167\u7684\u4e8b\u52a1\u51fa\u73b0\u540e\u88ab\u4e22\u5f03\uff0c\u5728\u4e00\u81f4\u8bfb\u53d6\u4e2d\u53ef\u80fd\u9700\u8981update undoLog\u4e2d\u7684\u4fe1\u606f\u6765\u5efa\u7acb\u6570\u636e\u5e93\u884c\u7684\u65e9\u671f\u7248\u672c\u3002</p> <p>\u5efa\u8bae\u4f60\u5b9a\u671f\u63d0\u4ea4\u4e8b\u52a1\uff0c\u5305\u62ec\u53ea\u53d1\u51fa\u4e00\u81f4\u8bfb\u53d6\u7684\u4e8b\u52a1\u3002\u5426\u5219\uff0cInnoDB\u4e0d\u80fd\u4e22\u5f03update undoLog\u4e2d\u7684\u6570\u636e\uff0c\u5e76\u4e14\u56de\u6eda\u6bb5\u53ef\u80fd\u4f1a\u589e\u957f\u5f97\u592a\u5927\uff0c\u586b\u6ee1\u5b83\u6240\u5728\u7684\u8868\u7a7a\u95f4\u3002\u5173\u4e8e\u7ba1\u7406undoLog\u8868\u7a7a\u95f4\u7684\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u7b2c14.6.3.4\u8282\uff0c\"undoLog\u8868\u7a7a\u95f4\"\u3002</p> <p>\u56de\u6eda\u6bb5\u4e2dundoLog\u8bb0\u5f55\u7684\u7269\u7406\u5927\u5c0f\u901a\u5e38\u6bd4\u76f8\u5e94\u7684\u63d2\u5165\u6216\u66f4\u65b0\u7684\u884c\u5c0f\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u4fe1\u606f\u6765\u8ba1\u7b97\u4f60\u7684\u56de\u6eda\u6bb5\u6240\u9700\u8981\u7684\u7a7a\u95f4\u3002</p> <p>\u5728InnoDB\u7684\u591a\u7248\u672c\u6a21\u5f0f\u4e2d\uff0c\u5f53\u4f60\u7528SQL\u8bed\u53e5\u5220\u9664\u4e00\u6761\u8bb0\u5f55\u65f6\uff0c\u5b83\u4e0d\u4f1a\u7acb\u5373\u4ece\u6570\u636e\u5e93\u4e2d\u88ab\u7269\u7406\u5220\u9664\u3002InnoDB\u53ea\u6709\u5728\u4e22\u5f03\u4e3a\u5220\u9664\u800c\u5199\u7684update undoLog\u8bb0\u5f55\u65f6\uff0c\u624d\u4f1a\u7269\u7406\u4e0a\u5220\u9664\u76f8\u5e94\u7684\u884c\u548c\u5b83\u7684\u7d22\u5f15\u8bb0\u5f55\u3002\u8fd9\u4e2a\u5220\u9664\u64cd\u4f5c\u88ab\u79f0\u4e3a\u6e05\u9664(purge)\uff0c\u5b83\u662f\u76f8\u5f53\u5feb\u7684\uff0c\u901a\u5e38\u4e0e\u8fdb\u884c\u5220\u9664\u7684SQL\u8bed\u53e5\u7684\u65f6\u95f4\u987a\u5e8f\u76f8\u540c\u3002</p> <p>\u5982\u679c\u4f60\u5728\u8868\u4e2d\u4ee5\u76f8\u540c\u7684\u901f\u5ea6\u5c0f\u6279\u91cf\u5730\u63d2\u5165\u548c\u5220\u9664\u884c\uff0c\u6e05\u9664\u7ebf\u7a0b\u5c31\u4f1a\u5f00\u59cb\u843d\u540e\uff0c\u5e76\u4e14\u7531\u4e8e\u6240\u6709\u7684 \"\u6b7b \"\u884c\uff0c\u8868\u4f1a\u8d8a\u6765\u8d8a\u5927\uff0c\u4f7f\u5f97\u6240\u6709\u7684\u4e1c\u897f\u90fd\u88ab\u78c1\u76d8\u675f\u7f1a\uff0c\u975e\u5e38\u7f13\u6162\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8981\u9650\u5236\u65b0\u884c\u7684\u64cd\u4f5c\uff0c\u5e76\u901a\u8fc7\u8c03\u6574innodb_max_purge_lag\u7cfb\u7edf\u53d8\u91cf\u4e3a\u6e05\u9664\u7ebf\u7a0b\u5206\u914d\u66f4\u591a\u8d44\u6e90\u3002\u6b32\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u7b2c14.8.10\u8282\uff0c\"\u6e05\u9664\u914d\u7f6e\"\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_1","title":"\u591a\u7248\u672c\u548c\u4e8c\u7ea7\u7d22\u5f15","text":"<p>InnoDB\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08MVCC\uff09\u5bf9\u5f85\u4e8c\u7ea7\u7d22\u5f15\u7684\u65b9\u5f0f\u4e0e\u805a\u96c6\u7d22\u5f15\u4e0d\u540c\u3002\u805a\u96c6\u7d22\u5f15\u4e2d\u7684\u8bb0\u5f55\u662f\u5c31\u5730\u66f4\u65b0\u7684\uff0c\u5176\u9690\u85cf\u7684\u7cfb\u7edf\u5217\u6307\u5411undoLog\u6761\u76ee\uff0c\u53ef\u4ee5\u4ece\u4e2d\u91cd\u5efa\u8bb0\u5f55\u7684\u65e9\u671f\u7248\u672c\u3002\u4e0e\u805a\u96c6\u7d22\u5f15\u8bb0\u5f55\u4e0d\u540c\uff0c\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u4e0d\u5305\u542b\u9690\u85cf\u7684\u7cfb\u7edf\u5217\uff0c\u4e5f\u4e0d\u5728\u539f\u5730\u66f4\u65b0\u3002</p> <p>\u5f53\u4e00\u4e2a\u4e8c\u7ea7\u7d22\u5f15\u5217\u88ab\u66f4\u65b0\u65f6\uff0c\u65e7\u7684\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u88ab\u6807\u8bb0\u5220\u9664\uff0c\u65b0\u7684\u8bb0\u5f55\u88ab\u63d2\u5165\uff0c\u800c\u88ab\u5220\u9664\u6807\u8bb0\u7684\u8bb0\u5f55\u6700\u7ec8\u88ab\u6e05\u9664\u3002\u5f53\u4e00\u4e2a\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u88ab\u6807\u8bb0\u5220\u9664\u6216\u8005\u4e8c\u7ea7\u7d22\u5f15\u9875\u88ab\u4e00\u4e2a\u8f83\u65b0\u7684\u4e8b\u52a1\u66f4\u65b0\u65f6\uff0cInnoDB\u5728\u805a\u96c6\u7d22\u5f15\u4e2d\u67e5\u627e\u6570\u636e\u5e93\u8bb0\u5f55\u3002\u5728\u805a\u96c6\u7d22\u5f15\u4e2d\uff0c\u8bb0\u5f55\u7684DB_TRX_ID\u88ab\u68c0\u67e5\uff0c\u5982\u679c\u8be5\u8bb0\u5f55\u5728\u8bfb\u53d6\u4e8b\u52a1\u5f00\u59cb\u540e\u88ab\u4fee\u6539\uff0c\u5219\u4eceundo log \u4e2d\u68c0\u7d22\u51fa\u8be5\u8bb0\u5f55\u7684\u6b63\u786e\u7248\u672c\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u88ab\u6807\u8bb0\u4e3a\u5220\u9664\uff0c\u6216\u8005\u4e8c\u7ea7\u7d22\u5f15\u9875\u88ab\u4e00\u4e2a\u8f83\u65b0\u7684\u4e8b\u52a1\u66f4\u65b0\uff0c\u8986\u76d6\u7d22\u5f15\u6280\u672f\u5c31\u4e0d\u4f1a\u88ab\u4f7f\u7528\u3002InnoDB\u4e0d\u4f1a\u4ece\u7d22\u5f15\u7ed3\u6784\u4e2d\u8fd4\u56de\u503c\uff0c\u800c\u662f\u5728\u805a\u96c6\u7d22\u5f15\u4e2d\u67e5\u627e\u8bb0\u5f55\u3002</p> <p>\u7136\u800c\uff0c\u5982\u679c\u542f\u7528\u4e86\u7d22\u5f15\u6761\u4ef6\u4e0b\u63a8\uff08ICP\uff09\u4f18\u5316\uff0c\u5e76\u4e14WHERE\u6761\u4ef6\u7684\u4e00\u90e8\u5206\u53ef\u4ee5\u53ea\u4f7f\u7528\u7d22\u5f15\u4e2d\u7684\u5b57\u6bb5\u8fdb\u884c\u8bc4\u4f30\uff0cMySQL\u670d\u52a1\u5668\u4ecd\u7136\u5c06WHERE\u6761\u4ef6\u7684\u8fd9\u4e00\u90e8\u5206\u4e0b\u63a8\u5230\u5b58\u50a8\u5f15\u64ce\uff0c\u5728\u90a3\u91cc\u4f7f\u7528\u7d22\u5f15\u5bf9\u5176\u8fdb\u884c\u8bc4\u4f30\u3002\u5982\u679c\u6ca1\u6709\u627e\u5230\u5339\u914d\u7684\u8bb0\u5f55\uff0c\u5c31\u907f\u514d\u4e86\u805a\u96c6\u7d22\u5f15\u7684\u67e5\u627e\u3002\u5982\u679c\u627e\u5230\u4e86\u5339\u914d\u7684\u8bb0\u5f55\uff0c\u751a\u81f3\u5728\u6709\u5220\u9664\u6807\u8bb0\u7684\u8bb0\u5f55\u4e2d\uff0cInnoDB\u5728\u805a\u96c6\u7d22\u5f15\u4e2d\u67e5\u627e\u8bb0\u5f55\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#144-innodb","title":"14.4 InnoDB\u7684\u67b6\u6784","text":"<p>\u4e0b\u56fe\u663e\u793a\u4e86\u6784\u6210InnoDB\u5b58\u50a8\u5f15\u64ce\u67b6\u6784\u7684\u5185\u5b58\u548c\u78c1\u76d8\u7ed3\u6784\u3002\u6709\u5173\u6bcf\u4e2a\u7ed3\u6784\u7684\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.5 \u8282\u201cInnoDB \u5185\u5b58\u7ed3\u6784\u201d\u548c \u7b2c 14.6 \u8282\u201cInnoDB \u78c1\u76d8\u7ed3\u6784\u201d\u3002</p> <p></p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#145-innodb","title":"14.5 InnoDB\u7684\u5185\u5b58\u7ed3\u6784","text":""},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1451-buffer-pool","title":"14.5.1 Buffer Pool","text":"<p>\u7f13\u51b2\u6c60\u662f\u4e3b\u5185\u5b58\u4e2d\u7684\u4e00\u4e2a\u533a\u57df\uff0c\u7528\u4e8e\u5728InnoDB\u8bbf\u95ee\u65f6\u7f13\u5b58\u8868\u548c\u7d22\u5f15\u6570\u636e\u3002\u7f13\u51b2\u6c60\u5141\u8bb8\u76f4\u63a5\u4ece\u5185\u5b58\u8bbf\u95ee\u7ecf\u5e38\u4f7f\u7528\u7684\u6570\u636e\uff0c\u4ece\u800c\u52a0\u5feb\u5904\u7406\u901f\u5ea6\u3002\u5728\u4e13\u7528\u670d\u52a1\u5668\u4e0a\uff0c\u591a\u8fbe 80% \u7684\u7269\u7406\u5185\u5b58\u901a\u5e38\u5206\u914d\u7ed9\u7f13\u51b2\u6c60\u3002</p> <p>\u4e3a\u4e86\u63d0\u9ad8high-volume\u8bfb\u53d6\u64cd\u4f5c\u7684\u6548\u7387\uff0c\u7f13\u51b2\u6c60\u88ab\u5212\u5206\u4e3a\u53ef\u80fd\u5305\u542b\u591a\u884c\u7684pages\u9875\u3002\u4e3a\u4e86\u7f13\u5b58\u7ba1\u7406\u7684\u6548\u7387\uff0c\u7f13\u51b2\u6c60buffer pool\u88ab\u5b9e\u73b0\u4e3a linked list of pages\uff1b\u5f88\u5c11\u4f7f\u7528\u7684\u6570\u636e\u4f7f\u7528\u6700\u8fd1\u6700\u5c11\u4f7f\u7528 (LRU) \u7b97\u6cd5\u7684\u53d8\u4f53\u4ece\u7f13\u5b58\u4e2d\u8001\u5316\u3002</p> <p>\u4e86\u89e3\u5982\u4f55\u5229\u7528\u7f13\u51b2\u6c60\u5c06\u7ecf\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\u662f MySQL \u8c03\u4f18\u7684\u4e00\u4e2a\u91cd\u8981\u65b9\u9762\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#lru","title":"\u7f13\u51b2\u6c60 LRU \u7b97\u6cd5","text":"<p>\u7f13\u51b2\u6c60\u4f7f\u7528\u5217\u8868\u8fdb\u884c\u7ba1\u7406\uff0c\u4f7f\u7528 LRU \u7b97\u6cd5\u7684\u53d8\u4f53\u3002\u5f53\u5411buffer pool,\u6dfb\u52a0\u65b0\u9875\u9762\u9700\u8981\u7a7a\u95f4\u65f6\uff0c\u6700\u8fd1\u6700\u5c11\u4f7f\u7528\u7684\u9875\u9762\u4f1a\u88ab\u9010\u51fa\uff0c\u5e76\u5c06\u65b0\u9875\u9762\u6dfb\u52a0\u5230\u5217\u8868\u4e2d\u95f4\u3002\u6b64\u4e2d\u70b9\u63d2\u5165\u7b56\u7565\u5c06\u5217\u8868\u89c6\u4e3a\u4e24\u4e2a\u5b50\u5217\u8868\uff1a</p> <ul> <li>\u5728\u5934\u90e8\uff0c\u6700\u8fd1\u8bbf\u95ee\u7684\u65b0\uff08\u201c\u5e74\u8f7b\u201d\uff09\u9875\u9762 \u7684\u5b50\u5217\u8868</li> <li>\u5728\u5c3e\u90e8\uff0c\u8f83\u5c11\u8bbf\u95ee\u8fc7\u7684\u65e7\u9875\u9762\u7684\u5b50\u5217\u8868</li> </ul> <p></p> <p>\u8be5\u7b97\u6cd5\u5c06\u7ecf\u5e38\u4f7f\u7528\u7684\u9875\u9762\u4fdd\u7559\u5728\u65b0\u7684\u5b50\u5217\u8868\u4e2d\u3002\u65e7\u7684\u5b50\u5217\u8868\u5305\u542b\u4e0d\u592a\u5e38\u7528\u7684\u9875\u9762\uff1b\u8fd9\u4e9b\u9875\u9762\u662f\u9a71\u9010\u7684\u5019\u9009\u9875\u9762\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7b97\u6cd5\u64cd\u4f5c\u5982\u4e0b\uff1a</p> <ul> <li>\u7f13\u51b2\u6c60\u7684 3/8 \u4e13\u7528\u4e8e\u65e7\u5b50\u5217\u8868\u3002</li> <li>\u5217\u8868\u7684\u4e2d\u70b9\u662f\u65b0\u5b50\u5217\u8868\u5c3e\u90e8\u4e0e\u65e7\u5b50\u5217\u8868\u5934\u90e8\u76f8\u4ea4\u7684\u8fb9\u754c\u3002</li> <li>\u5f53InnoDB\u5c06\u9875\u9762\u8bfb\u5165\u7f13\u51b2\u6c60\u65f6\uff0c\u5b83\u6700\u521d\u5c06\u5b83\u63d2\u5165\u5230\u4e2d\u70b9\uff08\u65e7\u5b50\u5217\u8868\u7684\u5934\u90e8\uff09\u3002\u53ef\u4ee5\u8bfb\u53d6\u9875\u9762\uff0c\u56e0\u4e3a\u5b83\u662f\u7528\u6237\u542f\u52a8\u7684\u64cd\u4f5c\uff08\u4f8b\u5982 SQL \u67e5\u8be2\uff09\u6240\u5fc5\u9700\u7684\uff0c\u6216\u8005\u662f\u7531 \u81ea\u52a8\u6267\u884c\u7684\u9884\u8bfb\u64cd\u4f5c\u7684\u4e00\u90e8\u5206InnoDB\u3002</li> <li>\u8bbf\u95ee\u65e7\u5b50\u5217\u8868\u4e2d\u7684\u9875\u9762\u4f7f\u5176 \u201c\u5e74\u8f7b\u201d\uff0c\u5c06\u5176\u79fb\u52a8\u5230\u65b0\u5b50\u5217\u8868\u7684\u5934\u90e8\u3002\u5982\u679c\u9875\u9762\u662f\u56e0\u4e3a\u7528\u6237\u542f\u52a8\u7684\u64cd\u4f5c\u9700\u8981\u5b83\u800c\u88ab\u8bfb\u53d6\uff0c\u5219\u7b2c\u4e00\u6b21\u8bbf\u95ee\u4f1a\u7acb\u5373\u53d1\u751f\uff0c\u5e76\u4e14\u9875\u9762\u4f1a\u53d8\u5e74\u8f7b\u3002\u5982\u679c\u9875\u9762\u662f\u7531\u4e8e\u9884\u8bfb\u64cd\u4f5c\u800c\u8bfb\u53d6\u7684\uff0c\u5219\u7b2c\u4e00\u6b21\u8bbf\u95ee\u4e0d\u4f1a\u7acb\u5373\u53d1\u751f\uff0c\u5e76\u4e14\u5728\u9875\u9762\u88ab\u9010\u51fa\u4e4b\u524d\u53ef\u80fd\u6839\u672c\u4e0d\u4f1a\u53d1\u751f\u3002</li> <li>\u968f\u7740\u6570\u636e\u5e93\u7684\u8fd0\u884c\uff0c\u7f13\u51b2\u6c60\u4e2d\u672a\u88ab\u8bbf\u95ee\u7684\u9875\u9762\u4f1a\u901a\u8fc7\u5411\u5217\u8868\u5c3e\u90e8\u79fb\u52a8\u6765\u201c\u8001\u5316\u201d\u3002\u65b0\u65e7\u5b50\u5217\u8868\u4e2d\u7684\u9875\u9762\u968f\u7740\u5176\u4ed6\u9875\u9762\u7684\u66f4\u65b0\u800c\u8001\u5316\u3002\u65e7\u5b50\u5217\u8868\u4e2d\u7684\u9875\u9762\u4e5f\u4f1a\u968f\u7740\u9875\u9762\u63d2\u5165\u4e2d\u70b9\u800c\u8001\u5316\u3002\u6700\u7ec8\uff0c\u4e00\u4e2a\u672a\u4f7f\u7528\u7684\u9875\u9762\u5230\u8fbe\u65e7\u5b50\u5217\u8868\u7684\u5c3e\u90e8\u5e76\u88ab\u9a71\u9010\u3002</li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u67e5\u8be2\u8bfb\u53d6\u7684\u9875\u9762\u4f1a\u7acb\u5373\u79fb\u52a8\u5230\u65b0\u7684\u5b50\u5217\u8868\u4e2d\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u5728\u7f13\u51b2\u6c60\u4e2d\u505c\u7559\u7684\u65f6\u95f4\u66f4\u957f\u3002\u4f8b\u5982\uff0cmysqldump\u64cd\u4f5c\u6216\u6ca1\u6709WHERE\u5b50\u53e5\u7684 SELECT\u8bed\u53e5 \u6267\u884c\u7684\u8868\u626b\u63cf\u53ef\u4ee5\u5c06\u5927\u91cf\u6570\u636e\u5e26\u5165\u7f13\u51b2\u6c60\u5e76\u9a71\u9010\u7b49\u91cf\u7684\u65e7\u6570\u636e\uff0c\u5373\u4f7f\u65b0\u6570\u636e\u4e0d\u518d\u4f7f\u7528\u3002\u7c7b\u4f3c\u5730\uff0c\u7531\u9884\u8bfb\u540e\u53f0\u7ebf\u7a0b\u52a0\u8f7d\u4e14\u4ec5\u8bbf\u95ee\u4e00\u6b21\u7684\u9875\u9762\u88ab\u79fb\u52a8\u5230\u65b0\u5217\u8868\u7684\u5934\u90e8\u3002\u8fd9\u4e9b\u60c5\u51b5\u4f1a\u5c06\u7ecf\u5e38\u4f7f\u7528\u7684\u9875\u9762\u63a8\u9001\u5230\u65e7\u7684\u5b50\u5217\u8868\uff0c\u5728\u90a3\u91cc\u5b83\u4eec\u4f1a\u88ab\u9010\u51fa\u3002\u6709\u5173\u4f18\u5316\u6b64\u884c\u4e3a\u7684\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.8.3.3 \u8282\uff0c\u201c\u4f7f\u7f13\u51b2\u6c60\u626b\u63cf\u5177\u6709\u62b5\u6297\u6027\u201d\u548c \u7b2c 14.8.3.4 \u8282\uff0c\u201c\u914d\u7f6e InnoDB \u7f13\u51b2\u6c60\u9884\u53d6\uff08\u9884\u8bfb\uff09\u201d\u3002</p> <p>InnoDB\u6807\u51c6\u76d1\u89c6\u5668\u8f93\u51fa\u5728<code>BUFFER POOL AND MEMORY</code>\u6709\u5173\u7f13\u51b2\u6c60 LRU \u7b97\u6cd5\u64cd\u4f5c\u7684\u90e8\u5206\u4e2d\u5305\u542b\u591a\u4e2a\u5b57\u6bb5\u3002\u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u4f7f\u7528 InnoDB \u6807\u51c6\u76d1\u89c6\u5668\u76d1\u89c6\u7f13\u51b2\u6c60\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_2","title":"\u7f13\u51b2\u6c60\u914d\u7f6e","text":"<p>\u60a8\u53ef\u4ee5\u914d\u7f6e\u7f13\u51b2\u6c60\u7684\u5404\u4e2a\u65b9\u9762\u4ee5\u63d0\u9ad8\u6027\u80fd</p> <ul> <li>\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u60a8\u5c06\u7f13\u51b2\u6c60\u7684\u5927\u5c0f\u8bbe\u7f6e\u4e3a\u5c3d\u53ef\u80fd\u5927\u7684\u503c\uff0c\u4ece\u800c\u4e3a\u670d\u52a1\u5668\u4e0a\u7684\u5176\u4ed6\u8fdb\u7a0b\u7559\u51fa\u8db3\u591f\u7684\u5185\u5b58\u6765\u8fd0\u884c\u800c\u4e0d\u4f1a\u4ea7\u751f\u8fc7\u591a\u7684\u5206\u9875\u3002\u7f13\u51b2\u6c60\u8d8a\u5927\uff0c\u5c31\u8d8aInnoDB\u50cf\u5185\u5b58\u6570\u636e\u5e93\uff0c\u4ece\u78c1\u76d8\u8bfb\u53d6\u6570\u636e\u4e00\u6b21\uff0c\u7136\u540e\u5728\u540e\u7eed\u8bfb\u53d6\u671f\u95f4\u4ece\u5185\u5b58\u8bbf\u95ee\u6570\u636e\u3002\u8bf7\u53c2\u9605 \u7b2c 14.8.3.1 \u8282\uff0c\u201c\u914d\u7f6e InnoDB \u7f13\u51b2\u6c60\u5927\u5c0f\u201d\u3002</li> <li>\u5728\u5177\u6709\u8db3\u591f\u5185\u5b58\u7684 64 \u4f4d\u7cfb\u7edf\u4e0a\uff0c\u60a8\u53ef\u4ee5\u5c06\u7f13\u51b2\u6c60\u62c6\u5206\u4e3a\u591a\u4e2a\u90e8\u5206\uff0c\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u51cf\u5c11\u5e76\u53d1\u64cd\u4f5c\u4e4b\u95f4\u5bf9\u5185\u5b58\u7ed3\u6784\u7684\u4e89\u7528\u3002\u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u7b2c 14.8.3.2 \u8282\uff0c\u201c\u914d\u7f6e\u591a\u4e2a\u7f13\u51b2\u6c60\u5b9e\u4f8b\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u5c06\u7ecf\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u4fdd\u7559\u5728\u5185\u5b58\u4e2d\uff0c\u800c\u4e0d\u7ba1\u64cd\u4f5c\u7684\u6d3b\u52a8\u7a81\u7136\u6fc0\u589e\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u4f1a\u5c06\u5927\u91cf\u4e0d\u5e38\u8bbf\u95ee\u7684\u6570\u636e\u5e26\u5165\u7f13\u51b2\u6c60\u3002\u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.8.3.3 \u8282\uff0c\u201c\u4f7f\u7f13\u51b2\u6c60\u626b\u63cf\u62b5\u6297\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u63a7\u5236\u5982\u4f55\u4ee5\u53ca\u4f55\u65f6\u6267\u884c\u9884\u8bfb\u8bf7\u6c42\u4ee5\u5f02\u6b65\u5730\u5c06\u9875\u9762\u9884\u53d6\u5230\u7f13\u51b2\u6c60\u4e2d\uff0c\u4ee5\u9884\u671f\u5f88\u5feb\u5c31\u4f1a\u9700\u8981\u8fd9\u4e9b\u9875\u9762\u3002\u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.8.3.4 \u8282\uff0c\u201c\u914d\u7f6e InnoDB \u7f13\u51b2\u6c60\u9884\u53d6\uff08\u9884\u8bfb\uff09\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u63a7\u5236\u4f55\u65f6\u53d1\u751f\u540e\u53f0\u5237\u65b0\u4ee5\u53ca\u662f\u5426\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\u52a8\u6001\u8c03\u6574\u5237\u65b0\u901f\u7387\u3002\u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.8.3.5 \u8282\uff0c\u201c\u914d\u7f6e\u7f13\u51b2\u6c60\u5237\u65b0\u201d\u3002</li> <li>\u60a8\u53ef\u4ee5\u914d\u7f6e\u5982\u4f55InnoDB\u4fdd\u7559\u5f53\u524d\u7f13\u51b2\u6c60\u72b6\u6001\u4ee5\u907f\u514d\u670d\u52a1\u5668\u91cd\u65b0\u542f\u52a8\u540e\u7684\u957f\u65f6\u95f4\u9884\u70ed\u3002\u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.8.3.6 \u8282\uff0c\u201c\u4fdd\u5b58\u548c\u6062\u590d\u7f13\u51b2\u6c60\u72b6\u6001\u201d\u3002</li> </ul>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#innodbbuffer-pool","title":"\u4f7f\u7528InnoDB\u6807\u51c6\u76d1\u89c6\u5668\u76d1\u89c6Buffer Pool","text":"<pre><code> SHOW ENGINE INNODB STATUS\n</code></pre> <p>\u53ef\u4ee5\u67e5\u770bBuffer Pool\u7684\u5404\u9879\u6307\u6807\u548c\u5185\u5b58\u4f7f\u7528</p> <pre><code>----------------------\nBUFFER POOL AND MEMORY\n----------------------\nTotal large memory allocated 2198863872\nDictionary memory allocated 776332\nBuffer pool size   131072\nFree buffers       124908\nDatabase pages     5720\nOld database pages 2071\nModified db pages  910\nPending reads 0\nPending writes: LRU 0, flush list 0, single page 0\nPages made young 4, not young 0\n0.10 youngs/s, 0.00 non-youngs/s\nPages read 197, created 5523, written 5060\n0.00 reads/s, 190.89 creates/s, 244.94 writes/s\nBuffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not\n0 / 1000\nPages read ahead 0.00/s, evicted without access 0.00/s, Random read\nahead 0.00/s\nLRU len: 5720, unzip_LRU len: 0\nI/O sum[0]:cur[0], unzip sum[0]:cur[0]\n</code></pre> <p>M\u6570\u636e\u5e93T\u670d\u52a1\u5668\u914d\u7f6e\uff1a</p> <p>BufferPool\u5927\u5c0f\uff1a20GB \uff0c\u4e3b\u673a\u914d\u7f6e 16c 28G 600G PCIE-SSID</p> <p>\u4e3b\u4ece\u67b6\u6784\uff0c\u4e00\u4e3b\u4e8c\u4ece</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1452-change-buffer","title":"14.5.2 Change Buffer","text":"<p>Change Buffer\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5f53\u4e8c\u7ea7\u7d22\u5f15\u9875\u7684\u6539\u53d8\u4e0d\u5728buffer pool\u65f6\uff0c\u5b83\u53ef\u4ee5\u7f13\u5b58\u8fd9\u4e9b\u9875\u7684\u53d8\u66f4\u3002\u8fd9\u4e9b\u7f13\u51b2\u533a\u7684\u53d8\u66f4\uff0c\u53ef\u80fd\u6765\u81ea\u4e8eINSERT\u3001UPDATE\u6216DELETE\u64cd\u4f5c\uff08DML\uff09,\u5f53\u8fd9\u4e9b\u9875\u88ab\u5176\u4ed6\u8bfb\u64cd\u4f5c\u52a0\u8f7d\u5230buffer pool\uff0c\u8fd9\u4e9b\u53d8\u66f4\u5c06\u88ab\u5408\u5e76\u3002</p> <p></p> <p>\u4e0e\u805a\u96c6\u7d22\u5f15\u4e0d\u540c\uff0c\u4e8c\u7ea7\u7d22\u5f15\u901a\u5e38\u662f\u975e\u552f\u4e00\u7684\uff0c\u800c\u4e14\u5bf9\u4e8c\u7ea7\u7d22\u5f15\u7684\u63d2\u5165\u662f\u4ee5\u76f8\u5bf9\u968f\u673a\u7684\u987a\u5e8f\u8fdb\u884c\u7684\u3002\u540c\u6837\u5730\uff0c\u5220\u9664\u548c\u66f4\u65b0\u53ef\u80fd\u4f1a\u5f71\u54cd\u5230\u5728\u7d22\u5f15\u6811\u4e2d\u4e0d\u76f8\u90bb\u7684\u4e8c\u7ea7\u7d22\u5f15\u9875\u3002\u5f53\u53d7\u5f71\u54cd\u7684\u9875\u9762\u88ab\u5176\u4ed6\u64cd\u4f5c\u8bfb\u5165\u7f13\u51b2\u6c60\u65f6\uff0c\u5728\u7a0d\u540e\u7684\u65f6\u95f4\u5408\u5e76\u7f13\u5b58\u7684\u53d8\u5316\uff0c\u907f\u514d\u4e86\u5927\u91cf\u7684\u968f\u673a\u8bbf\u95eeI/O\uff0c\u800c\u8fd9\u662f\u9700\u8981\u4ece\u78c1\u76d8\u4e0a\u5c06\u4e8c\u7ea7\u7d22\u5f15\u9875\u9762\u8bfb\u5165\u7f13\u51b2\u6c60\u7684\u3002</p> <p>\u5f53\u7cfb\u7edf\u5927\u90e8\u5206\u65f6\u95f4\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u65f6\uff0c\u6216\u5728\u7f13\u6162\u5173\u673a\u671f\u95f4\uff0c\u5b9a\u671f\u8fd0\u884c\u6e05\u9664\u64cd\u4f5c\uff0c\u5c06\u66f4\u65b0\u7684\u7d22\u5f15\u9875\u5199\u5165\u78c1\u76d8\u3002\u6e05\u9664\u64cd\u4f5c\u53ef\u4ee5\u5c06\u4e00\u7cfb\u5217\u7684\u7d22\u5f15\u503c\u5199\u5165\u78c1\u76d8\u5757\uff0c\u6bd4\u6bcf\u4e2a\u503c\u7acb\u5373\u5199\u5165\u78c1\u76d8\u66f4\u6709\u6548\u7387\u3002</p> <p>\u5f53\u6709\u8bb8\u591a\u53d7\u5f71\u54cd\u7684\u884c\u548c\u8bb8\u591a\u4e8c\u7ea7\u7d22\u5f15\u9700\u8981\u66f4\u65b0\u65f6\uff0c\u53d8\u66f4\u7f13\u51b2\u533a\u7684\u5408\u5e76\u53ef\u80fd\u9700\u8981\u51e0\u4e2a\u5c0f\u65f6\u3002\u5728\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u78c1\u76d8I/O\u4f1a\u589e\u52a0\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5bf9\u78c1\u76d8\u7ed1\u5b9a\u7684\u67e5\u8be2\u7684\u663e\u8457\u51cf\u6162\u3002\u5728\u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u751a\u81f3\u5728\u670d\u52a1\u5668\u5173\u95ed\u548c\u91cd\u542f\u540e\uff0c\u53d8\u66f4\u7f13\u51b2\u533a\u7684\u5408\u5e76\u4e5f\u53ef\u80fd\u7ee7\u7eed\u53d1\u751f\uff08\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u89c1\u7ae0\u828214.22.2\uff0c\"\u5f3a\u5236InnoDB\u6062\u590d\"\uff09\u3002</p> <p>\u5728\u5185\u5b58\u4e2d\uff0cChange Buffer\u5360\u636e\u4e86\u7f13\u51b2\u6c60\u7684\u4e00\u90e8\u5206\u3002\u5728\u78c1\u76d8\u4e0a\uff0cChange Buffer\u662f\u7cfb\u7edf\u8868\u7a7a\u95f4\u7684\u4e00\u90e8\u5206\uff0c\u5f53\u6570\u636e\u5e93\u670d\u52a1\u5668\u5173\u95ed\u65f6\uff0c\u7d22\u5f15\u53d8\u5316\u88ab\u7f13\u51b2\u5728\u8fd9\u91cc\u3002</p> <p>\u7f13\u5b58\u5728Change Buffer\u7684\u6570\u636e\u7c7b\u578b\u7531innodb_change_buffering\u53d8\u91cf\u63a7\u5236\u3002\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u914d\u7f6e\u53d8\u5316\u7f13\u51b2\u3002\u4f60\u4e5f\u53ef\u4ee5\u914d\u7f6e\u6700\u5927\u7684\u53d8\u5316\u7f13\u51b2\u533a\u5927\u5c0f\u3002\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u914d\u7f6e\u53d8\u66f4\u7f13\u51b2\u533a\u7684\u6700\u5927\u5c3a\u5bf8\u3002</p> <p>\u5982\u679c\u7d22\u5f15\u5305\u542b\u4e00\u4e2a\u964d\u5e8f\u7d22\u5f15\u5217\u6216\u8005\u4e3b\u952e\u5305\u542b\u4e00\u4e2a\u964d\u5e8f\u7d22\u5f15\u5217\uff0c\u5219\u4e0d\u652f\u6301\u4e8c\u7ea7\u7d22\u5f15\u7684\u53d8\u66f4\u7f13\u51b2\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#change-buffer","title":"\u914d\u7f6eChange Buffer","text":"<p>\u5f53\u5bf9\u8868\u8fdb\u884cINSERT\u3001UPDATE\u548cDELETE\u64cd\u4f5c\u65f6\uff0c\u7d22\u5f15\u5217\u7684\u503c\uff08\u7279\u522b\u662f\u6b21\u8981\u952e\u7684\u503c\uff09\u901a\u5e38\u662f\u4ee5\u672a\u6392\u5e8f\u7684\u987a\u5e8f\u8fdb\u884c\u7684\uff0c\u9700\u8981\u5927\u91cf\u7684I/O\u6765\u4f7f\u6b21\u8981\u7d22\u5f15\u8fbe\u5230\u6700\u65b0\u72b6\u6001\u3002\u5f53\u76f8\u5173\u9875\u9762\u4e0d\u5728\u7f13\u51b2\u6c60\u4e2d\u65f6\uff0cChange Buffer\u4f1a\u5bf9\u4e8c\u7ea7\u7d22\u5f15\u9879\u7684\u53d8\u5316\u8fdb\u884c\u7f13\u5b58\uff0c\u4ece\u800c\u907f\u514d\u4e86\u6602\u8d35\u7684I/O\u64cd\u4f5c\uff0c\u56e0\u4e3a\u4e0d\u4f1a\u7acb\u5373\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u9875\u9762\u3002\u5f53\u9875\u9762\u88ab\u52a0\u8f7d\u5230\u7f13\u51b2\u6c60\u4e2d\u65f6\uff0c\u7f13\u51b2\u533a\u7684\u53d8\u5316\u88ab\u5408\u5e76\uff0c\u66f4\u65b0\u7684\u9875\u9762\u968f\u540e\u88ab\u5237\u65b0\u5230\u78c1\u76d8\u3002InnoDB\u4e3b\u7ebf\u7a0b\u5728\u670d\u52a1\u5668\u63a5\u8fd1\u7a7a\u95f2\u65f6\uff0c\u4ee5\u53ca\u5728\u7f13\u6162\u5173\u673a\u65f6\u5408\u5e76\u7f13\u51b2\u53d8\u5316\u3002</p> <p>\u56e0\u4e3a\u5b83\u53ef\u4ee5\u5bfc\u81f4\u66f4\u5c11\u7684\u78c1\u76d8\u8bfb\u5199\uff0c\u6240\u4ee5Change Buffer\u5bf9I/O\u7ed1\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6700\u6709\u4ef7\u503c\uff1b\u4f8b\u5982\uff0c\u6709\u5927\u91cfDML\u64cd\u4f5c\u7684\u5e94\u7528\uff0c\u5982\u6279\u91cf\u63d2\u5165\uff0c\u90fd\u4f1a\u4eceChange Buffer\u4e2d\u53d7\u76ca\u3002</p> <p>\u7136\u800c\uff0cChange Buffer\u5360\u636e\u4e86\u7f13\u51b2\u6c60\u7684\u4e00\u90e8\u5206\uff0c\u51cf\u5c11\u4e86\u53ef\u7528\u4e8e\u7f13\u5b58\u6570\u636e\u9875\u7684\u5185\u5b58\u3002\u5982\u679c\u5de5\u4f5c\u96c6\u51e0\u4e4e\u9002\u5408\u4e8e\u7f13\u51b2\u6c60\uff0c\u6216\u8005\u5982\u679c\u4f60\u7684\u8868\u6709\u76f8\u5bf9\u8f83\u5c11\u7684\u4e8c\u7ea7\u7d22\u5f15\uff0c\u7981\u7528\u53d8\u5316\u7f13\u51b2\u53ef\u80fd\u662f\u6709\u7528\u7684\u3002\u5982\u679c\u5de5\u4f5c\u6570\u636e\u96c6\u5b8c\u5168\u5728\u7f13\u51b2\u6c60\u4e2d\uff0cChange Buffer\u4e0d\u4f1a\u5e26\u6765\u989d\u5916\u7684\u5f00\u9500\uff0c\u56e0\u4e3a\u5b83\u53ea\u9002\u7528\u4e8e\u4e0d\u5728\u7f13\u51b2\u6c60\u4e2d\u7684\u9875\u9762\u3002</p> <p>innodb_change_buffering\u53d8\u91cf\u63a7\u5236InnoDB\u6267\u884c\u53d8\u5316\u7f13\u51b2\u7684\u7a0b\u5ea6\u3002\u4f60\u53ef\u4ee5\u4e3a\u63d2\u5165\u3001\u5220\u9664\u64cd\u4f5c\uff08\u5f53\u7d22\u5f15\u8bb0\u5f55\u6700\u521d\u88ab\u6807\u8bb0\u4e3a\u5220\u9664\u65f6\uff09\u548c\u6e05\u9664\u64cd\u4f5c\uff08\u5f53\u7d22\u5f15\u8bb0\u5f55\u88ab\u7269\u7406\u5220\u9664\u65f6\uff09\u542f\u7528\u6216\u7981\u7528\u7f13\u51b2\u3002\u4e00\u4e2a\u66f4\u65b0\u64cd\u4f5c\u662f\u63d2\u5165\u548c\u5220\u9664\u7684\u7ec4\u5408\u3002\u9ed8\u8ba4\u7684innodb_change_buffering\u503c\u662f\u5168\u90e8\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#146-innodb","title":"14.6 InnoDB\u78c1\u76d8\u7ed3\u6784","text":""},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1462","title":"14.6.2 \u7d22\u5f15","text":""},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14621","title":"14.6.2.1 \u805a\u96c6\u7d22\u5f15\u548c\u4e8c\u7ea7\u7d22\u5f15","text":"<p>\u6bcf\u4e2aInnoDB\u8868\u90fd\u6709\u4e00\u4e2a\u79f0\u4e3a\u805a\u96c6\u7d22\u5f15\u7684\u7279\u6b8a\u7d22\u5f15\uff0c\u7528\u4e8e\u5b58\u50a8\u884c\u6570\u636e\u3002\u901a\u5e38\uff0c\u805a\u96c6\u7d22\u5f15\u4e0e\u4e3b\u952e\u540c\u4e49\u3002\u4e3a\u4e86\u4ece\u67e5\u8be2\u3001\u63d2\u5165\u548c\u5176\u4ed6\u6570\u636e\u5e93\u64cd\u4f5c\u4e2d\u83b7\u5f97\u6700\u4f73\u6027\u80fd\uff0c\u4e86\u89e3\u5982\u4f55InnoDB\u4f7f\u7528\u805a\u96c6\u7d22\u5f15\u6765\u4f18\u5316\u5e38\u89c1\u67e5\u627e\u548c DML \u64cd\u4f5c\u975e\u5e38\u91cd\u8981\u3002</p> <ul> <li>\u5728\u8868\u4e0a\u5b9a\u4e49<code>PRIMARY KEY</code>a\u65f6\uff0cInnoDB\u5c06\u5176\u7528\u4f5c\u805a\u96c6\u7d22\u5f15\u3002\u5e94\u8be5\u4e3a\u6bcf\u4e2a\u8868\u5b9a\u4e49\u4e00\u4e2a\u4e3b\u952e\u3002\u5982\u679c\u6ca1\u6709\u903b\u8f91\u552f\u4e00\u4e14\u975e\u7a7a\u7684\u5217\u6216\u5217\u96c6\u4f7f\u7528\u4e3b\u952e\uff0c\u8bf7\u6dfb\u52a0\u81ea\u52a8\u589e\u91cf\u5217\u3002\u81ea\u52a8\u9012\u589e\u5217\u503c\u662f\u552f\u4e00\u7684\uff0c\u5e76\u5728\u63d2\u5165\u65b0\u884c\u65f6\u81ea\u52a8\u6dfb\u52a0\u3002</li> <li>\u5982\u679c\u6ca1\u6709\u4e3a\u8868\u5b9a\u4e49<code>PRIMARY KEY</code> a \uff0c\u5219InnoDB\u4f7f\u7528\u7b2c\u4e00\u4e2a <code>UNIQUE</code>\u7d22\u5f15\uff0c\u5e76\u5c06\u6240\u6709\u952e\u5217\u5b9a\u4e49\u4e3a<code>NOT NULL</code>\u805a\u96c6\u7d22\u5f15\u3002</li> <li>\u5982\u679c\u8868\u6ca1\u6709\u7d22\u5f15<code>PRIMARY KEY</code>\u6216\u6ca1\u6709\u5408\u9002\u7684 <code>UNIQUE</code>\u7d22\u5f15\uff0c\u5219InnoDB \u751f\u6210\u4ee5<code>GEN_CLUST_INDEX</code>\u5305\u542b\u884c ID \u503c\u7684\u5408\u6210\u5217\u547d\u540d\u7684\u9690\u85cf\u805a\u96c6\u7d22\u5f15 \u3002\u884c\u6309InnoDB\u5206\u914d\u7684\u884c ID \u6392\u5e8f\u3002\u884c ID \u662f\u4e00\u4e2a 6 \u5b57\u8282\u7684\u5b57\u6bb5\uff0c\u968f\u7740\u63d2\u5165\u65b0\u884c\u800c\u5355\u8c03\u589e\u52a0\u3002\u56e0\u6b64\uff0c\u6309\u884c ID \u6392\u5e8f\u7684\u884c\u5728\u7269\u7406\u4e0a\u662f\u6309\u63d2\u5165\u987a\u5e8f\u6392\u5217\u7684\u3002</li> </ul>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_3","title":"\u805a\u96c6\u7d22\u5f15\u5982\u4f55\u52a0\u5feb\u67e5\u8be2\u901f\u5ea6","text":"<p>\u901a\u8fc7\u805a\u96c6\u7d22\u5f15\u8bbf\u95ee\u4e00\u884c\u5f88\u5feb\uff0c\u56e0\u4e3a\u7d22\u5f15\u641c\u7d22\u76f4\u63a5\u6307\u5411\u5305\u542b\u884c\u6570\u636e\u7684\u9875\u9762\u3002\u5982\u679c\u8868\u5f88\u5927\uff0c\u4e0e\u4f7f\u7528\u4e0e\u7d22\u5f15\u8bb0\u5f55\u4e0d\u540c\u7684\u9875\u9762\u5b58\u50a8\u884c\u6570\u636e\u7684\u5b58\u50a8\u7ec4\u7ec7\u76f8\u6bd4\uff0c\u805a\u7c07\u7d22\u5f15\u4f53\u7cfb\u7ed3\u6784\u901a\u5e38\u53ef\u4ee5\u8282\u7701\u78c1\u76d8 I/O \u64cd\u4f5c\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_4","title":"\u4e8c\u7ea7\u7d22\u5f15\u4e0e\u805a\u96c6\u7d22\u5f15\u7684\u5173\u7cfb","text":"<p>\u805a\u96c6\u7d22\u5f15\u4ee5\u5916\u7684\u7d22\u5f15\u79f0\u4e3a\u4e8c\u7ea7\u7d22\u5f15\u3002\u5728InnoDB\u4e2d\uff0c\u4e8c\u7ea7\u7d22\u5f15\u4e2d\u7684\u6bcf\u6761\u8bb0\u5f55\u90fd\u5305\u542b\u8be5\u884c\u7684\u4e3b\u952e\u5217\uff0c\u4ee5\u53ca\u6307\u5b9a\u4e3a\u4e8c\u7ea7\u7d22\u5f15\u7684\u5217\u3002InnoDB\u4f7f\u7528\u6b64\u4e3b\u952e\u503c\u53bb\u805a\u96c6\u7d22\u5f15\u4e2d\u641c\u7d22\u8be5\u884c\u3002</p> <p>\u5982\u679c\u4e3b\u952e\u5f88\u957f\uff0c\u4e8c\u7ea7\u7d22\u5f15\u4f1a\u5360\u7528\u66f4\u591a\u7684\u7a7a\u95f4\uff0c\u6240\u4ee5\u4e3b\u952e\u77ed\u662f\u6709\u5229\u7684\u3002</p> <p>\u6709\u5173\u5229\u7528InnoDB \u805a\u96c6\u7d22\u5f15\u548c\u4e8c\u7ea7\u7d22\u5f15\u7684\u6307\u5357\uff0c\u8bf7\u53c2\u9605 \u7b2c 8.3 \u8282 \u201c\u4f18\u5316\u548c\u7d22\u5f15\u201d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14622-innodb","title":"14.6.2.2 InnoDB \u7d22\u5f15\u7684\u7269\u7406\u7ed3\u6784","text":"<p>\u9664\u7a7a\u95f4\u7d22\u5f15\uff08spatial indexes\uff09\u5916\uff0cInnoDB \u7d22\u5f15\u90fd\u662fB \u6811\u6570\u636e\u7ed3\u6784\u3002\u7a7a\u95f4\u7d22\u5f15\u4f7f\u7528 R \u6811\uff0c\u5b83\u662f\u7528\u4e8e\u7d22\u5f15\u591a\u7ef4\u6570\u636e\u7684\u4e13\u7528\u6570\u636e\u7ed3\u6784\u3002\u7d22\u5f15\u8bb0\u5f55\u5b58\u50a8\u5728\u5176 B \u6811\u6216 R \u6811\u6570\u636e\u7ed3\u6784\u7684\u53f6\u9875\u4e2d\u3002\u7d22\u5f15\u9875\u7684\u9ed8\u8ba4\u5927\u5c0f\u4e3a 16KB\u3002\u9875\u5927\u5c0f\u7531<code>innodb_page_size</code>MySQL \u5b9e\u4f8b\u521d\u59cb\u5316\u65f6\u7684\u8bbe\u7f6e\u51b3\u5b9a \u3002\u8bf7\u53c2\u9605 \u7b2c 14.8.1 \u8282\uff0c\u201cInnoDB \u542f\u52a8\u914d\u7f6e\u201d\u3002</p> <p>\u5f53\u65b0\u8bb0\u5f55\u63d2\u5165\u5230InnoDB \u805a\u96c6\u7d22\u5f15\u4e2d\u65f6\uff0cInnoDB\u5c1d\u8bd5\u4fdd\u7559 1/16 \u7684\u9875\u9762\u7a7a\u95f2\u7a7a\u95f4\u4ee5\u4f9b\u5c06\u6765\u63d2\u5165\u548c\u66f4\u65b0\u7d22\u5f15\u8bb0\u5f55\u3002\u5982\u679c\u6309\u987a\u5e8f\uff08\u5347\u5e8f\u6216\u964d\u5e8f\uff09\u63d2\u5165\u7d22\u5f15\u8bb0\u5f55\uff0c\u5219\u751f\u6210\u7684\u7d22\u5f15\u9875\u5927\u7ea6\u4e3a 15/16\u3002\u5982\u679c\u4ee5\u968f\u673a\u987a\u5e8f\u63d2\u5165\u8bb0\u5f55\uff0c\u5219\u9875\u9762\u4ece 1/2 \u5230 15/16 \u6ee1\u3002</p> <p>InnoDB\u521b\u5efa\u6216\u91cd\u5efa B \u6811\u7d22\u5f15\u65f6\u6267\u884c\u6279\u91cf\u52a0\u8f7d\u3002\u8fd9\u79cd\u521b\u5efa\u7d22\u5f15\u7684\u65b9\u6cd5\u79f0\u4e3a\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u3002\u8be5 <code>innodb_fill_factor</code>\u53d8\u91cf\u5b9a\u4e49\u4e86\u5728\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u671f\u95f4\u586b\u5145\u7684\u6bcf\u4e2a B \u6811\u9875\u9762\u4e0a\u7684\u7a7a\u95f4\u767e\u5206\u6bd4\uff0c\u5269\u4f59\u7a7a\u95f4\u4fdd\u7559\u7528\u4e8e\u5c06\u6765\u7684\u7d22\u5f15\u589e\u957f\u3002\u7a7a\u95f4\u7d22\u5f15\u4e0d\u652f\u6301\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u3002\u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.6.2.3 \u8282\uff0c\u201c\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u201d\u3002\u4e00\u4e2a <code>innodb_fill_factor</code>100\u4e2a\u53f6\u5b50\u5728\u805a\u7c07\u7d22\u5f15\u9875\u7684\u7a7a\u95f41/16\u7684\u8bbe\u7f6e\u514d\u8d39\u4e3a\u672a\u6765\u7684\u6307\u6570\u589e\u957f\u3002</p> <p>\u5982\u679cInnoDB\u7d22\u5f15\u9875\u9762\u7684\u586b\u5145\u56e0\u5b50\u4f4e\u4e8e<code>MERGE_THRESHOLD</code>\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e3a 50%\uff0c\u5982\u679c\u672a\u6307\u5b9a\uff0c\u5219InnoDB\u5c1d\u8bd5\u6536\u7f29\u7d22\u5f15\u6811\u4ee5\u91ca\u653e\u9875\u9762\u3002\u8be5 <code>MERGE_THRESHOLD</code>\u8bbe\u7f6e\u9002\u7528\u4e8e B \u6811\u548c R \u6811\u7d22\u5f15\u3002\u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.8.12 \u8282\uff0c\u201c\u914d\u7f6e\u7d22\u5f15\u9875\u9762\u7684\u5408\u5e76\u9608\u503c\u201d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14623","title":"14.6.2.3 \u6784\u5efa\u6392\u5e8f\u7d22\u5f15","text":"<p>InnoDB\u5728\u521b\u5efa\u6216\u91cd\u5efa\u7d22\u5f15\u65f6\u6267\u884c\u6279\u91cf\u52a0\u8f7d\u800c\u4e0d\u662f\u4e00\u6b21\u63d2\u5165\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u3002\u8fd9\u79cd\u7d22\u5f15\u521b\u5efa\u65b9\u6cd5\u4e5f\u79f0\u4e3a\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u3002\u7a7a\u95f4\u7d22\u5f15\u4e0d\u652f\u6301\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u3002</p> <p>\u7d22\u5f15\u6784\u5efa\u5206\u4e3a\u4e09\u4e2a\u9636\u6bb5\u3002\u5728\u7b2c\u4e00\u9636\u6bb5\uff0c \u626b\u63cf\u805a\u96c6\u7d22\u5f15\uff0c\u751f\u6210\u7d22\u5f15\u6761\u76ee\u5e76\u6dfb\u52a0\u5230\u6392\u5e8f\u7f13\u51b2\u533a\u3002\u5f53\u6392\u5e8f\u7f13\u51b2\u533a\u53d8\u6ee1\u65f6\uff0c\u6761\u76ee\u88ab\u6392\u5e8f\u5e76\u5199\u51fa\u5230\u4e34\u65f6\u4e2d\u95f4\u6587\u4ef6\u3002\u6b64\u8fc7\u7a0b\u4e5f\u79f0\u4e3a \u201c\u8fd0\u884c\u201d\u3002\u5728\u7b2c\u4e8c\u9636\u6bb5\uff0c\u5c06\u4e00\u6b21\u6216\u591a\u6b21\u8fd0\u884c\u5199\u5165\u4e34\u65f6\u4e2d\u95f4\u6587\u4ef6\uff0c\u5bf9\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u6761\u76ee\u6267\u884c\u5f52\u5e76\u6392\u5e8f\u3002\u5728\u7b2c\u4e09\u4e2a\u4e5f\u662f\u6700\u540e\u4e00\u4e2a\u9636\u6bb5\uff0c\u6392\u5e8f\u540e\u7684\u6761\u76ee\u88ab\u63d2\u5165\u5230 B \u6811\u4e2d\u3002</p> <p>\u5728\u5f15\u5165\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u4e4b\u524d\uff0c\u4f7f\u7528\u63d2\u5165 API \u5c06\u7d22\u5f15\u6761\u76ee\u4e00\u6b21\u4e00\u6761\u5730\u63d2\u5165\u5230 B \u6811\u4e2d\u3002\u6b64\u65b9\u6cd5\u6d89\u53ca\u6253\u5f00 B \u6811 \u6e38\u6807\u4ee5\u67e5\u627e\u63d2\u5165\u4f4d\u7f6e\uff0c\u7136\u540e\u4f7f\u7528\u4e50\u89c2\u63d2\u5165\u5c06\u6761\u76ee\u63d2\u5165 B \u6811\u9875\u9762 \u3002\u5982\u679c\u7531\u4e8e\u9875\u9762\u5df2\u6ee1\u800c\u5bfc\u81f4\u63d2\u5165\u5931\u8d25\uff0c \u5219\u4f1a\u6267\u884c\u60b2\u89c2\u63d2\u5165\uff0c\u8fd9\u6d89\u53ca\u6253\u5f00 B \u6811\u6e38\u6807\u5e76\u6839\u636e\u9700\u8981\u62c6\u5206\u548c\u5408\u5e76 B \u6811\u8282\u70b9\uff0c\u4ee5\u4fbf\u4e3a\u6761\u76ee\u627e\u5230\u7a7a\u95f4\u3002\u8fd9\u79cd\u201c\u81ea\u4e0a\u800c\u4e0b\u201d\u7684\u5f0a\u7aef \u5efa\u7acb\u7d22\u5f15\u7684\u65b9\u6cd5\u662f\u641c\u7d22\u63d2\u5165\u4f4d\u7f6e\u7684\u6210\u672c\u548c\u4e0d\u65ad\u5206\u88c2\u548c\u5408\u5e76 B \u6811\u8282\u70b9\u3002</p> <p>\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u4f7f\u7528\u201c\u81ea\u5e95\u5411\u4e0a\u201d\u5efa\u7acb\u7d22\u5f15\u7684\u65b9\u6cd5\u3002\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\uff0c\u5bf9\u6700\u53f3\u4fa7\u53f6\u9875\u7684\u5f15\u7528\u4fdd\u5b58\u5728 B \u6811\u7684\u6240\u6709\u7ea7\u522b\u3002\u5206\u914d\u5fc5\u8981 B \u6811\u6df1\u5ea6\u7684\u6700\u53f3\u4fa7\u53f6\u9875\uff0c\u5e76\u6839\u636e\u5176\u6392\u5e8f\u987a\u5e8f\u63d2\u5165\u6761\u76ee\u3002\u4e00\u65e6\u53f6\u9875\u5df2\u6ee1\uff0c\u8282\u70b9\u6307\u9488\u5c06\u9644\u52a0\u5230\u7236\u9875\uff0c\u5e76\u4e3a\u4e0b\u4e00\u6b21\u63d2\u5165\u5206\u914d\u540c\u7ea7\u53f6\u9875\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e00\u76f4\u6301\u7eed\u5230\u6240\u6709\u6761\u76ee\u90fd\u88ab\u63d2\u5165\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u63d2\u5165\u5230\u6839\u7ea7\u522b\u3002\u5206\u914d\u540c\u7ea7\u9875\u65f6\uff0c\u91ca\u653e\u5bf9\u5148\u524d\u56fa\u5b9a\u7684\u53f6\u9875\u7684\u5f15\u7528\uff0c\u65b0\u5206\u914d\u7684\u53f6\u9875\u6210\u4e3a\u6700\u53f3\u4fa7\u7684\u53f6\u9875\u548c\u65b0\u7684\u9ed8\u8ba4\u63d2\u5165\u4f4d\u7f6e\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#b","title":"\u4e3a\u672a\u6765\u7684\u6307\u6570\u589e\u957f\u4fdd\u7559 B \u6811\u9875\u9762\u7a7a\u95f4","text":"<p>\u8981\u4e3a\u5c06\u6765\u7684\u7d22\u5f15\u589e\u957f\u7559\u51fa\u7a7a\u95f4\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8be5 <code>innodb_fill_factor</code>\u53d8\u91cf\u6765\u4fdd\u7559 B \u6811\u9875\u9762\u7a7a\u95f4\u7684\u767e\u5206\u6bd4\u3002\u4f8b\u5982\uff0c\u8bbe\u7f6e <code>innodb_fill_factor</code>\u4e3a 80 \u4f1a\u5728\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u671f\u95f4\u4fdd\u7559 B \u6811\u9875\u9762\u4e2d 20% \u7684\u7a7a\u95f4\u3002\u6b64\u8bbe\u7f6e\u9002\u7528\u4e8e B \u6811\u53f6\u9875\u548c\u975e\u53f6\u9875\u3002\u5b83\u4e0d\u9002\u7528\u4e8e\u7528\u4e8e<code>TEXT</code>\u6216 <code>BLOB</code>\u6761\u76ee\u7684\u5916\u90e8\u9875\u9762 \u3002\u4fdd\u7559\u7684\u7a7a\u95f4\u91cf\u53ef\u80fd\u4e0e\u914d\u7f6e\u7684\u4e0d\u5b8c\u5168\u76f8\u540c\uff0c\u56e0\u4e3a\u8be5 <code>innodb_fill_factor</code>\u503c\u88ab\u89e3\u91ca\u4e3a\u63d0\u793a\u800c\u4e0d\u662f\u786c\u9650\u5236\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_5","title":"\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u548c\u5168\u6587\u7d22\u5f15\u652f\u6301","text":"<p>\u5168\u6587\u7d22\u5f15 \u652f\u6301\u6392\u5e8f\u7d22\u5f15\u6784\u5efa \u3002\u4ee5\u524d\uff0cSQL \u7528\u4e8e\u5c06\u6761\u76ee\u63d2\u5165\u5230\u5168\u6587\u7d22\u5f15\u4e2d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_6","title":"\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u548c\u538b\u7f29\u8868","text":"<p>\u5bf9\u4e8e\u538b\u7f29\u8868\uff0c\u4e4b\u524d\u7684\u7d22\u5f15\u521b\u5efa\u65b9\u6cd5\u5c06\u6761\u76ee\u9644\u52a0\u5230\u538b\u7f29\u9875\u548c\u672a\u538b\u7f29\u9875\u3002\u5f53\u4fee\u6539\u65e5\u5fd7\uff08\u4ee3\u8868\u538b\u7f29\u9875\u9762\u4e0a\u7684\u53ef\u7528\u7a7a\u95f4\uff09\u53d8\u6ee1\u65f6\uff0c\u5c06\u91cd\u65b0\u538b\u7f29\u538b\u7f29\u9875\u9762\u3002\u5982\u679c\u7531\u4e8e\u7a7a\u95f4\u4e0d\u8db3\u5bfc\u81f4\u538b\u7f29\u5931\u8d25\uff0c\u9875\u9762\u5c06\u88ab\u62c6\u5206\u3002\u4f7f\u7528\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\uff0c\u6761\u76ee\u4ec5\u9644\u52a0\u5230\u672a\u538b\u7f29\u7684\u9875\u9762\u3002\u5f53\u4e00\u4e2a\u672a\u538b\u7f29\u7684\u9875\u9762\u53d8\u6ee1\u65f6\uff0c\u5b83\u5c31\u4f1a\u88ab\u538b\u7f29\u3002\u81ea\u9002\u5e94\u586b\u5145\u7528\u4e8e\u786e\u4fdd\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u538b\u7f29\u6210\u529f\uff0c\u4f46\u5982\u679c\u538b\u7f29\u5931\u8d25\uff0c\u9875\u9762\u5c06\u88ab\u62c6\u5206\u5e76\u518d\u6b21\u5c1d\u8bd5\u538b\u7f29\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e00\u76f4\u6301\u7eed\u5230\u538b\u7f29\u6210\u529f\u3002\u6709\u5173 B-Tree \u9875\u9762\u538b\u7f29\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.9.1.5 \u8282\uff0c\u201cInnoDB \u8868\u7684\u538b\u7f29\u5982\u4f55\u5de5\u4f5c\u201d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_7","title":"\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u548c\u91cd\u505a\u65e5\u5fd7","text":"<p>\u5728\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u671f\u95f4\u7981\u7528\u91cd\u505a\u65e5\u5fd7\u8bb0\u5f55\u3002\u76f8\u53cd\uff0c\u6709\u4e00\u4e2a \u68c0\u67e5\u70b9\u6765\u786e\u4fdd\u7d22\u5f15\u6784\u5efa\u53ef\u4ee5\u627f\u53d7\u610f\u5916\u9000\u51fa\u6216\u5931\u8d25\u3002\u68c0\u67e5\u70b9\u5f3a\u5236\u5c06\u6240\u6709\u810f\u9875\u5199\u5165\u78c1\u76d8\u3002\u5728\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u671f\u95f4\uff0c\u9875\u9762\u6e05\u7406\u5668\u7ebf\u7a0b\u4f1a\u5b9a\u671f\u6536\u5230\u4fe1\u53f7\u4ee5\u5237\u65b0 \u810f\u9875\u9762\uff0c\u4ee5\u786e\u4fdd\u53ef\u4ee5\u5feb\u901f\u5904\u7406\u68c0\u67e5\u70b9\u64cd\u4f5c\u3002\u901a\u5e38\uff0c\u5f53\u5e72\u51c0\u9875\u9762\u7684\u6570\u91cf\u4f4e\u4e8e\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\uff0c\u9875\u9762\u6e05\u7406\u5668\u7ebf\u7a0b\u4f1a\u5237\u65b0\u810f\u9875\u9762\u3002\u5bf9\u4e8e\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\uff0c\u810f\u9875\u4f1a\u7acb\u5373\u5237\u65b0\u4ee5\u51cf\u5c11\u68c0\u67e5\u70b9\u5f00\u9500\u5e76\u5e76\u884c\u5316 I/O \u548c CPU \u6d3b\u52a8\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_8","title":"\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u548c\u4f18\u5316\u5668\u7edf\u8ba1\u4fe1\u606f","text":"<p>\u6392\u5e8f\u7d22\u5f15\u6784\u5efa\u53ef\u80fd\u4f1a\u5bfc\u81f4 \u4f18\u5316\u5668\u7edf\u8ba1\u4fe1\u606f\u4e0e\u4ee5\u524d\u7684\u7d22\u5f15\u521b\u5efa\u65b9\u6cd5\u751f\u6210\u7684\u7edf\u8ba1\u4fe1\u606f\u4e0d\u540c\u3002\u7edf\u8ba1\u6570\u636e\u7684\u5dee\u5f02\uff08\u9884\u8ba1\u4e0d\u4f1a\u5f71\u54cd\u5de5\u4f5c\u8d1f\u8f7d\u6027\u80fd\uff09\u662f\u7531\u4e8e\u7528\u4e8e\u586b\u5145\u7d22\u5f15\u7684\u7b97\u6cd5\u4e0d\u540c\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14624-innodb","title":"14.6.2.4 InnoDB\u5168\u6587\u7d22\u5f15","text":"<p>\u5168\u6587\u7d22\u5f15\u662f\u5728\u57fa\u4e8e\u6587\u672c\u7684\u5217\uff08<code>CHAR</code>\u3001 <code>VARCHAR</code>\u6216<code>TEXT</code>\u5217\uff09\u4e0a\u521b\u5efa\u7684\uff0c \u4ee5\u52a0\u5feb\u5bf9\u8fd9\u4e9b\u5217\u4e2d\u5305\u542b\u7684\u6570\u636e\u7684\u67e5\u8be2\u548c DML \u64cd\u4f5c\u3002</p> <p>\u5168\u6587\u7d22\u5f15\u88ab\u5b9a\u4e49\u4e3a<code>CREATE TABLE</code>\u8bed\u53e5\u7684\u4e00\u90e8\u5206 \u6216\u4f7f\u7528<code>ALTER TABLE</code> \u6216\u6dfb\u52a0\u5230\u73b0\u6709\u8868\u4e2d<code>CREATE INDEX</code>\u3002</p> <p>\u5168\u6587\u641c\u7d22\u4f7f\u7528<code>MATCH() ... AGAINST</code>\u8bed\u6cd5\u8fdb\u884c\u3002\u6709\u5173\u4f7f\u7528\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 12.10 \u8282\uff0c\u201c\u5168\u6587\u641c\u7d22\u529f\u80fd\u201d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#innodb_1","title":"InnoDB\u5168\u6587\u7d22\u5f15\u8bbe\u8ba1","text":"<p>InnoDB\u5168\u6587\u7d22\u5f15\u91c7\u7528\u5012\u6392\u7d22\u5f15\u8bbe\u8ba1\u3002\u5012\u6392\u7d22\u5f15\u5b58\u50a8\u4e00\u4e2a\u5355\u8bcd\u5217\u8868\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5355\u8bcd\uff0c\u8fd8\u6709\u4e00\u4e2a\u8be5\u5355\u8bcd\u51fa\u73b0\u7684\u6587\u6863\u5217\u8868\u3002\u4e3a\u4e86\u652f\u6301\u90bb\u8fd1\u641c\u7d22\uff0c\u6bcf\u4e2a\u5355\u8bcd\u7684\u4f4d\u7f6e\u4fe1\u606f\u4e5f\u88ab\u5b58\u50a8\u4e3a\u5b57\u8282\u504f\u79fb\u91cf\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1463","title":"14.6.3 \u8868\u7a7a\u95f4","text":""},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1465-doublewrite-buffer","title":"14.6.5 Doublewrite Buffer\u53cc\u5199\u7f13\u51b2\u533a","text":"<p>\u53cc\u5199\u7f13\u51b2\u533a\u662f\u4e00\u4e2a\u5b58\u50a8\u533a\u57df\uff0cInnoDB\u5728\u5c06\u9875\u9762\u5199\u5230InnoDB\u6570\u636e\u6587\u4ef6\u7684\u9002\u5f53\u4f4d\u7f6e\u4e4b\u524d\uff0c\u5c06buffer pool\u7684\u9875\u9762\u5148\u5199\u5165\u53cc\u5199\u7f13\u51b2\u6c60\u4e2d\u3002\u5982\u679c\u64cd\u4f5c\u7cfb\u7edf\u3001\u5b58\u50a8\u5b50\u7cfb\u7edf\u6216\u610f\u5916\u7684mysqld\u8fdb\u7a0b\u5728\u9875\u9762\u5199\u5165\u8fc7\u7a0b\u4e2d\u9000\u51fa\uff0cInnoDB\u53ef\u4ee5\u5728\u5d29\u6e83\u6062\u590d\u671f\u95f4\u4ece\u53cc\u5199\u7f13\u51b2\u533a\u4e2d\u627e\u5230\u4e00\u4e2a\u826f\u597d\u7684\u9875\u9762\u526f\u672c\u3002</p> <p>\u867d\u7136\u6570\u636e\u88ab\u5199\u4e86\u4e24\u6b21\uff0c\u4f46\u53cc\u5199\u7f13\u51b2\u533a\u5e76\u4e0d\u8981\u6c42\u4e24\u500d\u7684I/O\u5f00\u9500\u6216\u4e24\u500d\u7684I/O\u64cd\u4f5c\u3002\u6570\u636e\u662f\u4ee5\u4e00\u4e2a\u5927\u7684\u987a\u5e8f\u5757\u5199\u5165\u53cc\u5199\u7f13\u51b2\u533a\u7684\uff0c\u53ea\u9700\u5411\u64cd\u4f5c\u7cfb\u7edf\u8c03\u7528\u4e00\u6b21fsync()\uff08\u9664\u4e86innodb_flush_method\u88ab\u8bbe\u7f6e\u4e3aO_DIRECT_NO_FSYNC\u7684\u60c5\u51b5\uff09\u3002</p> <p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u53cc\u5199\u7f13\u51b2\u533a\u662f\u9ed8\u8ba4\u542f\u7528\u7684\u3002\u8981\u7981\u7528\u91cd\u5199\u7f13\u51b2\u533a\uff0c\u5c06innodb_doublewrite\u8bbe\u7f6e\u4e3a0\u3002</p> <p>\u5982\u679c\u7cfb\u7edf\u8868\u7a7a\u95f4\u6587\u4ef6\uff08\"ibdata\u6587\u4ef6\"\uff09\u4f4d\u4e8e\u652f\u6301\u539f\u5b50\u5199\u5165\u7684Fusion-io\u8bbe\u5907\u4e0a\uff0c\u5219\u81ea\u52a8\u7981\u7528\u53cc\u5199\u7f13\u51b2\uff0cFusion-io\u7684\u539f\u5b50\u5199\u5165\u7528\u4e8e\u6240\u6709\u6570\u636e\u6587\u4ef6\u3002\u56e0\u4e3a\u53cc\u5199\u7f13\u51b2\u8bbe\u7f6e\u662f\u5168\u5c40\u7684\uff0c\u6240\u4ee5\u5bf9\u4e8e\u9a7b\u7559\u5728\u975eFusion-io\u786c\u4ef6\u4e0a\u7684\u6570\u636e\u6587\u4ef6\uff0c\u53cc\u5199\u7f13\u51b2\u4e5f\u88ab\u7981\u7528\u3002\u8fd9\u4e2a\u529f\u80fd\u53ea\u5728Fusion-io\u786c\u4ef6\u4e0a\u652f\u6301\uff0c\u5e76\u4e14\u53ea\u5728Linux\u4e0a\u7684Fusion-io NVMFS\u4e2d\u542f\u7528\u3002\u4e3a\u4e86\u5145\u5206\u5229\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u5efa\u8bae\u5c06innodb_flush_method\u8bbe\u7f6e\u4e3aO_DIRECT\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1466-redo","title":"14.6.6 Redo\u65e5\u5fd7","text":"<p>redo\u65e5\u5fd7\u662f\u4e00\u79cd\u57fa\u4e8e\u78c1\u76d8\u7684\u6570\u636e\u7ed3\u6784\uff0c\u7528\u4e8e\u5728\u5d29\u6e83\u6062\u590d\u671f\u95f4\u4fee\u590d\u4e0d\u5b8c\u6574\u4e8b\u52a1\u5199\u5165\u7684\u6570\u636e\u3002\u5728\u6b63\u5e38\u64cd\u4f5c\u671f\u95f4\uff0credo\u65e5\u5fd7\u5bf9\u7531 SQL \u8bed\u53e5\u6216\u4f4e\u7ea7 API \u8c03\u7528\u4ea7\u751f\u7684\u66f4\u6539\u8868\u6570\u636e\u7684\u8bf7\u6c42\u8fdb\u884c\u7f16\u7801\u3002\u5728\u521d\u59cb\u5316\u671f\u95f4\u548c\u63a5\u53d7\u8fde\u63a5\u4e4b\u524d\uff0c\u4f1a\u81ea\u52a8\u91cd\u64ad\u5728\u610f\u5916\u5173\u95ed\u4e4b\u524d\u672a\u5b8c\u6210\u66f4\u65b0\u6570\u636e\u6587\u4ef6\u7684\u4fee\u6539\u3002\u6709\u5173redo\u65e5\u5fd7\u5728\u5d29\u6e83\u6062\u590d\u4e2d\u7684\u4f5c\u7528\u7684\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.19.2 \u8282\uff0c\u201cInnoDB \u6062\u590d\u201d\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0credo\u65e5\u5fd7\u5728\u78c1\u76d8\u4e0a\u5bf9\u5e94\u7740\u4e24\u4e2a\u540d\u4e3a<code>ib_logfile0</code>\u548c<code>ib_logfile1</code>\u7684\u7269\u7406\u6587\u4ef6\u3002MySQL\u4ee5\u5faa\u73af\u65b9\u5f0f\u5199\u5165redo\u65e5\u5fd7\u6587\u4ef6\u3002redo\u65e5\u5fd7\u4e2d\u7684\u6570\u636e\u6839\u636e\u53d7\u5f71\u54cd\u7684\u8bb0\u5f55\u8fdb\u884c\u7f16\u7801\uff1b\u8fd9\u4e9b\u6570\u636e\u7edf\u79f0\u4e3aredo\u3002\u901a\u8fc7redo\u65e5\u5fd7\u7684\u6570\u636e\u901a\u9053\u7531\u4e0d\u65ad\u589e\u52a0\u7684LSN\u503c\u8868\u793a\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#redo","title":"redo\u65e5\u5fd7\u5237\u65b0\u7684\u7ec4\u63d0\u4ea4","text":"<p>InnoDB\u50cf\u4efb\u4f55\u5176\u4ed6 \u7b26\u5408 ACID\u7684\u6570\u636e\u5e93\u5f15\u64ce\u4e00\u6837\uff0c\u5728\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\u5237\u65b0\u4e8b\u52a1\u7684redo\u65e5\u5fd7\u3002InnoDB \u4f7f\u7528group commit \u529f\u80fd\u5c06\u591a\u4e2a\u5237\u65b0\u8bf7\u6c42\u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u4ee5\u907f\u514d\u6bcf\u6b21\u63d0\u4ea4\u90fd\u8981\u5237\u65b0\u3002\u4f7f\u7528\u7ec4\u63d0\u4ea4\uff0cInnoDB\u5411\u65e5\u5fd7\u6587\u4ef6\u53d1\u51fa\u4e00\u6b21\u5199\u5165\uff0c\u5bf9\u5e94\u5927\u7ea6\u540c\u65f6\u63d0\u4ea4\u7684\u591a\u4e2a\u7528\u6237\u7684\u4e8b\u52a1\u6267\u884c\u63d0\u4ea4\u64cd\u4f5c\uff0c\u4ece\u800c\u663e\u8457\u63d0\u9ad8\u541e\u5410\u91cf\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1467-undo","title":"14.6.7 undo\u65e5\u5fd7","text":"<p>undo\u65e5\u5fd7\u662f\u4e0e\u5355\u4e2a\u8bfb\u5199\u4e8b\u52a1\u76f8\u5173\u8054\u7684\u64a4\u6d88\u65e5\u5fd7\u8bb0\u5f55\u7684\u96c6\u5408\u3002undo\u65e5\u5fd7\u8bb0\u5f55\u5305\u542b\u6709\u5173\u5982\u4f55\u64a4\u6d88\u4e8b\u52a1\u5bf9\u805a\u96c6\u7d22\u5f15 \u8bb0\u5f55\u7684\u6700\u65b0\u66f4\u6539\u7684\u4fe1\u606f\u3002\u5982\u679c\u53e6\u4e00\u4e2a\u4e8b\u52a1\u9700\u8981\u67e5\u770b\u539f\u59cb\u6570\u636e\u7528\u4e8e\u4e00\u81f4\u6027\u8bfb\u53d6\u64cd\u4f5c\u7684\u4e00\u90e8\u5206\uff0c\u5219\u5c06\u4eceundo Logs\u8bb0\u5f55\u4e2d\u68c0\u7d22\u672a\u4fee\u6539\u7684\u6570\u636e\u3002undo Log\u5b58\u5728\u4e8e \u64a4\u6d88\u65e5\u5fd7\u6bb5\u4e2d\uff0c\u800c\u64a4\u6d88\u65e5\u5fd7\u6bb5\u5305\u542b\u5728  rollback segments.\u3002\u56de\u6eda\u6bb5\u9a7b\u7559\u5728 \u7cfb\u7edf\u8868\u7a7a\u95f4\u3001undo\u8868\u7a7a\u95f4\u548c\u4e34\u65f6\u8868\u7a7a\u95f4\u4e2d\u3002</p> <p>\u9a7b\u7559\u5728\u4e34\u65f6\u8868\u7a7a\u95f4\u4e2d\u7684\u64a4\u6d88\u65e5\u5fd7\u7528\u4e8e\u4fee\u6539\u7528\u6237\u5b9a\u4e49\u4e34\u65f6\u8868\u4e2d\u6570\u636e\u7684\u4e8b\u52a1\u3002\u8fd9\u4e9b\u64a4\u6d88\u65e5\u5fd7\u4e0d\u4f1a\u88abredo\u65e5\u5fd7\u8bb0\u5f55\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u662f\u5d29\u6e83\u6062\u590d\u9700\u8981\u7684\u3002\u5b83\u4eec\u4ec5\u7528\u4e8e\u5728\u670d\u52a1\u5668\u8fd0\u884c\u65f6\u7684\u56de\u6eda\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u64a4\u6d88\u65e5\u5fd7\u901a\u8fc7\u907f\u514d\u91cd\u505a\u65e5\u5fd7\u8bb0\u5f55 I/O \u6765\u63d0\u9ad8\u6027\u80fd\u3002</p> <p>InnoDB\u6700\u591a\u652f\u6301 128 \u4e2a\u56de\u6eda\u6bb5\uff0c\u5176\u4e2d 32 \u4e2a\u5206\u914d\u7ed9\u4e34\u65f6\u8868\u7a7a\u95f4\u3002\u8fd9\u7559\u4e0b\u4e86 96 \u4e2a\u56de\u6eda\u6bb5\uff0c\u53ef\u4ee5\u5206\u914d\u7ed9\u4fee\u6539\u5e38\u89c4\u8868\u4e2d\u6570\u636e\u7684\u4e8b\u52a1\u3002\u8be5 <code>innodb_rollback_segments</code>\u53d8\u91cf\u5b9a\u4e49\u4e86 \u4f7f\u7528\u7684\u56de\u6eda\u6bb5\u6570\u76eeInnoDB\u3002</p> <p>\u56de\u6eda\u6bb5\u652f\u6301\u7684\u4e8b\u52a1\u6570\u91cf\u53d6\u51b3\u4e8e\u56de\u6eda\u6bb5\u4e2d\u7684undo slot\u6570\u91cf\u548c\u6bcf\u4e2a\u4e8b\u52a1\u6240\u9700\u7684undo log\u6570\u91cf\u3002\u56de\u6eda\u6bb5\u4e2d\u7684\u64a4\u6d88\u69fd\u6570\u56e0InnoDB\u9875\u9762\u5927\u5c0f\u800c\u5f02\u3002</p> InnoDB Page Size Number of Undo Slots in a Rollback Segment (InnoDB Page Size / 16) <code>4096 (4KB)</code> <code>256</code> <code>8192 (8KB)</code> <code>512</code> <code>16384 (16KB)</code> <code>1024</code> <code>32768 (32KB)</code> <code>2048</code> <code>65536 (64KB)</code> <code>4096</code> <p>\u4e00\u4e2a\u4e8b\u52a1\u6700\u591a\u5206\u914d\u56db\u4e2a\u64a4\u6d88\u65e5\u5fd7\uff0c\u4e00\u4e2a\u7528\u4e8e\u4ee5\u4e0b\u6bcf\u79cd\u64cd\u4f5c\u7c7b\u578b\uff1a</p> <ol> <li><code>INSERT</code> \u5bf9\u7528\u6237\u5b9a\u4e49\u8868\u7684\u64cd\u4f5c</li> <li>UPDATE\u4ee5\u53ca <code>DELETE</code>\u5bf9\u7528\u6237\u5b9a\u4e49\u8868\u7684\u64cd\u4f5c</li> <li><code>INSERT</code> \u5bf9\u7528\u6237\u5b9a\u4e49\u7684\u4e34\u65f6\u8868\u7684\u64cd\u4f5c</li> <li>UPDATE\u4ee5\u53ca <code>DELETE</code>\u5bf9\u7528\u6237\u5b9a\u4e49\u7684\u4e34\u65f6\u8868\u7684\u64cd\u4f5c</li> </ol> <p>\u6839\u636e\u9700\u8981\u5206\u914d\u64a4\u6d88\u65e5\u5fd7\u3002\u4f8b\u5982\uff0c\u5bf9\u5e38\u89c4\u8868\u548c\u4e34\u65f6\u8868\u6267\u884c<code>INSERT</code>\u3001 UPDATE\u548c <code>DELETE</code>\u64cd\u4f5c\u7684\u4e8b\u52a1\u9700\u8981\u5b8c\u6574\u5206\u914d\u56db\u4e2a\u64a4\u6d88\u65e5\u5fd7\u3002\u4ec5\u5bf9<code>INSERT</code>\u5e38\u89c4\u8868\u6267\u884c\u64cd\u4f5c\u7684\u4e8b\u52a1 \u9700\u8981\u5355\u4e2a\u64a4\u6d88\u65e5\u5fd7\u3002</p> <p>\u5bf9\u5e38\u89c4\u8868\u6267\u884c\u64cd\u4f5c\u7684\u4e8b\u52a1\u4ece\u5206\u914d\u7684\u7cfb\u7edf\u8868\u7a7a\u95f4\u6216\u64a4\u6d88\u8868\u7a7a\u95f4\u56de\u6eda\u6bb5\u5206\u914d\u64a4\u6d88\u65e5\u5fd7\u3002\u5bf9\u4e34\u65f6\u8868\u6267\u884c\u64cd\u4f5c\u7684\u4e8b\u52a1\u4ece\u5206\u914d\u7684\u4e34\u65f6\u8868\u7a7a\u95f4\u56de\u6eda\u6bb5\u5206\u914d\u64a4\u6d88\u65e5\u5fd7\u3002</p> <p>\u5206\u914d\u7ed9\u4e8b\u52a1\u7684\u64a4\u6d88\u65e5\u5fd7\u5728\u5176\u6301\u7eed\u65f6\u95f4\u5185\u4fdd\u6301\u9644\u52a0\u5230\u4e8b\u52a1\u3002\u4f8b\u5982\uff0c\u4e3a<code>INSERT</code> \u5e38\u89c4\u8868\u4e0a\u7684\u64cd\u4f5c\u5206\u914d\u7ed9\u4e8b\u52a1\u7684\u64a4\u6d88\u65e5\u5fd7\u7528\u4e8e\u8be5\u4e8b\u52a1<code>INSERT</code>\u5728\u5e38\u89c4\u8868\u4e0a\u6267\u884c\u7684\u6240\u6709 \u64cd\u4f5c\u3002</p> <p>\u8003\u8651\u5230\u4e0a\u8ff0\u56e0\u7d20\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u516c\u5f0f\u6765\u4f30\u8ba1InnoDB\u80fd\u591f\u652f\u6301\u7684\u5e76\u53d1\u8bfb\u5199\u4e8b\u52a1\u7684\u6570\u91cf\uff1a</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#147-innodb-lock","title":"14.7 InnoDB lock\u548c\u4e8b\u52a1\u6a21\u578b","text":"<p>\u8981\u5b9e\u73b0\u5927\u89c4\u6a21\u3001\u7e41\u5fd9\u6216\u9ad8\u5ea6\u53ef\u9760\u7684\u6570\u636e\u5e93\u5e94\u7528\u7a0b\u5e8f\uff0c\u4ece\u4e0d\u540c\u7684\u6570\u636e\u5e93\u7cfb\u7edf\u79fb\u690d\u5927\u91cf\u4ee3\u7801\uff0c\u6216\u8c03\u6574 MySQL \u6027\u80fd\uff0c\u4e86\u89e3InnoDB\u9501\u548cInnoDB \u4e8b\u52a1\u6a21\u578b\u975e\u5e38\u91cd\u8981 \u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1471-innodb","title":"14.7.1 InnoDB\u7684\u9501","text":"<p>\u672c\u8282\u63cf\u8ff0\u4e86InnoDB\u4f7f\u7528\u7684\u9501\u7c7b\u578b</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#shared-and-exclusive-locks","title":"\u5171\u4eab\u9501\u548c\u6392\u4ed6\u9501Shared and Exclusive Locks","text":"<p>InnoDB\u5b9e\u73b0\u6807\u51c6\u7684\u884c\u7ea7\u9501\uff0c\u5176\u4e2d\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u9501\uff0c \u5171\u4eab ( <code>S</code>) \u9501\u548c\u6392\u5b83 ( <code>X</code>) \u9501\u3002</p> <ul> <li>\u5171\u4eab\uff08<code>S</code>\uff09\u9501\u5141\u8bb8\u4e8b\u52a1\u5bf9\u8bfb\u53d6\u7684\u884c\u6301\u6709\u9501\u3002</li> <li>\u72ec\u5360\uff08<code>X</code>\uff09\u9501\u5141\u8bb8\u4e8b\u52a1\u5728\u66f4\u65b0\u6216\u5220\u9664\u884c\u65f6\u6301\u6709\u9501\u3002</li> </ul> <p>\u5982\u679c\u4e8b\u52a1T1\u5728\u6301\u6709\u5bf9\u884c<code>r</code>\u7684\u5171\u4eab ( <code>S</code>) \u9501\uff0c\u90a3\u4e48\u6765\u81ea\u67d0\u4e2a\u4e0d\u540c\u4e8b\u52a1<code>T2</code> \u7684\u5bf9\u884c<code>r</code>\u7684\u9501\u8bf7\u6c42\u5c06\u6309\u5982\u4e0b\u65b9\u5f0f\u5904\u7406\uff1a</p> <ul> <li>T2\u4e8b\u52a1\u8bf7\u6c42 <code>S</code>\u9501\u7acb\u5373\u88ab\u6388\u4e88\u3002\u4e5f\u5c31\u662f<code>T1</code>\u4e0e<code>T2</code> \u6301\u6709\u884cr\u7684s\u9501\u3002</li> <li>T2\u4e8b\u52a1\u8bf7\u6c42\u4e00\u4e2a <code>X</code>\u9501\u4e0d\u80fd\u7acb\u5373\u6388\u4e88\u3002</li> </ul> <p>\u5982\u679c\u4e8b\u52a1<code>T1</code>\u6301\u6709\u884cr\u7684\u6392\u4ed6(X)\u9501\uff0c\u5219\u4e8b\u52a1T2\u5bf9\u8be5\u884cr\u7684\u4efb\u4e00\u7c7b\u578b\u9501\u7684\u8bf7\u6c42\u90fd\u4e0d\u4f1a\u88ab\u6388\u4e88\u3002\u76f8\u53cd\uff0c\u4e8b\u52a1<code>T2</code>\u5fc5\u987b\u7b49\u5f85\u4e8b\u52a1<code>T1</code>\u91ca\u653e\u5176\u5bf9\u884cr\u7684\u9501\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#intention-locks","title":"\u610f\u5411\u9501Intention Locks","text":"<p>InnoDB\u652f\u6301\u591a\u7c92\u5ea6\u9501\uff0c\u5141\u8bb8\u884c\u9501\u548c\u8868\u9501\u5171\u5b58\u3002\u4f8b\u5982\uff0c\u8bf8\u5982LOCK TABLES ... WRITE\u8fd9\u6837\u7684\u8bed\u53e5\u5728\u6307\u5b9a\u7684\u8868\u4e0a\u53d6\u5f97\u4e86\u4e00\u4e2a\u72ec\u5360\u9501\uff08X\u9501\uff09\u3002\u4e3a\u4e86\u4f7f\u591a\u4e2a\u7c92\u5ea6\u7ea7\u522b\u7684\u9501\u5207\u5b9e\u53ef\u884c\uff0cInnoDB\u4f7f\u7528\u610f\u56fe\u9501\u3002\u610f\u56fe\u9501\u662f\u8868\u7ea7\u522b\u7684\u9501\uff0c\u5b83\u8868\u660e\u4e8b\u52a1\u4ee5\u540e\u9700\u8981\u5bf9\u8868\u4e2d\u7684\u67d0\u4e00\u884c\u8fdb\u884c\u54ea\u79cd\u7c7b\u578b\u7684\u9501\uff08\u5171\u4eab\u6216\u72ec\u5360\uff09\u3002\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u610f\u5411\u9501\u3002</p> <ul> <li> <p>\u610f\u5411\u5171\u4eab\u9501\uff08IS\uff09\u8868\u793a\u4e8b\u52a1\u6253\u7b97\u5bf9\u8868\u4e2d\u7684\u4e2a\u522b\u884c\u8bbe\u7f6e\u5171\u4eab\u9501\u3002</p> </li> <li> <p>\u610f\u5411\u6392\u4ed6\u9501\uff08IX\uff09\u8868\u793a\u4e00\u4e2a\u4e8b\u52a1\u6253\u7b97\u5bf9\u8868\u4e2d\u7684\u4e2a\u522b\u884c\u8bbe\u7f6e\u6392\u4ed6\u9501\u3002</p> </li> </ul> <p>\u4f8b\u5982\uff0c<code>SELECT ... LOCK IN SHARE MODE</code>\u8bbe\u7f6e\u4e00\u4e2aIS\u9501\uff0c<code>SELECT ... FOR UPDATE</code>\u8bbe\u7f6e\u4e00\u4e2aIX\u9501\u3002</p> <p>\u610f\u5411\u9501\u534f\u8bae\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u5728\u4e00\u4e2a\u4e8b\u52a1\u53ef\u4ee5\u83b7\u5f97\u8868\u5185\u67d0\u884c\u7684\u5171\u4eab\u9501\u4e4b\u524d\uff0c\u5b83\u5fc5\u987b\u9996\u5148\u83b7\u5f97\u8be5\u8868\u7684IS\u9501\u6216\u66f4\u5f3a\u7684\u9501\u3002</p> </li> <li> <p>\u5728\u4e8b\u52a1\u5bf9\u8868\u4e2d\u7684\u67d0\u4e00\u884c\u53d6\u5f97\u72ec\u5360\u9501\u4e4b\u524d\uff0c\u5b83\u5fc5\u987b\u9996\u5148\u53d6\u5f97\u8be5\u8868\u7684IX\u9501\u3002</p> </li> </ul> <p>\u90a3\u53ef\u4ee5\u7406\u89e3\u4e3a\uff0c\u60f3\u8981\u83b7\u53d6\u5171\u4eab\u9501\uff0c\u5f97\u5148\u83b7\u53d6\u4e00\u4e2a\u610f\u5411\u5171\u4eab\u9501\u6216\u6392\u5b83\u9501\uff1b\u83b7\u53d6\u6392\u4ed6\u9501\uff0c\u5c31\u5148\u83b7\u53d6\u610f\u5411\u6392\u5b83\u9501\u3002\u4e5f\u5c31\u662f\u8981\u5148\u8868\u8fbe\u51fa\u610f\u5411\uff1f</p> <p>\u8868\u7ea7\u9501\u7c7b\u578b\u7684\u517c\u5bb9\u6027\u603b\u7ed3\u5728\u4e0b\u9762\u7684\u77e9\u9635\u4e2d\uff1a</p> <code>X</code> <code>IX</code> <code>S</code> <code>IS</code> <code>X</code> Conflict Conflict Conflict Conflict <code>IX</code> Conflict Compatible Conflict Compatible <code>S</code> Conflict Conflict Compatible Compatible <code>IS</code> Conflict Compatible Compatible Compatible <p>\u5982\u679c\u4e00\u4e2a\u9501\u4e0e\u73b0\u6709\u7684\u9501\u517c\u5bb9\uff0c\u5219\u6388\u4e88\u8bf7\u6c42\u4e8b\u52a1\uff1b\u4f46\u5982\u679c\u4e0e\u73b0\u6709\u7684\u9501\u51b2\u7a81\uff0c\u5219\u4e0d\u6388\u4e88\uff0c\u4e8b\u52a1\u4f1a\u7b49\u5f85\uff0c\u76f4\u5230\u51b2\u7a81\u7684\u73b0\u6709\u9501\u88ab\u91ca\u653e\u3002\u5982\u679c\u4e00\u4e2a\u9501\u8bf7\u6c42\u4e0e\u73b0\u6709\u7684\u9501\u51b2\u7a81\uff0c\u5e76\u4e14\u4e0d\u80fd\u88ab\u6388\u4e88\uff0c\u56e0\u4e3a\u5b83\u4f1a\u5bfc\u81f4\u6b7b\u9501\uff0c\u90a3\u4e48\u5c31\u4f1a\u53d1\u751f\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>\u9664\u4e86\u5168\u8868\u8bf7\u6c42\uff08\u4f8b\u5982\uff0cLOCK TABLES ... WRITE\uff09\uff0c\u610f\u56fe\u9501\u4e0d\u4f1a\u963b\u6b62\u4efb\u4f55\u4e1c\u897f\u3002\u610f\u56fe\u9501\u7684\u4e3b\u8981\u76ee\u7684\u662f\u663e\u793a\u6709\u4eba\u6b63\u5728\u9501\u5b9a\u67d0\u4e00\u884c\uff0c\u6216\u5c06\u8981\u9501\u5b9a\u8868\u4e2d\u7684\u67d0\u4e00\u884c\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_9","title":"\u8bb0\u5f55\u9501","text":"<p>\u8bb0\u5f55\u9501\u662f\u5bf9\u7d22\u5f15\u8bb0\u5f55\u7684\u9501\u3002\u4f8b\u5982\uff0c <code>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;</code> \u53ef\u4ee5\u9632\u6b62\u4ece\u63d2\u5165\uff0c\u66f4\u65b0\u6216\u5220\u9664\u884c\uff0c\u5176\u4e2d\u7684\u503c\u7684\u4efb\u4f55\u5176\u5b83\u4ea4\u6613<code>t.c1</code>\u662f <code>10</code>\u3002</p> <p>\u8bb0\u5f55\u9501\u603b\u662f\u9501\u5b9a\u7d22\u5f15\u8bb0\u5f55\uff0c\u5373\u4f7f\u4e00\u4e2a\u8868\u6ca1\u6709\u5b9a\u4e49\u7d22\u5f15\u3002\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\uff0cInnoDB\u521b\u5efa\u4e00\u4e2a\u9690\u85cf\u7684\u805a\u96c6\u7d22\u5f15\u5e76\u4f7f\u7528\u8be5\u7d22\u5f15\u8fdb\u884c\u8bb0\u5f55\u9501\u5b9a\u3002\u8bf7\u53c2\u9605 \u7b2c 14.6.2.1 \u8282\uff0c\u201c\u805a\u96c6\u7d22\u5f15\u548c\u4e8c\u7ea7\u7d22\u5f15\u201d\u3002</p> <p>\u7528\u4e8e\u5728\u8bb0\u5f55\u9501\u5b9a\u4e8b\u52a1\u6570\u636e\u51fa\u73b0\u7c7b\u4f3c\u4e8e\u5728\u4ee5\u4e0b<code>SHOW ENGINE INNODB STATUS</code>\u548c InnoDB\u7684\u76d1\u89c6\u5668 \u8f93\u51fa\uff1a</p> <pre><code>RECORD LOCKS space id 58 page no 3 n bits 72 index `PRIMARY` of table `test`.`t`\ntrx id 10078 lock_mode X locks rec but not gap\nRecord lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0\n 0: len 4; hex 8000000a; asc     ;;\n 1: len 6; hex 00000000274f; asc     'O;;\n 2: len 7; hex b60000019d0110; asc        ;;\n</code></pre>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_10","title":"\u95f4\u9699\u9501","text":"<p>\u95f4\u9699\u9501\u662f\u5bf9\u7d22\u5f15\u8bb0\u5f55\u4e4b\u95f4\u7684\u95f4\u9699\u7684\u9501\uff0c\u6216\u8005\u662f\u5bf9\u7b2c\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u4e4b\u524d\u6216\u6700\u540e\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u4e4b\u540e\u7684\u95f4\u9699\u7684\u9501\u3002\u4f8b\u5982\uff0c<code>SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code>\u963b\u6b62\u5176\u4ed6\u4e8b\u52a1\u5c06\u503c<code>15</code>\u63d2\u5165\u5230\u5217<code>t.c1</code>\uff0c\u65e0\u8bba\u5217\u4e2d\u662f\u5426\u5df2\u7ecf\u5b58\u5728\u4efb\u4f55\u6b64\u7c7b\u503c\uff0c\u56e0\u4e3a\u8be5\u8303\u56f4\u5185\u6240\u6709\u73b0\u6709\u503c\u4e4b\u95f4\u7684\u95f4\u9699\u88ab\u9501\u5b9a\u3002</p> <p>\u95f4\u9699\u53ef\u80fd\u8de8\u8d8a\u5355\u4e2a\u7d22\u5f15\u503c\u3001\u591a\u4e2a\u7d22\u5f15\u503c\uff0c\u751a\u81f3\u662f\u7a7a\u7684\u3002</p> <p>\u95f4\u9699\u9501\u662f\u6027\u80fd\u548c\u5e76\u53d1\u6027\u4e4b\u95f4\u6743\u8861\u7684\u4e00\u90e8\u5206\uff0c\u7528\u4e8e\u67d0\u4e9b\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u800c\u4e0d\u662f\u5176\u4ed6\u7ea7\u522b\u3002</p> <p>\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\u9501\u5b9a\u884c\u641c\u7d22\u552f\u4e00\u884c\u7684\u8bed\u53e5\u4e0d\u9700\u8981\u95f4\u9699\u9501\u3002\uff08\u8fd9\u4e0d\u5305\u62ec\u641c\u7d22\u6761\u4ef6\u4ec5\u5305\u542b\u591a\u5217\u552f\u4e00\u7d22\u5f15\u7684\u67d0\u4e9b\u5217\u7684\u60c5\u51b5\uff1b\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u786e\u5b9e\u4f1a\u53d1\u751f\u95f4\u9699\u9501\u5b9a\u3002\uff09\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8be5<code>id</code>\u5217\u5177\u6709\u552f\u4e00\u7d22\u5f15\uff0c\u5219\u4ee5\u4e0b\u8bed\u53e5\u4ec5\u4f7f\u7528<code>id</code>\u503c\u4e3a 100\u7684\u884c\u7684\u7d22\u5f15\u8bb0\u5f55\u9501\u5b9a\uff0c\u5176\u4ed6\u4f1a\u8bdd\u662f\u5426\u5728\u524d\u9762\u7684\u95f4\u9699\u4e2d\u63d2\u5165\u884c\u65e0\u5173\u7d27\u8981\uff1a</p> <pre><code>SELECT * FROM child WHERE id = 100;\n</code></pre> <p>\u5982\u679c<code>id</code>\u672a\u7f16\u5165\u7d22\u5f15\u6216\u5177\u6709\u975e\u552f\u4e00\u7d22\u5f15\uff0c\u5219\u8be5\u8bed\u53e5\u4f1a\u9501\u5b9a\u524d\u9762\u7684\u95f4\u9699\u3002</p> <p>\u8fd9\u91cc\u8fd8\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u4e0d\u540c\u7684\u4e8b\u52a1\u53ef\u4ee5\u5728\u95f4\u9699\u4e0a\u6301\u6709\u51b2\u7a81\u7684\u9501\u3002\u4f8b\u5982\uff0c\u4e8b\u52a1 A \u53ef\u4ee5\u5728\u95f4\u9699\u4e0a\u6301\u6709\u5171\u4eab\u95f4\u9699\u9501\uff08\u95f4\u9699 S \u9501\uff09\uff0c\u800c\u4e8b\u52a1 B \u5728\u540c\u4e00\u95f4\u9699\u4e0a\u6301\u6709\u6392\u4ed6\u95f4\u9699\u9501\uff08\u95f4\u9699 X \u9501\uff09\u3002\u5141\u8bb8\u51b2\u7a81\u95f4\u9699\u9501\u7684\u539f\u56e0\u662f\uff0c\u5982\u679c\u4ece\u7d22\u5f15\u4e2d\u6e05\u9664\u8bb0\u5f55\uff0c\u5219\u5fc5\u987b\u5408\u5e76\u4e0d\u540c\u4e8b\u52a1\u5728\u8bb0\u5f55\u4e0a\u6301\u6709\u7684\u95f4\u9699\u9501\u3002</p> <p>\u95f4\u9699\u9501\u5b9aInnoDB\u662f\u201c\u7eaf\u7cb9\u7684\u6291\u5236\u6027\u201d\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u7684\u552f\u4e00\u76ee\u7684\u662f\u9632\u6b62\u5176\u4ed6\u4e8b\u52a1\u63d2\u5165\u95f4\u9699\u3002\u95f4\u9699\u9501\u53ef\u4ee5\u5171\u5b58\u3002\u4e00\u4e2a\u4e8b\u52a1\u91c7\u7528\u7684\u95f4\u9699\u9501\u4e0d\u4f1a\u963b\u6b62\u53e6\u4e00\u4e2a\u4e8b\u52a1\u5728\u540c\u4e00\u95f4\u9699\u4e0a\u91c7\u7528\u95f4\u9699\u9501\u3002\u5171\u4eab\u548c\u6392\u4ed6\u95f4\u9699\u9501\u4e4b\u95f4\u6ca1\u6709\u533a\u522b\u3002\u5b83\u4eec\u5f7c\u6b64\u4e0d\u51b2\u7a81\uff0c\u5e76\u4e14\u6267\u884c\u76f8\u540c\u7684\u529f\u80fd\u3002</p> <p>\u53ef\u4ee5\u660e\u786e\u7981\u7528\u95f4\u9699\u9501\u5b9a\u3002\u5982\u679c\u60a8\u5c06\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u66f4\u6539\u4e3a<code>READ COMMITTED</code>\u6216\u542f\u7528 <code>innodb_locks_unsafe_for_binlog</code> \u7cfb\u7edf\u53d8\u91cf\uff08\u73b0\u5df2\u5f03\u7528\uff09\uff0c\u5219\u4f1a\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5 \u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5bf9\u641c\u7d22\u548c\u7d22\u5f15\u626b\u63cf\u7981\u7528\u95f4\u9699\u9501\u5b9a\uff0c\u4ec5\u7528\u4e8e\u5916\u952e\u7ea6\u675f\u68c0\u67e5\u548c\u91cd\u590d\u952e\u68c0\u67e5\u3002</p> <p>\u4f7f\u7528 <code>READ COMMITTED</code>\u9694\u79bb\u7ea7\u522b\u6216\u542f\u7528 <code>innodb_locks_unsafe_for_binlog</code>. \u5728 MySQL \u8bc4\u4f30<code>WHERE</code>\u6761\u4ef6\u540e\u91ca\u653e\u4e0d\u5339\u914d\u884c\u7684\u8bb0\u5f55\u9501\u3002\u5bf9\u4e8e <code>UPDATE</code>\u62a5\u8868\uff0cInnoDB \u505a\u4e00\u4e2a\u201c\u534a\u4e00\u81f4\u201d\u8bfb\uff0c\u8fd9\u6837\u5b83\u8fd4\u56de\u7684\u6700\u65b0\u63d0\u4ea4\u7248\u672c\u5230MySQL\u4f7fMySQL\u80fd\u591f\u786e\u5b9a\u8be5\u884c\u662f\u5426\u6bd4\u8d5b<code>WHERE</code> \u7684\u6761\u4ef6UPDATE\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#next-key","title":"Next-Key \u9501","text":"<p>next-key \u9501\u662f\u7d22\u5f15\u8bb0\u5f55\u4e0a\u7684\u8bb0\u5f55\u9501\u548c\u95f4\u9699\u9501\u7684\u7ec4\u5408\u3002</p> <p>InnoDB\u6267\u884c\u884c\u7ea7\u9501\u5b9a\u7684\u65b9\u5f0f\u662f\uff0c\u5f53\u5b83\u641c\u7d22\u6216\u626b\u63cf\u8868\u7d22\u5f15\u65f6\uff0c\u5b83\u4f1a\u5728\u9047\u5230\u7684\u7d22\u5f15\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u5171\u4eab\u9501\u6216\u6392\u4ed6\u9501\u3002\u56e0\u6b64\uff0c\u884c\u7ea7\u9501\u5b9e\u9645\u4e0a\u662f\u7d22\u5f15\u8bb0\u5f55\u9501\u3002\u7d22\u5f15\u8bb0\u5f55\u4e0a\u7684 next-key \u9501\u4e5f\u4f1a\u5f71\u54cd\u8be5\u7d22\u5f15\u8bb0\u5f55\u4e4b\u524d\u7684\u201c\u95f4\u9699\u201d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cnext-key \u9501\u662f\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u52a0\u4e0a\u4e00\u4e2a\u5728\u7d22\u5f15\u8bb0\u5f55\u95f4\u9699\u4e0a\u7684\u95f4\u9699\u9501\u3002\u5982\u679c\u4e00\u4e2a\u4f1a\u8bdd\u5bf9<code>R</code>\u7d22\u5f15\u4e2d\u7684\u8bb0\u5f55\u5177\u6709\u5171\u4eab\u9501\u6216\u6392\u4ed6\u9501 \uff0c\u5219\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u4e0d\u80fd<code>R</code>\u5728\u7d22\u5f15\u987a\u5e8f\u4e2d\u7d27\u63a5\u5728\u524d\u7684\u95f4\u9699\u4e2d\u63d2\u5165\u65b0\u7684\u7d22\u5f15\u8bb0\u5f55 \u3002</p> <p>\u5047\u8bbe\u4e00\u4e2a\u7d22\u5f15\u5305\u542b\u503c 10\u300111\u300113 \u548c 20\u3002\u8be5\u7d22\u5f15\u53ef\u80fd\u7684 next-key \u9501\u6db5\u76d6\u4ee5\u4e0b\u533a\u95f4\uff0c\u5176\u4e2d\u5706\u62ec\u53f7\u8868\u793a\u6392\u9664\u533a\u95f4\u7aef\u70b9\uff0c\u65b9\u62ec\u53f7\u8868\u793a\u5305\u542b\u7aef\u70b9\uff1a</p> <pre><code>(negative infinity, 10]\n(10, 11]\n(11, 13]\n(13, 20]\n(20, positive infinity)\n</code></pre> <p>\u5bf9\u4e8e\u6700\u540e\u4e00\u4e2a\u65f6\u95f4\u95f4\u9694\uff0cnext-key lock \u9501\u5b9a\u7d22\u5f15\u4e2d\u6700\u5927\u503c\u4ee5\u4e0a\u7684\u95f4\u9699\uff0c\u5e76\u4e14\u201c supremum \u201d \u4f2a\u8bb0\u5f55\u7684\u503c\u9ad8\u4e8e\u7d22\u5f15\u4e2d\u7684\u4efb\u4f55\u5b9e\u9645\u503c\u3002supremum \u4e0d\u662f\u771f\u6b63\u7684\u7d22\u5f15\u8bb0\u5f55\uff0c\u56e0\u6b64\uff0c\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a next-key \u9501\u53ea\u9501\u5b9a\u6700\u5927\u7d22\u5f15\u503c\u4e4b\u540e\u7684\u95f4\u9699\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cInnoDB\u5728 <code>REPEATABLE READ</code>\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u8fd0\u884c\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cInnoDB\u4f7f\u7528 next-key \u9501\u8fdb\u884c\u641c\u7d22\u548c\u7d22\u5f15\u626b\u63cf\uff0c\u4ee5\u9632\u6b62\u5e7b\u8bfb\uff08\u8bf7\u53c2\u9605\u7b2c 14.7.4 \u8282\uff0c\u201c\u5e7b\u50cf\u884c\u201d\uff09\u3002</p> <p>\u7528\u4e8e\u4e0b\u4e00\u4e2a\u952e\u9501\u5b9a\u4e8b\u52a1\u6570\u636e\u51fa\u73b0\u7c7b\u4f3c\u4e8e\u5728\u4e0b\u9762<code>SHOW ENGINE INNODB STATUS</code>\u548c InnoDB\u7684\u76d1\u89c6\u5668 \u8f93\u51fa\uff1a</p> <pre><code>RECORD LOCKS space id 58 page no 3 n bits 72 index `PRIMARY` of table `test`.`t`\ntrx id 10080 lock_mode X\nRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0\n 0: len 8; hex 73757072656d756d; asc supremum;;\n\nRecord lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0\n 0: len 4; hex 8000000a; asc     ;;\n 1: len 6; hex 00000000274f; asc     'O;;\n 2: len 7; hex b60000019d0110; asc        ;;\n</code></pre>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#insert-intention-locks","title":"\u63d2\u5165\u610f\u5411\u9501Insert Intention Locks","text":"<p>\u63d2\u5165\u610f\u5411\u9501\u662f\u95f4\u9699\u9501\u7684\u4e00\u79cd\uff0c\u7531<code>INSERT</code>\u64cd\u4f5c\u5728\u63d2\u5165\u884c\u4e4b\u524d\u8bbe\u7f6e\u3002\u8fd9\u79cd\u9501\u53d1\u51fa\u4e86\u63d2\u5165\u610f\u56fe\u7684\u4fe1\u53f7\uff0c\u5982\u679c\u591a\u4e2a\u4e8b\u52a1\u5728\u540c\u4e00\u7d22\u5f15\u95f4\u9699\u4e2d\u63d2\u5165\u7684\u4f4d\u7f6e\u4e0d\u4e00\u6837\uff0c\u5c31\u4e0d\u9700\u8981\u4e92\u76f8\u7b49\u5f85\u3002\u5047\u8bbe\u6709\u6570\u503c\u4e3a4\u548c7\u7684\u7d22\u5f15\u8bb0\u5f55\u3002\u5206\u522b\u8bd5\u56fe\u63d2\u5165\u503c\u4e3a5\u548c6\u7684\u4e8b\u52a1\uff0c\u5728\u83b7\u5f97\u63d2\u5165\u884c\u7684\u72ec\u5360\u9501\u4e4b\u524d\uff0c\u5404\u81ea\u7528\u63d2\u5165\u610f\u56fe\u9501\u9501\u5b9a\u4e864\u548c7\u4e4b\u95f4\u7684\u95f4\u9699\uff0c\u4f46\u662f\u7531\u4e8e\u8fd9\u4e9b\u884c\u662f\u4e0d\u51b2\u7a81\u7684\uff0c\u6240\u4ee5\u4e0d\u4f1a\u4e92\u76f8\u963b\u585e\u3002</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u6f14\u793a\u4e86\u4e00\u4e2a\u4e8b\u52a1\u5728\u83b7\u5f97\u88ab\u63d2\u5165\u8bb0\u5f55\u7684\u72ec\u5360\u9501\u4e4b\u524d\uff0c\u91c7\u53d6\u63d2\u5165\u610f\u5411\u9501\u3002\u8fd9\u4e2a\u4f8b\u5b50\u6d89\u53ca\u4e24\u4e2a\u5ba2\u6237\uff0cA\u548cB\u3002</p> <p>\u5ba2\u6237\u7aefA\u521b\u5efa\u4e86\u4e00\u4e2a\u5305\u542b\u4e24\u4e2a\u7d22\u5f15\u8bb0\u5f55\uff0890\u548c102\uff09\u7684\u8868\uff0c\u7136\u540e\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728ID\u5927\u4e8e100\u7684\u7d22\u5f15\u8bb0\u5f55\u4e0a\u52a0\u4e00\u4e2a\u72ec\u5360\u9501\u3002\u8be5\u72ec\u5360\u9501\u5305\u62ec102\u53f7\u8bb0\u5f55\u524d\u7684\u95f4\u9699\u9501\u3002\uff1a</p> <pre><code>mysql&gt; CREATE TABLE child (id int(11) NOT NULL, PRIMARY KEY(id)) ENGINE=InnoDB;\nmysql&gt; INSERT INTO child (id) values (90),(102);\n\nmysql&gt; START TRANSACTION;\nmysql&gt; SELECT * FROM child WHERE id &gt; 100 FOR UPDATE;\n+-----+\n| id  |\n+-----+\n| 102 |\n+-----+\n</code></pre> <p>\u5ba2\u6237\u7aef B \u5f00\u59cb\u4e00\u4e2a\u4e8b\u52a1\u4ee5\u5728\u95f4\u9699\u4e2d\u63d2\u5165\u4e00\u6761\u8bb0\u5f55\u3002\u4e8b\u52a1\u5728\u7b49\u5f85\u83b7\u5f97\u6392\u4ed6\u9501\u65f6\u4f7f\u7528\u63d2\u5165\u610f\u5411\u9501\u3002(\u6ce8\uff1a\u6b64\u65f6\u80af\u5b9a\u662f\u63d2\u5165\u4e0d\u8fdb\u53bb\uff0c\u8981\u7b49\u5f85\u7684)</p> <pre><code>mysql&gt; START TRANSACTION;\nmysql&gt; INSERT INTO child (id) VALUES (101);\n</code></pre> <p>\u7528\u4e8e\u63d2\u5165\u610f\u56fe\u9501\u5b9a\u4e8b\u52a1\u6570\u636e\u51fa\u73b0\u7c7b\u4f3c\u4e8e\u5728\u4e0b\u9762 <code>SHOW ENGINE INNODB STATUS</code>\u548c InnoDB\u7684\u76d1\u89c6\u5668 \u8f93\u51fa\uff1a</p> <pre><code>RECORD LOCKS space id 31 page no 3 n bits 72 index `PRIMARY` of table `test`.`child`\ntrx id 8731 lock_mode X locks gap before rec insert intention waiting\nRecord lock, heap no 3 PHYSICAL RECORD: n_fields 3; compact format; info bits 0\n 0: len 4; hex 80000066; asc    f;;\n 1: len 6; hex 000000002215; asc     \" ;;\n 2: len 7; hex 9000000172011c; asc     r  ;;...\n</code></pre>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#auto-inc","title":"AUTO-INC \u9501","text":"<p><code>AUTO-INC</code>\u9501\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8868\u7ea7\u9501\uff0c\u5f53\u4e8b\u52a1\u63d2\u5165\u5230\u5177\u6709AUTO_INCREMENT\u5217\u7684\u8868\u4e2d\u3002\u5728\u6700\u7b80\u5355\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e00\u4e2a\u4e8b\u52a1\u6b63\u5728\u5411\u8868\u4e2d\u63d2\u5165\u503c\uff0c\u5219\u4efb\u4f55\u5176\u4ed6\u4e8b\u52a1\u90fd\u5fc5\u987b\u7b49\u5f85\u81ea\u5df1\u63d2\u5165\u64cd\u4f5c\uff0c\u4ee5\u4fbf\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u63d2\u5165\u7684\u884c\u63a5\u6536\u8fde\u7eed\u7684\u4e3b\u952e\u503c\u3002</p> <p>\u8be5<code>innodb_autoinc_lock_mode</code> \u53d8\u91cf\u63a7\u5236\u7528\u4e8e\u81ea\u52a8\u589e\u91cf\u9501\u5b9a\u7684\u7b97\u6cd5\u3002\u5b83\u5141\u8bb8\u60a8\u9009\u62e9\u5982\u4f55\u5728\u53ef\u9884\u6d4b\u7684\u81ea\u52a8\u589e\u91cf\u503c\u5e8f\u5217\u548c\u63d2\u5165\u64cd\u4f5c\u7684\u6700\u5927\u5e76\u53d1\u4e4b\u95f4\u8fdb\u884c\u6743\u8861\u3002</p> <p>\u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 14.6.1.6 \u8282\uff0c\u201cInnoDB \u4e2d\u7684 AUTO_INCREMENT \u5904\u7406\u201d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_11","title":"\u7a7a\u95f4\u7d22\u5f15\u7684\u8c13\u8bcd\u9501","text":"<p>InnoDB\u652f\u6301<code>SPATIAL</code> \u5bf9\u5305\u542b\u7a7a\u95f4\u6570\u636e\u7684\u5217\u8fdb\u884c\u7d22\u5f15\uff08\u8bf7\u53c2\u9605 \u7b2c 11.4.8 \u8282\uff0c\u201c\u4f18\u5316\u7a7a\u95f4\u5206\u6790\u201d\uff09\u3002</p> <p>\u8981\u628a\u624b\u9501\u6b62\u6d89\u53ca\u64cd\u4f5c <code>SPATIAL</code>\u7d22\u5f15\uff0c\u4e0b\u4e00\u952e\u9501\u5b9a\u4e0d\u80fd\u5f88\u597d\u5730\u652f\u6301\u5de5\u4f5c<code>REPEATABLE READ</code>\u6216 <code>SERIALIZABLE</code>\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u3002\u591a\u7ef4\u6570\u636e\u4e2d\u6ca1\u6709\u7edd\u5bf9\u6392\u5e8f\u7684\u6982\u5ff5\uff0c\u6240\u4ee5\u4e0d\u6e05\u695a\u54ea\u4e2a\u662f \u201c next \u201d\u952e\u3002</p> <p>\u8981\u4e3a\u5e26<code>SPATIAL</code>\u7d22\u5f15\u7684\u8868\u542f\u7528\u9694\u79bb\u7ea7\u522b\u652f\u6301 \uff0c\u8bf7InnoDB \u4f7f\u7528\u8c13\u8bcd\u9501\u3002\u7532<code>SPATIAL</code>\u7d22\u5f15\u5305\u542b\u6700\u5c0f\u5916\u63a5\u77e9\u5f62\uff08MBR\uff09\u503c\uff0c\u56e0\u6b64\uff0cInnoDB\u901a\u8fc7\u8bbe\u7f6e\u7528\u4e8e\u67e5\u8be2\u7684MBR\u503c\u7684\u8c13\u8bcd\u9501\u5f3a\u5236\u4e0a\u7684\u7d22\u5f15\u4e00\u81f4\u7684\u8bfb\u53d6\u3002\u5176\u4ed6\u4e8b\u52a1\u65e0\u6cd5\u63d2\u5165\u6216\u4fee\u6539\u4e0e\u67e5\u8be2\u6761\u4ef6\u5339\u914d\u7684\u884c\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1472-innodb","title":"14.7.2 InnoDB\u7684\u4e8b\u52a1\u6a21\u578b","text":"<p>InnoDB\u4e8b\u52a1\u6a21\u578b\u65e8\u5728\u5c06\u591a\u7248\u672c\u6570\u636e\u5e93\u7684\u6700\u4f73\u7279\u6027\u4e0e\u4f20\u7edf\u7684\u4e24\u9636\u6bb5\u9501\u5b9a\u76f8\u7ed3\u5408\u3002InnoDB\u5728\u884c\u7ea7\u522b\u4e0a\u6267\u884c\u9501\uff0c\u5e76\u4e14\u9ed8\u8ba4\u4ee5\u975e\u9501\u7684\u4e00\u81f4\u8bfb\u53d6\u65b9\u5f0f\u8fd0\u884c\u67e5\u8be2\uff0c\u4e0eOracle\u7684\u98ce\u683c\u4e00\u81f4\u3002InnoDB\u4e2d\u7684\u9501\u4fe1\u606f\u662f\u4ee5\u7a7a\u95f4\u6548\u7387\u7684\u65b9\u5f0f\u5b58\u50a8\u7684\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u9501\u5347\u7ea7\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u5141\u8bb8\u51e0\u4e2a\u7528\u6237\u9501\u5b9aInnoDB\u8868\u4e2d\u7684\u6bcf\u4e00\u884c\uff0c\u6216\u8005\u4efb\u4f55\u968f\u673a\u7684\u884c\u7684\u5b50\u96c6\uff0c\u800c\u4e0d\u4f1a\u5bfc\u81f4InnoDB\u5185\u5b58\u8017\u5c3d\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14721","title":"14.7.2.1 \u4e8b\u52a1\u9694\u79bb\u7ea7\u522b","text":"<p>\u4e8b\u52a1\u9694\u79bb\u662f\u6570\u636e\u5e93\u5904\u7406\u7684\u57fa\u7840\u4e4b\u4e00\u3002\u9694\u79bb\u662f\u7f29\u5199ACID \u4e2d\u7684 I \uff1b\u9694\u79bb\u7ea7\u522b\u662f\u5728\u591a\u4e2a\u4e8b\u52a1\u540c\u65f6\u8fdb\u884c\u66f4\u6539\u548c\u6267\u884c\u67e5\u8be2\u65f6\u5fae\u8c03\u7ed3\u679c\u7684\u6027\u80fd\u548c\u53ef\u9760\u6027\u3001\u4e00\u81f4\u6027\u548c\u53ef\u518d\u73b0\u6027\u4e4b\u95f4\u7684\u5e73\u8861\u7684\u8bbe\u7f6e\u3002</p> <p>InnoDB\u63d0\u4f9b\u4e86\u7531SQL:1992\u6807\u51c6\u63cf\u8ff0\u7684\u6240\u6709\u56db\u4e2a\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\uff1a <code>READ UNCOMMITTED</code>\uff0c <code>READ COMMITTED</code>\uff0c <code>REPEATABLE READ</code>\uff0c\u548c <code>SERIALIZABLE</code>\u3002InnoDB\u9ed8\u8ba4\u9694\u79bb\u7ea7\u522b\u662f <code>REPEATABLE READ</code>\u3002</p> <p>\u7528\u6237\u53ef\u4ee5\u4f7f\u7528<code>SET TRANSACTION</code>\u8bed\u53e5\u66f4\u6539\u5355\u4e2a\u4f1a\u8bdd\u6216\u6240\u6709\u540e\u7eed\u8fde\u63a5\u7684\u9694\u79bb\u7ea7\u522b\u3002\u8981\u4e3a\u6240\u6709\u8fde\u63a5\u8bbe\u7f6e\u670d\u52a1\u5668\u7684\u9ed8\u8ba4\u9694\u79bb\u7ea7\u522b\uff0c\u8bf7\u4f7f\u7528 <code>--transaction-isolation</code>\u547d\u4ee4\u884c\u6216\u9009\u9879\u6587\u4ef6\u4e2d\u7684\u9009\u9879\u3002\u6709\u5173\u9694\u79bb\u7ea7\u522b\u548c\u7ea7\u522b\u8bbe\u7f6e\u8bed\u6cd5\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 \u7b2c 13.3.6 \u8282\uff0c\u201cSET TRANSACTION \u8bed\u53e5\u201d\u3002</p> <p>InnoDB\u4f7f\u7528\u4e0d\u540c\u7684\u9501\u7b56\u7565\u652f\u6301\u6bcf\u4e2a\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b \u3002\u4f60\u53ef\u4ee5\u7528\u9ed8\u8ba4\u7684REPEATABLE READ\u7ea7\u522b\u5f3a\u5236\u6267\u884c\u9ad8\u5ea6\u7684\u4e00\u81f4\u6027\uff0c\u7528\u4e8e\u5bf9\u5173\u952e\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cACID\u7b26\u5408\u6027\u975e\u5e38\u91cd\u8981\u3002\u6216\u8005\u4f60\u53ef\u4ee5\u7528READ COMMITTED\u751a\u81f3READ UNCOMMITTED\u6765\u653e\u677e\u4e00\u81f4\u6027\u89c4\u5219\uff0c\u5728\u8bf8\u5982\u6279\u91cf\u62a5\u544a\u7684\u60c5\u51b5\u4e0b\uff0c\u7cbe\u786e\u7684\u4e00\u81f4\u6027\u548c\u53ef\u91cd\u590d\u7684\u7ed3\u679c\u4e0d\u5982\u6700\u5c0f\u5316\u9501\u7684\u5f00\u9500\u6765\u7684\u91cd\u8981\u3002SERIALIZABLE\u6267\u884c\u6bd4REPEATABLE READ\u66f4\u4e25\u683c\u7684\u89c4\u5219\uff0c\u4e3b\u8981\u7528\u4e8e\u7279\u6b8a\u60c5\u51b5\uff0c\u5982XA\u4e8b\u52a1\uff0c\u4ee5\u53ca\u6392\u9664\u5e76\u53d1\u548c\u6b7b\u9501\u7684\u95ee\u9898\u3002</p> <p>\u4e0b\u9762\u7684\u5217\u8868\u63cf\u8ff0\u4e86MySQL\u5982\u4f55\u652f\u6301\u4e0d\u540c\u7684\u4e8b\u52a1\u7ea7\u522b\u3002\u8be5\u5217\u8868\u4ece\u6700\u5e38\u7528\u7684\u7ea7\u522b\u5230\u6700\u4e0d\u5e38\u7528\u7684\u7ea7\u522b\u6392\u5217:</p> <ul> <li><code>REPEATABLE READ</code></li> </ul> <p>\u8fd9\u662fInnoDB\u9ed8\u8ba4\u7684\u9694\u79bb\u7ea7\u522b\u3002 \u540c\u4e00\u4e8b\u52a1\u5185\u7684\u4e00\u81f4\u6027\u8bfb\u53d6\u8bfb\u53d6\u7531\u7b2c\u4e00\u6b21\u8bfb\u53d6\u5efa\u7acb\u7684 \u5feb\u7167\u3002\u8fd9\u610f\u5473\u7740\uff0c\u5982\u679c\u60a8SELECT\u5728\u540c\u4e00\u4e8b\u52a1\u4e2d\u53d1\u51fa\u591a\u4e2a\u666e\u901a\uff08\u975e\u9501\u5b9a\uff09\u8bed\u53e5\uff0c\u5219\u8fd9\u4e9b <code>SELECT</code>\u8bed\u53e5\u5f7c\u6b64\u4e4b\u95f4\u4e5f\u662f\u4e00\u81f4\u7684\u3002\u8bf7\u53c2\u9605 \u7b2c 14.7.2.3 \u8282\uff0c\u201c\u4e00\u81f4\u7684\u975e\u9501\u5b9a\u8bfb\u53d6\u201d\u3002</p> <p>\u5bf9\u4e8e\u9501\u5b9a\u8bfb\u53d6 \uff08 <code>SELECT with FOR UPDATE</code>\u6216<code>LOCK IN SHARE MODE</code>\uff09\u3001 UPDATE\u548c <code>DELETE</code>\u8bed\u53e5\uff0c\u9501\u5b9a\u53d6\u51b3\u4e8e\u8bed\u53e5\u662f\u4f7f\u7528\u5177\u6709\u552f\u4e00\u641c\u7d22\u6761\u4ef6\u7684\u552f\u4e00\u7d22\u5f15\u8fd8\u662f\u8303\u56f4\u7c7b\u578b\u641c\u7d22\u6761\u4ef6\u3002</p> <ul> <li>\u5bf9\u4e8e\u5177\u6709\u552f\u4e00\u641c\u7d22\u6761\u4ef6\u7684\u552f\u4e00\u7d22\u5f15\uff0cInnoDB\u53ea\u9501\u5b9a\u627e\u5230\u7684\u7d22\u5f15\u8bb0\u5f55\uff0c\u800c\u4e0d\u9501\u5b9a\u5b83\u4e4b\u524d\u7684\u95f4\u9699\u3002</li> <li> <p>\u5bf9\u4e8e\u5176\u4ed6\u641c\u7d22\u6761\u4ef6\uff0cInnoDB \u9501\u5b9a\u626b\u63cf\u7684\u7d22\u5f15\u8303\u56f4\uff0c\u4f7f\u7528 \u95f4\u9699\u9501\u6216 next-key \u9501 \u963b\u6b62\u5176\u4ed6\u4f1a\u8bdd\u63d2\u5165\u8303\u56f4\u6240\u8986\u76d6\u7684\u95f4\u9699\u3002</p> </li> <li> <p><code>READ COMMITTED</code></p> </li> </ul> <p>\u6bcf\u4e2a\u4e00\u81f4\u8bfb\u53d6\uff0c\u5373\u4f7f\u5728\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u4e5f\u4f1a\u8bbe\u7f6e\u548c\u8bfb\u53d6\u81ea\u5df1\u7684\u65b0\u5feb\u7167\u3002</p> <p>\u5bf9\u4e8e\u9501\u5b9a\u8bfb\u53d6\uff08SELECTwith<code>FOR UPDATE</code>\u6216<code>LOCK IN SHARE MODE</code>\uff09\u3001UPDATE \u8bed\u53e5\u548c<code>DELETE</code> \u8bed\u53e5\uff0cInnoDB\u4ec5\u9501\u5b9a\u7d22\u5f15\u8bb0\u5f55\uff0c\u800c\u4e0d\u9501\u5b9a\u5b83\u4eec\u4e4b\u95f4\u7684\u95f4\u9699\uff0c\u56e0\u6b64\u5141\u8bb8\u5728\u9501\u5b9a\u8bb0\u5f55\u65c1\u8fb9\u81ea\u7531\u63d2\u5165\u65b0\u8bb0\u5f55\u3002\u95f4\u9699\u9501\u4ec5\u7528\u4e8e\u5916\u952e\u7ea6\u675f\u68c0\u67e5\u548c\u91cd\u590d\u952e\u68c0\u67e5\u3002</p> <p>\u7531\u4e8e\u95f4\u9699\u9501\u88ab\u7981\u7528\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u5e7b\u8bfb\u95ee\u9898\uff0c\u56e0\u4e3a\u5176\u4ed6\u4f1a\u8bdd\u53ef\u4ee5\u5c06\u65b0\u884c\u63d2\u5165\u95f4\u9699\u4e2d\u3002</p> <p><code>READ COMMITTED</code>\u9694\u79bb\u7ea7\u522b \u4ec5\u652f\u6301\u57fa\u4e8e\u884c\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55 \u3002\u5982\u679c\u4f7f\u7528<code>READ COMMITTED</code>with <code>binlog_format=MIXED</code>\uff0c\u670d\u52a1\u5668\u4f1a\u81ea\u52a8\u4f7f\u7528\u57fa\u4e8e\u884c\u7684\u65e5\u5fd7\u8bb0\u5f55\u3002</p> <p>\u4f7f\u7528<code>READ COMMITTED</code>\u6709\u989d\u5916\u7684\u6548\u679c\uff1a</p> <ul> <li>\u5bf9\u4e8e UPDATE\u6216\u8005 <code>DELETE</code>\u8bed\u53e5\uff0cInnoDB\u53ea\u4e3a\u5b83\u66f4\u65b0\u6216\u5220\u9664\u7684\u884c\u6301\u6709\u9501\u3002\u5728 MySQL \u8bc4\u4f30<code>WHERE</code>\u6761\u4ef6\u540e\u91ca\u653e\u4e0d\u5339\u914d\u884c\u7684\u8bb0\u5f55\u9501 \u3002\u8fd9\u5927\u5927\u964d\u4f4e\u4e86\u6b7b\u9501\u7684\u53ef\u80fd\u6027\uff0c\u4f46\u5b83\u4eec\u4ecd\u7136\u53ef\u80fd\u53d1\u751f\u3002</li> <li>\u5bf9\u4e8eUPDATE\u8bed\u53e5\uff0c\u5982\u679c\u884c\u5df2\u88ab\u9501\u5b9a\uff0cInnoDB \u6267\u884c\u4e00\u4e2a\u201c\u534a\u4e00\u81f4\u201d\u8bfb\uff0c\u8fd4\u56de\u6700\u65b0\u63d0\u4ea4\u7684\u7248\u672c\u5230MySQL\uff0c\u4ee5\u4fbfMySQL\u80fd\u591f\u786e\u5b9a\u8be5\u884c\u662f\u5426\u5339\u914d <code>WHERE</code>\u7684\u6761\u4ef6 UPDATE\u3002\u5982\u679c\u884c\u5339\u914d\uff08\u5fc5\u987b\u66f4\u65b0\uff09\uff0cMySQL \u518d\u6b21\u8bfb\u53d6\u8be5\u884c\uff0c\u8fd9\u6b21InnoDB\u8981\u4e48\u9501\u5b9a\u5b83\uff0c\u8981\u4e48\u7b49\u5f85\u9501\u5b9a\u5b83\u3002</li> </ul> <p>\u8003\u8651\u4ee5\u4e0b\u793a\u4f8b\uff0c\u4ece\u8be5\u8868\u5f00\u59cb\uff1a</p> <pre><code>CREATE TABLE t (a INT NOT NULL, b INT) ENGINE = InnoDB;\nINSERT INTO t VALUES (1,2),(2,3),(3,2),(4,3),(5,2);\nCOMMIT;\n</code></pre> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8868\u6ca1\u6709\u7d22\u5f15\uff0c\u56e0\u6b64\u641c\u7d22\u548c\u7d22\u5f15\u626b\u63cf\u4f7f\u7528\u9690\u85cf\u7684\u805a\u96c6\u7d22\u5f15\u8fdb\u884c\u8bb0\u5f55\u9501\u5b9a\uff08\u800c\u4e0d\u662f\u7d22\u5f15\u5217\u3002</p> <p>\u5047\u8bbe\u4e00\u4e2a\u4f1a\u8bdd\u4f7f\u7528\u8fd9\u4e9b\u8bed\u53e5\u6267\u884c\u4e00\u4e2aUPDATE \uff1a</p> <pre><code># Session A\nSTART TRANSACTION;\nUPDATE t SET b = 5 WHERE b = 3;\n</code></pre> <p>\u8fd8\u5047\u8bbe\u7b2c\u4e8c\u4e2a\u4f1a\u8bdd\u5728\u7b2c\u4e00\u4e2a\u4f1a\u8bdd\u4e4b\u540e\u6267\u884c\u4ee5\u4e0b\u8bed\u53e5\u6765\u6267\u884cUPDATE\uff1a</p> <pre><code># Session B\nUPDATE t SET b = 4 WHERE b = 2;\n</code></pre> <p>\u5728InnoDB\u6267\u884c\u6bcf\u4e2aUPDATE\uff0c\u5b83\u9996\u5148\u4e3a\u5b83\u8bfb\u53d6\u7684\u6bcf\u4e00\u884c\u83b7\u53d6\u4e00\u4e2a\u6392\u4ed6\u9501\uff0c\u7136\u540e\u51b3\u5b9a\u662f\u5426\u4fee\u6539\u5b83\u3002\u5982\u679c InnoDB\u4e0d\u4fee\u6539\u884c\uff0c\u5219\u91ca\u653e\u9501\u3002\u5426\u5219\uff0c InnoDB\u4fdd\u7559\u9501\u76f4\u5230\u4e8b\u52a1\u7ed3\u675f\u3002\u8fd9\u4f1a\u5f71\u54cd\u4e8b\u52a1\u5904\u7406\u5982\u4e0b\u3002</p> <p>\u4f7f\u7528\u9ed8\u8ba4<code>REPEATABLE READ</code> \u9694\u79bb\u7ea7\u522b\u65f6\uff0c\u7b2c\u4e00\u4e2aUPDATE\u5728\u5b83\u8bfb\u53d6\u7684\u6bcf\u4e00\u884c\u4e0a\u83b7\u53d6\u4e00\u4e2a x \u9501\uff0c\u5e76\u4e14\u4e0d\u91ca\u653e\u4efb\u4f55\u884c\uff1a</p> <pre><code>x-lock(1,2); retain x-lock\nx-lock(2,3); update(2,3) to (2,5); retain x-lock\nx-lock(3,2); retain x-lock\nx-lock(4,3); update(4,3) to (4,5); retain x-lock\nx-lock(5,2); retain x-lock\n</code></pre> <p>\u7b2c\u4e8c\u4e2aUPDATE\u5728\u5c1d\u8bd5\u83b7\u53d6\u4efb\u4f55\u9501\u65f6\u7acb\u5373\u963b\u585e\uff08\u56e0\u4e3a\u7b2c\u4e00\u6b21\u66f4\u65b0\u5df2\u4fdd\u7559\u6240\u6709\u884c\u4e0a\u7684\u9501\uff09\uff0c\u5e76\u4e14\u5728\u7b2c\u4e00\u6b21UPDATE\u63d0\u4ea4\u6216\u56de\u6eda\u4e4b\u524d\u4e0d\u4f1a\u7ee7\u7eed\uff1a</p> <pre><code>x-lock(1,2); block and wait for first UPDATE to commit or roll back\n</code></pre> <p>\u5982\u679c\u6539\u4e3a\u4f7f\u7528<code>READ COMMITTED</code>\uff0c\u5219\u7b2c\u4e00\u4e2aUPDATE\u5728\u5b83\u8bfb\u53d6\u7684\u6bcf\u4e00\u884c\u4e0a\u83b7\u53d6\u4e00\u4e2a x \u9501\uff0c\u5e76\u91ca\u653e\u5b83\u4e0d\u4fee\u6539\u7684\u90a3\u4e9b\u884c\uff1a</p> <pre><code>x-lock(1,2); unlock(1,2)\nx-lock(2,3); update(2,3) to (2,5); retain x-lock\nx-lock(3,2); unlock(3,2)\nx-lock(4,3); update(4,3) to (4,5); retain x-lock\nx-lock(5,2); unlock(5,2)\n</code></pre> <p>\u5bf9\u4e8e\u7b2c\u4e8c\u4e2a<code>UPDATE</code>\uff0cInnoDB\u6267\u884c \u201c\u534a\u4e00\u81f4\u6027\u201d\u8bfb\u53d6\uff0c\u5c06\u8bfb\u53d6\u7684\u6bcf\u4e00\u884c\u7684\u6700\u65b0\u63d0\u4ea4\u7248\u672c\u8fd4\u56de\u7ed9 MySQL\uff0c\u4ee5\u4fbf MySQL \u53ef\u4ee5\u786e\u5b9a\u8be5\u884c\u662f\u5426\u7b26\u5408 UPDATE\u7684 <code>WHERE</code>\u6761\u4ef6\uff1a</p> <pre><code>x-lock(1,2); update(1,2) to (1,4); retain x-lock\nx-lock(2,3); unlock(2,3)\nx-lock(3,2); update(3,2) to (3,4); retain x-lock\nx-lock(4,3); unlock(4,3)\nx-lock(5,2); update(5,2) to (5,4); retain x-lock\n</code></pre> <p>\u4f46\u662f\uff0c\u5982\u679c<code>WHERE</code>\u6761\u4ef6\u5305\u542b\u7d22\u5f15\u5217\u5e76InnoDB\u4f7f\u7528\u7d22\u5f15\uff0c\u5219\u5728\u83b7\u53d6\u548c\u4fdd\u7559\u8bb0\u5f55\u9501\u65f6\u4ec5\u8003\u8651\u7d22\u5f15\u5217\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u7b2c \u4e00\u4e2aUPDATE\u5728 b = 2 \u7684\u6bcf\u4e00\u884c\u4e0a\u83b7\u53d6\u5e76\u4fdd\u7559\u4e00\u4e2a x \u9501\u3002\u7b2c\u4e8c \u4e2aUPDATE\u5728\u5c1d\u8bd5\u83b7\u53d6\u76f8\u540c\u8bb0\u5f55\u4e0a\u7684 x \u9501\u65f6\u4f1a\u963b\u585e\uff0c\u56e0\u4e3a\u5b83\u4e5f\u4f7f\u7528\u5728 b \u5217\u4e0a\u5b9a\u4e49\u7684\u7d22\u5f15\u3002</p> <pre><code>CREATE TABLE t (a INT NOT NULL, b INT, c INT, INDEX (b)) ENGINE = InnoDB;\nINSERT INTO t VALUES (1,2,3),(2,2,4);\nCOMMIT;\n\n# Session A\nSTART TRANSACTION;\nUPDATE t SET b = 3 WHERE b = 2 AND c = 3;\n\n# Session B\nUPDATE t SET b = 4 WHERE b = 2 AND c = 4;\n</code></pre> <p>\u4f7f\u7528<code>READ COMMITTED</code> \u9694\u79bb\u7ea7\u522b\u7684\u6548\u679c\u4e0e\u542f\u7528\u4e0d\u63a8\u8350\u4f7f\u7528\u7684<code>innodb_locks_unsafe_for_binlog</code> \u53d8\u91cf\u76f8\u540c \uff0c\u4f46\u6709\u4ee5\u4e0b\u4f8b\u5916\uff1a</p> <ul> <li>\u542f\u7528 <code>innodb_locks_unsafe_for_binlog</code> \u662f\u5168\u5c40\u8bbe\u7f6e\u5e76\u5f71\u54cd\u6240\u6709\u4f1a\u8bdd\uff0c\u800c\u9694\u79bb\u7ea7\u522b\u53ef\u4ee5\u4e3a\u6240\u6709\u4f1a\u8bdd\u5168\u5c40\u8bbe\u7f6e\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u4f1a\u8bdd\u5355\u72ec\u8bbe\u7f6e\u3002</li> <li><code>innodb_locks_unsafe_for_binlog</code> \u53ea\u80fd\u5728\u670d\u52a1\u5668\u542f\u52a8\u65f6\u8bbe\u7f6e\uff0c\u800c\u9694\u79bb\u7ea7\u522b\u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u8bbe\u7f6e\u6216\u5728\u8fd0\u884c\u65f6\u66f4\u6539\u3002</li> </ul> <p><code>READ COMMITTED</code>\u56e0\u6b64\u63d0\u4f9b\u6bd4 \u66f4\u7cbe\u7ec6\u3001\u66f4\u7075\u6d3b\u7684\u63a7\u5236 <code>innodb_locks_unsafe_for_binlog</code>\u3002</p> <ul> <li><code>READ UNCOMMITTED</code></li> </ul> <p>SELECT\u8bed\u53e5\u662f\u4ee5\u975e\u9501\u5b9a\u7684\u65b9\u5f0f\u6267\u884c\u7684\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u4f7f\u7528\u67d0\u884c\u7684\u65e9\u671f\u7248\u672c\u3002\u56e0\u6b64\uff0c\u4f7f\u7528\u8fd9\u79cd\u9694\u79bb\u7ea7\u522b\uff0c\u8fd9\u79cd\u8bfb\u53d6\u662f\u4e0d\u4e00\u81f4\u7684\u3002\u8fd9\u4e5f\u88ab\u79f0\u4e3a\u810f\u8bfb\u3002\u5426\u5219\uff0c\u8fd9\u79cd\u9694\u79bb\u7ea7\u522b\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0eREAD COMMITTED\u7c7b\u4f3c\u3002COMMITTED`](https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_read-committed).</p> <ul> <li><code>SERIALIZABLE</code></li> </ul> <p>\u8fd9\u4e2a\u7ea7\u522b\u548cREPEATABLE READ\u4e00\u6837\uff0c\u4f46\u662f\u5982\u679c\u81ea\u52a8\u63d0\u4ea4\u88ab\u7981\u7528\uff0cInnoDB\u4f1a\u9690\u542b\u5730\u5c06\u6240\u6709\u666e\u901a\u7684SELECT\u8bed\u53e5\u8f6c\u6362\u4e3aSELECT ... LOCK IN SHARE MODE\u3002\u5982\u679c\u81ea\u52a8\u63d0\u4ea4\u88ab\u542f\u7528\uff0cSELECT\u662f\u5b83\u81ea\u5df1\u7684\u4e8b\u52a1\u3002\u56e0\u6b64\uff0c\u5b83\u88ab\u8ba4\u4e3a\u662f\u53ea\u8bfb\u7684\uff0c\u5982\u679c\u4f5c\u4e3a\u4e00\u4e2a\u4e00\u81f4\u7684\uff08\u975e\u9501\u5b9a\u7684\uff09\u8bfb\u6765\u6267\u884c\uff0c\u53ef\u4ee5\u88ab\u5e8f\u5217\u5316\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u4e3a\u5176\u4ed6\u4e8b\u52a1\u963b\u585e\u3002(\u5982\u679c\u5176\u4ed6\u4e8b\u52a1\u5df2\u7ecf\u4fee\u6539\u4e86\u6240\u9009\u7684\u884c\uff0c\u8981\u5f3a\u5236\u4e00\u4e2a\u666e\u901a\u7684SELECT\u963b\u585e\uff0c\u8bf7\u7981\u7528\u81ea\u52a8\u63d0\u4ea4\uff09\u3002)</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14722","title":"14.7.2.2 \u81ea\u52a8\u63d0\u4ea4\uff0c\u63d0\u4ea4\u548c\u56de\u6eda","text":"<p>\u5728InnoDB\u4e2d\uff0c\u6240\u6709\u7684\u7528\u6237\u6d3b\u52a8\u90fd\u53d1\u751f\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u3002\u5982\u679c\u542f\u7528\u4e86\u81ea\u52a8\u63d0\u4ea4\u6a21\u5f0f\uff0c\u6bcf\u4e2aSQL\u8bed\u53e5\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u4e8b\u52a1\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cMySQL\u4e3a\u6bcf\u4e2a\u542f\u7528\u4e86\u81ea\u52a8\u63d0\u4ea4\u529f\u80fd\u7684\u65b0\u8fde\u63a5\u542f\u52a8\u4f1a\u8bdd\uff0c\u56e0\u6b64\u5982\u679c\u6bcf\u4e2aSQL\u8bed\u53e5\u6ca1\u6709\u8fd4\u56de\u9519\u8bef\uff0cMySQL\u4f1a\u5728\u8be5\u8bed\u53e5\u4e4b\u540e\u8fdb\u884c\u63d0\u4ea4\u3002\u5982\u679c\u4e00\u4e2a\u8bed\u53e5\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\uff0c\u63d0\u4ea4\u6216\u56de\u6eda\u884c\u4e3a\u53d6\u51b3\u4e8e\u9519\u8bef\u3002</p> <p>\u542f\u7528\u4e86\u81ea\u52a8\u63d0\u4ea4\u529f\u80fd\u7684\u4f1a\u8bdd\u53ef\u4ee5\u901a\u8fc7\u660e\u786e\u7684START TRANSACTION\u6216BEGIN\u8bed\u53e5\u5f00\u59cb\uff0c\u5e76\u7528COMMIT\u6216ROLLBACK\u8bed\u53e5\u7ed3\u675f\u6765\u6267\u884c\u4e00\u4e2a\u591a\u8bed\u53e5\u4e8b\u52a1\u3002</p> <p>\u5982\u679c\u5728\u4f1a\u8bdd\u4e2d\u7528SET autocommit = 0\u7981\u7528\u4e86\u81ea\u52a8\u63d0\u4ea4\u6a21\u5f0f\uff0c\u90a3\u4e48\u8be5\u4f1a\u8bdd\u603b\u662f\u6709\u4e00\u4e2a\u4e8b\u52a1\u5728\u6253\u5f00\u3002COMMIT\u6216ROLLBACK\u8bed\u53e5\u4f1a\u7ed3\u675f\u5f53\u524d\u7684\u4e8b\u52a1\u5e76\u5f00\u59cb\u4e00\u4e2a\u65b0\u7684\u4e8b\u52a1\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u7981\u7528\u4e86\u81ea\u52a8\u63d0\u4ea4\u7684\u4f1a\u8bdd\u5728\u6ca1\u6709\u660e\u786e\u63d0\u4ea4\u6700\u7ec8\u4e8b\u52a1\u7684\u60c5\u51b5\u4e0b\u7ed3\u675f\uff0cMySQL\u5c06\u56de\u6eda\u8be5\u4e8b\u52a1\u3002</p> <p>\u4e00\u4e9b\u8bed\u53e5\u9690\u542b\u5730\u7ed3\u675f\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5c31\u50cf\u4f60\u5728\u6267\u884c\u8bed\u53e5\u524d\u505a\u4e86COMMIT\u4e00\u6837\u3002\u8be6\u60c5\u89c1 Section 13.3.3, \u201cStatements That Cause an Implicit Commit\u201d.</p> <p>COMMIT\u610f\u5473\u7740\u5728\u5f53\u524d\u4e8b\u52a1\u4e2d\u6240\u505a\u7684\u6539\u53d8\u662f\u6c38\u4e45\u6027\u7684\uff0c\u5e76\u4e14\u5bf9\u5176\u4ed6\u4f1a\u8bdd\u662f\u53ef\u89c1\u7684\u3002\u53e6\u4e00\u65b9\u9762\uff0cROLLBACK\u8bed\u53e5\u5219\u53d6\u6d88\u4e86\u5f53\u524d\u4e8b\u52a1\u6240\u505a\u7684\u6240\u6709\u4fee\u6539\u3002COMMIT\u548cROLLBACK\u90fd\u4f1a\u91ca\u653e\u6240\u6709\u5728\u5f53\u524d\u4e8b\u52a1\u4e2d\u8bbe\u7f6e\u7684InnoDB\u9501\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0eMySQL\u670d\u52a1\u5668\u7684\u8fde\u63a5\u662f\u5728\u542f\u7528\u81ea\u52a8\u63d0\u4ea4\u6a21\u5f0f\u7684\u60c5\u51b5\u4e0b\u5f00\u59cb\u7684\uff0c\u5b83\u5728\u4f60\u6267\u884c\u6bcf\u6761SQL\u8bed\u53e5\u65f6\u81ea\u52a8\u63d0\u4ea4\u3002\u5982\u679c\u4f60\u6709\u5176\u4ed6\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u7ecf\u9a8c\uff0c\u53ef\u80fd\u4f1a\u5bf9\u8fd9\u79cd\u64cd\u4f5c\u6a21\u5f0f\u611f\u5230\u964c\u751f\uff0c\u56e0\u4e3a\u5176\u4ed6\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u6807\u51c6\u505a\u6cd5\u662f\u53d1\u51fa\u4e00\u8fde\u4e32\u7684DML\u8bed\u53e5\u5e76\u63d0\u4ea4\u5b83\u4eec\u6216\u5c06\u5b83\u4eec\u5168\u90e8\u56de\u6eda\u3002</p> <p>\u8981\u4f7f\u7528\u591a\u8bed\u53e5\u4e8b\u52a1\uff0c\u8bf7\u7528SQL\u8bed\u53e5SET autocommit = 0\u5173\u95ed\u81ea\u52a8\u63d0\u4ea4\uff0c\u5e76\u6839\u636e\u60c5\u51b5\u7528COMMIT\u6216ROLLBACK\u7ed3\u675f\u6bcf\u4e2a\u4e8b\u52a1\u3002\u8981\u4fdd\u6301\u81ea\u52a8\u63d0\u4ea4\u72b6\u6001\uff0c\u7528START TRANSACTION\u5f00\u59cb\u6bcf\u4e2a\u4e8b\u52a1\uff0c\u7528COMMIT\u6216ROLLBACK\u7ed3\u675f\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u663e\u793a\u4e86\u4e24\u4e2a\u4e8b\u52a1\u3002\u7b2c\u4e00\u4e2a\u88ab\u63d0\u4ea4\uff0c\u7b2c\u4e8c\u4e2a\u88ab\u56de\u6eda\u3002</p> <pre><code>mysql&gt; CREATE TABLE customer (a INT, b CHAR (20), INDEX (a));\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; -- Do a transaction with autocommit turned on.\nmysql&gt; START TRANSACTION;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; INSERT INTO customer VALUES (10, 'Heikki');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; COMMIT;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; -- Do another transaction with autocommit turned off.\nmysql&gt; SET autocommit=0;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; INSERT INTO customer VALUES (15, 'John');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; INSERT INTO customer VALUES (20, 'Paul');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; DELETE FROM customer WHERE b = 'Heikki';\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; -- Now we undo those last 2 inserts and the delete.\nmysql&gt; ROLLBACK;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; SELECT * FROM customer;\n+------+--------+\n| a    | b      |\n+------+--------+\n|   10 | Heikki |\n+------+--------+\n1 row in set (0.00 sec)\nmysql&gt;\n</code></pre>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14723","title":"14.7.2.3 \u4e00\u81f4\u975e\u9501\u5b9a\u8bfb","text":"<p>\u4e00\u81f4\u6027\u8bfb\u53d6\u662f\u6307InnoDB\u4f7f\u7528\u591a\u7248\u672c\u6765\u67e5\u8be2\u5448\u73b0\u6570\u636e\u5e93\u5728\u67d0\u4e2a\u65f6\u95f4\u70b9\u7684\u5feb\u7167\u3002\u67e5\u8be2\u770b\u5230\u7684\u662f\u5728\u8be5\u65f6\u95f4\u70b9\u4e4b\u524d\u63d0\u4ea4\u7684\u4e8b\u52a1\u6240\u505a\u7684\u6539\u53d8\uff0c\u800c\u6ca1\u6709\u770b\u5230\u540e\u6765\u6216\u672a\u63d0\u4ea4\u7684\u4e8b\u52a1\u6240\u505a\u7684\u6539\u53d8\u3002\u8fd9\u4e2a\u89c4\u5219\u7684\u4f8b\u5916\u662f\uff0c\u67e5\u8be2\u53ef\u4ee5\u770b\u5230\u540c\u4e00\u4e8b\u52a1\u4e2d\u65e9\u671f\u8bed\u53e5\u6240\u505a\u7684\u6539\u53d8\u3002\u8fd9\u4e2a\u4f8b\u5916\u4f1a\u5bfc\u81f4\u4ee5\u4e0b\u5f02\u5e38\uff1a\u5982\u679c\u4f60\u66f4\u65b0\u4e86\u8868\u4e2d\u7684\u4e00\u4e9b\u884c\uff0cSELECT\u4f1a\u770b\u5230\u6700\u65b0\u7248\u672c\u7684\u66f4\u65b0\u884c\uff0c\u4f46\u662f\u5b83\u4e5f\u53ef\u80fd\u770b\u5230\u4efb\u4f55\u884c\u7684\u65e7\u7248\u672c\u3002\u5982\u679c\u5176\u4ed6\u4f1a\u8bdd\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u4e2a\u8868\uff0c\u8be5\u5f02\u5e38\u73b0\u8c61\u610f\u5473\u7740\u4f60\u53ef\u80fd\u770b\u5230\u8be5\u8868\u5904\u4e8e\u6570\u636e\u5e93\u4e2d\u4ece\u672a\u5b58\u5728\u7684\u72b6\u6001\u3002</p> <p>\u5982\u679c\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u662fREPEATABLE READ\uff08\u9ed8\u8ba4\u7ea7\u522b\uff09\uff0c\u540c\u4e00\u4e8b\u52a1\u4e2d\u7684\u6240\u6709\u4e00\u81f4\u8bfb\u53d6\u90fd\u4f1a\u8bfb\u53d6\u8be5\u4e8b\u52a1\u4e2d\u7b2c\u4e00\u4e2a\u6b64\u7c7b\u8bfb\u53d6\u6240\u5efa\u7acb\u7684\u5feb\u7167\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u63d0\u4ea4\u5f53\u524d\u4e8b\u52a1\u5e76\u5728\u4e4b\u540e\u53d1\u5e03\u65b0\u7684\u67e5\u8be2\u6765\u4e3a\u4f60\u7684\u67e5\u8be2\u83b7\u5f97\u4e00\u4e2a\u66f4\u65b0\u9c9c\u7684\u5feb\u7167\u3002</p> <p>\u5728READ COMMITTED\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1\u4e2d\u7684\u6bcf\u4e2a\u4e00\u81f4\u8bfb\u53d6\u90fd\u4f1a\u8bbe\u7f6e\u5e76\u8bfb\u53d6\u81ea\u5df1\u7684\u65b0\u5feb\u7167\u3002</p> <p>\u4e00\u81f4\u6027\u8bfb\u53d6\u662fInnoDB\u5904\u7406READ COMMITTED\u548cREPEATABLE READ\u9694\u79bb\u7ea7\u522b\u4e2dSELECT\u8bed\u53e5\u7684\u9ed8\u8ba4\u6a21\u5f0f\u3002\u4e00\u81f4\u6027\u8bfb\u53d6\u4e0d\u4f1a\u5728\u5176\u8bbf\u95ee\u7684\u8868\u4e0a\u8bbe\u7f6e\u4efb\u4f55\u9501\uff0c\u56e0\u6b64\u5728\u8868\u4e0a\u6267\u884c\u4e00\u81f4\u6027\u8bfb\u53d6\u7684\u540c\u65f6\uff0c\u5176\u4ed6\u4f1a\u8bdd\u53ef\u4ee5\u81ea\u7531\u4fee\u6539\u8fd9\u4e9b\u8868\u3002</p> <p>\u5047\u8bbe\u4f60\u6b63\u8fd0\u884c\u5728\u9ed8\u8ba4\u7684REPEATABLE READ\u9694\u79bb\u7ea7\u522b\u4e2d\u3002\u5f53\u4f60\u53d1\u51fa\u4e00\u81f4\u8bfb\u53d6\uff08\u4e5f\u5c31\u662f\u4e00\u4e2a\u666e\u901a\u7684SELECT\u8bed\u53e5\uff09\u65f6\uff0cInnoDB\u7ed9\u4f60\u7684\u4e8b\u52a1\u4e00\u4e2a\u65f6\u95f4\u70b9\uff0c\u4f60\u7684\u67e5\u8be2\u4f1a\u6839\u636e\u8fd9\u4e2a\u65f6\u95f4\u70b9\u6765\u67e5\u770b\u6570\u636e\u5e93\u3002\u5982\u679c\u53e6\u4e00\u4e2a\u4e8b\u52a1\u5220\u9664\u4e86\u4e00\u6761\u8bb0\u5f55\uff0c\u5e76\u5728\u4f60\u7684\u65f6\u95f4\u70b9\u88ab\u5206\u914d\u540e\u63d0\u4ea4\uff0c\u4f60\u4e0d\u4f1a\u770b\u5230\u8be5\u8bb0\u5f55\u88ab\u5220\u9664\u3002\u63d2\u5165\u548c\u66f4\u65b0\u4e5f\u662f\u7c7b\u4f3c\u7684\u5904\u7406\u65b9\u5f0f\u3002</p> <p>\u6ce8\u610f \u6570\u636e\u5e93\u72b6\u6001\u7684\u5feb\u7167\u9002\u7528\u4e8e\u4e8b\u52a1\u4e2d\u7684SELECT\u8bed\u53e5\uff0c\u4e0d\u4e00\u5b9a\u9002\u7528\u4e8eDML\u8bed\u53e5\u3002\u5982\u679c\u4f60\u63d2\u5165\u6216\u4fee\u6539\u4e86\u4e00\u4e9b\u884c\uff0c\u7136\u540e\u63d0\u4ea4\u4e86\u8be5\u4e8b\u52a1\uff0c\u90a3\u4e48\u4ece\u53e6\u4e00\u4e2a\u5e76\u53d1\u7684REPEATABLE READ\u4e8b\u52a1\u53d1\u51fa\u7684DELETE\u6216UPDATE\u8bed\u53e5\u53ef\u80fd\u4f1a\u5f71\u54cd\u90a3\u4e9b\u521a\u521a\u63d0\u4ea4\u7684\u884c\uff0c\u5373\u4f7f\u4f1a\u8bdd\u4e0d\u80fd\u67e5\u8be2\u5b83\u4eec\u3002\u5982\u679c\u4e00\u4e2a\u4e8b\u52a1\u786e\u5b9e\u66f4\u65b0\u6216\u5220\u9664\u4e86\u7531\u4e0d\u540c\u4e8b\u52a1\u63d0\u4ea4\u7684\u884c\uff0c\u8fd9\u4e9b\u53d8\u5316\u5bf9\u5f53\u524d\u7684\u4e8b\u52a1\u662f\u53ef\u89c1\u7684\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u4f1a\u9047\u5230\u4e0b\u9762\u8fd9\u79cd\u60c5\u51b5:</p> <pre><code>SELECT COUNT(c1) FROM t1 WHERE c1 = 'xyz';\n-- Returns 0: no rows match.\nDELETE FROM t1 WHERE c1 = 'xyz';\n-- Deletes several rows recently committed by other transaction.\n\nSELECT COUNT(c2) FROM t1 WHERE c2 = 'abc';\n-- Returns 0: no rows match.\nUPDATE t1 SET c2 = 'cba' WHERE c2 = 'abc';\n-- Affects 10 rows: another txn just committed 10 rows with 'abc' values.\nSELECT COUNT(c2) FROM t1 WHERE c2 = 'cba';\n-- Returns 10: this txn can now see the rows it just updated.\n</code></pre> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u63d0\u4ea4\u4f60\u7684\u4e8b\u52a1\uff0c\u7136\u540e\u505a\u53e6\u4e00\u4e2aSELECT\u6216START TRANSACTION WITH CONSISTENT SNAPSHOT\u6765\u63a8\u8fdb\u4f60\u7684\u65f6\u95f4\u70b9\u3002</p> <p>\u8fd9\u88ab\u79f0\u4e3a\u591a\u7248\u672c\u7684\u5e76\u53d1\u63a7\u5236MVCC\u3002</p> <p>\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u4f1a\u8bddA\u53ea\u6709\u5728B\u63d0\u4ea4\u4e86\u63d2\u5165\uff0cA\u4e5f\u63d0\u4ea4\u4e86\u7684\u60c5\u51b5\u4e0b\u624d\u80fd\u770b\u5230B\u63d2\u5165\u7684\u884c\uff0c\u8fd9\u6837\u65f6\u95f4\u70b9\u5c31\u63d0\u524d\u5230\u4e86B\u7684\u63d0\u4ea4\u4e4b\u540e\u3002</p> <pre><code>             Session A              Session B\n\n           SET autocommit=0;      SET autocommit=0;\ntime\n|          SELECT * FROM t;\n|          empty set\n|                                 INSERT INTO t VALUES (1, 2);\n|\nv          SELECT * FROM t;\n           empty set\n                                  COMMIT;\n\n           SELECT * FROM t;\n           empty set\n\n           COMMIT;\n\n           SELECT * FROM t;\n           ---------------------\n           |    1    |    2    |\n           ---------------------\n</code></pre> <p>\u5982\u679c\u4f60\u60f3\u770b\u5230\u6570\u636e\u5e93\u7684 \"\u6700\u65b0 \"\u72b6\u6001\uff0c\u53ef\u4ee5\u4f7f\u7528READ COMMITTED\u9694\u79bb\u7ea7\u522b\u6216\u9501\u5b9a\u8bfb\u53d6</p> <pre><code>SELECT * FROM t LOCK IN SHARE MODE;\n</code></pre> <p>\u5728READ COMMITTED\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1\u4e2d\u7684\u6bcf\u4e2a\u4e00\u81f4\u8bfb\u53d6\u90fd\u4f1a\u8bbe\u7f6e\u5e76\u8bfb\u53d6\u81ea\u5df1\u7684\u65b0\u5feb\u7167\u3002\u5728LOCK IN SHARE\u6a21\u5f0f\u4e0b\uff0c\u4f1a\u53d1\u751f\u4e00\u4e2a\u9501\u5b9a\u7684\u8bfb\u53d6\u3002\u4e00\u4e2aSELECT\u4f1a\u963b\u585e\uff0c\u76f4\u5230\u5305\u542b\u6700\u65b0\u9c9c\u8bb0\u5f55\u7684\u4e8b\u52a1\u7ed3\u675f\uff08\u53c2\u89c1\u7b2c14.7.2.4\u8282\uff0c\"\u9501\u5b9a\u8bfb\u53d6\"\uff09\u3002</p> <ul> <li> <p>\u4e00\u81f4\u6027\u8bfb\u53d6\u5728\u67d0\u4e9bDDL\u8bed\u53e5\u4e0a\u4e0d\u8d77\u4f5c\u7528\u3002</p> </li> <li> <p>\u4e00\u81f4\u6027\u8bfb\u53d6\u5728DROP TABLE\u4e0a\u4e0d\u8d77\u4f5c\u7528\uff0c\u56e0\u4e3aMySQL\u4e0d\u80fd\u4f7f\u7528\u4e00\u4e2a\u5df2\u7ecf\u88ab\u4e22\u5f03\u7684\u8868\uff0cInnoDB\u4f1a\u9500\u6bc1\u8be5\u8868\u3002</p> </li> </ul> <p>\u4e00\u81f4\u6027\u8bfb\u53d6\u5728ALTER TABLE\u64cd\u4f5c\u4e0a\u4e0d\u8d77\u4f5c\u7528\uff0cALTER TABLE\u64cd\u4f5c\u662f\u5bf9\u539f\u59cb\u8868\u8fdb\u884c\u4e34\u65f6\u62f7\u8d1d\uff0c\u5e76\u5728\u4e34\u65f6\u62f7\u8d1d\u5efa\u7acb\u540e\u5220\u9664\u539f\u59cb\u8868\u3002\u5f53\u4f60\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u91cd\u65b0\u53d1\u51fa\u4e00\u81f4\u8bfb\u53d6\u65f6\uff0c\u65b0\u8868\u4e2d\u7684\u884c\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u56e0\u4e3a\u5f53\u4e8b\u52a1\u7684\u5feb\u7167\u88ab\u62cd\u6444\u65f6\uff0c\u8fd9\u4e9b\u884c\u5e76\u4e0d\u5b58\u5728\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8be5\u4e8b\u52a1\u4f1a\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u3002ER_TABLE_DEF_CHANGED, \"\u8868\u5b9a\u4e49\u5df2\u7ecf\u6539\u53d8\uff0c\u8bf7\u91cd\u8bd5\u4e8b\u52a1\"\u3002</p> <p>\u5bf9\u4e8eINSERT INTO ...\u8fd9\u6837\u7684\u8bed\u53e5\u4e2d\u7684\u9009\u62e9\uff0c\u8bfb\u53d6\u7684\u7c7b\u578b\u662f\u4e0d\u540c\u7684\u3002\u9009\u62e9\uff0c\u66f4\u65b0... (SELECT)\uff0c\u548cCREATE TABLE ... SELECT\uff0c\u8fd9\u4e9b\u5b50\u53e5\u6ca1\u6709\u6307\u5b9aFOR UPDATE\u6216LOCK IN SHARE MODE\u3002</p> <ul> <li> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cInnoDB\u5728\u8fd9\u4e9b\u8bed\u53e5\u4e2d\u4f7f\u7528\u66f4\u5f3a\u7684\u9501\uff0c\u5e76\u4e14SELECT\u90e8\u5206\u7684\u884c\u4e3a\u5c31\u50cfREAD COMMITTED\uff0c\u5176\u4e2d\u6bcf\u4e2a\u4e00\u81f4\u7684\u8bfb\u53d6\uff0c\u751a\u81f3\u5728\u540c\u4e00\u4e8b\u52a1\u4e2d\uff0c\u8bbe\u7f6e\u548c\u8bfb\u53d6\u81ea\u5df1\u7684\u65b0\u5feb\u7167\u3002</p> </li> <li> <p>\u8981\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6267\u884c\u65e0\u9501\u8bfb\u53d6\uff0c\u8bf7\u542f\u7528innodb_locks_unsafe_for_binlog\u9009\u9879\uff0c\u5e76\u5c06\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\u8bbe\u7f6e\u4e3aREAD UNCOMMITTED\u3001READ COMMITTED\u6216REPEATABLE READ\uff0c\u4ee5\u907f\u514d\u5728\u4ece\u9009\u5b9a\u8868\u8bfb\u53d6\u7684\u884c\u4e0a\u8bbe\u7f6e\u9501\u3002</p> </li> </ul>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#14724","title":"14.7.2.4 \u9501\u5b9a\u8bfb\u53d6","text":"<p>\u5982\u679c\u4f60\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u5728\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u63d2\u5165\u6216\u66f4\u65b0\u76f8\u5173\u7684\u6570\u636e\uff0c\u5e38\u89c4\u7684SELECT\u8bed\u53e5\u5e76\u4e0d\u80fd\u63d0\u4f9b\u8db3\u591f\u7684\u4fdd\u62a4\u3002\u5176\u4ed6\u4e8b\u52a1\u53ef\u4ee5\u66f4\u65b0\u6216\u5220\u9664\u4f60\u521a\u521a\u67e5\u8be2\u7684\u540c\u4e00\u884c\u3002InnoDB\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u9501\u8bfb\uff0c\u63d0\u4f9b\u989d\u5916\u7684\u5b89\u5168\u3002</p> <ul> <li><code>SELECT ... LOCK IN SHARE MODE</code></li> </ul> <p>\u5728\u4efb\u4f55\u88ab\u8bfb\u53d6\u7684\u884c\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u5171\u4eab\u6a21\u5f0f\u7684\u9501\u3002\u5176\u4ed6\u4f1a\u8bdd\u53ef\u4ee5\u8bfb\u53d6\u8fd9\u4e9b\u884c\uff0c\u4f46\u662f\u5728\u4f60\u7684\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\u4e0d\u80fd\u4fee\u6539\u5b83\u4eec\u3002\u5982\u679c\u8fd9\u4e9b\u884c\u88ab\u53e6\u4e00\u4e2a\u5c1a\u672a\u63d0\u4ea4\u7684\u4e8b\u52a1\u6240\u6539\u53d8\uff0c\u4f60\u7684\u67e5\u8be2\u4f1a\u7b49\u5f85\uff0c\u76f4\u5230\u8be5\u4e8b\u52a1\u7ed3\u675f\uff0c\u7136\u540e\u4f7f\u7528\u6700\u65b0\u7684\u503c\u3002</p> <ul> <li><code>SELECT ... FOR UPDATE</code></li> </ul> <p>\u5bf9\u4e8e\u641c\u7d22\u9047\u5230\u7684\u7d22\u5f15\u8bb0\u5f55\uff0c\u9501\u4f4f\u8fd9\u4e9b\u884c\u548c\u4efb\u4f55\u76f8\u5173\u7684\u7d22\u5f15\u6761\u76ee\uff0c\u5c31\u50cf\u4f60\u5bf9\u8fd9\u4e9b\u884c\u6267\u884c\u4e86UPDATE\u8bed\u53e5\u4e00\u6837\u3002\u963b\u6b62\u5176\u4ed6\u4e8b\u52a1\u66f4\u65b0\u8fd9\u4e9b\u884c\uff0c\u963b\u6b62\u505aSELECT ... LOCK IN SHARE MODE\uff0c\u6216\u8005\u963b\u6b62\u5728\u67d0\u4e9b\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u4e2d\u8bfb\u53d6\u6570\u636e\u3002\u4e00\u81f4\u6027\u8bfb\u53d6\u4f1a\u5ffd\u7565\u5728\u8bfb\u53d6\u89c6\u56fe\u4e2d\u5b58\u5728\u7684\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u9501\u3002(\u8bb0\u5f55\u7684\u65e7\u7248\u672c\u4e0d\u80fd\u88ab\u9501\u5b9a\uff1b\u5b83\u4eec\u662f\u901a\u8fc7\u5728\u8bb0\u5f55\u7684\u5185\u5b58\u526f\u672c\u4e0a\u5e94\u7528\u64a4\u9500\u65e5\u5fd7\u6765\u91cd\u6784\u7684\u3002)</p> <p>\u5728\u5904\u7406\u6811\u72b6\u7ed3\u6784\u6216\u56fe\u72b6\u7ed3\u6784\u7684\u6570\u636e\u65f6\uff0c\u8fd9\u4e9b\u6761\u6b3e\u4e3b\u8981\u662f\u6709\u7528\u7684\uff0c\u65e0\u8bba\u662f\u5728\u4e00\u4e2a\u8868\u4e2d\u8fd8\u662f\u5728\u591a\u4e2a\u8868\u4e2d\u5206\u5272\u3002\u4f60\u4ece\u4e00\u4e2a\u5730\u65b9\u7a7f\u8d8a\u8fb9\u7f18\u6216\u6811\u679d\u5230\u53e6\u4e00\u4e2a\u5730\u65b9\uff0c\u540c\u65f6\u4fdd\u7559\u56de\u6765\u6539\u53d8\u4efb\u4f55\u8fd9\u4e9b \"\u6307\u9488 \"\u503c\u7684\u6743\u5229\u3002</p> <p>\u6240\u6709\u7531LOCK IN SHARE MODE\u548cFOR UPDATE\u67e5\u8be2\u8bbe\u7f6e\u7684\u9501\u5728\u4e8b\u52a1\u63d0\u4ea4\u6216\u56de\u6eda\u65f6\u88ab\u91ca\u653e\u3002</p> <p>\u6ce8\u610f \u53ea\u6709\u5728\u7981\u6b62\u81ea\u52a8\u63d0\u4ea4\u7684\u60c5\u51b5\u4e0b\u624d\u53ef\u4ee5\u9501\u5b9a\u8bfb\u53d6\uff08\u901a\u8fc7\u4f7f\u7528START TRANSACTION\u5f00\u59cb\u4e8b\u52a1\u6216\u5c06\u81ea\u52a8\u63d0\u4ea4\u8bbe\u7f6e\u4e3a0\u3002</p> <p>\u5728\u5916\u5c42\u8bed\u53e5\u4e2d\u7684\u9501\u5b9a\u8bfb\u53d6\u5b50\u53e5\u4e0d\u4f1a\u9501\u5b9a\u5d4c\u5957\u5b50\u67e5\u8be2\u4e2d\u7684\u8868\u7684\u884c\uff0c\u9664\u975e\u5728\u5b50\u67e5\u8be2\u4e2d\u4e5f\u6307\u5b9a\u4e86\u9501\u5b9a\u8bfb\u53d6\u5b50\u53e5\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e0d\u4f1a\u9501\u5b9a\u8868t2\u4e2d\u7684\u8bb0\u5f55\u3002</p> <pre><code>SELECT * FROM t1 WHERE c1 = (SELECT c1 FROM t2) FOR UPDATE;\n</code></pre> <p>\u8981\u9501\u5b9a\u8868t2\u4e2d\u7684\u8bb0\u5f55\uff0c\u9700\u8981\u5728\u5b50\u67e5\u8be2\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u9501\u5b9a\u7684\u8bfb\u53d6\u5b50\u53e5\u3002</p> <pre><code>SELECT * FROM t1 WHERE c1 = (SELECT c1 FROM t2 FOR UPDATE) FOR UPDATE;\n</code></pre>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#_12","title":"\u9501\u5b9a\u8bfb\u53d6\u7684\u4f8b\u5b50","text":"<p>\u5047\u8bbe\u4f60\u60f3\u5728\u8868child\u4e2d\u63d2\u5165\u4e00\u6761\u65b0\u7684\u8bb0\u5f55\uff0c\u5e76\u786e\u4fdd\u8be5\u5b50\u8bb0\u5f55\u5728\u8868parent\u4e2d\u6709\u4e00\u4e2a\u7236\u8bb0\u5f55\u3002\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u53ef\u4ee5\u5728\u8fd9\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c\u4e2d\u786e\u4fdd\u53c2\u8003\u5b8c\u6574\u6027\u3002</p> <p>\u9996\u5148\uff0c\u4f7f\u7528\u4e00\u4e2a\u4e00\u81f4\u7684\u8bfb\u6cd5\u6765\u67e5\u8be2\u8868PARENT\uff0c\u5e76\u9a8c\u8bc1\u7236\u884c\u662f\u5426\u5b58\u5728\u3002\u4f60\u80fd\u5b89\u5168\u5730\u63d2\u5165\u5b50\u884c\u5230\u8868CHILD\u4e2d\u5417\uff1f\u4e0d\u80fd\uff0c\u56e0\u4e3a\u5176\u4ed6\u4f1a\u8bdd\u53ef\u80fd\u5728\u4f60\u7684SELECT\u548cINSERT\u4e4b\u95f4\u5220\u9664\u7236\u884c\uff0c\u800c\u4f60\u5e76\u4e0d\u77e5\u9053\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u6f5c\u5728\u7684\u95ee\u9898\uff0c\u4f7f\u7528LOCK IN SHARE MODE\u6765\u6267\u884cSELECT\u3002</p> <pre><code>SELECT * FROM parent WHERE NAME = 'Jones' LOCK IN SHARE MODE;\n</code></pre> <p>\u5728LOCK IN SHARE MODE\u67e5\u8be2\u8fd4\u56de\u7236\u7c7b \"Jones \"\u540e\uff0c\u4f60\u53ef\u4ee5\u5b89\u5168\u5730\u5c06\u5b50\u7c7b\u8bb0\u5f55\u6dfb\u52a0\u5230CHILD\u8868\u4e2d\u5e76\u63d0\u4ea4\u4e8b\u52a1\u3002\u4efb\u4f55\u8bd5\u56fe\u5728PARENT\u8868\u7684\u9002\u7528\u884c\u4e2d\u83b7\u53d6\u72ec\u5360\u9501\u7684\u4e8b\u52a1\u90fd\u4f1a\u7b49\u5f85\uff0c\u76f4\u5230\u4f60\u5b8c\u6210\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u76f4\u5230\u6240\u6709\u8868\u4e2d\u7684\u6570\u636e\u90fd\u5904\u4e8e\u4e00\u81f4\u72b6\u6001\u3002</p> <p>\u53e6\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8003\u8651\u8868CHILD_CODES\u4e2d\u7684\u4e00\u4e2a\u6574\u6570\u8ba1\u6570\u5668\u5b57\u6bb5\uff0c\u7528\u6765\u7ed9\u8868CHILD\u4e2d\u6dfb\u52a0\u7684\u6bcf\u4e2a\u5b69\u5b50\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u7b26\u3002\u4e0d\u8981\u4f7f\u7528\u4e00\u81f4\u8bfb\u53d6\u6216\u5171\u4eab\u6a21\u5f0f\u8bfb\u53d6\u8ba1\u6570\u5668\u7684\u5f53\u524d\u503c\uff0c\u56e0\u4e3a\u6570\u636e\u5e93\u7684\u4e24\u4e2a\u7528\u6237\u53ef\u4ee5\u770b\u5230\u8ba1\u6570\u5668\u7684\u76f8\u540c\u503c\uff0c\u5982\u679c\u4e24\u4e2a\u4e8b\u52a1\u8bd5\u56fe\u5411CHILD\u8868\u6dfb\u52a0\u5177\u6709\u76f8\u540c\u6807\u8bc6\u7b26\u7684\u884c\uff0c\u4f1a\u53d1\u751f\u91cd\u590d\u952e\u9519\u8bef\u3002</p> <p>\u5728\u8fd9\u91cc\uff0cLOCK IN SHARE MODE\u4e0d\u662f\u4e00\u4e2a\u597d\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u56e0\u4e3a\u5982\u679c\u4e24\u4e2a\u7528\u6237\u540c\u65f6\u8bfb\u53d6\u8ba1\u6570\u5668\uff0c\u5f53\u5b83\u8bd5\u56fe\u66f4\u65b0\u8ba1\u6570\u5668\u65f6\uff0c\u81f3\u5c11\u6709\u4e00\u4e2a\u7528\u6237\u4f1a\u9677\u5165\u6b7b\u9501\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u8bfb\u53d6\u548c\u589e\u52a0\u8ba1\u6570\u5668\uff0c\u9996\u5148\u4f7f\u7528FOR UPDATE\u5bf9\u8ba1\u6570\u5668\u8fdb\u884c\u9501\u5b9a\u8bfb\u53d6\uff0c\u7136\u540e\u518d\u589e\u52a0\u8ba1\u6570\u5668\u3002\u6bd4\u5982\u8bf4</p> <pre><code>SELECT counter_field FROM child_codes FOR UPDATE;\nUPDATE child_codes SET counter_field = counter_field + 1;\n</code></pre> <p>\u4e00\u4e2aSELECT ... FOR UPDATE\u8bfb\u53d6\u6700\u65b0\u7684\u53ef\u7528\u6570\u636e\uff0c\u5728\u5b83\u8bfb\u53d6\u7684\u6bcf\u4e00\u884c\u4e0a\u8bbe\u7f6e\u72ec\u5360\u9501\u3002\u56e0\u6b64\uff0c\u5b83\u8bbe\u7f6e\u7684\u9501\u4e0e\u641c\u7d22\u7684SQL UPDATE\u5728\u884c\u4e0a\u8bbe\u7f6e\u7684\u9501\u76f8\u540c\u3002</p> <p>\u524d\u9762\u7684\u63cf\u8ff0\u53ea\u662f\u4e00\u4e2a\u5173\u4e8eSELECT ... FOR UPDATE\u5982\u4f55\u5de5\u4f5c\u7684\u4f8b\u5b50\u3002\u5728MySQL\u4e2d\uff0c\u751f\u6210\u552f\u4e00\u6807\u8bc6\u7b26\u7684\u5177\u4f53\u4efb\u52a1\u5b9e\u9645\u4e0a\u53ea\u9700\u4f7f\u7528\u5bf9\u8868\u7684\u4e00\u6b21\u8bbf\u95ee\u5c31\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002</p> <pre><code>UPDATE child_codes SET counter_field = LAST_INSERT_ID(counter_field + 1);\nselect last_insert_id();\n</code></pre> <p>SELECT\u8bed\u53e5\u53ea\u662f\u68c0\u7d22\u6807\u8bc6\u7b26\u4fe1\u606f\uff08\u7279\u5b9a\u4e8e\u5f53\u524d\u8fde\u63a5\uff09\u3002\u5b83\u5e76\u6ca1\u6709\u8bbf\u95ee\u4efb\u4f55\u8868\u3002</p> <p>\u6ce8\uff1a\u4ece\u4e0a\u9762\u7684\u4f8b\u5b50\u6765\u770b\uff0c\u9002\u7528\u4e8e\u4ee5\u4e0b\u60c5\u51b5\uff1f</p> <p>lock in share mode\u9002\u7528\u4e8e\u4e24\u5f20\u8868\u5b58\u5728\u4e1a\u52a1\u5173\u7cfb\u65f6\u7684\u4e00\u81f4\u6027\u8981\u6c42\uff0cfor  update\u9002\u7528\u4e8e\u64cd\u4f5c\u540c\u4e00\u5f20\u8868\u65f6\u7684\u4e00\u81f4\u6027\u8981\u6c42\u3002</p>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1473-innodbsql","title":"14.7.3 InnoDB\u5728\u4e0d\u540cSQL\u8bed\u53e5\u4e0a\u8bbe\u7f6e\u7684\u4e0d\u540c\u9501","text":"<p>\u9501\u5b9a\u8bfb\u53d6\u3001UPDATE\u6216\u8005DELETE\u901a\u5e38\u4f1a\u5bf9\u5728\u5904\u7406SQL\u8bed\u53e5\u4e2d\u88ab\u626b\u63cf\u7684\u6bcf\u4e00\u6761\u7d22\u5f15\u8bb0\u5f55\u8bbe\u7f6e\u8bb0\u5f55\u9501\u3002\u8bed\u53e5\u4e2d\u662f\u5426\u6709\u6392\u9664\u8be5\u884c\u7684WHERE\u6761\u4ef6\u5e76\u4e0d\u91cd\u8981\u3002InnoDB\u4e0d\u8bb0\u5f97\u786e\u5207\u7684WHERE\u6761\u4ef6\uff0c\u800c\u53ea\u77e5\u9053\u54ea\u4e9b\u7d22\u5f15\u8303\u56f4\u88ab\u626b\u63cf\u4e86\u3002\u8fd9\u4e9b\u9501\u901a\u5e38\u662fnext-key \u9501\uff0c\u4e5f\u4f1a\u963b\u6b62\u63d2\u5165\u5230\u7d27\u90bb\u8bb0\u5f55\u7684 \"\u95f4\u9699 \"\u4e2d\u3002\u7136\u800c\uff0c\u95f4\u9699\u9501\u53ef\u4ee5\u660e\u786e\u5730\u88ab\u7981\u7528\uff0c\u8fd9\u5c06\u5bfc\u81f4\u4e0d\u4f7f\u7528next-key \u9501\u3002</p> <p>\u5982\u679c\u5728\u641c\u7d22\u4e2d\u4f7f\u7528\u4e86\u4e8c\u7ea7\u7d22\u5f15\uff0c\u5e76\u4e14\u8981\u8bbe\u7f6e\u7684\u7d22\u5f15\u8bb0\u5f55\u9501\u662f\u72ec\u5360\u7684\uff0c\u90a3\u4e48InnoDB\u4e5f\u4f1a\u68c0\u7d22\u76f8\u5e94\u7684\u805a\u7c7b\u7d22\u5f15\u8bb0\u5f55\u5e76\u5bf9\u5b83\u4eec\u8bbe\u7f6e\u9501\u3002</p> <p>\u5982\u679c\u4f60\u6ca1\u6709\u9002\u5408\u4f60\u7684\u8bed\u53e5\u7684\u7d22\u5f15\uff0c\u5e76\u4e14MySQL\u5fc5\u987b\u626b\u63cf\u6574\u4e2a\u8868\u6765\u5904\u7406\u8be5\u8bed\u53e5\uff0c\u90a3\u4e48\u8868\u7684\u6bcf\u4e00\u884c\u90fd\u4f1a\u88ab\u9501\u5b9a\uff0c\u8fd9\u53cd\u8fc7\u6765\u53c8\u4f1a\u963b\u6b62\u5176\u4ed6\u7528\u6237\u5bf9\u8868\u7684\u6240\u6709\u63d2\u5165\u3002\u521b\u5efa\u826f\u597d\u7684\u7d22\u5f15\u662f\u5f88\u91cd\u8981\u7684\uff0c\u8fd9\u6837\u4f60\u7684\u67e5\u8be2\u5c31\u4e0d\u4f1a\u626b\u63cf\u8d85\u8fc7\u9700\u8981\u7684\u884c\u3002</p> <p>InnoDB\u8bbe\u7f6e\u7684\u7279\u5b9a\u7c7b\u578b\u7684\u9501\u5982\u4e0b\uff1a</p> <ul> <li> <p>SELECT ... FROM\u662f\u4e00\u4e2a\u4e00\u81f4\u7684\u8bfb\u53d6\uff0c\u8bfb\u53d6\u6570\u636e\u5e93\u7684\u4e00\u4e2a\u5feb\u7167\uff0c\u5e76\u4e14\u4e0d\u8bbe\u7f6e\u9501\uff0c\u9664\u975e\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u88ab\u8bbe\u7f6e\u4e3aSERIALIZABLE\u3002\u5bf9\u4e8eSERIALIZABLE\u7ea7\u522b\uff0c\u641c\u7d22\u5728\u5b83\u9047\u5230\u7684\u7d22\u5f15\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u5171\u4eab\u7684next-key \u9501\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\u9501\u5b9a\u884c\u7684\u8bed\u53e5\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u6765\u641c\u7d22\u552f\u4e00\u884c\u3002</p> </li> <li> <p>\u5bf9\u4e8eSELECT ... FOR UPDATE\u6216\u8005SELECT ... LOCK IN SHARE MODE\uff0c\u4f1a\u83b7\u53d6\u8981\u626b\u63cf\u7684\u884c\u7684\u9501\uff0c\u5e76\u4e14\u671f\u671b\u4f1a\u91ca\u653e\u4e0d\u7b26\u5408\u5217\u5165\u7ed3\u679c\u96c6\u884c\u7684\u9501\uff08\u4f8b\u5982\uff0c\u5982\u679c\u5b83\u4eec\u4e0d\u7b26\u5408WHERE\u5b50\u53e5\u4e2d\u7ed9\u51fa\u7684\u6807\u51c6\uff09\u3002\u7136\u800c\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u884c\u53ef\u80fd\u4e0d\u4f1a\u88ab\u7acb\u5373\u89e3\u9501\uff0c\u56e0\u4e3a\u5728\u67e5\u8be2\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u7ed3\u679c\u884c\u548c\u5176\u539f\u59cb\u6765\u6e90\u4e4b\u95f4\u7684\u5173\u7cfb\u4f1a\u4e22\u5931\u3002\u4f8b\u5982\uff0c\u5728UNION\u4e2d\uff0c\u4ece\u8868\u4e2d\u626b\u63cf\uff08\u548c\u9501\u5b9a\uff09\u7684\u884c\u53ef\u80fd\u4f1a\u5728\u8bc4\u4f30\u5b83\u4eec\u662f\u5426\u7b26\u5408\u7ed3\u679c\u96c6\u7684\u6761\u4ef6\u4e4b\u524d\u88ab\u63d2\u5165\u5230\u4e00\u4e2a\u4e34\u65f6\u8868\u4e2d\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4e34\u65f6\u8868\u4e2d\u7684\u8bb0\u5f55\u4e0e\u539f\u59cb\u8868\u4e2d\u7684\u8bb0\u5f55\u7684\u5173\u7cfb\u5c31\u4f1a\u4e22\u5931\uff0c\u5e76\u4e14\u540e\u8005\u7684\u8bb0\u5f55\u76f4\u5230\u67e5\u8be2\u6267\u884c\u7ed3\u675f\u65f6\u624d\u4f1a\u88ab\u89e3\u9501\u3002</p> </li> <li> <p>SELECT ... LOCK IN SHARE MODE\u5728\u641c\u7d22\u9047\u5230\u7684\u6240\u6709\u7d22\u5f15\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u5171\u4eab\u7684next-key \u9501\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\u9501\u5b9a\u8bb0\u5f55\u7684\u8bed\u53e5\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u6765\u641c\u7d22\u552f\u4e00\u7684\u8bb0\u5f55\u3002</p> </li> <li> <p>SELECT ... FOR UPDATE\u5728\u641c\u7d22\u9047\u5230\u7684\u6bcf\u4e00\u6761\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u72ec\u5360\u7684next-key\u9501\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\u9501\u5b9a\u8bb0\u5f55\u4ee5\u641c\u7d22\u552f\u4e00\u8bb0\u5f55\u7684\u8bed\u53e5\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u3002</p> </li> </ul> <p>\u5bf9\u4e8e\u641c\u7d22\u9047\u5230\u7684\u7d22\u5f15\u8bb0\u5f55\uff0cSELECT ... FOR UPDATE\u4f1a\u963b\u6b62\u5176\u4ed6\u4f1a\u8bdd\u8fdb\u884cSELECT ... LOCK IN SHARE MODE\u6216\u5728\u67d0\u4e9b\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u4e2d\u7684\u8bfb\u53d6\u3002\u4e00\u81f4\u6027\u8bfb\u53d6\u4f1a\u5ffd\u7565\u5728\u8bfb\u53d6\u89c6\u56fe\u4e2d\u5b58\u5728\u7684\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u7684\u4efb\u4f55\u9501\u3002</p> <ul> <li> <p>UPDATE ... WHERE ... \u5728\u641c\u7d22\u9047\u5230\u7684\u6bcf\u6761\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u72ec\u5360\u7684next-key\u9501\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\u9501\u5b9a\u8bb0\u5f55\u4ee5\u641c\u7d22\u552f\u4e00\u8bb0\u5f55\u7684\u8bed\u53e5\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u3002</p> </li> <li> <p>\u5f53UPDATE\u4fee\u6539\u4e00\u4e2a\u805a\u7c7b\u7d22\u5f15\u8bb0\u5f55\u65f6\uff0c\u4f1a\u5728\u53d7\u5f71\u54cd\u7684\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u4e0a\u91c7\u53d6\u9690\u5f0f\u9501\u3002\u5728\u63d2\u5165\u65b0\u7684\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u4e4b\u524d\u6267\u884c\u91cd\u590d\u68c0\u67e5\u626b\u63cf\u65f6\uff0c\u4ee5\u53ca\u63d2\u5165\u65b0\u7684\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u65f6\uff0cUPDATE\u64cd\u4f5c\u4e5f\u4f1a\u5728\u53d7\u5f71\u54cd\u7684\u4e8c\u7ea7\u7d22\u5f15\u8bb0\u5f55\u4e0a\u53d6\u5f97\u5171\u4eab\u9501\u3002</p> </li> <li> <p>DELETE FROM ... WHERE ... \u5728\u641c\u7d22\u9047\u5230\u7684\u6bcf\u6761\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u72ec\u5360\u7684next-key\u9501\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u4f7f\u7528\u552f\u4e00\u7d22\u5f15\u9501\u5b9a\u8bb0\u5f55\u7684\u8bed\u53e5\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u6765\u641c\u7d22\u552f\u4e00\u8bb0\u5f55\u3002</p> </li> <li> <p>INSERT\u5728\u63d2\u5165\u7684\u884c\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u72ec\u5360\u9501\u3002\u8fd9\u4e2a\u9501\u662f\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\uff0c\u800c\u4e0d\u662fnext-key\u9501\uff08\u4e5f\u5c31\u662f\u8bf4\uff0c\u6ca1\u6709\u95f4\u9699\u9501\uff09\uff0c\u5e76\u4e14\u4e0d\u963b\u6b62\u5176\u4ed6\u4f1a\u8bdd\u5728\u63d2\u5165\u7684\u884c\u4e4b\u524d\u63d2\u5165\u5230\u95f4\u9699\u4e2d\u3002</p> </li> </ul> <p>\u5728\u63d2\u5165\u884c\u4e4b\u524d\uff0c\u4f1a\u8bbe\u7f6e\u4e00\u79cd\u53eb\u505a\u63d2\u5165\u610f\u56fe\u95f4\u9699\u9501\u7684\u95f4\u9699\u9501\u3002\u8fd9\u4e2a\u9501\u53d1\u51fa\u4e86\u63d2\u5165\u610f\u56fe\u7684\u4fe1\u53f7\uff0c\u5982\u679c\u591a\u4e2a\u4e8b\u52a1\u5728\u540c\u4e00\u7d22\u5f15\u95f4\u9699\u4e2d\u63d2\u5165\u7684\u4f4d\u7f6e\u4e0d\u4e00\u6837\uff0c\u5c31\u4e0d\u9700\u8981\u4e92\u76f8\u7b49\u5f85\u3002\u5047\u8bbe\u6709\u6570\u503c\u4e3a4\u548c7\u7684\u7d22\u5f15\u8bb0\u5f55\u3002\u8bd5\u56fe\u63d2\u5165\u503c\u4e3a5\u548c6\u7684\u72ec\u7acb\u4e8b\u52a1\uff0c\u5728\u83b7\u5f97\u63d2\u5165\u884c\u7684\u72ec\u5360\u9501\u4e4b\u524d\uff0c\u5404\u81ea\u7528\u63d2\u5165\u610f\u56fe\u9501\u9501\u5b9a\u4e864\u548c7\u4e4b\u95f4\u7684\u95f4\u9699\uff0c\u4f46\u662f\u7531\u4e8e\u8fd9\u4e9b\u884c\u662f\u4e0d\u51b2\u7a81\u7684\uff0c\u6240\u4ee5\u4e0d\u4f1a\u4e92\u76f8\u963b\u585e\u3002</p> <p>\u5982\u679c\u53d1\u751f\u91cd\u590d\u952e\u9519\u8bef\uff0c\u5c31\u4f1a\u5728\u91cd\u590d\u7684\u7d22\u5f15\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u5171\u4eab\u9501\u3002\u5982\u679c\u6709\u591a\u4e2a\u4f1a\u8bdd\u8bd5\u56fe\u63d2\u5165\u540c\u4e00\u884c\uff0c\u800c\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u5df2\u7ecf\u6709\u4e86\u72ec\u5360\u9501\uff0c\u90a3\u4e48\u8fd9\u79cd\u5171\u4eab\u9501\u7684\u4f7f\u7528\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6b7b\u9501\u3002</p> <pre><code>CREATE TABLE t1 (i INT, PRIMARY KEY (i)) ENGINE = InnoDB;\n</code></pre> <p>\u73b0\u5728\u5047\u8bbe\u6709\u4e09\u4e2a\u4e8b\u52a1\u6309\u4ee5\u4e0b\u987a\u5e8f\u6267\u884c</p> <pre><code># session1:\nSTART TRANSACTION;\nINSERT INTO t1 VALUES(1);\n\n# session2\nSTART TRANSACTION;\nINSERT INTO t1 VALUES(1);\n\n# session3\nSTART TRANSACTION;\nINSERT INTO t1 VALUES(1);\n\n# session1\nROLLBACK;\n</code></pre> <p>\u4f1a\u8bdd1\u7684\u7b2c\u4e00\u4e2a\u64cd\u4f5c\u83b7\u5f97\u4e86\u8be5\u884c\u7684\u72ec\u5360\u9501\u3002\u4f1a\u8bdd2\u548c3\u7684\u64cd\u4f5c\u90fd\u5bfc\u81f4\u4e86\u4e00\u4e2a\u91cd\u590d\u952e\u7684\u9519\u8bef\uff0c\u4ed6\u4eec\u90fd\u8bf7\u6c42\u4e00\u4e2a\u884c\u7684\u5171\u4eab\u9501\u3002\u5f53\u4f1a\u8bdd1\u56de\u6eda\u65f6\uff0c\u5b83\u91ca\u653e\u4e86\u5bf9\u8be5\u884c\u7684\u72ec\u5360\u9501\uff0c\u4f1a\u8bdd2\u548c3\u7684\u6392\u961f\u5171\u4eab\u9501\u8bf7\u6c42\u88ab\u6279\u51c6\u3002\u5728\u8fd9\u4e00\u70b9\u4e0a\uff0c\u4f1a\u8bdd2\u548c3\u9677\u5165\u50f5\u5c40\u3002\u7531\u4e8e\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u6301\u6709\u7684\u5171\u4eab\u9501\uff0c\u8fd9\u4e24\u4e2a\u4f1a\u8bdd\u90fd\u4e0d\u80fd\u83b7\u5f97\u8be5\u884c\u7684\u72ec\u5360\u9501\u3002</p> <p>\u5982\u679c\u8868\u5df2\u7ecf\u5305\u542b\u4e00\u6761\u952e\u503c\u4e3a1\u7684\u884c\uff0c\u5e76\u4e14\u4e09\u4e2a\u4f1a\u8bdd\u4f9d\u6b21\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff0c\u4e5f\u4f1a\u51fa\u73b0\u7c7b\u4f3c\u7684\u60c5\u51b5:</p> <pre><code># Session 1:\nSTART TRANSACTION;\nDELETE FROM t1 WHERE i = 1;\n\n# Session 2:\nSTART TRANSACTION;\nINSERT INTO t1 VALUES(1);\n\n# Session 3:\nSTART TRANSACTION;\nINSERT INTO t1 VALUES(1);\n\n# Session 1:\nCOMMIT;\n</code></pre> <p>\u4f1a\u8bdd1\u7684\u7b2c\u4e00\u4e2a\u64cd\u4f5c\u83b7\u5f97\u4e86\u8be5\u884c\u7684\u72ec\u5360\u9501\u3002\u4f1a\u8bdd2\u548c3\u7684\u64cd\u4f5c\u90fd\u5bfc\u81f4\u4e86\u4e00\u4e2a\u91cd\u590d\u952e\u7684\u9519\u8bef\uff0c\u4ed6\u4eec\u90fd\u8bf7\u6c42\u4e00\u4e2a\u884c\u7684\u5171\u4eab\u9501\u3002\u5f53\u4f1a\u8bdd1\u63d0\u4ea4\u65f6\uff0c\u5b83\u91ca\u653e\u4e86\u5bf9\u8be5\u884c\u7684\u72ec\u5360\u9501\uff0c\u4f1a\u8bdd2\u548c3\u7684\u6392\u961f\u5171\u4eab\u9501\u8bf7\u6c42\u88ab\u6279\u51c6\u3002\u5728\u8fd9\u4e00\u70b9\u4e0a\uff0c\u4f1a\u8bdd2\u548c3\u9677\u5165\u50f5\u5c40\u3002\u7531\u4e8e\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u6301\u6709\u5171\u4eab\u9501\uff0c\u4e24\u4e2a\u4f1a\u8bdd\u90fd\u4e0d\u80fd\u83b7\u5f97\u8be5\u884c\u7684\u72ec\u5360\u9501\u3002</p> <ul> <li>INSERT ... ON DUPLICATE KEY UPDATE\u4e0e\u7b80\u5355\u7684INSERT\u4e0d\u540c\uff0c\u5f53\u53d1\u751f\u91cd\u590d\u952e\u9519\u8bef\u65f6\uff0c\u5728\u8981\u66f4\u65b0\u7684\u884c\u4e0a\u653e\u7f6e\u4e00\u4e2a\u72ec\u5360\u9501\u800c\u4e0d\u662f\u4e00\u4e2a\u5171\u4eab\u9501\u3002\u5bf9\u4e8e\u4e00\u4e2a\u91cd\u590d\u7684\u4e3b\u952e\u503c\uff0c\u4f1a\u6709\u4e00\u4e2a\u72ec\u5360\u7684\u7d22\u5f15\u8bb0\u5f55\u9501\u3002\u5bf9\u4e8e\u91cd\u590d\u7684\u552f\u4e00\u952e\u503c\uff0c\u4f1a\u4f7f\u7528\u72ec\u5360\u7684next-key\u9501\u3002</li> </ul> <p>\u5982\u679c\u5728\u552f\u4e00\u952e\u4e0a\u6ca1\u6709\u78b0\u649e\uff0cREPLACE\u4f1a\u50cfINSERT\u4e00\u6837\u8fdb\u884c\u3002\u5426\u5219\uff0c\u4e00\u4e2a\u6392\u4ed6\u6027\u7684next-key\u9501\u5c06\u88ab\u653e\u5728\u8981\u66ff\u6362\u7684\u884c\u4e0a\u3002</p> <ul> <li>INSERT INTO T SELECT ... FROM S WHERE ... \u5728\u63d2\u5165\u5230T\u4e2d\u7684\u6bcf\u4e00\u6761\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u72ec\u5360\u7d22\u5f15\u8bb0\u5f55\u9501\uff08\u6ca1\u6709\u95f4\u9699\u9501\uff09\u3002\u5982\u679c\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u662fREAD COMMITTED\uff0c\u6216\u8005innodb_locks_unsafe_for_binlog\u88ab\u542f\u7528\u5e76\u4e14\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u4e0d\u662fSERIALIZABLE\uff0cInnoDB\u5728S\u4e0a\u8fdb\u884c\u641c\u7d22\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u4e00\u81f4\u8bfb\u53d6\uff08\u6ca1\u6709\u9501\uff09\u3002\u5426\u5219\uff0cInnoDB\u4f1a\u5728S\u7684\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u5171\u4eab\u7684\u4e0b\u4e00\u4e2a\u952e\u9501\uff0c\u5728\u540e\u4e00\u79cd\u60c5\u51b5\u4e0b\uff0cInnoDB\u5fc5\u987b\u8bbe\u7f6e\u9501\u3002\u5728\u4f7f\u7528\u57fa\u4e8e\u8bed\u53e5\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8fdb\u884c\u5411\u524d\u6eda\u52a8\u6062\u590d\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6bcf\u4e2aSQL\u8bed\u53e5\u90fd\u5fc5\u987b\u4ee5\u5b8c\u5168\u76f8\u540c\u7684\u65b9\u5f0f\u6267\u884c\u3002</li> </ul> <p>\u521b\u5efa\u8868... SELECT ... \u4f7f\u7528\u5171\u4eab\u7684\u4e0b\u4e00\u4e2a\u952e\u9501\u6765\u6267\u884cSELECT\uff0c\u6216\u8005\u50cfINSERT ... SELECT\u4e00\u6837\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u4e00\u81f4\u7684\u8bfb\u3002</p> <p>\u5f53SELECT\u88ab\u7528\u4e8e\u6784\u9020REPLACE INTO t SELECT ... FROM s WHERE ... \u6216\u8005UPDATE t ... WHERE col IN (SELECT ... FROM s ...)\uff0cInnoDB\u5bf9s\u8868\u7684\u8bb0\u5f55\u8bbe\u7f6e\u5171\u4eab\u7684\u4e0b\u4e00\u4e2a\u952e\u9501\u3002</p> <ul> <li>InnoDB\u5728\u521d\u59cb\u5316\u8868\u7684\u4e00\u4e2a\u5148\u524d\u6307\u5b9a\u7684AUTO_INCREMENT\u5217\u65f6\uff0c\u5728\u4e0eAUTO_INCREMENT\u5217\u76f8\u5173\u7684\u7d22\u5f15\u7684\u672b\u7aef\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u72ec\u5360\u9501\u3002</li> </ul> <p>\u5728innodb_autoinc_lock_mode=0\u7684\u60c5\u51b5\u4e0b\uff0cInnoDB\u4f7f\u7528\u4e00\u79cd\u7279\u6b8a\u7684AUTO-INC\u8868\u9501\u6a21\u5f0f\uff0c\u5728\u8bbf\u95ee\u81ea\u52a8\u589e\u91cf\u8ba1\u6570\u5668\u65f6\uff0c\u8be5\u9501\u88ab\u83b7\u5f97\u5e76\u4fdd\u6301\u5230\u5f53\u524dSQL\u8bed\u53e5\u7684\u7ed3\u675f\uff08\u800c\u4e0d\u662f\u5230\u6574\u4e2a\u4e8b\u52a1\u7684\u7ed3\u675f\uff09\u3002\u5f53AUTO-INC\u8868\u9501\u88ab\u4fdd\u6301\u65f6\uff0c\u5176\u4ed6\u5ba2\u6237\u4e0d\u80fd\u63d2\u5165\u5230\u8be5\u8868\u3002\u540c\u6837\u7684\u884c\u4e3a\u53d1\u751f\u5728innodb_autoinc_lock_mode=1\u7684 \"\u6279\u91cf\u63d2\u5165 \"\u4e2d\u3002\u5728innodb_autoinc_lock_mode=2\u7684\u60c5\u51b5\u4e0b\uff0c\u8868\u7ea7\u7684AUTO-INC\u9501\u4e0d\u88ab\u4f7f\u7528\u3002\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u7ae0\u828214.6.1.6, \"InnoDB\u7684AUTO_INCREMENT\u5904\u7406\"\u3002</p> <p>InnoDB\u83b7\u53d6\u5148\u524d\u521d\u59cb\u5316\u7684AUTO_INCREMENT\u5217\u7684\u503c\u800c\u4e0d\u8bbe\u7f6e\u4efb\u4f55\u9501\u3002</p> <ul> <li> <p>\u5982\u679c\u5728\u8868\u4e0a\u5b9a\u4e49\u4e86\u4e00\u4e2aFOREIGN KEY\u7ea6\u675f\uff0c\u4efb\u4f55\u9700\u8981\u68c0\u67e5\u7ea6\u675f\u6761\u4ef6\u7684\u63d2\u5165\u3001\u66f4\u65b0\u6216\u5220\u9664\u90fd\u4f1a\u5728\u68c0\u67e5\u7ea6\u675f\u7684\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u5171\u4eab\u8bb0\u5f55\u7ea7\u9501\u3002InnoDB\u4e5f\u4f1a\u5728\u7ea6\u675f\u6761\u4ef6\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\u8bbe\u7f6e\u8fd9\u4e9b\u9501\u3002</p> </li> <li> <p>LOCK TABLES\u8bbe\u7f6e\u8868\u9501\uff0c\u4f46\u8bbe\u7f6e\u8fd9\u4e9b\u9501\u7684\u662fInnoDB\u5c42\u4ee5\u4e0a\u7684MySQL\u5c42\u3002\u5982\u679cinnodb_table_locks = 1\uff08\u9ed8\u8ba4\uff09\u548cautocommit = 0\uff0cInnoDB\u5c31\u77e5\u9053\u8868\u9501\uff0cInnoDB\u4e0a\u9762\u7684MySQL\u5c42\u77e5\u9053\u884c\u7ea7\u9501\u3002</p> </li> </ul> <p>\u5426\u5219\uff0cInnoDB\u7684\u81ea\u52a8\u6b7b\u9501\u68c0\u6d4b\u65e0\u6cd5\u68c0\u6d4b\u5230\u6d89\u53ca\u8fd9\u79cd\u8868\u9501\u7684\u6b7b\u9501\u3002\u53e6\u5916\uff0c\u56e0\u4e3a\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8f83\u9ad8\u7684MySQL\u5c42\u4e0d\u77e5\u9053\u884c\u7ea7\u9501\uff0c\u6240\u4ee5\u6709\u53ef\u80fd\u5728\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u5f53\u524d\u62e5\u6709\u884c\u7ea7\u9501\u7684\u8868\u4e0a\u83b7\u5f97\u4e00\u4e2a\u8868\u9501\u3002\u7136\u800c\uff0c\u8fd9\u5e76\u4e0d\u5371\u53ca\u4e8b\u52a1\u7684\u5b8c\u6574\u6027\uff0c\u6b63\u5982\u7b2c14.7.5.2\u8282 \"\u6b7b\u9501\u68c0\u6d4b \"\u4e2d\u6240\u8ba8\u8bba\u7684\u3002</p> <p>\u5982\u679cinnodb_table_locks=1\uff08\u9ed8\u8ba4\uff09\uff0cLOCK TABLES\u5728\u6bcf\u4e2a\u8868\u4e0a\u83b7\u5f97\u4e24\u4e2a\u9501\u3002\u9664\u4e86\u5728MySQL\u5c42\u4e0a\u7684\u8868\u9501\u5916\uff0c\u5b83\u8fd8\u83b7\u53d6\u4e00\u4e2aInnoDB\u8868\u9501\u3002\u8981\u907f\u514d\u83b7\u53d6InnoDB\u8868\u9501\uff0c\u8bf7\u8bbe\u7f6einnodb_table_locks=0\u3002 \u5982\u679c\u6ca1\u6709\u83b7\u53d6InnoDB\u8868\u9501\uff0c\u5373\u4f7f\u8868\u7684\u4e00\u4e9b\u8bb0\u5f55\u88ab\u5176\u4ed6\u4e8b\u52a1\u9501\u5b9a\uff0cLOCK TABLES\u4e5f\u4f1a\u5b8c\u6210\u3002</p> <p>\u5728MySQL 5.7\u4e2d\uff0cinnodb_table_locks=0\u5bf9\u7528LOCK TABLES ...\u660e\u786e\u9501\u5b9a\u7684\u8868\u6ca1\u6709\u5f71\u54cd\u3002WRITE\u9501\u5b9a\u7684\u8868\u6ca1\u6709\u5f71\u54cd\u3002\u5b83\u5bf9\u88abLOCK TABLES ... WRITE\u9501\u5b9a\u7684\u8bfb\u6216\u5199\u7684\u8868\u786e\u5b9e\u6709\u5f71\u54cd\u3002WRITE\uff08\u4f8b\u5982\uff0c\u901a\u8fc7\u89e6\u53d1\u5668\uff09\u6216\u901a\u8fc7LOCK TABLES ... \u9605\u8bfb\u3002</p> <ul> <li> <p>\u6240\u6709\u7531\u4e8b\u52a1\u6301\u6709\u7684InnoDB\u9501\u5728\u4e8b\u52a1\u63d0\u4ea4\u6216\u4e2d\u6b62\u65f6\u88ab\u91ca\u653e\u3002\u56e0\u6b64\uff0c\u5728\u81ea\u52a8\u63d0\u4ea4=1\u6a21\u5f0f\u4e0b\u5bf9InnoDB\u8868\u8c03\u7528LOCK TABLES\u6ca1\u6709\u591a\u5927\u610f\u4e49\uff0c\u56e0\u4e3a\u83b7\u5f97\u7684InnoDB\u8868\u9501\u5c06\u88ab\u7acb\u5373\u91ca\u653e\u3002</p> </li> <li> <p>\u4f60\u4e0d\u80fd\u5728\u4e8b\u52a1\u4e2d\u95f4\u9501\u5b9a\u5176\u4ed6\u7684\u8868\uff0c\u56e0\u4e3aLOCK TABLES\u4f1a\u6267\u884c\u9690\u542b\u7684COMMIT\u548cUNLOCK TABLES\u3002</p> </li> </ul>"},{"location":"database/03-InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/#1474","title":"14.7.4 \u5e7b\u8bfb","text":"<p>\u6240\u8c13\u7684\u5e7b\u8bfb\u95ee\u9898\u5c31\u662f\uff0c\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u4e2d\u540c\u4e00\u4e2a\u67e5\u8be2\u5728\u4e0d\u540c\u7684\u65f6\u95f4\u4ea7\u751f\u4e0d\u540c\u7684\u8bb0\u5f55\u96c6\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2aSELECT\u88ab\u6267\u884c\u4e86\u4e24\u6b21\uff0c\u4f46\u662f\u7b2c\u4e8c\u6b21\u8fd4\u56de\u4e86\u4e00\u6761\u7b2c\u4e00\u6b21\u6ca1\u6709\u8fd4\u56de\u7684\u8bb0\u5f55\uff0c\u90a3\u4e48\u8fd9\u6761\u8bb0\u5f55\u5c31\u662f\u4e00\u4e2a \"\u5e7b\u8bfb \"\u8bb0\u5f55\u3002</p> <p>\u5047\u8bbe\u5728\u5b50\u8868\u7684id\u5217\u4e0a\u6709\u4e00\u4e2a\u7d22\u5f15\uff0c\u4f60\u60f3\u4ece\u8868\u4e2d\u8bfb\u53d6\u5e76\u9501\u5b9a\u6240\u6709\u6807\u8bc6\u7b26\u503c\u5927\u4e8e100\u7684\u8bb0\u5f55\uff0c\u5e76\u6253\u7b97\u4ee5\u540e\u66f4\u65b0\u6240\u9009\u8bb0\u5f55\u4e2d\u7684\u67d0\u4e9b\u5217\u3002</p> <pre><code>SELECT * FROM child WHERE id &gt; 100 FOR UPDATE;\n</code></pre> <p>\u8fd9\u4e2a\u67e5\u8be2\u4eceid\u5927\u4e8e100\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55\u5f00\u59cb\u626b\u63cf\u7d22\u5f15\u3002\u8be5\u8868\u5305\u542bid\u503c\u4e3a90\u548c102\u7684\u8bb0\u5f55\u3002\u5982\u679c\u5728\u626b\u63cf\u8303\u56f4\u5185\u7684\u7d22\u5f15\u8bb0\u5f55\u4e0a\u8bbe\u7f6e\u7684\u9501\u6ca1\u6709\u9501\u5b9a\u5728\u7a7a\u767d\u5904\uff08\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c90\u548c102\u4e4b\u95f4\u7684\u7a7a\u767d\u5904\uff09\u8fdb\u884c\u7684\u63d2\u5165\uff0c\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u53ef\u4ee5\u5411\u8868\u4e2d\u63d2\u5165\u4e00\u6761id\u4e3a101\u7684\u65b0\u884c\u3002\u5982\u679c\u4f60\u5728\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u6267\u884c\u540c\u6837\u7684SELECT\uff0c\u4f60\u4f1a\u5728\u67e5\u8be2\u8fd4\u56de\u7684\u7ed3\u679c\u96c6\u4e2d\u770b\u5230\u4e00\u6761id\u4e3a101\u7684\u65b0\u884c\uff08\u4e00\u4e2a \"\u5e7b\u8bfb\"\uff09\u3002\u5982\u679c\u6211\u4eec\u628a\u4e00\u7ec4\u884c\u770b\u4f5c\u662f\u4e00\u4e2a\u6570\u636e\u9879\uff0c\u90a3\u4e48\u65b0\u7684\u5e7b\u8bfb\u5b50\u5c31\u4f1a\u8fdd\u53cd\u4e8b\u52a1\u7684\u9694\u79bb\u539f\u5219\uff0c\u5373\u4e00\u4e2a\u4e8b\u52a1\u5e94\u8be5\u80fd\u591f\u8fd0\u884c\uff0c\u4f7f\u5b83\u6240\u8bfb\u53d6\u7684\u6570\u636e\u5728\u4e8b\u52a1\u4e2d\u4e0d\u53d1\u751f\u53d8\u5316\u3002</p> <p>\u4e3a\u4e86\u9632\u6b62\u5e7b\u8bfb\uff0cInnoDB\u4f7f\u7528\u4e86\u4e00\u79cd\u53eb\u505anext-key\u7684\u7b97\u6cd5\uff0c\u5b83\u5c06\u7d22\u5f15-\u884c\u9501\u548c\u95f4\u9699\u9501\u7ed3\u5408\u8d77\u6765\u3002InnoDB\u6267\u884c\u884c\u7ea7\u9501\u7684\u65b9\u5f0f\u662f\uff0c\u5f53\u5b83\u641c\u7d22\u6216\u626b\u63cf\u4e00\u4e2a\u8868\u7684\u7d22\u5f15\u65f6\uff0c\u5b83\u5bf9\u5b83\u9047\u5230\u7684\u7d22\u5f15\u8bb0\u5f55\u8bbe\u7f6e\u5171\u4eab\u6216\u6392\u4ed6\u9501\u3002\u56e0\u6b64\uff0c\u884c\u7ea7\u9501\u5b9e\u9645\u4e0a\u662f\u7d22\u5f15-\u8bb0\u5f55\u9501\u3002\u6b64\u5916\uff0c\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u4e0a\u7684next-key \u9501\u4e5f\u4f1a\u5f71\u54cd\u5230\u7d22\u5f15\u8bb0\u5f55\u4e4b\u524d\u7684 \"\u95f4\u9699\"\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cnext-key \u9501\u662f\u4e00\u4e2a\u7d22\u5f15\u8bb0\u5f55\u9501\u52a0\u4e0a\u7d22\u5f15\u8bb0\u5f55\u4e4b\u95f4\u7684\u7a7a\u9699\u9501\u3002\u5982\u679c\u4e00\u4e2a\u4f1a\u8bdd\u5bf9\u7d22\u5f15\u4e2d\u7684\u8bb0\u5f55R\u6709\u4e00\u4e2a\u5171\u4eab\u6216\u72ec\u5360\u7684\u9501\uff0c\u53e6\u4e00\u4e2a\u4f1a\u8bdd\u5c31\u4e0d\u80fd\u5728\u7d22\u5f15\u987a\u5e8f\u4e2d\u7d27\u6328\u7740R\u7684\u7a7a\u9699\u4e2d\u63d2\u5165\u4e00\u4e2a\u65b0\u7684\u7d22\u5f15\u8bb0\u5f55\u3002</p> <p>\u5f53InnoDB\u626b\u63cf\u4e00\u4e2a\u7d22\u5f15\u65f6\uff0c\u5b83\u4e5f\u53ef\u4ee5\u9501\u5b9a\u7d22\u5f15\u4e2d\u6700\u540e\u4e00\u6761\u8bb0\u5f55\u4e4b\u540e\u7684\u7a7a\u9699\u3002\u5c31\u5728\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\u53d1\u751f\u4e86\u8fd9\u79cd\u60c5\u51b5\u3002\u4e3a\u4e86\u9632\u6b62\u4efb\u4f55\u63d2\u5165\u8868\u7684id\u5927\u4e8e100\uff0cInnoDB\u8bbe\u7f6e\u7684\u9501\u5305\u62ec\u5bf9id\u503c102\u4e4b\u540e\u7684\u7a7a\u9699\u7684\u9501\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f7f\u7528next-key \u9501\u6765\u5b9e\u73b0\u552f\u4e00\u6027\u68c0\u67e5\u3002\u5982\u679c\u4f60\u5728\u5171\u4eab\u6a21\u5f0f\u4e0b\u8bfb\u53d6\u4f60\u7684\u6570\u636e\uff0c\u5e76\u4e14\u6ca1\u6709\u770b\u5230\u4f60\u8981\u63d2\u5165\u7684\u884c\u7684\u91cd\u590d\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u5b89\u5168\u7684\u63d2\u5165\u4f60\u7684\u884c\uff0c\u5e76\u4e14\u77e5\u9053\u5728\u8bfb\u53d6\u8fc7\u7a0b\u4e2d\u5bf9\u4f60\u7684\u884c\u7684\u7ee7\u627f\u8005\u8bbe\u7f6e\u7684next-key \u9501\u53ef\u4ee5\u9632\u6b62\u4efb\u4f55\u4eba\u540c\u65f6\u63d2\u5165\u91cd\u590d\u7684\u884c\u3002\u56e0\u6b64\uff0cnext-key \u9501\u4f7f\u4f60\u80fd\u591f \"\u9501\u5b9a \"\u8868\u4e2d\u4e0d\u5b58\u5728\u7684\u4e1c\u897f\u3002</p> <p>\u6b63\u5982\u7b2c14.7.1\u8282 \"InnoDB\u9501\u5b9a \"\u4e2d\u6240\u8ba8\u8bba\u7684\uff0c\u95f4\u9699\u9501\u53ef\u4ee5\u88ab\u7981\u7528\u3002\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5e7d\u7075\u822c\u7684\u95ee\u9898\uff0c\u56e0\u4e3a\u5f53\u95f4\u9699\u9501\u88ab\u7981\u7528\u65f6\uff0c\u5176\u4ed6\u4f1a\u8bdd\u53ef\u4ee5\u5728\u95f4\u9699\u4e2d\u63d2\u5165\u65b0\u7684\u884c\u3002</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/","title":"MySQL\u7d22\u5f15","text":"<p>\u7d22\u5f15\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u66f4\u5feb\u7684\u67e5\u627e\u548c\u83b7\u53d6\u6307\u5b9a\u884c\u7684\u6570\u636e\uff0c\u662f\u589e\u5f3a\u6570\u636e\u5e93\u6027\u80fd\u7684\u5e38\u7528\u624b\u6bb5\u3002\u4f46\u662f\u5982\u679c\u6570\u636e\u5e93\u7d22\u5f15\u4f7f\u7528\u4e0d\u5408\u7406\u53cd\u800c\u4f1a\u964d\u4f4e\u6570\u636e\u5e93\u6027\u80fd\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e86\u89e3\u7d22\u5f15\u7684\u76f8\u5173\u539f\u7406\u548c\u4f7f\u7528\u89c4\u8303\u3002</p> <p>\u521b\u5efa\u7d22\u5f15\u8bed\u53e5\u4e3a\uff1aCREATE INDEX idx_name ON test1 (name);</p> <p>\u5220\u9664\u7d22\u5f15\u8bed\u53e5\u4e3a\uff1aDROP INDEX idx_name;</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_1","title":"\u7d22\u5f15\u7c7b\u578b","text":"<p>\u6309\u7167\u5b58\u50a8\u7ed3\u6784\u5206\u4e3a\uff1a</p> <ul> <li>HASH\u7d22\u5f15</li> </ul> <p>\u51e0\u4e4e\u552f\u4e00\u5bf9\u5e94\uff0c\u5728\u201c=\u201d\u548c\u201cin\u201d\u6761\u4ef6\u4e0b\u9ad8\u6548\uff0c\u4f46\u662f\u5bf9\u4e8e\u8303\u56f4\u67e5\u8be2\u3001\u6392\u5e8f\u53ca\u7ec4\u5408\u7d22\u5f15\u5c31\u4e0d\u592a\u9002\u5408\u4e86\u3002\u7d22\u5f15\u672c\u8eab\u54c8\u5e0c\u51fd\u6570\u7684\u8ba1\u7b97\u548c\u78b0\u649e\u95ee\u9898\u4e5f\u662f\u9700\u8981\u89e3\u51b3\u7684\u3002</p> <ul> <li>B+\u6811\u7d22\u5f15</li> </ul> <p>\u6700\u5e38\u7528\u4e5f\u662f\u9ed8\u8ba4\u7684\u7d22\u5f15</p> <p></p> <ul> <li>Rtree\u7d22\u5f15</li> </ul> <p>\u5728MySQL\u5f88\u5c11\u4f7f\u7528\uff0c\u4ec5\u652f\u6301geometry\u6570\u636e\u7c7b\u578b\uff0c\u76f8\u5bf9\u4e8eBTREE\uff0cRTREE\u7684\u4f18\u52bf\u5728\u4e8e\u8303\u56f4\u67e5\u627e\u3002</p> <ul> <li>FullText\u5168\u6587\u7d22\u5f15</li> </ul> <p>\u76ee\u524d\u53ea\u6709MyISAM\u5f15\u64ce\u652f\u6301\uff0c\u4e0d\u8fc7\u76ee\u524d\u53ea\u6709 CHAR\u3001VARCHAR \uff0cTEXT \u5217\u4e0a\u53ef\u4ee5\u521b\u5efa\u5168\u6587\u7d22\u5f15\u3002\u5168\u6587\u7d22\u5f15\u5e76\u4e0d\u662f\u548cMyISAM\u4e00\u8d77\u8bde\u751f\u7684\uff0c\u5b83\u7684\u51fa\u73b0\u662f\u4e3a\u4e86\u89e3\u51b3<code>WHERE name LIKE \u201c%word%\"</code>\u8fd9\u7c7b\u9488\u5bf9\u6587\u672c\u7684\u6a21\u7cca\u67e5\u8be2\u6548\u7387\u8f83\u4f4e\u7684\u95ee\u9898\u3002</p> <ul> <li>\u6709\u5e8f\u6570\u7ec4</li> </ul> <p>\u641c\u7d22\u7b97\u6cd5\u91cc\u63d0\u5230\u7684\u6709\u5e8f\u6570\u7ec4\uff0c\u5373\u53ef\u4ee5\u6309\u7167\u4e8c\u5206\u6cd5\u5feb\u901f\u67e5\u627e\u67d0\u4e2a\u503c\uff0c\u4e5f\u652f\u6301\u8303\u56f4\u67e5\u8be2\uff0c\u4f46\u662f\u52a8\u6001\u63d2\u5165\u4e0d\u65b9\u4fbf\uff0c\u53ea\u9002\u5408\u9759\u6001\u4e0d\u53d8\u7684\u5386\u53f2\u6570\u636e\u3002</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_2","title":"\u7d22\u5f15\u79cd\u7c7b","text":"<ul> <li> <p>\u805a\u96c6\u7d22\u5f15   \u805a\u7c07\u7d22\u5f15\u6307\u53f6\u5b50\u7ed3\u70b9\u5b58\u50a8\u5b9e\u9645\u8868\u6570\u636e\uff0c\u6216\u8005\u8bf4\u78c1\u76d8\u4e0a\u6570\u636e\u6587\u4ef6\u5c31\u662f\u805a\u96c6\u7d22\u5f15\u7684\u987a\u5e8f\u5b58\u653e\u7684\uff0c\u5982innodb\u7684\u4e3b\u952e\u7d22\u5f15 <code>*.ibd</code>\u6587\u4ef6\u3002\u8d70\u805a\u96c6\u7d22\u5f15\u7684\u8bdd\u4e0d\u5fc5\u518d\u6839\u636e\u5730\u5740\u53bb\u78c1\u76d8\u67e5\u3002</p> </li> <li> <p>\u4e8c\u7ea7\u7d22\u5f15/\u6b21\u7ea7\u7d22\u5f15\uff1a</p> </li> </ul> <p>\u5bf9\u4e8e\u4e8c\u7ea7\u7d22\u5f15\uff0c\u53f6\u5b50\u7ed3\u70b9\u5b58\u7740\u4e3b\u952e\u7684id\uff0c\u9700\u8981\u518d\u6b21\u56de\u8868\u5230\u805a\u7c07\u7d22\u5f15\u90a3\u91cc\u67e5\u8be2\u5176\u4ed6\u5b57\u6bb5\u6570\u636e\u3002\u4e00\u5f20\u8868\u53ea\u80fd\u6709\u552f\u4e00\u7684\u805a\u7c07\u7d22\u5f15\uff0c\u4f46\u662f\u53ef\u4ee5\u6709\u591a\u4e2a\u6b21\u7ea7\u7d22\u5f15\u3002</p> <p>\u6309\u7167\u7d22\u5f15\u7684\u7279\u6027\u53c8\u53ef\u4ee5\u5206\u4e3a\uff1a</p> <ul> <li> <p>\u666e\u901a\u7d22\u5f15\uff1a\u52a0\u901f\u67e5\u8be2</p> </li> <li> <p>\u4e3b\u952e\u7d22\u5f15\uff1a\u5217\u503c\u552f\u4e00\uff08\u4e0d\u53ef\u4ee5\u6709null\uff09+ \u8868\u4e2d\u53ea\u6709\u4e00\u4e2a</p> </li> <li> <p>\u552f\u4e00\u7d22\u5f15\uff1a \u5217\u503c\u552f\u4e00\uff08\u53ef\u4ee5\u6709\u591a\u4e2anull\uff09</p> </li> </ul> <p>\u552f\u4e00\u7d22\u5f15\u548c\u4e3b\u952e\u7d22\u5f15\u7684\u533a\u522b\uff1a\u4e3b\u952e\u7d22\u5f15\u4e5f\u5c5e\u4e8e\u552f\u4e00\u7d22\u5f15\uff0c\u8868\u4e2d\u53ea\u6709\u4e00\u4e2a\uff0c\u4e0d\u5141\u8bb8\u6709null\uff0cInnodb\u5f15\u64ce\u4e0b\u4e3b\u952e\u7d22\u5f15\u662f\u805a\u96c6\u7d22\u5f15\uff1b\u552f\u4e00\u7d22\u5f15\u53ef\u4ee5\u5b58\u5728\u591a\u4e2a\uff0c\u5141\u8bb8\u6709null\uff1b</p> <ul> <li>\u8054\u5408\u7d22\u5f15\uff1a\u591a\u5217\u503c\u7ec4\u6210\u4e00\u4e2a\u7d22\u5f15\uff0c\u4e13\u95e8\u7528\u4e8e\u7ec4\u5408\u641c\u7d22\uff0c\u5176\u6548\u7387\u5927\u4e8e\u7d22\u5f15\u5408\u5e76</li> </ul> <p></p> <ul> <li>\u8986\u76d6\u7d22\u5f15</li> </ul> <p>\u5982\u679c\u67e5\u8be2\u7684\u5217\u901a\u8fc7\u7d22\u5f15\u53ef\u76f4\u63a5\u8fd4\u56de\uff0c\u5c31\u79f0\u8be5\u7d22\u5f15\u4e3a\u67e5\u8be2sql\u7684\u8986\u76d6\u7d22\u5f15(Covering Index)\uff0c\u4e5f\u5c31\u662f\u5e73\u65f6\u6240\u8bf4\u7684\u4e0d\u9700\u8981\u56de\u8868\u64cd\u4f5c\u3002\u8986\u76d6\u7d22\u5f15\u8bb2\u89e3</p> <p>\u6267\u884c\u8ba1\u5212\u7684extra\u5217\u7684using index \u8868\u660e\u67e5\u8be2\u8d70\u7684\u7d22\u5f15\u8986\u76d6</p> <ul> <li>\u524d\u7f00\u7d22\u5f15</li> </ul> <p>\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5bf9\u5b57\u7b26\u5217\u7684\u524d\u51e0\u4e2a\u5b57\u7b26\u5efa\u7acb\u7d22\u5f15\u5982<code>ADD KEY(email(6))</code>\uff0c\u8fd9\u6837\u7684\u597d\u5904\u662f\u964d\u4f4e\u7d22\u5f15\u6587\u4ef6\u7684\u5927\u5c0f\uff1b\u4f46\u662f\u4e0d\u80fd\u7cbe\u786e\u5339\u914d\uff0c\u5bfc\u81f4\u56de\u8868\u7684\u6b21\u6570\u589e\u52a0\uff0c\u4e5f\u4e0d\u80fd\u7528\u4f5c\u8986\u76d6\u7d22\u5f15\u4e86\u3002</p> <p>\u4e00\u822c\u6ca1\u5fc5\u8981\u4e3a\u4e86\u4f18\u5316\u7d22\u5f15\u7684\u5927\u5c0f\u5efa\u7acb\u524d\u7f00\u7d22\u5f15\u3002\u5982\u679c\u5b57\u7b26\u957f\u5ea6\u8fc7\u957f\uff0cmysql\u4f1a\u81ea\u52a8\u5efa\u7acb\u524d\u7f00\u7d22\u5f15\uff0c\u964d\u4f4e\u67e5\u8be2\u6548\u7387\u3002</p> <p>\u5982\u679c\u5b57\u6bb5\u524d\u51e0\u4e2a\u5b57\u7b26\u533a\u5206\u5ea6\u4e0d\u9ad8\uff0c\u53ef\u4ee5\u5efa\u7acb\u5012\u5e8f\u5b58\u50a8\uff0c\u6216\u589e\u52a0hash\u5b58\u50a8\u5b57\u6bb5\u3002\u4f46\u662f\u6ce8\u610f\u6b64\u65f6\u4e0d\u652f\u6301\u8303\u56f4\u626b\u63cf\u4e86\u5c31\uff0c\u53ef\u4ee5\u7528\u4e8e\u8eab\u4efd\u8bc1\uff0c\u6709\u4e00\u5b9a\u89c4\u5219\u7684\u5b66\u53f7\u7b49\u5b57\u6bb5</p> <p>\u9996\u5148\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u7b97\u51fa\u8fd9\u4e2a\u5217\u4e0a\u6709\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u503c\uff1a</p> <pre><code>mysql&gt; select count(distinct email) as L from SUser;\n</code></pre> <p>\u7136\u540e\uff0c\u4f9d\u6b21\u9009\u53d6\u4e0d\u540c\u957f\u5ea6\u7684\u524d\u7f00\u6765\u770b\u8fd9\u4e2a\u503c\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u770b\u4e00\u4e0b4~7\u4e2a\u5b57\u8282\u7684\u524d\u7f00\u7d22\u5f15\uff0c\u53ef\u4ee5\u7528\u8fd9\u4e2a\u8bed\u53e5\uff1a</p> <pre><code>mysql&gt; select \n\n count(distinct left(email,4)\uff09as L4,\n\n count(distinct left(email,5)\uff09as L5,\n\n count(distinct left(email,6)\uff09as L6,\n\n count(distinct left(email,7)\uff09as L7,\n\nfrom SUser;\n</code></pre> <p>\u5f53\u7136\uff0c\u4f7f\u7528\u524d\u7f00\u7d22\u5f15\u5f88\u53ef\u80fd\u4f1a\u635f\u5931\u533a\u5206\u5ea6\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u9884\u5148\u8bbe\u5b9a\u4e00\u4e2a\u53ef\u4ee5\u63a5\u53d7\u7684\u635f\u5931\u6bd4\u4f8b\uff0c\u6bd4\u59825%\u3002\u7136\u540e\uff0c\u5728\u8fd4\u56de\u7684L4~L7\u4e2d\uff0c\u627e\u51fa\u4e0d\u5c0f\u4e8e L * 95%\u7684\u503c\uff0c\u5047\u8bbe\u8fd9\u91ccL6\u3001L7\u90fd\u6ee1\u8db3\uff0c\u4f60\u5c31\u53ef\u4ee5\u9009\u62e9\u524d\u7f00\u957f\u5ea6\u4e3a6\u3002</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_3","title":"\u7d22\u5f15\u6761\u4ef6\u4e0b\u63a8","text":"<p>\u7d22\u5f15\u6761\u4ef6\u4e0b\u63a8\uff08index condition pushdown \uff09\u7b80\u79f0ICP\uff0c\u5728Mysql5.6\u7684\u7248\u672c\u4e0a\u63a8\u51fa\uff0c\u7528\u4e8e\u4f18\u5316\u67e5\u8be2\u3002\u5b83\u7684\u6838\u5fc3\u601d\u60f3\u662f\uff1a\u5c06WHERE\u6761\u4ef6\u4e2d\u53ef\u4ee5\u5728\u7d22\u5f15\u4e2d\u5224\u65ad\u7684\u90e8\u5206\"\u4e0b\u63a8\"\u5230\u5b58\u50a8\u5f15\u64ce\u5c42\u6267\u884c\uff0c\u4ece\u800c\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u6570\u636e\u8bfb\u53d6\u548c\u4f20\u8f93</p> <p>\u5728\u4e0d\u4f7f\u7528ICP\u7684\u60c5\u51b5\u4e0b\uff0c\u5728\u4f7f\u7528\u4e8c\u7ea7\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\u65f6\uff0c\u5b58\u50a8\u5f15\u64ce\u901a\u8fc7\u7d22\u5f15\u68c0\u7d22\u5230\u6570\u636e\uff0c\u7136\u540e\u8fd4\u56de\u7ed9MySQL\u670d\u52a1\u5668\uff0c\u670d\u52a1\u5668\u7136\u540e\u5224\u65ad\u6570\u636e\u662f\u5426\u7b26\u5408\u6761\u4ef6 \u3002</p> <p>\u5728\u4f7f\u7528ICP\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u5b58\u5728\u67d0\u4e9b\u88ab\u7d22\u5f15\u7684\u5217\u7684\u5224\u65ad\u6761\u4ef6\u65f6\uff0cMySQL\u670d\u52a1\u5668\u5c06\u8fd9\u4e00\u90e8\u5206\u5224\u65ad\u6761\u4ef6\u4f20\u9012\u7ed9\u5b58\u50a8\u5f15\u64ce\uff0c\u7136\u540e\u7531\u5b58\u50a8\u5f15\u64ce\u901a\u8fc7\u5224\u65ad\u7d22\u5f15\u662f\u5426\u7b26\u5408MySQL\u670d\u52a1\u5668\u4f20\u9012\u7684\u6761\u4ef6\uff0c\u53ea\u6709\u5f53\u7d22\u5f15\u7b26\u5408\u6761\u4ef6\u65f6\u624d\u4f1a\u5c06\u6570\u636e\u68c0\u7d22\u51fa\u6765\u8fd4\u56de\u7ed9MySQL\u670d\u52a1\u5668 \u3002\u8fd9\u6837\u5c31\u51cf\u5c11\u5b58\u50a8\u5f15\u64ce\u67e5\u8be2\u57fa\u7840\u8868\u7684\u6b21\u6570\uff0c\u4e5f\u53ef\u4ee5\u51cf\u5c11MySQL\u670d\u52a1\u5668\u4ece\u5b58\u50a8\u5f15\u64ce\u63a5\u6536\u6570\u636e\u7684\u6b21\u6570\u3002</p> <p>\u5982\u5efa\u7acb\u8054\u5408\u7d22\u5f15\uff08name\uff0cage\uff09\uff0c\u67e5\u8be2<code>where  name like '\u9648%' and age=20</code>\uff0c\u6ca1\u6709\u5f00\u542fICP\u65f6\u4f1a\u76f4\u63a5\u901a\u8fc7name\u8fdb\u884c\u67e5\u8be2\uff0c\u67e5\u8be2\u51fa\u6765\u884c\u8bb0\u5f55\u8f83\u591a\u3002\u800c\u5f00\u542fICP\uff0c\u5728\u7d22\u5f15\u5185\u90e8\u5c31\u5224\u65ad\u4e86age\u662f\u4e0d\u662f\u7b49\u4e8e20\uff0c\u5339\u914d\u5230\u7684\u6b21\u6570\u5c31\u8f83\u5c11\u3002\u5b58\u50a8\u5f15\u64ce\u4f20\u9012\u7ed9mysql\u670d\u52a1\u5668\u7684\u6570\u636e\u5c31\u5c11\u4e86\u8bb8\u591a</p> <p>\u5728EXPLAIN\u6267\u884c\u8ba1\u5212\u7684 Extra \u5217\u4e2d\uff0c\u5982\u679c\u770b\u5230Using index condition\uff0c\u8868\u793a\u4f7f\u7528\u4e86\u7d22\u5f15\u4e0b\u63a8\u3002https://blog.csdn.net/sinat_29774479/article/details/103470244</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#mrr","title":"MRR","text":"<p>\u9664\u4e86ICP\uff0cMySQL\u8fd8\u6709\u54ea\u4e9b\u7d22\u5f15\u4f18\u5316\u6280\u672f\uff1f</p> <p>MRR\u5de5\u4f5c\u539f\u7406\uff1a \u4e8c\u7ea7\u7d22\u5f15\u67e5\u8be2\u5f97\u5230\u4e00\u6279\u4e3b\u952eID \u4e0d\u662f\u7acb\u5373\u56de\u8868\uff0c\u800c\u662f\u5148\u5c06\u4e3b\u952eID\u6392\u5e8f \u6309\u7167\u4e3b\u952e\u987a\u5e8f\u6279\u91cf\u56de\u8868\u67e5\u8be2</p> <p>\u4f18\u52bf\uff1a \u51cf\u5c11\u78c1\u76d8\u968f\u673aI/O\uff0c\u8f6c\u4e3a\u987a\u5e8fI/O \u5145\u5206\u5229\u7528\u78c1\u76d8\u9884\u8bfb\u80fd\u529b</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_4","title":"\u7d22\u5f15\u5408\u5e76","text":"<p>\u5728 MySQL 5.0 \u4e4b\u524d\uff0c\u4e00\u4e2a\u8868\u6700\u591a\u53ea\u80fd\u4f7f\u7528\u4e00\u4e2a\u7d22\u5f15\u3002\u4eceMySQL 5.1 \u5f00\u59cb\u5f15\u5165\u7d22\u5f15\u5408\u5e76\uff08index_merge\uff09\u6280\u672f\u4f18\u5316\uff0c\u5bf9\u540c\u4e00\u4e2a\u8868\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u7d22\u5f15\u5206\u522b\u8fdb\u884c\u6761\u4ef6\u626b\u63cf\uff0c\u7136\u540e\u5c06\u5404\u81ea\u7684\u7ed3\u679c\u8fdb\u884c\u5408\u5e76\uff08intersect/union\uff09\u3002</p> <pre><code>SELECT * FROM tbl_name WHERE key1 = 10 OR key2 = 20;\nSELECT * FROM tbl_name WHERE (key1 = 10 OR key2 = 20) AND non_key=30;\nSELECT * FROM t1, t2 WHERE (t1.key1 IN (1,2) OR t1.key2 LIKE 'value%') AND t2.key1=t1.some_col;\n</code></pre> <p>\u4e0b\u9762\u770b\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>index_merge\u4e4busing union:\n mysql&gt; explain \n select count(0)\n from lessons\n where stu_id=116401\n or sel_id=1113;\n\n| id | select_type | table   | type        | possible_keys                                                                          | key                               | key_len | ref  | rows | Extra                                                       |\n|  1 | SIMPLE      | lessons | index_merge | lessons_stu_id,idx_stuid_lessub,IDX_LES_TYPE_STU_ID,stu_id_pay_type,idx_lessons_sel_id | lessons_stu_id,idx_lessons_sel_id | 4,5     | NULL | 1467 | Using union(lessons_stu_id,idx_lessons_sel_id); Using where |\n+----+-------------+---------+-------------+----------------------------------------------------------------------------------------+-----------------------------------+---------+------+------+-------------------------------------------------------------+\n1 row in set (0.09 sec)\n\u67e5\u8be2\u4f7f\u7528 or \u8fde\u63a5\u591a\u4e2a\u6761\u4ef6\uff0c\u67e5\u8be2\u5206\u522b\u4f7f\u7528 stu_id \u548c sel_id \u5217\u7d22\u5f15\u8fdb\u884c\u626b\u63cf\uff0c\u5e76\u5c06\u626b\u63cf\u7ed3\u679c\u8fdb\u884c\u53d6\u5e76\u96c6(union)\n\nindex_merge\u4e4busing intersect:\nmysql&gt; explain \nselect count(0)\nfrom lessons\nwhere stu_id=116401\nand sel_id=1113;\n+----+-------------+---------+-------------+----------------------------------------------------------------------------------------+-----------------------------------+---------+------+------+------------------------------------------------------------------------------+\n| id | select_type | table   | type        | possible_keys                                                                          | key                               | key_len | ref  | rows | Extra                                                                        |\n+----+-------------+---------+-------------+----------------------------------------------------------------------------------------+-----------------------------------+---------+------+------+------------------------------------------------------------------------------+\n|  1 | SIMPLE      | lessons | index_merge | lessons_stu_id,idx_stuid_lessub,IDX_LES_TYPE_STU_ID,stu_id_pay_type,idx_lessons_sel_id | lessons_stu_id,idx_lessons_sel_id | 4,5     | NULL |    1 | Using intersect(lessons_stu_id,idx_lessons_sel_id); Using where; Using index |\n+----+-------------+---------+-------------+----------------------------------------------------------------------------------------+-----------------------------------+---------+------+------+------------------------------------------------------------------------------+\n1 row in set (0.07 sec)\n\u67e5\u8be2\u4f7f\u7528 and \u8fde\u63a5\u591a\u4e2a\u6761\u4ef6\uff0c\u67e5\u8be2\u5206\u522b\u4f7f\u7528 stu_id \u548c sel_id \u5217\u7d22\u5f15\u8fdb\u884c\u626b\u63cf\uff0c\u5e76\u5c06\u626b\u63cf\u7ed3\u679c\u8fdb\u884c\u53d6\u4ea4\u96c6(intersect)\n</code></pre> <p>\u4f46\u662f\u6ce8\u610f\uff0c\u5982\u679cwhere\u6761\u4ef6\u4e2d\u6709 &gt;, &lt;, &gt;=, &lt;=\u7b49\u6761\u4ef6\uff0c\u90a3\u4e48\u4f18\u5316\u5668\u4e0d\u4f1a\u4f7f\u7528 index merge\uff0c\u800c\u4e14\u8fd8\u4f1a\u5ffd\u7565\u5176\u4ed6\u7684\u7d22\u5f15\u3002</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_5","title":"\u7d22\u5f15\u957f\u5ea6","text":"<p>\u7d22\u5f15\u7684\u957f\u5ea6\u4e0d\u4ec5\u51b3\u5b9a\u4e86\u7d22\u5f15\u5360\u7528\u7684\u6570\u636e\u7a7a\u95f4\u5927\u5c0f\uff0c\u4e5f\u4f1a\u5f71\u54cd\u67e5\u627e\u6570\u636e\u7684 IO \u6b21\u6570\u3002\u5728\u540c\u7b49\u6570\u636e\u91cf\u4e0b\uff0c\u7d22\u5f15\u957f\u5ea6\u8fc7\u957f\u4f1a\u5bfc\u81f4\u5355\u4e2a\u6570\u636e\u9875\u5b58\u653e\u7684\u7d22\u5f15\u6761\u76ee\u6570\u51cf\u5c11\uff0c\u7d22\u5f15\u9ad8\u5ea6\u589e\u52a0\uff0c\u78c1\u76d8 IO \u67e5\u8be2\u6b21\u6570\u589e\u52a0\uff0c\u5e76\u4e14\u7d22\u5f15\u5360\u7528\u7a7a\u95f4\u589e\u5927\u3002\u6240\u4ee5\u5e94\u8be5\u5728\u6ee1\u8db3\u8981\u6c42\u7684\u524d\u63d0\u4e0b\uff0c\u5c3d\u91cf\u51cf\u5c11\u7d22\u5f15\u957f\u5ea6\u3002</p> <p>\u7d22\u5f15\u7684\u957f\u5ea6\u9650\u5236\u53ca\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u7d22\u5f15\u6700\u5927\u957f\u5ea6\u4e3a 767 \u5b57\u8282\uff0c\u82e5\u7d22\u5f15\u957f\u5ea6\u8d85\u8fc7 767 \u5b57\u8282\u5c06\u65e0\u6cd5\u521b\u5efa\uff08\u53ef\u8003\u8651\u521b\u5efa\u524d\u7f00\u7d22\u5f15\uff09</p> </li> <li> <p>\u7d22\u5f15\u957f\u5ea6\u4e0e\u5b57\u6bb5\u5b9a\u4e49\u957f\u5ea6\u57fa\u672c\u76f8\u540c\uff0c\u524d\u7f00\u7d22\u5f15\u957f\u5ea6\u4e0e\u5b9a\u4e49\u7684\u524d\u7f00\u957f\u5ea6\u6709\u5173</p> </li> <li> <p>\u53d8\u957f\u7c7b\u578b\u5982 varchar\uff0c\u989d\u5916\u9700\u8981 2 \u4e2a\u5b57\u8282\u5b58\u653e\u7d22\u5f15\u957f\u5ea6</p> </li> <li> <p>\u5982\u679c\u5b57\u6bb5\u53ef\u4ee5\u4e3a\u7a7a\uff0c\u989d\u5916\u9700\u8981 1 \u4e2a\u5b57\u8282\u5b58\u653e\u4e3a\u7a7a\u6807\u8bc6</p> </li> </ol> <p>\u7d22\u5f15\u957f\u5ea6 = \u5b57\u6bb5\u957f\u5ea6 + \u662f\u5426\u4e3a\u7a7a(+1) + \u662f\u5426\u53d8\u957f(+2)</p> <p>\u5982name \u5b57\u6bb5 varchar(10) \u53ef\u4ee5\u4e3a\u7a7a\uff0c\u5b57\u7b26\u96c6\u4e3a utf8mb4 \uff0c\u5219\u7d22\u5f15\u957f\u5ea6\u4e3a\uff1a 10*4B+1B+2B=43B</p> <p>\u800c a2 \u5b57\u6bb5 int \u53ef\u4ee5\u4e3a\u7a7a\uff0c\u7d22\u5f15\u957f\u5ea6\u4e3a\uff1a4B+1B=5B</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_6","title":"\u7d22\u5f15\u9875\u80fd\u5b58\u50a8\u7684\u6761\u76ee\u6570\u91cf","text":"<p>\u6211\u4eec\u77e5\u9053\uff0cMySQL\u6570\u636e\u5e93page \u5927\u5c0f\u9ed8\u8ba4\u4e3a 16k \uff0c\u5373\u4e00\u6b21 IO \u9884\u8bfb 16k \u7684\u6570\u636e\u5230\u6570\u636e\u5e93\u7684 buffer pool \u4e2d\u3002\u6bcf\u4e2a\u7d22\u5f15\u9664\u4e86\u7d22\u5f15\u957f\u5ea6\u5916\uff0c\u8fd8\u4f1a\u75284B\u5b58\u50a8\u9875\u53f7\uff0c6B\u5b58\u50a8\u5176\u4ed6\u6570\u636e\u3002</p> <p>\u5047\u8bbe\u8868\u5e73\u5747\u884c\u957f\u5ea6\u4e3a300B\uff0c\u4e3b\u952e\u7d22\u5f15\u5217 ID \u4e3a int \u7c7b\u578b\uff0c\u666e\u901a\u7d22\u5f15\u5217 name \u4e3a varchar(20) \u7c7b\u578b\u975e\u7a7a (utf8mb4)\uff0c\u666e\u901a\u7d22\u5f15\u5217 info \u4e3a varchar(150) \u7c7b\u578b\u53ef\u4ee5\u4e3a\u7a7a (utf8mb4)</p> <ul> <li>\u4e3b\u952e\u7d22\u5f15</li> </ul> <p>\u6bcf\u4e2a\u975e\u53f6\u5b50\u8282\u70b9\u53ef\u5b58\u653e key \u4e2a\u6570\u4e3a <code>M1=16KB/(4B+4B+6B)\u22481170</code>   \u6bcf\u4e2a\u53f6\u5b50\u8282\u70b9\u53ef\u5b58\u653e key \u4e2a\u6570\u4e3a <code>M2=16KB/(300B+4B+6B) \u224852</code>   \u5219 3 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L=1170*1170*52 \u22487118W</code>\uff0c4 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L=1170*1170*1170*52 \u2248832\u4ebf</code></p> <ul> <li>\u4e8c\u7ea7\u7d22\u5f15name \u7d22\u5f15\u5b57\u6bb5\u672c\u8eab\u957f\u5ea6\u4e3a<code>20*4B+2B</code></li> </ul> <p>\u6bcf\u4e2a\u975e\u53f6\u5b50\u8282\u70b9\u53ef\u5b58\u653e key \u4e2a\u6570\u4e3a <code>M1=16KB/(20*4B+2B+4B+6B)\u2248178</code>   \u6bcf\u4e2a\u53f6\u5b50\u8282\u70b9\u53ef\u5b58\u653e key \u4e2a\u6570\u4e3a <code>M2=16KB/(4B+20*4B+2B+4B+6B) \u2248170</code>   \u5219 3 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L= 178*178*170 \u2248538W</code>\uff0c 4 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L= 178*178*178*170 \u22489.58\u4ebf</code> </p> <ul> <li>\u4e8c\u7ea7\u7d22\u5f15info \uff08varchar(150)\uff09\uff0c\u53ef\u4e3a\u7a7a\uff0c \u7d22\u5f15\u5b57\u6bb5\u672c\u8eab\u957f\u5ea6\u4e3a<code>150*4B+2B+1B</code></li> </ul> <p>\u6bcf\u4e2a\u975e\u53f6\u5b50\u8282\u70b9\u53ef\u5b58\u653e key \u4e2a\u6570\u4e3a <code>M1=16KB/(150*4B+2B+1B+4B+6B)\u224826</code>   \u6bcf\u4e2a\u53f6\u5b50\u8282\u70b9\u53ef\u5b58\u653e key \u4e2a\u6570\u4e3a <code>M2=16KB/(150*4B+2B+1B+4B+6B+4B) \u224826</code>   \u5219 3 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L= 26*26*26 \u224817576</code>   4 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L= 26*26*26*26 \u2248456976</code>   5 \u5c42\u7d22\u5f15\u6700\u7ec8\u80fd\u5b58\u653e\u6700\u5927\u6761\u76ee\u6570\u4e3a\uff1a<code>L= 26*26*26*26*26 \u22481188W</code></p> <p>\u53ef\u4ee5\u53d1\u73b0\u5f53\u7d22\u5f15\u957f\u5ea6\u589e\u52a0\u65f6\uff0c\u4f1a\u5bfc\u81f4\u6bcf\u4e2a page \u9875\u5b58\u653e\u7684\u7d22\u5f15\u6570\u51cf\u5c11\uff0c\u7d22\u5f15\u9ad8\u5ea6\u589e\u52a0\u3002</p> <p>\u7279\u522b\u662f char/varchar \u7c7b\u578b\uff0c\u7d22\u5f15\u957f\u5ea6\u4f1a\u56e0\u4e3a utf8mb4 \u5b57\u7b26\u96c6\u539f\u56e0\u5bfc\u81f4\u7d22\u5f15\u957f\u5ea6\u6025\u5267\u589e\u957f\uff0c\u56e0\u6b64\u9700\u8981\u4e25\u683c\u63a7\u5236\u5b57\u6bb5\u548c\u7d22\u5f15\u957f\u5ea6\u3002</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_7","title":"\u7d22\u5f15\u8bbe\u8ba1\u539f\u5219","text":"<ul> <li> <p>\u7d22\u5f15\u5e76\u4e0d\u662f\u8d8a\u591a\u8d8a\u597d\uff0c\u56e0\u4e3a\u4ed6\u4f1a\u5360\u7528\u5927\u91cf\u7684\u78c1\u76d8\uff0c\u8fd8\u4f1a\u964d\u4f4e\u6570\u636e\u8868\u7684 DML \u901f\u5ea6\uff0c\u56e0\u4e3a\u6570\u636e\u589e\u5220\u6539\u90fd\u4f1a\u989d\u5916\u7ef4\u62a4\u7d22\u5f15\u4fe1\u606f</p> </li> <li> <p>\u5408\u7406\u4f7f\u7528\u8054\u5408\u7d22\u5f15\u548c\u8986\u76d6\u7d22\u5f15\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8\u67e5\u8be2\u901f\u5ea6</p> </li> <li> <p>\u4e0d\u8981\u5728\u7ecf\u5e38\u66f4\u65b0\uff0c\u533a\u5206\u5ea6\u4e0d\u9ad8\uff0c\u5b57\u6bb5\u592a\u957f\u7684\u5b57\u6bb5\u4e0a\u6dfb\u52a0\u7d22\u5f15\uff1b\u8981\u5728\u7ecf\u5e38\u67e5\u8be2\u3001\u6392\u5e8f\u7684\u5217\u4e0a\u5efa\u7acb\u7d22\u5f15\u3002\u5b57\u6bb5\u8fc7\u957f\u53ef\u4ee5\u8003\u8651\u5efa\u7acb\u524d\u7f00\u7d22\u5f15\u3002</p> </li> <li> <p>\u91cd\u590d\u7d22\u5f15\u53ef\u4ee5\u5220\u9664\u3002\u4e0d\u5408\u7406\u7684\u7d22\u5f15\u4e5f\u53ef\u80fd\u5bfc\u81f4\u4f18\u5316\u5668\u9519\u8bef\u5224\u65ad\uff0c\u6709\u65f6\u53cd\u800c\u9009\u62e9\u6027\u80fd\u4f4e\u7684\u7d22\u5f15</p> </li> </ul> <p>\u5982\u7d22\u5f15 index(A) \u548c index(A,B) \u662f\u91cd\u590d\u7684\uff0c\u91cd\u590d\u7684\u7d22\u5f15\u9700\u8981\u66f4\u591a\u7684\u5b58\u50a8\u7a7a\u95f4\u548c\u7ef4\u62a4\u4ee3\u4ef7\uff0c\u53ef\u8003\u8651\u5220\u9664 index(A)\u3002</p> <p>\u5982\u4f55\u7ed9\u5b57\u7b26\u4e32\u5b57\u6bb5\u5efa\u7acb\u7d22\u5f15</p>"},{"location":"database/04-%E7%B4%A2%E5%BC%95/#_8","title":"\u7d22\u5f15\u5931\u6548\u7684\u60c5\u51b5\uff08\u6709\u5751\uff01\uff01\uff09","text":"<ul> <li>\u4f18\u5316\u5668\u8ba4\u4e3a\u5168\u8868\u626b\u63cf\u66f4\u9ad8\u6548\u65f6\uff0c\u4f1a\u4e0d\u8d70\u7d22\u5f15\u3002</li> </ul> <p>\u5982\u5f53\u65f6\u4e00\u4e2a\u540d\u7247\u7533\u8bf7\u5217\u8868\u7684\u8868\uff0ctime\u5217\u5efa\u7acb\u7d22\u5f15\uff0c\u6839\u636etime\u6761\u4ef6\u8303\u56f4\u67e5\u8be2\u6700\u8fd1\u51e0\u4e2a\u6708\u7684\u6570\u636e\uff0cMySQL\u4f18\u5316\u5668\u53cd\u800c\u4e0d\u8d70\u7d22\u5f15\uff0c\u76f4\u63a5\u5168\u8868\u626b\u63cf\u3002\u67e5\u8be2\u4e00\u5e74\u524d\u7684\u6570\u636e\u6216\u8005\u65f6\u95f4\u8303\u56f4\u8db3\u591f\u5927\u65f6\uff0c\u624d\u8d70time\u7684\u7d22\u5f15\u3002</p> <ul> <li> <p>\u5728\u7d22\u5f15\u4e0a\u505a\u4efb\u4f55\u64cd\u4f5c\uff08\u8ba1\u7b97\u3001\u51fd\u6570\u3001\u663e\u5f0f\u6216\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362\uff09\u4f1a\u5bfc\u81f4\u7d22\u5f15\u5931\u6548</p> </li> <li> <p><code>!= is null\uff0cis not null</code>\u6839\u636e\u5217\u4e2dnull\u503c\u7684\u591a\u5c11\u6709\u4e0d\u540c\u7684\u60c5\u51b5\u3002\u5982\u679c\u7d22\u5f15\u5217\u7684null\u503c\u5360\u591a\u6570\uff0cis not null \u548c!=\u8d70\u7d22\u5f15 ,is null\u4e0d\u8d70\u7d22\u5f15\u4e86\uff1b\u5982\u679cnull\u503c\u5f88\u5c11\u65f6\uff0cis null\u5c31\u8d70\u7d22\u5f15\uff0cis not null \u548c!=\u4e0d\u8d70\u7d22\u5f15\u3002</p> </li> </ul> <p>\u539f\u56e0\uff1a\u8d70\u4e0d\u8d70\u7d22\u5f15\uff0c\u662f\u770bmysql\u600e\u4e48\u4f30\u7b97\u6210\u672c\u7684\uff0c\u4e8c\u7ea7\u7d22\u5f15\u7684\u6210\u672c\u4e3b\u8981\u662f\u4e8c\u7ea7\u7d22\u5f15\u672c\u8eab\u7684\u8bfb\u53d6\u6210\u672c\uff0c\u548c\u56de\u8868\u7684\u6210\u672c\u3002\u5982\u5f53null\u503c\u5f88\u591a\u65f6\uff0cis not null \u548c!= \u9700\u8981\u56de\u8868\u7684\u884c\u6570\u5c31\u6bd4\u8f83\u5c11\uff0c\u6240\u4ee5\u8d70\u7d22\u5f15\uff0c\u4f46\u662fis null\u9700\u8981\u56de\u8868\u67e5\u5f88\u591a\u8bb0\u5f55\u90a3\u8fd8\u4e0d\u5982\u76f4\u63a5\u53d6\u4e3b\u952e\u7d22\u5f15\u626b\u63cf\u5168\u8868\u3002</p> <p>null\u503c\u662f\u5b58\u5728\u5bf9\u5e94\u7d22\u5f15\u7684B+\u6811\u7684\u6700\u5de6\u8fb9\u7684\u3002https://www.cnblogs.com/niuben/p/11197945.html</p> <ul> <li>like '%abc' '%abc%'\u4e00\u5b9a\u4e0d\u8d70\u7d22\u5f15\u5417\uff1f</li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u6a21\u7cca\u67e5\u8be2\uff0c\u524d\u7f6e\u767e\u5206\u53f7%abc\u4e0d\u8d70\u7d22\u5f15\uff1b\u540e\u7f6e\u767e\u5206\u53f7abc%\u624d\u4f1a\u8d70\u7d22\u5f15\u3002</p> <p>\u4f46\u662f\u8981\u6ce8\u610f\u4e00\u79cd\u60c5\u51b5\uff0c\u5982\u679c\u8be5\u67e5\u8be2SQL\u5c5e\u4e8e\u8986\u76d6\u7d22\u5f15\uff0c\u4e5f\u5c31\u662fselect\u7684\u5b57\u6bb5\u53ea\u5305\u542b\u7d22\u5f15\u5b57\u6bb5\u7684\u8bdd\uff0c\u4e5f\u662f\u8d70\u7d22\u5f15\u7684\u3002</p> <p>https://www.cnblogs.com/bigsaltfish/p/10067179.html</p> <p>\u53ef\u4ee5\u8fd9\u6837\u7406\u89e3\uff1a\u6a21\u7cca\u67e5\u8be2%abc\u65f6\uff0cB+\u6811\u662f\u4ece\u5de6\u5230\u53f3\u6765\u6bd4\u8f83\u5b57\u6bb5\u662f\u5426\u76f8\u7b49\u7684\uff0c\u800c%abc\u6b64\u65f6\u524d\u9762\u7684\u5185\u5bb9\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u6240\u4ee5\u5c31\u8981\u626b\u63cf\u5168\u90e8\u7d22\u5f15\uff08\u4e14sleet * \u540e\u7eed\u8981\u7ee7\u7eed\u56de\u67e5\u4e3b\u8868\uff09\uff0c\u90a3\u8fd8\u4e0d\u5982\u76f4\u63a5\u626b\u63cf\u5168\u8868\u3002\u4f46\u662f\u5982\u679cselect \u91cc\u53ea\u67e5\u8be2\u7d22\u5f15\u5b57\u6bb5\u6216\u8005\u4e3b\u952e\u7684\u8bdd\uff0c\u90a3\u626b\u63cf\u6574\u4e2a\u7d22\u5f15\u5c31\u884c\uff0c\u4e0d\u9700\u8981\u56de\u67e5\u4e3b\u8868\uff0c\u6240\u4ee5\u7ed3\u679c\u5c31\u8d70\u4e86\u7d22\u5f15\uff01</p> <ul> <li>or \u4e00\u5b9a\u4e0d\u8d70\u7d22\u5f15\u5417\uff1f\u4e00\u6b21\u67e5\u8be2\u53ea\u80fd\u4f7f\u7528\u4e00\u4e2a\u7d22\u5f15\u5417\uff1f</li> </ul> <p>\u67d0\u4e9b\u6761\u4ef6\u65f6\uff0c\u5982\u4e0a\u9762\u7684\u7d22\u5f15\u5408\u5e76\uff0c\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u4e24\u4e2a\u7d22\u5f15\uff0c\u7136\u540e\u5bf9\u7ed3\u679c\u53d6\u4ea4\u96c6\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/","title":"\u65e5\u5fd7\u7cfb\u7edf","text":""},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#binlogredolog","title":"binlog\u548credolog\u662f\u4ec0\u4e48\uff1f","text":"<ul> <li>binlog\u65e5\u5fd7\u662fmySQL server\u5c42\u7684\u903b\u8f91\u65e5\u5fd7\uff0c\u4e8c\u8fdb\u5236\u683c\u5f0f\uff0c\u8bb0\u5f55\u7684\u6570\u636e\u53d8\u66f4\uff0c\u5373\u6267\u884c\u8fc7\u7684SQL\u8bed\u53e5\uff0c\u6838\u5fc3\u529f\u80fd\u662f\u7528\u4e8e\u4e3b\u4ece\u590d\u5236\u548c\u6570\u636e\u5f52\u6863\u3001\u6062\u590d\u3002 \u6240\u6709\u5f15\u64ce\u90fd\u53ef\u4ee5\u4f7f\u7528\uff0c\u4f46\u6ca1\u6709\u5d29\u6e83\u6062\u590d\u7684\u80fd\u529b\u3002\u53ef\u4ee5\u4e0d\u65ad\u8ffd\u52a0\u3002</li> <li>redolog\u662fInnoDB\u5b58\u50a8\u5f15\u64ce\u5c42\u7279\u6709\u7684\u7269\u7406\u65e5\u5fd7\uff0c\u53ea\u8bb0\u5f55\u54ea\u4e9b\u6570\u636e\u9875\u505a\u4e86\u54ea\u4e9b\u4fee\u6539\uff0c\u5373\u5237\u76d8\u524d\u7684\u8bb0\u5f55\uff0c\u6838\u5fc3\u529f\u80fd\u662f\u4fdd\u969c\u4e8b\u52a1\u6301\u4e45\u6027\u548c\u5d29\u6e83\u6062\u590d\u3002 \u7a7a\u95f4\u6709\u9650\uff0c\u5faa\u73af\u5199\u5165\uff0c\u5199\u6ee1\u4e86\u9700\u8981\u5237\u76d8\u3002innodb_flush_log_at_trx_commit\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u62101\u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684redo log\u90fd\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002</li> </ul> <p>\u6b63\u662f\u8fd9\u79cd\u201c\u5b58\u50a8\u5f15\u64ce\u5c42\u201d\u4e0e\u201cServer\u5c42\u201d\u7684\u5206\u79bb\uff0c\u624d\u9700\u8981\u8457\u540d\u7684\u4e24\u9636\u6bb5\u63d0\u4ea4\u6765\u4fdd\u8bc1 redo log \u548c binlog \u7684\u4e00\u81f4\u6027\u3002 \u800cPostgreSQL\u5219\u662f\u91c7\u7528\u7edf\u4e00\u7684WAL\uff08Write-Ahead Logging\uff0c\u5148\u5199\u65e5\u5fd7\uff0c\u518d\u53d8\u66f4\uff09\u9884\u5199\u5f0f\u65e5\u5fd7\uff0c\u7edf\u4e00\u67b6\u6784\uff0c\u6574\u5408mySQL\u4e2d\u7684binlog\u548credolog\u65e5\u5fd7\uff0cmySQL\u4e5f\u5728\u501f\u9274\u8fd9\u4e00\u601d\u60f3\u201c\u6240\u6709\u65e5\u5fd7\u90fd\u5177\u6709\u5f3a\u4e00\u81f4\u6027\u201d\uff0c\u9010\u6b65\u5438\u6536\uff0c\u5373\u5c06binlog\u548credolog\u65e5\u5fd7\u8054\u7cfb\u66f4\u52a0\u7d27\u5bc6\uff0c\u4e0d\u7528\u4f9d\u8d56\u4e24\u9636\u6bb5\u5f0f\u4fdd\u8bc1\u65e5\u5fd7\u4e00\u81f4\uff01</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#2pc","title":"2PC\u662f\u5982\u4f55\u4fdd\u8bc1\u4e24\u4e2a\u65e5\u5fd7\u6700\u7ec8\u4e00\u81f4\u7684\uff1f","text":"<p>\u95ee\u9898\u672c\u8d28\uff1a\u4e00\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u65f6\uff0c\u9700\u8981\u505a\u4e24\u4ef6\u4e8b\uff1a 1.\u8ba9 InnoDB \u5f15\u64ce\u628a\u4e8b\u52a1\u7684\u4fee\u6539\u6301\u4e45\u5316\uff08\u901a\u8fc7 redo log\uff09\u3002 2.\u8ba9 Server \u5c42\u628a\u4e8b\u52a1\u7684\u65e5\u5fd7\u8bb0\u5f55\u5230 binlog \u4e2d\uff0c\u4ee5\u4fbf\u590d\u5236\u3002 \u6211\u4eec\u5fc5\u987b\u4fdd\u8bc1\u8fd9\u4e24\u4ef6\u4e8b\u662f\u539f\u5b50\u6027\u7684\uff1a\u8981\u4e48\u90fd\u5b8c\u6210\uff0c\u8981\u4e48\u90fd\u4e0d\u5b8c\u6210\u3002 2PC\u7684\u7cbe\u9ad3\u5728\u4e8e\uff0c\u5b83\u628a\u4e00\u4e2a\u4e0d\u53ef\u5206\u5272\u7684\u201c\u63d0\u4ea4\u201d\u52a8\u4f5c\uff0c\u62c6\u89e3\u6210\u4e00\u4e2a \u201c\u51c6\u5907\u201d \u548c\u4e00\u4e2a \u201c\u63d0\u4ea4\u201d \u9636\u6bb5\u3002 1. \u51c6\u5907\u9636\u6bb5\uff1a \u4e00\u4e2a\u4e8b\u52a1\u5f00\u59cb\u540e\uff0c\u9996\u5148redolog\u5237\u76d8\u6301\u4e45\u5316\u5230\u78c1\u76d8\u4e0a\uff0c\u4f46\u6b64\u65f6\u662fprepare\u72b6\u6001\uff01 2. \u63d0\u4ea4\u9636\u6bb5\uff1a\u524d\u4e00\u6b65\u6210\u529f\u540e\uff0cbinlog\u5237\u76d8\u6301\u4e45\u5316\u5230\u78c1\u76d8\u4e0a\u3002  3. \u7136\u540e\u901a\u77e5redolog\u66f4\u65b0\u72b6\u6001\u4e3acommit\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u53ef\u80fd\u88ab\u4f18\u5316\uff0c\u4e0d\u4f1a\u7acb\u5373\u6267\u884c\uff0c\u800c\u662f\u4e00\u8d77\u6267\u884c\u3002 </p> <p>\u7136\u540e\u6211\u4eec\u770b\u770b\u5982\u679c\u6570\u636e\u5e93\u5d29\u6e83\u540e\uff0c\u662f\u5982\u4f55\u4fdd\u8bc1\u6570\u636e\u4e00\u81f4\u7684\u3002 \u6062\u590d\u6d41\u7a0b\u4f1a\u626b\u63cfredolog\u548cbinlog\uff1a 1. \u5982\u679credolog\u4e2d\u4e8b\u52a1\u72b6\u6001\u4e3aprepare\uff0c\u5219\u53bb\u67e5\u770bbinlog\uff0c\u5982\u679cbinlog\u5df2\u63d0\u4ea4\uff0c\u8bf4\u660e\u662f\u5728\u7b2c\u4e09\u6b65\u524d\u5d29\u6e83\u4e86\uff0c\u5219\u91cd\u65b0\u63d0\u4ea4\u8fd9\u4e2a\u4e8b\u52a1\u3002\u5982\u679cbinlog\u4e0d\u5b58\u5728\uff0c\u8bf4\u660e\u5728\u7b2c\u4e8c\u6b65\u524d\u5931\u8d25\u4e86\uff0c\u5219\u56de\u6eda\u8fd9\u4e2a\u4e8b\u52a1\u3002  2. \u5982\u679credolog\u4e2d\u4e8b\u52a1\u72b6\u6001\u4e3acommit\uff0c\u5219\u8bf4\u660e\u5d29\u6e83\u53d1\u751f\u5728\u7b2c\u4e09\u6b65\u540e\uff0c\u4e8b\u52a1\u5df2\u7ecf\u6b63\u5e38\u63d0\u4ea4\uff0c\u6b63\u5e38\u91cd\u505a\u5373\u53ef\u3002  3. \u5982\u679credolog\u4e2d\u6839\u672c\u6ca1\u6709\u8fd9\u4e2a\u4e8b\u52a1\uff0c\u8bf4\u660e\u5728\u7b2c\u4e00\u6b65\u524d\u5c31\u5d29\u6e83\u4e86\uff0c\u5219\u56de\u6eda\u4e8b\u52a1\u3002 \u901a\u8fc7\u8fd9\u5957\u4e25\u5bc6\u7684\u903b\u8f91\uff0c\u65e0\u8bba\u5728\u54ea\u4e2a\u9636\u6bb5\u5d29\u6e83\uff0c\u6062\u590d\u540e\u90fd\u80fd\u4fdd\u8bc1 binlog \u548c redo log \u7684\u6700\u7ec8\u4e00\u81f4\u6027\uff1a\u4e00\u4e2a\u4e8b\u52a1\u8981\u4e48\u540c\u65f6\u5b58\u5728\u4e8e\u4e24\u4e2a\u65e5\u5fd7\u4e2d\uff0c\u8981\u4e48\u540c\u65f6\u4e0d\u5b58\u5728\u4e8e\u4e24\u4e2a\u65e5\u5fd7\u4e2d\u3002</p> <p>Redo Log\u4e0eBinlog\u7684\u534f\u540c \u4e24\u9636\u6bb5\u63d0\u4ea4\u6d41\u7a0b\uff1a Prepare\u9636\u6bb5\uff1a\u5199\u5165redo log\uff0c\u72b6\u6001\u4e3aprepare Commit\u9636\u6bb5\uff1a\u5199\u5165binlog \u6700\u7ec8\u63d0\u4ea4\uff1aredo log\u72b6\u6001\u6539\u4e3acommit</p> <p>\u5d29\u6e83\u6062\u590d\uff1a redo log prepare + binlog\u5b8c\u6574 \u2192 \u63d0\u4ea4\u4e8b\u52a1 redo log prepare + binlog\u4e0d\u5b8c\u6574 \u2192 \u56de\u6eda\u4e8b\u52a1</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#binlogredolog_1","title":"\u65e5\u5fd7\u7cfb\u7edf binlog\u548credolog","text":"<p>MySQL \u4fdd\u8bc1\u6570\u636e\u4e0d\u4f1a\u4e22\u7684\u80fd\u529b\u4e3b\u8981\u4f53\u73b0\u5728\u4e24\u65b9\u9762\uff1a</p> <ul> <li>\u80fd\u591f\u6062\u590d\u5230\u4efb\u4f55\u65f6\u95f4\u70b9\u7684\u72b6\u6001\uff1b</li> </ul> <p>\u5bf9\u4e8e\u7b2c\u4e00\u70b9\u4f60\u53ef\u80fd\u7ecf\u5e38\u542cDBA\u540c\u4e8b\u8bf4\uff0cMySQL\u53ef\u4ee5\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u4efb\u610f\u4e00\u79d2\u7684\u72b6\u6001\uff0c\u60ca\u53f9\u7684\u540c\u65f6\uff0c\u4f60\u662f\u4e0d\u662f\u5fc3\u4e2d\u4e5f\u4f1a\u4e0d\u514d\u4f1a\u597d\u5947\uff0c\u8fd9\u662f\u600e\u6837\u505a\u5230\u7684\u5462\uff1f\u5c06MySQL\u6062\u590d\u5230\u4efb\u4f55\u65f6\u95f4\u70b9\u7684\u72b6\u6001\uff0c\u53ea\u8981\u4fdd\u7559\u6709\u8db3\u591f\u7684binlog\uff0c\u5c31\u80fd\u901a\u8fc7\u91cd\u8dd1binlog\u6765\u5b9e\u73b0\u3002</p> <ul> <li>\u80fd\u591f\u4fdd\u8bc1MySQL\u5728\u4efb\u4f55\u65f6\u95f4\u6bb5\u7a81\u7136\u5d29\u6e83\uff0c\u91cd\u542f\u540e\u4e4b\u524d\u63d0\u4ea4\u7684\u8bb0\u5f55\u90fd\u4e0d\u4f1a\u4e22\u5931\uff1b</li> </ul> <p>\u5bf9\u4e8e\u7b2c\u4e8c\u70b9\u7684\u80fd\u529b\uff0c\u4e5f\u5c31\u662f\u6240\u8bb2\u7684crash-safe\u3002\u5373\u5728 InnoDB \u5b58\u50a8\u5f15\u64ce\u4e2d\uff0c\u4e8b\u52a1\u63d0\u4ea4\u8fc7\u7a0b\u4e2d\u4efb\u4f55\u9636\u6bb5\uff0cMySQL\u7a81\u7136\u5d29\u6e83\uff0c\u91cd\u542f\u540e\u90fd\u80fd\u4fdd\u8bc1\u4e8b\u52a1\u7684\u5b8c\u6574\u6027\uff0c\u5df2\u63d0\u4ea4\u7684\u6570\u636e\u4e0d\u4f1a\u4e22\u5931\uff0c\u672a\u63d0\u4ea4\u5b8c\u6574\u7684\u6570\u636e\u4f1a\u81ea\u52a8\u8fdb\u884c\u56de\u6eda\u3002\u8fd9\u4e2a\u80fd\u529b\u4f9d\u8d56\u7684\u5c31\u662fredo log\u548cunod log\u4e24\u4e2a\u65e5\u5fd7\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#binlog","title":"binlog\u7684\u4e09\u79cd\u683c\u5f0f","text":"<p>statement\uff1a\u76f4\u63a5\u5c31\u662f\u539f\u59cb\u7684SQL\u8bed\u53e5\u3002\u4f46\u53ef\u80fd\u4e3b\u5e93\u5224\u65ad\u4f7f\u7528\u7d22\u5f15a\uff0c\u4ece\u5e93\u5224\u65ad\u4f7f\u7528\u7d22\u5f15b\uff0c\u5bfc\u81f4SQL\u7ed3\u679c\u4e0d\u4e00\u81f4\u3002 rows\uff1a\u5b58\u50a8\u7684\u662frow\u683c\u5f0f\uff0c\u76f4\u63a5\u8bb0\u5f55\u5b9e\u9645\u66f4\u65b0\u7684\u4e3b\u952e\u3002\u8fd9\u6837\u5c31\u4e0d\u4f1a\u5bfc\u81f4\u4e3b\u5907\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u3002\u4f46\u662frow\u683c\u5f0f\u5360\u7528\u7a7a\u95f4\u5927\uff0c\u5220\u9664\u4e8610\u4e07\u884c\u7684\u6570\u636e\uff0crow\u5c31\u9700\u8981\u628a\u8fd910\u4e07\u6761\u8bb0\u5f55\u90fd\u5199\u5230binlog\u4e2d\u3002 mixed\uff1amySQL\u4f1a\u81ea\u5df1\u5224\u65ad\uff0c\u5982\u679cSQL\u8bed\u53e5\u53ef\u80fd\u5f15\u8d77\u4e3b\u5907\u4e0d\u4e00\u81f4\u5c31\u4f7f\u7528row\uff0c\u5426\u5219\u5c31\u7528statement\u683c\u5f0f\u3002 \u73b0\u5728\u8d8a\u6765\u8d8a\u591a\u7684\u573a\u666f\u8981\u6c42\u4f7f\u7528row\u683c\u5f0f\uff0c\u597d\u5904\u5c31\u662f\u6062\u590d\u6570\u636e\u975e\u5e38\u5feb\u3002\u5982\u679c\u662fdelete\u8bed\u53e5\uff0c\u6062\u590d\u76f4\u63a5\u6539\u6210insert\u5373\u53ef\uff1b\u5982\u679c\u662finsert\u8bed\u53e5\uff0c\u6062\u590d\u65f6\u76f4\u63a5\u6539\u6210delete\u8bed\u53e5\uff1b\u5982\u679c\u662fupdate\u8bed\u53e5\uff0c\u5219\u628a\u524d\u540e\u7684\u8bed\u53e5\u5bf9\u8c03\u4e00\u4e0b\u5c31\u884c\u3002\u800c\u5b83\u7684\u7f3a\u70b9\u5360\u7528\u7a7a\u95f4\u5176\u5b9e\u4e0d\u503c\u94b1\u3002 \u7528binlog\u6765\u6062\u590d\u6570\u636e\u7684\u6807\u51c6\u505a\u6cd5\u662f\uff0c\u7528 mysqlbinlog\u5de5\u5177\u89e3\u6790\u51fa\u6765\uff0c\u7136\u540e\u628a\u89e3\u6790\u7ed3\u679c\u6574\u4e2a\u53d1\u7ed9MySQL\u6267\u884c</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#redo-log","title":"\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1aredo log","text":"<p>\u4e0d\u77e5\u9053\u4f60\u8fd8\u8bb0\u4e0d\u8bb0\u5f97\u300a\u5b54\u4e59\u5df1\u300b\u8fd9\u7bc7\u6587\u7ae0\uff0c\u9152\u5e97\u638c\u67dc\u6709\u4e00\u4e2a\u7c89\u677f\uff0c\u4e13\u95e8\u7528\u6765\u8bb0\u5f55\u5ba2\u4eba\u7684\u8d4a\u8d26\u8bb0\u5f55\u3002\u5982\u679c\u8d4a\u8d26\u7684\u4eba\u4e0d\u591a\uff0c\u90a3\u4e48\u4ed6\u53ef\u4ee5\u628a\u987e\u5ba2\u540d\u548c\u8d26\u76ee\u5199\u5728\u677f\u4e0a\u3002\u4f46\u5982\u679c\u8d4a\u8d26\u7684\u4eba\u591a\u4e86\uff0c\u7c89\u677f\u603b\u4f1a\u6709\u8bb0\u4e0d\u4e0b\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u638c\u67dc\u4e00\u5b9a\u8fd8\u6709\u4e00\u4e2a\u4e13\u95e8\u8bb0\u5f55\u8d4a\u8d26\u7684\u8d26\u672c\u3002</p> <p>\u5982\u679c\u6709\u4eba\u8981\u8d4a\u8d26\u6216\u8005\u8fd8\u8d26\u7684\u8bdd\uff0c\u638c\u67dc\u4e00\u822c\u6709\u4e24\u79cd\u505a\u6cd5\uff1a</p> <p>\u200b   \u2022   \u4e00\u79cd\u505a\u6cd5\u662f\u76f4\u63a5\u628a\u8d26\u672c\u7ffb\u51fa\u6765\uff0c\u628a\u8fd9\u6b21\u8d4a\u7684\u8d26\u52a0\u4e0a\u53bb\u6216\u8005\u6263\u9664\u6389\uff1b</p> <p>\u200b   \u2022   \u53e6\u4e00\u79cd\u505a\u6cd5\u662f\u5148\u5728\u7c89\u677f\u4e0a\u8bb0\u4e0b\u8fd9\u6b21\u7684\u8d26\uff0c\u7b49\u6253\u70ca\u4ee5\u540e\u518d\u628a\u8d26\u672c\u7ffb\u51fa\u6765\u6838\u7b97\u3002</p> <p>\u5728\u751f\u610f\u7ea2\u706b\u67dc\u53f0\u5f88\u5fd9\u65f6\uff0c\u638c\u67dc\u4e00\u5b9a\u4f1a\u9009\u62e9\u540e\u8005\uff0c\u56e0\u4e3a\u524d\u8005\u64cd\u4f5c\u5b9e\u5728\u662f\u592a\u9ebb\u70e6\u4e86\u3002\u9996\u5148\uff0c\u4f60\u5f97\u627e\u5230\u8fd9\u4e2a\u4eba\u7684\u8d4a\u8d26\u603b\u989d\u90a3\u6761\u8bb0\u5f55\u3002\u4f60\u60f3\u60f3\uff0c\u5bc6\u5bc6\u9ebb\u9ebb\u51e0\u5341\u9875\uff0c\u638c\u67dc\u8981\u627e\u5230\u90a3\u4e2a\u540d\u5b57\uff0c\u53ef\u80fd\u8fd8\u5f97\u5e26\u4e0a\u8001\u82b1\u955c\u6162\u6162\u627e\uff0c\u627e\u5230\u4e4b\u540e\u518d\u62ff\u51fa\u7b97\u76d8\u8ba1\u7b97\uff0c\u6700\u540e\u518d\u5c06\u7ed3\u679c\u5199\u56de\u5230\u8d26\u672c\u4e0a\u3002</p> <p>\u8fd9\u6574\u4e2a\u8fc7\u7a0b\u60f3\u60f3\u90fd\u9ebb\u70e6\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u8fd8\u662f\u5148\u5728\u7c89\u677f\u4e0a\u8bb0\u4e00\u4e0b\u65b9\u4fbf\u3002\u4f60\u60f3\u60f3\uff0c\u5982\u679c\u638c\u67dc\u6ca1\u6709\u7c89\u677f\u7684\u5e2e\u52a9\uff0c\u6bcf\u6b21\u8bb0\u8d26\u90fd\u5f97\u7ffb\u8d26\u672c\uff0c\u6548\u7387\u662f\u4e0d\u662f\u4f4e\u5f97\u8ba9\u4eba\u96be\u4ee5\u5fcd\u53d7\uff1f</p> <p>\u540c\u6837\uff0c\u5728MySQL\u91cc\u4e5f\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u6bcf\u4e00\u6b21\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u9700\u8981\u5199\u8fdb\u78c1\u76d8\uff0c\u7136\u540e\u78c1\u76d8\u4e5f\u8981\u627e\u5230\u5bf9\u5e94\u7684\u90a3\u6761\u8bb0\u5f55\uff0c\u7136\u540e\u518d\u66f4\u65b0\uff0c\u6574\u4e2a\u8fc7\u7a0bIO\u6210\u672c\u3001\u67e5\u627e\u6210\u672c\u90fd\u5f88\u9ad8\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cMySQL\u7684\u8bbe\u8ba1\u8005\u5c31\u7528\u4e86\u7c7b\u4f3c\u9152\u5e97\u638c\u67dc\u7c89\u677f\u7684\u601d\u8def\u6765\u63d0\u5347\u66f4\u65b0\u6548\u7387\u3002</p> <p>\u800c\u7c89\u677f\u548c\u8d26\u672c\u914d\u5408\u7684\u6574\u4e2a\u8fc7\u7a0b\uff0c\u5176\u5b9e\u5c31\u662fMySQL\u91cc\u7ecf\u5e38\u8bf4\u5230\u7684WAL\u6280\u672f\uff0cWAL\u7684\u5168\u79f0\u662fWrite-Ahead Logging\uff0c\u5b83\u7684\u5173\u952e\u70b9\u5c31\u662f\u5148\u5199\u65e5\u5fd7\uff0c\u518d\u5199\u78c1\u76d8\uff0c\u4e5f\u5c31\u662f\u5148\u5199\u7c89\u677f\uff0c\u7b49\u4e0d\u5fd9\u7684\u65f6\u5019\u518d\u5199\u8d26\u672c\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u5f53\u6709\u4e00\u6761\u8bb0\u5f55\u9700\u8981\u66f4\u65b0\u7684\u65f6\u5019\uff0cInnoDB\u5f15\u64ce\u5c31\u4f1a\u5148\u628a\u8bb0\u5f55\u5199\u5230redo log\uff08\u7c89\u677f\uff09\u91cc\u9762\uff0c\u5e76\u66f4\u65b0\u5185\u5b58\uff0c\u8fd9\u4e2a\u65f6\u5019\u66f4\u65b0\u5c31\u7b97\u5b8c\u6210\u4e86\u3002\u540c\u65f6\uff0cInnoDB\u5f15\u64ce\u4f1a\u5728\u9002\u5f53\u7684\u65f6\u5019\uff0c\u5c06\u8fd9\u4e2a\u64cd\u4f5c\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u91cc\u9762\uff0c\u800c\u8fd9\u4e2a\u66f4\u65b0\u5f80\u5f80\u662f\u5728\u7cfb\u7edf\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\u505a\uff0c\u8fd9\u5c31\u50cf\u6253\u70ca\u4ee5\u540e\u638c\u67dc\u505a\u7684\u4e8b\u3002</p> <p>\u5982\u679c\u4eca\u5929\u8d4a\u8d26\u7684\u4e0d\u591a\uff0c\u638c\u67dc\u53ef\u4ee5\u7b49\u6253\u70ca\u540e\u518d\u6574\u7406\u3002\u4f46\u5982\u679c\u67d0\u5929\u8d4a\u8d26\u7684\u7279\u522b\u591a\uff0c\u7c89\u677f\u5199\u6ee1\u4e86\uff0c\u53c8\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e2a\u65f6\u5019\u638c\u67dc\u53ea\u597d\u653e\u4e0b\u624b\u4e2d\u7684\u6d3b\u513f\uff0c\u628a\u7c89\u677f\u4e2d\u7684\u4e00\u90e8\u5206\u8d4a\u8d26\u8bb0\u5f55\u66f4\u65b0\u5230\u8d26\u672c\u4e2d\uff0c\u7136\u540e\u628a\u8fd9\u4e9b\u8bb0\u5f55\u4ece\u7c89\u677f\u4e0a\u64e6\u6389\uff0c\u4e3a\u8bb0\u65b0\u8d26\u817e\u51fa\u7a7a\u95f4\u3002</p> <p>\u4e0e\u6b64\u7c7b\u4f3c\uff0cInnoDB\u7684redo log\u662f\u56fa\u5b9a\u5927\u5c0f\u7684\uff0c\u6bd4\u5982\u53ef\u4ee5\u914d\u7f6e\u4e3a\u4e00\u7ec44\u4e2a\u6587\u4ef6\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7684\u5927\u5c0f\u662f1GB\uff0c\u90a3\u4e48\u8fd9\u5757\u201c\u7c89\u677f\u201d\u603b\u5171\u5c31\u53ef\u4ee5\u8bb0\u5f554GB\u7684\u64cd\u4f5c\u3002\u4ece\u5934\u5f00\u59cb\u5199\uff0c\u5199\u5230\u672b\u5c3e\u5c31\u53c8\u56de\u5230\u5f00\u5934\u5faa\u73af\u5199\uff0c\u5982\u4e0b\u9762\u8fd9\u4e2a\u56fe\u6240\u793a\u3002</p> <p></p> <p>write pos\u662f\u5f53\u524d\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u4e00\u8fb9\u5199\u4e00\u8fb9\u540e\u79fb\uff0c\u5199\u5230\u7b2c3\u53f7\u6587\u4ef6\u672b\u5c3e\u540e\u5c31\u56de\u52300\u53f7\u6587\u4ef6\u5f00\u5934\u3002checkpoint\u662f\u5f53\u524d\u8981\u64e6\u9664\u7684\u4f4d\u7f6e\uff0c\u4e5f\u662f\u5f80\u540e\u63a8\u79fb\u5e76\u4e14\u5faa\u73af\u7684\uff0c\u64e6\u9664\u8bb0\u5f55\u524d\u8981\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u6570\u636e\u6587\u4ef6\u3002</p> <p>write pos\u548ccheckpoint\u4e4b\u95f4\u7684\u662f\u201c\u7c89\u677f\u201d\u4e0a\u8fd8\u7a7a\u7740\u7684\u90e8\u5206\uff0c\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u65b0\u7684\u64cd\u4f5c\u3002\u5982\u679cwrite pos\u8ffd\u4e0acheckpoint\uff0c\u8868\u793a\u201c\u7c89\u677f\u201d\u6ee1\u4e86\uff0c\u8fd9\u65f6\u5019\u4e0d\u80fd\u518d\u6267\u884c\u65b0\u7684\u66f4\u65b0\uff0c\u5f97\u505c\u4e0b\u6765\u5148\u64e6\u6389\u4e00\u4e9b\u8bb0\u5f55\uff0c\u628acheckpoint\u63a8\u8fdb\u4e00\u4e0b\u3002</p> <p>\u6709\u4e86redo log\uff0cInnoDB\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5373\u4f7f\u6570\u636e\u5e93\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u4e4b\u524d\u63d0\u4ea4\u7684\u8bb0\u5f55\u90fd\u4e0d\u4f1a\u4e22\u5931\uff0c\u8fd9\u4e2a\u80fd\u529b\u79f0\u4e3acrash-safe\u3002</p> <p>\u8981\u7406\u89e3crash-safe\u8fd9\u4e2a\u6982\u5ff5\uff0c\u53ef\u4ee5\u60f3\u60f3\u6211\u4eec\u524d\u9762\u8d4a\u8d26\u8bb0\u5f55\u7684\u4f8b\u5b50\u3002\u53ea\u8981\u8d4a\u8d26\u8bb0\u5f55\u8bb0\u5728\u4e86\u7c89\u677f\u4e0a\u6216\u5199\u5728\u4e86\u8d26\u672c\u4e0a\uff0c\u4e4b\u540e\u5373\u4f7f\u638c\u67dc\u5fd8\u8bb0\u4e86\uff0c\u6bd4\u5982\u7a81\u7136\u505c\u4e1a\u51e0\u5929\uff0c\u6062\u590d\u751f\u610f\u540e\u4f9d\u7136\u53ef\u4ee5\u901a\u8fc7\u8d26\u672c\u548c\u7c89\u677f\u4e0a\u7684\u6570\u636e\u660e\u786e\u8d4a\u8d26\u8d26\u76ee\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#binlog_1","title":"\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1abinlog","text":"<p>\u975e\u5e38\u91cd\u8981\uff0c\u4f5c\u7528\u4e5f\u5f88\u591a\u3002\u901a\u8fc7\u76d1\u542cbinLog\u6587\u4ef6\uff0c\u53ef\u4ee5\u7528\u4e8e\u4e3b\u4ece\u590d\u5236\u548c\u53d1\u9001\u6570\u636e\u7684\u53d8\u66f4MQ\u6d88\u606f\u7b49</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_1","title":"\u4e3b\u4ece\u590d\u5236","text":"<p>master\u670d\u52a1\u5668\u4f1a\u5524\u9192dump\u7ebf\u7a0b\u5c06binlog\u65e5\u5fd7\u6587\u4ef6\u4f20\u8f93\u7ed9slave\u670d\u52a1\u5668\uff0cslave\u670d\u52a1\u5668\u5524\u9192I/O\u7ebf\u7a0b\u5c06binlog\u65e5\u5fd7\u6587\u4ef6\u5199\u5165\u5230\u4e2d\u7ee7\u6587\u4ef6RelayLog\u4e2d\uff0c\u6700\u540eSQL\u7ebf\u7a0b\u8d1f\u8d23\u8bfb\u53d6\u56de\u653e\u5199\u5165\u5230\u78c1\u76d8\u91cc\u3002\u8fd9\u6837\u5c31\u7528\u4ee5\u4fdd\u8bc1\u4e3b\u4ece\u6570\u636e\u4e00\u81f4\u3002</p> <p>\u524d\u9762\u6211\u4eec\u8bb2\u8fc7\uff0cMySQL\u6574\u4f53\u6765\u770b\uff0c\u5176\u5b9e\u5c31\u6709\u4e24\u5757\uff1a\u4e00\u5757\u662fServer\u5c42\uff0c\u5b83\u4e3b\u8981\u505a\u7684\u662fMySQL\u529f\u80fd\u5c42\u9762\u7684\u4e8b\u60c5\uff1b\u8fd8\u6709\u4e00\u5757\u662f\u5f15\u64ce\u5c42\uff0c\u8d1f\u8d23\u5b58\u50a8\u76f8\u5173\u7684\u5177\u4f53\u4e8b\u5b9c\u3002\u4e0a\u9762\u6211\u4eec\u804a\u5230\u7684\u7c89\u677fredo log\u662fInnoDB\u5f15\u64ce\u7279\u6709\u7684\u65e5\u5fd7\uff0c\u800cServer\u5c42\u4e5f\u6709\u81ea\u5df1\u7684\u65e5\u5fd7\uff0c\u79f0\u4e3abinlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002</p> <p>\u6211\u60f3\u4f60\u80af\u5b9a\u4f1a\u95ee\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4e24\u4efd\u65e5\u5fd7\u5462\uff1f</p> <p>\u56e0\u4e3a\u6700\u5f00\u59cbMySQL\u91cc\u5e76\u6ca1\u6709InnoDB\u5f15\u64ce\u3002MySQL\u81ea\u5e26\u7684\u5f15\u64ce\u662fMyISAM\uff0c\u4f46\u662fMyISAM\u6ca1\u6709crash-safe\u7684\u80fd\u529b\uff0cbinlog\u65e5\u5fd7\u53ea\u80fd\u7528\u4e8e\u5f52\u6863\u3002\u800cInnoDB\u662f\u53e6\u4e00\u4e2a\u516c\u53f8\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u5f15\u5165MySQL\u7684\uff0c\u65e2\u7136\u53ea\u4f9d\u9760binlog\u662f\u6ca1\u6709crash-safe\u80fd\u529b\u7684\uff0c\u6240\u4ee5InnoDB\u4f7f\u7528\u53e6\u5916\u4e00\u5957\u65e5\u5fd7\u7cfb\u7edf\u2014\u2014\u4e5f\u5c31\u662fredo log\u6765\u5b9e\u73b0crash-safe\u80fd\u529b\u3002</p> <p>\u8fd9\u4e24\u79cd\u65e5\u5fd7\u6709\u4ee5\u4e0b\u4e09\u70b9\u4e0d\u540c:</p> <p>\u200b   1.  redo log\u662fInnoDB\u5f15\u64ce\u7279\u6709\u7684\uff1bbinlog\u662fMySQL\u7684Server\u5c42\u5b9e\u73b0\u7684\uff0c\u6240\u6709\u5f15\u64ce\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>\u200b   2.  redo log\u662f\u7269\u7406\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u201c\u5728\u67d0\u4e2a\u6570\u636e\u9875\u4e0a\u505a\u4e86\u4ec0\u4e48\u4fee\u6539\u201d\uff1bbinlog\u662f\u903b\u8f91\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684\u539f\u59cb\u903b\u8f91\uff0c\u6bd4\u5982\u201c\u7ed9ID=2\u8fd9\u4e00\u884c\u7684c\u5b57\u6bb5\u52a01 \u201d\u3002</p> <p>\u200b   3.  redo log\u662f\u5faa\u73af\u5199\u7684\uff0c\u7a7a\u95f4\u56fa\u5b9a\u4f1a\u7528\u5b8c\uff1bbinlog\u662f\u53ef\u4ee5\u8ffd\u52a0\u5199\u5165\u7684\u3002\u201c\u8ffd\u52a0\u5199\u201d\u662f\u6307binlog\u6587\u4ef6\u5199\u5230\u4e00\u5b9a\u5927\u5c0f\u540e\u4f1a\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\uff0c\u5e76\u4e0d\u4f1a\u8986\u76d6\u4ee5\u524d\u7684\u65e5\u5fd7\u3002</p> <p>\u6709\u4e86\u5bf9\u8fd9\u4e24\u4e2a\u65e5\u5fd7\u7684\u6982\u5ff5\u6027\u7406\u89e3\uff0c\u6211\u4eec\u518d\u6765\u770b\u6267\u884c\u5668\u548cInnoDB\u5f15\u64ce\u5728\u6267\u884c\u8fd9\u4e2a\u7b80\u5355\u7684update\u8bed\u53e5\u65f6\u7684\u5185\u90e8\u6d41\u7a0b\u3002</p> <p>\u200b   1.  \u6267\u884c\u5668\u5148\u627e\u5f15\u64ce\u53d6ID=2\u8fd9\u4e00\u884c\u3002ID\u662f\u4e3b\u952e\uff0c\u5f15\u64ce\u76f4\u63a5\u7528\u6811\u641c\u7d22\u627e\u5230\u8fd9\u4e00\u884c\u3002\u5982\u679cID=2\u8fd9\u4e00\u884c\u6240\u5728\u7684\u6570\u636e\u9875\u672c\u6765\u5c31\u5728\u5185\u5b58\u4e2d\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u7ed9\u6267\u884c\u5668\uff1b\u5426\u5219\uff0c\u9700\u8981\u5148\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u518d\u8fd4\u56de\u3002</p> <p>\u200b   2.  \u6267\u884c\u5668\u62ff\u5230\u5f15\u64ce\u7ed9\u7684\u884c\u6570\u636e\uff0c\u628a\u8fd9\u4e2a\u503c\u52a0\u4e0a1\uff0c\u6bd4\u5982\u539f\u6765\u662fN\uff0c\u73b0\u5728\u5c31\u662fN+1\uff0c\u5f97\u5230\u65b0\u7684\u4e00\u884c\u6570\u636e\uff0c\u518d\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u5199\u5165\u8fd9\u884c\u65b0\u6570\u636e\u3002</p> <p>\u200b   3.  \u5f15\u64ce\u5c06\u8fd9\u884c\u65b0\u6570\u636e\u66f4\u65b0\u5230\u5185\u5b58\u4e2d\uff0c\u540c\u65f6\u5c06\u8fd9\u4e2a\u66f4\u65b0\u64cd\u4f5c\u8bb0\u5f55\u5230redo log\u91cc\u9762\uff0c\u6b64\u65f6redo log\u5904\u4e8eprepare\u72b6\u6001\u3002\u7136\u540e\u544a\u77e5\u6267\u884c\u5668\u6267\u884c\u5b8c\u6210\u4e86\uff0c\u968f\u65f6\u53ef\u4ee5\u63d0\u4ea4\u4e8b\u52a1\u3002</p> <p>\u200b   4.  \u6267\u884c\u5668\u751f\u6210\u8fd9\u4e2a\u64cd\u4f5c\u7684binlog\uff0c\u5e76\u628abinlog\u5199\u5165\u78c1\u76d8\u3002</p> <p>\u200b   5.  \u6267\u884c\u5668\u8c03\u7528\u5f15\u64ce\u7684\u63d0\u4ea4\u4e8b\u52a1\u63a5\u53e3\uff0c\u5f15\u64ce\u628a\u521a\u521a\u5199\u5165\u7684redo log\u6539\u6210\u63d0\u4ea4\uff08commit\uff09\u72b6\u6001\uff0c\u66f4\u65b0\u5b8c\u6210\u3002</p> <p>\u8fd9\u91cc\u6211\u7ed9\u51fa\u8fd9\u4e2aupdate\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u56fe\uff0c\u56fe\u4e2d\u6d45\u8272\u6846\u8868\u793a\u662f\u5728InnoDB\u5185\u90e8\u6267\u884c\u7684\uff0c\u6df1\u8272\u6846\u8868\u793a\u662f\u5728\u6267\u884c\u5668\u4e2d\u6267\u884c\u7684\u3002</p> <p></p> <p>\u4f60\u53ef\u80fd\u6ce8\u610f\u5230\u4e86\uff0c\u6700\u540e\u4e09\u6b65\u770b\u4e0a\u53bb\u6709\u70b9\u201c\u7ed5\u201d\uff0c\u5c06redo log\u7684\u5199\u5165\u62c6\u6210\u4e86\u4e24\u4e2a\u6b65\u9aa4\uff1aprepare\u548ccommit\uff0c\u8fd9\u5c31\u662f\"\u4e24\u9636\u6bb5\u63d0\u4ea4\"\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_2","title":"\u4e24\u9636\u6bb5\u63d0\u4ea4","text":"<p>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u6709\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u5462\uff1f\u8fd9\u662f\u4e3a\u4e86\u8ba9\u4e24\u4efd\u65e5\u5fd7\u4e4b\u95f4\u7684\u903b\u8f91\u4e00\u81f4\u3002\u8981\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5f97\u4ece\u6587\u7ae0\u5f00\u5934\u7684\u90a3\u4e2a\u95ee\u9898\u8bf4\u8d77\uff1a\u600e\u6837\u8ba9\u6570\u636e\u5e93\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u4efb\u610f\u4e00\u79d2\u7684\u72b6\u6001\uff1f</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u4e86\uff0cbinlog\u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u903b\u8f91\u64cd\u4f5c\uff0c\u5e76\u4e14\u662f\u91c7\u7528\u201c\u8ffd\u52a0\u5199\u201d\u7684\u5f62\u5f0f\u3002\u5982\u679c\u4f60\u7684DBA\u627f\u8bfa\u8bf4\u534a\u4e2a\u6708\u5185\u53ef\u4ee5\u6062\u590d\uff0c\u90a3\u4e48\u5907\u4efd\u7cfb\u7edf\u4e2d\u4e00\u5b9a\u4f1a\u4fdd\u5b58\u6700\u8fd1\u534a\u4e2a\u6708\u7684\u6240\u6709binlog\uff0c\u540c\u65f6\u7cfb\u7edf\u4f1a\u5b9a\u671f\u505a\u6574\u5e93\u5907\u4efd\u3002\u8fd9\u91cc\u7684\u201c\u5b9a\u671f\u201d\u53d6\u51b3\u4e8e\u7cfb\u7edf\u7684\u91cd\u8981\u6027\uff0c\u53ef\u4ee5\u662f\u4e00\u5929\u4e00\u5907\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e00\u5468\u4e00\u5907\u3002</p> <p>\u5f53\u9700\u8981\u6062\u590d\u5230\u6307\u5b9a\u7684\u67d0\u4e00\u79d2\u65f6\uff0c\u6bd4\u5982\u67d0\u5929\u4e0b\u5348\u4e24\u70b9\u53d1\u73b0\u4e2d\u5348\u5341\u4e8c\u70b9\u6709\u4e00\u6b21\u8bef\u5220\u8868\uff0c\u9700\u8981\u627e\u56de\u6570\u636e\uff0c\u90a3\u4f60\u53ef\u4ee5\u8fd9\u4e48\u505a\uff1a</p> <p>\u200b   \u2022   \u9996\u5148\uff0c\u627e\u5230\u6700\u8fd1\u7684\u4e00\u6b21\u5168\u91cf\u5907\u4efd\uff0c\u5982\u679c\u4f60\u8fd0\u6c14\u597d\uff0c\u53ef\u80fd\u5c31\u662f\u6628\u5929\u665a\u4e0a\u7684\u4e00\u4e2a\u5907\u4efd\uff0c\u4ece\u8fd9\u4e2a\u5907\u4efd\u6062\u590d\u5230\u4e34\u65f6\u5e93\uff1b</p> <p>\u200b   \u2022   \u7136\u540e\uff0c\u4ece\u5907\u4efd\u7684\u65f6\u95f4\u70b9\u5f00\u59cb\uff0c\u5c06\u5907\u4efd\u7684binlog\u4f9d\u6b21\u53d6\u51fa\u6765\uff0c\u91cd\u653e\u5230\u4e2d\u5348\u8bef\u5220\u8868\u4e4b\u524d\u7684\u90a3\u4e2a\u65f6\u523b\u3002</p> <p>\u8fd9\u6837\u4f60\u7684\u4e34\u65f6\u5e93\u5c31\u8ddf\u8bef\u5220\u4e4b\u524d\u7684\u7ebf\u4e0a\u5e93\u4e00\u6837\u4e86\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u628a\u8868\u6570\u636e\u4ece\u4e34\u65f6\u5e93\u53d6\u51fa\u6765\uff0c\u6309\u9700\u8981\u6062\u590d\u5230\u7ebf\u4e0a\u5e93\u53bb\u3002</p> <p>\u597d\u4e86\uff0c\u8bf4\u5b8c\u4e86\u6570\u636e\u6062\u590d\u8fc7\u7a0b\uff0c\u6211\u4eec\u56de\u6765\u8bf4\u8bf4\uff0c\u4e3a\u4ec0\u4e48\u65e5\u5fd7\u9700\u8981\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u3002\u8fd9\u91cc\u4e0d\u59a8\u7528\u53cd\u8bc1\u6cd5\u6765\u8fdb\u884c\u89e3\u91ca\u3002</p> <p>\u7531\u4e8eredo log\u548cbinlog\u662f\u4e24\u4e2a\u72ec\u7acb\u7684\u903b\u8f91\uff0c\u5982\u679c\u4e0d\u7528\u4e24\u9636\u6bb5\u63d0\u4ea4\uff0c\u8981\u4e48\u5c31\u662f\u5148\u5199\u5b8credo log\u518d\u5199binlog\uff0c\u6216\u8005\u91c7\u7528\u53cd\u8fc7\u6765\u7684\u987a\u5e8f\u3002\u6211\u4eec\u770b\u770b\u8fd9\u4e24\u79cd\u65b9\u5f0f\u4f1a\u6709\u4ec0\u4e48\u95ee\u9898\u3002</p> <p>\u4ecd\u7136\u7528\u524d\u9762\u7684update\u8bed\u53e5\u6765\u505a\u4f8b\u5b50\u3002\u5047\u8bbe\u5f53\u524dID=2\u7684\u884c\uff0c\u5b57\u6bb5c\u7684\u503c\u662f0\uff0c\u518d\u5047\u8bbe\u6267\u884cupdate\u8bed\u53e5\u8fc7\u7a0b\u4e2d\u5728\u5199\u5b8c\u7b2c\u4e00\u4e2a\u65e5\u5fd7\u540e\uff0c\u7b2c\u4e8c\u4e2a\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5199\u5b8c\u671f\u95f4\u53d1\u751f\u4e86crash\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\u5462\uff1f</p> <p>\u200b   1.  \u5148\u5199redo log\u540e\u5199binlog\u3002\u5047\u8bbe\u5728redo log\u5199\u5b8c\uff0cbinlog\u8fd8\u6ca1\u6709\u5199\u5b8c\u7684\u65f6\u5019\uff0cMySQL\u8fdb\u7a0b\u5f02\u5e38\u91cd\u542f\u3002\u7531\u4e8e\u6211\u4eec\u524d\u9762\u8bf4\u8fc7\u7684\uff0credo log\u5199\u5b8c\u4e4b\u540e\uff0c\u7cfb\u7edf\u5373\u4f7f\u5d29\u6e83\uff0c\u4ecd\u7136\u80fd\u591f\u628a\u6570\u636e\u6062\u590d\u56de\u6765\uff0c\u6240\u4ee5\u6062\u590d\u540e\u8fd9\u4e00\u884cc\u7684\u503c\u662f1\u3002\u4f46\u662f\u7531\u4e8ebinlog\u6ca1\u5199\u5b8c\u5c31crash\u4e86\uff0c\u8fd9\u65f6\u5019binlog\u91cc\u9762\u5c31\u6ca1\u6709\u8bb0\u5f55\u8fd9\u4e2a\u8bed\u53e5\u3002\u56e0\u6b64\uff0c\u4e4b\u540e\u5907\u4efd\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u5b58\u8d77\u6765\u7684binlog\u91cc\u9762\u5c31\u6ca1\u6709\u8fd9\u6761\u8bed\u53e5\u3002\u7136\u540e\u4f60\u4f1a\u53d1\u73b0\uff0c\u5982\u679c\u9700\u8981\u7528\u8fd9\u4e2abinlog\u6765\u6062\u590d\u4e34\u65f6\u5e93\u7684\u8bdd\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u7684binlog\u4e22\u5931\uff0c\u8fd9\u4e2a\u4e34\u65f6\u5e93\u5c31\u4f1a\u5c11\u4e86\u8fd9\u4e00\u6b21\u66f4\u65b0\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884cc\u7684\u503c\u5c31\u662f0\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</p> <p>\u200b   2.  \u5148\u5199binlog\u540e\u5199redo log\u3002\u5982\u679c\u5728binlog\u5199\u5b8c\u4e4b\u540ecrash\uff0c\u7531\u4e8eredo log\u8fd8\u6ca1\u5199\uff0c\u5d29\u6e83\u6062\u590d\u4ee5\u540e\u8fd9\u4e2a\u4e8b\u52a1\u65e0\u6548\uff0c\u6240\u4ee5\u8fd9\u4e00\u884cc\u7684\u503c\u662f0\u3002\u4f46\u662fbinlog\u91cc\u9762\u5df2\u7ecf\u8bb0\u5f55\u4e86\u201c\u628ac\u4ece0\u6539\u62101\u201d\u8fd9\u4e2a\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u5728\u4e4b\u540e\u7528binlog\u6765\u6062\u590d\u7684\u65f6\u5019\u5c31\u591a\u4e86\u4e00\u4e2a\u4e8b\u52a1\u51fa\u6765\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884cc\u7684\u503c\u5c31\u662f1\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u7684\u72b6\u6001\u5c31\u6709\u53ef\u80fd\u548c\u7528\u5b83\u7684\u65e5\u5fd7\u6062\u590d\u51fa\u6765\u7684\u5e93\u7684\u72b6\u6001\u4e0d\u4e00\u81f4\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u8bf4\uff0c\u8fd9\u4e2a\u6982\u7387\u662f\u4e0d\u662f\u5f88\u4f4e\uff0c\u5e73\u65f6\u4e5f\u6ca1\u6709\u4ec0\u4e48\u52a8\u4e0d\u52a8\u5c31\u9700\u8981\u6062\u590d\u4e34\u65f6\u5e93\u7684\u573a\u666f\u5440\uff1f</p> <p>\u5176\u5b9e\u4e0d\u662f\u7684\uff0c\u4e0d\u53ea\u662f\u8bef\u64cd\u4f5c\u540e\u9700\u8981\u7528\u8fd9\u4e2a\u8fc7\u7a0b\u6765\u6062\u590d\u6570\u636e\u3002\u5f53\u4f60\u9700\u8981\u6269\u5bb9\u7684\u65f6\u5019\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u518d\u591a\u642d\u5efa\u4e00\u4e9b\u5907\u5e93\u6765\u589e\u52a0\u7cfb\u7edf\u7684\u8bfb\u80fd\u529b\u7684\u65f6\u5019\uff0c\u73b0\u5728\u5e38\u89c1\u7684\u505a\u6cd5\u4e5f\u662f\u7528\u5168\u91cf\u5907\u4efd\u52a0\u4e0a\u5e94\u7528binlog\u6765\u5b9e\u73b0\u7684\uff0c\u8fd9\u4e2a\u201c\u4e0d\u4e00\u81f4\u201d\u5c31\u4f1a\u5bfc\u81f4\u4f60\u7684\u7ebf\u4e0a\u51fa\u73b0\u4e3b\u4ece\u6570\u636e\u5e93\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p> <p>\u7b80\u5355\u8bf4\uff0credo log\u548cbinlog\u90fd\u53ef\u4ee5\u7528\u4e8e\u8868\u793a\u4e8b\u52a1\u7684\u63d0\u4ea4\u72b6\u6001\uff0c\u800c\u4e24\u9636\u6bb5\u63d0\u4ea4\u5c31\u662f\u8ba9\u8fd9\u4e24\u4e2a\u72b6\u6001\u4fdd\u6301\u903b\u8f91\u4e0a\u7684\u4e00\u81f4\u3002</p> <p>redo log\u7528\u4e8e\u4fdd\u8bc1crash-safe\u80fd\u529b\u3002innodb_flush_log_at_trx_commit\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u62101\u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684redo log\u90fd\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u62101\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1MySQL\u5f02\u5e38\u91cd\u542f\u4e4b\u540e\u6570\u636e\u4e0d\u4e22\u5931\u3002</p> <p>sync_binlog\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u62101\u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684binlog\u90fd\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u4e5f\u5efa\u8bae\u4f60\u8bbe\u7f6e\u62101\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1MySQL\u5f02\u5e38\u91cd\u542f\u4e4b\u540ebinlog\u4e0d\u4e22\u5931\u3002</p> <p>\u4e0eMySQL\u65e5\u5fd7\u7cfb\u7edf\u5bc6\u5207\u76f8\u5173\u7684\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u3002\u4e24\u9636\u6bb5\u63d0\u4ea4\u662f\u8de8\u7cfb\u7edf\u7ef4\u6301\u6570\u636e\u903b\u8f91\u4e00\u81f4\u6027\u65f6\u5e38\u7528\u7684\u4e00\u4e2a\u65b9\u6848\uff0c\u5373\u4f7f\u4f60\u4e0d\u505a\u6570\u636e\u5e93\u5185\u6838\u5f00\u53d1\uff0c\u65e5\u5e38\u5f00\u53d1\u4e2d\u4e5f\u6709\u53ef\u80fd\u4f1a\u7528\u5230\u3002</p> <p>\u5982\u679c\u5728\u56fe\u4e2d\u65f6\u523b A \u7684\u5730\u65b9\uff0c\u4e5f\u5c31\u662f\u5199\u5165 redo log \u5904\u4e8e prepare \u9636\u6bb5\u4e4b\u540e\u3001\u5199 binlog \u4e4b\u524d\uff0c\u53d1\u751f\u4e86\u5d29\u6e83\uff08crash\uff09\uff0c\u7531\u4e8e\u6b64\u65f6 binlog \u8fd8\u6ca1\u5199\uff0credo log \u4e5f\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u6240\u4ee5\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u4f1a\u56de\u6eda\u3002\u8fd9\u65f6\u5019\uff0cbinlog \u8fd8\u6ca1\u5199\uff0c\u6240\u4ee5\u4e5f\u4e0d\u4f1a\u4f20\u5230\u5907\u5e93\u3002\u5230\u8fd9\u91cc\uff0c\u5927\u5bb6\u90fd\u53ef\u4ee5\u7406\u89e3\u3002</p> <p>\u65f6\u523b B\uff0c\u4e5f\u5c31\u662f binlog \u5199\u5b8c\uff0credo log \u8fd8\u6ca1 commit \u524d\u53d1\u751f crash\u3002\u65f6\u523b B \u53d1\u751f crash \u5bf9\u5e94\u7684\u5c31\u662f 2(a) \u7684\u60c5\u51b5\uff0c\u5d29\u6e83\u6062\u590d\u8fc7\u7a0b\u4e2d\u4e8b\u52a1\u4f1a\u88ab\u63d0\u4ea4\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#qa","title":"Q&amp;A","text":"<p>Q1\uff1aMySQL \u600e\u4e48\u77e5\u9053 binlog \u662f\u5b8c\u6574\u7684?</p> <p>A\uff1a\u4e00\u4e2a\u4e8b\u52a1\u7684 binlog \u662f\u6709\u5b8c\u6574\u683c\u5f0f\u7684\uff1astatement \u683c\u5f0f\u7684 binlog\uff0c\u6700\u540e\u4f1a\u6709 COMMIT\uff1b row \u683c\u5f0f\u7684 binlog\uff0c\u6700\u540e\u4f1a\u6709\u4e00\u4e2a XID event\u3002 \u53e6\u5916\uff0c\u5728 MySQL 5.6.2 \u7248\u672c\u4ee5\u540e\uff0c\u8fd8\u5f15\u5165\u4e86 binlog-checksum \u53c2\u6570\uff0c\u7528\u6765\u9a8c\u8bc1 binlog \u5185\u5bb9\u7684\u6b63\u786e\u6027\u3002\u5bf9\u4e8e binlog \u65e5\u5fd7\u7531\u4e8e\u78c1\u76d8\u539f\u56e0\uff0c\u53ef\u80fd\u4f1a\u5728\u65e5\u5fd7\u4e2d\u95f4\u51fa\u9519\u7684\u60c5\u51b5\uff0cMySQL \u53ef\u4ee5\u901a\u8fc7\u6821\u9a8c checksum \u7684\u7ed3\u679c\u6765\u53d1\u73b0\u3002\u6240\u4ee5\uff0cMySQL \u8fd8\u662f\u6709\u529e\u6cd5\u9a8c\u8bc1\u4e8b\u52a1 binlog \u7684\u5b8c\u6574\u6027\u7684\u3002</p> <p>Q2: redo log \u548c binlog \u662f\u600e\u4e48\u5173\u8054\u8d77\u6765\u7684?</p> <p>A\uff1a\u5b83\u4eec\u6709\u4e00\u4e2a\u5171\u540c\u7684\u6570\u636e\u5b57\u6bb5\uff0c\u53eb XID\u3002\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u4f1a\u6309\u987a\u5e8f\u626b\u63cf redo log\uff1a</p> <p>\u5982\u679c\u78b0\u5230\u65e2\u6709 prepare\u3001\u53c8\u6709 commit \u7684 redo log\uff0c\u5c31\u76f4\u63a5\u63d0\u4ea4\uff1b \u5982\u679c\u78b0\u5230\u53ea\u6709 parepare\u3001\u800c\u6ca1\u6709 commit \u7684 redo log\uff0c\u5c31\u62ff\u7740 XID \u53bb binlog \u627e\u5bf9\u5e94\u7684\u4e8b\u52a1\u3002</p> <p>Q3: \u5904\u4e8e prepare \u9636\u6bb5\u7684 redo log \u52a0\u4e0a\u5b8c\u6574 binlog\uff0c\u91cd\u542f\u5c31\u80fd\u6062\u590d\uff0cMySQL \u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u8bbe\u8ba1?</p> <p>A\uff1a\u8fd9\u4e2a\u95ee\u9898\u8fd8\u662f\u8ddf\u6211\u4eec\u5728\u53cd\u8bc1\u6cd5\u4e2d\u8bf4\u5230\u7684\u6570\u636e\u4e0e\u5907\u4efd\u7684\u4e00\u81f4\u6027\u6709\u5173\u3002\u5728\u65f6\u523b B\uff0c\u4e5f\u5c31\u662f binlog \u5199\u5b8c\u4ee5\u540e MySQL \u53d1\u751f\u5d29\u6e83\uff0c\u8fd9\u65f6\u5019 binlog \u5df2\u7ecf\u5199\u5165\u4e86\uff0c\u4e4b\u540e\u5c31\u4f1a\u88ab\u4ece\u5e93\uff08\u6216\u8005\u7528\u8fd9\u4e2a binlog \u6062\u590d\u51fa\u6765\u7684\u5e93\uff09\u4f7f\u7528\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u4e3b\u5e93\u4e0a\u4e5f\u8981\u63d0\u4ea4\u8fd9\u4e2a\u4e8b\u52a1\u3002\u91c7\u7528\u8fd9\u4e2a\u7b56\u7565\uff0c\u4e3b\u5e93\u548c\u5907\u5e93\u7684\u6570\u636e\u5c31\u4fdd\u8bc1\u4e86\u4e00\u81f4\u6027\u3002</p> <p>Q4: \u5982\u679c\u8fd9\u6837\u7684\u8bdd\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u4e24\u9636\u6bb5\u63d0\u4ea4\u5462\uff1f\u5e72\u8106\u5148 redo log \u5199\u5b8c\uff0c\u518d\u5199 binlog\u3002\u5d29\u6e83\u6062\u590d\u7684\u65f6\u5019\uff0c\u5fc5\u987b\u5f97\u4e24\u4e2a\u65e5\u5fd7\u90fd\u5b8c\u6574\u624d\u53ef\u4ee5\u3002\u662f\u4e0d\u662f\u4e00\u6837\u7684\u903b\u8f91\uff1f</p> <p>A\uff1a\u5176\u5b9e\uff0c\u4e24\u9636\u6bb5\u63d0\u4ea4\u662f\u7ecf\u5178\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u95ee\u9898\uff0c\u5e76\u4e0d\u662f MySQL \u72ec\u6709\u7684\u3002</p> <p>\u5982\u679c\u5fc5\u987b\u8981\u4e3e\u4e00\u4e2a\u573a\u666f\uff0c\u6765\u8bf4\u660e\u8fd9\u4e48\u505a\u7684\u5fc5\u8981\u6027\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\u4e8b\u52a1\u7684\u6301\u4e45\u6027\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8e InnoDB \u5f15\u64ce\u6765\u8bf4\uff0c\u5982\u679c redo log \u63d0\u4ea4\u5b8c\u6210\u4e86\uff0c\u4e8b\u52a1\u5c31\u4e0d\u80fd\u56de\u6eda\uff08\u5982\u679c\u8fd9\u8fd8\u5141\u8bb8\u56de\u6eda\uff0c\u5c31\u53ef\u80fd\u8986\u76d6\u6389\u522b\u7684\u4e8b\u52a1\u7684\u66f4\u65b0\uff09\u3002\u800c\u5982\u679c redo log \u76f4\u63a5\u63d0\u4ea4\uff0c\u7136\u540e binlog \u5199\u5165\u7684\u65f6\u5019\u5931\u8d25\uff0cInnoDB \u53c8\u56de\u6eda\u4e0d\u4e86\uff0c\u6570\u636e\u548c binlog \u65e5\u5fd7\u53c8\u4e0d\u4e00\u81f4\u4e86\u3002</p> <p>\u4e24\u9636\u6bb5\u63d0\u4ea4\u5c31\u662f\u4e3a\u4e86\u7ed9\u6240\u6709\u4eba\u4e00\u4e2a\u673a\u4f1a\uff0c\u5f53\u6bcf\u4e2a\u4eba\u90fd\u8bf4\u201c\u6211 ok\u201d\u7684\u65f6\u5019\uff0c\u518d\u4e00\u8d77\u63d0\u4ea4\u3002</p> <p>Q5: \u53ea\u7528 redo log\uff0c\u4e0d\u8981 binlog\uff1f</p> <p>A\uff1a\u5982\u679c\u53ea\u4ece\u5d29\u6e83\u6062\u590d\u7684\u89d2\u5ea6\u6765\u8bb2\u662f\u53ef\u4ee5\u7684\u3002\u4f60\u53ef\u4ee5\u628a binlog \u5173\u6389\uff0c\u8fd9\u6837\u5c31\u6ca1\u6709\u4e24\u9636\u6bb5\u63d0\u4ea4\u4e86\uff0c\u4f46\u7cfb\u7edf\u4f9d\u7136\u662f crash-safe \u7684\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u4e86\u89e3\u4e00\u4e0b\u4e1a\u754c\u5404\u4e2a\u516c\u53f8\u7684\u4f7f\u7528\u573a\u666f\u7684\u8bdd\uff0c\u5c31\u4f1a\u53d1\u73b0\u5728\u6b63\u5f0f\u7684\u751f\u4ea7\u5e93\u4e0a\uff0cbinlog \u90fd\u662f\u5f00\u7740\u7684\u3002\u56e0\u4e3a binlog \u6709\u7740 redo log \u65e0\u6cd5\u66ff\u4ee3\u7684\u529f\u80fd\u3002</p> <p>\u4e00\u4e2a\u662f\u5f52\u6863\u3002redo log \u662f\u5faa\u73af\u5199\uff0c\u5199\u5230\u672b\u5c3e\u662f\u8981\u56de\u5230\u5f00\u5934\u7ee7\u7eed\u5199\u7684\u3002\u8fd9\u6837\u5386\u53f2\u65e5\u5fd7\u6ca1\u6cd5\u4fdd\u7559\uff0credo log \u4e5f\u5c31\u8d77\u4e0d\u5230\u5f52\u6863\u7684\u4f5c\u7528\u3002</p> <p>\u4e00\u4e2a\u5c31\u662f MySQL \u7cfb\u7edf\u4f9d\u8d56\u4e8e binlog\u3002binlog \u4f5c\u4e3a MySQL \u4e00\u5f00\u59cb\u5c31\u6709\u7684\u529f\u80fd\uff0c\u88ab\u7528\u5728\u4e86\u5f88\u591a\u5730\u65b9\u3002\u5176\u4e2d\uff0cMySQL \u7cfb\u7edf\u9ad8\u53ef\u7528\u7684\u57fa\u7840\uff0c\u5c31\u662f binlog \u590d\u5236\u3002</p> <p>Q6: redo log buffer \u662f\u4ec0\u4e48\uff1f\u662f\u5148\u4fee\u6539\u5185\u5b58\uff0c\u8fd8\u662f\u5148\u5199 redo log \u6587\u4ef6\uff1f</p> <p>A\uff1a\u5728\u4e00\u4e2a\u4e8b\u52a1\u7684\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u65e5\u5fd7\u662f\u8981\u5199\u591a\u6b21\u7684\u3002\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u4e8b\u52a1\uff1a</p> <pre><code>begin; \ninsert into t1 ... \ninsert into t2 ... commit; \n</code></pre> <p>\u8fd9\u4e2a\u4e8b\u52a1\u8981\u5f80\u4e24\u4e2a\u8868\u4e2d\u63d2\u5165\u8bb0\u5f55\uff0c\u63d2\u5165\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u7684\u65e5\u5fd7\u90fd\u5f97\u5148\u4fdd\u5b58\u8d77\u6765\uff0c\u4f46\u53c8\u4e0d\u80fd\u5728\u8fd8\u6ca1 commit \u7684\u65f6\u5019\u5c31\u76f4\u63a5\u5199\u5230 redo log \u6587\u4ef6\u91cc\u3002</p> <p>\u6240\u4ee5\uff0credo log buffer \u5c31\u662f\u4e00\u5757\u5185\u5b58\uff0c\u7528\u6765\u5148\u5b58 redo \u65e5\u5fd7\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u6267\u884c\u7b2c\u4e00\u4e2a insert \u7684\u65f6\u5019\uff0c\u6570\u636e\u7684\u5185\u5b58\u88ab\u4fee\u6539\u4e86\uff0credo log buffer \u4e5f\u5199\u5165\u4e86\u65e5\u5fd7\u3002\u4f46\u662f\u771f\u6b63\u628a\u65e5\u5fd7\u5199\u5230 redo log \u6587\u4ef6\uff08\u6587\u4ef6\u540d\u662f ib_logfile+ \u6570\u5b57\uff09\uff0c\u662f\u5728\u6267\u884c commit \u8bed\u53e5\u7684\u65f6\u5019\u505a\u7684\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#change-buffer","title":"change buffer","text":"<p>\u5f53\u9700\u8981\u66f4\u65b0\u4e00\u4e2a\u6570\u636e\u9875\u65f6\uff0c\u5982\u679c\u6570\u636e\u9875\u5728\u5185\u5b58\u4e2d\u5c31\u76f4\u63a5\u66f4\u65b0\uff0c\u800c\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u8fd8\u6ca1\u6709\u5728\u5185\u5b58\u4e2d\u7684\u8bdd\uff0c\u5728\u4e0d\u5f71\u54cd\u6570\u636e\u4e00\u81f4\u6027\u7684\u524d\u63d0\u4e0b\uff0cInnoDB\u4f1a\u5c06\u8fd9\u4e9b\u66f4\u65b0\u64cd\u4f5c\u7f13\u5b58\u5728change buffer\u4e2d\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u8fd9\u4e2a\u6570\u636e\u9875\u4e86\u3002\u5728\u4e0b\u6b21\u67e5\u8be2\u9700\u8981\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\u7684\u65f6\u5019\uff0c\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u6267\u884cchange buffer\u4e2d\u4e0e\u8fd9\u4e2a\u9875\u6709\u5173\u7684\u64cd\u4f5c\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5c31\u80fd\u4fdd\u8bc1\u8fd9\u4e2a\u6570\u636e\u903b\u8f91\u7684\u6b63\u786e\u6027\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u867d\u7136\u540d\u5b57\u53eb\u4f5cchange buffer\uff0c\u5b9e\u9645\u4e0a\u5b83\u662f\u53ef\u4ee5\u6301\u4e45\u5316\u7684\u6570\u636e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cchange buffer\u5728\u5185\u5b58\u4e2d\u6709\u62f7\u8d1d\uff0c\u4e5f\u4f1a\u88ab\u5199\u5165\u5230\u78c1\u76d8\u4e0a\u3002</p> <p>\u5c06change buffer\u4e2d\u7684\u64cd\u4f5c\u5e94\u7528\u5230\u539f\u6570\u636e\u9875\uff0c\u5f97\u5230\u6700\u65b0\u7ed3\u679c\u7684\u8fc7\u7a0b\u79f0\u4e3amerge\u3002\u9664\u4e86\u8bbf\u95ee\u8fd9\u4e2a\u6570\u636e\u9875\u4f1a\u89e6\u53d1merge\u5916\uff0c\u7cfb\u7edf\u6709\u540e\u53f0\u7ebf\u7a0b\u4f1a\u5b9a\u671fmerge\u3002\u5728\u6570\u636e\u5e93\u6b63\u5e38\u5173\u95ed\uff08shutdown\uff09\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u4f1a\u6267\u884cmerge\u64cd\u4f5c\u3002</p> <p>\u663e\u7136\uff0c\u5982\u679c\u80fd\u591f\u5c06\u66f4\u65b0\u64cd\u4f5c\u5148\u8bb0\u5f55\u5728change buffer\uff0c\u51cf\u5c11\u8bfb\u78c1\u76d8\uff0c\u8bed\u53e5\u7684\u6267\u884c\u901f\u5ea6\u4f1a\u5f97\u5230\u660e\u663e\u7684\u63d0\u5347\u3002\u800c\u4e14\uff0c\u6570\u636e\u8bfb\u5165\u5185\u5b58\u662f\u9700\u8981\u5360\u7528buffer pool\u7684\uff0c\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fd8\u80fd\u591f\u907f\u514d\u5360\u7528\u5185\u5b58\uff0c\u63d0\u9ad8\u5185\u5b58\u5229\u7528\u7387\u3002</p> <p>\u90a3\u4e48\uff0c\u4ec0\u4e48\u6761\u4ef6\u4e0b\u53ef\u4ee5\u4f7f\u7528change buffer\u5462\uff1f</p> <p>\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u6765\u8bf4\uff0c\u6240\u6709\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u8981\u5148\u5224\u65ad\u8fd9\u4e2a\u64cd\u4f5c\u662f\u5426\u8fdd\u53cd\u552f\u4e00\u6027\u7ea6\u675f\u3002\u6bd4\u5982\uff0c\u8981\u63d2\u5165(4,400)\u8fd9\u4e2a\u8bb0\u5f55\uff0c\u5c31\u8981\u5148\u5224\u65ad\u73b0\u5728\u8868\u4e2d\u662f\u5426\u5df2\u7ecf\u5b58\u5728k=4\u7684\u8bb0\u5f55\uff0c\u800c\u8fd9\u5fc5\u987b\u8981\u5c06\u6570\u636e\u9875\u8bfb\u5165\u5185\u5b58\u624d\u80fd\u5224\u65ad\u3002\u5982\u679c\u90fd\u5df2\u7ecf\u8bfb\u5165\u5230\u5185\u5b58\u4e86\uff0c\u90a3\u76f4\u63a5\u66f4\u65b0\u5185\u5b58\u4f1a\u66f4\u5feb\uff0c\u5c31\u6ca1\u5fc5\u8981\u4f7f\u7528change buffer\u4e86\u3002</p> <p>\u56e0\u6b64\uff0c\u552f\u4e00\u7d22\u5f15\u7684\u66f4\u65b0\u5c31\u4e0d\u80fd\u4f7f\u7528change buffer\uff0c\u5b9e\u9645\u4e0a\u4e5f\u53ea\u6709\u666e\u901a\u7d22\u5f15\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>change buffer\u7528\u7684\u662fbuffer pool\u91cc\u7684\u5185\u5b58\uff0c\u56e0\u6b64\u4e0d\u80fd\u65e0\u9650\u589e\u5927\u3002change buffer\u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570innodb_change_buffer_max_size\u6765\u52a8\u6001\u8bbe\u7f6e\u3002\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u4e3a50\u7684\u65f6\u5019\uff0c\u8868\u793achange buffer\u7684\u5927\u5c0f\u6700\u591a\u53ea\u80fd\u5360\u7528buffer pool\u768450%\u3002</p> <p>\u666e\u901a\u7d22\u5f15\u548c\u552f\u4e00\u7d22\u5f15\u5728\u67e5\u8be2\u80fd\u529b\u4e0a\u662f\u6ca1\u5dee\u522b\u7684\uff0c\u4e3b\u8981\u8003\u8651\u7684\u662f\u5bf9\u66f4\u65b0\u6027\u80fd\u7684\u5f71\u54cd\u3002\u6240\u4ee5\uff0c\u6211\u5efa\u8bae\u4f60\u5c3d\u91cf\u9009\u62e9\u666e\u901a\u7d22\u5f15\u3002\u666e\u901a\u7d22\u5f15\u548cchange buffer\u7684\u914d\u5408\u4f7f\u7528\uff0c\u5bf9\u4e8e\u6570\u636e\u91cf\u5927\u7684\u8868\u7684\u66f4\u65b0\u4f18\u5316\u8fd8\u662f\u5f88\u660e\u663e\u7684\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_3","title":"\u4ec0\u4e48\u662f\u5237\u810f\u9875\uff1f","text":"<p>InnoDB\u5728\u5904\u7406\u66f4\u65b0\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u53ea\u505a\u4e86\u5199\u65e5\u5fd7\u8fd9\u4e00\u4e2a\u78c1\u76d8\u64cd\u4f5c\u3002\u8fd9\u4e2a\u65e5\u5fd7\u53eb\u4f5credo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\uff0c\u4e5f\u5c31\u662f\u300a\u5b54\u4e59\u5df1\u300b\u91cc\u54b8\u4ea8\u9152\u5e97\u638c\u67dc\u7528\u6765\u8bb0\u8d26\u7684\u7c89\u677f\uff0c\u5728\u66f4\u65b0\u5185\u5b58\u5199\u5b8credo log\u540e\uff0c\u5c31\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u672c\u6b21\u66f4\u65b0\u6210\u529f\u3002</p> <p>\u505a\u4e0b\u7c7b\u6bd4\u7684\u8bdd\uff0c\u638c\u67dc\u8bb0\u8d26\u7684\u8d26\u672c\u662f\u6570\u636e\u6587\u4ef6\uff0c\u8bb0\u8d26\u7528\u7684\u7c89\u677f\u662f\u65e5\u5fd7\u6587\u4ef6\uff08redo log\uff09\uff0c\u638c\u67dc\u7684\u8bb0\u5fc6\u5c31\u662f\u5185\u5b58\u3002</p> <p>\u638c\u67dc\u603b\u8981\u627e\u65f6\u95f4\u628a\u8d26\u672c\u66f4\u65b0\u4e00\u4e0b\uff0c\u8fd9\u5bf9\u5e94\u7684\u5c31\u662f\u628a\u5185\u5b58\u91cc\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\u7684\u8fc7\u7a0b\uff0c\u672f\u8bed\u5c31\u662fflush\u3002\u5728\u8fd9\u4e2aflush\u64cd\u4f5c\u6267\u884c\u4e4b\u524d\uff0c\u5b54\u4e59\u5df1\u7684\u8d4a\u8d26\u603b\u989d\uff0c\u5176\u5b9e\u8ddf\u638c\u67dc\u624b\u4e2d\u8d26\u672c\u91cc\u9762\u7684\u8bb0\u5f55\u662f\u4e0d\u4e00\u81f4\u7684\u3002\u56e0\u4e3a\u5b54\u4e59\u5df1\u4eca\u5929\u7684\u8d4a\u8d26\u91d1\u989d\u8fd8\u53ea\u5728\u7c89\u677f\u4e0a\uff0c\u800c\u8d26\u672c\u91cc\u7684\u8bb0\u5f55\u662f\u8001\u7684\uff0c\u8fd8\u6ca1\u628a\u4eca\u5929\u7684\u8d4a\u8d26\u7b97\u8fdb\u53bb.</p> <p>\u5f53\u5185\u5b58\u6570\u636e\u9875\u8ddf\u78c1\u76d8\u6570\u636e\u9875\u5185\u5bb9\u4e0d\u4e00\u81f4\u7684\u65f6\u5019\uff0c\u6211\u4eec\u79f0\u8fd9\u4e2a\u5185\u5b58\u9875\u4e3a\u201c\u810f\u9875\u201d\u3002\u5185\u5b58\u6570\u636e\u5199\u5165\u5230\u78c1\u76d8\u540e\uff0c\u5185\u5b58\u548c\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u9875\u7684\u5185\u5bb9\u5c31\u4e00\u81f4\u4e86\uff0c\u79f0\u4e3a\u201c\u5e72\u51c0\u9875\u201d\u3002\u4e0d\u8bba\u662f\u810f\u9875\u8fd8\u662f\u5e72\u51c0\u9875\uff0c\u90fd\u5728\u5185\u5b58\u4e2d</p> <p>\u56de\u5230\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff0c\u4f60\u4e0d\u96be\u60f3\u8c61\uff0c\u5e73\u65f6\u6267\u884c\u5f88\u5feb\u7684\u66f4\u65b0\u64cd\u4f5c\uff0c\u5176\u5b9e\u5c31\u662f\u5728\u5199\u5185\u5b58\u548c\u65e5\u5fd7\uff0c\u800cMySQL\u5076\u5c14\u201c\u6296\u201d\u4e00\u4e0b\u7684\u90a3\u4e2a\u77ac\u95f4\uff0c\u53ef\u80fd\u5c31\u662f\u5728\u5237\u810f\u9875\uff08flush\uff09\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#flush","title":"\u4ec0\u4e48\u60c5\u51b5\u4f1a\u5f15\u53d1\u6570\u636e\u5e93\u7684flush\u8fc7\u7a0b\u5462\uff1f","text":"<p>\u6211\u4eec\u8fd8\u662f\u7ee7\u7eed\u7528\u54b8\u4ea8\u9152\u5e97\u638c\u67dc\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u60f3\u4e00\u60f3\uff1a\u638c\u67dc\u5728\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u628a\u7c89\u677f\u4e0a\u7684\u8d4a\u8d26\u8bb0\u5f55\u6539\u5230\u8d26\u672c\u4e0a\uff1f</p> <p>\u200b   \u2022   \u7b2c\u4e00\u79cd\u573a\u666f\u662f\uff0c\u7c89\u677f\u6ee1\u4e86\uff0c\u8bb0\u4e0d\u4e0b\u4e86\u3002\u8fd9\u65f6\u5019\u5982\u679c\u518d\u6709\u4eba\u6765\u8d4a\u8d26\uff0c\u638c\u67dc\u5c31\u53ea\u5f97\u653e\u4e0b\u624b\u91cc\u7684\u6d3b\u513f\uff0c\u5c06\u7c89\u677f\u4e0a\u7684\u8bb0\u5f55\u64e6\u6389\u4e00\u4e9b\uff0c\u7559\u51fa\u7a7a\u4f4d\u4ee5\u4fbf\u7ee7\u7eed\u8bb0\u8d26\u3002\u5f53\u7136\u5728\u64e6\u6389\u4e4b\u524d\uff0c\u4ed6\u5fc5\u987b\u5148\u5c06\u6b63\u786e\u7684\u8d26\u76ee\u8bb0\u5f55\u5230\u8d26\u672c\u4e2d\u624d\u884c\u3002 \u8fd9\u4e2a\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662fInnoDB\u7684redo log\u5199\u6ee1\u4e86\u3002\u8fd9\u65f6\u5019\u7cfb\u7edf\u4f1a\u505c\u6b62\u6240\u6709\u66f4\u65b0\u64cd\u4f5c\uff0c\u628acheckpoint\u5f80\u524d\u63a8\u8fdb\uff0credo log\u7559\u51fa\u7a7a\u95f4\u53ef\u4ee5\u7ee7\u7eed\u5199\u3002\u6211\u5728\u7b2c\u4e8c\u8bb2\u753b\u4e86\u4e00\u4e2aredo log\u7684\u793a\u610f\u56fe\uff0c\u8fd9\u91cc\u6211\u6539\u6210\u73af\u5f62\uff0c\u4fbf\u4e8e\u5927\u5bb6\u7406\u89e3\u3002</p> <p></p> <p>checkpoint\u53ef\u4e0d\u662f\u968f\u4fbf\u5f80\u524d\u4fee\u6539\u4e00\u4e0b\u4f4d\u7f6e\u5c31\u53ef\u4ee5\u7684\u3002\u6bd4\u5982\u56fe2\u4e2d\uff0c\u628acheckpoint\u4f4d\u7f6e\u4eceCP\u63a8\u8fdb\u5230CP\u2019\uff0c\u5c31\u9700\u8981\u5c06\u4e24\u4e2a\u70b9\u4e4b\u95f4\u7684\u65e5\u5fd7\uff08\u6d45\u7eff\u8272\u90e8\u5206\uff09\uff0c\u5bf9\u5e94\u7684\u6240\u6709\u810f\u9875\u90fdflush\u5230\u78c1\u76d8\u4e0a\u3002\u4e4b\u540e\uff0c\u56fe\u4e2d\u4ecewrite pos\u5230CP\u2019\u4e4b\u95f4\u5c31\u662f\u53ef\u4ee5\u518d\u5199\u5165\u7684redo log\u7684\u533a\u57df\u3002</p> <p>\u200b   \u2022   \u7b2c\u4e8c\u79cd\u573a\u666f\u662f\uff0c\u8fd9\u4e00\u5929\u751f\u610f\u592a\u597d\uff0c\u8981\u8bb0\u4f4f\u7684\u4e8b\u60c5\u592a\u591a\uff0c\u638c\u67dc\u53d1\u73b0\u81ea\u5df1\u5feb\u8bb0\u4e0d\u4f4f\u4e86\uff0c\u8d76\u7d27\u627e\u51fa\u8d26\u672c\u628a\u5b54\u4e59\u5df1\u8fd9\u7b14\u8d26\u5148\u52a0\u8fdb\u53bb\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662f\u7cfb\u7edf\u5185\u5b58\u4e0d\u8db3\u3002\u5f53\u9700\u8981\u65b0\u7684\u5185\u5b58\u9875\uff0c\u800c\u5185\u5b58\u4e0d\u591f\u7528\u7684\u65f6\u5019\uff0c\u5c31\u8981\u6dd8\u6c70\u4e00\u4e9b\u6570\u636e\u9875\uff0c\u7a7a\u51fa\u5185\u5b58\u7ed9\u522b\u7684\u6570\u636e\u9875\u4f7f\u7528\u3002\u5982\u679c\u6dd8\u6c70\u7684\u662f\u201c\u810f\u9875\u201d\uff0c\u5c31\u8981\u5148\u5c06\u810f\u9875\u5199\u5230\u78c1\u76d8\u3002 \u4f60\u4e00\u5b9a\u4f1a\u8bf4\uff0c\u8fd9\u65f6\u5019\u96be\u9053\u4e0d\u80fd\u76f4\u63a5\u628a\u5185\u5b58\u6dd8\u6c70\u6389\uff0c\u4e0b\u6b21\u9700\u8981\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u4ece\u78c1\u76d8\u8bfb\u5165\u6570\u636e\u9875\uff0c\u7136\u540e\u62ffredo log\u51fa\u6765\u5e94\u7528\u4e0d\u5c31\u884c\u4e86\uff1f\u8fd9\u91cc\u5176\u5b9e\u662f\u4ece\u6027\u80fd\u8003\u8651\u7684\u3002\u5982\u679c\u5237\u810f\u9875\u4e00\u5b9a\u4f1a\u5199\u76d8\uff0c\u5c31\u4fdd\u8bc1\u4e86\u6bcf\u4e2a\u6570\u636e\u9875\u6709\u4e24\u79cd\u72b6\u6001\uff1a</p> <p>\u200b   \u25e6   \u4e00\u79cd\u662f\u5185\u5b58\u91cc\u5b58\u5728\uff0c\u5185\u5b58\u91cc\u5c31\u80af\u5b9a\u662f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u76f4\u63a5\u8fd4\u56de\uff1b</p> <p>\u200b   \u25e6   \u53e6\u4e00\u79cd\u662f\u5185\u5b58\u91cc\u6ca1\u6709\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u80af\u5b9a\u6570\u636e\u6587\u4ef6\u4e0a\u662f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u8bfb\u5165\u5185\u5b58\u540e\u8fd4\u56de\u3002 \u8fd9\u6837\u7684\u6548\u7387\u6700\u9ad8\u3002</p> <p>\u200b   \u2022   \u7b2c\u4e09\u79cd\u573a\u666f\u662f\uff0c\u751f\u610f\u4e0d\u5fd9\u7684\u65f6\u5019\uff0c\u6216\u8005\u6253\u70ca\u4e4b\u540e\u3002\u8fd9\u65f6\u5019\u67dc\u53f0\u6ca1\u4e8b\uff0c\u638c\u67dc\u95f2\u7740\u4e5f\u662f\u95f2\u7740\uff0c\u4e0d\u5982\u66f4\u65b0\u8d26\u672c\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662fMySQL\u8ba4\u4e3a\u7cfb\u7edf\u201c\u7a7a\u95f2\u201d\u7684\u65f6\u5019\u3002\u5f53\u7136\uff0cMySQL\u201c\u8fd9\u5bb6\u9152\u5e97\u201d\u7684\u751f\u610f\u597d\u8d77\u6765\u53ef\u662f\u4f1a\u5f88\u5feb\u5c31\u80fd\u628a\u7c89\u677f\u8bb0\u6ee1\u7684\uff0c\u6240\u4ee5\u201c\u638c\u67dc\u201d\u8981\u5408\u7406\u5730\u5b89\u6392\u65f6\u95f4\uff0c\u5373\u4f7f\u662f\u201c\u751f\u610f\u597d\u201d\u7684\u65f6\u5019\uff0c\u4e5f\u8981\u89c1\u7f1d\u63d2\u9488\u5730\u627e\u65f6\u95f4\uff0c\u53ea\u8981\u6709\u673a\u4f1a\u5c31\u5237\u4e00\u70b9\u201c\u810f\u9875\u201d\u3002</p> <p>\u200b   \u2022   \u7b2c\u56db\u79cd\u573a\u666f\u662f\uff0c\u5e74\u5e95\u4e86\u54b8\u4ea8\u9152\u5e97\u8981\u5173\u95e8\u51e0\u5929\uff0c\u9700\u8981\u628a\u8d26\u7ed3\u6e05\u4e00\u4e0b\u3002\u8fd9\u65f6\u5019\u638c\u67dc\u8981\u628a\u6240\u6709\u8d26\u90fd\u8bb0\u5230\u8d26\u672c\u4e0a\uff0c\u8fd9\u6837\u8fc7\u5b8c\u5e74\u91cd\u65b0\u5f00\u5f20\u7684\u65f6\u5019\uff0c\u5c31\u80fd\u5c31\u7740\u8d26\u672c\u660e\u786e\u8d26\u76ee\u60c5\u51b5\u4e86\u3002 \u8fd9\u79cd\u573a\u666f\uff0c\u5bf9\u5e94\u7684\u5c31\u662fMySQL\u6b63\u5e38\u5173\u95ed\u7684\u60c5\u51b5\u3002\u8fd9\u65f6\u5019\uff0cMySQL\u4f1a\u628a\u5185\u5b58\u7684\u810f\u9875\u90fdflush\u5230\u78c1\u76d8\u4e0a\uff0c\u8fd9\u6837\u4e0b\u6b21MySQL\u542f\u52a8\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u78c1\u76d8\u4e0a\u8bfb\u6570\u636e\uff0c\u542f\u52a8\u901f\u5ea6\u4f1a\u5f88\u5feb\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u4f60\u53ef\u4ee5\u5206\u6790\u4e00\u4e0b\u4e0a\u9762\u56db\u79cd\u573a\u666f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u3002</p> <p>\u5176\u4e2d\uff0c\u7b2c\u4e09\u79cd\u60c5\u51b5\u662f\u5c5e\u4e8eMySQL\u7a7a\u95f2\u65f6\u7684\u64cd\u4f5c\uff0c\u8fd9\u65f6\u7cfb\u7edf\u6ca1\u4ec0\u4e48\u538b\u529b\uff0c\u800c\u7b2c\u56db\u79cd\u573a\u666f\u662f\u6570\u636e\u5e93\u672c\u6765\u5c31\u8981\u5173\u95ed\u4e86\u3002\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u4e0d\u4f1a\u592a\u5173\u6ce8\u201c\u6027\u80fd\u201d\u95ee\u9898\u3002\u6240\u4ee5\u8fd9\u91cc\uff0c\u6211\u4eec\u4e3b\u8981\u6765\u5206\u6790\u4e00\u4e0b\u524d\u4e24\u79cd\u573a\u666f\u4e0b\u7684\u6027\u80fd\u95ee\u9898\u3002</p> <p>\u7b2c\u4e00\u79cd\u662f\u201credo log\u5199\u6ee1\u4e86\uff0c\u8981flush\u810f\u9875\u201d\uff0c\u8fd9\u79cd\u60c5\u51b5\u662fInnoDB\u8981\u5c3d\u91cf\u907f\u514d\u7684\u3002\u56e0\u4e3a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u7684\u65f6\u5019\uff0c\u6574\u4e2a\u7cfb\u7edf\u5c31\u4e0d\u80fd\u518d\u63a5\u53d7\u66f4\u65b0\u4e86\uff0c\u6240\u6709\u7684\u66f4\u65b0\u90fd\u5fc5\u987b\u5835\u4f4f\u3002\u5982\u679c\u4f60\u4ece\u76d1\u63a7\u4e0a\u770b\uff0c\u8fd9\u65f6\u5019\u66f4\u65b0\u6570\u4f1a\u8dcc\u4e3a0\u3002</p> <p>\u7b2c\u4e8c\u79cd\u662f\u201c\u5185\u5b58\u4e0d\u591f\u7528\u4e86\uff0c\u8981\u5148\u5c06\u810f\u9875\u5199\u5230\u78c1\u76d8\u201d\uff0c\u8fd9\u79cd\u60c5\u51b5\u5176\u5b9e\u662f\u5e38\u6001\u3002InnoDB\u7528\u7f13\u51b2\u6c60\uff08buffer pool\uff09\u7ba1\u7406\u5185\u5b58\uff0c\u7f13\u51b2\u6c60\u4e2d\u7684\u5185\u5b58\u9875\u6709\u4e09\u79cd\u72b6\u6001\uff1a</p> <p>\u200b   \u2022   \u7b2c\u4e00\u79cd\u662f\uff0c\u8fd8\u6ca1\u6709\u4f7f\u7528\u7684\uff1b</p> <p>\u200b   \u2022   \u7b2c\u4e8c\u79cd\u662f\uff0c\u4f7f\u7528\u4e86\u5e76\u4e14\u662f\u5e72\u51c0\u9875\uff1b</p> <p>\u200b   \u2022   \u7b2c\u4e09\u79cd\u662f\uff0c\u4f7f\u7528\u4e86\u5e76\u4e14\u662f\u810f\u9875\u3002</p> <p>InnoDB\u7684\u7b56\u7565\u662f\u5c3d\u91cf\u4f7f\u7528\u5185\u5b58\uff0c\u56e0\u6b64\u5bf9\u4e8e\u4e00\u4e2a\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u5e93\u6765\u8bf4\uff0c\u672a\u88ab\u4f7f\u7528\u7684\u9875\u9762\u5f88\u5c11\u3002</p> <p>\u800c\u5f53\u8981\u8bfb\u5165\u7684\u6570\u636e\u9875\u6ca1\u6709\u5728\u5185\u5b58\u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u5230\u7f13\u51b2\u6c60\u4e2d\u7533\u8bf7\u4e00\u4e2a\u6570\u636e\u9875\u3002\u8fd9\u65f6\u5019\u53ea\u80fd\u628a\u6700\u4e45\u4e0d\u4f7f\u7528\u7684\u6570\u636e\u9875\u4ece\u5185\u5b58\u4e2d\u6dd8\u6c70\u6389\uff1a\u5982\u679c\u8981\u6dd8\u6c70\u7684\u662f\u4e00\u4e2a\u5e72\u51c0\u9875\uff0c\u5c31\u76f4\u63a5\u91ca\u653e\u51fa\u6765\u590d\u7528\uff1b\u4f46\u5982\u679c\u662f\u810f\u9875\u5462\uff0c\u5c31\u5fc5\u987b\u5c06\u810f\u9875\u5148\u5237\u5230\u78c1\u76d8\uff0c\u53d8\u6210\u5e72\u51c0\u9875\u540e\u624d\u80fd\u590d\u7528\u3002</p> <p>\u6240\u4ee5\uff0c\u5237\u810f\u9875\u867d\u7136\u662f\u5e38\u6001\uff0c\u4f46\u662f\u51fa\u73b0\u4ee5\u4e0b\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u90fd\u662f\u4f1a\u660e\u663e\u5f71\u54cd\u6027\u80fd\u7684\uff1a</p> <p>\u200b   1.  \u4e00\u4e2a\u67e5\u8be2\u8981\u6dd8\u6c70\u7684\u810f\u9875\u4e2a\u6570\u592a\u591a\uff0c\u4f1a\u5bfc\u81f4\u67e5\u8be2\u7684\u54cd\u5e94\u65f6\u95f4\u660e\u663e\u53d8\u957f\uff1b</p> <p>\u200b   2.  \u65e5\u5fd7\u5199\u6ee1\uff0c\u66f4\u65b0\u5168\u90e8\u5835\u4f4f\uff0c\u5199\u6027\u80fd\u8dcc\u4e3a0\uff0c\u8fd9\u79cd\u60c5\u51b5\u5bf9\u654f\u611f\u4e1a\u52a1\u6765\u8bf4\uff0c\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002</p> <p>\u6240\u4ee5\uff0cInnoDB\u9700\u8981\u6709\u63a7\u5236\u810f\u9875\u6bd4\u4f8b\u7684\u673a\u5236\uff0c\u6765\u5c3d\u91cf\u907f\u514d\u4e0a\u9762\u7684\u8fd9\u4e24\u79cd\u60c5\u51b5\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#innodb","title":"InnoDB\u5237\u810f\u9875\u7684\u63a7\u5236\u7b56\u7565","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u5c31\u6765\u548c\u4f60\u8bf4\u8bf4InnoDB\u810f\u9875\u7684\u63a7\u5236\u7b56\u7565\uff0c\u4ee5\u53ca\u548c\u8fd9\u4e9b\u7b56\u7565\u76f8\u5173\u7684\u53c2\u6570\u3002</p> <p>\u9996\u5148\uff0c\u4f60\u8981\u6b63\u786e\u5730\u544a\u8bc9InnoDB\u6240\u5728\u4e3b\u673a\u7684IO\u80fd\u529b\uff0c\u8fd9\u6837InnoDB\u624d\u80fd\u77e5\u9053\u9700\u8981\u5168\u529b\u5237\u810f\u9875\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5237\u591a\u5feb\u3002</p> <p>\u8fd9\u5c31\u8981\u7528\u5230innodb_io_capacity\u8fd9\u4e2a\u53c2\u6570\u4e86\uff0c\u5b83\u4f1a\u544a\u8bc9InnoDB\u4f60\u7684\u78c1\u76d8\u80fd\u529b\u3002\u8fd9\u4e2a\u503c\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210\u78c1\u76d8\u7684IOPS\u3002\u78c1\u76d8\u7684IOPS\u53ef\u4ee5\u901a\u8fc7fio\u8fd9\u4e2a\u5de5\u5177\u6765\u6d4b\u8bd5\uff0c\u4e0b\u9762\u7684\u8bed\u53e5\u662f\u6211\u7528\u6765\u6d4b\u8bd5\u78c1\u76d8\u968f\u673a\u8bfb\u5199\u7684\u547d\u4ee4\uff1a</p> <pre><code> fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest \n</code></pre> <p>\u5176\u5b9e\uff0c\u56e0\u4e3a\u6ca1\u80fd\u6b63\u786e\u5730\u8bbe\u7f6einnodb_io_capacity\u53c2\u6570\uff0c\u800c\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u4e5f\u6bd4\u6bd4\u7686\u662f\u3002\u4e4b\u524d\uff0c\u5c31\u66fe\u6709\u5176\u4ed6\u516c\u53f8\u7684\u5f00\u53d1\u8d1f\u8d23\u4eba\u627e\u6211\u770b\u4e00\u4e2a\u5e93\u7684\u6027\u80fd\u95ee\u9898\uff0c\u8bf4MySQL\u7684\u5199\u5165\u901f\u5ea6\u5f88\u6162\uff0cTPS\u5f88\u4f4e\uff0c\u4f46\u662f\u6570\u636e\u5e93\u4e3b\u673a\u7684IO\u538b\u529b\u5e76\u4e0d\u5927\u3002\u7ecf\u8fc7\u4e00\u756a\u6392\u67e5\uff0c\u53d1\u73b0\u7f6a\u9b41\u7978\u9996\u5c31\u662f\u8fd9\u4e2a\u53c2\u6570\u7684\u8bbe\u7f6e\u51fa\u4e86\u95ee\u9898\u3002</p> <p>\u4ed6\u7684\u4e3b\u673a\u78c1\u76d8\u7528\u7684\u662fSSD\uff0c\u4f46\u662finnodb_io_capacity\u7684\u503c\u8bbe\u7f6e\u7684\u662f300\u3002\u4e8e\u662f\uff0cInnoDB\u8ba4\u4e3a\u8fd9\u4e2a\u7cfb\u7edf\u7684\u80fd\u529b\u5c31\u8fd9\u4e48\u5dee\uff0c\u6240\u4ee5\u5237\u810f\u9875\u5237\u5f97\u7279\u522b\u6162\uff0c\u751a\u81f3\u6bd4\u810f\u9875\u751f\u6210\u7684\u901f\u5ea6\u8fd8\u6162\uff0c\u8fd9\u6837\u5c31\u9020\u6210\u4e86\u810f\u9875\u7d2f\u79ef\uff0c\u5f71\u54cd\u4e86\u67e5\u8be2\u548c\u66f4\u65b0\u6027\u80fd\u3002</p> <p>\u867d\u7136\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u5b9a\u4e49\u4e86\u201c\u5168\u529b\u5237\u810f\u9875\u201d\u7684\u884c\u4e3a\uff0c\u4f46\u5e73\u65f6\u603b\u4e0d\u80fd\u4e00\u76f4\u662f\u5168\u529b\u5237\u5427\uff1f\u6bd5\u7adf\u78c1\u76d8\u80fd\u529b\u4e0d\u80fd\u53ea\u7528\u6765\u5237\u810f\u9875\uff0c\u8fd8\u9700\u8981\u670d\u52a1\u7528\u6237\u8bf7\u6c42\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4e00\u8d77\u770b\u770bInnoDB\u600e\u4e48\u63a7\u5236\u5f15\u64ce\u6309\u7167\u201c\u5168\u529b\u201d\u7684\u767e\u5206\u6bd4\u6765\u5237\u810f\u9875\u3002</p> <p>\u6839\u636e\u6211\u524d\u9762\u63d0\u5230\u7684\u77e5\u8bc6\u70b9\uff0c\u8bd5\u60f3\u4e00\u4e0b\uff0c\u5982\u679c\u4f60\u6765\u8bbe\u8ba1\u7b56\u7565\u63a7\u5236\u5237\u810f\u9875\u7684\u901f\u5ea6\uff0c\u4f1a\u53c2\u8003\u54ea\u4e9b\u56e0\u7d20\u5462\uff1f</p> <p>\u8fd9\u4e2a\u95ee\u9898\u53ef\u4ee5\u8fd9\u4e48\u60f3\uff0c\u5982\u679c\u5237\u592a\u6162\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\uff1f\u9996\u5148\u662f\u5185\u5b58\u810f\u9875\u592a\u591a\uff0c\u5176\u6b21\u662fredo log\u5199\u6ee1\u3002</p> <p>\u6240\u4ee5\uff0cInnoDB\u7684\u5237\u76d8\u901f\u5ea6\u5c31\u662f\u8981\u53c2\u8003\u8fd9\u4e24\u4e2a\u56e0\u7d20\uff1a\u4e00\u4e2a\u662f\u810f\u9875\u6bd4\u4f8b\uff0c\u4e00\u4e2a\u662fredo log\u5199\u76d8\u901f\u5ea6\u3002</p> <p>InnoDB\u4f1a\u6839\u636e\u8fd9\u4e24\u4e2a\u56e0\u7d20\u5148\u5355\u72ec\u7b97\u51fa\u4e24\u4e2a\u6570\u5b57\u3002</p> <p>\u53c2\u6570innodb_max_dirty_pages_pct\u662f\u810f\u9875\u6bd4\u4f8b\u4e0a\u9650\uff0c\u9ed8\u8ba4\u503c\u662f75%\u3002InnoDB\u4f1a\u6839\u636e\u5f53\u524d\u7684\u810f\u9875\u6bd4\u4f8b\uff08\u5047\u8bbe\u4e3aM\uff09\uff0c\u7b97\u51fa\u4e00\u4e2a\u8303\u56f4\u57280\u5230100\u4e4b\u95f4\u7684\u6570\u5b57\uff0c\u8ba1\u7b97\u8fd9\u4e2a\u6570\u5b57\u7684\u4f2a\u4ee3\u7801\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <pre><code>F1(M)\n\n{\n\n if M&gt;=innodb_max_dirty_pages_pct then\n\n   return 100;\n\n return 100*M/innodb_max_dirty_pages_pct;\n\n}\n</code></pre> <p>InnoDB\u6bcf\u6b21\u5199\u5165\u7684\u65e5\u5fd7\u90fd\u6709\u4e00\u4e2a\u5e8f\u53f7\uff0c\u5f53\u524d\u5199\u5165\u7684\u5e8f\u53f7\u8ddfcheckpoint\u5bf9\u5e94\u7684\u5e8f\u53f7\u4e4b\u95f4\u7684\u5dee\u503c\uff0c\u6211\u4eec\u5047\u8bbe\u4e3aN\u3002InnoDB\u4f1a\u6839\u636e\u8fd9\u4e2aN\u7b97\u51fa\u4e00\u4e2a\u8303\u56f4\u57280\u5230100\u4e4b\u95f4\u7684\u6570\u5b57\uff0c\u8fd9\u4e2a\u8ba1\u7b97\u516c\u5f0f\u53ef\u4ee5\u8bb0\u4e3aF2(N)\u3002F2(N)\u7b97\u6cd5\u6bd4\u8f83\u590d\u6742\uff0c\u4f60\u53ea\u8981\u77e5\u9053N\u8d8a\u5927\uff0c\u7b97\u51fa\u6765\u7684\u503c\u8d8a\u5927\u5c31\u597d\u4e86\u3002</p> <p>\u7136\u540e\uff0c\u6839\u636e\u4e0a\u8ff0\u7b97\u5f97\u7684F1(M)\u548cF2(N)\u4e24\u4e2a\u503c\uff0c\u53d6\u5176\u4e2d\u8f83\u5927\u7684\u503c\u8bb0\u4e3aR\uff0c\u4e4b\u540e\u5f15\u64ce\u5c31\u53ef\u4ee5\u6309\u7167innodb_io_capacity\u5b9a\u4e49\u7684\u80fd\u529b\u4e58\u4ee5R%\u6765\u63a7\u5236\u5237\u810f\u9875\u7684\u901f\u5ea6\u3002</p> <p>\u4e0a\u8ff0\u7684\u8ba1\u7b97\u6d41\u7a0b\u6bd4\u8f83\u62bd\u8c61\uff0c\u4e0d\u5bb9\u6613\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u753b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u6d41\u7a0b\u56fe\u3002\u56fe\u4e2d\u7684F1\u3001F2\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u810f\u9875\u6bd4\u4f8b\u548credo log\u5199\u5165\u901f\u5ea6\u7b97\u51fa\u6765\u7684\u4e24\u4e2a\u503c\u3002</p> <p></p> <p>\u73b0\u5728\u4f60\u77e5\u9053\u4e86\uff0cInnoDB\u4f1a\u5728\u540e\u53f0\u5237\u810f\u9875\uff0c\u800c\u5237\u810f\u9875\u7684\u8fc7\u7a0b\u662f\u8981\u5c06\u5185\u5b58\u9875\u5199\u5165\u78c1\u76d8\u3002\u6240\u4ee5\uff0c\u65e0\u8bba\u662f\u4f60\u7684\u67e5\u8be2\u8bed\u53e5\u5728\u9700\u8981\u5185\u5b58\u7684\u65f6\u5019\u53ef\u80fd\u8981\u6c42\u6dd8\u6c70\u4e00\u4e2a\u810f\u9875\uff0c\u8fd8\u662f\u7531\u4e8e\u5237\u810f\u9875\u7684\u903b\u8f91\u4f1a\u5360\u7528IO\u8d44\u6e90\u5e76\u53ef\u80fd\u5f71\u54cd\u5230\u4e86\u4f60\u7684\u66f4\u65b0\u8bed\u53e5\uff0c\u90fd\u53ef\u80fd\u662f\u9020\u6210\u4f60\u4ece\u4e1a\u52a1\u7aef\u611f\u77e5\u5230MySQL\u201c\u6296\u201d\u4e86\u4e00\u4e0b\u7684\u539f\u56e0\u3002</p> <p>\u8981\u5c3d\u91cf\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f60\u5c31\u8981\u5408\u7406\u5730\u8bbe\u7f6einnodb_io_capacity\u7684\u503c\uff0c\u5e76\u4e14\u5e73\u65f6\u8981\u591a\u5173\u6ce8\u810f\u9875\u6bd4\u4f8b\uff0c\u4e0d\u8981\u8ba9\u5b83\u7ecf\u5e38\u63a5\u8fd175%\u3002</p> <p>\u5176\u4e2d\uff0c\u810f\u9875\u6bd4\u4f8b\u662f\u901a\u8fc7Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total\u5f97\u5230\u7684\uff0c\u5177\u4f53\u7684\u547d\u4ee4\u53c2\u8003\u4e0b\u9762\u7684\u4ee3\u7801\uff1a</p> <pre><code>mysql&gt; select VARIABLE_VALUE into @a from global_status where VARIABLE_NAME = 'Innodb_buffer_pool_pages_dirty';\n\nselect VARIABLE_VALUE into @b from global_status where VARIABLE_NAME = 'Innodb_buffer_pool_pages_total';\n\nselect @a/@b;\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e2a\u6709\u8da3\u7684\u7b56\u7565\u3002</p> <p>\u4e00\u65e6\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u9700\u8981\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5148flush\u6389\u4e00\u4e2a\u810f\u9875\u65f6\uff0c\u8fd9\u4e2a\u67e5\u8be2\u5c31\u53ef\u80fd\u8981\u6bd4\u5e73\u65f6\u6162\u4e86\u3002\u800cMySQL\u4e2d\u7684\u4e00\u4e2a\u673a\u5236\uff0c\u53ef\u80fd\u8ba9\u4f60\u7684\u67e5\u8be2\u4f1a\u66f4\u6162\uff1a\u5728\u51c6\u5907\u5237\u4e00\u4e2a\u810f\u9875\u7684\u65f6\u5019\uff0c\u5982\u679c\u8fd9\u4e2a\u6570\u636e\u9875\u65c1\u8fb9\u7684\u6570\u636e\u9875\u521a\u597d\u662f\u810f\u9875\uff0c\u5c31\u4f1a\u628a\u8fd9\u4e2a\u201c\u90bb\u5c45\u201d\u4e5f\u5e26\u7740\u4e00\u8d77\u5237\u6389\uff1b\u800c\u4e14\u8fd9\u4e2a\u628a\u201c\u90bb\u5c45\u201d\u62d6\u4e0b\u6c34\u7684\u903b\u8f91\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u8513\u5ef6\uff0c\u4e5f\u5c31\u662f\u5bf9\u4e8e\u6bcf\u4e2a\u90bb\u5c45\u6570\u636e\u9875\uff0c\u5982\u679c\u8ddf\u5b83\u76f8\u90bb\u7684\u6570\u636e\u9875\u4e5f\u8fd8\u662f\u810f\u9875\u7684\u8bdd\uff0c\u4e5f\u4f1a\u88ab\u653e\u5230\u4e00\u8d77\u5237\u3002</p> <p>\u5728InnoDB\u4e2d\uff0cinnodb_flush_neighbors \u53c2\u6570\u5c31\u662f\u7528\u6765\u63a7\u5236\u8fd9\u4e2a\u884c\u4e3a\u7684\uff0c\u503c\u4e3a1\u7684\u65f6\u5019\u4f1a\u6709\u4e0a\u8ff0\u7684\u201c\u8fde\u5750\u201d\u673a\u5236\uff0c\u503c\u4e3a0\u65f6\u8868\u793a\u4e0d\u627e\u90bb\u5c45\uff0c\u81ea\u5df1\u5237\u81ea\u5df1\u7684\u3002</p> <p>\u627e\u201c\u90bb\u5c45\u201d\u8fd9\u4e2a\u4f18\u5316\u5728\u673a\u68b0\u786c\u76d8\u65f6\u4ee3\u662f\u5f88\u6709\u610f\u4e49\u7684\uff0c\u53ef\u4ee5\u51cf\u5c11\u5f88\u591a\u968f\u673aIO\u3002\u673a\u68b0\u786c\u76d8\u7684\u968f\u673aIOPS\u4e00\u822c\u53ea\u6709\u51e0\u767e\uff0c\u76f8\u540c\u7684\u903b\u8f91\u64cd\u4f5c\u51cf\u5c11\u968f\u673aIO\u5c31\u610f\u5473\u7740\u7cfb\u7edf\u6027\u80fd\u7684\u5927\u5e45\u5ea6\u63d0\u5347\u3002</p> <p>\u800c\u5982\u679c\u4f7f\u7528\u7684\u662fSSD\u8fd9\u7c7bIOPS\u6bd4\u8f83\u9ad8\u7684\u8bbe\u5907\u7684\u8bdd\uff0c\u6211\u5c31\u5efa\u8bae\u4f60\u628ainnodb_flush_neighbors\u7684\u503c\u8bbe\u7f6e\u62100\u3002\u56e0\u4e3a\u8fd9\u65f6\u5019IOPS\u5f80\u5f80\u4e0d\u662f\u74f6\u9888\uff0c\u800c\u201c\u53ea\u5237\u81ea\u5df1\u201d\uff0c\u5c31\u80fd\u66f4\u5feb\u5730\u6267\u884c\u5b8c\u5fc5\u8981\u7684\u5237\u810f\u9875\u64cd\u4f5c\uff0c\u51cf\u5c11SQL\u8bed\u53e5\u54cd\u5e94\u65f6\u95f4\u3002</p> <p>\u5728MySQL 8.0\u4e2d\uff0cinnodb_flush_neighbors\u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u5df2\u7ecf\u662f0\u4e86\u3002</p>"},{"location":"database/05-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_4","title":"\u5c0f\u7ed3","text":"<p>\u4eca\u5929\u8fd9\u7bc7\u6587\u7ae0\uff0c\u5ef6\u7eed\u7b2c2\u7bc7\u4e2d\u4ecb\u7ecd\u7684WAL\u7684\u6982\u5ff5\uff0c\u548c\u4f60\u89e3\u91ca\u4e86\u8fd9\u4e2a\u673a\u5236\u540e\u7eed\u9700\u8981\u7684\u5237\u810f\u9875\u64cd\u4f5c\u548c\u6267\u884c\u65f6\u673a\u3002\u5229\u7528WAL\u6280\u672f\uff0c\u6570\u636e\u5e93\u5c06\u968f\u673a\u5199\u8f6c\u6362\u6210\u4e86\u987a\u5e8f\u5199\uff0c\u5927\u5927\u63d0\u5347\u4e86\u6570\u636e\u5e93\u7684\u6027\u80fd\u3002</p> <p>\u4f46\u662f\uff0c\u7531\u6b64\u4e5f\u5e26\u6765\u4e86\u5185\u5b58\u810f\u9875\u7684\u95ee\u9898\u3002\u810f\u9875\u4f1a\u88ab\u540e\u53f0\u7ebf\u7a0b\u81ea\u52a8flush\uff0c\u4e5f\u4f1a\u7531\u4e8e\u6570\u636e\u9875\u6dd8\u6c70\u800c\u89e6\u53d1flush\uff0c\u800c\u5237\u810f\u9875\u7684\u8fc7\u7a0b\u7531\u4e8e\u4f1a\u5360\u7528\u8d44\u6e90\uff0c\u53ef\u80fd\u4f1a\u8ba9\u4f60\u7684\u66f4\u65b0\u548c\u67e5\u8be2\u8bed\u53e5\u7684\u54cd\u5e94\u65f6\u95f4\u957f\u4e00\u4e9b\u3002\u5728\u6587\u7ae0\u91cc\uff0c\u6211\u4e5f\u7ed9\u4f60\u4ecb\u7ecd\u4e86\u63a7\u5236\u5237\u810f\u9875\u7684\u65b9\u6cd5\u548c\u5bf9\u5e94\u7684\u76d1\u63a7\u65b9\u5f0f\u3002</p>"},{"location":"database/06-%E4%BA%8B%E5%8A%A1/","title":"mysql\u7684\u4e8b\u52a1","text":"<p>\u4e8b\u52a1\u7684\u56db\u4e2a\u7279\u5f81ACID\uff1a\u539f\u5b50\u6027\uff0c\u4e00\u81f4\u6027\uff0c\u6301\u4e45\u6027\uff0c\u9694\u79bb\u6027\u3002</p>"},{"location":"database/06-%E4%BA%8B%E5%8A%A1/#_1","title":"\u4e8b\u52a1\u7684\u539f\u5b50\u6027\u548c\u6301\u4e45\u6027","text":"<p>\u539f\u5b50\u6027\u5c31\u7531undolog\u65e5\u5fd7\u6765\u4fdd\u8bc1\uff0c\u8bb0\u5f55\u4e86\u5982\u679c\u53d1\u751f\u9519\u8bef\u9700\u8981\u56de\u6eda\u7684\u65e5\u5fd7\u4fe1\u606f\u3002</p> <p>\u6301\u4e45\u6027\u7531redolog\u6765\u4fdd\u8bc1\uff0c\u5c31\u7b97\u6570\u636e\u6ca1\u6709\u4fdd\u5b58\u6210\u529f\uff0c\u53ea\u8981redolog\u65e5\u5fd7\u6587\u4ef6\u5728\u6570\u636e\u5c31\u4e0d\u4f1a\u4e22\u5931\u3002</p> <p>innoDB\u4e3a\u4e86\u63d0\u5347\u8bfb\u5199\u6548\u7387\uff0c\u5f15\u5165\u4e86\u7f13\u5b58\u6c60\uff0c\u5411\u6570\u636e\u5e93\u5199\u5165\u6570\u636e\u65f6\u4f1a\u5148\u5199\u5165\u7f13\u5b58\u6c60\uff0c\u8bfb\u4e5f\u4e00\u6837\uff0c\u7136\u540e\u5b9a\u671f\u5c06\u7f13\u5b58\u6c60\u4e2d\u7684\u6570\u636e\u5237\u65b0\u5230\u78c1\u76d8\u3002\u8fd9\u6837\u6709\u4e2a\u95ee\u9898\uff0c\u5982\u679cMySQL\u5b95\u673a\uff0c\u7f13\u5b58\u6c60\u4e2d\u66f4\u65b0\u7684\u6570\u636e\u8fd8\u6ca1\u5237\u5230\u78c1\u76d8\u4e0a\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u3002\u4e8e\u662f\u5f15\u5165redoLog\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u5148\u5c06\u539f\u59cb\u6570\u636e\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u5185\u5b58\u4e2d\u6765\uff0c\u4fee\u6539\u6570\u636e\u7684\u5185\u5b58\u62f7\u8d1d\u3002</li> <li>\u751f\u6210\u4e00\u6761\u91cd\u505a\u65e5\u5fd7\u5e76\u5199\u5165redo log buffer\uff0c\u8bb0\u5f55\u7684\u662f\u6570\u636e\u88ab\u4fee\u6539\u540e\u7684\u503c\u3002</li> <li>\u5f53\u4e8b\u52a1commit\u65f6\uff0c\u5c06redo log buffer\u4e2d\u7684\u5185\u5bb9\u901a\u8fc7\u8ffd\u52a0\u5199\u7684\u65b9\u5f0f\u5237\u65b0\u5230\u786c\u76d8redo log file\u4e2d</li> <li>\u5b9a\u671f\u5c06\u5185\u5b58\u4e2d\u4fee\u6539\u7684\u6570\u636e\u5237\u65b0\u5230\u78c1\u76d8\u4e2d</li> </ol> <p></p> <p>\u5177\u4f53\u4ece\u4e00\u4e2a\u4f8b\u5b50\u6765\u770b\u4e0b\u5982\u4f55\u4ea4\u4e92\uff1a</p> <p></p>"},{"location":"database/06-%E4%BA%8B%E5%8A%A1/#_2","title":"\u4e8b\u52a1\u7684\u9694\u79bb\u6027","text":"<p>\u591a\u4e2a\u4e8b\u52a1\u5728\u5e76\u53d1\u60c5\u51b5\u4e0b\u4f1a\u4e92\u76f8\u5e72\u6270\uff0c\u5e26\u6765\u4e00\u4e9b\u95ee\u9898\u3002MySQL\u662f\u5229\u7528MVCC\uff08\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff09\u548c\u9501\u6765\u4fdd\u8bc1\u4e8b\u52a1\u7684\u9694\u79bb\u6027\u3002</p> <p>\u9694\u79bb\u7ea7\u522b\u6709\u4ee5\u4e0b\u56db\u79cd\uff1a</p> <ul> <li>READ_UNCOMMITTED \u672a\u63d0\u4ea4\u8bfb</li> </ul> <pre><code>    A constant indicating that dirty reads and non-repeatable reads are\n  * prevented; phantom reads can occur. This level prohibits a transaction\n  * from reading a row with uncommitted changes in it, and it also prohibits\n  * the situation where one transaction reads a row, a second transaction\n  * alters the row, and the first transaction rereads the row, getting\n  * different values the second time (a \"non-repeatable read\").\n</code></pre> <ul> <li>READ_COMMITTED \u5df2\u63d0\u4ea4\u8bfb    </li> </ul> <pre><code>/**\n* A constant indicating that\n* dirty reads are prevented; non-repeatable reads and phantom\n* reads can occur.  This level only prohibits a transaction\n* from reading a row with uncommitted changes in it.\n*/\n</code></pre> <ul> <li>REPEATABLE_READ \u53ef\u91cd\u590d\u8bfb</li> </ul> <pre><code>/**\n* A constant indicating that\n* dirty reads and non-repeatable reads are prevented; phantom\n* reads can occur.  This level prohibits a transaction from\n* reading a row with uncommitted changes in it, and it also\n* prohibits the situation where one transaction reads a row,\n* a second transaction alters the row, and the first transaction\n* rereads the row, getting different values the second time\n* (a \"non-repeatable read\").\n*/\n</code></pre> <p>\u4f46\u662fmysql\u5728\u53ef\u91cd\u590d\u8bfb\u7ea7\u522b\u4e0b\uff0c\u7ed3\u5408next-key\u9501\u907f\u514d\u4e86\u5e7b\u8bfb\u7684\u53d1\u751f\uff0c\u9762\u8bd5\u88ab\u95ee\u5230\u8fc7\uff01</p> <ul> <li>SERIALIZABLE \u4e32\u884c\u5316</li> </ul> <pre><code>/**\n* A constant indicating that\n* dirty reads, non-repeatable reads and phantom reads are prevented.\n* This level includes the prohibitions in\n* &lt;code&gt;TRANSACTION_REPEATABLE_READ&lt;/code&gt; and further prohibits the\n* situation where one transaction reads all rows that satisfy\n* a &lt;code&gt;WHERE&lt;/code&gt; condition, a second transaction inserts a row that\n* satisfies that &lt;code&gt;WHERE&lt;/code&gt; condition, and the first transaction\n* rereads for the same condition, retrieving the additional\n* \"phantom\" row in the second read.\n*/\n</code></pre> <p>\u5e7b\u8bfb\u548c\u4e0d\u53ef\u91cd\u590d\u8bfb\u76f8\u4f3c\u5bb9\u6613\u6df7\u6dc6\uff0c\u4e0d\u53ef\u91cd\u590d\u8bfb\u6307\u7684\u662f\u53e6\u4e00\u4e2a\u4e8b\u52a1\u4fee\u6539\uff08 alters the row\uff09\u4e86\u67d0\u884c\u7684\u6570\u636e\uff0c\u5bfc\u81f4\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u4e24\u6b21\u67e5\u8be2\u7684\u7ed3\u679c\u4e0d\u3002\u5e7b\u8bfb\u6307\u7684\u662f\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u76f8\u540c\u67e5\u8be2\u6761\u4ef6\u7684\u67e5\u8be2\u884c\u6570\uff0c\u53e6\u4e00\u4e2a\u4e8b\u52a1\u589e\u52a0\u67d0\u884c\uff08inserts a row\uff09\uff0c\u5bfc\u81f4\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u4e24\u6b21\u67e5\u8be2\u7684\u7ed3\u679c\u4e0d\u540c\u3002</p> <p>\u4e0b\u9762\u662f\u6f14\u793aRC\u7ea7\u522b\u4e0b\uff0c\u4e0d\u53ef\u91cd\u590d\u7684\u95ee\u9898</p> <p></p> <p>\u5728\u5b9e\u73b0\u4e0a\uff0c\u6570\u636e\u5e93\u91cc\u9762\u4f1a\u521b\u5efa\u4e00\u4e2a\u89c6\u56fe\uff0c\u8bbf\u95ee\u7684\u65f6\u5019\u4ee5\u89c6\u56fe\u7684\u903b\u8f91\u7ed3\u679c\u4e3a\u51c6\u3002\u5728\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u5728\u4e8b\u52a1\u542f\u52a8\u65f6\u521b\u5efa\u7684\uff0c\u6574\u4e2a\u4e8b\u52a1\u5b58\u5728\u671f\u95f4\u90fd\u7528\u8fd9\u4e2a\u89c6\u56fe\u3002\u5728\u201c\u8bfb\u63d0\u4ea4\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u5728\u6bcf\u4e2aSQL\u8bed\u53e5\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\u521b\u5efa\u7684\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u201c\u8bfb\u672a\u63d0\u4ea4\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\u76f4\u63a5\u8fd4\u56de\u8bb0\u5f55\u4e0a\u7684\u6700\u65b0\u503c\uff0c\u6ca1\u6709\u89c6\u56fe\u6982\u5ff5\uff1b\u800c\u201c\u4e32\u884c\u5316\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\u76f4\u63a5\u7528\u52a0\u9501\u7684\u65b9\u5f0f\u6765\u907f\u514d\u5e76\u884c\u8bbf\u95ee\u3002</p> <p>\u53ef\u91cd\u590d\u8bfb\u7684\u5b9a\u4e49\uff0c\u4e00\u4e2a\u4e8b\u52a1\u542f\u52a8\u7684\u65f6\u5019\uff0c\u80fd\u591f\u770b\u5230\u6240\u6709\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\u7ed3\u679c\u3002\u4f46\u662f\u4e4b\u540e\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u6267\u884c\u671f\u95f4\uff0c\u5176\u4ed6\u4e8b\u52a1\u7684\u66f4\u65b0\u5bf9\u5b83\u4e0d\u53ef\u89c1\u3002 \u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1\u5728\u542f\u52a8\u7684\u65f6\u5019\u5c31\u201c\u62cd\u4e86\u4e2a\u5feb\u7167\u201d\u3002\u6ce8\u610f\uff0c\u8fd9\u4e2a\u5feb\u7167\u662f\u57fa\u4e8e\u6574\u5e93\u7684</p> <p>\u5728\u5b9e\u73b0\u4e0a\uff0c InnoDB\u4e3a\u6bcf\u4e2a\u4e8b\u52a1\u6784\u9020\u4e86\u4e00\u4e2a\u6570\u7ec4\uff0c\u7528\u6765\u4fdd\u5b58\u8fd9\u4e2a\u4e8b\u52a1\u542f\u52a8\u77ac\u95f4\uff0c\u5f53\u524d\u6b63\u5728\u201c\u6d3b\u8dc3\u201d\u7684\u6240\u6709\u4e8b\u52a1ID\u3002\u201c\u6d3b\u8dc3\u201d\u6307\u7684\u5c31\u662f\uff0c\u542f\u52a8\u4e86\u4f46\u8fd8\u6ca1\u63d0\u4ea4\u3002\u89c6\u56fe\u6570\u7ec4\u628a\u6240\u6709\u7684row trx_id \u5206\u6210\u4e86\u51e0\u79cd\u4e0d\u540c\u7684\u60c5\u51b5</p> <p>InnoDB\u7684\u884c\u6570\u636e\u6709\u591a\u4e2a\u7248\u672c\uff0c\u6bcf\u4e2a\u6570\u636e\u7248\u672c\u6709\u81ea\u5df1\u7684row trx_id\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u6216\u8005\u8bed\u53e5\u6709\u81ea\u5df1\u7684\u4e00\u81f4\u6027\u89c6\u56fe\u3002\u666e\u901a\u67e5\u8be2\u8bed\u53e5\u662f\u4e00\u81f4\u6027\u8bfb\uff0c\u4e00\u81f4\u6027\u8bfb\u4f1a\u6839\u636erow trx_id\u548c\u4e00\u81f4\u6027\u89c6\u56fe\u786e\u5b9a\u6570\u636e\u7248\u672c\u7684\u53ef\u89c1\u6027\u3002 \u2022\u5bf9\u4e8e\u53ef\u91cd\u590d\u8bfb\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u4e8b\u52a1\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b \u2022\u5bf9\u4e8e\u8bfb\u63d0\u4ea4\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u8bed\u53e5\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b \u800c\u5f53\u524d\u8bfb\uff0c\u603b\u662f\u8bfb\u53d6\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6700\u65b0\u7248\u672c\u3002</p>"},{"location":"database/06-%E4%BA%8B%E5%8A%A1/#mvcc","title":"MVCC","text":"<p>\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff1a\u8bfb\u53d6\u6570\u636e\u7684\u65f6\u5019\u901a\u8fc7\u4e00\u79cd\u7c7b\u4f3c\u5feb\u7167\u7684\u65b9\u5f0f\u628a\u6570\u636e\u4fdd\u5b58\u4e0b\u6765\uff0c\u4e0d\u540c\u7684\u4e8b\u52a1\u53ea\u80fd\u770b\u5230\u7279\u5b9a\u7248\u672c\u7684\u6570\u636e\u3002MVCC\u53ea\u5728\u8bfb\u5df2\u63d0\u4ea4\u548c\u53ef\u91cd\u590d\u8bfb\u4e24\u4e2a\u9694\u79bb\u7ea7\u522b\u4e0b\u5b58\u5728\uff0c\u672a\u63d0\u4ea4\u8bfb\u603b\u662f\u8bfb\u53d6\u6700\u65b0\u7684\u6570\u636e\uff0c\u4e32\u884c\u5316\u4f1a\u5bf9\u6240\u6709\u884c\u8bb0\u5f55\u52a0\u9501\u3002</p> <p>\u805a\u96c6\u7d22\u5f15\u4e2d\uff0c\u6bcf\u884c\u8bb0\u5f55\u6709\u4e24\u4e2a\u9690\u85cf\u5217\uff1a</p> <ul> <li> <p>trx_id\uff1a\u5b58\u50a8\u6bcf\u6b21\u5bf9\u6bcf\u6761\u805a\u96c6\u7d22\u5f15\u8bb0\u5f55\u8fdb\u884c\u4fee\u6539\u65f6\u7684\u4e8b\u52a1id</p> </li> <li> <p>roll_pointer\uff1a\u662f\u4e00\u4e2a\u6307\u9488\uff0c\u6307\u5411undo\u65e5\u5fd7\u4e2d\u8fd9\u6761\u8bb0\u5f55\u7684\u4e0a\u4e00\u4e2a\u4e8b\u52a1\u7248\u672c\uff0c\u4ece\u800c\u5f62\u6210\u4e00\u4e2a\u7248\u672c\u94fe\u3002\uff08\u63d2\u5165\u64cd\u4f5c\u662f\u6ca1\u6709undo\u65e5\u5fd7\u7684\uff0c\u56e0\u4e3a\u6ca1\u6709\u4e0a\u4e00\u6761\uff0c\u53e6\u5916\u4f1a\u5728\u6ca1\u6709\u5f15\u7528\u6307\u5411\u65f6\u624d\u4f1a\u5220\u9664\uff09</p> </li> </ul> <p>\u201c\u5feb\u7167\u201d\u5728MVCC\u91cc\u662f\u600e\u4e48\u5de5\u4f5c\u7684\uff1f</p> <p>\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1\u5728\u542f\u52a8\u7684\u65f6\u5019\u5c31\u201c\u62cd\u4e86\u4e2a\u5feb\u7167\u201d\u3002\u6ce8\u610f\uff0c\u8fd9\u4e2a\u5feb\u7167\u662f\u57fa\u4e8e\u6574\u5e93\u7684\u3002</p> <p>\u8fd9\u65f6\uff0c\u4f60\u4f1a\u8bf4\u8fd9\u770b\u4e0a\u53bb\u4e0d\u592a\u73b0\u5b9e\u554a\u3002\u5982\u679c\u4e00\u4e2a\u5e93\u6709100G\uff0c\u90a3\u4e48\u6211\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0cMySQL\u5c31\u8981\u62f7\u8d1d100G\u7684\u6570\u636e\u51fa\u6765\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5f97\u591a\u6162\u554a\u3002\u53ef\u662f\uff0c\u6211\u5e73\u65f6\u7684\u4e8b\u52a1\u6267\u884c\u8d77\u6765\u5f88\u5feb\u554a\u3002\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u62f7\u8d1d\u51fa\u8fd9100G\u7684\u6570\u636e\u3002\u6211\u4eec\u5148\u6765\u770b\u770b\u8fd9\u4e2a\u5feb\u7167\u662f\u600e\u4e48\u5b9e\u73b0\u7684\u3002</p> <p>InnoDB\u91cc\u9762\u6bcf\u4e2a\u4e8b\u52a1\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u4e8b\u52a1ID\uff0c\u53eb\u4f5ctransaction id\u3002\u5b83\u662f\u5728\u4e8b\u52a1\u5f00\u59cb\u7684\u65f6\u5019\u5411InnoDB\u7684\u4e8b\u52a1\u7cfb\u7edf\u7533\u8bf7\u7684\uff0c\u662f\u6309\u7533\u8bf7\u987a\u5e8f\u4e25\u683c\u9012\u589e\u7684\u3002</p> <p>\u800c\u6bcf\u884c\u6570\u636e\u4e5f\u90fd\u662f\u6709\u591a\u4e2a\u7248\u672c\u7684\u3002\u6bcf\u6b21\u4e8b\u52a1\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u7248\u672c\uff0c\u5e76\u4e14\u628atransaction id\u8d4b\u503c\u7ed9\u8fd9\u4e2a\u6570\u636e\u7248\u672c\u7684\u4e8b\u52a1ID\uff0c\u8bb0\u4e3arow trx_id\u3002\u540c\u65f6\uff0c\u65e7\u7684\u6570\u636e\u7248\u672c\u8981\u4fdd\u7559\uff0c\u5e76\u4e14\u5728\u65b0\u7684\u6570\u636e\u7248\u672c\u4e2d\uff0c\u80fd\u591f\u6709\u4fe1\u606f\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230\u5b83\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6570\u636e\u8868\u4e2d\u7684\u4e00\u884c\u8bb0\u5f55\uff0c\u5176\u5b9e\u53ef\u80fd\u6709\u591a\u4e2a\u7248\u672c(row)\uff0c\u6bcf\u4e2a\u7248\u672c\u6709\u81ea\u5df1\u7684row trx_id\u3002</p> <p>\u5982\u56fe2\u6240\u793a\uff0c\u5c31\u662f\u4e00\u4e2a\u8bb0\u5f55\u88ab\u591a\u4e2a\u4e8b\u52a1\u8fde\u7eed\u66f4\u65b0\u540e\u7684\u72b6\u6001\u3002</p> <p></p> <p>\u56fe\u4e2d\u865a\u7ebf\u6846\u91cc\u662f\u540c\u4e00\u884c\u6570\u636e\u76844\u4e2a\u7248\u672c\uff0c\u5f53\u524d\u6700\u65b0\u7248\u672c\u662fV4\uff0ck\u7684\u503c\u662f22\uff0c\u5b83\u662f\u88abtransaction id \u4e3a25\u7684\u4e8b\u52a1\u66f4\u65b0\u7684\uff0c\u56e0\u6b64\u5b83\u7684row trx_id\u4e5f\u662f25\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u95ee\uff0c\u524d\u9762\u7684\u6587\u7ae0\u4e0d\u662f\u8bf4\uff0c\u8bed\u53e5\u66f4\u65b0\u4f1a\u751f\u6210undo log\uff08\u56de\u6eda\u65e5\u5fd7\uff09\u5417\uff1f\u90a3\u4e48\uff0cundo log\u5728\u54ea\u5462\uff1f</p> <p>\u5b9e\u9645\u4e0a\uff0c\u56fe2\u4e2d\u7684\u4e09\u4e2a\u865a\u7ebf\u7bad\u5934\uff0c\u5c31\u662fundo log\uff1b\u800cV1\u3001V2\u3001V3\u5e76\u4e0d\u662f\u7269\u7406\u4e0a\u771f\u5b9e\u5b58\u5728\u7684\uff0c\u800c\u662f\u6bcf\u6b21\u9700\u8981\u7684\u65f6\u5019\u6839\u636e\u5f53\u524d\u7248\u672c\u548cundo log\u8ba1\u7b97\u51fa\u6765\u7684\u3002\u6bd4\u5982\uff0c\u9700\u8981V2\u7684\u65f6\u5019\uff0c\u5c31\u662f\u901a\u8fc7V4\u4f9d\u6b21\u6267\u884cU3\u3001U2\u7b97\u51fa\u6765\u3002</p> <p>\u660e\u767d\u4e86\u591a\u7248\u672c\u548crow trx_id\u7684\u6982\u5ff5\u540e\uff0c\u6211\u4eec\u518d\u6765\u60f3\u4e00\u4e0b\uff0cInnoDB\u662f\u600e\u4e48\u5b9a\u4e49\u90a3\u4e2a\u201c100G\u201d\u7684\u5feb\u7167\u7684\u3002</p> <p>\u6309\u7167\u53ef\u91cd\u590d\u8bfb\u7684\u5b9a\u4e49\uff0c\u4e00\u4e2a\u4e8b\u52a1\u542f\u52a8\u7684\u65f6\u5019\uff0c\u80fd\u591f\u770b\u5230\u6240\u6709\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\u7ed3\u679c\u3002\u4f46\u662f\u4e4b\u540e\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u6267\u884c\u671f\u95f4\uff0c\u5176\u4ed6\u4e8b\u52a1\u7684\u66f4\u65b0\u5bf9\u5b83\u4e0d\u53ef\u89c1\u3002</p> <p>\u56e0\u6b64\uff0c\u4e00\u4e2a\u4e8b\u52a1\u53ea\u9700\u8981\u5728\u542f\u52a8\u7684\u65f6\u5019\u58f0\u660e\u8bf4\uff0c\u201c\u4ee5\u6211\u542f\u52a8\u7684\u65f6\u523b\u4e3a\u51c6\uff0c\u5982\u679c\u4e00\u4e2a\u6570\u636e\u7248\u672c\u662f\u5728\u6211\u542f\u52a8\u4e4b\u524d\u751f\u6210\u7684\uff0c\u5c31\u8ba4\uff1b\u5982\u679c\u662f\u6211\u542f\u52a8\u4ee5\u540e\u624d\u751f\u6210\u7684\uff0c\u6211\u5c31\u4e0d\u8ba4\uff0c\u6211\u5fc5\u987b\u8981\u627e\u5230\u5b83\u7684\u4e0a\u4e00\u4e2a\u7248\u672c\u201d\u3002</p> <p>\u5f53\u7136\uff0c\u5982\u679c\u201c\u4e0a\u4e00\u4e2a\u7248\u672c\u201d\u4e5f\u4e0d\u53ef\u89c1\uff0c\u90a3\u5c31\u5f97\u7ee7\u7eed\u5f80\u524d\u627e\u3002\u8fd8\u6709\uff0c\u5982\u679c\u662f\u8fd9\u4e2a\u4e8b\u52a1\u81ea\u5df1\u66f4\u65b0\u7684\u6570\u636e\uff0c\u5b83\u81ea\u5df1\u8fd8\u662f\u8981\u8ba4\u7684\u3002</p> <p>\u5728\u5b9e\u73b0\u4e0a\uff0c InnoDB\u4e3a\u6bcf\u4e2a\u4e8b\u52a1\u6784\u9020\u4e86\u4e00\u4e2a\u6570\u7ec4\uff0c\u7528\u6765\u4fdd\u5b58\u8fd9\u4e2a\u4e8b\u52a1\u542f\u52a8\u77ac\u95f4\uff0c\u5f53\u524d\u6b63\u5728\u201c\u6d3b\u8dc3\u201d\u7684\u6240\u6709\u4e8b\u52a1ID\u3002\u201c\u6d3b\u8dc3\u201d\u6307\u7684\u5c31\u662f\uff0c\u542f\u52a8\u4e86\u4f46\u8fd8\u6ca1\u63d0\u4ea4\u3002</p> <p>\u6570\u7ec4\u91cc\u9762\u4e8b\u52a1ID\u7684\u6700\u5c0f\u503c\u8bb0\u4e3a\u4f4e\u6c34\u4f4d\uff0c\u5f53\u524d\u7cfb\u7edf\u91cc\u9762\u5df2\u7ecf\u521b\u5efa\u8fc7\u7684\u4e8b\u52a1ID\u7684\u6700\u5927\u503c\u52a01\u8bb0\u4e3a\u9ad8\u6c34\u4f4d\u3002</p> <p>\u8fd9\u4e2a\u89c6\u56fe\u6570\u7ec4\u548c\u9ad8\u6c34\u4f4d\uff0c\u5c31\u7ec4\u6210\u4e86\u5f53\u524d\u4e8b\u52a1\u7684\u4e00\u81f4\u6027\u89c6\u56fe\uff08read-view\uff09\u3002</p> <p>\u800c\u6570\u636e\u7248\u672c\u7684\u53ef\u89c1\u6027\u89c4\u5219\uff0c\u5c31\u662f\u57fa\u4e8e\u6570\u636e\u7684row trx_id\u548c\u8fd9\u4e2a\u4e00\u81f4\u6027\u89c6\u56fe\u7684\u5bf9\u6bd4\u7ed3\u679c\u5f97\u5230\u7684\u3002</p> <p>\u8fd9\u4e2a\u89c6\u56fe\u6570\u7ec4\u628a\u6240\u6709\u7684row trx_id \u5206\u6210\u4e86\u51e0\u79cd\u4e0d\u540c\u7684\u60c5\u51b5\u3002</p> <p></p> <p>\u8fd9\u6837\uff0c\u5bf9\u4e8e\u5f53\u524d\u4e8b\u52a1\u7684\u542f\u52a8\u77ac\u95f4\u6765\u8bf4\uff0c\u4e00\u4e2a\u6570\u636e\u7248\u672c\u7684row trx_id\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u53ef\u80fd\uff1a</p> <p>\u200b   1.  \u5982\u679c\u843d\u5728\u7eff\u8272\u90e8\u5206\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u5df2\u63d0\u4ea4\u7684\u4e8b\u52a1\u6216\u8005\u662f\u5f53\u524d\u4e8b\u52a1\u81ea\u5df1\u751f\u6210\u7684\uff0c\u8fd9\u4e2a\u6570\u636e\u662f\u53ef\u89c1\u7684\uff1b</p> <pre><code>2.  \u5982\u679c\u843d\u5728\u7ea2\u8272\u90e8\u5206\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u7531\u5c06\u6765\u542f\u52a8\u7684\u4e8b\u52a1\u751f\u6210\u7684\uff0c\u662f\u80af\u5b9a\u4e0d\u53ef\u89c1\u7684\uff1b\n3.  \u5982\u679c\u843d\u5728\u9ec4\u8272\u90e8\u5206\uff0c\u90a3\u5c31\u5305\u62ec\u4e24\u79cd\u60c5\u51b5\n     a. \u82e5 row trx_id\u5728\u6570\u7ec4\u4e2d\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u7531\u8fd8\u6ca1\u63d0\u4ea4\u7684\u4e8b\u52a1\u751f\u6210\u7684\uff0c\u4e0d\u53ef\u89c1\uff1b\n    b. \u82e5 row trx_id\u4e0d\u5728\u6570\u7ec4\u4e2d\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u5df2\u7ecf\u63d0\u4ea4\u4e86\u7684\u4e8b\u52a1\u751f\u6210\u7684\uff0c\u53ef\u89c1\u3002\n</code></pre> <p>\u6bd4\u5982\uff0c\u5bf9\u4e8e\u56fe2\u4e2d\u7684\u6570\u636e\u6765\u8bf4\uff0c\u5982\u679c\u6709\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5b83\u7684\u4f4e\u6c34\u4f4d\u662f18\uff0c\u90a3\u4e48\u5f53\u5b83\u8bbf\u95ee\u8fd9\u4e00\u884c\u6570\u636e\u65f6\uff0c\u5c31\u4f1a\u4eceV4\u901a\u8fc7U3\u8ba1\u7b97\u51faV3\uff0c\u6240\u4ee5\u5728\u5b83\u770b\u6765\uff0c\u8fd9\u4e00\u884c\u7684\u503c\u662f11\u3002</p> <p>\u4f60\u770b\uff0c\u6709\u4e86\u8fd9\u4e2a\u58f0\u660e\u540e\uff0c\u7cfb\u7edf\u91cc\u9762\u968f\u540e\u53d1\u751f\u7684\u66f4\u65b0\uff0c\u662f\u4e0d\u662f\u5c31\u8ddf\u8fd9\u4e2a\u4e8b\u52a1\u770b\u5230\u7684\u5185\u5bb9\u65e0\u5173\u4e86\u5462\uff1f\u56e0\u4e3a\u4e4b\u540e\u7684\u66f4\u65b0\uff0c\u751f\u6210\u7684\u7248\u672c\u4e00\u5b9a\u5c5e\u4e8e\u4e0a\u9762\u76842\u6216\u80053(a)\u7684\u60c5\u51b5\uff0c\u800c\u5bf9\u5b83\u6765\u8bf4\uff0c\u8fd9\u4e9b\u65b0\u7684\u6570\u636e\u7248\u672c\u662f\u4e0d\u5b58\u5728\u7684\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4e8b\u52a1\u7684\u5feb\u7167\uff0c\u5c31\u662f\u201c\u9759\u6001\u201d\u7684\u4e86\u3002</p> <p>\u6240\u4ee5\u4f60\u73b0\u5728\u77e5\u9053\u4e86\uff0cInnoDB\u5229\u7528\u4e86\u201c\u6240\u6709\u6570\u636e\u90fd\u6709\u591a\u4e2a\u7248\u672c\u201d\u7684\u8fd9\u4e2a\u7279\u6027\uff0c\u5b9e\u73b0\u4e86\u201c\u79d2\u7ea7\u521b\u5efa\u5feb\u7167\u201d\u7684\u80fd\u529b\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7ee7\u7eed\u770b\u4e00\u4e0b\u56fe1\u4e2d\u7684\u4e09\u4e2a\u4e8b\u52a1\uff0c\u5206\u6790\u4e0b\u4e8b\u52a1A\u7684\u8bed\u53e5\u8fd4\u56de\u7684\u7ed3\u679c\uff0c\u4e3a\u4ec0\u4e48\u662fk=1\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u4e0d\u59a8\u505a\u5982\u4e0b\u5047\u8bbe\uff1a</p> <p>\u200b   1.  \u4e8b\u52a1A\u5f00\u59cb\u524d\uff0c\u7cfb\u7edf\u91cc\u9762\u53ea\u6709\u4e00\u4e2a\u6d3b\u8dc3\u4e8b\u52a1ID\u662f99\uff1b</p> <p>\u200b   2.  \u4e8b\u52a1A\u3001B\u3001C\u7684\u7248\u672c\u53f7\u5206\u522b\u662f100\u3001101\u3001102\uff0c\u4e14\u5f53\u524d\u7cfb\u7edf\u91cc\u53ea\u6709\u8fd9\u56db\u4e2a\u4e8b\u52a1\uff1b</p> <p>\u200b   3.  \u4e09\u4e2a\u4e8b\u52a1\u5f00\u59cb\u524d\uff0c(1,1\uff09\u8fd9\u4e00\u884c\u6570\u636e\u7684row trx_id\u662f90\u3002</p> <p>\u8fd9\u6837\uff0c\u4e8b\u52a1A\u7684\u89c6\u56fe\u6570\u7ec4\u5c31\u662f[99,100], \u4e8b\u52a1B\u7684\u89c6\u56fe\u6570\u7ec4\u662f[99,100,101], \u4e8b\u52a1C\u7684\u89c6\u56fe\u6570\u7ec4\u662f[99,100,101,102]\u3002</p> <p>\u4e3a\u4e86\u7b80\u5316\u5206\u6790\uff0c\u6211\u5148\u628a\u5176\u4ed6\u5e72\u6270\u8bed\u53e5\u53bb\u6389\uff0c\u53ea\u753b\u51fa\u8ddf\u4e8b\u52a1A\u67e5\u8be2\u903b\u8f91\u6709\u5173\u7684\u64cd\u4f5c\uff1a</p> <p></p> <p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u7b2c\u4e00\u4e2a\u6709\u6548\u66f4\u65b0\u662f\u4e8b\u52a1C\uff0c\u628a\u6570\u636e\u4ece(1,1)\u6539\u6210\u4e86(1,2)\u3002\u8fd9\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u7684\u6700\u65b0\u7248\u672c\u7684row trx_id\u662f102\uff0c\u800c90\u8fd9\u4e2a\u7248\u672c\u5df2\u7ecf\u6210\u4e3a\u4e86\u5386\u53f2\u7248\u672c\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u6709\u6548\u66f4\u65b0\u662f\u4e8b\u52a1B\uff0c\u628a\u6570\u636e\u4ece(1,2)\u6539\u6210\u4e86(1,3)\u3002\u8fd9\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u7684\u6700\u65b0\u7248\u672c\uff08\u5373row trx_id\uff09\u662f101\uff0c\u800c102\u53c8\u6210\u4e3a\u4e86\u5386\u53f2\u7248\u672c\u3002</p> <p>\u4f60\u53ef\u80fd\u6ce8\u610f\u5230\u4e86\uff0c\u5728\u4e8b\u52a1A\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u4e8b\u52a1B\u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u4f46\u662f\u5b83\u751f\u6210\u7684(1,3)\u8fd9\u4e2a\u7248\u672c\u5df2\u7ecf\u53d8\u6210\u5f53\u524d\u7248\u672c\u4e86\u3002\u4f46\u8fd9\u4e2a\u7248\u672c\u5bf9\u4e8b\u52a1A\u5fc5\u987b\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u5426\u5219\u5c31\u53d8\u6210\u810f\u8bfb\u4e86\u3002</p> <p>\u597d\uff0c\u73b0\u5728\u4e8b\u52a1A\u8981\u6765\u8bfb\u6570\u636e\u4e86\uff0c\u5b83\u7684\u89c6\u56fe\u6570\u7ec4\u662f[99,100]\u3002\u5f53\u7136\u4e86\uff0c\u8bfb\u6570\u636e\u90fd\u662f\u4ece\u5f53\u524d\u7248\u672c\u8bfb\u8d77\u7684\u3002\u6240\u4ee5\uff0c\u4e8b\u52a1A\u67e5\u8be2\u8bed\u53e5\u7684\u8bfb\u6570\u636e\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <p>\u200b   \u2022   \u627e\u5230(1,3)\u7684\u65f6\u5019\uff0c\u5224\u65ad\u51farow trx_id=101\uff0c\u6bd4\u9ad8\u6c34\u4f4d\u5927\uff0c\u5904\u4e8e\u7ea2\u8272\u533a\u57df\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   \u2022   \u63a5\u7740\uff0c\u627e\u5230\u4e0a\u4e00\u4e2a\u5386\u53f2\u7248\u672c\uff0c\u4e00\u770brow trx_id=102\uff0c\u6bd4\u9ad8\u6c34\u4f4d\u5927\uff0c\u5904\u4e8e\u7ea2\u8272\u533a\u57df\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   \u2022   \u518d\u5f80\u524d\u627e\uff0c\u7ec8\u4e8e\u627e\u5230\u4e86\uff081,1)\uff0c\u5b83\u7684row trx_id=90\uff0c\u6bd4\u4f4e\u6c34\u4f4d\u5c0f\uff0c\u5904\u4e8e\u7eff\u8272\u533a\u57df\uff0c\u53ef\u89c1\u3002</p> <p>\u8fd9\u6837\u6267\u884c\u4e0b\u6765\uff0c\u867d\u7136\u671f\u95f4\u8fd9\u4e00\u884c\u6570\u636e\u88ab\u4fee\u6539\u8fc7\uff0c\u4f46\u662f\u4e8b\u52a1A\u4e0d\u8bba\u5728\u4ec0\u4e48\u65f6\u5019\u67e5\u8be2\uff0c\u770b\u5230\u8fd9\u884c\u6570\u636e\u7684\u7ed3\u679c\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u79f0\u4e4b\u4e3a\u4e00\u81f4\u6027\u8bfb\u3002</p> <p>\u8fd9\u4e2a\u5224\u65ad\u89c4\u5219\u662f\u4ece\u4ee3\u7801\u903b\u8f91\u76f4\u63a5\u8f6c\u8bd1\u8fc7\u6765\u7684\uff0c\u4f46\u662f\u6b63\u5982\u4f60\u6240\u89c1\uff0c\u7528\u4e8e\u4eba\u8089\u5206\u6790\u53ef\u89c1\u6027\u5f88\u9ebb\u70e6\u3002</p> <p>\u6240\u4ee5\uff0c\u6211\u6765\u7ed9\u4f60\u7ffb\u8bd1\u4e00\u4e0b\u3002\u4e00\u4e2a\u6570\u636e\u7248\u672c\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u4e8b\u52a1\u89c6\u56fe\u6765\u8bf4\uff0c\u9664\u4e86\u81ea\u5df1\u7684\u66f4\u65b0\u603b\u662f\u53ef\u89c1\u4ee5\u5916\uff0c\u6709\u4e09\u79cd\u60c5\u51b5\uff1a</p> <p>\u200b   1.  \u7248\u672c\u672a\u63d0\u4ea4\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   2.  \u7248\u672c\u5df2\u63d0\u4ea4\uff0c\u4f46\u662f\u662f\u5728\u89c6\u56fe\u521b\u5efa\u540e\u63d0\u4ea4\u7684\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   3.  \u7248\u672c\u5df2\u63d0\u4ea4\uff0c\u800c\u4e14\u662f\u5728\u89c6\u56fe\u521b\u5efa\u524d\u63d0\u4ea4\u7684\uff0c\u53ef\u89c1\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u7528\u8fd9\u4e2a\u89c4\u5219\u6765\u5224\u65ad\u56fe4\u4e2d\u7684\u67e5\u8be2\u7ed3\u679c\uff0c\u4e8b\u52a1A\u7684\u67e5\u8be2\u8bed\u53e5\u7684\u89c6\u56fe\u6570\u7ec4\u662f\u5728\u4e8b\u52a1A\u542f\u52a8\u7684\u65f6\u5019\u751f\u6210\u7684\uff0c\u8fd9\u65f6\u5019\uff1a</p> <p>\u200b   \u2022   (1,3)\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u5c5e\u4e8e\u60c5\u51b51\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   \u2022   (1,2)\u867d\u7136\u63d0\u4ea4\u4e86\uff0c\u4f46\u662f\u662f\u5728\u89c6\u56fe\u6570\u7ec4\u521b\u5efa\u4e4b\u540e\u63d0\u4ea4\u7684\uff0c\u5c5e\u4e8e\u60c5\u51b52\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   \u2022   (1,1)\u662f\u5728\u89c6\u56fe\u6570\u7ec4\u521b\u5efa\u4e4b\u524d\u63d0\u4ea4\u7684\uff0c\u53ef\u89c1\u3002</p> <p>\u4f60\u770b\uff0c\u53bb\u6389\u6570\u5b57\u5bf9\u6bd4\u540e\uff0c\u53ea\u7528\u65f6\u95f4\u5148\u540e\u987a\u5e8f\u6765\u5224\u65ad\uff0c\u5206\u6790\u8d77\u6765\u662f\u4e0d\u662f\u8f7b\u677e\u591a\u4e86\u3002\u6240\u4ee5\uff0c\u540e\u9762\u6211\u4eec\u5c31\u90fd\u7528\u8fd9\u4e2a\u89c4\u5219\u6765\u5206\u6790\u3002</p> <p>\u66f4\u65b0\u903b\u8f91</p> <p>\u7ec6\u5fc3\u7684\u540c\u5b66\u53ef\u80fd\u6709\u7591\u95ee\u4e86\uff1a\u4e8b\u52a1B\u7684update\u8bed\u53e5\uff0c\u5982\u679c\u6309\u7167\u4e00\u81f4\u6027\u8bfb\uff0c\u597d\u50cf\u7ed3\u679c\u4e0d\u5bf9\u54e6\uff1f</p> <p>\u4f60\u770b\u56fe5\u4e2d\uff0c\u4e8b\u52a1B\u7684\u89c6\u56fe\u6570\u7ec4\u662f\u5148\u751f\u6210\u7684\uff0c\u4e4b\u540e\u4e8b\u52a1C\u624d\u63d0\u4ea4\uff0c\u4e0d\u662f\u5e94\u8be5\u770b\u4e0d\u89c1(1,2)\u5417\uff0c\u600e\u4e48\u80fd\u7b97\u51fa(1,3)\u6765\uff1f</p> <p></p> <p>\u662f\u7684\uff0c\u5982\u679c\u4e8b\u52a1B\u5728\u66f4\u65b0\u4e4b\u524d\u67e5\u8be2\u4e00\u6b21\u6570\u636e\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fd4\u56de\u7684k\u7684\u503c\u786e\u5b9e\u662f1\u3002</p> <p>\u4f46\u662f\uff0c\u5f53\u5b83\u8981\u53bb\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u5c31\u4e0d\u80fd\u518d\u5728\u5386\u53f2\u7248\u672c\u4e0a\u66f4\u65b0\u4e86\uff0c\u5426\u5219\u4e8b\u52a1C\u7684\u66f4\u65b0\u5c31\u4e22\u5931\u4e86\u3002\u56e0\u6b64\uff0c\u4e8b\u52a1B\u6b64\u65f6\u7684set k=k+1\u662f\u5728\uff081,2\uff09\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u7684\u64cd\u4f5c\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u91cc\u5c31\u7528\u5230\u4e86\u8fd9\u6837\u4e00\u6761\u89c4\u5219\uff1a\u66f4\u65b0\u6570\u636e\u90fd\u662f\u5148\u8bfb\u540e\u5199\u7684\uff0c\u800c\u8fd9\u4e2a\u8bfb\uff0c\u53ea\u80fd\u8bfb\u5f53\u524d\u7684\u503c\uff0c\u79f0\u4e3a\u201c\u5f53\u524d\u8bfb\u201d\uff08current read\uff09\u3002</p> <p>\u56e0\u6b64\uff0c\u5728\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u5f53\u524d\u8bfb\u62ff\u5230\u7684\u6570\u636e\u662f(1,2)\uff0c\u66f4\u65b0\u540e\u751f\u6210\u4e86\u65b0\u7248\u672c\u7684\u6570\u636e(1,3)\uff0c\u8fd9\u4e2a\u65b0\u7248\u672c\u7684row trx_id\u662f101\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u6267\u884c\u4e8b\u52a1B\u67e5\u8be2\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u4e00\u770b\u81ea\u5df1\u7684\u7248\u672c\u53f7\u662f101\uff0c\u6700\u65b0\u6570\u636e\u7684\u7248\u672c\u53f7\u4e5f\u662f101\uff0c\u662f\u81ea\u5df1\u7684\u66f4\u65b0\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u67e5\u8be2\u5f97\u5230\u7684k\u7684\u503c\u662f3\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u63d0\u5230\u4e86\u4e00\u4e2a\u6982\u5ff5\uff0c\u53eb\u4f5c\u5f53\u524d\u8bfb\u3002\u5176\u5b9e\uff0c\u9664\u4e86update\u8bed\u53e5\u5916\uff0cselect\u8bed\u53e5\u5982\u679c\u52a0\u9501\uff0c\u4e5f\u662f\u5f53\u524d\u8bfb\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u628a\u4e8b\u52a1A\u7684\u67e5\u8be2\u8bed\u53e5select * from t where id=1\u4fee\u6539\u4e00\u4e0b\uff0c\u52a0\u4e0alock in share mode \u6216 for update\uff0c\u4e5f\u90fd\u53ef\u4ee5\u8bfb\u5230\u7248\u672c\u53f7\u662f101\u7684\u6570\u636e\uff0c\u8fd4\u56de\u7684k\u7684\u503c\u662f3\u3002\u4e0b\u9762\u8fd9\u4e24\u4e2aselect\u8bed\u53e5\uff0c\u5c31\u662f\u5206\u522b\u52a0\u4e86\u8bfb\u9501\uff08S\u9501\uff0c\u5171\u4eab\u9501\uff09\u548c\u5199\u9501\uff08X\u9501\uff0c\u6392\u4ed6\u9501\uff09\u3002</p> <p>mysql&gt; select k from t where id=1 lock in share mode;</p> <p>mysql&gt; select k from t where id=1 for update;</p> <p>\u518d\u5f80\u524d\u4e00\u6b65\uff0c\u5047\u8bbe\u4e8b\u52a1C\u4e0d\u662f\u9a6c\u4e0a\u63d0\u4ea4\u7684\uff0c\u800c\u662f\u53d8\u6210\u4e86\u4e0b\u9762\u7684\u4e8b\u52a1C\u2019\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f</p> <p></p> <p>\u4e8b\u52a1C\u2019\u7684\u4e0d\u540c\u662f\uff0c\u66f4\u65b0\u540e\u5e76\u6ca1\u6709\u9a6c\u4e0a\u63d0\u4ea4\uff0c\u5728\u5b83\u63d0\u4ea4\u524d\uff0c\u4e8b\u52a1B\u7684\u66f4\u65b0\u8bed\u53e5\u5148\u53d1\u8d77\u4e86\u3002\u524d\u9762\u8bf4\u8fc7\u4e86\uff0c\u867d\u7136\u4e8b\u52a1C\u2019\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u4f46\u662f(1,2)\u8fd9\u4e2a\u7248\u672c\u4e5f\u5df2\u7ecf\u751f\u6210\u4e86\uff0c\u5e76\u4e14\u662f\u5f53\u524d\u7684\u6700\u65b0\u7248\u672c\u3002\u90a3\u4e48\uff0c\u4e8b\u52a1B\u7684\u66f4\u65b0\u8bed\u53e5\u4f1a\u600e\u4e48\u5904\u7406\u5462\uff1f</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u201c\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u201d\u5c31\u8981\u4e0a\u573a\u4e86\u3002\u4e8b\u52a1C\u2019\u6ca1\u63d0\u4ea4\uff0c\u4e5f\u5c31\u662f\u8bf4(1,2)\u8fd9\u4e2a\u7248\u672c\u4e0a\u7684\u5199\u9501\u8fd8\u6ca1\u91ca\u653e\u3002\u800c\u4e8b\u52a1B\u662f\u5f53\u524d\u8bfb\uff0c\u5fc5\u987b\u8981\u8bfb\u6700\u65b0\u7248\u672c\uff0c\u800c\u4e14\u5fc5\u987b\u52a0\u9501\uff0c\u56e0\u6b64\u5c31\u88ab\u9501\u4f4f\u4e86\uff0c\u5fc5\u987b\u7b49\u5230\u4e8b\u52a1C\u2019\u91ca\u653e\u8fd9\u4e2a\u9501\uff0c\u624d\u80fd\u7ee7\u7eed\u5b83\u7684\u5f53\u524d\u8bfb\u3002</p> <p></p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u628a\u4e00\u81f4\u6027\u8bfb\u3001\u5f53\u524d\u8bfb\u548c\u884c\u9501\u5c31\u4e32\u8d77\u6765\u4e86\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u518d\u56de\u5230\u6587\u7ae0\u5f00\u5934\u7684\u95ee\u9898\uff1a\u4e8b\u52a1\u7684\u53ef\u91cd\u590d\u8bfb\u7684\u80fd\u529b\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1f</p> <p>\u53ef\u91cd\u590d\u8bfb\u7684\u6838\u5fc3\u5c31\u662f\u4e00\u81f4\u6027\u8bfb\uff08consistent read\uff09\uff1b\u800c\u4e8b\u52a1\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u7528\u5f53\u524d\u8bfb\u3002\u5982\u679c\u5f53\u524d\u7684\u8bb0\u5f55\u7684\u884c\u9501\u88ab\u5176\u4ed6\u4e8b\u52a1\u5360\u7528\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u8fdb\u5165\u9501\u7b49\u5f85\u3002</p> <p>\u800c\u8bfb\u63d0\u4ea4\u7684\u903b\u8f91\u548c\u53ef\u91cd\u590d\u8bfb\u7684\u903b\u8f91\u7c7b\u4f3c\uff0c\u5b83\u4eec\u6700\u4e3b\u8981\u7684\u533a\u522b\u662f\uff1a</p> <p>\u200b   \u2022   \u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u53ea\u9700\u8981\u5728\u4e8b\u52a1\u5f00\u59cb\u7684\u65f6\u5019\u521b\u5efa\u4e00\u81f4\u6027\u89c6\u56fe\uff0c\u4e4b\u540e\u4e8b\u52a1\u91cc\u7684\u5176\u4ed6\u67e5\u8be2\u90fd\u5171\u7528\u8fd9\u4e2a\u4e00\u81f4\u6027\u89c6\u56fe\uff1b</p> <p>\u200b   \u2022   \u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u6bcf\u4e00\u4e2a\u8bed\u53e5\u6267\u884c\u524d\u90fd\u4f1a\u91cd\u65b0\u7b97\u51fa\u4e00\u4e2a\u65b0\u7684\u89c6\u56fe\u3002</p> <p>\u90a3\u4e48\uff0c\u6211\u4eec\u518d\u770b\u4e00\u4e0b\uff0c\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1A\u548c\u4e8b\u52a1B\u7684\u67e5\u8be2\u8bed\u53e5\u67e5\u5230\u7684k\uff0c\u5206\u522b\u5e94\u8be5\u662f\u591a\u5c11\u5462\uff1f</p> <p>\u8fd9\u91cc\u9700\u8981\u8bf4\u660e\u4e00\u4e0b\uff0c\u201cstart transaction with consistent snapshot; \u201d\u7684\u610f\u601d\u662f\u4ece\u8fd9\u4e2a\u8bed\u53e5\u5f00\u59cb\uff0c\u521b\u5efa\u4e00\u4e2a\u6301\u7eed\u6574\u4e2a\u4e8b\u52a1\u7684\u4e00\u81f4\u6027\u5feb\u7167\u3002\u6240\u4ee5\uff0c\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u7528\u6cd5\u5c31\u6ca1\u610f\u4e49\u4e86\uff0c\u7b49\u6548\u4e8e\u666e\u901a\u7684start transaction\u3002</p> <p>\u4e0b\u9762\u662f\u8bfb\u63d0\u4ea4\u65f6\u7684\u72b6\u6001\u56fe\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u4e24\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u521b\u5efa\u89c6\u56fe\u6570\u7ec4\u7684\u65f6\u673a\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u5c31\u662f\u56fe\u4e2d\u7684read view\u6846\u3002\uff08\u6ce8\u610f\uff1a\u8fd9\u91cc\uff0c\u6211\u4eec\u7528\u7684\u8fd8\u662f\u4e8b\u52a1C\u7684\u903b\u8f91\u76f4\u63a5\u63d0\u4ea4\uff0c\u800c\u4e0d\u662f\u4e8b\u52a1C\u2019\uff09</p> <p></p> <p>\u8fd9\u65f6\uff0c\u4e8b\u52a1A\u7684\u67e5\u8be2\u8bed\u53e5\u7684\u89c6\u56fe\u6570\u7ec4\u662f\u5728\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u7684\u65f6\u5019\u521b\u5efa\u7684\uff0c\u65f6\u5e8f\u4e0a(1,2)\u3001(1,3)\u7684\u751f\u6210\u65f6\u95f4\u90fd\u5728\u521b\u5efa\u8fd9\u4e2a\u89c6\u56fe\u6570\u7ec4\u7684\u65f6\u523b\u4e4b\u524d\u3002\u4f46\u662f\uff0c\u5728\u8fd9\u4e2a\u65f6\u523b\uff1a</p> <p>\u200b   \u2022   (1,3)\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u5c5e\u4e8e\u60c5\u51b51\uff0c\u4e0d\u53ef\u89c1\uff1b</p> <p>\u200b   \u2022   (1,2)\u63d0\u4ea4\u4e86\uff0c\u5c5e\u4e8e\u60c5\u51b53\uff0c\u53ef\u89c1\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\u4e8b\u52a1A\u67e5\u8be2\u8bed\u53e5\u8fd4\u56de\u7684\u662fk=2\u3002</p> <p>\u663e\u7136\u5730\uff0c\u4e8b\u52a1B\u67e5\u8be2\u7ed3\u679ck=3\u3002</p>"},{"location":"database/06-%E4%BA%8B%E5%8A%A1/#innodb","title":"Innodb\u5728\u53ef\u91cd\u590d\u8bfb\u7ea7\u522b\u5982\u4f55\u907f\u514d\u5e7b\u8bfb","text":"<p>MySQL\u5b98\u65b9\u6587\u6863</p> <ol> <li>\u5728\u5feb\u7167\u8bfb\uff08\u7b80\u5355\u7684select\u64cd\u4f5c\uff09\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7mvcc\u6765\u907f\u514d\u5e7b\u8bfb\uff1a</li> </ol> <p>\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u53ea\u5728\u7b2c\u4e00\u6b21\u67e5\u8be2\u7684\u65f6\u5019\u751f\u6210readview\uff0c\u518d\u6b21\u67e5\u8be2\u65f6\u8fd8\u4f7f\u7528\u8fd9\u4e2areadview\uff0c\u6240\u4ee5\u5373\u4f7f\u4e2d\u95f4\u6709\u4eba\u63d2\u5165\u4e86\u6570\u636e\uff0c\u5b83\u4e5f\u4e0d\u77e5\u9053\uff0c\u67e5\u8be2\u5230\u7684\u8fd8\u662f\u7b2c\u4e00\u6b21\u67e5\u8be2\u65f6\u4e8b\u52a1\u7684\u60c5\u51b5\u3002</p> <p>\u800c\u8bfb\u5df2\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4f1a\u5728\u6bcf\u4e00\u6b21\u67e5\u8be2\u7684\u65f6\u5019\u90fd\u4f1a\u751f\u6210readview\uff0c\u4ece\u4e2d\u67e5\u8be2\u5df2\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u53ea\u80fd\u907f\u514d\u810f\u8bfb\u95ee\u9898\u3002</p> <ol> <li>\u5728\u5f53\u524d\u8bfb\uff08update\u3001insert\u3001delete\u3001select ... for update\u7b49\u64cd\u4f5c\uff09\u60c5\u51b5\u4e0b\uff1a</li> </ol> <p>\u53ef\u91cd\u590d\u8bfb\u5f15\u5165\u4e86next-key\u9501\uff08\u884c\u9501+GAP\u9501\uff09\uff0c \u884c\u9501\u5bf9\u67e5\u8be2\u51fa\u6765\u7684\u6570\u636e\u52a0\u9501\uff0c\u95f4\u9699\u9501\u9632\u6b62\u522b\u7684\u4e8b\u52a1\u65b0\u589e\uff0c\u7ed3\u5408\u8d77\u6765\u5171\u540c\u907f\u514d\u4e86\u5e7b\u8bfb\u95ee\u9898\uff01\uff01</p> <p>\u800c\u8bfb\u5df2\u63d0\u4ea4\u53ea\u4f1a\u5bf9\u67e5\u8be2\u51fa\u6765\u7684\u6570\u636e\u884c\u8fdb\u884c\u52a0\u9501\uff0c\u6240\u4ee5\u65e0\u6cd5\u907f\u514d\u5e7b\u8bfb\u3002</p> <p>\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4ecd\u51fa\u73b0\"\u5e7b\u8bfb\"\u7684bug\uff1f</p> <p>\u7b80\u5355\u8bf4\u5728\u53ef\u91cd\u590d\u9694\u79bb\u7ea7\u522b\u4e0b\uff1a\u4e24\u6b21\u5feb\u7167\u8bfb\u4e4b\u95f4\u5b58\u5728\u5f53\u524d\u8bfb\uff0creadview\u4f1a\u91cd\u65b0\u751f\u6210\uff0c\u5bfc\u81f4\u5e7b\u8bfb\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <p>\u6709\u4eba\u4ee5\u4e3a\u662fBUG\u8fdb\u884c\u4e86\u4e0a\u62a5\uff0c\u770b\u56de\u590d\uff0c\u5bf9\u5e94\u5b98\u65b9\u6587\u6863\u4e3a\uff0c\u8fd8\u6709\u4e00\u4e2a\u77e5\u4e4e\u56de\u7b54\u5bc7\u4e9a\u9f99</p> <p>\u539f\u56e0\uff1aMVCC\u53ea\u9488\u5bf9\u5feb\u7167\u8bfb\u60c5\u51b5\u751f\u6548\uff0c\u9488\u5bf9DML \u8bed\u53e5\uff08UPDATE\u3001DELETE\u3001INSERT\uff09\u548c\u5f53\u524d\u8bfb\uff08SELECT ... IN SHARE MODE\u3001SELECT ... FOR UPDATE\uff09\uff0c\u4e8b\u52a1\u603b\u662f\u4f1a\u53bb\u8bfb\u53bb\u5f53\u524d\u6700\u65b0\u7684\u6570\u636e\u3002</p>"},{"location":"database/07-%E9%94%81/","title":"mysql\u4e2d\u7684\u9501","text":"<p>\u6309\u7167\u9501\u7684\u6a21\u5f0f\u53ef\u4ee5\u5206\u4e3a\uff1a\u5171\u4eab\u9501\uff08S\u9501\uff09\uff0c\u6392\u4ed6\u9501\uff08X\u9501\uff09</p> <p>\u6309\u7167\u9501\u7684\u7c92\u5ea6\u5206\u4e3a\uff1a\u5168\u5c40\u9501\uff0c\u8868\u9501\uff0c\u884c\u9501\uff08\u8bb0\u5f55\u9501\uff0c\u95f4\u9699\u9501\uff0c\u4e34\u952e\u9501\uff09</p>"},{"location":"database/07-%E9%94%81/#_1","title":"\u5171\u4eab\u9501\u548c\u6392\u5b83\u9501","text":"<p>\u53ef\u4ee5\u4f5c\u7528\u4e8e\u8868\u3001\u884c\u7b49\u4e0d\u540c\u7c92\u5ea6\uff0c\u662f\u4e00\u79cd\u9501\u7684\u6a21\u5f0f\u3002</p> <p>\u884c\u9501\u53ef\u4ee5\u662fS\u9501\uff08SELECT ... LOCK IN SHARE MODE\uff09\uff0c\u6216X\u9501\uff08SELECT ... FOR UPDATE\uff09\u3002</p> <p>\u610f\u5411\u9501\u662f\u8868\u7ea7\u9501\uff0c\u662f\u4e3a\u4e86\u4fee\u6539\u8868\u65f6\u5feb\u901f\u5224\u65ad\u8868\u4e2d\u662f\u5426\u6709\u884c\u88ab\u52a0\u4e86S/X\u9501\uff0c\u907f\u514d\u9010\u884c\u68c0\u67e5\uff0c\u63d0\u5347\u6027\u80fd\u3002</p> <ul> <li>\u4e8b\u52a1 A BEGIN; SELECT * FROM t WHERE id = 1 FOR UPDATE;  -- InnoDB \u81ea\u52a8\uff1a -- 1. \u5728\u8868 t \u4e0a\u52a0 IX \u9501 -- 2. \u5728 id=1 \u7684\u884c\u4e0a\u52a0 X \u9501 </li> <li>\u4e8b\u52a1 B LOCK TABLES t READ;  -- \u5c1d\u8bd5\u5728\u8868 t \u4e0a\u52a0 S \u9501 -- \u53d1\u73b0\u8868\u4e0a\u6709 IX \u9501 \u2192 \u51b2\u7a81\uff01\u7b49\u5f85\u4e8b\u52a1 A \u91ca\u653e</li> </ul> <p>\u5982\u679c\u53ea\u6709\u884c\u9501\uff0c\u6ca1\u6709\u610f\u5411\u9501\uff0c\u4e8b\u52a1 B \u5c31\u5f97\u626b\u63cf\u5168\u8868\u786e\u8ba4\u662f\u5426\u6709\u884c\u88ab X \u9501\u4f4f \u2014\u2014 \u6548\u7387\u6781\u4f4e\u3002</p> <p>\u610f\u5411\u9501\u7684\u4f5c\u7528\uff1a\u201c\u9884\u544a\u201d\u673a\u5236\uff0c\u5f53\u4e8b\u52a1\u8981\u5bf9\u67d0\u884c\u52a0 X \u9501\u524d\uff0c\u5fc5\u987b\u5148\u5728\u8868\u4e0a\u52a0 IX \u9501\u3002\u8fd9\u6837\uff0c\u53e6\u4e00\u4e2a\u4e8b\u52a1\u5982\u679c\u60f3\u5bf9\u6574\u5f20\u8868\u52a0 S \u9501\uff08\u5982 <code>LOCK TABLES ... READ</code>\uff09\uff0c\u53ea\u9700\u68c0\u67e5\u8868\u4e0a\u662f\u5426\u6709 IX \u6216 X \u9501\u5373\u53ef\uff0c\u65e0\u9700\u904d\u5386\u6240\u6709\u884c\u3002\u610f\u5411\u9501\u672c\u8eab\u4e0d\u963b\u585e\u6570\u636e\u64cd\u4f5c\uff0c\u53ea\u7528\u4e8e\u201c\u58f0\u660e\u610f\u56fe\u201d\u3002</p>"},{"location":"database/07-%E9%94%81/#_2","title":"\u5168\u5c40\u9501","text":"<p>\u5373\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u52a0\u9501\uff0c\u547d\u4ee4\u662fFlush tables with read lock\uff08FTWRL\uff09\uff0c\u6548\u679c\u662f\u6574\u4e2a\u5e93\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\uff0c\u5176\u4ed6\u7ebf\u7a0b\u7684DML\uff0cDDL\u548cupdate\u8bed\u53e5\u90fd\u4f1a\u88ab\u963b\u585e\u3002\u5168\u5c40\u9501\u7684\u5178\u578b\u573a\u666f\u5c31\u662f\u505a\u5168\u5e93\u903b\u8f91\u5907\u4efd\uff0c\u5373\u628a\u6574\u5e93\u6bcf\u4e2a\u8868\u90fdselect\u51fa\u6765\u5b58\u6210\u6587\u672c\u3002</p> <p>\u6574\u5e93\u5907\u4efd\u65b9\u6cd5\u8fd8\u53ef\u4ee5\u7528mysql\u81ea\u5e26\u7684mysql dump\uff0c\u4f7f\u7528\u53c2\u6570--single--transaction\u7684\u65f6\u5019\uff0c\u5bfc\u6570\u636e\u524d\u4f1a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6765\u786e\u4fdd\u62ff\u5230\u4e00\u81f4\u6027\u7684\u89c6\u56fe\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u662f\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\uff01\u6240\u4ee5\u5e93\u4e2d\u90fd\u662finnoDB\u5f15\u64ce\u7684\u8bdd\uff0c\u80af\u5b9a\u7528mysqlDump\u6765\u5907\u4efd\u662f\u6700\u5408\u9002\u7684\u3002</p>"},{"location":"database/07-%E9%94%81/#_3","title":"\u8868\u9501","text":"<p>MySQL\u91cc\u9762\u8868\u7ea7\u522b\u7684\u9501\u6709\u4e24\u79cd\uff1a\u4e00\u79cd\u662f\u8868\u9501\uff0c\u4e00\u79cd\u662f\u5143\u6570\u636e\u9501\uff08meta data lock\uff0cMDL)\u3002</p> <p>\u8868\u9501\u7684\u8bed\u6cd5\u662f lock tables \u2026 read/write\u3002\u4e0eFTWRL\u7c7b\u4f3c\uff0c\u53ef\u4ee5\u7528unlock tables\u4e3b\u52a8\u91ca\u653e\u9501\uff0c\u4e5f\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u65ad\u5f00\u7684\u65f6\u5019\u81ea\u52a8\u91ca\u653e\u3002\u9700\u8981\u6ce8\u610f\uff0clock tables\u8bed\u6cd5\u9664\u4e86\u4f1a\u9650\u5236\u522b\u7684\u7ebf\u7a0b\u7684\u8bfb\u5199\u5916\uff0c\u4e5f\u9650\u5b9a\u4e86\u672c\u7ebf\u7a0b\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u5bf9\u8c61\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50, \u5982\u679c\u5728\u67d0\u4e2a\u7ebf\u7a0bA\u4e2d\u6267\u884c<code>lock tables t1 read, t2 write;</code> \u8fd9\u4e2a\u8bed\u53e5\uff0c\u5219\u5176\u4ed6\u7ebf\u7a0b\u5199t1\u3001\u8bfb\u5199t2\u7684\u8bed\u53e5\u90fd\u4f1a\u88ab\u963b\u585e\u3002\u540c\u65f6\uff0c\u7ebf\u7a0bA\u5728\u6267\u884cunlock tables\u4e4b\u524d\uff0c\u4e5f\u53ea\u80fd\u6267\u884c\u8bfbt1\u3001\u8bfb\u5199t2\u7684\u64cd\u4f5c\u3002\u8fde\u5199t1\u90fd\u4e0d\u5141\u8bb8\uff0c\u81ea\u7136\u4e5f\u4e0d\u80fd\u8bbf\u95ee\u5176\u4ed6\u8868\u3002</p> <p>\u5728\u8fd8\u6ca1\u6709\u51fa\u73b0\u66f4\u7ec6\u7c92\u5ea6\u7684\u9501\u7684\u65f6\u5019\uff0c\u8868\u9501\u662f\u6700\u5e38\u7528\u7684\u5904\u7406\u5e76\u53d1\u7684\u65b9\u5f0f\u3002\u800c\u5bf9\u4e8eInnoDB\u8fd9\u79cd\u652f\u6301\u884c\u9501\u7684\u5f15\u64ce\uff0c\u4e00\u822c\u4e0d\u4f7f\u7528lock tables\u547d\u4ee4\u6765\u63a7\u5236\u5e76\u53d1\uff0c\u6bd5\u7adf\u9501\u4f4f\u6574\u4e2a\u8868\u7684\u5f71\u54cd\u9762\u8fd8\u662f\u592a\u5927\u3002</p>"},{"location":"database/07-%E9%94%81/#mdlmetadata-lock","title":"MDL\uff08metadata lock)\u9501","text":"<p>\u53e6\u4e00\u7c7b\u8868\u7ea7\u7684\u9501\u662fMDL\uff08metadata lock)\u3002MDL\u4e0d\u9700\u8981\u663e\u5f0f\u4f7f\u7528\uff0c\u5728\u8bbf\u95ee\u4e00\u4e2a\u8868\u7684\u65f6\u5019\u4f1a\u88ab\u81ea\u52a8\u52a0\u4e0a\u3002MDL\u7684\u4f5c\u7528\u662f\uff0c\u4fdd\u8bc1\u8bfb\u5199\u7684\u6b63\u786e\u6027\u3002\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u6b63\u5728\u904d\u5386\u4e00\u4e2a\u8868\u4e2d\u7684\u6570\u636e\uff0c\u800c\u6267\u884c\u671f\u95f4\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u8868\u7ed3\u6784\u505a\u53d8\u66f4\uff0c\u5220\u4e86\u4e00\u5217\uff0c\u90a3\u4e48\u67e5\u8be2\u7ebf\u7a0b\u62ff\u5230\u7684\u7ed3\u679c\u8ddf\u8868\u7ed3\u6784\u5bf9\u4e0d\u4e0a\uff0c\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u5143\u6570\u636e\u9501\uff1a\u5bf9\u4e00\u4e2a\u8868\u505a\u589e\u5220\u6539\u67e5\u65f6\u52a0MDL\u8bfb\u9501\uff1b\u5f53\u8981\u5bf9\u8868\u505a\u7ed3\u6784\u53d8\u66f4\u65f6\u52a0MDL\u5199\u9501\u3002\u5143\u6570\u636e\u9501MDL\uff0c\u662f\u81ea\u52a8\u52a0\u7684\uff0c\u4e0d\u9700\u8981\u663e\u5f0f\u4f7f\u7528\u3002\u8868\u9501\uff1a\u9700\u8981\u624b\u52a8\u52a0\u3002</p> <ul> <li>\u8bfb\u9501\u4e4b\u95f4\u4e0d\u4e92\u65a5\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5bf9\u4e00\u5f20\u8868\u589e\u5220\u6539\u67e5\u3002 </li> <li>\u8bfb\u5199\u9501\u4e4b\u95f4\u3001\u5199\u9501\u4e4b\u95f4\u662f\u4e92\u65a5\u7684\uff0c\u7528\u6765\u4fdd\u8bc1\u53d8\u66f4\u8868\u7ed3\u6784\u64cd\u4f5c\u7684\u5b89\u5168\u6027\u3002\u56e0\u6b64\uff0c\u5982\u679c\u6709\u4e24\u4e2a\u7ebf\u7a0b\u8981\u540c\u65f6\u7ed9\u4e00\u4e2a\u8868\u52a0\u5b57\u6bb5\uff0c\u5176\u4e2d\u4e00\u4e2a\u8981\u7b49\u53e6\u4e00\u4e2a\u6267\u884c\u5b8c\u624d\u80fd\u5f00\u59cb\u6267\u884c\u3002 \u56e0\u6b64\u7ebf\u4e0a\uff0c\u5bf9\u5927\u8868\u8fdb\u884c\u7ed3\u6784\u53d8\u66f4\u65f6\uff0c\u4e00\u5b9a\u8981\u5c0f\u5fc3\uff01\u53ef\u80fd\u9020\u6210\u6162SQL\uff0c\u6570\u636e\u5c40\u4e0d\u53ef\u7528\u7b49\uff01   \u5373\u4f7f\u5c0f\u8868\u5982\u679c\u6b63\u597d\u6709\u5927\u4e8b\u52a1\uff0c\u8868\u9501\u52a0\u9501\u540e\uff0c\u4e5f\u4f1a\u5f71\u54cd\u540e\u7eed\u7684SQL\u3002</li> </ul> <p>\u867d\u7136MDL\u9501\u662f\u7cfb\u7edf\u9ed8\u8ba4\u4f1a\u52a0\u7684\uff0c\u4f46\u5374\u662f\u4f60\u4e0d\u80fd\u5ffd\u7565\u7684\u4e00\u4e2a\u673a\u5236\u3002\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u7ecf\u5e38\u770b\u5230\u6709\u4eba\u6389\u5230\u8fd9\u4e2a\u5751\u91cc\uff1a\u7ed9\u4e00\u4e2a\u5c0f\u8868\u52a0\u4e2a\u5b57\u6bb5\uff0c\u5bfc\u81f4\u6574\u4e2a\u5e93\u6302\u4e86\u3002</p> <p>\u4f60\u80af\u5b9a\u77e5\u9053\uff0c\u7ed9\u4e00\u4e2a\u8868\u52a0\u5b57\u6bb5\uff0c\u6216\u8005\u4fee\u6539\u5b57\u6bb5\uff0c\u6216\u8005\u52a0\u7d22\u5f15\uff0c\u9700\u8981\u626b\u63cf\u5168\u8868\u7684\u6570\u636e\u3002\u5728\u5bf9\u5927\u8868\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u4f60\u80af\u5b9a\u4f1a\u7279\u522b\u5c0f\u5fc3\uff0c\u4ee5\u514d\u5bf9\u7ebf\u4e0a\u670d\u52a1\u9020\u6210\u5f71\u54cd\u3002\u800c\u5b9e\u9645\u4e0a\uff0c\u5373\u4f7f\u662f\u5c0f\u8868\uff0c\u64cd\u4f5c\u4e0d\u614e\u4e5f\u4f1a\u51fa\u95ee\u9898\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0b\u9762\u7684\u64cd\u4f5c\u5e8f\u5217\uff0c\u5047\u8bbe\u8868t\u662f\u4e00\u4e2a\u5c0f\u8868\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230session A\u5148\u542f\u52a8\uff0c\u8fd9\u65f6\u5019\u4f1a\u5bf9\u8868t\u52a0\u4e00\u4e2aMDL\u8bfb\u9501\u3002\u7531\u4e8esession B\u9700\u8981\u7684\u4e5f\u662fMDL\u8bfb\u9501\uff0c\u56e0\u6b64\u53ef\u4ee5\u6b63\u5e38\u6267\u884c\u3002</p> <p>\u4e4b\u540esession C\u4f1a\u88abblocked\uff0c\u662f\u56e0\u4e3asession A\u7684MDL\u8bfb\u9501\u8fd8\u6ca1\u6709\u91ca\u653e\uff0c\u800csession C\u9700\u8981MDL\u5199\u9501\uff0c\u56e0\u6b64\u53ea\u80fd\u88ab\u963b\u585e\u3002</p> <p>\u5982\u679c\u53ea\u6709session C\u81ea\u5df1\u88ab\u963b\u585e\u8fd8\u6ca1\u4ec0\u4e48\u5173\u7cfb\uff0c\u4f46\u662f\u4e4b\u540e\u6240\u6709\u8981\u5728\u8868t\u4e0a\u65b0\u7533\u8bf7MDL\u8bfb\u9501\u7684\u8bf7\u6c42\u4e5f\u4f1a\u88absession C\u963b\u585e\u3002\u524d\u9762\u6211\u4eec\u8bf4\u4e86\uff0c\u6240\u6709\u5bf9\u8868\u7684\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u90fd\u9700\u8981\u5148\u7533\u8bf7MDL\u8bfb\u9501\uff0c\u5c31\u90fd\u88ab\u9501\u4f4f\uff0c\u7b49\u4e8e\u8fd9\u4e2a\u8868\u73b0\u5728\u5b8c\u5168\u4e0d\u53ef\u8bfb\u5199\u4e86\u3002</p> <p>\u5982\u679c\u67d0\u4e2a\u8868\u4e0a\u7684\u67e5\u8be2\u8bed\u53e5\u9891\u7e41\uff0c\u800c\u4e14\u5ba2\u6237\u7aef\u6709\u91cd\u8bd5\u673a\u5236\uff0c\u4e5f\u5c31\u662f\u8bf4\u8d85\u65f6\u540e\u4f1a\u518d\u8d77\u4e00\u4e2a\u65b0session\u518d\u8bf7\u6c42\u7684\u8bdd\uff0c\u8fd9\u4e2a\u5e93\u7684\u7ebf\u7a0b\u5f88\u5feb\u5c31\u4f1a\u7206\u6ee1\u3002</p> <p>\u4f60\u73b0\u5728\u5e94\u8be5\u77e5\u9053\u4e86\uff0c\u4e8b\u52a1\u4e2d\u7684MDL\u9501\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5f00\u59cb\u65f6\u7533\u8bf7\uff0c\u4f46\u662f\u8bed\u53e5\u7ed3\u675f\u540e\u5e76\u4e0d\u4f1a\u9a6c\u4e0a\u91ca\u653e\uff0c\u800c\u4f1a\u7b49\u5230\u6574\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\u518d\u91ca\u653e\u3002</p> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e2a\u95ee\u9898\uff0c\u5982\u4f55\u5b89\u5168\u5730\u7ed9\u5c0f\u8868\u52a0\u5b57\u6bb5\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u89e3\u51b3\u957f\u4e8b\u52a1\uff0c\u4e8b\u52a1\u4e0d\u63d0\u4ea4\uff0c\u5c31\u4f1a\u4e00\u76f4\u5360\u7740MDL\u9501\u3002\u5728MySQL\u7684information_schema \u5e93\u7684 innodb_trx \u8868\u4e2d\uff0c\u4f60\u53ef\u4ee5\u67e5\u5230\u5f53\u524d\u6267\u884c\u4e2d\u7684\u4e8b\u52a1\u3002\u5982\u679c\u4f60\u8981\u505aDDL\u53d8\u66f4\u7684\u8868\u521a\u597d\u6709\u957f\u4e8b\u52a1\u5728\u6267\u884c\uff0c\u8981\u8003\u8651\u5148\u6682\u505cDDL\uff0c\u6216\u8005kill\u6389\u8fd9\u4e2a\u957f\u4e8b\u52a1\u3002</p> <p>\u4f46\u8003\u8651\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\u3002\u5982\u679c\u4f60\u8981\u53d8\u66f4\u7684\u8868\u662f\u4e00\u4e2a\u70ed\u70b9\u8868\uff0c\u867d\u7136\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u4f46\u662f\u4e0a\u9762\u7684\u8bf7\u6c42\u5f88\u9891\u7e41\uff0c\u800c\u4f60\u4e0d\u5f97\u4e0d\u52a0\u4e2a\u5b57\u6bb5\uff0c\u4f60\u8be5\u600e\u4e48\u505a\u5462\uff1f</p> <p>\u8fd9\u65f6\u5019kill\u53ef\u80fd\u672a\u5fc5\u7ba1\u7528\uff0c\u56e0\u4e3a\u65b0\u7684\u8bf7\u6c42\u9a6c\u4e0a\u5c31\u6765\u4e86\u3002\u6bd4\u8f83\u7406\u60f3\u7684\u673a\u5236\u662f\uff0c\u5728alter table\u8bed\u53e5\u91cc\u9762\u8bbe\u5b9a\u7b49\u5f85\u65f6\u95f4\uff0c\u5982\u679c\u5728\u8fd9\u4e2a\u6307\u5b9a\u7684\u7b49\u5f85\u65f6\u95f4\u91cc\u9762\u80fd\u591f\u62ff\u5230MDL\u5199\u9501\u6700\u597d\uff0c\u62ff\u4e0d\u5230\u4e5f\u4e0d\u8981\u963b\u585e\u540e\u9762\u7684\u4e1a\u52a1\u8bed\u53e5\uff0c\u5148\u653e\u5f03\u3002\u4e4b\u540e\u5f00\u53d1\u4eba\u5458\u6216\u8005DBA\u518d\u901a\u8fc7\u91cd\u8bd5\u547d\u4ee4\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\u3002</p>"},{"location":"database/07-%E9%94%81/#_4","title":"\u884c\u9501","text":"<p>\u884c\u9501\uff1aInnoDB\u5f15\u64ce\u7279\u6709\u7684\u4e00\u79cd\u9501\uff0c\u9501\u5b9a\u8868\u7684\u67d0\u4e00\u884c\u6216\u51e0\u884c\u8bb0\u5f55\uff0c\u7c92\u5ea6\u5c0f\uff0c\u5e76\u53d1\u5ea6\u9ad8\u3002</p> <ul> <li>\u8bb0\u5f55\u9501\uff1a\u9501\u5b9a\u7684\u662f\u67d0\u4e00\u6761\u8bb0\u5f55\uff0c\u5c5e\u4e8e\u884c\u9501\u7684\u4e00\u79cd\u3002</li> <li>\u95f4\u9699\u9501\uff1a\u5c5e\u4e8e\u884c\u9501\u7684\u4e00\u79cd\uff0c\u9501\u4f4f\u4e00\u4e2a\u533a\u95f4\uff0c\u9075\u5faa\u5de6\u5f00\u53f3\u95ed\u539f\u5219\u3002\u95f4\u9699\u9501\u53ea\u5728\u53ef\u91cd\u590d\u8bfb\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u5b58\u5728</li> </ul> <p>\u4e34\u952e\u9501\uff1aNext-Key Lock\uff0c\u662fInnodb\u7684\u884c\u9501\u9ed8\u8ba4\u7b97\u6cd5\u3002\u7b80\u5355\u8bf4\u5c31\u662f\u95f4\u9699\u9501\u548c\u8bb0\u5f55\u9501\u7684\u7ec4\u5408\uff0c\u4e34\u952e\u9501\u4f1a\u628a\u67e5\u8be2\u51fa\u6765\u7684\u8bb0\u5f55\u9501\u4f4f\uff0c\u540c\u65f6\u4e5f\u4f1a\u628a\u8be5\u67e5\u8be2\u8303\u56f4\u5185\u7684\u6240\u6709\u95f4\u9699\u533a\u95f4\u4e5f\u9501\u4f4f\uff0c\u628a\u76f8\u90bb\u7684\u4e0b\u4e00\u4e2a\u533a\u95f4\u4e5f\u9501\u4f4f\u3002</p> <p>\u884c\u9501\u662f\u52a0\u5728\u7d22\u5f15\u4e0a\u7684\uff0c\u5982\u679c\u5b57\u6bb5\u6ca1\u6709\u7d22\u5f15\uff0c\u66f4\u65b0\u65f6\u53ef\u80fd\u9501\u8868\uff01\uff01\uff01</p> <p></p> <p>\u884c\u9501\u662f\u5728\u6267\u884c\u9700\u8981\u7684SQL\u52a0\u4e0a\uff0c\u5728commit\u4e4b\u540e\u624d\u91ca\u653e\uff0c\u8fd9\u5c31\u4ee3\u8868\u5373\u4f7f\u6267\u884c\u5b8c\u4e86SQL\uff0c\u4f46\u662fcommit\u4e4b\u524d\u63d2\u5165\u4e86\u5176\u4ed6\u64cd\u4f5c\uff0c\u9501\u662f\u4e0d\u4f1a\u53ca\u65f6\u91ca\u653e\u7684\uff0c\u76f4\u5230\u4e8b\u52a1\u63d0\u4ea4\uff0c\u8fd9\u5c31\u662f\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u3002\u77e5\u9053\u8fd9\u70b9\uff0c\u6211\u4eec\u5728\u4e8b\u52a1\u4e2d\uff0c\u5c31\u5e94\u8be5\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\uff0c\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u5c3d\u91cf\u5f80\u540e\u653e\u3002</p>"},{"location":"database/07-%E9%94%81/#_5","title":"\u5feb\u7167\u8bfb\u548c\u5f53\u524d\u8bfb","text":"<ul> <li>\u666e\u901a SELECT\uff08\u5feb\u7167\u8bfb\uff09\uff1a \u5728 InnoDB \u7684\u9ed8\u8ba4\u9694\u79bb\u7ea7\u522b\uff08\u53ef\u91cd\u590d\u8bfb RR\uff09\u4e0b\uff0c\u666e\u901a\u7684 SELECT \u8bed\u53e5\u662f\u4e0d\u52a0\u9501\u7684\uff01\u5b83\u901a\u8fc7 MVCC\uff08\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff09\u673a\u5236\u8bfb\u53d6\u6570\u636e\u7684\u5386\u53f2\u5feb\u7167\uff0c\u4ece\u800c\u5b9e\u73b0\u975e\u963b\u585e\u8bfb\u3002</li> <li>\u52a0\u9501\u8bfb\uff08\u5f53\u524d\u8bfb\uff09\uff1a \u53ea\u6709\u5f53\u4f60\u663e\u5f0f\u4f7f\u7528 SELECT ... LOCK IN SHARE MODE\uff08\u52a0 S \u9501\uff09\u6216\u8005 SELECT ... FOR UPDATE\uff08\u52a0 X \u9501\uff09\uff0c\u4ee5\u53ca\u6267\u884c UPDATE/DELETE \u65f6\uff0c\u624d\u4f1a\u771f\u6b63\u5bf9\u6570\u636e\u884c\u52a0\u4e0a\u4e0a\u9762\u63d0\u5230\u7684\u5171\u4eab\u9501\u6216\u6392\u4ed6\u9501\u3002</li> </ul> <p>\u6240\u4ee5\uff0c\u666e\u901a\u8bfb\u4e0d\u9700\u8981\u83b7\u53d6\u5171\u4eab\u9501\uff0c\u662f\u56e0\u4e3a\u5b83\u907f\u5f00\u4e86\u7ade\u4e89\u3002</p> <ul> <li>\u5199\u64cd\u4f5c\uff08X \u9501\uff09\u548c \u663e\u5f0f\u52a0\u9501\u8bfb\uff08S \u9501\uff09\u662f\u5728\u4e89\u593a\u201c\u539f\u4ef6\u201d\u7684\u4f7f\u7528\u6743\u3002</li> <li>\u666e\u901a\u8bfb\u5219\u662f\u5229\u7528 MVCC \u673a\u5236\uff0c\u76f4\u63a5\u62ff\u8d70\u4e86\u4e00\u4efd\u201c\u5386\u53f2\u590d\u5370\u4ef6\u201d\u81ea\u5df1\u770b\uff0c\u65e2\u4e0d\u5e72\u6270\u522b\u4eba\u4fee\u6539\u539f\u4ef6\uff0c\u4e5f\u4e0d\u9700\u8981\u53bb\u7533\u8bf7\u5bf9\u539f\u4ef6\u7684\u4fdd\u62a4\uff08\u9501\uff09\u3002</li> </ul> <p>\u8fd9\u5c31\u662f InnoDB \u80fd\u591f\u652f\u6301\u9ad8\u5e76\u53d1\u8bfb\u7684\u6838\u5fc3\u79d8\u5bc6\uff1a\u8bfb\u4e0d\u963b\u585e\u5199\uff0c\u5199\u4e0d\u963b\u585e\u8bfb\u3002</p> <p>\u5f53\u524d\u8bfb\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u597d\u50cf\u7528\u7684\u5e76\u4e0d\u591a\uff0c\u53ef\u7528\u5728\u4e00\u4e9b\u51cf\u5e93\u5b58\uff0c\u4e0d\u5b58\u5728\u624d\u63d2\u5165\u7684\u573a\u666f\uff0c \u4e00\u67e5\u4e8c\u5224\u4e09\u66f4\u65b0\uff0c\u67e5\u662fselect.. for update\u3002\u4f46\u5f53\u524d\u8bfb\u53ef\u80fd\u5e26\u6765\u9501\u7ade\u4e89\u3001\u6b7b\u9501\u6982\u7387\u589e\u52a0\u4ee5\u53ca\u541e\u5410\u91cf\u4e0b\u964d\u7b49\u95ee\u9898\uff0c\u4e14\u53d7\u6846\u67b6\u5c01\u88c5\u5f71\u54cd\uff0c\u5206\u5e93\u5206\u8868\u7b49\uff0c\u4f7f\u7528\u573a\u666f\u66f4\u5c11\u4e86\u3002\u4e00\u822c\u7528\u5206\u5e03\u5f0f\u9501\u5373\u53ef\u641e\u5b9a\u3002</p> <p>\u5f53\u524d\u8bfb\u6a21\u5f0f\u7684\"\u5c11\u89c1\"\u6e90\u4e8e\u4e92\u8054\u7f51\u7cfb\u7edf\u5bf9\u9ad8\u5e76\u53d1\u6027\u80fd\u7684\u6781\u81f4\u8ffd\u6c42\uff0c\u4ee5\u53ca\u5206\u5e03\u5f0f\u67b6\u6784\u4e0b\u66f4\u4f18\u7684\u5e76\u53d1\u63a7\u5236\u65b9\u6848\u7684\u666e\u53ca\u3002\u73b0\u4ee3\u4e92\u8054\u7f51\u7cfb\u7edf\u666e\u904d\u91c7\u7528\u7f13\u5b58\u5c42(\u5982Redis)\u3001\u6d88\u606f\u961f\u5217(\u5982Kafka)\u3001\u5206\u5e03\u5f0f\u9501\u7b49\u4e2d\u95f4\u5c42\uff0c\u5c06\u5e76\u53d1\u63a7\u5236\u538b\u529b\u8f6c\u79fb\u81f3\u8fd9\u4e9b\u66f4\u9ad8\u6548\u7684\u7ec4\u4ef6\u4e0a</p>"},{"location":"database/07-%E9%94%81/#_6","title":"\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b","text":"<p>\u6709\u65f6MySQL\u670d\u52a1\u5668\u6302\u4e86\uff0c\u770bCPU\u4f7f\u7528\u63a5\u8fd1100%\uff0c\u8fd9\u662f\u600e\u4e48\u56de\u4e8b\u5462\uff1f</p> <p>\u6570\u636e\u5e93\u51fa\u73b0\u4e8b\u52a1\u76f8\u4e92\u7b49\u5f85\u5373\u8fdb\u5165\u6b7b\u9501\u72b6\u6001\uff0c\u6709\u4e24\u79cd\u7b56\u7565\uff1a</p> <ol> <li>\u76f4\u63a5\u8fdb\u5165\u7b49\u5f85\uff0c\u76f4\u5230\u8d85\u65f6\u3002\u4f46\u662f\u8fd9\u4e2a\u8d85\u65f6\u65f6\u95f4\u4e0d\u597d\u8bbe\u7f6e\uff0c\u5728InnoDB\u4e2d\u9ed8\u8ba4\u662f50s\uff0c\u610f\u5473\u7740\u51fa\u73b0\u6b7b\u9501\u65f6\uff0c\u7b2c\u4e00\u4e2a\u88ab\u9501\u7684\u7ebf\u7a0b\u8981\u8fc750\u79d2\u624d\u4f1a\u8d85\u65f6\u9000\u51fa\uff0c\u5176\u4ed6\u7ebf\u7a0b\u624d\u6709\u53ef\u80fd\u7ee7\u7eed\u6267\u884c\uff0c\u8fd9\u5bf9\u4e8e\u5728\u7ebf\u4e1a\u52a1\u6765\u8bf4\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002\u4f46\u662f\u53c8\u4e0d\u80fd\u592a\u77ed\u6bd4\u5982\u8bbe\u7f6e\u62101\u79d2\uff0c\u867d\u7136\u53ef\u4ee5\u5f88\u5feb\u89e3\u5f00\u6b7b\u9501\uff0c\u4f46\u4e07\u4e00\u53ea\u662f\u9501\u7b49\u5f85\u5462\uff1f</li> <li>\u6700\u5e38\u7528\u7684\u7b56\u7565\u662f\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\u3002Innodb_deadlock_detect\u9ed8\u8ba4\u5c31\u662fon\u3002\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\u5728\u53d1\u751f\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u5e76\u8fdb\u884c\u5904\u7406\uff0c\u4f46\u662f\u5b83\u4e5f\u6709\u989d\u5916\u8d1f\u62c5\u3002</li> </ol> <p>\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\u8fd9\u4e2a\u8fc7\u7a0b\uff1a\u6bcf\u5f53\u4e00\u4e2a\u4e8b\u52a1\u88ab\u9501\u7684\u65f6\u5019\uff0c\u5c31\u8981\u770b\u770b\u5b83\u6240\u4f9d\u8d56\u7684\u7ebf\u7a0b\u6709\u6ca1\u6709\u88ab\u522b\u4eba\u9501\u4f4f\uff0c\u5982\u6b64\u5faa\u73af\uff0c\u6700\u540e\u5224\u65ad\u662f\u5426\u51fa\u73b0\u4e86\u5faa\u73af\u7b49\u5f85\uff0c\u4e5f\u5c31\u662f\u6b7b\u9501\u3002</p> <p>\u90a3\u5982\u679c\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u6240\u6709\u4e8b\u52a1\u90fd\u8981\u66f4\u65b0\u540c\u4e00\u884c\u7684\u573a\u666f\u5462\uff1f</p> <p>\u6bcf\u4e2a\u65b0\u6765\u7684\u88ab\u5835\u4f4f\u7684\u7ebf\u7a0b\uff0c\u90fd\u8981\u5224\u65ad\u4f1a\u4e0d\u4f1a\u7531\u4e8e\u81ea\u5df1\u7684\u52a0\u5165\u5bfc\u81f4\u4e86\u6b7b\u9501\uff0c\u8fd9\u662f\u4e00\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u662fO(n)\u7684\u64cd\u4f5c\u3002\u5047\u8bbe\u67091000\u4e2a\u5e76\u53d1\u7ebf\u7a0b\u8981\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u64cd\u4f5c\u5c31\u662f100\u4e07\u8fd9\u4e2a\u91cf\u7ea7\u7684\u3002\u867d\u7136\u6700\u7ec8\u68c0\u6d4b\u7684\u7ed3\u679c\u662f\u6ca1\u6709\u6b7b\u9501\uff0c\u4f46\u662f\u8fd9\u671f\u95f4\u8981\u6d88\u8017\u5927\u91cf\u7684CPU\u8d44\u6e90\u3002\u56e0\u6b64\uff0c\u4f60\u5c31\u4f1a\u770b\u5230CPU\u5229\u7528\u7387\u5f88\u9ad8\uff0c\u4f46\u662f\u6bcf\u79d2\u5374\u6267\u884c\u4e0d\u4e86\u51e0\u4e2a\u4e8b\u52a1\u3002</p> <p>\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u6765\u8ba8\u8bba\u4e00\u4e0b\uff0c\u600e\u4e48\u89e3\u51b3\u7531\u8fd9\u79cd\u70ed\u70b9\u884c\u66f4\u65b0\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u5462\uff1f\u95ee\u9898\u7684\u75c7\u7ed3\u5728\u4e8e\uff0c\u6b7b\u9501\u68c0\u6d4b\u8981\u8017\u8d39\u5927\u91cf\u7684CPU\u8d44\u6e90\u3002</p> <p>\u4e00\u79cd\u5934\u75db\u533b\u5934\u7684\u65b9\u6cd5\uff0c\u5c31\u662f\u5982\u679c\u4f60\u80fd\u786e\u4fdd\u8fd9\u4e2a\u4e1a\u52a1\u4e00\u5b9a\u4e0d\u4f1a\u51fa\u73b0\u6b7b\u9501\uff0c\u53ef\u4ee5\u4e34\u65f6\u628a\u6b7b\u9501\u68c0\u6d4b\u5173\u6389\u3002\u4f46\u662f\u8fd9\u79cd\u64cd\u4f5c\u672c\u8eab\u5e26\u6709\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u56e0\u4e3a\u4e1a\u52a1\u8bbe\u8ba1\u7684\u65f6\u5019\u4e00\u822c\u4e0d\u4f1a\u628a\u6b7b\u9501\u5f53\u505a\u4e00\u4e2a\u4e25\u91cd\u9519\u8bef\uff0c\u6bd5\u7adf\u51fa\u73b0\u6b7b\u9501\u4e86\uff0c\u5c31\u56de\u6eda\uff0c\u7136\u540e\u901a\u8fc7\u4e1a\u52a1\u91cd\u8bd5\u4e00\u822c\u5c31\u6ca1\u95ee\u9898\u4e86\uff0c\u8fd9\u662f\u4e1a\u52a1\u65e0\u635f\u7684\u3002\u800c\u5173\u6389\u6b7b\u9501\u68c0\u6d4b\u610f\u5473\u7740\u53ef\u80fd\u4f1a\u51fa\u73b0\u5927\u91cf\u7684\u8d85\u65f6\uff0c\u8fd9\u662f\u4e1a\u52a1\u6709\u635f\u7684\u3002</p> <p>\u53e6\u4e00\u4e2a\u601d\u8def\u662f\u63a7\u5236\u5e76\u53d1\u5ea6\u3002\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u4f60\u4f1a\u53d1\u73b0\u5982\u679c\u5e76\u53d1\u80fd\u591f\u63a7\u5236\u4f4f\uff0c\u6bd4\u5982\u540c\u4e00\u884c\u540c\u65f6\u6700\u591a\u53ea\u670910\u4e2a\u7ebf\u7a0b\u5728\u66f4\u65b0\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u7684\u6210\u672c\u5f88\u4f4e\uff0c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u3002\u4e00\u4e2a\u76f4\u63a5\u7684\u60f3\u6cd5\u5c31\u662f\uff0c\u5728\u5ba2\u6237\u7aef\u505a\u5e76\u53d1\u63a7\u5236\u3002\u4f46\u662f\uff0c\u4f60\u4f1a\u5f88\u5feb\u53d1\u73b0\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u592a\u53ef\u884c\uff0c\u56e0\u4e3a\u5ba2\u6237\u7aef\u5f88\u591a\u3002\u6211\u89c1\u8fc7\u4e00\u4e2a\u5e94\u7528\uff0c\u6709600\u4e2a\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u5373\u4f7f\u6bcf\u4e2a\u5ba2\u6237\u7aef\u63a7\u5236\u5230\u53ea\u67095\u4e2a\u5e76\u53d1\u7ebf\u7a0b\uff0c\u6c47\u603b\u5230\u6570\u636e\u5e93\u670d\u52a1\u7aef\u4ee5\u540e\uff0c\u5cf0\u503c\u5e76\u53d1\u6570\u4e5f\u53ef\u80fd\u8981\u8fbe\u52303000\u3002</p> <p>\u56e0\u6b64\uff0c\u8fd9\u4e2a\u5e76\u53d1\u63a7\u5236\u8981\u505a\u5728\u6570\u636e\u5e93\u670d\u52a1\u7aef\u3002\u5982\u679c\u4f60\u6709\u4e2d\u95f4\u4ef6\uff0c\u53ef\u4ee5\u8003\u8651\u5728\u4e2d\u95f4\u4ef6\u5b9e\u73b0\uff1b\u5982\u679c\u4f60\u7684\u56e2\u961f\u6709\u80fd\u4fee\u6539MySQL\u6e90\u7801\u7684\u4eba\uff0c\u4e5f\u53ef\u4ee5\u505a\u5728MySQL\u91cc\u9762\u3002\u57fa\u672c\u601d\u8def\u5c31\u662f\uff0c\u5bf9\u4e8e\u76f8\u540c\u884c\u7684\u66f4\u65b0\uff0c\u5728\u8fdb\u5165\u5f15\u64ce\u4e4b\u524d\u6392\u961f\u3002\u8fd9\u6837\u5728InnoDB\u5185\u90e8\u5c31\u4e0d\u4f1a\u6709\u5927\u91cf\u7684\u6b7b\u9501\u68c0\u6d4b\u5de5\u4f5c\u4e86\u3002</p> <p>\u53ef\u80fd\u4f60\u4f1a\u95ee\uff0c\u5982\u679c\u56e2\u961f\u91cc\u6682\u65f6\u6ca1\u6709\u6570\u636e\u5e93\u65b9\u9762\u7684\u4e13\u5bb6\uff0c\u4e0d\u80fd\u5b9e\u73b0\u8fd9\u6837\u7684\u65b9\u6848\uff0c\u80fd\u4e0d\u80fd\u4ece\u8bbe\u8ba1\u4e0a\u4f18\u5316\u8fd9\u4e2a\u95ee\u9898\u5462\uff1f</p> <p>\u4f60\u53ef\u4ee5\u8003\u8651\u901a\u8fc7\u5c06\u4e00\u884c\u6539\u6210\u903b\u8f91\u4e0a\u7684\u591a\u884c\u6765\u51cf\u5c11\u9501\u51b2\u7a81\u3002\u8fd8\u662f\u4ee5\u5f71\u9662\u8d26\u6237\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u8003\u8651\u653e\u5728\u591a\u6761\u8bb0\u5f55\u4e0a\uff0c\u6bd4\u598210\u4e2a\u8bb0\u5f55\uff0c\u5f71\u9662\u7684\u8d26\u6237\u603b\u989d\u7b49\u4e8e\u8fd910\u4e2a\u8bb0\u5f55\u7684\u503c\u7684\u603b\u548c\u3002\u8fd9\u6837\u6bcf\u6b21\u8981\u7ed9\u5f71\u9662\u8d26\u6237\u52a0\u91d1\u989d\u7684\u65f6\u5019\uff0c\u968f\u673a\u9009\u5176\u4e2d\u4e00\u6761\u8bb0\u5f55\u6765\u52a0\u3002\u8fd9\u6837\u6bcf\u6b21\u51b2\u7a81\u6982\u7387\u53d8\u6210\u539f\u6765\u76841/10\uff0c\u53ef\u4ee5\u51cf\u5c11\u9501\u7b49\u5f85\u4e2a\u6570\uff0c\u4e5f\u5c31\u51cf\u5c11\u4e86\u6b7b\u9501\u68c0\u6d4b\u7684CPU\u6d88\u8017\u3002\u8fd9\u4e2a\u65b9\u6848\u770b\u4e0a\u53bb\u662f\u65e0\u635f\u7684\uff0c\u4f46\u5176\u5b9e\u8fd9\u7c7b\u65b9\u6848\u9700\u8981\u6839\u636e\u4e1a\u52a1\u903b\u8f91\u505a\u8be6\u7ec6\u8bbe\u8ba1\u3002\u5982\u679c\u8d26\u6237\u4f59\u989d\u53ef\u80fd\u4f1a\u51cf\u5c11\uff0c\u6bd4\u5982\u9000\u7968\u903b\u8f91\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u8003\u8651\u5f53\u4e00\u90e8\u5206\u884c\u8bb0\u5f55\u53d8\u62100\u7684\u65f6\u5019\uff0c\u4ee3\u7801\u8981\u6709\u7279\u6b8a\u5904\u7406\u3002</p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/","title":"08 \u6269\u5c55\u5b66\u4e60","text":""},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#mysql80","title":"mySQL8.0\u7684\u65b0\u7279\u6027","text":"<p>SQL\u76f8\u5173\uff1a \u2022\u5feb\u901fDDL\u3002\u5927\u8868\u7684\u52a0\u5217\u64cd\u4f5c\u901a\u5e38\u8981\u597d\u51e0\u4e2a\u5c0f\u65f6\uff0c\u800c\u4e14\u4f1a\u4ea7\u751f\u5927\u7684\u4e34\u65f6\u8868\u3002\u6709\u4e86\u5feb\u901fDDL\uff0c\u5c31\u53ef\u4ee5\u907f\u514d\u8fd9\u4e9b\u95ee\u9898\uff0c\u6ce8\u610f\u4ec5\u652f\u6301\u5728\u6700\u540e\u6dfb\u52a0\u5217\u3002\u9002\u7528\u4e8e\u6dfb\u52a0\u5217\u3001\u4fee\u6539\u5217\u7684\u9ed8\u8ba4\u503c\u3001\u4fee\u6539\u5217\u8868 \u2022\u7a97\u53e3\u51fd\u6570\uff0c \u652f\u6301 over \u5b57\u53e5\uff0cROW_NUMBER(), RANK(), LEAD(), LAG() \u7b49\uff0c\u5b9e\u73b0\u4e00\u4e9b\u590d\u6742\u7684\u5206\u6790\u67e5\u8be2\u3002 \u2022 \u4ece8.0\u5f00\u59cb\uff0cUTF8mb4\u6210\u4e3aMySQL\u9ed8\u8ba4\u652f\u6301\u7684\u5b57\u7b26\u96c6\uff0c\u5b8c\u7f8e\u652f\u6301\u5404\u7c7b\u706b\u661f\u6587\u3001\ud83d\ude06emoji\u8868\u60c5\u7b49\u7279\u6b8a\u5b57\u7b26\u3002</p> <p>\u7d22\u5f15\u76f8\u5173\uff1a - \u53ef\u5c06\u7d22\u5f15\u8bbe\u4e3a\u4e0d\u53ef\u89c1\u6d4b\u8bd5\u6027\u80fd\u5f71\u54cd\uff0c\u786e\u8ba4\u65e0\u5f71\u54cd\u540e\u518d\u5220\u9664\u3002alter table t1 alter index idx_name invisible - \u652f\u6301\u964d\u5e8f\u7d22\u5f15\uff0c\u5373\u6307\u5b9aDESC\uff0c\u907f\u514d\u53cd\u5411\u626b\u63cf\u7d22\u5f15\u3002\u4e4b\u524d\u9ed8\u8ba4\u90fd\u662f\u6309\u5347\u5e8f\u65b9\u5f0f\u5b58\u50a8\u3002 - \u652f\u6301\u51fd\u6570\u7d22\u5f15\u3002\u5c06\u67d0\u5217\u4f5c\u7528\u51fd\u6570\u540e\u4f5c\u4e3a\u7d22\u5f15</p> <p>\u4f18\u5316\u5668\u76f8\u5173\uff1a \u4e3b\u4ece\u590d\u5236\u7684\u6539\u8fdb\uff1a</p> <p>InnoDB\u76f8\u5173\uff1a - CATS \u9501\u7684\u8c03\u5ea6\u3002\u591a\u4e2a\u4e8b\u52a1\u7684\u9501\u7b49\u5f85\u65f6\u4e0d\u518d\u662fFIFI\u7b56\u7565\uff0c\u800c\u662fCATS\uff0c\u4e8b\u52a1\u62e5\u6709\u6743\u91cd\u5c5e\u6027\uff0c\u5373\u4e00\u4e2a\u4e8b\u52a1\u5df2\u7ecf\u9501\u5b9a\u8bb8\u591a\u70ed\u70b9\u884c\u65f6\uff0c\u6743\u91cd\u66f4\u9ad8\uff0c\u8bf7\u6c42\u65b0\u9501\u65f6\u5c06\u83b7\u5f97\u4f18\u5148\u6743\u3002\u516c\u4ea4\u8f66\u53f8\u673a\u5373\u4f7f\u6bd4\u51fa\u79df\u8f66\u540e\u5230\uff0c\u4f46\u4e5f\u7ed9\u4ed6\u5148\u52a0\u6cb9\uff0c\u8fd9\u6837\u4f1a\u8ba9\u66f4\u591a\u4eba\u66f4\u5feb\u5230\u8fbe\u76ee\u7684\u5730\u3002 - \u91cd\u542f\u65f6\uff0cInnoDB\u6839\u636e\u670d\u52a1\u5668\u5185\u5b58\u81ea\u52a8\u4f18\u5316 InnoDB \u53c2\u6570\uff0c\u4ee5\u5c3d\u53ef\u80fd\u4f7f\u7528\u66f4\u591a\u7684\u670d\u52a1\u5668\u8d44\u6e90\u3002\u51cf\u5c11 DBA \u624b\u52a8\u914d\u7f6e\u3002</p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#mysql-group-replicationmgr","title":"MySQL Group Replication\uff08MGR\uff09","text":"<p>\u662f MySQL \u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u9ad8\u53ef\u7528\u3001\u9ad8\u53ef\u9760\u3001\u5f3a\u4e00\u81f4\u6027\u7684\u6570\u636e\u5e93\u96c6\u7fa4\u89e3\u51b3\u65b9\u6848\u3002 \u2022\u6838\u5fc3\u672c\u8d28\uff1a\u5b83\u662f\u4e00\u4e2a \u57fa\u4e8e Paxos \u534f\u8bae\u7684\u5206\u5e03\u5f0f\u72b6\u6001\u673a\u590d\u5236\u7cfb\u7edf\u3002 \u2022\u7b80\u5355\u7406\u89e3\uff1aMGR \u5c06\u591a\u4e2a MySQL \u5b9e\u4f8b\u7ec4\u6210\u4e00\u4e2a \u201c\u7ec4\u201d\uff0c\u8fd9\u4e2a\u7ec4\u5bf9\u5916\u5c31\u50cf\u4e00\u4e2a\u5355\u4e00\u7684\u6570\u636e\u5e93\u3002\u7ec4\u5185\u4efb\u4f55\u8282\u70b9\u6267\u884c\u7684\u4e8b\u52a1\u90fd\u4f1a\u901a\u8fc7\u7ec4\u5185\u534f\u5546\u4e00\u81f4\u540e\u540c\u6b65\u5230\u5176\u4ed6\u6240\u6709\u8282\u70b9\uff0c\u4ece\u800c\u5b9e\u73b0\u6570\u636e\u7684\u5f3a\u4e00\u81f4\u6027\u3002 \u2022\u5355\u4e3b\u8282\u70b9\uff0c\u8fd8\u6709\u591a\u4e3b\u8282\u70b9\u3002 \u901a\u8fc7mySQL Router\u5e94\u7528\u5c42\u4ee3\u7406\u66b4\u9732\u7ed9\u5ba2\u6237\u7aef </p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#binlog-server","title":"binlog server","text":"<p>mySQL master \u4f1a\u901a\u8fc7\u534f\u8bae\u540c\u6b65\u5230salve\uff0c\u4f46\u662f\u4e00\u822c\u4f01\u4e1a\u4f1a\u57fa\u4e8ebinlog\u505a\u66f4\u591a\u4e8b\u60c5\u3002 binlog\u7684\u5e94\u7528\u573a\u666f\uff1a\u670d\u52a1\u5b9e\u4f8b\u6269\u5bb9\u3001binlog\u8ba2\u9605\uff1b\u8bfb\u5199\u5206\u79bb\u3001HA\u5207\u6362\u7b49\u573a\u666f\uff0c\u5e94\u7528\u975e\u5e38\u5e7f\u6cdb\u3002 binlog server \u7684\u57fa\u672c\u539f\u7406\u548c\u4f5c\u7528\u673a\u5236\uff1a\u901a\u8fc7\u5b9e\u65f6\u5907\u4efdmaster\u7684binlog\uff0c\u5e76\u5411\u4e0b\u6e38\u540c\u6b65binlog\uff0c\u91ca\u653emaster\u7684\u538b\u529b\u3002 binlog server\u4f5c\u7528\u5f88\u5927\uff0c\u56e0\u6b64\u5b9e\u73b0\u65b9\u5f0f\u6709\u5f88\u591a\u79cd\uff0c\u4e1a\u754c\u4e5f\u6709\u5f88\u591a\u65b9\u6848\uff0c\u5982 - mysqbinlog\uff1a\u6a21\u62dfMySQL\u7684\u4ece\u673a\uff0c\u5411master\u53d1\u9001binlog dump\u547d\u4ee4\u5c06\u4ecemaster\u6536\u5230\u7684binlog\u5b58\u653e\u5728\u672c\u5730\u3002\u7b80\u5355\uff0cmysql\u81ea\u5e26\uff0c\u4f46\u662f\u4e0d\u80fd\u4f5c\u4e3a\u4e0b\u6e38slave\u7684\u4e2d\u7ee7\u8282\u70b9\u3002  - kingbus\uff1a\u57fa\u4e8eraft\u5f3a\u4e00\u81f4\u534f\u8bae\u5b9e\u73b0\u7684\u5206\u5e03\u5f0fMySQL binlog \u5b58\u50a8\u7cfb\u7edf\u3002\u5b83\u80fd\u591f\u5145\u5f53\u4e00\u4e2aMySQL Slave\u4ece\u771f\u6b63\u7684Master\u4e0a\u540c\u6b65binlog\uff0c\u5e76\u5b58\u50a8\u5728\u5206\u5e03\u5f0f\u96c6\u7fa4\u4e2d\u3002\u540c\u65f6\u53c8\u5145\u5f53\u4e00\u4e2aMySQL Master\u5c06\u96c6\u7fa4\u4e2d\u7684binlog \u540c\u6b65\u7ed9\u5176\u4ed6Slave  - Google Mysql-ripple\u3001Blackhole\u5b58\u50a8\u5f15\u64ce\u7b49\u3002 </p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#performance-schema","title":"Performance Schema","text":"<p>\u662f\u4e00\u79cd\u4e13\u95e8\u7528\u6765\u76d1\u63a7\u670d\u52a1\u5668\u6267\u884c\u60c5\u51b5\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5b83\u4f1a\u628a\u76d1\u63a7\u670d\u52a1\u5668\u6267\u884c\u60c5\u51b5\u7684\u6570\u636e\u8bb0\u5f55\u5728\u7cfb\u7edf\u81ea\u5e26\u7684\u6570\u636e\u5e93performance_schema\u3002setup_instruments\u4fdd\u5b58\u7684\u6570\u636e\uff0c\u8868\u793a\u54ea\u4e9b\u5bf9\u8c61\u53d1\u751f\u7684\u4e8b\u4ef6\u53ef\u4ee5\u88ab\u7cfb\u7edf\u6355\u83b7\uff0c setup_consumers\u4fdd\u5b58\u7684\u6570\u636e\u7528\u6765\u63a7\u5236\u4fdd\u5b58\u54ea\u4e9b\u4e8b\u4ef6\u7684\u4fe1\u606f\u3002\u6211\u4eec\u53ef\u4ee5\u8c03\u53d6\u76d1\u63a7\u6570\u636e\u6765\u67e5\u770b\u6267\u884c\u60c5\u51b5\uff0c\u4ece\u800c\u5b9a\u4f4d\u548c\u89e3\u51b3\u95ee\u9898\u3002</p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#mysql","title":"MySQL\u9ad8\u6027\u80fd\u79d2\u6740","text":""},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#1","title":"1. \u80cc\u666f","text":"<p>\u5728\u7528\u6237\u4e0b\u5355\u65f6\uff0c\u65e0\u8bba\u662f\u5916\u5356\u3001\u95ea\u8d2d\uff0c\u8fd8\u662f\u4f18\u9009\u3001\u56e2\u597d\u8d27\u3001\u5404\u4ea7\u54c1\u7ebf\u53d1\u653e\u4f18\u60e0\u5238\uff0c\u5728\u6280\u672f\u4e0a\uff0c\u90fd\u53ef\u4ee5\u62bd\u8c61\u6210\u5bf9\u5e93\u5b58\u8fdb\u884c\u6263\u51cf\u3002\u4e1a\u52a1\u5fc5\u987b\u4fdd\u8bc1\u5e93\u5b58\u7684\u7edd\u5bf9\u51c6\u786e\uff0c\u5426\u5219\u5c31\u4f1a\u53d1\u751f\u8d85\u5356\u6216\u8005\u5c11\u5356\u3002\u5982\u5916\u5356\u5238 \u5238\u662f\u6709\u9650\u7684\uff0c\u4e8b\u5148\u4f1a\u505a\u4f30\u7b97\uff0c\u6240\u4ee5\u5916\u5356\u5238\u7684\u53d1\u653e\u6d89\u53ca\u5230\u79d2\u6740\uff0c\u8fd8\u6709\u7535\u5f71\u5238\uff0c\u8fea\u58eb\u5c3c\u5238\u7b49\u7b49</p> <p>\u79d2\u6740\u5931\u8d25\u7684\u6848\u4f8b</p> <p>\u73b0\u8c61\uff1a\u6570\u636e\u5e93\u4e00\u4e3b\u4e09\u4ece\u53d8\u6210\u4e00\u4e3b\u4e8c\u4ece\uff0c\u6700\u540e\u4e00\u4e3b\u4e00\u4ece\u3002\u7136\u540eDBA\u8fc5\u901f\u8fdb\u884c\u9650\u6d41\u3002</p> <p>\u95ee\u9898\uff1a\u4e1a\u52a1\u8fdb\u884c\u4e86\u9650\u6d41\uff0cQPS600.\u3002\u7136\u540e\u5206\u5230\u4e09\u4e2a\u5e93\u3002\u7ed3\u679c\u6d41\u91cf\u5168\u90e8\u6253\u5230\u4e00\u4e2a\u5e93\u4e0a\uff0c\u5355\u673aQPS\u53ea\u6709200\uff0c\u4e0d\u6ee1\u8db3600\u7684QPS\uff0c</p> <p>\u5df2\u6709\u79d2\u6740\u65b9\u6848\uff1a</p> <ul> <li>MysQL</li> </ul> <p>\u9ad8\u5e76\u53d1\u4e0b\u6027\u80fd\u4f4e\uff0c\u793e\u533a\u7248MySQL\u6570\u636e\u5e93\u5728\u5904\u7406\u6263\u51cf\u5e93\u5b58\u4e0a\u80fd\u529b\u4e0d\u8db3\uff0c\u5c24\u5176\u662f\u5728\u6d77\u91cf\u7528\u6237\u62a2\u8d2d\u76f8\u540c\u7684\u5546\u54c1\u65f6\uff0c\u7cfb\u7edf\u7684\u54cd\u5e94\u65f6\u95f4\u6025\u5267\u6076\u5316\uff0c\u541e\u5410\u91cf\u5927\u5927\u964d\u4f4e</p> <ul> <li>redis</li> </ul> <p>\u76ee\u524d\u8fd8\u6ca1\u6709\u975e\u5e38\u6210\u719f\u7684\u673a\u5236\uff0c\u5728\u673a\u5668\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u4fdd\u8bc1\u6570\u636e\u7684\u51c6\u786e\u6027\uff0c\u56e0\u6b64\u9700\u8981\u4e1a\u52a1\u8017\u8d39\u8f83\u5927\u7cbe\u529b\u53bb\u5904\u7406\u5404\u79cd\u5f02\u5e38\u60c5\u51b5\uff0c\u9020\u6210\u89e3\u51b3\u65b9\u6848\u590d\u6742\uff0c\u6613\u51fa\u9519\u9c81\u68d2\u6027\u4f4e\u3002</p> <ul> <li>\u65b0\u65b9\u6848\uff1f</li> </ul> <p>\u5982\u4f55\u4f7f\u7528MySQL\u7684\u4e8b\u52a1\u9ad8\u4e00\u81f4\u6027\uff0c\u53c8\u80fd\u4fdd\u6301\u9ad8\u6027\u80fd\u5462\uff1fSQL\u5185\u6838\u56e2\u961f\u5728\u6570\u636e\u5e93\u4e2d\u5185\u7f6e\u4e86\u79d2\u6740\u529f\u80fd\uff0c\u4e1a\u52a1\u53ea\u9700\u901a\u8fc7\u7b80\u5355\u9002\u914d\uff0c\u5c31\u53ef\u4ee5\u65e2\u4fdd\u8bc1\u5e93\u5b58\u51c6\u786e\u6027\uff0c\u4e5f\u80fd\u83b7\u5f97\u8f83\u4e3a\u6ee1\u610f\u7684\u6027\u80fd\u3002</p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#2","title":"2. \u539f\u7406","text":"<p>\u5148\u5206\u6790\u4e1a\u52a1\u548c\u6570\u636e\u5e93\u7684\u4ea4\u4e92</p> <p>mySQL\u662f\u4e00\u81f4\u6027\u8981\u6c42\u975e\u5e38\u5f3a\u7684\u5173\u7cfb\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u5bf9\u4efb\u4f55\u8bb0\u5f55\u7684\u4fee\u6539\u90fd\u8981\u7ecf\u8fc7\u4e00\u4e2a\u5b8c\u6574\u7684\u4e8b\u52a1\u8fc7\u7a0b\uff0c\u5305\u542b\u201c\u5f00\u542f\u4e8b\u52a1-&gt;\u52a0\u9501\u4fee\u6539-&gt;\u63d0\u4ea4\u89e3\u9501\"\u4e09\u4e2a\u6b65\u9aa4\uff0c\u4e0d\u540c\u7684\u4e8b\u52a1\u5982\u679c\u4fee\u6539\u5b8c\u5168\u4e0d\u540c\u7684\u8bb0\u5f55\uff0c\u5728\u6570\u636e\u5e93\u4e2d\u53ef\u4ee5\u5b8c\u5168\u5e76\u884c\uff0c\u6709\u6bd4\u8f83\u597d\u7684\u6027\u80fd\u3002</p> <p>\u4f46\u5982\u679c\u4fee\u6539\u7684\u662f\u540c\u4e00\u6761\u8bb0\u5f55\uff0c\u5219\u4e0d\u540c\u4f1a\u8bdd\u7684\u4e8b\u52a1\u5728\u6570\u636e\u5e93\u91cc\u7684\u6267\u884c\u662f\u4e32\u884c\u7684\uff0c\u5f62\u6210\u6211\u4eec\u7684\u8bb2\u7684\u70ed\u70b9\u8bb0\u5f55\uff0c\u5bf9\u5e94\u5230\u4e1a\u52a1\u5219\u662f\u70ed\u70b9\u4e1a\u52a1\u3002\u8fd9\u79cd\u70ed\u70b9\u60c5\u51b5\u662f\u666e\u904d\u5b58\u5728\u7684\uff0c\u6bd4\u5982\u7269\u7f8e\u4ef7\u5ec9\u7684\u4f18\u8d28\u5546\u54c1\u7684\u5e93\u5b58\u8bb0\u5f55\u3001\u53d1\u653e\u7ea2\u5305/\u4f18\u60e0\u5377\u7684\u5185\u90e8\u8d26\u53f7\u3001\u6216\u8d22\u52a1\u4e2d\u7684\u4f01\u4e1a\u8d26\u53f7\u6216\u4e2d\u95f4\u8d26\u53f7\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e00\u4e2a\u5178\u578b\u7684\u51cf\u5e93\u5b58\u7684\u903b\u8f91\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>begin;\ninsert into \u5e93\u5b58\u53d8\u52a8\u8bb0\u5f55 value (....);\nupdate \u5e93\u5b58\u4f59\u6570\u8bb0\u5f55 set \u4f59\u6570 = \u4f59\u6570 - 1 where \u5546\u54c1id = ? and \u4f59\u6570 &gt; 0;\ncommit;\n</code></pre> <p>\u5728Update\u8bed\u53e5\u4e4b\u524d\uff0c\u4e0d\u540c\u4f1a\u8bdd\u7684\u4e8b\u52a1\u53ef\u4ee5\u5e76\u884c\uff0c\u5728Update\u8bed\u53e5\u6267\u884c\u65f6\uff0c\u9700\u8981\u52a0\u9501\u7136\u540e\u76f4\u5230commit\u8bed\u53e5\u6267\u884c\u6210\u529f\u624d\u80fd\u89e3\u9501\u3002\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\u5728Update\u548cCommit\u4e2d\u95f4\u4f1a\u7ecf\u5386\u54ea\u4e9b\u4e8b\u60c5\uff1f\u53ef\u80fd\u7684\u4e8b\u60c5\u6709</p> <p>\u200b   \u2022   update/commit\u4e24\u6761\u547d\u4ee4\u4e4b\u95f4\uff0c\u9700\u8981\u5e94\u7528\u4eceDB\u670d\u52a1\u5668\u53d6\u5f97Update\u8bed\u53e5\u7684\u8fd4\u56de\u503c\uff0c\u7136\u540e\u518d\u5c06commit\u8bed\u53e5\u53d1\u8fc7\u53bb\uff0c\u6d89\u53ca\u4e00\u4e2a\u7f51\u7edc\u6765\u56de\uff0c\u5e94\u7528\u548c\u6570\u636e\u5e93\u4e4b\u95f4\u53ef\u80fd\u5728\u540c\u4e00\u4e2aAZ\u5185\uff0c\u4e5f\u53ef\u80fd\u662f\u8de8AZ\u7684\u3002\u4e00\u6761\u7b80\u5355\u7684\u7eaf\u5185\u5b58\u7684Update\u8bed\u53e5\u7684\u5185\u6838\u6267\u884c\u65f6\u95f4\u5927\u7ea6\u5728100us\u4ee5\u5185\uff0c\u540c\u57ce\u4e00\u4e2a\u7f51\u7edc\u6765\u56de\u7684\u65f6\u95f4\u53ef\u80fd\u662f200us\u52301500us\u4e4b\u95f4\uff0c\u53ef\u4ee5\u770b\u5230\u7f51\u7edc\u5bf9\u70ed\u70b9\u573a\u666f\u5e76\u53d1\u80fd\u529b\u7684\u5f71\u54cd\u3002</p> <p>\u200b   \u2022   Update\u8bed\u53e5\u4e0d\u4e00\u5b9a\u653e\u5728\u4e8b\u52a1\u7684\u6700\u540e\u9762\uff0c\u6bd4\u5982\u524d\u9762\u7684Update\u548cInsert\u8bed\u53e5\u6362\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u5219Update\u9501\u7684\u6301\u6709\u65f6\u95f4\u4f1a\u660e\u663e\u504f\u957f\u3002\u8fd9\u91cc\u53ef\u4ee5\u4f18\u5316\u5e94\u7528\uff0c\u8fdb\u884cSQL\u8bed\u53e5\u4f4d\u7f6e\u7684\u8c03\u6574\u3002</p> <p>\u200b   \u2022   \u76ee\u524d\u5f88\u591a\u5e94\u7528\u662f\u7528Java\u7f16\u5199\u7684\uff0c\u4e5f\u53ef\u80fd\u5728Update\u548ccommit\u4e24\u6761\u547d\u4ee4\u4e4b\u95f4\uff0c\u53d1\u751fGC\u7684\u884c\u4e3a\uff0c\u4e00\u6b21Young GC\u7684\u65f6\u95f4\u5927\u7ea6\u4e3a\u51e0\u5341\u6beb\u79d2\uff0c\u5982\u679c\u662f\u4e00\u6b21Full GC\uff0c\u5219\u65f6\u95f4\u53ef\u80fd\u8fbe\u5230\u79d2\u7ea7\u3002</p> <p>\u200b   \u2022   \u6709\u4e9b\u5e94\u7528\u903b\u8f91\u4e2d\uff0c\u53ef\u80fd\u9700\u8981\u5728Update\u548cCommit\u4e2d\u95f4\u901a\u77e5\u5176\u4ed6\u7684\u5e94\u7528\u8fdb\u884c\u534f\u4f5c\uff0c\u5982\u679c\u6d89\u53ca\u5916\u90e8\u7684\u5e94\u7528\uff0c\u65f6\u95f4\u4e0a\u4f1a\u66f4\u4e0d\u53ef\u63a7\u3002\u8fd9\u91cc\u53ef\u4ee5\u5148\u5728\u672c\u5730\u8bb0\u5f55\u4e00\u4e2a\u4e8b\u4ef6\uff0c\u7136\u540e\u5728\u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u901a\u8fc7\u4e8b\u4ef6\u8fdb\u884c\u5916\u90e8\u7cfb\u7edf\u4ea4\u4e92\u3002</p> <p>\u5f53\u6211\u4eec\u4e0d\u7528\u4e8b\u52a1\u6a21\u5f0f\u6d4b\u8bd5Update\u8bed\u53e5\uff0c\u6267\u884c\u5c31\u4f1a\u975e\u5e38\u5feb\uff0c\u8fd9\u91cc\u5176\u5b9e\u662f\u7701\u6389\u4e86Update\u548cCommit\u4e24\u4e2a\u8bed\u53e5\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\u3002\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u5c06\u68c0\u67e5Update\u8bed\u53e5\u662f\u5426\u6210\u529f\u7684\u6761\u4ef6\uff0c\u4e5f\u5305\u62ec\u5728\u8bed\u53e5\u4e2d\uff0c\u76f4\u63a5\u53d1\u5230\u6570\u636e\u5e93\u670d\u52a1\u5668\uff0c\u8ba9\u6570\u636e\u5e93\u670d\u52a1\u4ee3\u4e3a\u68c0\u67e5Update\u8bed\u53e5\u662f\u5426\u6210\u529f\uff0c\u5982\u679c\u6210\u529f\u5219\u76f4\u63a5\u63d0\u4ea4\uff0c\u5982\u679c\u5931\u8d25\u5219\u76f4\u63a5\u56de\u6eda\uff0c\u4ee5\u7701\u7565Update\u548cCommit\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\uff0c\u4ece\u800c\u63d0\u5347\u70ed\u70b9\u4e1a\u52a1\u7684\u5904\u7406\u80fd\u529b\u3002\u53e6\u5916\u4e00\u9762\uff0c\u5f53\u592a\u591a\u7684\u70ed\u70b9\u76f8\u5173\u7684\u4f1a\u8bdd\u8fdb\u5165\u5230\u6570\u636e\u5e93\u4e8b\u52a1\u5f15\u64ce\u5c42\u4e2d\uff0c\u4f1a\u589e\u52a0\u6570\u636e\u5e93\u5185\u90e8\u7684\u4e8b\u52a1\u8c03\u5ea6\uff08\u4e3b\u8981\u662f\u9501\u51b2\u7a81\u548c\u6b7b\u9501\u68c0\u6d4b\u76f8\u5173\uff09\u7684\u6210\u672c\uff0c\u4e3a\u4e86\u66f4\u597d\u7684\u5e76\u53d1\u6027\u80fd\uff0c\u8fd8\u53ef\u4ee5\u5bf9\u8fdb\u5165\u5230\u4e8b\u52a1\u5f15\u64ce\u5c42\u7684\u70ed\u70b9\u66f4\u65b0\u4f1a\u8bdd\u6570\u4f7f\u7528\u6392\u961f\u673a\u5236\u505a\u51fa\u4e00\u5b9a\u7684\u9650\u5236\uff0c\u7c7b\u4f3c\u4e8eJava\u5e94\u7528\u4e2d\u666e\u904d\u4f7f\u7528\u7684\u7ebf\u7a0b\u6c60\u673a\u5236\uff0c\u5bf9\u4e8e\u540c\u4e00\u4e2a\u70ed\u70b9\u7684\u66f4\u65b0\uff0c\u53ea\u5141\u8bb8\u5c11\u91cf\u7684\u5e76\u884c\u8fdb\u5165\u3002</p> <p>\u79d2\u6740\u573a\u666f\uff0c\u4ece\u4e1a\u52a1\u89d2\u5ea6\u6765\u770b</p> <p>- \u5355\u8bed\u53e5\u5355\u5546\u54c1\uff0c\u4e5f\u5c31\u662f\u53ea\u6709\u4e00\u5f20\u8868\uff0c\u5982\u4f18\u60e0\u5238\u6570\u91cf</p> <p>* \u4e8b\u52a1\u5355\u5546\u54c1\u3002\u5982\u5f00\u542f\u4e8b\u52a1\uff0c\u63d2\u5165\u6d41\u6c34\u8868\uff0c\u8fd8\u9700\u8981\u66f4\u65b0\u4e00\u4e2a\u5e93\u5b58\u8868\uff0c\u6700\u540e\u63d0\u4ea4\u4e8b\u52a1\u3002</p> <p>* \u4e8b\u52a1\u591a\u5546\u54c1\u3002\u5982\u8d2d\u7269\u8f66\u4e00\u6b21\u63d0\u4ea4\u591a\u4e2a\u5546\u54c1\u3002\u5c31\u662f\u5f00\u7403\u4e8b\u52a1\uff0c\u7136\u540e\u66f4\u65b0\u591a\u4e2a\u8868\uff0c\u6700\u540e\u63d0\u4ea4\u4e8b\u52a1\u3002</p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#3","title":"3. \u5b9e\u73b0\u65b9\u5f0f","text":""},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#31-updatecommit","title":"3.1 \u964d\u4f4eupdate\u548ccommit\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee","text":"<p>\u4ece\u56fe1\u53ef\u4ee5\u770b\u51fa\uff0c\u5bf9\u4e8e\u4e00\u822c\u4e1a\u52a1\u6765\u8bf4\uff0c\u4e8b\u52a1\u63d0\u4ea4\u9700\u8981\u663e\u5f0f\u7684\u6267\u884cset auto_commit=1\u6216\u8005commit\u8bed\u53e5\uff0c\u90a3\u4e48\u70ed\u70b9\u884c\u6301\u6709\u7684\u9501\uff0c\u6700\u5c11\u4f1a\u6301\u7eed\u4e00\u4e2a\u7f51\u7edc\u6765\u56de\u65f6\u95f4\u3002\u7279\u522b\u662f\u5e94\u7528\u670d\u52a1\u5668\u4e0e\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e0d\u5728\u540c\u4e00\u4e2a\u673a\u623f\u65f6\uff0c\u7f51\u7edc\u6765\u56de\u65f6\u95f4\u5927\u6982\u4e3a2ms\uff0c\u7531\u4e8e\u884c\u9501\u7684\u5b58\u5728\uff0c\u90a3\u4e48\u5bf9\u4e8e\u5355\u884c\u66f4\u65b0tps\u7684\u7406\u8bba\u4e0a\u9650\u4e3a500\u3002\u5982\u4f55\u51cf\u5c11\u6216\u907f\u514d\u8fd9\u4e2a\u7f51\u7edc\u4ea4\u4e92\u5f00\u9500\u5c31\u975e\u5e38\u91cd\u8981\u3002</p> <p>\u901a\u8fc7\u8c03\u67e5\u53d1\u73b0\uff0c\u4e1a\u52a1\u4e00\u822c\u4f1a\u6839\u636eupdate\u8bed\u53e5\u662f\u5426\u6210\u529f\uff0c\u6765\u51b3\u5b9a\u4e1a\u52a1\u903b\u8f91\u3002\u6bd4\u5982\u5728\u6263\u5e93\u5b58\u60c5\u51b5\u4e0b\uff0c\u5982\u679cupdate\u6210\u529f\u6267\u884c\uff0c\u5373affect_row\u4e3a1\uff0c\u5219\u63d0\u4ea4\u4e8b\u52a1\uff0c\u5426\u5219\u8ba4\u4e3a\u5931\u8d25\uff0c\u5219\u56de\u6eda\u4e8b\u52a1\u3002\u56e0\u6b64\u5982\u679c\u6211\u4eec\u5728SQL\u4e2d\u901a\u8fc7hint\u6307\u5bfc\u6570\u636e\u5e93\u8fdb\u884c\u76f8\u5e94\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u5c3d\u65e9\u7684\u91ca\u653e\u9501\uff0c\u63d0\u5347\u6570\u636e\u5e93TPS\u7684\u7406\u8bba\u4e0a\u9650\u3002\u4e3a\u6b64\u6211\u4eec\u5f15\u5165\u4e86\u4e09\u4e2aSQL Hint\u6765\u7528\u4f20\u9012\u6307\u4ee4\uff0c\u5982\u4e0b\u8868\u6240\u793a\uff1a</p> SQL Hint \u542b\u4e49 TARGET_AFFECT_ROW_H \u7528\u6765\u6307\u5b9aUpdate\u5fc5\u987b\u6210\u529f\u66f4\u65b0\u7684\u8bb0\u5f55\u6570\uff0c\u5982\u679c\u8bb0\u5f55\u6570\u4e0d\u5339\u914d\u89c6\u4e3a\u66f4\u65b0\u4e0d\u6210\u529f\u3002 COMMIT_ON_SUCCESS_H \u5982\u679cSQL\u6267\u884c\u4e0d\u62a5\u9519\uff0c\u5e76\u4e14\u66f4\u65b0\u8bb0\u5f55\u6570\u7b26\u5408TARGET_AFFECT_ROW_H\u8981\u6c42\uff0c\u5219\u81ea\u52a8\u63d0\u4ea4\u4e8b\u52a1\u3002 ROLLBACK_ON_FAIL_H \u5982\u679cSQL\u6267\u884c\u5931\u8d25\uff0c\u6216\u66f4\u65b0\u8bb0\u5f55\u6570\u4e0d\u7b26\u5408TARGET_AFFECT_ROW_H\u8981\u6c42\uff0c\u5219\u81ea\u52a8\u56de\u6eda\u4e8b\u52a1\u3002 <p>\u5728\u4e0d\u52a0\u4e0a\u97623\u4e2ahint\u7684\u60c5\u51b5\u4e0b\uff0c\u9700\u8981\u4e1a\u52a1\u4e3b\u52a8\u63d0\u4ea4\u3002\u5982\u679c\u52a0\u4e0aCOMMIT_ON_SUCCESS_H(1) TARGET_AFFECT_ROW_H(1)\uff0c\u8868\u793a\u5f53update\u6210\u529f\u66f4\u65b0\u4e00\u884c\u65f6\uff0c\u5219\u7acb\u5373\u63d0\u4ea4\uff0c\u5426\u5219\u7b49\u5f85\u4e1a\u52a1\u4e3b\u52a8\u53d1\u8d77commit\u6216\u8005rollback\u64cd\u4f5c\uff1b\u5982\u679c\u52a0\u4e0aROLLBACK_ON_FAIL_H(1) TARGET_AFFECT_ROW_H(1)\uff0c\u5219\u8868\u793a\u5982\u679cupdate\u66f4\u65b0\u7684\u884c\u6570\u4e0d\u4e3a1\uff0c\u5219\u7acb\u5373\u56de\u6eda\uff0c\u5426\u5219\u7b49\u5f85\u4e1a\u52a1\u4e3b\u52a8\u53d1\u8d77commit\u6216\u8005rollback\u64cd\u4f5c\uff1b\u5982\u679c\u4e09\u4e2ahint\u4e00\u8d77\u52a0\u4e0a\uff0c\u5219\u8868\u793a\u5047\u5982update\u66f4\u65b0\u7684\u884c\u6570\u4e3a1\uff0c\u5219\u7acb\u5373\u63d0\u4ea4\uff0c\u5426\u5219\u7acb\u5373\u56de\u6eda\u3002</p> <p>\u628a\u6301\u6709\u5173\u952e\u9501\u7684SQL\u4f5c\u4e3a\u6700\u540e\u4e00\u53e5\uff0c\u6dfb\u52a0commit_on_success_rollback_on_fail_target_affect_row,\u610f\u601d\u5c31\u662f\u53ea\u8981\u8fd9\u4e2aSQL\u6267\u884c\u6210\u529f\u5c31\u63d0\u4ea4\u4e8b\u52a1\uff0c\u53ca\u65f6\u91ca\u653e\u9501\u30021.\u907f\u514d\u4e86\u4e4b\u524dSQL\u6267\u884c\u6210\u529f\u8fd4\u56de\uff0c\u4e1a\u52a1\u518d\u53d1\u51facommit\u7684\u7f51\u7edc\u65f6\u95f4\u5f00\u9500\u30022.\u4e5f\u907f\u514d\u4e86\u5ba2\u6237\u7aef\u672c\u8eab\u963b\u585e\u6570\u636e\u5e93</p> <p></p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#32-innodb","title":"3.2 \u63a7\u5236\u548c\u9650\u5236\u8fdb\u5165InnoDB\u4e8b\u52a1\u5f15\u64ce\u5c42\u7684\u70ed\u70b9\u6570\u91cf","text":"<p>\u8fd9\u91cc\u4e3b\u8981\u6d89\u53ca\u4e00\u4e2a\u70ed\u70b9ID\u7684\u6807\u8bc6\uff0c\u4f7f\u7528QUEUE_ON_PK_H\u6807\u8bc6</p> <pre><code>update /*+ QUEUE_ON_PK_H(12345) */ tb1 set amount = amount - 1 where id=12345 and amount &gt; 10\n</code></pre> <p>\u5982\u4e0a\u6240\u793a\uff0c\u70ed\u70b9ID\u7684\u6807\u8bc6\u4f9d\u9760\u7528\u6237\u5728SQL\u4e2d\u4ee5hint\u7684\u65b9\u5f0f\u6ce8\u5165\uff0c\u8be5\u65b9\u5f0f\u6709\u4e24\u5927\u4f18\u70b9\uff1a</p> <ul> <li>\u4e1a\u52a1\u4eba\u5458\u53ef\u4ee5\u6839\u636e\u4e1a\u52a1\u81ea\u8eab\u60c5\u51b5\uff0c\u53ea\u5bf9\u53ef\u80fd\u6709\u70ed\u70b9\u66f4\u65b0\u7684\u8bed\u53e5\u4f7f\u7528\u8be5\u4f18\u5316\u3002</li> <li>\u4e0d\u652f\u6301\u8be5hint\u7684\u793e\u533a\u7248\u672c\uff0c\u4e5f\u80fd\u6b63\u5e38\u6267\u884c\u8be5SQL\uff0c\u53ea\u662f\u5c11\u4e86\u79d2\u6740\u6548\u679c\u3002</li> </ul> <p>\u5b9e\u73b0\u4e0a\uff0c\u503c\u521b\u5efa\u4e00\u4e2a\u7b49\u5f85\u961f\u5217\uff0c\u7136\u540e\u76f4\u63a5\u6267\u884c\uff0c\u5426\u5219\u5728\u8be5\u7b49\u5f85\u961f\u5217\u4e0a\u4f11\u7720\u3002\u5728update\u6267\u884c\u5b8c\u4e4b\u540e\uff0c\u5524\u9192\u76f8\u5173\u7b49\u5f85\u7ebf\u7a0b\u7ee7\u7eed\u6267\u884c</p> <p></p> <p>\u8fd9\u6837\u6709\u6548\u7684\u907f\u514d\u6b7b\u9501\u68c0\u6d4b\u548c\u9501\u51b2\u7a81</p> <p>\u4e1a\u52a1\u4e0a\u53ea\u9700\u8981\u518dSQL\u4e2d\u5408\u7406\u7684\u52a0\u4e0a\u524d\u9762\u7684\u56db\u4e2aSQL hint\uff0c\u5c31\u53ef\u4ee5\u5f00\u542f\u79d2\u6740\uff0c\u4e0d\u9650\u5ba2\u6237\u7aef\uff0c\u4e5f\u4e0d\u9650\u6846\u67b6\u3002</p> <p>\u53e6\u5916\u9700\u8981\u907f\u514d\u5916\u90e8\u8c03\u7528\uff0c\u5c3d\u91cf\u91c7\u7528\u56de\u8c03\u673a\u5236\u3002\u4f18\u5316\u4e8b\u52a1\u5185SQL\u8bed\u53e5\u7684\u987a\u5e8f\uff0c\u5c06\u51b2\u7a81\u91cd\u7684SQL\u5c3d\u53ef\u80fd\u653e\u540e\u9762\u3002\u5982\u628aselect\u653e\u5728\u524d\u9762\uff0c\u4e0d\u8981\u5148update\u540eselect\uff0c\u8fd9\u6837\u6301\u6709\u9501\u7684\u65f6\u95f4\u66f4\u52a0\u5ef6\u957f\u4e86\u3002\u3002</p>"},{"location":"database/08-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/#4","title":"4. \u6548\u679c","text":"<p>\u7ebf\u4e0a\u538b\u6d4b\u8fdb\u884c\u6027\u80fd\u8bc4\u4f30\u3002\u5173\u6ce8\u4e3b\u4ece\u5ef6\u8fdf\u3002\u6d4b\u8bd5\u5404\u79cd\u573a\u666f\uff0c\u5982\u6210\u529f\u63d0\u4ea4\uff0c\u5931\u8d25\u56de\u6eda\uff0c\u5e93\u5b58\u4e0d\u8db3\u7b49\u573a\u666f\uff0c\u8d2d\u7269\u8f66batch SQL\u662f\u5426\u6b63\u786e\u3002</p> <p>\u5f00\u542f\u4f18\u5316\u540e\uff0c2048\u4e2a\u7ebf\u7a0b\u65f6\u4ecd\u80fd\u4fdd\u63016000-7000TPS\u3002</p> <p>\u5728\u5c11\u91cf\u7ebf\u7a0b\u65f6\uff0c\u548c\u6ca1\u6709\u4f18\u5316\u7684\u5dee\u4e0d\u591a\u3002</p> <p>\u800c\u4e14\u8fd9\u6837\u7684\u65b9\u6848\u5f88\u65b9\u4fbf\u590d\u7528\u3002</p> <p></p> <p></p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/","title":"SQL\u4f18\u5316","text":"<p>\u4f60\u90fd\u505a\u8fc7\u54ea\u4e9bSQL\u4f18\u5316\uff1f\u8c03\u4f18\u77e5\u9053\u5417\uff1f\u600e\u4e48\u5904\u7406\u6162SQL\uff1f\u7b49\u7b49</p> <ul> <li>\u4e1a\u52a1\u5c42\u9762</li> </ul> <p>\u6bd4\u5982\u53ef\u4ee5\u52a0\u9650\u5236\u6761\u6570\u548c\u9650\u5236\u65f6\u95f4\u8303\u56f4\uff1a\u67e5\u8001\u5e08\u6700\u8fd1\u767b\u5f55\u7684\u8bb0\u5f55\uff0c\u53ea\u5141\u8bb8\u4f60\u67e5\u6700\u8fd1\u4e00\u4e2a\u6708\u7684\uff0c\u518d\u591a\u5c31\u4e0d\u5141\u8bb8\u4e86\u3002</p> <ul> <li>SQL\u5c42\u9762</li> </ul> <p>SQL\u4f18\u5316\u548c\u7d22\u5f15\u4f18\u5316</p> <ul> <li>\u6570\u636e\u5e93\u67b6\u6784</li> </ul> <p>\u5206\u5e93\u5206\u8868\uff1a</p> <p>\u8bfb\u5199\u5206\u79bb\uff1a\u8bfe\u7a0b\u62a5\u544a\u8868\u6570\u636e\u91cf\u5f88\u591a\uff0c\u505a\u4e86\u8bfb\u5199\u5206\u79bb\u3002\u6211\u662f\u60f3\u5f15\u5165shardingJDBC\uff0c\u4f46\u662f\u548cleader\u6c9f\u901a\u540e\u8bf4\u65f6\u95f4\u7d27\u6709\u98ce\u9669\uff0c\u76ee\u524d\u4e5f\u662f\u53ea\u5b9e\u73b0\u8bfb\u5199\u4e0d\u540c\u7684\u5e93\uff0c\u6240\u4ee5\u81ea\u5df1\u901a\u8fc7\u6ce8\u89e3\u5b9e\u73b0\u4e86\u4e00\u5957\uff0c\u6bcf\u4e2aSQL\u4e0a\u8d70\u4e0d\u540c\u7684\u6570\u636e\u5e93\u3002</p> <ul> <li>\u6570\u636e\u5e93\u670d\u52a1\u5668\u5c42\u9762</li> </ul> <p>\u670d\u52a1\u5668\u7aef\u4e5f\u53ef\u4ee5\u505a\u4e9b\u8c03\u4f18\uff0c\u8c03\u6574buffer poll \uff0c\u78c1\u76d8IO\u7b49\u53c2\u6570\uff0c\u4e00\u822c\u7531\u516c\u53f8\u7684\u8fd0\u7ef4/DBA\u8d1f\u8d23\u3002</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#sql_1","title":"\u6162SQL\u600e\u4e48\u5904\u7406\uff1f","text":"<p>\u6ce8\u610f\u8981\u4ece\u4e09\u4e2a\u6b65\u9aa4\u6765\u8003\u8651\uff0c\u5148\u662f\u662f\u5426\u52a0\u8f7d\u591a\u4f59\u6570\u636e\uff0c\u518d\u8003\u8651\u662f\u5426\u8d70\u7d22\u5f15\uff0c\u6700\u540e\u8003\u8651\u5206\u8868\u7b49</p> <p>\u5f00\u542f\u6162\u67e5\u8be2\u65e5\u5fd7\uff0c\u901a\u8fc7skywalking\u6216\u8005\u6570\u636e\u5e93\u7684\u4e00\u4e9b\u76d1\u63a7\u8f6f\u4ef6\u6765\u76d1\u63a7\u6162SQl\uff0c</p> <ul> <li>\u5206\u6790SQL\u662f\u5426\u52a0\u8f7d\u4e86\u591a\u4f59\u7684\u6570\u636e\uff0c\u662f\u5426\u9700\u8981\u6539\u5199SQL\u7f29\u5c0f\u67e5\u8be2\u8303\u56f4\uff1b</li> </ul> <p>insert\u65f6\u6279\u91cf\u63d2\u5165\u6570\u636e\uff0c\u907f\u514d\u7f51\u7edcIO</p> <ul> <li>\u67e5\u770b\u7d22\u5f15\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u5206\u6790SQL\u7684\u67e5\u8be2\u8ba1\u5212\uff0c\u4fee\u6539SQl\u6216\u8005\u589e\u52a0\u7d22\u5f15\uff0c\u907f\u514d\u5168\u8868\u626b\u63cf\u3002</li> </ul> <p>\u53ef\u4ee5\u5efa\u7acb\u9002\u5f53\u7684\u8054\u5408\u7d22\u5f15\u548c\u8986\u76d6\u7d22\u5f15\uff0c\u7d22\u5f15\u5982\u679c\u4e0d\u80fd\u5305\u542bnull\u503c\u5c31\u63d0\u524d\u58f0\u660enot null</p> <ul> <li>\u6700\u540e\u5982\u679c\u5b9e\u5728\u8868\u6570\u636e\u91cf\u5927\uff0c\u662f\u5426\u8981\u8bfb\u5199\u5206\u79bb\uff0c\u5206\u5e93\u5206\u8868\u3002</li> </ul>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#sql_2","title":"SQL\u4f18\u5316\u6848\u4f8b","text":"<p>zm\u4f18\u5316\u6848\u4f8b</p> <ul> <li> <p>\u4e0d\u8981\u8f7b\u6613\u5206\u7ec4\u6392\u5e8f\uff0c\u6392\u5e8f\u64cd\u4f5c\u6781\u8017\u8d44\u6e90</p> </li> <li> <p>\u4e0d\u8981\u4f7f\u7528 select * \u5199\u6cd5\uff0c\u53ea\u67e5\u8be2\u9700\u8981\u7684\u5217</p> </li> <li> <p>\u901a\u8fc7 limit \u65b9\u5f0f\u5206\u9875\u4f1a\u5bfc\u81f4\u540e\u7eed\u5206\u9875\u8d8a\u6765\u8d8a\u6162\uff0c\u53ef\u53d6\u524d\u4e00\u6b21\u5206\u9875\u7684\u6700\u5927 ID \u4f5c\u4e3a\u4e0b\u4e00\u9875\u53c2\u6570\u8f93\u5165\uff0c\u8fdb\u884c\u5206\u9875\u3002</p> </li> </ul> <p>\u5206\u9875\u53bb\u9664\u603b\u9875\u6570\uff0c\u53ea\u663e\u793a\u4e0a\u4e00\u9875\u4e0b\u4e00\u9875\u3002</p> <pre><code>-- \u867d\u7136 limit 100 \u548climit 1000000,100 \u7684\u89e3\u91ca\u8ba1\u5212\u76f8\u540c\uff0c\u4f46\u662f\u6267\u884c\u65f6\u95f4\u5dee\u5f02\u975e\u5e38\u5927\u3002\n-- limit m,n \u4e2d\u7684 m \u6570\u8d8a\u5927\uff0c\u5219\u67e5\u8be2\u8d8a\u6162\u3002limit 100 \u7684\u6267\u884c\u65f6\u95f4 0.05s\uff1blimit 1000000,100 \u7684\u6267\u884c\u65f6\u95f4 35s\nselect students.id,students.user_id,students.stu_city\n from students\n join students_seller on students.id=students_seller.student_id\n where students.created_at&gt;='2021-01-01'\n  and students_seller.state=0\n  limit 100;\n\n-- \u4f8b\u5982\u5047\u8bbe\u7b2c 10000 \u9875\u53d6\u5230\u7684 100 \u884c\u6570\u636e\u4e2d\u6700\u5927\u7684 students.ID \u4e3a 54978976\uff0c\u73b0\u5728\u9700\u8981\u53d6\u5f97\u7b2c 10001 \u9875\u7684 100 \u884c\u6570\u636e\n-- \u90a3\u4e48\u53ef\u4ee5\u6dfb\u52a0 students.id&gt;54978976,\u7136\u540e\u53d6 100 \u884c\u6570\u636e\uff0c\u6b64\u65b9\u6cd5\u53d6\u5f97\u7684\u5373\u4e3a\u7b2c 10001 \u9875\u7684\u6570\u636e\u3002\n-- \u901a\u8fc7 id \u5b57\u6bb5\u7684\u8303\u56f4\u9650\u5236\uff0c\u6bd4\u7b80\u5355\u7684 limit m,n \u66f4\u52a0\u9ad8\u6548\uff0c\u5373\u4f7f\u662f\u5927\u7684\u6570\u636e\u5206\u9875\u4e5f\u4e0d\u4f1a\u5bfc\u81f4\u6548\u7387\u53d8\u4f4e\u3002\u8be5\u65b9\u6cd5\u6267\u884c\u65f6\u95f4\u7a33\u5b9a\u4e3a 0.05s\nselect students.id,students.user_id,students.stu_city\n from students\n join students_seller on students.id=students_seller.student_id\n where students.created_at&gt;='2021-01-01'\n  and students_seller.state=0  \n  and students.id&gt;54978976 -- \u53d6\u4e0a\u4e00\u6b21\u5206\u9875\u7684\u6700\u5927ID\n  limit 100;\n</code></pre> <ul> <li>\u4f7f\u7528union/union all \u66ff\u6362 where \u5b50\u53e5\u4e2d\u7684 or \u8fde\u63a5\u6761\u4ef6</li> </ul> <pre><code>-- \u9700\u6c42\uff1a\u67e5\u8be218\u5e74\u540e\u548c\u6709\u5bf9\u5e94\u9500\u552e\u4eba\u5458\u7684\u5b66\u751f\n-- 1.\u56e0\u4e3a\u6761\u4ef6\u91cc\u6709 &gt;, &gt;=\uff0c\u6240\u4ee5\u4f7f\u7528or\u4e0d\u8d70\u7d22\u5f15\uff0c\u626b\u63cf\u5168\u8868\u3002\nselect count(0)\n from students\n where students.created_at &gt;= '2021-05-01'\n or students.referrer_user_id &gt; 0;\n\n -- 2.\u6539\u6210union\uff0c\u4f1a\u8d70\u7d22\u5f15\uff0c\u800c\u4e14\u4f1a\u8d70\u8986\u76d6\u7d22\u5f15using index\uff0c\u6548\u7387\u5f88\u9ad8\n select count(0) from \n (select id\n from students\n where students.created_at&gt;='2021-05-01'\n union\n select id\n from students\n where students.referrer_user_id&gt;0) as t;\n</code></pre> <ul> <li>\u4f7fjoin\u5173\u8054\u67e5\u8be2\u66ff\u6362\u5b50\u67e5\u8be2\uff0cin\uff0cexists\u5199\u6cd5</li> </ul> <p>\u5728 Mysql \u7684\u5199\u6cd5\u4e2d\uff0c\u975e\u5e38\u4e0d\u5efa\u8bae\u5b50\u67e5\u8be2\u5199\u6cd5\u3002\u5b50\u67e5\u8be2\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u67e5\u8be2\uff0c\u4e0d\u80fd\u53c2\u4e0e\u5230\u9a71\u52a8\u8868\u7684\u6570\u636e\u8fc7\u6ee4\uff0c\u800c\u4e14\u5b50\u67e5\u8be2\u7684\u7ed3\u679c\u6570\u636e\u4f1a\u88ab\u653e\u5230\u4e34\u65f6\u8868\u4e2d\u5b58\u653e\uff0c\u7136\u540e\u4e0e\u9a71\u52a8\u8868\u8fdb\u884c\u5173\u8054\uff0c\u6548\u7387\u975e\u5e38\u4f4e\u3002</p> <pre><code>-- \u8bf4\u660e\uff1apayments \u8868\u4f7f\u7528\u5355\u72ec\u7684\u5b50\u67e5\u8be2\uff0ctype \u4e3a ALL \u9700\u8981\u626b\u63cf\u6574\u4e2a payments \u8868\u8bb0\u5f55\uff0c\u5c06\u8fd4\u56de\u7684\u7ed3\u679c\u5b58\u653e\u5728\u4e34\u65f6\u8868\uff0c\u7136\u540e\u4e0e students \u8868\u8fdb\u884c\u5339\u914d\u3002\u67e5\u8be2\u8017\u65f6 22s\nselect sum(t.money)\nfrom students\njoin \n(select payments.stu_id,payments.money\nfrom payments\nwhere payments.is_paid=1\n  and payments.is_canceled=0\n  and payments.money&gt;0) as t \n  on students.id=t.stu_id\n    where students.created_at&gt;='2021-05-01'\n    and students.created_at&lt; '2021-06-01';\n\n-- \u8bf4\u660e\uff1a\u4e0d\u4f7f\u7528\u5b50\u67e5\u8be2\uff0c\u6539\u4e3a join \u5199\u6cd5\u540e\u3002\u67e5\u8be2\u9996\u5148\u6839\u636e students.created_at \u8d70\u7d22\u5f15\u626b\u63cf\uff0c\u7136\u540e\u6839\u636e\u67e5\u8be2\u7684\u7ed3\u679c\u4e0e payments \u8868\u7684 stu_id \u8fdb\u884c\u5173\u8054\u3002\u67e5\u8be2\u8017\u65f6 1.85s\nselect sum(payments.money)\nfrom students\njoin payments on students.id=payments.stu_id\nwhere payments.is_paid=1\n  and payments.is_canceled=0\n    and payments.money&gt;0\n    and students.created_at&gt;='2021-05-01'\n    and students.created_at&lt; '2021-06-01';\n</code></pre> <p>join\u8fd8\u53ef\u4ee5\u7528\u6765\u66ff\u4ee3not in</p> <pre><code>-- \u67e5\u8be2\u662f\u7edf\u8ba1 users \u8868\u521b\u5efa\u65f6\u95f4\u5927\u4e8e '2021-05-20 12:00:00'\uff0c\u4e14\u4e0d\u5728 users_account_number \u8868\u4e2d\u7684\u7528\u6237 ID\n-- \u8bf7\u6ce8\u610f id=2 \u7684 select_typ \u7c7b\u578b\u4e3a DEPENDENT SUBQUERY\uff0c\u8868\u793a\u5916\u5c42 select \u7ed3\u679c\u9700\u8981\u4f9d\u8d56\u4e8e\u5b50\u67e5\u8be2\u7684\u7ed3\u679c\u3002\u6548\u7387\u4f1a\u975e\u5e38\u5dee\nselect u.id \n from users u \n where u.updated_at &gt; '2021-05-20 12:00:00'\n and u.id not in(select a.user_id from users_account_number a);\n\n -- \u76f4\u63a5\u7528 join/left join \u7684\u5199\u6cd5\u66ff\u4ee3\uff0c\u6548\u7387\u5c06\u4f1a\u6709\u5927\u5e45\u63d0\u5347\nselect u.id \n from users u \n left join users_account_number a on u.id=a.user_id\n where u.updated_at &gt; '2021-05-20 12:00:00'\n and a.user_id is null;\n</code></pre> <ul> <li>\u7d22\u5f15\u5b57\u6bb5\u7c7b\u578b\u9519\u8bef\u6216\u51fd\u6570\u8fd0\u7b97\u5bfc\u81f4\u7d22\u5f15\u5931\u6548</li> </ul> <pre><code>-- users \u8868\u7684 mobile \u5b57\u6bb5\u662f varchar \u7c7b\u578b\uff0c\u5e76\u4e14\u521b\u5efa\u6709\u7d22\u5f15\uff0c\u4f46\u662f\u8f93\u5165\u53c2\u6570\u662f\u6574\u5f62\uff0c\u5bfc\u81f4\u67e5\u8be2\u65e0\u6cd5\u8d70\u7d22\u5f15\u626b\u63cf\uff0ctype \u4e3a ALL \u5168\u8868\u626b\u63cf\nselect *\n from users\n where mobile=13999999999;\n\n-- mobile \u4e3a varchar \u7c7b\u578b\uff0c\u5219\u5728\u53c2\u6570\u4e0a\u6dfb\u52a0\u5f15\u53f7''\u6807\u8bc6\u4e3a\u5b57\u7b26\u7c7b\u578b \u76f4\u63a5\u8d70\u552f\u4e00\u7d22\u5f15\nselect *\n from users\n where mobile='13999999999';\n</code></pre> <p>created_at\u5b57\u6bb5\u51fd\u6570\u8fd0\u7b97\u5bfc\u81f4\u7d22\u5f15\u5931\u6548</p> <pre><code>-- \u7531\u4e8e\u5728 students.created_at \u5b57\u6bb5\u4e0a\u4f7f\u7528 date \u51fd\u6570\uff0c\u5bfc\u81f4\u65e0\u6cd5\u901a\u8fc7 created_at \u5217\u5339\u914d\u6ee1\u8db3\u65f6\u95f4\u8981\u6c42\u7684\u6570\u636e\uff0c\u901a\u8fc7 rows \u5217\u53ef\u4ee5\u770b\u5230\u662f\u5168\u8868\u626b\u63cf 5285w \u6570\u636e\u91cf\u3002\n# \u6216\u8bb8\u6709\u4eba\u4f1a\u7591\u95ee\u65e2\u7136\u662f\u5168\u8868\u626b\u63cf\uff0c\u4e3a\u4ec0\u4e48 type \u662f index \u800c\u4e0d\u662f ALL\u3002\u8fd9\u662f\u56e0\u4e3a students \u8868\u53ea\u7528\u5230 created_at \u548c id \u5217\uff0c\u8fd9\u4e24\u5217\u662f\u76f4\u63a5\u5305\u542b\u5728\u7d22\u5f15\u4e2d\u7684\uff0c\u67e5\u8be2\u662f\u8d70\u7684\u8986\u76d6\u7d22\u5f15\u3002\nselect count(0)\n from students\n join students_seller on students.id=students_seller.student_id\n where date(students.created_at)='2021-05-05'\n  and students_seller.state=0;\n\n-- \u7531\u4e8e\u662f\u67e5\u8be2\u6ce8\u518c\u65f6\u95f4\u4e3a 2021-05-05 \u65e5\u7684\u5b66\u751f\uff0c\u90a3\u4e48\u53ef\u4ee5\u66ff\u4ee3\u4e3a\u4f7f\u7528 created_at&gt;= ... and &lt;= \u7684\u5199\u6cd5\n-- \u4f18\u5316\u540e\u67e5\u8be2\u6839\u636e students.created_at \u8d70\u7d22\u5f15\u8303\u56f4\u67e5\u8be2\uff0c\u5339\u914d\u884c\u6570 rows \u4e3a 134092 \u6761\uff0c\u7136\u540e\u4e0e students_seller \u8868\u5173\u8054\uff0c\u6548\u7387\u975e\u5e38\u9ad8\u3002\nselect count(0)\n from students\n join students_seller on students.id=students_seller.student_id\n where students.created_at&gt;='2021-05-05 00:00:00'\n   and students.created_at&lt;='2021-05-05 23:59:59'\n  and students_seller.state=0;\n</code></pre> <ul> <li>where + order by + limit \u67e5\u8be2\u9677\u9631</li> </ul> <p>\u5728\u7a0b\u5e8f\u8bbe\u8ba1\u4e2d\uff0c\u7ecf\u5e38\u9700\u8981\u7528\u5230 where+order by+limit \u5199\u6cd5\u83b7\u53d6\u6ee1\u8db3\u6761\u4ef6\u7684\u3001\u6392\u5e8f\u540e\u7684 N \u6761\u6570\u636e\u7ed3\u679c\u3002\u8fd9\u79cd\u5199\u6cd5\u672c\u8eab\u5e76\u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u8fd9\u6761\u8bed\u53e5\u5374\u5e38\u5e38\u5f15\u8d77\u4e25\u91cd\u7684\u6027\u80fd\u95ee\u9898\uff0c\u9700\u8981\u6211\u4eec\u91cd\u70b9\u5173\u6ce8\u3002</p> <pre><code># \u67e5\u8be2\u662f\u60f3\u53d6\u5f97\u5b66\u751f\u6ce8\u518c\u65f6\u95f4\u5728 2021-04-05 \u7684\uff0c\u5e76\u4e14 state=0 \u7684\uff0c\u6309\u7167\u66f4\u65b0\u65f6\u95f4\u53d6\u5f97\u6700\u8fd1 100 \u6761\u5b66\u751f\u8bb0\u5f55\u3002\n# \u8bf7\u6ce8\u610f\u89e3\u91ca\u8ba1\u5212\u4e2d\u7684 key \u4e3a updated_at \u5b57\u6bb5\uff0c\u6211\u4eec\u660e\u660e\u662f\u5bf9 created_at \u5b57\u6bb5\u505a\u8303\u56f4\u9650\u5236\uff0c\u4e3a\u5565 MySQL \u9009\u62e9\u8d70 updated_at \u5217\u7d22\u5f15\uff1f\nselect students.id,students.user_id,students_seller.seller_id,students.stu_city\n from students\n join students_seller on students.id=students_seller.student_id\n where students.created_at&gt;='2021-04-05'\n  and students.created_at&lt;='2021-04-05 23:59:59'\n  and students_seller.state=0\n order by students.updated_at desc \n limit 100;\n</code></pre> <p>\u5f53\u67e5\u8be2\u8bed\u53e5\u4e2d\u5305\u542b where+order by+limit \u65f6</p> <p>\u7531\u4e8e MySQL \u4f18\u5316\u5668\u4f1a\u8ba4\u4e3a\u6392\u5e8f order by \u662f\u975e\u5e38\u8017\u65f6\u7684\u64cd\u4f5c\uff0c\u5982\u679c\u80fd\u5728\u4e00\u5f00\u59cb\u5c31\u5c06\u7ed3\u679c\u505a\u6392\u5e8f\u8fd4\u56de\uff0c\u90a3\u662f\u6700\u597d\u7684\u3002\u800c\u4e14 limit 100 \u4f1a\u8ba9\u4f18\u5316\u5668\u8ba4\u4e3a\u8fd9 100 \u6761\u8bb0\u5f55\u662f\u5f88\u5bb9\u6613\u6ee1\u8db3\u7684\uff0c\u6b64\u65f6\u4f18\u5316\u5668\u4f1a\u8d70\u5982\u4e0b\u6267\u884c\u8ba1\u5212\uff1a</p> <pre><code>1. \u7531\u4e8e students.updated_at \u5b57\u6bb5\u672c\u8eab\u5c31\u6709\u7d22\u5f15\uff08\u5df2\u6392\u5e8f\uff09\uff0c\u6309\u7167 updated_at \u5b57\u6bb5\u6bcf\u6b21\u53d6 100 \u6761\u7ed3\u679c\uff0c\u7136\u540e\u8d70 where \u5339\u914d\uff0c\u5c06\u6ee1\u8db3\u7684\u7ed3\u679c\u8fd4\u56de\n\n2. \u91cd\u590d\u4ee5\u4e0a\u64cd\u4f5c\uff0c\u76f4\u5230\u6709 100 \u6761\u7ed3\u679c\u6ee1\u8db3\u8981\u6c42\uff0c\u5faa\u73af\u7ed3\u675f\n\n3. \u5982\u679c\u67e5\u8be2\u6309\u7167 students.updated_at \u6392\u5e8f\u7684\u6570\u636e\u7ecf\u8fc7 where \u6761\u4ef6\u8fc7\u6ee4\u540e\u80fd\u5feb\u901f\u6ee1\u8db3 100 \u6761\u7ed3\u679c\u8f93\u51fa\uff0c\u90a3\u4e48\u67e5\u8be2\u6216\u8bb8\u4f1a\u975e\u5e38\u5feb\n\n4. \u4f46\u5982\u679c\u4e00\u81f4\u6ca1\u6709\u53d6\u5230\u6ee1\u8db3 where \u6761\u4ef6\u7684 100 \u6761\u7ed3\u679c\uff0c\u4f1a\u4e00\u76f4\u5faa\u73af\u64cd\u4f5c\u76f4\u81f3\u904d\u5386 students \u6574\u4e2a\u8868\uff01\u90a3\u8fd9\u4e2a\u4ee3\u4ef7\u662f\u975e\u5e38\u6050\u6016\u7684\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u6784\u5efa\u5b50\u67e5\u8be2\u7684\u65b9\u5f0f\uff0c\u5f3a\u5236\u5148\u5bfc\u6267\u884c</p> <pre><code>select t.*\n from\n (select students.id, students.user_id, students_seller.seller_id,s tudents.stu_city, students.updated_at\n from students\n join students_seller on students.id=students_seller.student_id\n where students.created_at&gt;='2021-04-05'\n  and students.created_at&lt;='2021-04-05 23:59:59'\n  and students_seller.state=0) as t\norder by t.updated_at desc \nlimit 100;\n</code></pre>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#_1","title":"\u6570\u636e\u5e93\u89c4\u8303","text":""},{"location":"database/SQL%E4%BC%98%E5%8C%96/#_2","title":"\u5efa\u8868\u89c4\u8303","text":"<ul> <li>\u6570\u636e\u5e93\u8868\u5b57\u7b26\u96c6\u7edf\u4e00\u8bbe\u7f6e\u4e3a utf8mb4 \uff0c\u6392\u5e8f\u89c4\u5219\u4e3a utf8mb4_general_ci</li> </ul> <p>\u5f53\u5b57\u7b26\u96c6\u6216\u8005\u6392\u5e8f\u89c4\u5219\u4e0d\u4e00\u81f4\u65f6\uff0c\u4f1a\u5bfc\u81f4\u8868\u65e0\u6cd5\u5173\u8054\u67e5\u8be2\uff1b\u5982\u679c\u8fdb\u884c\u5b57\u7b26\u8f6c\u6362\uff0c\u4f1a\u5bfc\u81f4\u7d22\u5f15\u5931\u6548\uff0c\u800c\u4e14\u4e5f\u4f1a\u989d\u5916\u6d88\u8017\u6570\u636e\u5e93\u6027\u80fd\uff1b\u7edf\u4e00\u7684\u5b57\u7b26\u96c6\u548c\u6392\u5e8f\u89c4\u5219\u8bbe\u7f6e\uff0c\u80fd\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u5b57\u7b26\u96c6\u95ee\u9898</p> <ul> <li>\u5fc5\u987b\u5305\u542b deleted \uff0ccreate_time \uff0cupdate_time \u6570\u636e\u5217\uff08zm\u4e1a\u52a1\u89c4\u8303\u800c\u5df2\uff09</li> </ul> <p>\u903b\u8f91\u5220\u9664\uff0ccreate_time \uff0cupdate_time\u53ef\u4ee5\u4ea4\u7531\u6570\u636e\u5e93\u81ea\u52a8\u7ef4\u62a4\uff1b\u65b9\u4fbf\u8fdb\u884c\u589e\u91cf\u6570\u636e\u540c\u6b65\uff08BI\u90e8\u95e8\uff09</p> <ul> <li>\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528blog\u548ctext\u7b49\u5927\u5b57\u6bb5</li> </ul> <p>\u6570\u636e\u5e93\u5728\u5b58\u50a8\u5927\u5b57\u6bb5\u7684\u6570\u636e\u65f6\uff0c\u6570\u636e\u5217\u4e0a\u53ea\u5b58\u50a8\u6307\u5411\u5916\u90e8\u5b58\u50a8\u7684\u6307\u9488\uff0c\u67e5\u8be2\u65f6\u9700\u8981\u901a\u8fc7\u6307\u9488\u627e\u5230\u5916\u90e8\u5b58\u50a8\uff0c\u7136\u540e\u518d\u8bfb\u53d6\u5927\u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u589e\u52a0\u4e86\u989d\u5916\u7684\u78c1\u76d8IO\u64cd\u4f5c\uff0c\u6548\u7387\u4f4e\u4e0b\uff01</p> <p>\u8bfe\u7a0b\u62a5\u544a\u8868\u6709\u4e2a\u5b57\u6bb5\uff08\u77e5\u8bc6\u70b9\u5185\u5bb9\uff09\uff0c\u957f\u5ea6\u5f88\u5927\uff0c\u5355\u72ec\u62c6\u5206\u51fa\u6765\u3002</p> <ul> <li>\u5b57\u6bb5\u7c7b\u578b</li> </ul> <p>\u5b9a\u957f\u5b57\u7b26\u4e32\u5c3d\u91cf\u4f7f\u7528 char\uff0c\u4e0d\u8981\u4f7f\u7528 varchar\uff08\u6ce8\u610f char \u6700\u5927\u5b9a\u4e49\u4e3a 255 \uff09\uff1b</p> <p>\u5b57\u6bb5\u5c3d\u91cf\u8bbe\u7f6e\u4e3a\u975e\u7a7a\uff08 not null \uff09\uff0c\u5e76\u8bbe\u7f6e default \u5c5e\u6027\uff1b</p> <p>\u5b57\u6bb5\u957f\u5ea6\u6ee1\u8db3\u4e1a\u52a1\u9700\u6c42\u4e0b\u5c3d\u53ef\u80fd\u77ed\uff0c</p> <p>\u5e38\u89c1\u5b57\u6bb5\u7c7b\u578b\u7684\u957f\u5ea6\uff08\u4ee5\u4e0b\u5b57\u6bb5\u957f\u5ea6\u5747\u4e3a\u4e0d\u4e3a\u7a7a\u65f6\u7684\u5b57\u6bb5\u957f\u5ea6\uff09</p> <ul> <li> <p>tinyint 1 \u5b57\u8282\uff1bsmallint 2 \u5b57\u8282\uff1bint 4 \u5b57\u8282\uff1bbigint 8 \u5b57\u8282\uff1b</p> </li> <li> <p>date 3 \u5b57\u8282\uff1bdatetime 8 \u5b57\u8282\uff1btimestamp 4 \u5b57\u8282\uff1b</p> </li> </ul> <p>\u5b57\u7b26\u7c7b\u578b\u62ec\u53f7\u4e2d\u5b9a\u4e49\u7684\u6570\u5b57\u4e3a\u5b57\u7b26\u6570\uff0c\u5373 varchar(32) \u53ef\u4ee5\u5b58\u653e 32 \u4e2a\u6570\u5b57\u6216\u8005\u6c49\u5b57</p> <p>\u5982\u679c\u5b57\u6bb5\u4e3a varchar \u53d8\u957f\u7c7b\u578b\uff0c\u5f53\u5b9a\u4e49\u5c0f\u4e8e 255 \u5b57\u8282\u65f6\uff0c\u9700\u8981 1 \u5b57\u8282\u5b58\u653e\u5b57\u6bb5\u957f\u5ea6\uff1b\u5f53\u5b9a\u4e49\u8d85\u8fc7 255 \u5b57\u8282\u65f6\uff0c\u9700\u8981 2 \u5b57\u8282\u5b58\u653e\u5b57\u6bb5\u957f\u5ea6</p> <p>\u5b57\u7b26\u7c7b\u578b\u957f\u5ea6\u8ddf\u5b57\u7b26\u96c6\u6709\u5173\uff08\u5176\u4e2d utf8 \u5360\u7528 3 \u5b57\u8282\uff0cutf8mb4 \u5360\u7528 4 \u5b57\u8282\uff09</p> <p>varchar(10) \u7c7b\u578b\uff08utf8mb4\uff09\u5b57\u8282\u6570\uff1a 10*4B+1B=41B</p> <p>varchar(100) \u7c7b\u578b\uff08utf8mb4\uff09\u5b57\u8282\u6570\uff1a100*4B+2B=402B</p> <p>char(10) \u7c7b\u578b\uff08utf8mb4\uff09\u5b57\u8282\u6570\uff1a10*4B=40B</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#_3","title":"\u6570\u636e\u5e93\u5e38\u89c1\u95ee\u9898","text":""},{"location":"database/SQL%E4%BC%98%E5%8C%96/#_4","title":"\u5982\u4f55\u5e73\u6ed1\u7684\u7ed9\u8868\u6dfb\u52a0\u5b57\u6bb5\uff1f","text":"<p>\u5982\u679c\u6570\u636e\u91cf\u5f88\u5927\uff0c\u4f1a\u9501\u8868\u3002\u5f71\u54cd\u7ebf\u4e0a\u4e1a\u52a1</p> <ul> <li>\u5728\u51cc\u6668\u4e1a\u52a1\u4e0d\u7e41\u5fd9\u7684\u65f6\u5019\u6dfb\u52a0\u5b57\u6bb5\uff0c\u4e0d\u5f71\u54cd\u7ebf\u4e0a\u4e1a\u52a1\u3002</li> <li>\u63d0\u524d\u9884\u7559\u5b57\u6bb5\uff0c\u53ef\u4ee5\u9884\u7559\u5f88\u591a\u4e2a</li> <li>\u65b0\u5efa\u4e00\u5f20\u8868\u5305\u542b\u65b0\u5b57\u6bb5\u7684\uff0c\u7136\u540eDTS\u8fc1\u79fb\u8fc7\u53bb\uff0c\u7136\u540e\u67e5\u65b0\u8868\u3002\u628a\u8001\u8868\u6539\u6210\u522b\u7684\u540d\u5b57\uff0c\u65b0\u8868\u6539\u6210\u6b63\u786e\u7684\u8868\u540d\u3002</li> <li>\u63d0\u524d\u8bbe\u8ba1\uff0c\u4f7f\u7528key/value\u65b9\u6cd5\u5b58\u50a8\u5230redis\u91cc\uff0c\u4f18\u96c5\uff01</li> </ul>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#_5","title":"\u95ee\u9898\u6848\u4f8b","text":""},{"location":"database/SQL%E4%BC%98%E5%8C%96/#1","title":"1. \u5927\u91cf\u540c\u65f6\u66f4\u65b0\u8868\u5bfc\u81f4\u8fde\u63a5\u6c60\u4e0d\u591f\u7528","text":"<pre><code>GlobalExceptionHandler(Exception)  error:nested exception is org.apache.ibatis.exceptions.PersistenceException:  ### Error  querying database. Cause:  org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain  JDBC Connection; nested exception is  java.sql.SQLTransientConnectionException: hikari - Connection is not  available, request timed out after 10000ms.  ### The error  may exist in URL  \n</code></pre> <p>\u6392\u67e5\u8fc7\u7a0b\uff1a</p> <p>\u7ebf\u4e0a\u77ed\u65f6\u95f4\u5927\u91cf\u62a5\u9519\uff0c\u770b\u65e5\u5fd7\u662f\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u4e0d\u591f\u4e86\u3002</p> <p>\u7136\u540e\u53bb\u67e5\u770b\u516c\u53f8\u7684\u6162SQL\u65e5\u5fd7\u8bb0\u5f55\uff0c\u53d1\u73b0\u6709\u4e2aSQL\u662f\u6162SQL\uff0c\u800c\u4e14\u65f6\u95f4\u662f\u4e0d\u65ad\u7d2f\u52a0\u7684\uff0c\u4e5f\u5c31\u662f\u5f00\u59cb1\u79d2\uff0c\u7136\u540e3\u79d2\uff0c4\u79d2\u3002</p> <p>\u5206\u6790\u8fd9\u4e2aSQL\u5f88\u7b80\u5355\u5c31\u662fupdate\u64cd\u4f5c\uff0c\u6761\u4ef6\u662fwhere device_id ='cccc'\u3002\u867d\u7136\u8868\u8bb0\u5f55\u53ea\u67092\u4e07\u591a\u884c\uff0c\u4f46\u662f\u8fd9\u4e2a\u6761\u4ef6\u5217\u6ca1\u6709\u5efa\u7acb\u7d22\u5f15\uff0c\u67e5\u770b\u6267\u884c\u8ba1\u5212\uff0c\u662fALL\u5168\u8868\u626b\u63cf\u3002\u5f53\u4e1a\u52a1\u540c\u65f6\u53d1\u751f\u5927\u6279\u91cf\u66f4\u65b0\uff0c\u56e0\u4e3a\u6ca1\u6709\u7d22\u5f15\u5bfc\u81f4\u4e86\u9501\u5168\u8868\uff0c\u5f88\u591aSQL\u5360\u7528\u4e86\u8fde\u63a5\uff0c\u6162\u6162\u7684\u8fde\u63a5\u6c60\u4e0d\u591f\u7528\u4e86</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <p>\u5c31\u662f\u6761\u4ef6\u5b57\u6bb5\u5efa\u7acb\u7d22\u5f15\u3002</p> <p>\u6269\u5c55\uff1a</p> <p>\u5373\u4fbf\u6709\u4e8c\u7ea7\u7d22\u5f15\uff0c\u5f53MySQL\u9884\u4f30\u626b\u63cf\u884c\u6570\u8d85\u8fc7\u5168\u8868\u603b\u6570\u7ea6 20% \uff5e 30% \u65f6\uff0c\u4e5f\u4f1a\u76f4\u63a5\u5347\u7ea7\u4e3a\u5168\u8868\u626b\u63cf\u3002\u8fd9\u79cd\u60c5\u51b5\u4e00\u822c\u4e0d\u8003\u8651\uff0c\u56e0\u4e3a\u5b9e\u9645\u7684\u67e5\u8be2\u884c\u6570\u4e00\u822c\u4e0d\u4f1a\u8d85\u8fc7\u5168\u8868\u768430%\u3002</p> <p>Each table index is queried, and the best index is used unless the optimizer believes that it is more efficient to use a table scan. At one time, a scan was used based on whether the best index spanned more than 30% of the table, but a fixed percentage no longer determines the choice between using an index or a scan. The optimizer now is more complex and bases its estimate on additional factors such as table size, number of rows, and I/O block size.</p> <p>https://blog.csdn.net/n88Lpo/article/details/78099094\u5199\u7684\u4e0d\u9519\uff0c\u6709\u5b9e\u8df5\u8bc1\u660e</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#2","title":"2. \u4f18\u5316\u5668\u9009\u62e9\u4e86\u9519\u8bef\u7684\u7d22\u5f15","text":"<p>\u80cc\u666f\uff1a\u540d\u7247\u7684\u7533\u8bf7\u8ba2\u5355\u8868\u6709\u51e0\u5341\u4e07\u6761\u6570\u636e\uff0c\u5efa\u6709\uff08shop_id\uff0corder_token\uff0cstatus)\u7684\u7d22\u5f15\uff0c\u4e5f\u6709time\u7684\u7d22\u5f15\u3002\u6839\u636e\u8fd9\u4e9b\u6761\u4ef6\u6765\u67e5\u8be2\u65f6\uff0cmysql\u4f18\u5316\u5668\u975e\u8981\u8d70shop_id\u7684\u7d22\u5f15\uff08\u533a\u5206\u5ea6\u4e0d\u9ad8\uff0c\u5927\u6982\u5341\u51e0\u4e2a\u4e0d\u540c\u7684\u503c\uff09\uff0c\u4f46\u7ecf\u6d4b\u8bd5\uff08force index\uff09\u53d1\u73b0\u8d70time\u7d22\u5f15\u80af\u5b9a\u66f4\u5feb\u3002</p> <p>\u505a\u6cd5\uff1a\u56e0\u4e3ashop_id\u7d22\u5f15\u533a\u5206\u5ea6\u4e0d\u9ad8\uff0c\u4e14\u547d\u540d\u4e5f\u4e0d\u89c4\u8303\uff0c\u4e8e\u662f\u5220\u9664\u4e4b\u3002\u518d\u6d4b\u8bd5\u5c31\u8d70\u4e86\u6b63\u786e\u7684time\u7d22\u5f15\u3002</p> <p>\u539f\u7406\uff1a</p> <p>\u4f18\u5316\u5668\u4f1a\u6839\u636e\u626b\u63cf\u884c\u6570\uff0c\u8fd8\u6709\u662f\u5426\u4f7f\u7528\u4e34\u65f6\u8868\uff0c\u662f\u5426\u6392\u5e8f\uff0c\u662f\u5426\u8981\u56de\u8868\u7b49\u56e0\u7d20\u7efc\u5408\u5224\u65ad\u3002</p> <p>\u4f18\u5316\u5668\u5e76\u4e0d\u77e5\u9053\u7cbe\u786e\u7684\u8bb0\u5f55\u6761\u6570\uff0c\u53ea\u80fd\u6839\u636e\u7edf\u8ba1\u4fe1\u606f\u8fdb\u884c\u4f30\u7b97\uff0c\u6839\u636e\u7684\u662f\u7d22\u5f15\u7684\u533a\u5206\u5ea6\u3002\u4e00\u4e2a\u7d22\u5f15\u4e0a\u4e0d\u540c\u7684\u503c\u8d8a\u591a\uff0c\u533a\u5206\u5ea6\u5c31\u8d8a\u597d\u3002\u4e00\u4e2a\u7d22\u5f15\u4e0a\u4e0d\u540c\u7684\u503c\u4e2a\u6570\uff0c\u79f0\u4e3a\u57fa\u6570\uff0c\u57fa\u6570\u8d8a\u5927\uff0c\u7d22\u5f15\u533a\u5206\u5ea6\u8d8a\u597d\u3002<code>show index from t</code> \u53ef\u4ee5\u67e5\u770b\u7d22\u5f15\u7684\u57fa\u6570\u3002</p> <p>\u4f18\u5316\u5668\u662f\u91c7\u7528\u91c7\u6837\u7edf\u8ba1\u7684\u65b9\u5f0f\u6765\u5f97\u5230\u7d22\u5f15\u7684\u57fa\u6570\uff0c\u5982\u900910\u4e2a\u6570\u636e\u9875\uff0c\u7edf\u8ba1\u8fd9\u4e9b\u9875\u4e0a\u7684\u5e73\u5747\u503c\uff0c\u4e58\u4ee5\u7d22\u5f15\u7684\u9875\u6570\uff0c\u5f97\u5230\u8fd9\u4e2a\u7d22\u5f15\u7684\u57fa\u6570\u3002</p> <p>\u5f88\u660e\u663e\uff0c\u8fd9\u4e2a\u7edf\u8ba1\u4fe1\u606f\u5f88\u53ef\u80fd\u4e0d\u51c6\uff0c\u5bfc\u81f4\u4f18\u5316\u5668\u4f30\u7b97\u7684\u626b\u63cf\u884c\u6570\u4e5f\u4f1a\u4e0d\u51c6\uff0c\u4ece\u800c\u5bfc\u81f4\u9009\u62e9\u9519\u8bef\u7684\u7d22\u5f15\u3002\u6211\u4eec\u53ef\u4ee5\u7528analyze table t\u6765\u91cd\u65b0\u7edf\u8ba1\u7d22\u5f15\u4fe1\u606f\uff0c</p> <p>\u7d22\u5f15\u9009\u62e9\u5f02\u5e38\u7684\u5904\u7406</p> <ol> <li>\u91c7\u7528force index\u5f3a\u884c\u9009\u62e9\u4e00\u4e2a\u7d22\u5f15\u3002\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u4e0d\u591f\u4fbf\u6377\uff0c\u4e5f\u4e0d\u4f18\u7f8e</li> <li>\u4fee\u6539SQL\u3002\u6bd4\u5982\u5b50\u67e5\u8be2\uff0c</li> <li>\u65b0\u5efa\u5408\u9002\u7684\u7d22\u5f15\uff0c\u751a\u81f3\u5220\u9664\u9519\u8bef\u7684\u7d22\u5f15</li> </ol>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#88","title":"8.8 \u7406\u89e3\u67e5\u8be2\u6267\u884c\u8ba1\u5212","text":"<p>\u6839\u636e\u4f60\u7684\u8868\u3001\u5217\u3001\u7d22\u5f15\u7684\u7ec6\u8282\u4ee5\u53ca\u4f60\u7684WHERE\u5b50\u53e5\u4e2d\u7684\u6761\u4ef6\uff0cMySQL\u4f18\u5316\u5668\u8003\u8651\u4e86\u8bb8\u591a\u6280\u672f\u6765\u6709\u6548\u5730\u6267\u884cSQL\u67e5\u8be2\u4e2d\u6d89\u53ca\u7684\u67e5\u627e\u3002\u5bf9\u4e00\u4e2a\u5de8\u5927\u7684\u8868\u7684\u67e5\u8be2\u53ef\u4ee5\u5728\u4e0d\u8bfb\u53d6\u6240\u6709\u884c\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\uff1b\u6d89\u53ca\u51e0\u4e2a\u8868\u7684\u8fde\u63a5\u53ef\u4ee5\u5728\u4e0d\u6bd4\u8f83\u6bcf\u4e2a\u884c\u7684\u7ec4\u5408\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u3002\u4f18\u5316\u5668\u4e3a\u6267\u884c\u6700\u6709\u6548\u7684\u67e5\u8be2\u800c\u9009\u62e9\u7684\u4e00\u7ec4\u64cd\u4f5c\u88ab\u79f0\u4e3a \"\u67e5\u8be2\u6267\u884c\u8ba1\u5212query execution plan\"\uff0c\u4e5f\u88ab\u79f0\u4e3aEXPLAIN\u8ba1\u5212\u3002\u4f60\u7684\u76ee\u6807\u662f\u8bc6\u522bEXPLAIN\u8ba1\u5212\u4e2d\u8868\u660e\u67e5\u8be2\u88ab\u5f88\u597d\u4f18\u5316\u7684\u65b9\u9762\uff0c\u5e76\u5b66\u4e60SQL\u8bed\u6cd5\u548c\u7d22\u5f15\u6280\u672f\uff0c\u4ee5\u4fbf\u5728\u770b\u5230\u4e00\u4e9b\u4f4e\u6548\u64cd\u4f5c\u65f6\u6539\u8fdb\u8ba1\u5212\u3002</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#881explain","title":"8.8.1\u4f7f\u7528EXPLAIN\u4f18\u5316\u67e5\u8be2","text":"<p>EXPLAIN\u8bed\u53e5\u63d0\u4f9b\u5173\u4e8eMySQL\u5982\u4f55\u6267\u884c\u8bed\u53e5\u7684\u4fe1\u606f\uff1a</p> <ul> <li> <p>EXPLAIN\u4e0eSELECT\u3001DELETE\u3001INSERT\u3001REPLACE\u548cUPDATE\u8bed\u53e5\u4e00\u8d77\u5de5\u4f5c\u3002</p> </li> <li> <p>\u5f53EXPLAIN\u4e0e\u53ef\u89e3\u91ca\u8bed\u53e5\u4e00\u8d77\u4f7f\u7528\u65f6\uff0cMySQL\u663e\u793a\u6765\u81ea\u4f18\u5316\u5668\u7684\u5173\u4e8e\u8bed\u53e5\u6267\u884c\u8ba1\u5212\u7684\u4fe1\u606f\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cMySQL\u89e3\u91ca\u5b83\u5c06\u5982\u4f55\u5904\u7406\u8be5\u8bed\u53e5\uff0c\u5305\u62ec\u5173\u4e8e\u5982\u4f55\u8fde\u63a5\u8868\u548c\u4ee5\u4f55\u79cd\u987a\u5e8f\u8fde\u63a5\u7684\u4fe1\u606f\u3002\u5173\u4e8e\u4f7f\u7528EXPLAIN\u83b7\u5f97\u6267\u884c\u8ba1\u5212\u4fe1\u606f\u7684\u4fe1\u606f\uff0c\u89c1\u7b2c8.8.2\u8282 \"EXPLAIN\u8f93\u51fa\u683c\u5f0f\"\u3002</p> </li> <li> <p>\u5f53EXPLAIN\u4e0eFOR CONNECTION connection_id\u4e00\u8d77\u4f7f\u7528\uff0c\u800c\u4e0d\u662f\u4e0e\u53ef\u89e3\u91ca\u7684\u8bed\u53e5\u4e00\u8d77\u4f7f\u7528\u65f6\uff0c\u4f1a\u663e\u793a\u5728\u6307\u5b9a\u8fde\u63a5\u4e2d\u6267\u884c\u7684\u8bed\u53e5\u7684\u6267\u884c\u8ba1\u5212\u3002\u53c2\u89c1\u7ae0\u82828.8.4, \"\u83b7\u53d6\u547d\u540d\u8fde\u63a5\u7684\u6267\u884c\u8ba1\u5212\u4fe1\u606f\"\u3002</p> </li> <li> <p>\u5bf9\u4e8eSELECT\u8bed\u53e5\uff0cEXPLAIN\u4ea7\u751f\u989d\u5916\u7684\u6267\u884c\u8ba1\u5212\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528SHOW WARNINGS\u6765\u663e\u793a\u3002\u53c2\u89c1\u7ae0\u82828.8.3, \"\u6269\u5c55\u7684EXPLAIN\u8f93\u51fa\u683c\u5f0f\"\u3002</p> </li> <li> <p>EXPLAIN\u5bf9\u4e8e\u68c0\u67e5\u6d89\u53ca\u5206\u533a\u8868\u7684\u67e5\u8be2\u975e\u5e38\u6709\u7528\u3002\u53c2\u89c1\u7ae0\u828222.3.5, \"\u83b7\u53d6\u5173\u4e8e\u5206\u533a\u7684\u4fe1\u606f\"\u3002</p> </li> <li> <p>FORMAT\u9009\u9879\u53ef\u4ee5\u7528\u6765\u9009\u62e9\u8f93\u51fa\u683c\u5f0f\u3002TRADITIONAL\u662f\u4ee5\u8868\u683c\u683c\u5f0f\u8f93\u51fa\u7684\u3002\u5982\u679c\u6ca1\u6709FORMAT\u9009\u9879\uff0c\u8fd9\u662f\u9ed8\u8ba4\u7684\u3002JSON\u683c\u5f0f\u4ee5JSON\u683c\u5f0f\u663e\u793a\u4fe1\u606f\u3002</p> </li> </ul> <p>\u5728EXPLAIN\u7684\u5e2e\u52a9\u4e0b\uff0c\u4f60\u53ef\u4ee5\u770b\u5230\u4f60\u5e94\u8be5\u5728\u54ea\u91cc\u7ed9\u8868\u6dfb\u52a0\u7d22\u5f15\uff0c\u4ee5\u4fbf\u901a\u8fc7\u4f7f\u7528\u7d22\u5f15\u6765\u67e5\u627e\u884c\uff0c\u4f7f\u8bed\u53e5\u6267\u884c\u5f97\u66f4\u5feb\u3002\u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528EXPLAIN\u6765\u68c0\u67e5\u4f18\u5316\u5668\u662f\u5426\u4ee5\u6700\u4f73\u987a\u5e8f\u8fde\u63a5\u8868\u3002\u4e3a\u4e86\u63d0\u793a\u4f18\u5316\u5668\u4f7f\u7528\u4e0e\u8868\u5728SELECT\u8bed\u53e5\u4e2d\u7684\u547d\u540d\u987a\u5e8f\u76f8\u5bf9\u5e94\u7684\u8fde\u63a5\u987a\u5e8f\uff0c\u53ef\u4ee5\u7528SELECT STRAIGHT_JOIN\u5f00\u59cb\u8bed\u53e5\uff0c\u800c\u4e0d\u662f\u4ec5\u4ec5\u7528SELECT\u3002(\u53c2\u89c1\u7ae0\u828213.2.9, \"SELECT\u8bed\u53e5\"\u3002)\u7136\u800c\uff0cSTRAIGHT_JOIN\u53ef\u80fd\u4f1a\u963b\u6b62\u7d22\u5f15\u7684\u4f7f\u7528\uff0c\u56e0\u4e3a\u5b83\u7981\u7528\u4e86\u534a\u8fde\u63a5\u7684\u8f6c\u6362\u3002\u53c2\u89c1\u7ae0\u82828.2.2.1, \"\u7528\u534a\u8fde\u63a5\u8f6c\u6362\u4f18\u5316\u5b50\u67e5\u8be2\u3001\u6d3e\u751f\u8868\u548c\u89c6\u56fe\u5f15\u7528\"\u3002</p> <p>\u4f18\u5316\u5668\u8ddf\u8e2a\u6709\u65f6\u53ef\u4ee5\u63d0\u4f9b\u4e0eEXPLAIN\u4e92\u8865\u7684\u4fe1\u606f\u3002\u7136\u800c\uff0c\u4f18\u5316\u5668\u8ddf\u8e2a\u7684\u683c\u5f0f\u548c\u5185\u5bb9\u5728\u4e0d\u540c\u7684\u7248\u672c\u4e2d\u4f1a\u6709\u53d8\u5316\u3002\u8be6\u60c5\u8bf7\u89c1MySQL\u5185\u90e8\u3002\u8ffd\u8e2a\u4f18\u5316\u5668\u3002</p> <p>\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5373\u5f53\u4f60\u8ba4\u4e3a\u5e94\u8be5\u4f7f\u7528\u7d22\u5f15\u65f6\u5374\u6ca1\u6709\u4f7f\u7528\uff0c\u90a3\u4e48\u8fd0\u884cANALYZE TABLE\u6765\u66f4\u65b0\u8868\u7684\u7edf\u8ba1\u6570\u636e\uff0c\u5982\u952e\u7684cardinality\uff0c\u8fd9\u53ef\u4ee5\u5f71\u54cd\u4f18\u5316\u5668\u7684\u9009\u62e9\u3002\u53c2\u89c1\u7b2c13.7.2.1\u8282\uff0c\"ANALYZE TABLE\u8bed\u53e5\"\u3002</p> <p>\u6ce8\u610f EXPLAIN\u4e5f\u53ef\u4ee5\u7528\u6765\u83b7\u5f97\u5173\u4e8e\u8868\u4e2d\u5217\u7684\u4fe1\u606f\u3002EXPLAIN tbl_name\u4e0eDESCRIBE tbl_name\u548cSHOW COLUMNS FROM tbl_name\u540c\u4e49\u3002\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u89c1\u7ae0\u828213.8.1, \"DESCRIBE\u8bed\u53e5 \"\u548c\u7ae0\u828213.7.5.5, \"SHOW COLUMNS\u8bed\u53e5\"\u3002</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#882-explain","title":"8.8.2 EXPLAIN\u8f93\u51fa\u683c\u5f0f","text":"<p>EXPLAIN\u8bed\u53e5\u63d0\u4f9b\u5173\u4e8eMySQL\u5982\u4f55\u6267\u884c\u8bed\u53e5\u7684\u4fe1\u606f\u3002EXPLAIN\u4e0eSELECT\u3001DELETE\u3001INSERT\u3001REPLACE\u548cUPDATE\u8bed\u53e5\u4e00\u8d77\u5de5\u4f5c\u3002</p> <p>EXPLAIN\u4e3aSELECT\u8bed\u53e5\u4e2d\u4f7f\u7528\u7684\u6bcf\u4e2a\u8868\u8fd4\u56de\u4e00\u884c\u4fe1\u606f\u3002\u5b83\u5728\u8f93\u51fa\u4e2d\u6309\u7167MySQL\u5728\u5904\u7406\u8bed\u53e5\u65f6\u8bfb\u53d6\u5b83\u4eec\u7684\u987a\u5e8f\u5217\u51fa\u8868\u3002MySQL\u4f7f\u7528\u5d4c\u5957\u5faa\u73af\u8fde\u63a5\u65b9\u6cd5\u89e3\u51b3\u6240\u6709\u8fde\u63a5\u3002\u8fd9\u610f\u5473\u7740MySQL\u4ece\u7b2c\u4e00\u4e2a\u8868\u4e2d\u8bfb\u53d6\u4e00\u6761\u8bb0\u5f55\uff0c\u7136\u540e\u5728\u7b2c\u4e8c\u4e2a\u8868\u3001\u7b2c\u4e09\u4e2a\u8868\u4e2d\u627e\u5230\u5339\u914d\u7684\u8bb0\u5f55\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002\u5f53\u6240\u6709\u7684\u8868\u90fd\u88ab\u5904\u7406\u540e\uff0cMySQL\u8f93\u51fa\u6240\u9009\u62e9\u7684\u5217\uff0c\u5e76\u5728\u8868\u5217\u8868\u4e2d\u56de\u6eaf\uff0c\u76f4\u5230\u627e\u5230\u4e00\u4e2a\u6709\u66f4\u591a\u5339\u914d\u884c\u7684\u8868\u3002\u4e0b\u4e00\u6761\u8bb0\u5f55\u5c06\u4ece\u8fd9\u4e2a\u8868\u4e2d\u8bfb\u53d6\uff0c\u7136\u540e\u7ee7\u7eed\u5904\u7406\u4e0b\u4e00\u4e2a\u8868\u3002</p> <p>EXPLAIN\u8f93\u51fa\u5305\u62ec\u5206\u533a\u4fe1\u606f\u3002\u53e6\u5916\uff0c\u5bf9\u4e8eSELECT\u8bed\u53e5\uff0cEXPLAIN\u4ea7\u751f\u7684\u6269\u5c55\u4fe1\u606f\u53ef\u4ee5\u5728EXPLAIN\u4e4b\u540e\u7528SHOW WARNINGS\u6765\u663e\u793a\uff08\u53c2\u89c1\u7ae0\u82828.8.3, \"\u6269\u5c55\u7684EXPLAIN\u8f93\u51fa\u683c\u5f0f\"\uff09\u3002</p> <p>\u6ce8\u610f \u5728\u8f83\u65e9\u7684MySQL\u7248\u672c\u4e2d\uff0c\u5206\u533a\u548c\u6269\u5c55\u4fe1\u606f\u662f\u4f7f\u7528EXPLAIN PARTITIONS\u548cEXPLAIN EXTENDED\u4ea7\u751f\u7684\u3002\u4e3a\u4e86\u5411\u540e\u517c\u5bb9\uff0c\u8fd9\u4e9b\u8bed\u6cd5\u4ecd\u7136\u88ab\u8ba4\u53ef\uff0c\u4f46\u662f\u5206\u533a\u548c\u6269\u5c55\u8f93\u51fa\u73b0\u5728\u662f\u9ed8\u8ba4\u542f\u7528\u7684\uff0c\u6240\u4ee5PARTITIONS\u548cEXTENDED\u5173\u952e\u5b57\u662f\u591a\u4f59\u7684\uff0c\u5e76\u4e14\u88ab\u5e9f\u5f03\u3002\u4f7f\u7528\u5b83\u4eec\u4f1a\u5bfc\u81f4\u4e00\u4e2a\u8b66\u544a\uff1b\u9884\u8ba1\u5b83\u4eec\u4f1a\u5728\u672a\u6765\u7684MySQL\u7248\u672c\u4e2d\u4eceEXPLAIN\u8bed\u6cd5\u4e2d\u5220\u9664\u3002</p> <p>\u4f60\u4e0d\u80fd\u5728\u540c\u4e00\u4e2aEXPLAIN\u8bed\u53e5\u4e2d\u540c\u65f6\u4f7f\u7528\u5df2\u5e9f\u5f03\u7684PARTITIONS\u548cEXTENDED\u5173\u952e\u5b57\u3002\u6b64\u5916\uff0c\u8fd9\u4e9b\u5173\u952e\u5b57\u90fd\u4e0d\u80fd\u4e0eFORMAT\u9009\u9879\u4e00\u8d77\u4f7f\u7528\u3002</p> <p>\u6ce8\u610f MySQL Workbench\u6709\u4e00\u4e2a\u53ef\u89c6\u5316\u89e3\u91ca\u529f\u80fd\uff0c\u63d0\u4f9bEXPLAIN\u8f93\u51fa\u7684\u53ef\u89c6\u5316\u8868\u793a\u3002\u89c1\u6559\u7a0b\u3002\u4f7f\u7528\u89e3\u91ca\u6765\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\u3002</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#explain","title":"EXPLAIN \u8f93\u51fa\u5217","text":"<p>\u672c\u8282\u63cf\u8ff0\u4e86\u7531EXPLAIN\u4ea7\u751f\u7684\u8f93\u51fa\u5217\u3002\u540e\u9762\u7684\u7ae0\u8282\u63d0\u4f9b\u4e86\u5173\u4e8etype\u548cExtra\u5217\u7684\u5176\u4ed6\u4fe1\u606f\u3002</p> <p>EXPLAIN\u7684\u6bcf\u4e00\u6761\u8f93\u51fa\u884c\u90fd\u63d0\u4f9b\u4e86\u5173\u4e8e\u4e00\u4e2a\u8868\u7684\u4fe1\u606f\u3002\u6bcf\u4e00\u884c\u90fd\u5305\u542b\u4e86\u88688.1 \"EXPLAIN\u8f93\u51fa\u5217 \"\u4e2d\u603b\u7ed3\u7684\u6570\u503c\uff0c\u5e76\u4e14\u5728\u8868\u7684\u540e\u9762\u6709\u66f4\u8be6\u7ec6\u7684\u63cf\u8ff0\u3002\u5217\u540d\u663e\u793a\u5728\u8868\u7684\u7b2c\u4e00\u5217\u4e2d\uff1b\u7b2c\u4e8c\u5217\u63d0\u4f9b\u4e86\u4f7f\u7528FORMAT=JSON\u65f6\u8f93\u51fa\u4e2d\u663e\u793a\u7684\u7b49\u6548\u5c5e\u6027\u540d\u79f0\u3002</p> <p>Table 8.1 EXPLAIN Output Columns</p> Column JSON Name Meaning <code>id</code> <code>select_id</code> The <code>SELECT</code> identifier <code>select_type</code> None The <code>SELECT</code> type <code>table</code> <code>table_name</code> The table for the output row <code>partitions</code> <code>partitions</code> The matching partitions <code>type</code> <code>access_type</code> The join type <code>possible_keys</code> <code>possible_keys</code> The possible indexes to choose <code>key</code> <code>key</code> The index actually chosen <code>key_len</code> <code>key_length</code> The length of the chosen key <code>ref</code> <code>ref</code> The columns compared to the index <code>rows</code> <code>rows</code> \u626b\u63cf\u884c\u6570\u7684\u9884\u4f30 <code>filtered</code> <code>filtered</code> Percentage of rows filtered by table condition <code>Extra</code> None Additional information <ul> <li><code>Extra</code> (JSON name: none)</li> </ul> <p>\u8fd9\u4e00\u5217\u5305\u542b\u5173\u4e8eMySQL\u5982\u4f55\u89e3\u51b3\u67e5\u8be2\u7684\u989d\u5916\u4fe1\u606f\u3002\u67e5\u770b <code>EXPLAIN</code> Extra Information.</p> <p>\u6ca1\u6709\u4e0e<code>Extra</code>\u5217\u76f8\u5bf9\u5e94\u7684\u5355\u4e00JSON\u5c5e\u6027\uff1b\u4f46\u662f\uff0c\u5728\u8fd9\u4e00\u5217\u4e2d\u53ef\u80fd\u51fa\u73b0\u7684\u503c\u88ab\u66b4\u9732\u4e3aJSON\u5c5e\u6027\uff0c\u6216\u4f5c\u4e3a<code>message</code>\u5c5e\u6027\u7684\u6587\u672c\u3002</p>"},{"location":"database/SQL%E4%BC%98%E5%8C%96/#_6","title":"\u8868\u8bbe\u8ba1\u6027\u80fd\u539f\u5219","text":"<ul> <li> <p>\u6570\u636e\u7c7b\u578b\uff1a\u6bd4\u5982\u80fd\u7528smallInt\u5c31\u4e0d\u8981\u7528int\u3002\u80fd\u7528\u6574\u6570\u7c7b\u578b\u7684\u5c31\u4e0d\u8981\u7528char\u7c7b\u578b\uff0c\u56e0\u4e3a\u4ed6\u4eec\u5360\u7528\u7684\u5b58\u50a8\u7a7a\u95f4\u662f\u4e0d\u4e00\u6837\u7684</p> </li> <li> <p>\u4f7f\u7528\u975e\u7a7a\u7ea6\u675f\u3002\u4e0d\u4ec5\u907f\u514d\u4e1a\u52a1\u4e0a\u975e\u7a7a\u7684\u5224\u65ad\uff0c\u4e5f\u5bb9\u6613\u521b\u5efa\u7d22\u5f15\u3002\u751a\u81f3\u8282\u7701\u5b58\u50a8\u7a7a\u95f4\u3002</p> </li> <li> <p>\u5408\u7406\u589e\u52a0\u5197\u4f59\u5b57\u6bb5\uff0c\u51cf\u5c11\u5173\u8054\u67e5\u8be2</p> </li> <li> <p>\u9002\u5f53\u62c6\u5206\u8868\u3002\u628a\u8fc7\u957f\u7684\u5b57\u6bb5\u548c\u4e0d\u5e38\u7528\u7684\u5b57\u6bb5\u62c6\u5206\u6210\u5355\u72ec\u7684\u8868</p> </li> </ul>"},{"location":"database/redis/redis/","title":"Redis","text":"<p>\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u4e3a\u4e86\u89e3\u51b3\u5355\u70b9\u95ee\u9898\uff0c\u4f1a\u628a\u6570\u636e\u590d\u5236\u5230\u5176\u4ed6\u673a\u5668\u4e0a\uff0c\u6ee1\u8db3\u6545\u969c\u6062\u590d\u548c\u8d1f\u8f7d\u5747\u8861\u7684\u9700\u6c42\u3002</p> <p>\u590d\u5236\u662fredis\u54e8\u5175\u548c\u96c6\u7fa4\u7b49\u9ad8\u53ef\u7528\u7684\u57fa\u7840\u3002</p> <p>\u914d\u7f6e\u4e3b\u4ece\u8282\u70b9\uff0c\u53ef\u4ee5\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb\uff0c\u591a\u4e2a\u4ece\u8282\u70b9\u5206\u62c5\u8bfb\u7684\u538b\u529b\u3002</p>"},{"location":"database/redis/redis/#_1","title":"\u914d\u7f6e\u548c\u4f7f\u7528","text":"<ol> <li>\u5efa\u7acb\u590d\u5236</li> </ol> <p>\u5206\u4e3a\u4e3b\u8282\u70b9\uff08master\uff09\u548c\u4ece\u8282\u70b9\uff08slave\uff09\uff0c\u4e00\u4e2a\u4e3b\u8282\u70b9\u53ef\u4ee5\u6709\u591a\u4e2a\u4ece\u8282\u70b9\uff0c\u590d\u5236\u662f\u5355\u5411\u7684\uff0c\u5373\u53ea\u80fd\u7531\u4e3b\u8282\u70b9\u590d\u5236\u5230\u4ece\u8282\u70b9\u3002</p> <p>\u5f00\u542f\u590d\u5236\u662f\u5728\u4ece\u8282\u70b9\u4e0a\u8fdb\u884c\u7684\uff0c\u53ef\u4ee5\u8fd0\u884c\u671f\u52a8\u6001\u6307\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u91cc\u6307\u5b9a\uff1a</p> <ul> <li> <ul> <li>\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u5165 slave of masterHost masterPort</li> </ul> </li> <li>\u5728\u542f\u52a8\u65f6\u6307\u5b9a<code>./redis-server --slave of masterHost masterPort</code></li> <li>\u8fd0\u884c\u65f6\u52a8\u6001\u7684\u4f7f\u7528\u547d\u4ee4<code>slave of masterHost masterPort</code></li> </ul> <p><code>info replication</code>\u53ef\u4ee5\u67e5\u770b\u590d\u5236\u8282\u70b9\u7684\u4fe1\u606f</p> <p>\u5982\u679c\u4e3b\u8282\u70b9\u5f00\u542f\u4e86\u5bc6\u7801\uff0c\u9700\u8981\u5728\u4ece\u8282\u70b9\u914d\u7f6emasterauth\u53c2\u6570</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4ece\u8282\u70b9\u662f\u53ea\u8bfb\u7684\uff0c\u5efa\u8bae\u4e0d\u8981\u4fee\u6539\uff0c\u56e0\u4e3a\u590d\u5236\u662f\u5355\u5411\u7684\uff0c\u4ece\u8282\u70b9\u4fee\u6539\u4e86\u503c\u4f1a\u9020\u6210\u4e3b\u4ece\u4e0d\u4e00\u81f4\u3002</p> <p>\u4e3b\u4ece\u8282\u70b9\u4e00\u822c\u90e8\u7f72\u5728\u4e0d\u540c\u673a\u5668\u4e0a\uff0c\u590d\u5236\u65f6\u5c31\u4f1a\u5b58\u5728\u7f51\u7edc\u5ef6\u8fdf\u3002redis\u63d0\u4f9b\u4e86repl-disable-tcp-nodelay\uff0c\u9ed8\u8ba4\u5173\u95ed\uff0c\u8868\u793a\u4e3b\u8282\u70b9\u7684\u547d\u4ee4\u65e0\u8bba\u5927\u5c0f\u4f1a\u7acb\u5373\u53d1\u5f80\u4ece\u8282\u70b9\uff0c\u4f46\u662f\u8fd9\u6837\u589e\u52a0\u4e86\u7f51\u7edc\u5e26\u5bbd\u6d88\u8017\u3002\u5f00\u542f\u540e\uff0c\u4e3b\u8282\u70b9\u4f1a\u5408\u5e76\u8f83\u5c0f\u7684tcp\u5305\u6765\u8282\u7701\u5e26\u5bbd\uff0c\u4f46\u4e5f\u5c31\u9020\u6210\u4e86\u4e3b\u4ece\u4e4b\u95f4\u7684\u5ef6\u8fdf\u3002\u4e00\u822c\u9ed8\u8ba4\u5373\u53ef\uff0c\u56e0\u4e3a\u673a\u5668\u4e00\u822c\u90e8\u7f72\u540c\u4e00\u673a\u623f\u3002</p> <ol> <li>\u65ad\u5f00\u590d\u5236</li> </ol> <p><code>slaveof no one</code>\u53ef\u4ee5\u65ad\u5f00\u590d\u5236</p> <p>\u4e5f\u53ef\u4ee5<code>slaveof new_master_host new_master_port</code>\u590d\u5236\u81ea\u4e00\u4e2a\u65b0\u7684\u4e3b\u8282\u70b9\uff0c\u5373\u5207\u4e3b\uff0c\u6ce8\u610f\u5207\u4e3b\u540e\u4f1a\u6e05\u7a7a\u4e4b\u524d\u7684\u6570\u636e\uff0c\u5343\u4e07\u4e0d\u8981\u8bef\u64cd\u4f5c\u8f93\u9519\u4e3b\u8282\u70b9</p> <p>redis\u4e3b\u4ece\u67b6\u6784\u53ef\u4ee5\u91c7\u7528\u4e00\u4e3b\u4e00\u4ece\uff0c\u4e5f\u53ef\u4ee5\u4e00\u4e3b\u591a\u4ece\uff0c\u4e5f\u53ef\u4ee5\u6811\u72b6\u4e3b\u4ece\uff0c\u964d\u4f4e\u4e3b\u8282\u70b9\u538b\u529b\u3002</p>"},{"location":"database/redis/redission/","title":"Redission","text":"<p>redisson\u5728redis\u57fa\u7840\u4e0a\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u7684\u5206\u5e03\u5f0fJava\u5bf9\u8c61\u548c\u670d\u52a1\uff0c\u5982\u5206\u5e03\u5f0f\u9501\uff0c\u96c6\u5408\uff0c\u540c\u6b65\u5668\uff0c\u5206\u5e03\u5f0f\u4fe1\u53f7\u91cf\u7b49\u7b49\u3002</p> <p>redisson\u5b98\u65b9\u7f51\u7ad9\uff0credisson\u4e2d\u6587\u6587\u6863</p>"},{"location":"database/redis/redission/#_1","title":"\u5206\u5e03\u5f0f\u9501\u7684\u5b9e\u73b0","text":"<p>redisson\u5bf9\u5206\u5e03\u5f0f\u9501\u7684\u5b9e\u73b0\u5341\u5206\u5b8c\u5584\uff0c<code>public interface RLock extends Lock, RLockAsync</code>\u5b9e\u73b0\u4e86<code>java.util.concurrent.locks.Lock</code>\u63a5\u53e3\uff0c\u63d0\u4f9b\u4e86\u53ef\u91cd\u5165\u9501\uff0c\u516c\u5e73\u9501\uff0c\u8bfb\u5199\u9501\u7b49\u8bed\u4e49\uff0c\u8fd8\u63d0\u4f9b\u4e86Semaphore\uff0cCountDownLatch\u7684\u652f\u6301\u3002</p> <p>\u5e76\u4e14\u4e5f\u6709MultiLock,RedLock\uff0c\u9632\u6b62\u5355\u7ed3\u70b9\u6545\u969c\u95ee\u9898\u3002</p> <p>\u5148\u770b\u5206\u5e03\u5f0f\u9501\u63d0\u4f9b\u7684\u529f\u80fd\uff1a</p> <pre><code>RLock lock = redisson.getLock(\"anyLock\");\n\n// \u6700\u5e38\u89c1\u7684\u4f7f\u7528\u65b9\u6cd5\nlock.lock();\n\n// \u52a0\u9501\u4ee5\u540e10\u79d2\u949f\u81ea\u52a8\u89e3\u9501\uff0c\u65e0\u9700\u8c03\u7528unlock\u65b9\u6cd5\u624b\u52a8\u89e3\u9501\nlock.lock(10, TimeUnit.SECONDS);\n\n// \u5f02\u6b65\u83b7\u53d6\u9501\nlock.lockAsync();\nlock.lockAsync(10, TimeUnit.SECONDS);\nFuture&lt;Boolean&gt; res = lock.tryLockAsync(100, 10, TimeUnit.SECONDS);\n\n// \u6784\u5efa\u516c\u5e73\u9501\nRLock fairLock = redisson.getFairLock(\"anyLock\");\n\n// \u6784\u5efa\u8bfb\u5199\u9501\nRReadWriteLock rwlock = redisson.getReadWriteLock(\"anyRWLock\");\nrwlock.readLock().lock();\nrwlock.writeLock().lock();\n</code></pre>"},{"location":"database/redis/redission/#_2","title":"\u5206\u5e03\u5f0f\u9501\u7684\u5b9e\u73b0\u903b\u8f91","text":"<ol> <li>\u5faa\u73af\u83b7\u53d6\u9501</li> </ol> <pre><code>/**\n* \u83b7\u53d6\u5206\u5e03\u5f0f\u9501\u7684\u91cd\u8981\u65b9\u6cd5\n*/\nprivate void lock(long leaseTime, TimeUnit unit, boolean interruptibly) throws InterruptedException {\n    // \u5f53\u524d\u7ebf\u7a0bID\n    long threadId = Thread.currentThread().getId();\n    // \u5148\u53bb\u5f02\u6b65\u5224\u65ad\u9501\u662f\u5426\u88ab\u91ca\u653e\n    Long ttl = tryAcquire(-1, leaseTime, unit, threadId);\n    // lock acquired\n    if (ttl == null) {\n        return;\n    }\n\n    RFuture&lt;RedissonLockEntry&gt; future = subscribe(threadId);\n    if (interruptibly) {\n        commandExecutor.syncSubscriptionInterrupted(future);\n    } else {\n        commandExecutor.syncSubscription(future);\n    }\n\n    try {\n        // \u4e0a\u9762\u9996\u6b21\u5c1d\u8bd5\u6ca1\u6709\u83b7\u53d6\u9501\u540e\uff0c\u8fd9\u91cc\u4e0d\u505c\u5faa\u73af \u5c1d\u8bd5\u83b7\u53d6\u9501\n        while (true) {\n            ttl = tryAcquire(-1, leaseTime, unit, threadId);\n            // lock acquired \u4ee3\u8868\u9501\u88ab\u91ca\u653e\u4e86\n            if (ttl == null) {\n                break;\n            }\n\n            // waiting for message\n            if (ttl &gt;= 0) {\n                try {\n                    // ttl &gt;= 0\u4ee3\u8868\u9501\u88ab\u5176\u4ed6\u8bf7\u6c42\u5360\u6709\uff0c\u7b49\u5f85ttl\u65f6\u95f4\n                    future.getNow().getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);\n                } catch (InterruptedException e) {\n                    // \u5982\u679c\u5141\u8bb8\u4e2d\u65ad\uff0c\u5c31\u629b\u51faInterruptedException\n                    if (interruptibly) {\n                        throw e;\n                    }\n                    future.getNow().getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);\n                }\n            } else {\n                // \u5982\u679cttl\u4e3anull\u6216\u8005 &lt; 0\u8868\u793a\u9501\u5df2\u7ecf\u91ca\u653e\uff0c\u53ef\u4ee5\u53bb\u83b7\u53d6\u4e86\n                if (interruptibly) {\n                    future.getNow().getLatch().acquire();\n                } else {\n                    future.getNow().getLatch().acquireUninterruptibly();\n                }\n            }\n        }\n    } finally {\n        unsubscribe(future, threadId);\n    }\n}\n</code></pre> <ol> <li>\u5f02\u6b65\u83b7\u53d6\u9501\uff0c\u6210\u529f\u540e\u5982\u679c\u6ca1\u6709\u6307\u5b9aleaseTime\u6ce8\u518cwatchdog\u5b9a\u65f6\u4efb\u52a1\u8fdb\u884c\u7eed\u7ea6</li> </ol> <pre><code>private &lt;T&gt; RFuture&lt;Long&gt; tryAcquireAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId) {\n    RFuture&lt;Long&gt; ttlRemainingFuture;\n    if (leaseTime != -1) {\n        ttlRemainingFuture = tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);\n    } else {\n        // leaseTime\u4e0d\u4f20\u9ed8\u8ba4\u662f30\u79d2\n        ttlRemainingFuture = tryLockInnerAsync(waitTime, internalLockLeaseTime,\n                                               TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);\n    }\n    ttlRemainingFuture.onComplete((ttlRemaining, e) -&gt; {\n        if (e != null) {\n            return;\n        }\n\n        // \u5982\u679c\u83b7\u53d6\u9501\u6ca1\u6709\u629b\u51fa\u5f02\u5e38\uff0c\u4e14ttlRemaining\u4e0d\u4e3a\u7a7a\uff0c\n        // lock acquired\n        if (ttlRemaining == null) {\n            // \u5982\u679c\u7528\u6237\u8bbe\u7f6e\u4e86leaseTime\uff0c\u5c31\u4e0d\u5ef6\u671f\u4e86\n            if (leaseTime != -1) {\n                internalLockLeaseTime = unit.toMillis(leaseTime);\n            } else {\n                // \u5c31\u6ce8\u518cwatchdog\u540e\u7eed\u8fdb\u884c\u9501\u5ef6\u671f\n                scheduleExpirationRenewal(threadId);\n            }\n        }\n    });\n    return ttlRemainingFuture;\n}\n\n/**\n* lua\u811a\u672c\u53bb\u83b7\u53d6\u9501\u7684\u60c5\u51b5\n*/\n&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {\n    // \u5982\u679chash\u4e0d\u5b58\u5728\uff0c\u5c31\u7528hincrby\u4e3a\u540d\u4e3a \u7684hash\u7ed3\u6784\u5b58\u5165 id + \":\" + threadId = 1\u8fd9\u6837\u4e00\u4e2a\u952e\u503c\u5bf9\uff0c\u5e76\u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4leaseTime\n    return evalWriteAsync(getRawName(), LongCodec.INSTANCE, command,\n                          \"if (redis.call('exists', KEYS[1]) == 0) then \" +\n                          \"redis.call('hincrby', KEYS[1], ARGV[2], 1); \" +\n                          \"redis.call('pexpire', KEYS[1], ARGV[1]); \" +\n                          \"return nil; \" +\n                          \"end; \" +\n                          // \u5982\u679chash\u4e2d\u5df2\u7ecf\u5b58\u5728id + \":\" + threadId\u7684\u952e\u503c\u5bf9\uff0c\u5c31+1\uff0c\u5b9e\u73b0\u9501\u7684\u53ef\u91cd\u5165\u6027\n                          \"if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then \" +\n                          \"redis.call('hincrby', KEYS[1], ARGV[2], 1); \" +\n                          \"redis.call('pexpire', KEYS[1], ARGV[1]); \" +\n                          \"return nil; \" +\n                          \"end; \" +\n                          \"return redis.call('pttl', KEYS[1]);\", // \u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u8fd4\u56dehash\u7684\u8fc7\u671f\u65f6\u95f4\uff0c\u540e\u9762\u8981\u6839\u636e\u6b64\u5224\u65ad\u9501\u7684\u72b6\u6001\n                          Collections.singletonList(getRawName()), unit.toMillis(leaseTime), getLockName(threadId));\n}\n</code></pre>"},{"location":"java/NIO/","title":"IO\u57fa\u672c\u6982\u5ff5","text":"<p>\u8fdb\u7a0b/\u7ebf\u7a0b\u7684\u5207\u6362\uff1a\u6240\u6709\u7cfb\u7edf\u90fd\u6709\u8c03\u5ea6\u8fdb\u7a0b\u7684\u80fd\u529b\uff0c\u53ef\u4ee5\u6302\u8d77\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u8fdb\u7a0b\uff0c\u5e76\u6062\u590d\u67d0\u4e2a\u6302\u8d77\u7684\u8fdb\u7a0b\u3002</p> <p>\u8fdb\u7a0b/\u7ebf\u7a0b\u7684\u963b\u585e\uff1a\u8fd0\u884c\u4e2d\u7684\u7ebf\u7a0b\uff0c\u6709\u65f6\u9700\u8981\u7b49\u5f85\u5176\u4ed6\u4e8b\u4ef6\u7684\u6267\u884c\u5b8c\u6210\uff0c\u5982\u7b49\u5f85\u9501\uff0c\u8bf7\u6c42IO\u7684\u8bfb\u5199\u3002\u8fdb\u7a0b\u5728\u7b49\u5f85\u65f6\u4f1a\u88ab\u7cfb\u7edf\u81ea\u52a8\u6267\u884c\u963b\u585e\uff0c\u6b64\u65f6\u8fdb\u7a0b\u4e0d\u5360\u7528CPU\u3002</p> <p>\u6587\u4ef6\u63cf\u8ff0\u7b26\uff1a\u5728Linux\u4e2d\u4e07\u7269\u7686\u6587\u4ef6\uff0c\u5f53\u6253\u5f00\u6216\u8005\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u65f6\uff0c\u5185\u6838\u4f1a\u5411\u8fdb\u7a0b\u8fd4\u56de\u4e00\u4e2a\u975e\u8d1f\u6574\u6570\u8868\u793a\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u7528\u4e8e\u8868\u8ff0\u6307\u5411\u6587\u4ef6\u5f15\u7528\u7684\u62bd\u8c61\u6982\u5ff5\u3002\u7f51\u7edc\u5957\u63a5\u5b57Socket\u4e5f\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002</p> <p>\u8fdb\u7a0b\u8fd0\u884c\u4e2d\u4f1a\u63a5\u53d7\u7cfb\u7edf\u6216\u8005\u8fdb\u7a0b\u7684\u4fe1\u53f7\uff0c\u7c7b\u4f3c\u4e8e\u4e2d\u65ad\u3002</p>"},{"location":"java/NIO/#io_1","title":"IO\u8bfb\u5199\u8fc7\u7a0b","text":"<p>\u6240\u6709\u7684\u7f51\u7edcI/O\u90fd\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5\uff1a\u7b49\u5f85\u5c31\u7eea\u548c\u64cd\u4f5c\u3002\u6bd4\u5982\uff0c\u8bfb\u51fd\u6570\uff0c\u5206\u4e3a\u7b49\u5f85\u7cfb\u7edf\u53ef\u8bfbR1\u548c\u771f\u6b63\u7684\u8bfbR2\uff1b\u540c\u7406\uff0c\u5199\u51fd\u6570\u5206\u4e3a\u7b49\u5f85\u7f51\u5361\u53ef\u4ee5\u5199\u548c\u771f\u6b63\u7684\u5199:</p> <ul> <li>\u5f53\u5e94\u7528\u7a0b\u5e8f\u5728\u7528\u6237\u7a7a\u95f4\u53d1\u8d77\u5bf9socket\u5957\u63a5\u5b57\u7684\u8bfb\u8bf7\u6c42\u65f6\uff0c\u4f1a\u5bfc\u81f4\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u7528\u6237\u8fdb\u7a0b\u963b\u585e\uff0c\u7b49\u5f85\u6570\u636e\u6d41\u5230\u8fbe\uff0c\u4ece\u7f51\u5361\u7f13\u51b2\u533a\u590d\u5236\u5230\u5185\u6838\uff08R1\uff09\uff1b\u7136\u540e\u4ece\u5185\u6838\u7f13\u51b2\u533a\u590d\u5236\u5230\u7528\u6237\u7f13\u51b2\u533a\uff0c\u6b64\u65f6\u8fdb\u7a0b\u6062\u590d\uff0c\u5904\u7406\u6570\u636e\uff08R2\uff09\u3002</li> <li>\u5f53\u8fdb\u7a0b\u5728\u7528\u6237\u7a7a\u95f4\u53d1\u8d77\u5bf9socket\u7684send\u64cd\u4f5c\u65f6\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u628a\u6570\u636e\u4ece\u7528\u6237\u7f13\u5b58\u53bb\u590d\u5236\u5230\u5185\u6838\u7f13\u5b58\u533a\uff0c\u6570\u636ecopy\u5b8c\u6210\uff0c\u8fdb\u7a0b\u6062\u590d\u3002\u4f46\u662f\u6211\u4eec\u4e00\u822c\u4e0d\u5173\u5fc3send\u64cd\u4f5c\uff0c\u56e0\u4e3a\u8fdb\u7a0b\u53ea\u9700\u8981\u963b\u585e\u7b49\u5f85\u6570\u636e\u4ece\u7528\u6237\u7f13\u5b58\u53bbcopy\u5230\u5185\u6838\u7f13\u5b58\u533a\uff0c\u8fd9\u4e2a\u662fmemory- copy\uff0c\u5f88\u5feb\uff0c\u540e\u7eed\u7684\u5185\u6838\u5230\u7f51\u7edc\u7f13\u5b58\u533a\u662f\u5c5e\u4e8e\u7cfb\u7edf\u7684\u8303\u56f4\uff0c\u7528\u6237\u8fdb\u7a0b\u65e0\u9700\u5173\u5fc3\u3002</li> </ul> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\u7b49\u5f85\u5c31\u7eea\u7684\u963b\u585e\u662f\u4e0d\u4f7f\u7528CPU\u7684\uff0c\u662f\u5728\u201c\u7a7a\u7b49\u201d\uff1b\u800c\u771f\u6b63\u7684\u8bfb\u5199\u64cd\u4f5c\u662f\u4f7f\u7528CPU\u7684\uff0c\u771f\u6b63\u5728\u201d\u5e72\u6d3b\u201d\uff0c\u800c\u4e14\u8fd9\u4e2a\u8fc7\u7a0b\u975e\u5e38\u5feb\uff0c\u5c5e\u4e8ememory copy\uff0c\u5e26\u5bbd\u901a\u5e38\u57281GB/s\u7ea7\u522b\u4ee5\u4e0a\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u57fa\u672c\u4e0d\u8017\u65f6\u3002</p> <p>IO\u6a21\u578b\u5206\u4e3a\u4e0b\u9762\u51e0\u79cd\uff1a</p> <p></p> <p>\u4ee5socket.read()\u4e3a\u4f8b\u5b50\uff1a</p> <p>\u4f20\u7edf\u7684BIO\u91cc\u9762socket.read()\uff0c\u5982\u679cTCP RecvBuffer\u91cc\u6ca1\u6709\u6570\u636e\uff0c\u51fd\u6570\u4f1a\u4e00\u76f4\u963b\u585e\uff0c\u76f4\u5230\u6536\u5230\u6570\u636e\uff0c\u8fd4\u56de\u8bfb\u5230\u7684\u6570\u636e\u3002</p> <p>\u5bf9\u4e8eNIO\uff0c\u5982\u679cTCP RecvBuffer\u6709\u6570\u636e\uff0c\u5c31\u628a\u6570\u636e\u4ece\u7f51\u5361\u8bfb\u5230\u5185\u5b58\uff0c\u5e76\u4e14\u8fd4\u56de\u7ed9\u7528\u6237\uff1b\u53cd\u4e4b\u5219\u76f4\u63a5\u8fd4\u56de0\uff0c\u6c38\u8fdc\u4e0d\u4f1a\u963b\u585e\u3002\u5728R1\u7b49\u5f85\u5c31\u7eea\u9636\u6bb5\u662f\u975e\u963b\u585e\u7684\uff0cR2\u9636\u6bb5I/O\u64cd\u4f5c\u662f\u540c\u6b65\u963b\u585e\u7684\uff08\u5360\u7528CPU\u4f46memory- copy\u6027\u80fd\u975e\u5e38\u9ad8\uff09</p> <p>\u6700\u65b0\u7684AIO(Async I/O)\u91cc\u9762\u4f1a\u66f4\u8fdb\u4e00\u6b65\uff1a\u4e0d\u4f46\u7b49\u5f85\u5c31\u7eea\u662f\u975e\u963b\u585e\u7684\uff0c\u5c31\u8fde\u6570\u636e\u4ece\u5185\u6838\u7f13\u5b58\u533a\u5230\u7528\u6237\u7f13\u5b58\u533a\u7684\u8fc7\u7a0b\u4e5f\u662f\u5f02\u6b65\u7684\u3002</p> <p>\u6362\u53e5\u8bdd\u8bf4\uff0cBIO\u91cc\u7528\u6237\u6700\u5173\u5fc3\u201c\u6211\u8981\u8bfb\u201d\uff0cNIO\u91cc\u7528\u6237\u6700\u5173\u5fc3\u201d\u6211\u53ef\u4ee5\u8bfb\u4e86\u201d\uff0c\u5728AIO\u6a21\u578b\u91cc\u7528\u6237\u66f4\u9700\u8981\u5173\u6ce8\u7684\u662f\u201c\u8bfb\u5b8c\u4e86\u201d\u3002</p>"},{"location":"java/NIO/#bio","title":"BIO","text":"<p>\u4f20\u7edf\u7684\u670d\u52a1\u5668\u7aef\u540c\u6b65\u963b\u585eBIO\u5904\u7406\u7684\u7ecf\u5178\u7f16\u7a0b\u6a21\u578b\uff1a</p> <pre><code>/**\n* \u4f20\u7edf\u7684BIO\u65b9\u5f0f\uff0c\u670d\u52a1\u7aef\u76d1\u542c\u7aef\u53e3\uff0cclient\u53ef\u4ee5\u5229\u7528telnet host port \u8fdb\u884c\u901a\u4fe1\uff01\n*/\npublic static void main(String[] args) throws IOException {\n    ExecutorService executor = Executors.newFixedThreadPool(10);\n\n    ServerSocket serverSocket = new ServerSocket(9000);\n    // \u4e3b\u7ebf\u7a0b\u6b7b\u5faa\u73af\u7b49\u5f85\u65b0\u8fde\u63a5\u5230\u6765\n    while (!Thread.currentThread().isInterrupted()) {\n        // accept\u662f\u963b\u585e\u7684\n        Socket socket = serverSocket.accept();\n        // \u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u9700\u8981\u4e00\u4e2a\u7ebf\u7a0b\u5904\u7406\uff0c\u963b\u585e\u5f0f\u7684\n        executor.submit(new ConnectIOnHandler(socket));\n    }\n}\n\nstatic class ConnectIOnHandler extends Thread {\n    private Socket socket;\n\n    public ConnectIOnHandler(Socket socket) {\n        this.socket = socket;\n    }\n\n    public void run() {\n        while (!Thread.currentThread().isInterrupted() &amp;&amp; !socket.isClosed()) {\n            byte[] bytes = new byte[1024];\n            // \u6b7b\u5faa\u73af\u5904\u7406\u8bfb\u5199\u4e8b\u4ef6\n            int read = 0;\n            try {\n                // read\u662f\u963b\u585e\u7684\n                read = socket.getInputStream().read(bytes);\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n            if (read != -1) {\n                //\u5904\u7406\u6570\u636e\n                System.out.println(\"\u63a5\u6536\u5230\u6570\u636e\uff1a\" + new String(bytes, 0, read));\n            }\n\n        }\n    }\n}\n</code></pre> <p>\u8fd9\u662f\u7ecf\u5178\u7684\u4e00\u4e2a\u8fde\u63a5\u5bf9\u5e94\u4e00\u4e2a\u7ebf\u7a0b\u7684\u6a21\u578b\u3002</p> <p>\u4e4b\u6240\u4ee5\u4f7f\u7528\u591a\u7ebf\u7a0b\uff0c\u4e3b\u8981\u539f\u56e0\u5728\u4e8esocket.accept()\u3001socket.read()\u3001socket.write()\u4e09\u4e2a\u4e3b\u8981\u51fd\u6570\u90fd\u662f\u540c\u6b65\u963b\u585e\u7684\uff0c\u5f53\u4e00\u4e2a\u8fde\u63a5\u5728\u5904\u7406I/O\u7684\u65f6\u5019\uff0c\u7cfb\u7edf\u662f\u963b\u585e\u7684\uff0c\u5982\u679c\u662f\u5355\u7ebf\u7a0b\u7684\u8bdd\u5fc5\u7136\u5c31\u6302\u6b7b\u5728\u90a3\u91cc\uff1b\u4f46CPU\u662f\u88ab\u91ca\u653e\u51fa\u6765\u7684\uff0c\u5f00\u542f\u591a\u7ebf\u7a0b\uff0c\u5c31\u53ef\u4ee5\u8ba9CPU\u53bb\u5904\u7406\u66f4\u591a\u7684\u4e8b\u60c5\u3002\u5728\u6d3b\u52a8\u8fde\u63a5\u6570\u4e0d\u662f\u7279\u522b\u9ad8\uff08\u5c0f\u4e8e\u5355\u673a1000\uff09\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u79cd\u6a21\u578b\u662f\u6bd4\u8f83\u4e0d\u9519\u7684\uff0c\u53ef\u4ee5\u8ba9\u6bcf\u4e00\u4e2a\u8fde\u63a5\u4e13\u6ce8\u4e8e\u81ea\u5df1\u7684I/O\u5e76\u4e14\u7f16\u7a0b\u6a21\u578b\u7b80\u5355\uff0c\u4e5f\u4e0d\u7528\u8fc7\u591a\u8003\u8651\u7cfb\u7edf\u7684\u8fc7\u8f7d\u3001\u9650\u6d41\u7b49\u95ee\u9898\u3002\u7ebf\u7a0b\u6c60\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u5929\u7136\u7684\u6f0f\u6597\uff0c\u53ef\u4ee5\u7f13\u51b2\u4e00\u4e9b\u7cfb\u7edf\u5904\u7406\u4e0d\u4e86\u7684\u8fde\u63a5\u6216\u8bf7\u6c42\u3002</p> <p>\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u6a21\u578b\u6700\u672c\u8d28\u7684\u95ee\u9898\u5728\u4e8e\uff0c\u4e25\u91cd\u4f9d\u8d56\u4e8e\u7ebf\u7a0b\u3002\u4f46\u7ebf\u7a0b\u662f\u5f88\u201d\u8d35\u201d\u7684\u8d44\u6e90\uff0c\u4e3b\u8981\u8868\u73b0\u5728\uff1a 1. \u7ebf\u7a0b\u7684\u521b\u5efa\u548c\u9500\u6bc1\u6210\u672c\u5f88\u9ad8\uff0c\u5728Linux\u8fd9\u6837\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u7ebf\u7a0b\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2a\u8fdb\u7a0b\u3002\u521b\u5efa\u548c\u9500\u6bc1\u90fd\u662f\u91cd\u91cf\u7ea7\u7684\u7cfb\u7edf\u51fd\u6570\u3002 2. \u7ebf\u7a0b\u672c\u8eab\u5360\u7528\u8f83\u5927\u5185\u5b58\uff0c\u50cfJava\u7684\u7ebf\u7a0b\u6808\uff0c\u4e00\u822c\u81f3\u5c11\u5206\u914d512K\uff5e1M\u7684\u7a7a\u95f4\uff0c\u5982\u679c\u7cfb\u7edf\u4e2d\u7684\u7ebf\u7a0b\u6570\u8fc7\u5343\uff0c\u6050\u6015\u6574\u4e2aJVM\u7684\u5185\u5b58\u90fd\u4f1a\u88ab\u5403\u6389\u4e00\u534a\u3002 3. \u7ebf\u7a0b\u7684\u5207\u6362\u6210\u672c\u662f\u5f88\u9ad8\u7684\u3002\u64cd\u4f5c\u7cfb\u7edf\u53d1\u751f\u7ebf\u7a0b\u5207\u6362\u7684\u65f6\u5019\uff0c\u9700\u8981\u4fdd\u7559\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\uff0c\u7136\u540e\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u3002\u5982\u679c\u7ebf\u7a0b\u6570\u8fc7\u9ad8\uff0c\u53ef\u80fd\u6267\u884c\u7ebf\u7a0b\u5207\u6362\u7684\u65f6\u95f4\u751a\u81f3\u4f1a\u5927\u4e8e\u7ebf\u7a0b\u6267\u884c\u7684\u65f6\u95f4\uff0c\u8fd9\u65f6\u5019\u5e26\u6765\u7684\u8868\u73b0\u5f80\u5f80\u662f\u7cfb\u7edfload\u504f\u9ad8\u3001CPU sy\u4f7f\u7528\u7387\u7279\u522b\u9ad8\uff08\u8d85\u8fc720%\u4ee5\u4e0a)\uff0c\u5bfc\u81f4\u7cfb\u7edf\u51e0\u4e4e\u9677\u5165\u4e0d\u53ef\u7528\u7684\u72b6\u6001\u3002 4. \u5bb9\u6613\u9020\u6210\u952f\u9f7f\u72b6\u7684\u7cfb\u7edf\u8d1f\u8f7d\u3002\u56e0\u4e3a\u7cfb\u7edf\u8d1f\u8f7d\u662f\u7528\u6d3b\u52a8\u7ebf\u7a0b\u6570\u6216CPU\u6838\u5fc3\u6570\uff0c\u4e00\u65e6\u7ebf\u7a0b\u6570\u91cf\u9ad8\u4f46\u5916\u90e8\u7f51\u7edc\u73af\u5883\u4e0d\u662f\u5f88\u7a33\u5b9a\uff0c\u5c31\u5f88\u5bb9\u6613\u9020\u6210\u5927\u91cf\u8bf7\u6c42\u7684\u7ed3\u679c\u540c\u65f6\u8fd4\u56de\uff0c\u6fc0\u6d3b\u5927\u91cf\u963b\u585e\u7ebf\u7a0b\u4ece\u800c\u4f7f\u7cfb\u7edf\u8d1f\u8f7d\u538b\u529b\u8fc7\u5927\u3002</p> <p>\u6240\u4ee5\uff0c\u5f53\u9762\u5bf9\u5341\u4e07\u751a\u81f3\u767e\u4e07\u7ea7\u8fde\u63a5\u7684\u65f6\u5019\uff0c\u4f20\u7edf\u7684BIO\u6a21\u578b\u662f\u65e0\u80fd\u4e3a\u529b\u7684\u3002\u968f\u7740\u79fb\u52a8\u7aef\u5e94\u7528\u7684\u5174\u8d77\u548c\u5404\u79cd\u7f51\u7edc\u6e38\u620f\u7684\u76db\u884c\uff0c\u767e\u4e07\u7ea7\u957f\u8fde\u63a5\u65e5\u8d8b\u666e\u904d\uff0c\u6b64\u65f6\u5fc5\u7136\u9700\u8981\u4e00\u79cd\u66f4\u9ad8\u6548\u7684I/O\u5904\u7406\u6a21\u578b\u3002</p>"},{"location":"java/NIO/#java-nio","title":"Java NIO","text":"<p>NIO\uff08Non-blocking I/O\uff0c\u4e5f\u79f0\u4e3aNew I/O\uff09\uff0c\u662f\u4e00\u79cd\u540c\u6b65\u975e\u963b\u585e\u7684I/O\u6a21\u578b\uff0c\u4e5f\u662fI/O\u591a\u8def\u590d\u7528\u7684\u57fa\u7840\uff0c\u5df2\u7ecf\u88ab\u8d8a\u6765\u8d8a\u591a\u5730\u5e94\u7528\u5230\u5927\u578b\u5e94\u7528\u670d\u52a1\u5668\uff0c\u6210\u4e3a\u89e3\u51b3\u9ad8\u5e76\u53d1\u4e0e\u6d77\u91cf\u8fde\u63a5\u3001I/O\u5904\u7406\u95ee\u9898\u7684\u6709\u6548\u65b9\u5f0f\u3002</p> <p>Java\u652f\u63013\u79cd\u7f51\u7edc\u7f16\u7a0b\u6a21\u578b\uff0cBIO\uff0cNIO\u540c\u6b65\u975e\u963b\u585e\uff0cAIO\u5f02\u6b65\u975e\u963b\u585e\u3002</p>"},{"location":"java/NIO/#java-nioio","title":"Java NIO\u548cIO\u7684\u4e3b\u8981\u533a\u522b","text":"<p>\u5e94\u8be5\u4f55\u65f6\u4f7f\u7528IO\uff0c\u4f55\u65f6\u4f7f\u7528NIO\u5462\uff1f\uff1f</p> <ul> <li>IO\u9762\u5411\u6d41\uff0cNIO\u9762\u5411\u7f13\u51b2</li> </ul> <p>IO\u662f\u9762\u5411\u6d41\u7684\uff0cNIO\u662f\u9762\u5411\u7f13\u51b2\u533a\u7684\u3002 Java IO\u9762\u5411\u6d41\u610f\u5473\u7740\u6bcf\u6b21\u4ece\u6d41\u4e2d\u8bfb\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u8282\uff0c\u76f4\u81f3\u8bfb\u53d6\u6240\u6709\u5b57\u8282\uff0c\u5b83\u4eec\u6ca1\u6709\u88ab\u7f13\u5b58\u5728\u4efb\u4f55\u5730\u65b9\u3002\u6b64\u5916\uff0c\u5b83\u4e0d\u80fd\u524d\u540e\u79fb\u52a8\u6d41\u4e2d\u7684\u6570\u636e\u3002\u5982\u679c\u9700\u8981\u524d\u540e\u79fb\u52a8\u4ece\u6d41\u4e2d\u8bfb\u53d6\u7684\u6570\u636e\uff0c\u9700\u8981\u5148\u5c06\u5b83\u7f13\u5b58\u5230\u4e00\u4e2a\u7f13\u51b2\u533a\u3002 Java NIO\u7684\u7f13\u51b2\u5bfc\u5411\u65b9\u6cd5\u7565\u6709\u4e0d\u540c\u3002\u6570\u636e\u8bfb\u53d6\u5230\u4e00\u4e2a\u5b83\u7a0d\u540e\u5904\u7406\u7684\u7f13\u51b2\u533a\uff0c\u9700\u8981\u65f6\u53ef\u5728\u7f13\u51b2\u533a\u4e2d\u524d\u540e\u79fb\u52a8\u3002\u8fd9\u5c31\u589e\u52a0\u4e86\u5904\u7406\u8fc7\u7a0b\u4e2d\u7684\u7075\u6d3b\u6027\u3002\u4f46\u662f\uff0c\u8fd8\u9700\u8981\u68c0\u67e5\u662f\u5426\u8be5\u7f13\u51b2\u533a\u4e2d\u5305\u542b\u6240\u6709\u60a8\u9700\u8981\u5904\u7406\u7684\u6570\u636e\u3002\u800c\u4e14\uff0c\u9700\u786e\u4fdd\u5f53\u66f4\u591a\u7684\u6570\u636e\u8bfb\u5165\u7f13\u51b2\u533a\u65f6\uff0c\u4e0d\u8981\u8986\u76d6\u7f13\u51b2\u533a\u91cc\u5c1a\u672a\u5904\u7406\u7684\u6570\u636e\u3002</p> <ul> <li>\u963b\u585e\u548c\u975e\u963b\u585e</li> </ul> <p>Java IO\u7684\u5404\u79cd\u6d41\u662f\u963b\u585e\u7684\u3002\u8fd9\u610f\u5473\u7740\uff0c\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u8c03\u7528read() \u6216 write()\u65f6\uff0c\u8be5\u7ebf\u7a0b\u88ab\u963b\u585e\uff0c\u76f4\u5230\u6709\u4e00\u4e9b\u6570\u636e\u88ab\u8bfb\u53d6\uff0c\u6216\u6570\u636e\u5b8c\u5168\u5199\u5165\u3002\u8be5\u7ebf\u7a0b\u5728\u6b64\u671f\u95f4\u4e0d\u80fd\u518d\u5e72\u4efb\u4f55\u4e8b\u60c5\u4e86\u3002 Java NIO\u7684\u975e\u963b\u585e\u6a21\u5f0f\uff0c\u4f7f\u4e00\u4e2a\u7ebf\u7a0b\u4ece\u67d0\u901a\u9053\u53d1\u9001\u8bf7\u6c42\u8bfb\u53d6\u6570\u636e\uff0c\u4f46\u662f\u5b83\u4ec5\u80fd\u5f97\u5230\u76ee\u524d\u53ef\u7528\u7684\u6570\u636e\uff0c\u5982\u679c\u76ee\u524d\u6ca1\u6709\u6570\u636e\u53ef\u7528\u65f6\uff0c\u5c31\u4ec0\u4e48\u90fd\u4e0d\u4f1a\u83b7\u53d6\u3002\u800c\u4e0d\u662f\u4fdd\u6301\u7ebf\u7a0b\u963b\u585e\uff0c\u6240\u4ee5\u76f4\u81f3\u6570\u636e\u53d8\u7684\u53ef\u4ee5\u8bfb\u53d6\u4e4b\u524d\uff0c\u8be5\u7ebf\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u505a\u5176\u4ed6\u7684\u4e8b\u60c5\u3002 \u975e\u963b\u585e\u5199\u4e5f\u662f\u5982\u6b64\u3002\u4e00\u4e2a\u7ebf\u7a0b\u8bf7\u6c42\u5199\u5165\u4e00\u4e9b\u6570\u636e\u5230\u67d0\u901a\u9053\uff0c\u4f46\u4e0d\u9700\u8981\u7b49\u5f85\u5b83\u5b8c\u5168\u5199\u5165\uff0c\u8fd9\u4e2a\u7ebf\u7a0b\u540c\u65f6\u53ef\u4ee5\u53bb\u505a\u522b\u7684\u4e8b\u60c5\u3002 \u7ebf\u7a0b\u901a\u5e38\u5c06\u975e\u963b\u585eIO\u7684\u7a7a\u95f2\u65f6\u95f4\u7528\u4e8e\u5728\u5176\u5b83\u901a\u9053\u4e0a\u6267\u884cIO\u64cd\u4f5c\uff0c\u6240\u4ee5\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u73b0\u5728\u53ef\u4ee5\u7ba1\u7406\u591a\u4e2a\u8f93\u5165\u548c\u8f93\u51fa\u901a\u9053\uff08channel\uff09\u3002</p> <ul> <li>Selector</li> </ul> <p>Java NIO\u7684\u9009\u62e9\u5668\u5141\u8bb8\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u6765\u76d1\u89c6\u591a\u4e2a\u8f93\u5165\u901a\u9053\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u9009\u62e9\u5668\u6ce8\u518c\u591a\u4e2a\u901a\u9053\uff0c\u7136\u540e\u4f7f\u7528\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u6765\u201c\u9009\u62e9\u201d\u901a\u9053\uff1a\u8fd9\u4e9b\u901a\u9053\u91cc\u5df2\u7ecf\u6709\u53ef\u4ee5\u5904\u7406\u7684\u8f93\u5165\uff0c\u6216\u8005\u9009\u62e9\u5df2\u51c6\u5907\u5199\u5165\u7684\u901a\u9053\u3002\u8fd9\u79cd\u9009\u62e9\u673a\u5236\uff0c\u4f7f\u5f97\u4e00\u4e2a\u5355\u72ec\u7684\u7ebf\u7a0b\u5f88\u5bb9\u6613\u6765\u7ba1\u7406\u591a\u4e2a\u901a\u9053\u3002</p> <p>NIO\u53ef\u8ba9\u60a8\u53ea\u4f7f\u7528\u4e00\u4e2a\uff08\u6216\u51e0\u4e2a\uff09\u5355\u7ebf\u7a0b\u7ba1\u7406\u591a\u4e2a\u901a\u9053\uff08\u7f51\u7edc\u8fde\u63a5\u6216\u6587\u4ef6\uff09\uff0c\u4f46\u4ed8\u51fa\u7684\u4ee3\u4ef7\u662f\u89e3\u6790\u6570\u636e\u53ef\u80fd\u4f1a\u6bd4\u4ece\u4e00\u4e2a\u963b\u585e\u6d41\u4e2d\u8bfb\u53d6\u6570\u636e\u66f4\u590d\u6742\uff1a</p> <ul> <li>\u5982\u679c\u9700\u8981\u7ba1\u7406\u540c\u65f6\u6253\u5f00\u7684\u6210\u5343\u4e0a\u4e07\u4e2a\u8fde\u63a5\uff0c\u8fd9\u4e9b\u8fde\u63a5\u6bcf\u6b21\u53ea\u662f\u53d1\u9001\u5c11\u91cf\u7684\u6570\u636e\uff0c\u4f8b\u5982\u804a\u5929\u670d\u52a1\u5668\uff0c\u5b9e\u73b0NIO\u7684\u670d\u52a1\u5668\u53ef\u80fd\u662f\u4e00\u4e2a\u4f18\u52bf\uff1b</li> <li>\u5982\u679c\u4f60\u6709\u5c11\u91cf\u7684\u8fde\u63a5\u4f7f\u7528\u975e\u5e38\u9ad8\u7684\u5e26\u5bbd\uff0c\u4e00\u6b21\u53d1\u9001\u5927\u91cf\u7684\u6570\u636e\uff0c\u4e5f\u8bb8\u5178\u578b\u7684IO\u670d\u52a1\u5668\u5b9e\u73b0\u53ef\u80fd\u975e\u5e38\u5951\u5408\u3002</li> </ul> <p>Java NIO \u7531\u4ee5\u4e0b\u51e0\u4e2a\u6838\u5fc3\u90e8\u5206\u7ec4\u6210\uff1a</p>"},{"location":"java/NIO/#channel","title":"Channel","text":"<p>Java\u4e2dchannel\u7684\u4e3b\u8981\u5b9e\u73b0\u6709\uff1a</p> <ul> <li>FileChannel   \u4ece\u6587\u4ef6\u4e2d\u8bfb\u5199\u6570\u636e</li> <li>DatagramChannel \u901a\u8fc7UDP\u8bfb\u5199\u7f51\u7edc\u6570\u636e</li> <li>SocketChannel \u901a\u8fc7TCP\u8bfb\u5199\u7f51\u7edc\u6570\u636e</li> <li>ServerSocketChannel  \u53ef\u4ee5\u76d1\u542c\u65b0\u8fdb\u6765\u7684TCP\u8fde\u63a5\uff0c\u50cfWeb\u670d\u52a1\u5668\u90a3\u6837\u3002\u5bf9\u6bcf\u4e00\u4e2a\u65b0\u8fdb\u6765\u7684\u8fde\u63a5\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2aSocketChannel\u3002</li> </ul> <p>FileChannel</p> <p>Java NIO\u4e2d\u7684FileChannel\u662f\u4e00\u4e2a\u8fde\u63a5\u5230\u6587\u4ef6\u7684\u901a\u9053\uff0c\u53ef\u4ee5\u901a\u8fc7\u6587\u4ef6\u901a\u9053\u8bfb\u5199\u6587\u4ef6\u3002</p> <p>FileChannel\u65e0\u6cd5\u8bbe\u7f6e\u4e3a\u975e\u963b\u585e\u6a21\u5f0f\uff0c\u5b83\u603b\u662f\u8fd0\u884c\u5728\u963b\u585e\u6a21\u5f0f\u4e0b\u3002</p> <p>\u53e6\u5916\u5982\u679c\u4e24\u4e2a\u901a\u9053\u4e2d\u6709\u4e00\u4e2a\u662fFileChannel\uff0c\u90a3\u4f60\u53ef\u4ee5\u76f4\u63a5\u5c06\u6570\u636e\u4ece\u4e00\u4e2achannel\u4f20\u8f93\u5230\u53e6\u5916\u4e00\u4e2achannel\u3002</p> <p>FileChannel\u7684force()\u65b9\u6cd5\uff1a\u5c06\u901a\u9053\u91cc\u5c1a\u672a\u5199\u5165\u78c1\u76d8\u7684\u6570\u636e\u5f3a\u5236\u5199\u5230\u78c1\u76d8\u4e0a\u3002\u51fa\u4e8e\u6027\u80fd\u65b9\u9762\u7684\u8003\u8651\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5c06\u6570\u636e\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u6240\u4ee5\u65e0\u6cd5\u4fdd\u8bc1\u5199\u5165\u5230FileChannel\u91cc\u7684\u6570\u636e\u4e00\u5b9a\u4f1a\u53ca\u65f6\u5199\u5230\u78c1\u76d8\u4e0a\u3002\u8981\u4fdd\u8bc1\u8fd9\u4e00\u70b9\uff0c\u9700\u8981\u8c03\u7528force()\u65b9\u6cd5\u3002force()\u65b9\u6cd5\u6709\u4e00\u4e2aboolean\u7c7b\u578b\u7684\u53c2\u6570\uff0c\u6307\u660e\u662f\u5426\u540c\u65f6\u5c06\u6587\u4ef6\u5143\u6570\u636e\uff08\u6743\u9650\u4fe1\u606f\u7b49\uff09\u5199\u5230\u78c1\u76d8\u4e0a\uff1a<code>channel.force(</code>true);</p> <p>\u4ee3\u7801\u4e3e\u4f8b\uff1a</p> <pre><code>public void fileChannel() throws IOException {\n    // \u9700\u8981\u901a\u8fc7\u4f7f\u7528InputStream\u3001OutputStream\u6216RandomAccessFile\u6765\u83b7\u53d6FileChannel\n    RandomAccessFile aFile = new RandomAccessFile(\"/Users/Documents/work/code/sail-java/sail-java/src/main/java/com/aop/jdk/IHello.java\", \"rw\");\n    FileChannel inChannel = aFile.getChannel();\n\n    ByteBuffer byteBuffer = ByteBuffer.allocate(48);\n\n    // channel\u7684\u6570\u636e\u5fc5\u987b\u5148\u8bfb\u53d6\u5230\u4e00\u4e2abuffer\n    int read = inChannel.read(byteBuffer);\n    while (read != -1) {\n        // \u7ffb\u8f6c\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u4ece\u5199\u5207\u6362\u4e3a\u8bfb\u6a21\u5f0f\n        byteBuffer.flip();\n        while (byteBuffer.hasRemaining()) {\n            System.out.print((char) byteBuffer.get());\n        }\n        // buffer\u7684\u6570\u636e\u8bfb\u53d6\u5b8c\u540e\uff0c\u8981\u6e05\u7a7a\u3002\u7136\u540e\u518d\u6b21\u4ecechannel\u8bfb\u53d6\u6570\u636e\n        byteBuffer.clear();\n\n        read = inChannel.read(byteBuffer);\n    }\n\n    // \u6d4b\u8bd5\u5199\u5165\u6570\u636e\u5230channel\n    byteBuffer.clear();\n    byteBuffer.put(\"this is write to channel\".getBytes());\n    byteBuffer.flip();\n    while (byteBuffer.hasRemaining()) {\n        inChannel.write(byteBuffer);\n    }\n\n    aFile.close();\n}\n</code></pre>"},{"location":"java/NIO/#buffer","title":"Buffer","text":"<p>\u7f13\u51b2\u533a\u672c\u8d28\u4e0a\u662f\u4e00\u5757\u5185\u5b58\uff0c\u53ef\u4ee5\u5199\u5165\u6570\u636e\u7136\u540e\u8bfb\u53d6\u6570\u636e\u3002\u8fd9\u5757\u5185\u5b58\u88ab\u5305\u88c5\u6210NIO Buffer\u5bf9\u8c61\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e00\u7ec4\u65b9\u6cd5\uff0c\u7528\u6765\u65b9\u4fbf\u7684\u8bbf\u95ee\u8be5\u5757\u5185\u5b58\u3002</p> <p>\u4ee5\u4e0b\u662fJava NIO\u91cc\u5173\u952e\u7684Buffer\u5b9e\u73b0\uff1a</p> <ul> <li>ByteBuffer</li> <li>ShortBuffer</li> <li>IntBuffer</li> <li>LongBuffer</li> <li>FloatBuffer</li> <li>DoubleBuffer</li> <li>CharBuffer</li> </ul> <p>\u8fd9\u4e9bBuffer\u8986\u76d6\u4e86\u4f60\u80fd\u901a\u8fc7IO\u53d1\u9001\u7684\u57fa\u672c\u6570\u636e\u7c7b\u578b\uff1abyte, short, int, long, float, double \u548c char\u3002Java NIO \u8fd8\u6709\u4e2a MappedByteBuffer\uff08\u5e95\u5c42\u662fDirectByteBuffer\uff09\uff0c\u53ef\u4ee5\u8ba9\u6587\u4ef6\u76f4\u63a5\u5728\u5185\u5b58\uff08\u5806\u5916\u5185\u5b58\uff09\u8fdb\u884c\u4fee\u6539\uff0crocketmq\u4e2d\u6709\u4f7f\u7528\u5230\u3002</p> <p>\u4f7f\u7528Buffer\u8bfb\u5199\u6570\u636e\u4e00\u822c\u9075\u5faa\u4ee5\u4e0b\u56db\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u5199\u5165\u6570\u636e\u5230Buffer</li> <li>\u8c03\u7528<code>flip()</code>\u65b9\u6cd5</li> <li>\u4eceBuffer\u4e2d\u8bfb\u53d6\u6570\u636e</li> <li>\u8c03\u7528<code>clear()</code>\u65b9\u6cd5\u6216\u8005<code>compact()</code>\u65b9\u6cd5</li> </ol> <p>\u5f53\u5411buffer\u5199\u5165\u6570\u636e\u65f6\uff0cbuffer\u4f1a\u8bb0\u5f55\u4e0b\u5199\u4e86\u591a\u5c11\u6570\u636e\u3002\u4e00\u65e6\u8981\u8bfb\u53d6\u6570\u636e\uff0c\u9700\u8981\u901a\u8fc7flip()\u65b9\u6cd5\u5c06Buffer\u4ece\u5199\u6a21\u5f0f\u5207\u6362\u5230\u8bfb\u6a21\u5f0f\u3002</p> <p>\u4e00\u65e6\u8bfb\u5b8c\u4e86\u6240\u6709\u7684\u6570\u636e\uff0c\u5c31\u9700\u8981\u6e05\u7a7a\u7f13\u51b2\u533a\uff0c\u8ba9\u5b83\u53ef\u4ee5\u518d\u6b21\u88ab\u5199\u5165\u3002\u6709\u4e24\u79cd\u65b9\u5f0f\u80fd\u6e05\u7a7a\u7f13\u51b2\u533a\uff1a\u8c03\u7528clear()\u6216compact()\u65b9\u6cd5\u3002clear()\u65b9\u6cd5\u4f1a\u6e05\u7a7a\u6574\u4e2a\u7f13\u51b2\u533a\u3002compact()\u65b9\u6cd5\u53ea\u4f1a\u6e05\u9664\u5df2\u7ecf\u8bfb\u8fc7\u7684\u6570\u636e\u3002\u4efb\u4f55\u672a\u8bfb\u7684\u6570\u636e\u90fd\u88ab\u79fb\u5230\u7f13\u51b2\u533a\u7684\u8d77\u59cb\u5904\uff0c\u65b0\u5199\u5165\u7684\u6570\u636e\u5c06\u653e\u5230\u7f13\u51b2\u533a\u672a\u8bfb\u6570\u636e\u7684\u540e\u9762\u3002</p> <p>Buffer \u6709\u4e09\u4e2a\u5c5e\u6027\u8981\u6ce8\u610f\uff1acapacity\uff0cposition\uff0climit\u3002</p> <p></p> <p>\u4f5c\u4e3a\u5185\u5b58\u5757\uff0cbuffer\u7684\u5927\u5c0f\u662f\u56fa\u5b9a\u7684\uff0c\u5c31\u662fcapacity\u3002\u4f60\u53ea\u80fd\u5f80\u91cc\u5199capacity\u4e2abyte\u3001long\uff0cchar\u7b49\u7c7b\u578b\u3002\u4e00\u65e6Buffer\u6ee1\u4e86\uff0c\u9700\u8981\u5c06\u5176\u6e05\u7a7a\u624d\u80fd\u7ee7\u7eed\u5f80\u91cc\u5199\u6570\u636e\u3002</p> <p>position</p> <p>\u5f53\u4f60\u5199\u6570\u636e\u5230Buffer\u4e2d\u65f6\uff0cposition\u8868\u793a\u5f53\u524d\u7684\u4f4d\u7f6e\u3002\u521d\u59cb\u7684position\u503c\u4e3a0.\u5f53\u4e00\u4e2abyte\u3001long\u7b49\u6570\u636e\u5199\u5230Buffer\u540e\uff0c position\u4f1a\u5411\u524d\u79fb\u52a8\u5230\u4e0b\u4e00\u4e2a\u53ef\u63d2\u5165\u6570\u636e\u7684Buffer\u5355\u5143\u3002position\u6700\u5927\u53ef\u4e3acapacity \u2013 1.</p> <p>\u5f53\u8bfb\u53d6\u6570\u636e\u65f6\uff0c\u4e5f\u662f\u4ece\u67d0\u4e2a\u7279\u5b9a\u4f4d\u7f6e\u8bfb\u3002\u5f53\u5c06Buffer\u4ece\u5199\u6a21\u5f0f\u5207\u6362\u5230\u8bfb\u6a21\u5f0f\uff0cposition\u4f1a\u88ab\u91cd\u7f6e\u4e3a0. \u5f53\u4eceBuffer\u7684position\u5904\u8bfb\u53d6\u6570\u636e\u65f6\uff0cposition\u5411\u524d\u79fb\u52a8\u5230\u4e0b\u4e00\u4e2a\u53ef\u8bfb\u7684\u4f4d\u7f6e\u3002</p> <p>limit</p> <p>\u5728\u5199\u6a21\u5f0f\u4e0b\uff0cBuffer\u7684limit\u8868\u793a\u4f60\u6700\u591a\u80fd\u5f80Buffer\u91cc\u5199\u591a\u5c11\u6570\u636e\u3002 \u5199\u6a21\u5f0f\u4e0b\uff0climit\u7b49\u4e8eBuffer\u7684capacity\u3002</p> <p>\u5f53\u5207\u6362Buffer\u5230\u8bfb\u6a21\u5f0f\u65f6\uff0c limit\u8868\u793a\u4f60\u6700\u591a\u80fd\u8bfb\u5230\u591a\u5c11\u6570\u636e\u3002\u56e0\u6b64\uff0c\u5f53\u5207\u6362Buffer\u5230\u8bfb\u6a21\u5f0f\u65f6\uff0climit\u4f1a\u88ab\u8bbe\u7f6e\u6210\u5199\u6a21\u5f0f\u4e0b\u7684position\u503c\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u4f60\u80fd\u8bfb\u5230\u4e4b\u524d\u5199\u5165\u7684\u6240\u6709\u6570\u636e\uff08limit\u88ab\u8bbe\u7f6e\u6210\u5df2\u5199\u6570\u636e\u7684\u6570\u91cf\uff0c\u8fd9\u4e2a\u503c\u5728\u5199\u6a21\u5f0f\u4e0b\u5c31\u662fposition\uff09</p> <p>Java NIO\u5f00\u59cb\u652f\u6301scatter/gather\uff1a</p> <p>\u5206\u6563\uff08scatter\uff09\u4eceChannel\u4e2d\u8bfb\u53d6\u662f\u6307\u5728\u8bfb\u64cd\u4f5c\u65f6\u5c06\u8bfb\u53d6\u7684\u6570\u636e\u5199\u5165\u591a\u4e2abuffer\u4e2d\u3002 \u805a\u96c6\uff08gather\uff09\u5199\u5165Channel\u662f\u6307\u5728\u5199\u64cd\u4f5c\u65f6\u5c06\u591a\u4e2abuffer\u7684\u6570\u636e\u5199\u5165\u540c\u4e00\u4e2aChannel\uff0c\u56e0\u6b64\uff0cChannel \u5c06\u591a\u4e2aBuffer\u4e2d\u7684\u6570\u636e\u201c\u805a\u96c6\uff08gather\uff09\u201d\u540e\u53d1\u9001\u5230Channel\u3002</p> <p>scatter / gather\u7ecf\u5e38\u7528\u4e8e\u9700\u8981\u5c06\u4f20\u8f93\u7684\u6570\u636e\u5206\u5f00\u5904\u7406\u7684\u573a\u5408\uff0c\u4f8b\u5982\u4f20\u8f93\u4e00\u4e2a\u7531\u6d88\u606f\u5934\u548c\u6d88\u606f\u4f53\u7ec4\u6210\u7684\u6d88\u606f\uff0c\u4f60\u53ef\u80fd\u4f1a\u5c06\u6d88\u606f\u4f53\u548c\u6d88\u606f\u5934\u5206\u6563\u5230\u4e0d\u540c\u7684buffer\u4e2d\uff0c\u8fd9\u6837\u4f60\u53ef\u4ee5\u65b9\u4fbf\u7684\u5904\u7406\u6d88\u606f\u5934\u548c\u6d88\u606f\u4f53\u3002</p>"},{"location":"java/NIO/#selector","title":"Selector","text":"<p>Selector\u9009\u62e9\u5668\u80fd\u591f\u68c0\u6d4b\u591a\u4e2aNIO\u901a\u9053\u7684\u8bfb\u5199\u4e8b\u4ef6\u662f\u5426\u5c31\u7eea\u3002\u8fd9\u6837\u4e00\u4e2a\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u7ba1\u7406\u591a\u4e2achannel\uff0c\u4ece\u800c\u7ba1\u7406\u591a\u4e2a\u7f51\u7edc\u8fde\u63a5\uff0c\u907f\u514d\u4e86\u7ebf\u7a0b\u521b\u5efa\uff0c\u5207\u6362\u7684\u6d88\u8017\u3002</p> <p>\u5b83\u7684select\u65b9\u6cd5\u4f1a\u4e00\u76f4\u963b\u585e\uff0c\u76f4\u5230\u67d0\u4e2achannel\u6709\u4e8b\u4ef6\u5c31\u7eea\uff0c\u4e00\u65e6select( )\u65b9\u6cd5\u8fd4\u56de\uff0c\u5c31\u53ef\u4ee5\u5904\u7406\u8fd9\u4ef6\u4e8b\u60c5\u3002</p> <p>\u6ce8\u610f\uff0cselect()\u662f\u963b\u585e\u7684\uff0c\u65e0\u8bba\u662f\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7684\u901a\u77e5\uff08epoll\uff09\u8fd8\u662f\u4e0d\u505c\u7684\u8f6e\u8be2(select\uff0cpoll)\uff0c\u8fd9\u4e2a\u51fd\u6570\u90fd\u662f\u963b\u585e\u7684\u3002\u6240\u4ee5\u4f60\u53ef\u4ee5\u653e\u5fc3\u5927\u80c6\u5730\u5728\u4e00\u4e2awhile(true)\u91cc\u9762\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u800c\u4e0d\u7528\u62c5\u5fc3CPU\u7a7a\u8f6c\u3002</p> <p>selectNow()\u662f\u7acb\u5373\u8fd4\u56de\uff0c\u975e\u963b\u585e\u7684</p> <pre><code>public void selector() throws IOException {\n    // open()\u65b9\u6cd5\u521b\u5efaSelector\n    Selector selector = Selector.open();\n\n    SocketChannel channel = SocketChannel.open().bind(new InetSocketAddress(8081));\n    channel.configureBlocking(false); // \u4e0eselector\u914d\u5408\u4f7f\u7528\u65f6\uff0cchannel\u5fc5\u987b\u662f\u975e\u963b\u585e\u7684\u3002\u800cFileChannel\u4e0d\u80fd\u5207\u6362\u5230\u975e\u963b\u585e\u6a21\u5f0f\uff0c\u800c\u5957\u63a5\u5b57\u901a\u9053\u90fd\u53ef\u4ee5\n\n    // \u5fc5\u987b\u8981\u5c06channel\u6ce8\u518c\u5230Selector\u4e0a\uff0c\u624d\u80fd\u63a5\u4e0b\u6765\u914d\u5408\u4f7f\u7528\n    SelectionKey selectionKey = channel.register(selector, SelectionKey.OP_READ);\n\n    while (true) {\n        // select()\u65b9\u6cd5\u8fd4\u56de\u7684int\u503c\u8868\u793a\u81ea\u4e0a\u6b21\u8c03\u7528select()\u65b9\u6cd5\u540e\u6709\u591a\u5c11\u901a\u9053\u5df2\u7ecf\u5c31\u7eea\n        // \u6b64\u65b9\u6cd5\u662f\u963b\u585e\u7684\n        int readyChannels = selector.select();\n        if (readyChannels == 0) {\n            continue;\n        }\n        Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();\n        Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();\n        while (keyIterator.hasNext()) {\n            SelectionKey key = keyIterator.next();\n            if (key.isAcceptable()) {\n                // a connection was accepted by a ServerSocketChannel.\n            } else if (key.isConnectable()) {\n                // a connection was established with a remote server.\n            } else if (key.isReadable()) {\n                // a channel is ready for reading\n                System.out.println(key.channel().isBlocking());\n            } else if (key.isWritable()) {\n                // a channel is ready for writing\n            }\n            keyIterator.remove();\n        }\n    }\n}\n</code></pre> <p>SelectionKey\u610f\u601d\u662fSelector\u76d1\u542cChannel\u65f6\u5bf9\u4ec0\u4e48\u4e8b\u4ef6\u611f\u5174\u8da3\uff0c\u901a\u9053\u89e6\u53d1\u4e86\u4e00\u4e2a\u4e8b\u4ef6\u8868\u793a\u8be5\u4e8b\u4ef6\u5df2\u7ecf\u5c31\u7eea\u3002\u53ef\u4ee5\u76d1\u542c\u56db\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u4e8b\u4ef6\uff1a</p> <ol> <li>Connect    \u67d0\u4e2achannel\u6210\u529f\u8fde\u63a5\u5230\u53e6\u4e00\u4e2a\u670d\u52a1\u5668\u79f0\u4e3a\u201c\u8fde\u63a5\u5c31\u7eea\u201d</li> <li>Accept   \u4e00\u4e2aserver socket channel\u51c6\u5907\u597d\u63a5\u6536\u65b0\u8fdb\u5165\u7684\u8fde\u63a5\u79f0\u4e3a\u201c\u63a5\u6536\u5c31\u7eea\u201d</li> <li>Read   \u4e00\u4e2a\u6709\u6570\u636e\u53ef\u8bfb\u7684\u901a\u9053\u53ef\u4ee5\u8bf4\u662f\u201c\u8bfb\u5c31\u7eea\u201d</li> <li>Write  \u7b49\u5f85\u5199\u6570\u636e\u7684\u901a\u9053\u53ef\u4ee5\u8bf4\u662f\u201c\u5199\u5c31\u7eea\u201d</li> </ol>"},{"location":"java/NIO/#selector_1","title":"Selector\u7684\u5e95\u5c42\u539f\u7406","text":"<p><code>Selector.open();</code>\u4e3b\u8981\u662f\u4f9d\u8d56\u7cfb\u7edf\u7684EPoll\uff08\u5f53\u7136epoll\u662fLinux\u7cfb\u7edf\u652f\u6301\u7684\uff0cWindows\u63d0\u4f9b\u53e6\u5916\u7684\u51fd\u6570\uff09,</p> <pre><code>public static Selector open() throws IOException {\n    return SelectorProvider.provider().openSelector();\n}\n\n// \u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e0d\u540c\u7684\u51fd\u6570\npublic AbstractSelector openSelector() throws IOException {\n    return new EPollSelectorImpl(this);\n}\n\nEPollSelectorImpl(SelectorProvider sp) throws IOException {\n    super(sp);\n\n    // epoll\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\n    this.epfd = EPoll.create();\n    this.pollArrayAddress = EPoll.allocatePollArray(NUM_EPOLLEVENTS);\n\n    try {\n        // epoll\u5bf9\u8c61\n        this.eventfd = new EventFD();\n        IOUtil.configureBlocking(IOUtil.newFD(eventfd.efd()), false);\n    } catch (IOException ioe) {\n        EPoll.freePollArray(pollArrayAddress);\n        FileDispatcherImpl.closeIntFD(epfd);\n        throw ioe;\n    }\n\n    // register the eventfd object for wakeups \u6ce8\u518c\u7528\u4e8e\u5524\u9192\n    EPoll.ctl(epfd, EPOLL_CTL_ADD, eventfd.efd(), EPOLLIN);\n}\n</code></pre> <p><code>EPoll.create();</code>\u662f\u8c03\u7528Linux\u7cfb\u7edf\u7684\u5185\u6838\u51fd\u6570\uff0c\u521b\u5efa\u4e00\u4e2aepoll\u5b9e\u4f8b\uff0c\u8fd4\u56de\u6307\u5411epoll\u5b9e\u4f8b\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002 \u53e6\u5916\u7cfb\u7edf\u63d0\u4f9b\u7684\u51fd\u6570\u8fd8\u6709epoll_wait(epollfd,...)\u7b49\u5f85\u76f4\u5230\u6ce8\u518c\u7684\u4e8b\u4ef6\u53d1\u751f\uff0cepoll_ctl ()\u7528\u4e8e\u6ce8\u518c\u5220\u9664\u4fee\u6539\u4e8b\u4ef6\uff0c\u6dfb\u52a0\u5230epoll\u7684channel\u96c6\u5408\u91cc\u3002</p> <p>epoll\u5b9e\u4f8b\u7ed3\u6784\u5185\u90e8\u80af\u5b9a\u6709\u5b58\u653e\u6240\u6709channel\u7684\u96c6\u5408\uff0c\u8fd8\u6709\u4e8b\u4ef6\u5c31\u7eea\u7684channel\u96c6\u5408\u3002</p> <p>EPoll\u548cpoll,select\u7684\u533a\u522b\uff1f</p> <p>epoll\u662f Linux\u5185\u6838\u4e3a\u5904\u7406\u5927\u6279\u91cf \u6587\u4ef6\u63cf\u8ff0\u7b26\u800c\u4f5c\u4e86\u6539\u8fdb\u7684poll\uff0c\u662fLinux\u4e0b\u591a\u8def\u590d\u7528IO\u63a5\u53e3select/poll\u7684\u589e\u5f3a\u7248\u672c\uff0c\u5b83\u80fd\u663e\u8457\u63d0\u9ad8\u7a0b\u5e8f\u5728\u5927\u91cf \u5e76\u53d1\u8fde\u63a5\u4e2d\u53ea\u6709\u5c11\u91cf\u6d3b\u8dc3\u7684\u60c5\u51b5\u4e0b\u7684\u7cfb\u7edfCPU\u5229\u7528\u7387\u3002\u83b7\u53d6\u4e8b\u4ef6\u7684\u65f6\u5019\uff0c\u5b83\u65e0\u987b\u904d\u5386\u6574\u4e2a\u88ab\u4fa6\u542c\u7684\u63cf\u8ff0\u7b26\u96c6\uff0c\u53ea\u8981\u904d\u5386\u90a3\u4e9b\u88ab\u5185\u6838IO\u4e8b\u4ef6\u5f02\u6b65\u5524\u9192\u800c\u52a0\u5165Ready\u961f\u5217\u7684\u63cf\u8ff0\u7b26\u96c6\u5408\u5c31\u884c\u4e86\uff0c\u5e95\u5c42\u662f\u54c8\u5e0c\u8868\u7ed3\u6784\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u662fO(1)\u3002</p> <p>\u53e6\u5916epoll()\u7684\u6700\u5927\u8fde\u63a5\u662f\u6ca1\u6709\u4e0a\u9650\u7684\uff0cselect()\u662f\u6709\u4e0a\u9650\u7684\uff0c\u6700\u59271024\u6216\u80052048\u4e2a\u3002</p> <p>Java NIO\u662f\u5c5e\u4e8e\u6c34\u5e73\u89e6\u53d1</p> <ul> <li> <p>\u6c34\u5e73\u89e6\u53d1\uff1a\u5bf9\u4e8e\u8bfb\u64cd\u4f5c \u53ea\u8981\u7f13\u51b2\u5185\u5bb9\u4e0d\u4e3a\u7a7a\uff0cLT\u6a21\u5f0f\u8fd4\u56de\u8bfb\u5c31\u7eea\uff1b\u5bf9\u4e8e\u5199\u64cd\u4f5c \u53ea\u8981\u7f13\u51b2\u533a\u8fd8\u4e0d\u6ee1\uff0cLT\u6a21\u5f0f\u4f1a\u8fd4\u56de\u5199\u5c31\u7eea\u3002</p> </li> <li> <p>\u8fb9\u7f18\u89e6\u53d1:\u5982\u679c\u6587\u4ef6\u63cf\u8ff0\u7b26\u81ea\u4e0a\u6b21\u72b6\u6001\u6539\u53d8\u540e\u6709\u65b0\u7684IO\u6d3b\u52a8\u5230\u6765,\u6b64\u65f6\u4f1a\u89e6\u53d1\u901a\u77e5</p> </li> </ul> <p>\u4e3e\u4f8b\u8bf4\u660e:\u4e00\u4e2a\u7ba1\u9053\u6536\u5230\u4e861kb\u7684\u6570\u636e,epoll\u4f1a\u7acb\u5373\u8fd4\u56de,\u6b64\u65f6\u8bfb\u4e86512\u5b57\u8282\u6570\u636e,\u7136\u540e\u518d\u6b21\u8c03\u7528epoll.\u8fd9\u65f6\u5982\u679c\u662f\u6c34\u5e73\u89e6\u53d1\u7684,epoll\u4f1a\u7acb\u5373\u8fd4\u56de,\u56e0\u4e3a\u6709\u6570\u636e\u51c6\u5907\u597d\u4e86.\u5982\u679c\u662f\u8fb9\u7f18\u89e6\u53d1\u7684\u4e0d\u4f1a\u7acb\u5373\u8fd4\u56de,\u56e0\u4e3a\u6b64\u65f6\u867d\u7136\u6709\u6570\u636e\u53ef\u8bfb\u4f46\u662f\u5df2\u7ecf\u89e6\u53d1\u4e86\u4e00\u6b21\u901a\u77e5,\u5728\u8fd9\u6b21\u901a\u77e5\u5230\u73b0\u5728\u8fd8\u6ca1\u6709\u65b0\u7684\u6570\u636e\u5230\u6765,\u76f4\u5230\u6709\u65b0\u7684\u6570\u636e\u5230\u6765epoll\u624d\u4f1a\u8fd4\u56de,\u6b64\u65f6\u8001\u7684\u6570\u636e\u548c\u65b0\u7684\u6570\u636e\u90fd\u53ef\u4ee5\u8bfb\u53d6\u5230(\u5f53\u7136\u662f\u9700\u8981\u8fd9\u6b21\u4f60\u5c3d\u53ef\u80fd\u7684\u591a\u8bfb\u53d6).</p>"},{"location":"java/NIO/#nio","title":"NIO\u603b\u7ed3","text":"<p>\u4f7f\u7528NIO != \u9ad8\u6027\u80fd\uff0c\u5f53\u8fde\u63a5\u6570&lt;1000\uff0c\u5e76\u53d1\u7a0b\u5ea6\u4e0d\u9ad8\u6216\u8005\u5c40\u57df\u7f51\u73af\u5883\u4e0bNIO\u5e76\u6ca1\u6709\u663e\u8457\u7684\u6027\u80fd\u4f18\u52bf\u3002</p> <p>NIO\u5e76\u6ca1\u6709\u5b8c\u5168\u5c4f\u853d\u5e73\u53f0\u5dee\u5f02\uff0c\u5b83\u4ecd\u7136\u662f\u57fa\u4e8e\u5404\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684I/O\u7cfb\u7edf\u5b9e\u73b0\u7684\uff0c\u5dee\u5f02\u4ecd\u7136\u5b58\u5728\u3002\u4f7f\u7528NIO\u505a\u7f51\u7edc\u7f16\u7a0b\u6784\u5efa\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b\u5e76\u4e0d\u5bb9\u6613\uff0c\u9677\u9631\u91cd\u91cd\u3002\u63a8\u8350\u5927\u5bb6\u4f7f\u7528\u6210\u719f\u7684NIO\u6846\u67b6\uff0c\u5982Netty\uff0cMINA\u7b49\uff0c\u89e3\u51b3\u4e86\u5f88\u591aNIO\u7684\u9677\u9631\uff0c\u5e76\u5c4f\u853d\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5dee\u5f02\uff0c\u6709\u8f83\u597d\u7684\u6027\u80fd\u548c\u7f16\u7a0b\u6a21\u578b\u3002</p> <p>\u6700\u540e\u603b\u7ed3\u4e00\u4e0b\u5230\u5e95NIO\u7ed9\u6211\u4eec\u5e26\u6765\u4e86\u4e9b\u4ec0\u4e48\uff1a</p> <ul> <li>\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b</li> <li>\u5355\u7ebf\u7a0b\u5904\u7406\u591a\u8fde\u63a5\uff0c\u907f\u514d\u591a\u7ebf\u7a0b</li> <li>\u975e\u963b\u585eI/O\uff0cI/O\u8bfb\u5199\u4e0d\u518d\u963b\u585e\uff0c\u800c\u662f\u8fd4\u56de0</li> <li>\u57fa\u4e8eblock\u7684\u4f20\u8f93\uff0c\u901a\u5e38\u6bd4\u57fa\u4e8e\u6d41\u7684\u4f20\u8f93\u66f4\u9ad8\u6548</li> <li>\u66f4\u9ad8\u7ea7\u7684IO\u51fd\u6570\uff0czero-copy</li> <li>IO\u591a\u8def\u590d\u7528\u5927\u5927\u63d0\u9ad8\u4e86Java\u7f51\u7edc\u5e94\u7528\u7684\u53ef\u4f38\u7f29\u6027\u548c\u5b9e\u7528\u6027</li> </ul>"},{"location":"java/NIO/#nio_1","title":"NIO\u4e0e\u96f6\u62f7\u8d1d","text":"<p>\u96f6\u62f7\u8d1dzero-copy\u662f\u7f51\u7edc\u7f16\u7a0b\u7684\u5173\u952e\uff0c\u5f88\u591a\u6027\u80fd\u4f18\u5316\u90fd\u79bb\u4e0d\u5f00\u3002\u5e38\u7528\u7684\u96f6\u62f7\u8d1d\u6709mmap\u5185\u5b58\u6620\u5c04\u548csendfile\u3002\u6ce8\u610f\u96f6\u62f7\u8d1d\u662f\u4ece\u64cd\u4f5c\u7cfb\u7edf\u6765\u8bf4\u7684\uff0c <code>kernel buffer</code> \u53ea\u6709\u4e00\u4efd\u6570\u636e.</p> <p>\u4f20\u7edf\u7684IO\u4f20\u8f93\u6570\u636e\uff0c\u9700\u8981\u4ece\u5185\u6838\u6001\u62f7\u8d1d\u6570\u636e\u5230\u5185\u6838\u6001\uff1a</p> <p></p> <p>mmap\u901a\u8fc7\u5185\u5b58\u6620\u5c04\uff0c\u5c06\u6587\u4ef6\u6620\u5c04\u5230\u5185\u6838\u7f13\u51b2\u533a\uff0c\u540c\u65f6\u7528\u6237\u7a7a\u95f4\u53ef\u4ee5\u5171\u4eab\u5185\u6838\u7a7a\u95f4\u7684\u6570\u636e\uff0c\u51cf\u5c11\u5185\u6838\u7a7a\u95f4\u5230\u7528\u6237\u7a7a\u95f4\u7684\u62f7\u8d1d\u3002</p> <p></p> <p>Linux2.1 \u7248\u672c\u63d0\u4f9b\u4e86 <code>sendFile</code> \u51fd\u6570\uff0c\u5176\u57fa\u672c\u539f\u7406\u5982\u4e0b\uff1a\u6570\u636e\u6839\u672c\u4e0d\u7ecf\u8fc7\u7528\u6237\u6001\uff0c\u76f4\u63a5\u4ece\u5185\u6838\u7f13\u51b2\u533a\u8fdb\u5165\u5230 <code>SocketBuffer</code>\uff0c\u7531\u4e8e\u548c\u7528\u6237\u6001\u5b8c\u5168\u65e0\u5173\uff0c\u5c31\u51cf\u5c11\u4e86\u4e00\u6b21\u4e0a\u4e0b\u6587\u5207\u6362</p> <p></p> <p><code>Linux\u57282.4</code> \u7248\u672c\u4e2d\uff0c\u505a\u4e86\u4e00\u4e9b\u4fee\u6539\uff0c\u907f\u514d\u4e86\u4ece\u5185\u6838\u7f13\u51b2\u533a\u62f7\u8d1d\u5230 <code>Socketbuffer</code> \u7684\u64cd\u4f5c\uff0c\u76f4\u63a5\u62f7\u8d1d\u5230\u534f\u8bae\u6808\uff0c\u4ece\u800c\u518d\u4e00\u6b21\u51cf\u5c11\u4e86\u6570\u636e\u62f7\u8d1d</p> <p></p>"},{"location":"java/NIO/#mmap-sendfile","title":"mmap \u548c sendFile \u7684\u533a\u522b","text":"<ol> <li><code>mmap</code> \u9002\u5408\u5c0f\u6570\u636e\u91cf\u8bfb\u5199\uff0c<code>sendFile</code> \u9002\u5408\u5927\u6587\u4ef6\u4f20\u8f93\u3002</li> <li><code>mmap</code> \u9700\u8981 <code>4</code> \u6b21\u4e0a\u4e0b\u6587\u5207\u6362\uff0c<code>3</code> \u6b21\u6570\u636e\u62f7\u8d1d\uff1b<code>sendFile</code> \u9700\u8981 <code>3</code> \u6b21\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u6700\u5c11 <code>2</code> \u6b21\u6570\u636e\u62f7\u8d1d\u3002</li> <li><code>sendFile</code> \u4ece\u5185\u6838\u7f13\u5b58\u533a\u76f4\u63a5\u62f7\u8d1d\u5230\u534f\u8bae\u6808\uff0c<code>mmap</code> \u5219\u4e0d\u80fd\uff08\u5fc5\u987b\u4ece\u5185\u6838\u62f7\u8d1d\u5230 <code>Socket</code>\u7f13\u51b2\u533a\uff09\u3002</li> </ol> <p>NIO\u4e2d\u662f\u5982\u4f55\u4f7f\u7528\u96f6\u62f7\u8d1d\u6765\u4f18\u5316\u7684\u5462\uff1f</p> <p><code>fileChannel.transferTo(0, fileChannel.size(), socketChannel)</code>\u5e95\u5c42\u4f7f\u7528\u7684\u96f6\u62f7\u8d1d</p>"},{"location":"java/NIO/#aio","title":"AIO","text":"<ol> <li><code>JDK7</code> \u5f15\u5165\u4e86 <code>AsynchronousI/O</code>\uff0c\u5373 <code>AIO</code>\u3002\u5728\u8fdb\u884c <code>I/O</code> \u7f16\u7a0b\u4e2d\uff0c\u5e38\u7528\u5230\u4e24\u79cd\u6a21\u5f0f\uff1a<code>Reactor</code> \u548c <code>Proactor</code>\u3002<code>Java</code> \u7684 <code>NIO</code> \u5c31\u662f <code>Reactor</code>\uff0c\u5f53\u6709\u4e8b\u4ef6\u89e6\u53d1\u65f6\uff0c\u670d\u52a1\u5668\u7aef\u5f97\u5230\u901a\u77e5\uff0c\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406</li> <li><code>AIO</code> \u5373 <code>NIO2.0</code>\uff0c\u53eb\u505a\u5f02\u6b65\u975e\u963b\u585e IO\u3002<code>AIO</code> \u5f15\u5165\u5f02\u6b65\u901a\u9053\u7684\u6982\u5ff5\uff0c\u91c7\u7528\u4e86 <code>Proactor</code> \u6a21\u5f0f\uff0c\u7b80\u5316\u4e86\u7a0b\u5e8f\u7f16\u5199\uff0c\u6709\u6548\u7684\u8bf7\u6c42\u624d\u542f\u52a8\u7ebf\u7a0b\uff0c\u5b83\u7684\u7279\u70b9\u662f\u5148\u7531\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u540e\u624d\u901a\u77e5\u670d\u52a1\u7aef\u7a0b\u5e8f\u542f\u52a8\u7ebf\u7a0b\u53bb\u5904\u7406\uff0c\u4e00\u822c\u9002\u7528\u4e8e\u8fde\u63a5\u6570\u8f83\u591a\u4e14\u8fde\u63a5\u65f6\u95f4\u8f83\u957f\u7684\u5e94\u7528</li> <li>\u76ee\u524d <code>AIO</code> \u8fd8\u6ca1\u6709\u5e7f\u6cdb\u5e94\u7528\uff0cNetty\u4e5f\u662f\u57fa\u4e8e <code>NIO</code>\uff0c\u800c\u4e0d\u662f <code>AIO</code>\uff0c\u56e0\u6b64\u6211\u4eec\u5c31\u4e0d\u8be6\u89e3 <code>AIO</code> \u4e86\uff0c\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u53c2\u8003\u300aJava\u65b0\u4e00\u4ee3\u7f51\u7edc\u7f16\u7a0b\u6a21\u578bAIO\u539f\u7406\u53caLinux\u7cfb\u7edfAIO\u4ecb\u7ecd\u300b</li> </ol> <p>\u4e3e\u4f8b\u8bf4\u660e</p> <ol> <li>\u540c\u6b65\u963b\u585e\uff1a\u5230\u7406\u53d1\u5e97\u7406\u53d1\uff0c\u5c31\u4e00\u76f4\u7b49\u7406\u53d1\u5e08\uff0c\u76f4\u5230\u8f6e\u5230\u81ea\u5df1\u7406\u53d1\u3002</li> <li>\u540c\u6b65\u975e\u963b\u585e\uff1a\u5230\u7406\u53d1\u5e97\u7406\u53d1\uff0c\u53d1\u73b0\u524d\u9762\u6709\u5176\u5b83\u4eba\u7406\u53d1\uff0c\u7ed9\u7406\u53d1\u5e08\u8bf4\u4e0b\uff0c\u5148\u5e72\u5176\u4ed6\u4e8b\u60c5\uff0c\u4e00\u4f1a\u8fc7\u6765\u770b\u662f\u5426\u8f6e\u5230\u81ea\u5df1.</li> <li>\u5f02\u6b65\u975e\u963b\u585e\uff1a\u7ed9\u7406\u53d1\u5e08\u6253\u7535\u8bdd\uff0c\u8ba9\u7406\u53d1\u5e08\u4e0a\u95e8\u670d\u52a1\uff0c\u81ea\u5df1\u5e72\u5176\u5b83\u4e8b\u60c5\uff0c\u7406\u53d1\u5e08\u81ea\u5df1\u6765\u5bb6\u7ed9\u4f60\u7406\u53d1</li> </ol>"},{"location":"java/NIO/#proactorreactor","title":"\u4e8b\u4ef6\u5206\u53d1\u5668\u7c7b\u578b\uff1aProactor\u4e0eReactor","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0cI/O \u590d\u7528\u673a\u5236\u9700\u8981\u4e8b\u4ef6\u5206\u53d1\u5668\uff08event dispatcher\uff09\uff0c\u5373\u5c06\u90a3\u4e9b\u8bfb\u5199\u4e8b\u4ef6\u6e90\u5206\u53d1\u7ed9\u5404\u8bfb\u5199\u4e8b\u4ef6\u7684\u5904\u7406\u8005\uff0c\u6d89\u53ca\u5230\u4e8b\u4ef6\u5206\u53d1\u5668\u7684\u4e24\u79cd\u6a21\u5f0f\u79f0\u4e3a\uff1aReactor\u548cProactor\u3002 Reactor\u6a21\u5f0f\u662f\u57fa\u4e8e\u540c\u6b65I/O\u7684\uff0c\u800cProactor\u6a21\u5f0f\u662f\u548c\u5f02\u6b65I/O\u76f8\u5173\u7684\u3002</p> <p>\u5728Reactor\u6a21\u5f0f\u4e2d\uff0c\u4e8b\u4ef6\u5206\u53d1\u5668\u7b49\u5f85\u67d0\u4e2a\u4e8b\u4ef6\u6216\u8005\u53ef\u5e94\u7528\u6216\u4e2a\u64cd\u4f5c\u7684\u72b6\u6001\u53d1\u751f\uff08\u6bd4\u5982\u6587\u4ef6\u63cf\u8ff0\u7b26\u53ef\u8bfb\u5199\uff0c\u6216\u8005\u662fsocket\u53ef\u8bfb\u5199\uff09\uff0c\u4e8b\u4ef6\u5206\u53d1\u5668\u5c31\u628a\u8fd9\u4e2a\u4e8b\u4ef6\u4f20\u7ed9\u4e8b\u5148\u6ce8\u518c\u7684\u4e8b\u4ef6\u5904\u7406\u51fd\u6570\u6216\u8005\u56de\u8c03\u51fd\u6570\uff0c\u7531\u540e\u8005\u6765\u505a\u5b9e\u9645\u7684\u8bfb\u5199\u64cd\u4f5c\u3002</p> <p>\u800c\u5728Proactor\u6a21\u5f0f\u4e2d\uff0c\u4e8b\u4ef6\u5904\u7406\u8005\uff08\u6216\u8005\u4ee3\u7531\u4e8b\u4ef6\u5206\u53d1\u5668\u53d1\u8d77\uff09\u76f4\u63a5\u53d1\u8d77\u4e00\u4e2a\u5f02\u6b65\u8bfb\u5199\u64cd\u4f5c\uff08\u76f8\u5f53\u4e8e\u8bf7\u6c42\uff09\uff0c\u800c\u5b9e\u9645\u7684\u5de5\u4f5c\u662f\u7531\u64cd\u4f5c\u7cfb\u7edf\u6765\u5b8c\u6210\u7684\u3002\u53d1\u8d77\u65f6\uff0c\u9700\u8981\u63d0\u4f9b\u7684\u53c2\u6570\u5305\u62ec\u7528\u4e8e\u5b58\u653e\u8bfb\u5230\u6570\u636e\u7684\u7f13\u5b58\u533a\u3001\u8bfb\u7684\u6570\u636e\u5927\u5c0f\u6216\u7528\u4e8e\u5b58\u653e\u5916\u53d1\u6570\u636e\u7684\u7f13\u5b58\u533a\uff0c\u4ee5\u53ca\u8fd9\u4e2a\u8bf7\u6c42\u5b8c\u540e\u7684\u56de\u8c03\u51fd\u6570\u7b49\u4fe1\u606f\u3002\u4e8b\u4ef6\u5206\u53d1\u5668\u5f97\u77e5\u4e86\u8fd9\u4e2a\u8bf7\u6c42\uff0c\u5b83\u9ed8\u9ed8\u7b49\u5f85\u8fd9\u4e2a\u8bf7\u6c42\u7684\u5b8c\u6210\uff0c\u7136\u540e\u8f6c\u53d1\u5b8c\u6210\u4e8b\u4ef6\u7ed9\u76f8\u5e94\u7684\u4e8b\u4ef6\u5904\u7406\u8005\u6216\u8005\u56de\u8c03\u3002\u4e3e\u4f8b\u6765\u8bf4\uff0c\u5728Windows\u4e0a\u4e8b\u4ef6\u5904\u7406\u8005\u6295\u9012\u4e86\u4e00\u4e2a\u5f02\u6b65IO\u64cd\u4f5c\uff08\u79f0\u4e3aoverlapped\u6280\u672f\uff09\uff0c\u4e8b\u4ef6\u5206\u53d1\u5668\u7b49IO Complete\u4e8b\u4ef6\u5b8c\u6210\u3002\u8fd9\u79cd\u5f02\u6b65\u6a21\u5f0f\u7684\u5178\u578b\u5b9e\u73b0\u662f\u57fa\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5e95\u5c42\u5f02\u6b65API\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u79f0\u4e4b\u4e3a\u201c\u7cfb\u7edf\u7ea7\u522b\u201d\u7684\u6216\u8005\u201c\u771f\u6b63\u610f\u4e49\u4e0a\u201d\u7684\u5f02\u6b65\uff0c\u56e0\u4e3a\u5177\u4f53\u7684\u8bfb\u5199\u662f\u7531\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u52b3\u7684\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5c06\u6709\u52a9\u4e8e\u7406\u89e3Reactor\u4e0eProactor\u4e8c\u8005\u7684\u5dee\u5f02\uff0c\u4ee5\u8bfb\u64cd\u4f5c\u4e3a\u4f8b\uff08\u5199\u64cd\u4f5c\u7c7b\u4f3c\uff09\u3002</p>"},{"location":"java/NIO/#reactor","title":"\u5728Reactor\u4e2d\u5b9e\u73b0\u8bfb","text":"<ul> <li>\u6ce8\u518c\u8bfb\u5c31\u7eea\u4e8b\u4ef6\u548c\u76f8\u5e94\u7684\u4e8b\u4ef6\u5904\u7406\u5668\u3002</li> <li>\u4e8b\u4ef6\u5206\u53d1\u5668\u7b49\u5f85\u4e8b\u4ef6\u3002</li> <li>\u4e8b\u4ef6\u5230\u6765\uff0c\u6fc0\u6d3b\u5206\u53d1\u5668\uff0c\u5206\u53d1\u5668\u8c03\u7528\u4e8b\u4ef6\u5bf9\u5e94\u7684\u5904\u7406\u5668\u3002</li> <li>\u4e8b\u4ef6\u5904\u7406\u5668\u5b8c\u6210\u5b9e\u9645\u7684\u8bfb\u64cd\u4f5c\uff0c\u5904\u7406\u8bfb\u5230\u7684\u6570\u636e\uff0c\u6ce8\u518c\u65b0\u7684\u4e8b\u4ef6\uff0c\u7136\u540e\u8fd4\u8fd8\u63a7\u5236\u6743\u3002</li> </ul>"},{"location":"java/NIO/#proactor","title":"\u5728Proactor\u4e2d\u5b9e\u73b0\u8bfb\uff1a","text":"<ul> <li>\u5904\u7406\u5668\u53d1\u8d77\u5f02\u6b65\u8bfb\u64cd\u4f5c\uff08\u6ce8\u610f\uff1a\u64cd\u4f5c\u7cfb\u7edf\u5fc5\u987b\u652f\u6301\u5f02\u6b65IO\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5904\u7406\u5668\u65e0\u89c6IO\u5c31\u7eea\u4e8b\u4ef6\uff0c\u5b83\u5173\u6ce8\u7684\u662f\u5b8c\u6210\u4e8b\u4ef6\u3002</li> <li>\u4e8b\u4ef6\u5206\u53d1\u5668\u7b49\u5f85\u64cd\u4f5c\u5b8c\u6210\u4e8b\u4ef6\u3002</li> <li>\u5728\u5206\u53d1\u5668\u7b49\u5f85\u8fc7\u7a0b\u4e2d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5229\u7528\u5e76\u884c\u7684\u5185\u6838\u7ebf\u7a0b\u6267\u884c\u5b9e\u9645\u7684\u8bfb\u64cd\u4f5c\uff0c\u5e76\u5c06\u7ed3\u679c\u6570\u636e\u5b58\u5165\u7528\u6237\u81ea\u5b9a\u4e49\u7f13\u51b2\u533a\uff0c\u6700\u540e\u901a\u77e5\u4e8b\u4ef6\u5206\u53d1\u5668\u8bfb\u64cd\u4f5c\u5b8c\u6210\u3002</li> <li>\u4e8b\u4ef6\u5206\u53d1\u5668\u547c\u5524\u5904\u7406\u5668\u3002</li> <li>\u4e8b\u4ef6\u5904\u7406\u5668\u5904\u7406\u7528\u6237\u81ea\u5b9a\u4e49\u7f13\u51b2\u533a\u4e2d\u7684\u6570\u636e\uff0c\u7136\u540e\u542f\u52a8\u4e00\u4e2a\u65b0\u7684\u5f02\u6b65\u64cd\u4f5c\uff0c\u5e76\u5c06\u63a7\u5236\u6743\u8fd4\u56de\u4e8b\u4ef6\u5206\u53d1\u5668\u3002</li> </ul>"},{"location":"java/NIO/#netty","title":"netty","text":"<p>\u5f00\u53d1\u4e00\u4e2a\u5177\u6709\u8f83\u597d\u7a33\u5b9a\u6027\u548c\u53ef\u9760\u6027\u7684 NIO \u7a0b\u5e8f\u8fd8\u662f\u633a\u6709\u96be\u5ea6\u7684\u3002\u5ba2\u6237\u7aef\u9762\u4e34\u91cd\u8fde\uff0c\u7f51\u7edc\u95ea\u65ad\uff0c\u534a\u5305\u8bfb\u5199\uff0c\u5931\u8d25\u7f13\u5b58\uff0c\u7f51\u7edc\u62e5\u585e\u548c\u5f02\u5e38\u6d41\u7684\u5904\u7406\u7b49\u3002\u53e6\u5916JDK NIO\u7684Bug\uff1a\u5982Epoll Bug\uff0c\u4f1a\u5bfc\u81f4Selector\u7a7a\u8f6e\u8be2\uff0c\u6700\u7ec8\u5bfc\u81f4CPU 100%\uff0c\u76f4\u5230JDK1.7\u4e5f\u6ca1\u6709\u6839\u672c\u89e3\u51b3\u3002</p> <p>\u4e8e\u662f Netty \u51fa\u73b0\uff0c\u628a\u6211\u4eec\u4ece\u6c34\u6df1\u706b\u70ed\u5f53\u4e2d\u89e3\u6551\u51fa\u6765\uff0cNetty\u672c\u8eab\u662f\u4e00\u4e2a\u57fa\u4e8eNIO\u7684\u7f51\u7edc\u6846\u67b6\uff0c \u5c01\u88c5\u4e86Java NIO\u90a3\u4e9b\u590d\u6742\u7684\u5e95\u5c42\u7ec6\u8282\uff0c\u7ed9\u4f60\u63d0\u4f9b\u7b80\u5355\u597d\u7528\u7684\u62bd\u8c61\u6982\u5ff5\u6765\u7f16\u7a0b\u3002\u4f7f\u7528Netty\u7684\u5f00\u6e90\u6846\u67b6\uff0c\u53ef\u4ee5\u5feb\u901f\u5730\u5f00\u53d1\u9ad8\u6027\u80fd\u7684\u9762\u5411\u534f\u8bae\u7684\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u3002 \u6613\u7528\u3001\u5065\u58ee\u3001\u5b89\u5168\u3001\u9ad8\u6548\uff0c\u4f60\u53ef\u4ee5\u5728Netty\u4e0a\u8f7b\u677e\u5b9e\u73b0\u5404\u79cd\u81ea\u5b9a\u4e49\u7684\u534f\u8bae\uff01</p> <p></p> <ol> <li>Netty\u662f\u7531 JBOSS\u63d0\u4f9b\u7684\u4e00\u4e2a Java\u5f00\u6e90\u6846\u67b6\uff0c\u73b0\u4e3a Github\u4e0a\u7684\u72ec\u7acb\u9879\u76ee\u3002</li> <li>Netty\u662f\u5f02\u6b65\u7684\u3001\u57fa\u4e8e\u4e8b\u4ef6\u9a71\u52a8\u7684\u7f51\u7edc\u5e94\u7528\u6846\u67b6\uff0c\u7528\u4ee5\u5feb\u901f\u5f00\u53d1\u9ad8\u6027\u80fd\u3001\u9ad8\u53ef\u9760\u6027\u7684\u7f51\u7edc <code>IO</code> \u7a0b\u5e8f\u3002</li> <li>Netty\u4e3b\u8981\u9488\u5bf9\u5728 <code>TCP</code> \u534f\u8bae\u4e0b\uff0c\u9762\u5411 <code>Client</code> \u7aef\u7684\u9ad8\u5e76\u53d1\u5e94\u7528\uff0c\u6216\u8005 <code>Peer-to-Peer</code> \u573a\u666f\u4e0b\u7684\u5927\u91cf\u6570\u636e\u6301\u7eed\u4f20\u8f93\u7684\u5e94\u7528\u3002</li> <li>Netty\u672c\u8d28\u662f\u4e00\u4e2a <code>NIO</code> \u6846\u67b6\uff0c\u9002\u7528\u4e8e\u670d\u52a1\u5668\u901a\u8baf\u76f8\u5173\u7684\u591a\u79cd\u5e94\u7528\u573a\u666f\u3002</li> <li>\u8981\u900f\u5f7b\u7406\u89e3 <code>Netty</code>\uff0c\u9700\u8981\u5148\u5b66\u4e60 <code>NIO</code>\uff0c\u8fd9\u6837\u6211\u4eec\u624d\u80fd\u9605\u8bfb Netty\u7684\u6e90\u7801\u3002</li> </ol> <p></p> <p>netty\u5b98\u65b9\u6587\u6863\uff0cnetty\u7b2c\u4e09\u65b9\u6587\u6863</p> <p>\u4f7f\u7528\u6307\u5bfc\uff0c\u5bf9\u5e94\u7684\u4e2d\u6587\u7ffb\u8bd1</p> <p>\u5c1a\u7845\u8c37Netty\u89c6\u9891\u6559\u7a0b\uff0c\u5bf9\u5e94\u7684\u7b14\u8bb0</p> <p>Netty5\u51fa\u73b0\u91cd\u5927BUG\u5df2\u7ecf\u88ab\u5b98\u7f51\u5e9f\u5f03\uff0c\u6240\u4ee5\u76ee\u524d\u4f7f\u7528\u8f83\u591a\u7684\u5c31\u662fNetty4.1.x\u3002</p>"},{"location":"java/NIO/#netty_1","title":"netty\u7684\u5e94\u7528\u573a\u666f","text":"<p>\u6ce8\u610f\u51e0\u4e2a\u5173\u952e\u8bcd\uff0c\u9996\u5148\u5b83\u662f\u4e2a\u6846\u67b6\uff0c\u662f\u4e2a\u201c\u534a\u6210\u54c1\u201d\uff0c\u4e0d\u80fd\u5f00\u7bb1\u5373\u7528\uff0c\u4f60\u5fc5\u987b\u5f97\u62ff\u8fc7\u6765\u505a\u70b9\u5b9a\u5236\uff08\u5c31\u50cfSpring\u90a3\u6837\uff09\uff0c\u5229\u7528\u5b83\u5f00\u53d1\u51fa\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u7136\u540e\u624d\u80fd\u8fd0\u884c\u3002 \u53e6\u5916\u4e00\u4e2a\u5173\u952e\u8bcd\u662f\u9ad8\u6027\u80fd\uff0c\u5982\u679c\u4f60\u7684\u5e94\u7528\u6839\u672c\u6ca1\u6709\u9ad8\u5e76\u53d1\u7684\u538b\u529b\uff0c\u90a3\u5c31\u4e0d\u4e00\u5b9a\u8981\u7528Netty\u4e86\u3002</p> <p>\u5927\u91cf\u57fa\u4e8eNetty\u5f00\u53d1\u7684\u4ea7\u54c1</p> <ul> <li>RPC\u6846\u67b6</li> </ul> <p>\u5206\u5e03\u5f0f\u670d\u52a1\u4e4b\u95f4\u7684\u8fdc\u7a0b\u8c03\u7528\uff0c\u963f\u91cc\u5206\u5e03\u5f0f\u670d\u52a1RPC\u6846\u67b6 <code>Dubbo</code> \u4f7f\u7528\u7684 <code>Dubbo</code> \u534f\u8bae\u9ed8\u8ba4\u4f7f\u7528 Netty\u7528\u4e8e\u5b9e\u73b0\u5404\u8fdb\u7a0b\u8282\u70b9\u4e4b\u95f4\u7684\u5185\u90e8\u901a\u4fe1\u3002</p> <ul> <li>\u6e38\u620f\u9886\u57df</li> </ul> <p>\u5176\u5b9e\u6e38\u620f\u9886\u57df\u662f\u4e2a\u66f4\u597d\u7684\u4f8b\u5b50\uff0c\u957f\u8fde\u63a5\uff0c\u81ea\u5b9a\u4e49\u534f\u8bae\uff0c\u9ad8\u5e76\u53d1\uff0cNetty\u5c31\u662f\u7edd\u914d\u3002</p> <p>Netty\u4f5c\u4e3a\u9ad8\u6027\u80fd\u7684\u57fa\u7840\u901a\u4fe1\u7ec4\u4ef6\uff0c\u63d0\u4f9b\u4e86 <code>TCP/UDP</code> \u548c <code>HTTP</code> \u534f\u8bae\u6808\uff0c\u65b9\u4fbf\u5b9a\u5236\u548c\u5f00\u53d1\u79c1\u6709\u534f\u8bae\u6808\uff0c\u8d26\u53f7\u767b\u5f55\u670d\u52a1\u5668\u3002\u5730\u56fe\u670d\u52a1\u5668\u4e4b\u95f4\u53ef\u4ee5\u65b9\u4fbf\u7684\u901a\u8fc7 Netty\u8fdb\u884c\u9ad8\u6027\u80fd\u7684\u901a\u4fe1\u3002</p> <ul> <li>\u5927\u6570\u636e\u9886\u57df</li> </ul> <p>\u7ecf\u5178\u7684 <code>Hadoop</code> \u7684\u9ad8\u6027\u80fd\u901a\u4fe1\u548c\u5e8f\u5217\u5316\u7ec4\u4ef6 <code>Avro</code> \u7684 <code>RPC</code> \u6846\u67b6\uff0c\u9ed8\u8ba4\u91c7\u7528 Netty\u8fdb\u884c\u8de8\u754c\u70b9\u901a\u4fe1\uff0c\u5b83\u7684 <code>NettyService</code> \u57fa\u4e8e Netty\u6846\u67b6\u4e8c\u6b21\u5c01\u88c5\u5b9e\u73b0\u3002</p>"},{"location":"java/NIO/#netty_2","title":"Netty\u7684\u7ebf\u7a0b\u6a21\u578b","text":"<p>\u7ebf\u7a0b\u6a21\u578b\u6709\uff1a\u4f20\u7edf\u7684\u963b\u585eIO\u670d\u52a1\u6a21\u578b\uff0cReactor\u6a21\u578b\uff08\u4e5f\u662f\u9762\u8bd5\u7231\u95ee\u7684\u70b9\uff09\u3002</p> <p>Reactor\u6a21\u578b\u57fa\u4e8eIO\u591a\u8def\u590d\u7528\u548c\u7ebf\u7a0b\u6c60\uff0c\u89e3\u51b3\u4e86\u4f20\u7edf\u963b\u585eIO\u670d\u52a1\u6a21\u578b\u7684\u7f3a\u70b9\u3002Reactor\u6a21\u578b\u4e5f\u53eb\u53cd\u5e94\u5668\u6a21\u5f0f\uff0c\u5206\u53d1\u8005\u6a21\u5f0f\uff0c\u901a\u77e5\u8005\u6a21\u5f0f\u3002</p> <p></p> <p>Reactor\u6a21\u5f0f\u901a\u8fc7IO\u590d\u7528\u76d1\u542c\u591a\u4e2a\u8bf7\u6c42\uff0c\u57fa\u4e8e\u4e8b\u4ef6\u9a71\u52a8\uff0c\u6536\u5230\u4e8b\u4ef6\u540e\uff0c\u5206\u53d1\u7ed9\u67d0\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u8fdb\u884c\u5904\u7406\uff0c\u8fd9\u4e9b\u662f\u7f51\u7edc\u670d\u52a1\u5668\u5904\u7406\u9ad8\u5e76\u53d1\u7684\u5173\u952e\u3002</p> <p>Reactor\u6a21\u578b\u6839\u636e <code>Reactor</code> \u7684\u6570\u91cf\u548c\u5904\u7406\u8d44\u6e90\u7684\u6c60\u7ebf\u7a0b\u6570\u91cf\u4e0d\u540c\u5206\u4e3a\uff1a\u5355Reactor\u5355\u7ebf\u7a0b\uff0c\u5355Reactor\u591a\u7ebf\u7a0b\uff0c\u4e3b\u4eceReactor\u591a\u7ebf\u7a0b\u6a21\u578b\u3002netty\u7684\u7ebf\u7a0b\u6a21\u5f0f\u662f\u57fa\u4e8e\u4e3b\u4eceReactor\u591a\u7ebf\u7a0b\u6a21\u578b\u505a\u4e86\u4e00\u5b9a\u7684\u6539\u8fdb\uff0c\u6709\u591a\u4e2aReactor\u3002</p>"},{"location":"java/NIO/#reactor_1","title":"\u5355Reactor\u5355\u7ebf\u7a0b","text":"<p>\u901a\u8fc7 <code>Select</code> \u76d1\u63a7\u5ba2\u6237\u7aef\u8bf7\u6c42\u4e8b\u4ef6\uff0c\u6536\u5230\u4e8b\u4ef6\u540e\u901a\u8fc7 <code>Dispatch</code> \u8fdb\u884c\u5206\u53d1\uff1a</p> <p>\u5982\u679c\u662fAccept\u4e8b\u4ef6\uff0c\u5219\u7531 <code>Acceptor</code> \u901a\u8fc7 <code>Accept</code> \u5904\u7406\u8fde\u63a5\u8bf7\u6c42\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a <code>Handler</code> \u5bf9\u8c61\u5904\u7406\u8fde\u63a5\u5b8c\u6210\u540e\u7684\u540e\u7eed\u4e1a\u52a1\u5904\u7406\u3002\u5982\u679c\u4e0d\u662fAccept\u4e8b\u4ef6\uff0c\u5219 <code>Reactor</code> \u4f1a\u5206\u53d1\u7ed9\u5bf9\u5e94\u7684 <code>Handler</code> \u6765\u54cd\u5e94</p> <p></p> <p>\u4f18\u70b9\uff1a\u6a21\u578b\u7b80\u5355\uff0c\u6ca1\u6709\u591a\u7ebf\u7a0b\u5207\u6362\uff0c\u901a\u4fe1\u7b49\u95ee\u9898\u3002\u4f46\u662f\u6027\u80fd\u5dee\uff0c\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5904\u7406\u4e1a\u52a1\u5b58\u5728\u6027\u80fd\u74f6\u9888\uff0c\u4e14\u53ef\u9760\u6027\u4e5f\u5dee\uff0c\u7ebf\u7a0b\u53ef\u80fd\u610f\u5916\u7ec8\u6b62\u6216\u8005\u6b7b\u5faa\u73af\u4f1a\u5bfc\u81f4\u6574\u4e2a\u6a21\u5757\u4e0d\u53ef\u7528\u3002</p>"},{"location":"java/NIO/#reactor_2","title":"\u5355Reactor\u591a\u7ebf\u7a0b","text":"<p>\u6536\u5230\u4e8b\u4ef6\u540e\uff0cdispatcher\u5206\u53d1\u7ed9accept\u6216\u8005handler\u3002</p> <p><code>handler</code> \u53ea\u8d1f\u8d23\u54cd\u5e94\u4e8b\u4ef6\uff0c\u4e0d\u505a\u5177\u4f53\u7684\u4e1a\u52a1\u5904\u7406\uff0c\u901a\u8fc7 <code>read</code> \u8bfb\u53d6\u6570\u636e\u540e\uff0c\u4f1a\u5206\u53d1\u7ed9\u540e\u9762\u7684 <code>worker</code> \u7ebf\u7a0b\u6c60\u7684\u67d0\u4e2a\u7ebf\u7a0b\u5904\u7406\u4e1a\u52a1\uff0c<code>worker</code> \u7ebf\u7a0b\u6c60\u4f1a\u5206\u914d\u72ec\u7acb\u7ebf\u7a0b\u5b8c\u6210\u771f\u6b63\u7684\u4e1a\u52a1\uff0c\u5e76\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 <code>handler</code>\u3002</p> <p>handler\u6536\u5230\u54cd\u5e94\u540e\uff0c\u901a\u8fc7 <code>send</code> \u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 <code>client</code></p> <p></p> <ul> <li> <p>\u4f18\u70b9\uff1a\u53ef\u4ee5\u5145\u5206\u7684\u5229\u7528\u591a\u6838 <code>cpu</code> \u7684\u5904\u7406\u80fd\u529b</p> </li> <li> <p>\u7f3a\u70b9\uff1a\u591a\u7ebf\u7a0b\u6570\u636e\u5171\u4eab\u548c\u8bbf\u95ee\u6bd4\u8f83\u590d\u6742\uff0c<code>Reactor</code> \u5904\u7406\u6240\u6709\u7684\u4e8b\u4ef6\u7684\u76d1\u542c\u548c\u54cd\u5e94\uff0c\u5728\u5355\u7ebf\u7a0b\u8fd0\u884c\uff0c\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u5bb9\u6613\u51fa\u73b0\u6027\u80fd\u74f6\u9888\u3002</p> </li> </ul>"},{"location":"java/NIO/#reactor_3","title":"\u4e3b\u4eceReactor\u591a\u7ebf\u7a0b","text":"<p>\u4e3a\u4e86\u907f\u514dReactor\u5355\u7ebf\u7a0b\u4e0b\u8fd0\u884c\u51fa\u73b0\u5355\u70b9\u6545\u969c</p> <ol> <li> <p>\u4e3b\u7ebf\u7a0b <code>MainReactor</code> \u5bf9\u8c61\u901a\u8fc7 <code>select</code> \u76d1\u542c\u8fde\u63a5\u4e8b\u4ef6\uff0c\u901a\u8fc7 <code>Acceptor</code> \u5904\u7406\u8fde\u63a5\u4e8b\u4ef6\uff0c\u5904\u7406\u5b8c\u540e\u5c06\u8fde\u63a5\u5206\u914d\u7ed9 <code>SubReactor</code></p> </li> <li> <p><code>subreactor</code> \u5c06\u8fde\u63a5\u52a0\u5165\u5230\u8fde\u63a5\u961f\u5217\u8fdb\u884c\u76d1\u542c\uff0c\u5e76\u521b\u5efa <code>handler</code> \u8fdb\u884c\u5404\u79cd\u4e8b\u4ef6\u5904\u7406</p> </li> </ol> <p>\u5f53\u6709\u65b0\u4e8b\u4ef6\u53d1\u751f\u65f6\uff0c<code>subreactor</code> \u5c31\u4f1a\u8c03\u7528\u5bf9\u5e94\u7684 <code>handler</code> \u5904\u7406\uff0c<code>handler</code> \u901a\u8fc7 <code>read</code> \u8bfb\u53d6\u6570\u636e\uff0c\u5206\u53d1\u7ed9\u540e\u9762\u7684 <code>worker</code> \u7ebf\u7a0b\u5904\u7406</p> <ol> <li> <p><code>worker</code> \u7ebf\u7a0b\u6c60\u5206\u914d\u72ec\u7acb\u7684 <code>worker</code> \u7ebf\u7a0b\u8fdb\u884c\u4e1a\u52a1\u5904\u7406\uff0c\u5e76\u8fd4\u56de\u7ed3\u679c</p> </li> <li> <p><code>handler</code> \u6536\u5230\u54cd\u5e94\u7684\u7ed3\u679c\u540e\uff0c\u518d\u901a\u8fc7 <code>send</code> \u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 <code>client</code></p> </li> </ol> <p>MainRecator\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u5bf9\u5e94\u591a\u4e2a <code>Reactor</code> \u5b50\u7ebf\u7a0b\u3002</p> <p></p> <p></p> <ul> <li>\u4f18\u70b9\uff1a</li> </ul> <p>\u7236\u7ebf\u7a0b\u4e0e\u5b50\u7ebf\u7a0b\u7684\u6570\u636e\u4ea4\u4e92\u7b80\u5355\uff0c\u804c\u8d23\u660e\u786e\uff0c\u7236\u7ebf\u7a0b\u53ea\u9700\u8981\u63a5\u6536\u65b0\u8fde\u63a5\u7136\u540e\u4f20\u7ed9\u5b50\u7ebf\u7a0b\uff0c\u5b50\u7ebf\u7a0b\u5b8c\u6210\u540e\u7eed\u7684\u4e1a\u52a1\u5904\u7406\u3002</p> <ul> <li>\u7f3a\u70b9\uff1a\u7f16\u7a0b\u590d\u6742\u5ea6\u8f83\u9ad8</li> </ul> <p>\u8fd9\u79cd\u6a21\u578b\u5728\u8bb8\u591a\u9879\u76ee\u4e2d\u5e7f\u6cdb\u4f7f\u7528\uff0c\u5305\u62ec <code>Nginx</code> \u4e3b\u4ece <code>Reactor</code> \u591a\u8fdb\u7a0b\u6a21\u578b\uff0c<code>Memcached</code> \u4e3b\u4ece\u591a\u7ebf\u7a0b\uff0cNetty\u4e3b\u4ece\u591a\u7ebf\u7a0b\u6a21\u578b\u7684\u652f\u6301.</p>"},{"location":"java/NIO/#netty_3","title":"netty\u7684\u7ebf\u7a0b\u6a21\u578b","text":"<p>netty\u57fa\u4e8e\u4e3b\u4eceReactors\u591a\u7ebf\u7a0b\u6a21\u578b\u505a\u4e86\u4e00\u5b9a\u7684\u6539\u8fdb\uff0c</p> <p></p> <p>BossGroup\u7ef4\u62a4\u4e00\u4e2aSelector\uff0c\u53ea\u5173\u6ce8Accept\uff0c\u83b7\u53d6\u5230\u5bf9\u5e94\u7684 SocketChannel\u5c01\u88c5\u6210 NIOSocketChannel\uff0c\u7136\u540e\u6ce8\u518c\u5230 Worker \u7ebf\u7a0b\u7ec4\uff08\u4e8b\u4ef6\u5faa\u73af\uff09\u8fdb\u884c\u7ef4\u62a4</p> <p>\u5f53 Worker\u7ec4\u901a\u8fc7Selector \u76d1\u542c\u5230\u67d0\u901a\u9053\u53d1\u751f\u81ea\u5df1\u611f\u5174\u8da3\u7684\u4e8b\u4ef6\uff08\u8bfb\u5199\uff09\u540e\uff0c\u5c31\u4ea4\u7ed9Handler\u8fdb\u884c\u5904\u7406\uff0c\u6ce8\u610f handler \u5df2\u7ecf\u52a0\u5165\u5230\u901a\u9053\u3002</p> <p></p> <ol> <li> <p>Netty\u62bd\u8c61\u51fa\u4e24\u7ec4\u7ebf\u7a0b\u6c60\uff1a <code>BossGroup</code> \u4e13\u95e8\u8d1f\u8d23\u63a5\u6536\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c<code>WorkerGroup</code> \u4e13\u95e8\u8d1f\u8d23\u7f51\u7edc\u7684\u8bfb\u5199\uff0c\u7c7b\u578b\u90fd\u662f <code>NioEventLoopGroup</code>\u5373\u4e8b\u4ef6\u5faa\u73af\u7ec4\uff0c\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u4e8b\u4ef6\u5faa\u73af <code>NioEventLoop</code>\u3002</p> </li> <li> <p><code>NioEventLoop</code> \u8868\u793a\u4e00\u4e2a\u4e0d\u65ad\u5faa\u73af\u6267\u884c\u5904\u7406\u4efb\u52a1\u7684\u7ebf\u7a0b\uff0c\u6bcf\u4e2a <code>NioEventLoop</code> \u90fd\u6709\u4e00\u4e2a <code>Selector</code>\u7528\u4e8e\u76d1\u542c\u7ed1\u5b9a\u5728\u5176\u4e0a\u7684 <code>socket</code> \u7f51\u7edc\u901a\u8baf\u3002</p> </li> <li> <p>BossNioEventLoop\u5faa\u73af\u6267\u884c\u7684\u6b65\u9aa4\u6709\u4e09\u6b65\uff1a</p> </li> <li> <p>\u8f6e\u8be2\u662f\u5426\u6709 <code>accept</code> \u4e8b\u4ef6 </p> </li> <li>\u5904\u7406 <code>accept</code> \u4e8b\u4ef6\uff1a\u4e0e client \u5efa\u7acb\u8fde\u63a5\uff0c\u751f\u6210 <code>NioScocketChannel</code>\uff0c\u5e76\u5c06\u5176\u6ce8\u518c\u5230\u67d0\u4e2a <code>worker</code> <code>NIOEventLoop</code> \u4e0a\u7684 <code>Selector</code></li> <li> <p>\u5904\u7406\u4efb\u52a1\u961f\u5217\u7684\u4efb\u52a1\uff0c\u5373 <code>runAllTasks</code></p> </li> <li> <p>\u6bcf\u4e2aWorker\u7684NIOEventLoop\u5faa\u73af\u6267\u884c\u7684\u6b65\u9aa4\uff1a</p> </li> <li> <p>\u8f6e\u8be2\u6bcf\u4e2aNioSocketChannel\u662f\u5426\u6709 <code>read</code>\uff0c<code>write</code> \u4e8b\u4ef6</p> </li> <li> <p>\u5904\u7406 <code>I/O</code> \u4e8b\u4ef6\uff0c\u5373 <code>read</code>\uff0c<code>write</code> \u4e8b\u4ef6</p> </li> <li> <p>\u5904\u7406\u4efb\u52a1\u961f\u5217\u7684\u4efb\u52a1\uff0c\u5373 <code>runAllTasks</code></p> </li> </ol>"},{"location":"java/NIO/#netty_4","title":"netty\u4e3b\u8981\u7c7b","text":""},{"location":"java/NIO/#nioeventloopgroupnioeventloop","title":"NioEventLoopGroup\u548cNioEventLoop","text":"<p><code>BossEventLoop</code> \u8d1f\u8d23\u63a5\u6536\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u5e76\u5c06 <code>SocketChannel</code> \u4ea4\u7ed9<code>WorkerEventLoopGroup</code> \u6765\u8fdb\u884c <code>IO</code> \u5904\u7406\uff0c\u901a\u5e38\u4e00\u4e2a\u670d\u52a1\u7aef\u53e3\u5373\u4e00\u4e2a <code>ServerSocketChannel</code> \u5bf9\u5e94\u4e00\u4e2a <code>Selector</code> \u548c\u4e00\u4e2a <code>EventLoop</code> \u7ebf\u7a0b\u3002<code>EventLoopGroup</code> \u63d0\u4f9b <code>next</code> \u63a5\u53e3\uff0c\u53ef\u4ee5\u4ece\u7ec4\u91cc\u9762\u6309\u7167\u4e00\u5b9a\u89c4\u5219\uff08\u9ed8\u8ba4\u662fInteger.increment &amp; workerGroup.length() - 1\uff09\u83b7\u53d6\u5176\u4e2d\u4e00\u4e2a <code>EventLoop</code> \u6765\u5904\u7406\u4efb\u52a1\u3002 </p> <p>EventLoopGroup\u662f\u4e00\u7ec4 <code>EventLoop</code> \u7684\u62bd\u8c61\uff0cNetty\u4e3a\u4e86\u66f4\u597d\u7684\u5229\u7528\u591a\u6838 <code>CPU</code> \u8d44\u6e90\uff0c\u4e00\u822c\u4f1a\u6709\u591a\u4e2a <code>EventLoop</code> \u540c\u65f6\u5de5\u4f5c\uff0c\u6bcf\u4e2a <code>NioEventLoop</code> \u4e2d\u5305\u542b\u6709\u4e00\u4e2a Selector\uff0c\u4e00\u4e2a <code>taskQueue</code>\uff1a</p> <ul> <li> <p><code>Selector</code> \u4e0a\u53ef\u4ee5\u6ce8\u518c\u76d1\u542c\u591a\u4e2a <code>NioChannel</code>\uff0c\u6bcf\u4e2a <code>NioChannel</code> \u53ea\u4f1a\u7ed1\u5b9a\u5728\u552f\u4e00\u7684 <code>NioEventLoop</code> \u4e0a\uff0c\u4e14\u6bcf\u4e2a <code>NioChannel</code> \u90fd\u7ed1\u5b9a\u6709\u4e00\u4e2a\u81ea\u5df1\u7684 <code>ChannelPipeline</code>\uff0c\u7ba1\u9053\u4e2d\u7ef4\u62a4\u4e86\u5f88\u591a\u7684\u5904\u7406\u5668\u3002<code>pipeline</code> \u548c <code>channel</code>\u4e92\u76f8\u5bf9\u5e94\u3002</p> </li> <li> <p>\u6bcf\u4e2aNioEventLoop \u5185\u90e8\u91c7\u7528\u4e32\u884c\u5316\u8bbe\u8ba1\uff0c\u4ece\u6d88\u606f\u7684 \u8bfb\u53d6-&gt;\u89e3\u7801-&gt;\u5904\u7406-&gt;\u7f16\u7801-&gt;\u53d1\u9001\uff0c\u59cb\u7ec8\u7531\u4e00\u4e2a\u7ebf\u7a0b\u5904\u7406\uff0c\u4e5f\u5c31\u662f\u4efb\u52a1\u5148\u63d0\u4ea4\u5230TaskQueue\u3002</p> </li> </ul> <p>\u6709\u4e9b\u8bfb\u5199\u4e8b\u4ef6\u8017\u65f6\u53ef\u80fd\u8f83\u957f\uff0c\u7ebf\u7a0b\u6c60\u4e5f\u4e0d\u591f\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u4ea4\u5230\u4efb\u52a1\u961f\u5217TaskQueue\u540e\u5f02\u6b65\u6267\u884c\uff0c\u4e09\u79cd\u5178\u578b\u4f7f\u7528\u573a\u666f\uff1a</p> <ul> <li>\u7528\u6237\u7a0b\u5e8f\u81ea\u5b9a\u4e49\u7684\u666e\u901a\u4efb\u52a1\uff0c</li> <li>\u7528\u6237\u81ea\u5b9a\u4e49\u5b9a\u65f6\u4efb\u52a1\uff0c\u63d0\u4ea4\u5230scheduleTaskQueue\u4e2d</li> <li>\u975e\u5f53\u524dReactor\u7ebf\u7a0b\u8c03\u7528channel\u7684\u5404\u79cd\u65b9\u6cd5</li> </ul>"},{"location":"java/NIO/#iochannelfuture","title":"\u5f02\u6b65IO\u64cd\u4f5cChannelFuture","text":"<p>netty\u4e2d\u7684IO\u64cd\u4f5c\u5982Write\uff0cbind\uff0cConnect\u90fd\u662f\u5f02\u6b65\u7684\uff0c\u8fd9\u610f\u5473\u7740\u4efb\u4f55IO\u64cd\u4f5c\u90fd\u662f\u7acb\u5373\u8fd4\u56de\u7684\uff0c\u8fd4\u56de\u7684ChannelFuture\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u65b9\u6cd5\u6765\u83b7\u53d6\u64cd\u4f5c\u7ed3\u679c\u6216\u72b6\u6001:</p> <p>(\u6ce8\u610fIO\u64cd\u4f5c\u5931\u8d25\u6216\u53d6\u6d88\u4e5f\u662f\u5b8c\u6210\u72b6\u6001)</p> <pre><code>                                        +---------------------------+\n                                        | Completed successfully    |\n                                        +---------------------------+\n                                   +----&gt;      isDone() = true      |\n   +--------------------------+    |    |   isSuccess() = true      |\n   |        Uncompleted       |    |    +===========================+\n   +--------------------------+    |    | Completed with failure    |\n   |      isDone() = false    |    |    +---------------------------+\n   |   isSuccess() = false    |----+----&gt;      isDone() = true      |\n   | isCancelled() = false    |    |    |       cause() = non-null  |\n   |       cause() = null     |    |    +===========================+\n   +--------------------------+    |    | Completed by cancellation |\n                                   |    +---------------------------+\n                                   +----&gt;      isDone() = true      |\n                                        | isCancelled() = true      |\n                                        +---------------------------+\n</code></pre> <p>\u6700\u4f73\u5b9e\u8df5\u662f\u6dfb\u52a0ChannelFutureListener\u4ee5\u4fbf\u5728 I/O \u64cd\u4f5c\u5b8c\u6210\u65f6\u6536\u5230\u901a\u77e5\uff0c\u8fd9\u4e2a\u662f\u6839\u672c\u4e0d\u963b\u585e\u7684\uff0c\u53ef\u4ee5\u83b7\u53d6\u6700\u4f73\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u3002await()\u65b9\u6cd5\u4f1a\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u963b\u585e\uff0c\u4e14\u53ef\u80fd\u53d1\u751f\u6b7b\u9501\u3002</p> <pre><code>// BAD - NEVER DO THIS\n{@code @Override}\npublic void channelRead({@link ChannelHandlerContext} ctx, Object msg) {\n    {@link ChannelFuture} future = ctx.channel().close();\n    future.awaitUninterruptibly();\n    // Perform post-closure operation\n    // ...\n}\n\n// GOOD\n{@code @Override}\npublic void channelRead({@link ChannelHandlerContext} ctx, Object msg) {\n    {@link ChannelFuture} future = ctx.channel().close();\n    future.addListener(new {@link ChannelFutureListener}() {\n        public void operationComplete({@link ChannelFuture} future) {\n            // Perform post-closure operation\n            // ...\n        }\n    });\n }\n</code></pre>"},{"location":"java/NIO/#channeloption","title":"ChannelOption","text":"<p>Netty\u5728\u521b\u5efa <code>Channel</code> \u5b9e\u4f8b\u540e\uff0c\u4e00\u822c\u90fd\u9700\u8981\u8bbe\u7f6e <code>ChannelOption</code> \u53c2\u6570\uff0c\u5e38\u89c1\u7684\u5982\u4e0b\uff1a</p> <ul> <li>ChannelOption.SO_BACKLOG\uff1a\u5bf9\u5e94TCOP/IP\u534f\u8baelisten\u51fd\u6570\u4e2d\u7684backlog\u53c2\u6570\uff0c\u521d\u59cb\u5316\u670d\u52a1\u5668\u53ef\u8fde\u63a5\u961f\u5217\u7684\u5927\u5c0f\u3002\u670d\u52a1\u5668\u5904\u7406\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u662f\u987a\u5e8f\u5904\u7406\u7684\uff0c\u4e5f\u5c31\u662f\u540c\u4e00\u65f6\u523b\u53ea\u80fd\u5904\u7406\u4e00\u4e2a\u5ba2\u6237\u7aef\u8fde\u63a5\uff0c\u5176\u4ed6\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u9700\u8981\u653e\u5728\u961f\u5217\u4e2d\u5904\u7406\uff0cbacklog\u6307\u5b9a\u961f\u5217\u7684\u5927\u5c0f</li> <li>ChannelOption.SO_KEEPALIVE \u4e00\u76f4\u4fdd\u6301\u8fde\u63a5\u7684\u6d3b\u52a8\u72b6\u6001</li> </ul>"},{"location":"java/NIO/#nettybytebuf","title":"netty\u7684ByteBuf","text":"<p>Netty\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e13\u95e8\u64cd\u4f5c\u7f13\u51b2\u533a\u7684\u5de5\u5177\u7c7bUnpooled\uff0c\u901a\u8fc7\u5206\u914d\u65b0\u7a7a\u95f4\uff0c\u6216\u5305\u88c5\u590d\u5236\u73b0\u6709byte arrays, byte buffers\u548cstring\u6765\u521b\u5efa\u65b0\u7684ByteBuf \u3002</p> <pre><code>import static io.netty.buffer.Unpooled.*;\n\n// \u5206\u914d\u4e00\u4e2a\u65b0\u7684\u56fa\u5b9a\u5bb9\u91cf\u5806\u7f13\u51b2\u533a\nByteBuf heapBuffer = buffer(128);\n// \u5206\u914d\u4e00\u4e2a\u65b0\u7684\u56fa\u5b9a\u5bb9\u91cf\u76f4\u63a5\u7f13\u51b2\u533a\nByteBuf directBuffer = directBuffer(256);\n// \u5305\u88c5\u7f13\u51b2\u533a\u662f\u4e00\u4e2a\u6216\u591a\u4e2a\u73b0\u6709\u5b57\u8282\u6570\u7ec4\u548c\u5b57\u8282\u7f13\u51b2\u533a\u7684\u89c6\u56fe\u3002 \u539f\u59cb\u6570\u7ec4\u6216\u7f13\u51b2\u533a\u5185\u5bb9\u7684\u4efb\u4f55\u66f4\u6539\u90fd\u5c06\u5728\u5305\u88c5\u7684\u7f13\u51b2\u533a\u4e2d\u53ef\u89c1\u3002\u63d0\u4f9b\u4e86\u5404\u79cd\u5305\u88c5\u5668\u65b9\u6cd5\uff0c\u5b83\u4eec\u7684\u540d\u79f0\u90fd\u662fwrappedBuffer() \nByteBuf wrappedBuffer = wrappedBuffer(new byte[128], new byte[256]);\n\n// \u4e0e\u5305\u88c5\u7f13\u51b2\u533a\u4e0d\u540c\uff0c\u539f\u59cb\u6570\u636e\u548c\u590d\u5236\u7684\u7f13\u51b2\u533a\u4e4b\u95f4\u6ca1\u6709\u5171\u4eab\u6570\u636e\u3002 \u63d0\u4f9b\u4e86\u5404\u79cd\u590d\u5236\u65b9\u6cd5\uff0c\u5b83\u4eec\u7684\u540d\u5b57\u90fd\u662fcopiedBuffer() \u3002 \u4f7f\u7528\u6b64\u64cd\u4f5c\u5c06\u591a\u4e2a\u7f13\u51b2\u533a\u5408\u5e76\u4e3a\u4e00\u4e2a\u7f13\u51b2\u533a\u4e5f\u5f88\u65b9\u4fbf\nByteBuf copiedBuffe r = copiedBuffer(ByteBuffer.allocate(128));\n</code></pre> <p>\u5728netty \u7684buffer\u4e2d\uff0c\u4e0d\u9700\u8981\u4f7f\u7528flip \u8fdb\u884c\u53cd\u8f6c \uff0c \u5e95\u5c42\u7ef4\u62a4\u4e86 readerindex \u548c writerIndex\u3002\u901a\u8fc7 readerindex \u548c  writerIndex \u548c  capacity\uff0c \u5c06buffer\u5206\u6210\u4e09\u4e2a\u533a\u57df     </p> <ul> <li>0---readerindex \u5df2\u7ecf\u8bfb\u53d6\u7684\u533a\u57df       </li> <li>readerindex---writerIndex  \u53ef\u8bfb\u7684\u533a\u57df    </li> <li>writerIndex -- capacity  \u53ef\u5199\u7684\u533a\u57df</li> </ul> <pre><code> *  BEFORE clear()\n *\n *      +-------------------+------------------+------------------+\n *      | discardable bytes |  readable bytes  |  writable bytes  |\n *      +-------------------+------------------+------------------+\n *      |                   |                  |                  |\n *      0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=    capacity\n *\n *\n *  AFTER clear()\n *\n *      +---------------------------------------------------------+\n *      |             writable bytes (got more space)             |\n *      +---------------------------------------------------------+\n *      |                                                         |\n *      0 = readerIndex = writerIndex            &lt;=            capacity\n</code></pre>"},{"location":"java/NIO/#channelpipeline","title":"ChannelPipeline","text":"<p>\u6bcf\u4e2aChannel\u90fd\u6709\u5bf9\u5e94\u7684ChannelPipeline\uff0cChannelPipeline\u4e2d\u7ef4\u62a4\u4e86\u591a\u4e2aChannelHandlerContext\uff08\u5173\u8054\u7740\u4e00\u4e2aChannelHandler\uff09\u7ec4\u6210\u7684\u53cc\u5411\u94fe\u8868\uff0c\u8d1f\u8d23\u5904\u7406\u548c\u62e6\u622ainbound\u548coutbound\u7684\u4e8b\u4ef6\u548c\u64cd\u4f5c\u3002</p> <p></p> <p>\u4e00\u4e2a\u5165\u7ad9\u4e8b\u4ef6\u4f1a\u4f9d\u6b21\u4ecehead\u5230tail\u4ea4\u7ed9\u5404\u4e2ahandler\u5904\u7406\uff0c\u76f8\u53cd\u7684\u51fa\u7ad9\u4e8b\u4ef6\u4f1a\u4f9d\u6b21\u4ecetail\u5230head\u4ea4\u7ed9\u5404\u4e2aChannelHandler\u5904\u7406\uff0c\u662f\u4e00\u79cd\u9ad8\u7ea7\u7684\u62e6\u622a\u5668\u6a21\u5f0f\uff0c\u7528\u6237\u53ef\u4ee5\u5b8c\u5168\u63a7\u5236\u4e24\u4e2aChannel\u95f4\u7684\u5404\u4e2aChannelHandler\u5982\u4f55\u4ea4\u4e92\u3002</p>"},{"location":"java/NIO/#channelhandlercontext","title":"ChannelHandlerContext","text":""},{"location":"java/NIO/#channelhandler","title":"ChannelHandler","text":"<p>channelHandler\u5e94\u8be5\u901a\u8fc7ChannelHandlerContext\u4e0e\u5176\u6240\u5c5e\u7684ChannelPipeline\u8fdb\u884c\u4ea4\u4e92\u3002 \u4f7f\u7528ChannelHandlerContext\uff0c ChannelHandler\u53ef\u4ee5\u5411\u4e0a\u6e38\u6216\u4e0b\u6e38\u4f20\u9012\u4e8b\u4ef6\uff0c\u52a8\u6001\u4fee\u6539\u7ba1\u9053\uff0c\u6216\u5b58\u50a8\u7279\u5b9a\u4e8e\u5904\u7406\u7a0b\u5e8f\u7684\u4fe1\u606f\uff08\u4f7f\u7528AttributeKey s\uff09\u3002</p>"},{"location":"java/NIO/#channelhandler_1","title":"\u7f16\u7801\u89e3\u7801ChannelHandler","text":"<p>\u7f16\u5199\u7f51\u7edc\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u6570\u636e\u5728\u7f51\u7edc\u4e2d\u4f20\u8f93\u65f6\u90fd\u662f\u4e8c\u8fdb\u5236\u7684\u5b57\u8282\u7801\u6570\u636e\u3002\u8fd9\u5c31\u9700\u8981Codec\u8fdb\u884c\u8f6c\u6362</p> <p>Netty\u63d0\u4f9b\u4e00\u7cfb\u5217\u5b9e\u7528\u7684\u7f16\u89e3\u7801\u5668\uff0c\u4ed6\u4eec\u90fd\u5b9e\u73b0\u4e86 <code>ChannelInboundHadnler</code> \u6216\u8005 <code>ChannelOutboundHandler</code> \u63a5\u53e3\uff0c\u5728\u8fd9\u4e9b\u7f16\u89e3\u7801\u5668\u7c7b\u4e2d\uff0c<code>channelRead</code> \u65b9\u6cd5\u5df2\u7ecf\u88ab\u91cd\u5199\u4e86\u3002\u4ee5\u5165\u7ad9\u4e3a\u4f8b\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5165\u7ad9 \u7684\u6d88\u606f\uff0c\u8fd9\u4e2a<code>channelRead</code> \u65b9\u6cd5\u4f1a\u88ab\u8c03\u7528\uff0c\u968f\u540e\u7531\u89e3\u7801\u5668\u7684 <code>decode()</code> \u65b9\u6cd5\u8fdb\u884c\u89e3\u7801\uff0c\u5c06\u89e3\u7801\u540e\u7684\u5b57\u8282\u8f6c\u53d1\u7ed9 <code>ChannelPipeline</code> \u4e2d\u7684\u4e0b\u4e00\u4e2a <code>ChannelInboundHandler</code>\u3002</p> <p></p> <ol> <li>ByteToMessageDecoder\uff1a\u7ee7\u627f\u4e86ChannelInboundHandlerAdapter\uff0c\u662f\u4e00\u4e2a\u8f83\u9876\u5c42\u7684\u7f16\u7801\u89e3\u7801\u7c7b\uff0c\u4e0b\u9762\u5f88\u591a\u662f\u7ee7\u627f\u8fd9\u4e2a\u7c7b\u7684\u3002</li> <li><code>LineBasedFrameDecoder</code>\uff1a\u8fd9\u4e2a\u7c7b\u5728 Netty\u5185\u90e8\u4e5f\u6709\u4f7f\u7528\uff0c\u5b83\u4f7f\u7528\u884c\u5c3e\u63a7\u5236\u5b57\u7b26\uff08\\n\u6216\u8005\\r\\n\uff09\u4f5c\u4e3a\u5206\u9694\u7b26\u6765\u89e3\u6790\u6570\u636e\u3002\u800c<code>DelimiterBasedFrameDecoder</code>\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u7279\u6b8a\u5b57\u7b26\u4f5c\u4e3a\u6d88\u606f\u7684\u5206\u9694\u7b26\uff0c\u5bf9\u63a5\u6613\u6d41\u6e29\u6e7f\u5ea6\u8bbe\u5907\u7684\u79c1\u6709\u534f\u8bae\u5c31\u4f7f\u75280X7E\u4f5c\u4e3a\u5206\u9694\u7b26\u3002</li> <li><code>HttpObjectDecoder</code>\uff1a\u4e00\u4e2a <code>HTTP</code> \u534f\u8bae\u6570\u636e\u7684\u89e3\u7801\u5668</li> <li><code>LengthFieldBasedFrameDecoder</code>\uff1a\u901a\u8fc7\u6307\u5b9a\u957f\u5ea6\u6765\u6807\u8bc6\u6574\u5305\u6d88\u606f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u81ea\u52a8\u7684\u5904\u7406\u9ecf\u5305\u548c\u534a\u5305\u6d88\u606f\u3002</li> <li>ReplayingDecoder\uff1a\u7ee7\u627f\u4e86ByteToMessageDecoder\uff0c\u4e0d\u5fc5\u81ea\u5df1\u5224\u65ad\u662f\u5426\u6570\u636e\u591f\u8bfb\u53d6\uff0c\u5185\u90e8\u4f1a\u8fdb\u884c\u5904\u7406\u5224\u65ad\u3002\u5e76\u4e0d\u662f\u6240\u6709\u7684 ByteBuf \u64cd\u4f5c\u90fd\u88ab\u652f\u6301\uff0c\u5982\u679c\u8c03\u7528\u4e86\u4e00\u4e2a\u4e0d\u88ab\u652f\u6301\u7684\u65b9\u6cd5\uff0c\u5c06\u4f1a\u629b\u51fa\u4e00\u4e2a UnsupportedOperationException\u3002</li> </ol> <p>\u6ce8\u610f\uff1a</p> <p>\u4e0d\u8bba\u89e3\u7801\u5668 <code>handler</code> \u8fd8\u662f\u7f16\u7801\u5668 <code>handler</code> \uff0c\u63a5\u6536\u7684\u6d88\u606f\u7c7b\u578b\u5fc5\u987b\u4e0e\u5f85\u5904\u7406\u7684\u6d88\u606f\u7c7b\u578b\u4e00\u81f4\uff0c\u5426\u5219\u8be5 <code>handler</code> \u4e0d\u4f1a\u88ab\u6267\u884c</p> <p>\u5728\u89e3\u7801\u5668\u8fdb\u884c\u6570\u636e\u89e3\u7801\u65f6\uff0c\u9700\u8981\u5224\u65ad\u7f13\u5b58\u533a\uff08<code>ByteBuf</code>\uff09\u7684\u6570\u636e\u662f\u5426\u8db3\u591f\uff0c\u5426\u5219\u63a5\u6536\u5230\u7684\u7ed3\u679c\u4f1a\u671f\u671b\u7ed3\u679c\u53ef\u80fd\u4e0d\u4e00\u81f4</p>"},{"location":"java/NIO/#protobuf","title":"\u9ad8\u6548\u7684\u6570\u636e\u4f20\u8f93\u683c\u5f0fProtobuf","text":"<p>Netty \u63d0\u4f9b\u7684\u7f16\u7801\u5668\uff1a</p> <ul> <li>StringEncoder\u8d1f\u8d23\u5b57\u7b26\u4e32\u6570\u636e\u89e3\u7801\u3002</li> <li>ObjectDecoder\u548cObjectEncoder\u8d1f\u8d23\u5bf9\u8c61\u7684\u7f16\u89e3\u7801\uff0c\u4f46\u662f\u5e95\u5c42\u4f7f\u7528\u7684Java\u5e8f\u5217\u5316\u6280\u672f\uff0c\u65e0\u6cd5\u8de8\u8bed\u8a00\uff0c\u6027\u80fd\u592a\u4f4e\uff0c\u5e8f\u5217\u540e\u4f53\u79ef\u592a\u5927\u3002</li> </ul> <p>\u6240\u4ee5\u63d0\u4f9b\u4e86Protobuf\uff0c\u5b83\u662fGoogle\u53d1\u5e03\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5168\u79f0 <code>Google Protocol Buffers</code>\uff0c\u662f\u4e00\u79cd\u8f7b\u4fbf\u9ad8\u6548\u7684\u7ed3\u6784\u5316\u6570\u636e\u5b58\u50a8\u683c\u5f0f\uff0c\u53ef\u4ee5\u7528\u4e8e\u7ed3\u6784\u5316\u6570\u636e\u4e32\u884c\u5316\uff0c\u6216\u8005\u8bf4\u5e8f\u5217\u5316\u3002\u5b83\u5f88\u9002\u5408\u505a\u6570\u636e\u5b58\u50a8\u6216 RPC\u8c03\u7528\u7684\u6570\u636e\u4ea4\u6362\u683c\u5f0f\u3002\u76ee\u524d\u5f88\u591a\u516c\u53f8\u7531 http + json\u8f6c\u4e3a tcp + protobuf\u7684\u65b9\u5f0f\u6765\u63d0\u9ad8\u6548\u7387\u3002</p> <ol> <li> <p><code>Protobuf</code> \u662f\u4ee5 <code>message</code> \u7684\u65b9\u5f0f\u6765\u7ba1\u7406\u6570\u636e\u7684.</p> </li> <li> <p>\u652f\u6301\u8de8\u5e73\u53f0\u3001\u8de8\u8bed\u8a00\uff0c\u5373[\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u7aef\u53ef\u4ee5\u662f\u4e0d\u540c\u7684\u8bed\u8a00\u7f16\u5199\u7684]\uff08\u652f\u6301\u76ee\u524d\u7edd\u5927\u591a\u6570\u8bed\u8a00\uff0c\u4f8b\u5982 <code>C++</code>\u3001<code>C#</code>\u3001<code>Java</code>\u3001<code>python</code> \u7b49\uff09</p> </li> <li> <p>\u9ad8\u6027\u80fd\uff0c\u9ad8\u53ef\u9760\u6027</p> </li> </ol> <p>\u4f7f\u7528 <code>protobuf</code> \u7f16\u8bd1\u5668\u80fd\u81ea\u52a8\u751f\u6210\u4ee3\u7801\uff0c<code>Protobuf</code> \u662f\u5c06\u7c7b\u7684\u5b9a\u4e49\u4f7f\u7528 <code>.proto</code> \u6587\u4ef6\u8fdb\u884c\u63cf\u8ff0\u3002\u8bf4\u660e\uff0c\u5728 <code>idea</code> \u4e2d\u7f16\u5199 <code>.proto</code> \u6587\u4ef6\u65f6\uff0c\u4f1a\u81ea\u52a8\u63d0\u793a\u662f\u5426\u4e0b\u8f7d <code>.ptoto</code> \u7f16\u5199\u63d2\u4ef6.\u53ef\u4ee5\u8ba9\u8bed\u6cd5\u9ad8\u4eae\u3002\u7136\u540e\u901a\u8fc7 <code>protoc.exe</code> \u7f16\u8bd1\u5668\u6839\u636e <code>.proto</code> \u81ea\u52a8\u751f\u6210 <code>.java</code> \u6587\u4ef6</p>"},{"location":"java/NIO/#tcp","title":"TCP\u534f\u8bae\u7684\u7c98\u5305\u548c\u62c6\u5305","text":"<p>TCP\u534f\u8bae\u662f\u57fa\u4e8e\u6d41\u7684\uff0c\u9762\u5411\u8fde\u63a5\u7684\u53ef\u9760\u7b97\u6cd5\u3002</p> <p>TCP\u662f\u6709\u7c98\u5305\u548c\u62c6\u5305\uff0c\u4f46\u4e0d\u80fd\u8bf4\u662f\u95ee\u9898\uff01</p> <p>\u5148\u8bf4\u4ec0\u4e48\u662f\u7c98\u5305\u548c\u62c6\u5305\uff1f</p> <p>\u53d1\u9001\u7aef\u53d1\u9001\u4e86\u4e24\u6b21\u6570\u636e\uff0c\u4f46\u662f<code>Nagle</code> \u7b97\u6cd5\u4f1a\u505a\u4f18\u5316\uff0c\u5c06\u591a\u4e2a\u6570\u636e\u91cf\u5c0f\u4e14\u95f4\u9694\u8f83\u77ed\u7684\u6570\u636e\u5408\u5e76\u6210\u4e00\u4e2a\u8f83\u5927\u7684\u6570\u636e\u7136\u540e\u8fdb\u884c\u5c01\u5305\u53d1\u9001\u3002\u8fd9\u6837\u63a5\u6536\u7aef\u662f\u65e0\u6cd5\u5206\u8fa8\u8fd9\u4e24\u4e2a\u6570\u636e\u7684\u3002</p> <p></p> <p>\u8981\u7406\u89e3\u8fd9\u4e2a\uff0c\u4e00\u5b9a\u8981\u77e5\u9053TCP\u662f\u57fa\u4e8e\u6d41\u7684\uff0c\u6240\u8c13\u6d41\u5f0f\u534f\u8bae\uff0c\u5373\u534f\u8bae\u7684\u5185\u5bb9\u50cf\u6c34\u6d41\u4e00\u6837\u7684\u5b57\u8282\u6d41\uff0c\u5185\u5bb9\u4e0e\u5185\u5bb9\u4e4b\u95f4\u6ca1\u6709\u660e\u786e\u7684\u5206\u754c\u6807\u5fd7\uff0c\u9700\u8981\u6211\u4eec\u4eba\u4e3a\u7684\u53bb\u7ed9\u8fd9\u4e9b\u534f\u8bae\u5212\u5206\u6807\u754c\u3002\u4e5f\u5c31\u662fTCP\u534f\u8bae\u672c\u6765\u5c31\u662f\u4e0d\u5904\u7406\u534f\u8bae\u5185\u5bb9\u7684\u5206\u754c\uff0c\u4f60\u975e\u8981\u8bf4\u8fd9\u662f\u4eba\u5bb6\u7684\u95ee\u9898\uff1f\uff01</p> <p>\u5904\u7406\u6570\u636e\u7684\u5206\u754c\u662f\u9700\u8981\u5e94\u7528\u5c42\u534f\u8bae\u6765\u505a\u7684\uff0c\u4e00\u822c\u4e24\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u4ee5\u6307\u5b9a\u5b57\u7b26\uff08\u4e32\uff09\u4f5c\u4e3a\u5305\u7ed3\u675f\u6807\u5fd7\u3002</li> </ul> <p>\u5373\u5b57\u8282\u6d41\u4e2d\u9047\u5230\u7279\u6b8a\u7684\u7b26\u53f7\u5c31\u8ba4\u4e3a\u5230\u4e00\u4e2a\u5305\u7684\u672b\u5c3e\u4e86\u3002\u4f8b\u5982FTP\uff0cSMTP\u5c31\u662f\"\\r\\n\"\u5c31\u8868\u793a\u4e00\u4e2a\u5305\u7684\u7ed3\u675f\u3002\u4e0d\u8db3\u4e4b\u5904\u5c31\u662f\u534f\u8bae\u5185\u5bb9\u91cc\u7528\u5230\u4e86\u7ed3\u675f\u6807\u5fd7\u5c31\u9700\u8981\u8fdb\u884c\u8f6c\u4e49\u3002netty\u4e2d\u7684DelimiterBasedFrameDecoder\u5c31\u662f\u65b9\u4fbf\u5904\u7406\u7279\u6b8a\u5b57\u7b26\u4f5c\u4e3a\u7ed3\u675f\u7b26\u7684\u5305\u3002</p> <ul> <li>\u5305\u5934+\u5305\u4f53\u7684\u683c\u5f0f</li> </ul> <p>\u8fd9\u79cd\u534f\u8bae\u7684\u6570\u636e\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff0c\u5305\u5934\u548c\u5305\u4f53\u3002\u5305\u5934\u5927\u5c0f\u56fa\u5b9a\uff0c\u4e14\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u5b57\u6bb5\u8bf4\u660e\u5305\u4f53\u6709\u591a\u5927\u3002\u63a5\u6536\u7aef\u5148\u6536\u53d6\u5305\u5934\u5927\u5c0f\u7684\u6570\u636e\uff08\u4e0d\u591f\u5c31\u63a5\u7eed\u7b49\uff09\uff0c\u7136\u540e\u89e3\u6790\u5305\u5934\uff0c\u6839\u636e\u5305\u5934\u4e2d\u6307\u5b9a\u7684\u5305\u4f53\u5927\u5c0f\u6765\u6536\u53d6\u5305\u4f53\uff0c\u7b49\u5305\u4f53\u591f\u4e86\uff0c\u5c31\u4f5c\u4e3a\u4e00\u4e2a\u5b8c\u6574\u7684\u5305\u6765\u5904\u7406\u3002netty\u4e2d\u4e00\u822c\u7528\u7ee7\u627fByteToMessageDecoder\u53bb\u5904\u7406\u8fd9\u79cd\u81ea\u5b9a\u4e49\u534f\u8bae\u7684\u6570\u636e\u3002</p>"},{"location":"java/NIO/#netty_5","title":"netty\u7684\u6e90\u7801\u89e3\u6790","text":"<p>\u53ea\u6709\u770b\u8fc7 Netty\u6e90\u7801\uff0c\u624d\u80fd\u8bf4\u662f\u771f\u7684\u638c\u63e1\u4e86 Netty\u6846\u67b6\u3002\u5728 <code>io.netty.example</code> \u5305\u4e0b\uff0c\u6709\u5f88\u591a Netty\u6e90\u7801\u6848\u4f8b\uff0c\u53ef\u4ee5\u7528\u6765\u5206\u6790\u3002</p>"},{"location":"java/NIO/#netty_6","title":"netty\u7684\u542f\u52a8\u6d41\u7a0b\u6e90\u7801","text":""},{"location":"java/NIO/#1-eventloopgroup","title":"1. EventLoopGroup\u521b\u5efa\u7ebf\u7a0b\u7ec4","text":"<pre><code>EventLoopGroup bossGroup = new NioEventLoopGroup(1);\n// \u4e0d\u6307\u5b9a\u7ebf\u7a0b\u6570\uff0c\u9ed8\u8ba4\u662fNettyRuntime.availableProcessors() * 2\nEventLoopGroup workerGroup = new NioEventLoopGroup();\n</code></pre> <p>\u8fd9\u91cc\u7684NioEventLoopGroup\u7ee7\u627f\u4e86\u62bd\u8c61\u7c7bMultithreadEventLoopGroup</p> <pre><code>// \u6ce8\u610f\u5b83\u7ee7\u627f\u4e86\u591a\u7ebf\u7a0b\u6267\u884cExecutor\npublic abstract class MultithreadEventLoopGroup extends MultithreadEventExecutorGroup implements EventLoopGroup {\n\n}\n// \u6700\u7ec8\u7684\u6784\u9020\u65b9\u6cd5\nprotected MultithreadEventExecutorGroup(int nThreads, Executor executor,\n                                            EventExecutorChooserFactory chooserFactory, Object... args) {\n    // \u7ebf\u7a0b\u6570\u5fc5\u987b\u4e3a\u6b63\u6570\n    checkPositive(nThreads, \"nThreads\");\n\n    if (executor == null) {\n        // \u6ca1\u6709\u6307\u5b9a\u5c31\u662f\u7528\u9ed8\u8ba4\u7684\u6267\u884c\u5668\n        executor = new ThreadPerTaskExecutor(newDefaultThreadFactory());\n    }\n\n    // \u5173\u952e\uff1a\u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u521b\u5efa\u4e00\u4e2a\u6267\u884c\u5668\uff0c\u4e5f\u5c31\u662f\u8bf4\u6267\u884c\u5668\u90fd\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4e0d\u505c\u7684\u6267\u884c\n    children = new EventExecutor[nThreads];\n    for (int i = 0; i &lt; nThreads; i ++) {\n        boolean success = false;\n        try {\n            // newChild\u521b\u5efa\u7ebf\u7a0b\uff0c\u7531\u5b50\u7c7bNioEventLoopGroup\u81ea\u5df1\u5b9e\u73b0\uff0c\u521b\u5efaNioEventLoop\u7ebf\u7a0b\n            children[i] = newChild(executor, args);\n            success = true;\n        } catch (Exception e) {\n            // TODO: Think about if this is a good exception type\n            throw new IllegalStateException(\"failed to create a child event loop\", e);\n        } finally {\n            // \u5982\u679c\u67d0\u4e2a\u7ebf\u7a0b\u521b\u5efa\u5931\u8d25\uff0c\u5c31\u628a\u4e4b\u524d\u521b\u5efa\u597d\u7684\u90fd\u4f18\u96c5\u5173\u95ed\n            if (!success) {\n                for (int j = 0; j &lt; i; j ++) {\n                    children[j].shutdownGracefully();\n                }\n\n                for (int j = 0; j &lt; i; j ++) {\n                    EventExecutor e = children[j];\n                    try {\n                        while (!e.isTerminated()) {\n                            e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);\n                        }\n                    } catch (InterruptedException interrupted) {\n                        // Let the caller handle the interruption.\n                        Thread.currentThread().interrupt();\n                        break;\n                    }\n                }\n            }\n        }\n    }\n\n    chooser = chooserFactory.newChooser(children);\n\n    final FutureListener&lt;Object&gt; terminationListener = new FutureListener&lt;Object&gt;() {\n        @Override\n        public void operationComplete(Future&lt;Object&gt; future) throws Exception {\n            if (terminatedChildren.incrementAndGet() == children.length) {\n                terminationFuture.setSuccess(null);\n            }\n        }\n    };\n\n    // \u4e3a\u6bcf\u4e2a\u7ebf\u7a0b\u6c60\u6dfb\u52a0\u76d1\u542c\u5668\n    for (EventExecutor e: children) {\n        e.terminationFuture().addListener(terminationListener);\n    }\n\n    // \u5c06\u7ebf\u7a0b\u6c60\u6570\u7ec4\u653e\u5230\u4e00\u4e2a\u53ea\u8bfb\u7684set\u4e2d\n    Set&lt;EventExecutor&gt; childrenSet = new LinkedHashSet&lt;EventExecutor&gt;(children.length);\n    Collections.addAll(childrenSet, children);\n    readonlyChildren = Collections.unmodifiableSet(childrenSet);\n}\n</code></pre>"},{"location":"java/NIO/#2-serverbootstrap","title":"2. ServerBootstrap\u5f15\u5bfc\u7c7b","text":"<pre><code>ServerBootstrap b = new ServerBootstrap();\nb.group(bossGroup, workerGroup)\n    // \u6839\u636e\u7c7b\u578b\u521b\u5efa\u4e00\u4e2achannel\uff0c\u8fd9\u91cc\u662f\u7528\u4e8e\u670d\u52a1\u7aef\u7684channel\n    .channel(NioServerSocketChannel.class)\n    // \u7528\u4e00\u4e2aLinkedHashMap\u4fdd\u5b58\u4e0a\u9762channel\u7684\u5c5e\u6027\uff0c\u4f20null\u5c31\u6e05\u7a7a\u8bbe\u7f6e\n    .option(ChannelOption.SO_BACKLOG, 100)\n    // \u8fd9\u4e2a hanlder \u53ea\u4e13\u5c5e\u4e8e ServerSocketChannel \u800c\u4e0d\u662f SocketChannel\n    .handler(new LoggingHandler(LogLevel.INFO))\n    // \u8fd9\u91cc\u7684handler\u5904\u7406\u6bcf\u4e2a\u8fde\u63a5\n    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {\n        @Override\n        public void initChannel(SocketChannel ch) throws Exception {\n            ChannelPipeline p = ch.pipeline();\n            if (sslCtx != null) {\n                p.addLast(sslCtx.newHandler(ch.alloc()));\n            }\n            //p.addLast(new LoggingHandler(LogLevel.INFO));\n            p.addLast(serverHandler);\n        }\n    });\n</code></pre>"},{"location":"java/NIO/#3dobind","title":"3.doBind \u542f\u52a8","text":"<p>\u5148\u521d\u59cb\u5316channel\uff0c\u7136\u540e\u7ed1\u5b9a\u7aef\u53e3\u3002</p> <pre><code>// Start the server.\nChannelFuture f = b.bind(PORT).sync();\n\nprivate ChannelFuture doBind(final SocketAddress localAddress) {\n    // 1. initAndRegister\u6838\u5fc3\u65b9\u6cd5\n    final ChannelFuture regFuture = initAndRegister();\n    final Channel channel = regFuture.channel();\n    if (regFuture.cause() != null) {\n        return regFuture;\n    }\n\n    if (regFuture.isDone()) {\n        // At this point we know that the registration was complete and successful.\n        ChannelPromise promise = channel.newPromise();\n        // 2. \u8fdb\u884c\u7ed1\u5b9a\n        doBind0(regFuture, channel, localAddress, promise);\n        return promise;\n    } \n}\n</code></pre> <p>\u5148\u8bf4initAndRegister()\u5148\u521b\u5efa\u4e86\u4e00\u4e2aServerSocketChannel\uff0c\u7136\u540e\u4ea4\u7ed9\u4e0b\u9762init\u8fdb\u884c\u521d\u59cb\u5316  </p> <pre><code>@Override\nvoid init(Channel channel) {\n    setChannelOptions(channel, newOptionsArray(), logger);\n    setAttributes(channel, newAttributesArray());\n\n    ChannelPipeline p = channel.pipeline();\n\n    final EventLoopGroup currentChildGroup = childGroup;\n    final ChannelHandler currentChildHandler = childHandler;\n    final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions = newOptionsArray(childOptions);\n    final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs = newAttributesArray(childAttrs);\n\n    p.addLast(new ChannelInitializer&lt;Channel&gt;() {\n        @Override\n        public void initChannel(final Channel ch) {\n            final ChannelPipeline pipeline = ch.pipeline();\n            ChannelHandler handler = config.handler();\n            if (handler != null) {\n                pipeline.addLast(handler);\n            }\n\n            ch.eventLoop().execute(new Runnable() {\n                @Override\n                public void run() {\n                    pipeline.addLast(new ServerBootstrapAcceptor(\n                        ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));\n                }\n            });\n        }\n    });\n}\n</code></pre> <p>pipeline.addLast(handler)\u662f\u6838\u5fc3\u65b9\u6cd5\uff0c\u5b83\u521b\u5efa\u4e00\u4e2a <code>AbstractChannelHandlerContext</code> \u5bf9\u8c61\uff0c\u8fd9\u91cc\u8bf4\u4e00\u4e0b\uff0c<code>ChannelHandlerContext</code> \u5bf9\u8c61\u662f <code>ChannelHandler</code> \u548c <code>ChannelPipeline</code> \u4e4b\u95f4\u7684\u5173\u8054\uff0c\u6bcf\u5f53\u6709 <code>ChannelHandler</code> \u6dfb\u52a0\u5230 <code>Pipeline</code> \u4e2d\u65f6\uff0c\u90fd\u4f1a\u521b\u5efa <code>Context</code>\u3002</p> <p>\u5c06 <code>Context</code> \u6dfb\u52a0\u5230\u94fe\u8868\u4e2d\uff0c\u4e5f\u5c31\u662f\u8ffd\u52a0\u5230 <code>tail</code> \u8282\u70b9\u7684\u524d\u9762\u3002pipeline\u53cc\u5411\u94fe\u8868\u7684tail\u662f\u56fa\u5b9a\u7684\uff0c\u8d1f\u8d23\u4e00\u4e9b\u7cfb\u7edf\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0caddLast()\u5b9e\u9645\u4e0a\u662f\u52a0\u5230tail\u7684\u524d\u9762\u3002</p> <p>\u518d\u770bdoBind0()</p> <pre><code>private static void doBind0(\n        final ChannelFuture regFuture, final Channel channel,\n        final SocketAddress localAddress, final ChannelPromise promise) {\n\n    // This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up\n    // the pipeline in its channelRegistered() implementation.\n    channel.eventLoop().execute(new Runnable() {\n        @Override\n        public void run() {\n            if (regFuture.isSuccess()) {\n                //bind\u65b9\u6cd5\u8fd9\u91cc\u4e0b\u65ad\u70b9\uff0c\u8fd9\u91cc\u4e0b\u65ad\u70b9\uff0c\u6765\u73a9!!\n                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);\n            } else {\n                promise.setFailure(regFuture.cause());\n            }\n        }\n    });\n}\n</code></pre>"},{"location":"java/NIO/#netty_7","title":"netty\u63a5\u6536\u8bf7\u6c42\u7684\u6d41\u7a0b\u6e90\u7801","text":"<p>\u670d\u52a1\u5668\u542f\u52a8\u540e\u80af\u5b9a\u662f\u8981\u63a5\u53d7\u5ba2\u6237\u7aef\u8bf7\u6c42\u5e76\u8fd4\u56de\u5ba2\u6237\u7aef\u60f3\u8981\u7684\u4fe1\u606f \uff0c\u4e0b\u9762\u6e90\u7801\u5206\u6790 Netty\u5728\u542f\u52a8\u4e4b\u540e\u662f\u5982\u4f55\u63a5\u53d7\u5ba2\u6237\u7aef\u8bf7\u6c42\uff0c\u5c06\u5176\u6ce8\u518c\u5230workerGroup\u4e0a\u7684\u3002</p> <p>Eventloop\u7684\u4f5c\u7528\u662f\u4e2a\u6b7b\u5faa\u73af\uff0c\u505a\u4e09\u4ef6\u4e8b\uff1a</p> <ul> <li> <p>\u6709\u6761\u4ef6\u7684\u7b49\u5f85nio\u4e8b\u4ef6</p> </li> <li> <p>\u5904\u7406nio\u4e8b\u4ef6</p> </li> <li> <p>\u5904\u7406\u6d88\u606f\u961f\u5217\u4e2d\u7684\u4efb\u52a1</p> </li> </ul> <p>nioEventLoop\u6b7b\u5faa\u73af\u4e2d\u5bf9\u4e8eaccept\u4e8b\u4ef6\u4ea4\u7ed9<code>private void processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code>\u65b9\u6cd5\u4e2d\uff0creadyOps=16\u662faccept\u4e8b\u4ef6\uff0c</p> <pre><code>// \u83b7\u53d6\u5305\u88c5\u597d\u7684channel,\u6dfb\u52a0\u5230\u5bb9\u5668readBuf\u91cc\uff0c\nint localRead = doReadMessages(readBuf);\n\n// \u5faa\u73af\u4ecereadBuf\u83b7\u53d6channel\nfor (int i = 0; i &lt; size; i++) {\n    readPending = false;\n    pipeline.fireChannelRead(readBuf.get(i));\n}\n</code></pre> <p>\u8fd9\u91cc\u7684pipeline.fireChannelRead\u4f1a\u5bf9\u6bcf\u4e2achannel\u8c03\u7528\u591a\u4e2ahandler\u3002<code>pipeline</code> \u91cc\u9762\u6709 4\u4e2a<code>handler</code>\uff0c\u5206\u522b\u662f <code>Head</code>\uff0c<code>LoggingHandler</code>\uff0c<code>ServerBootstrapAcceptor</code>\uff0c<code>Tail</code>\u3002</p> <pre><code>// \u6211\u4eec\u91cd\u70b9\u770bServerBootstrapAcceptor\u7684channelRead\u65b9\u6cd5\npublic void channelRead(ChannelHandlerContext ctx, Object msg) {\n    // \u5c06msg\u5f3a\u8f6c\u6210Channel\n    final Channel child = (Channel) msg;\n\n    // \u4e3a\u8fd9\u4e2a\u8fdb\u6765\u7684\u8fde\u63a5channel\u8bbe\u7f6e\u591a\u4e2a\u5c5e\u6027\n    // \u5c06\u7528\u6237\u914d\u7f6e\u7684childHandler\u6dfb\u52a0\u5230\u8fd9\u4e2achannel\u7684pipeline\u4e2d\n    child.pipeline().addLast(childHandler);\n    setChannelOptions(child, childOptions, logger);\n    setAttributes(child, childAttrs);\n\n    try {\n        // \u8fd9\u91cc\uff0c\u5c31\u662f\u8fd9\u91cc\u5c06\u5ba2\u6237\u7aef\u8fde\u63a5\u6ce8\u518c\u5230 worker \u7ebf\u7a0b\u6c60\n        childGroup.register(child).addListener(new ChannelFutureListener() {\n            @Override\n            public void operationComplete(ChannelFuture future) throws Exception {\n                if (!future.isSuccess()) {\n                    forceClose(child, future.cause());\n                }\n            }\n        });\n    } catch (Throwable t) {\n        forceClose(child, t);\n    }\n}\n</code></pre> <p>\u603b\u7ed3\uff1a</p> <ul> <li> <p>NioEventLoopGroup\u7684NioEventLoop\u5faa\u73af\u76d1\u542c\uff0c\u5f53\u63a5\u6536\u5230\u4e00\u4e2a\u8fde\u63a5\u65f6\uff0c\u901a\u8fc7JDK\u521b\u5efa\u4e00\u4e2aSocketChannel\uff0c\u5305\u88c5\u6210NioSocketChannel\uff0c\u6dfb\u52a0\u5230\u5bb9\u5668\u91cc\u3002</p> </li> <li> <p>\u7136\u540e\u5faa\u73af\u5bf9\u5bb9\u5668\u91cc\u7684channl\u6267\u884chandler\uff0c\u5176\u4e2dServerBootstrapAcceptor\uff0c\u4f1a\u8d1f\u8d23\u4e3achannel\u8bbe\u7f6ehandler\uff0c\u5c5e\u6027\u7b49\uff0c\u5e76\u6ce8\u518c\u5230childGroup\u7684\u4e00\u4e2aEventloop\u4e0a\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e2a\u76d1\u542c\u5668\u3002</p> </li> </ul>"},{"location":"java/NIO/#channelpipeline-channelhandlercontext-channelhandler","title":"ChannelPipeline | ChannelHandlerContext | ChannelHandler\u4ecb\u7ecd","text":"<p>\u6211\u4eec\u9700\u8981\u4ece\u6e90\u7801\u6765\u5206\u6790netty\u662f\u5982\u4f55\u8bbe\u8ba1\u8fd9\u4e09\u4e2a\u975e\u5e38\u6838\u5fc3\u7684\u7ec4\u4ef6\uff0c\u5206\u6790\u662f\u5982\u4f55\u521b\u5efa\u548c\u534f\u540c\u5de5\u4f5c\u7684\u3002</p> <p>\u6bcf\u5f53serverSocket accept\u4e00\u4e2a\u65b0\u7684\u8fde\u63a5\u65f6\uff0c\u5c31\u4f1a\u521b\u5efa\u5bf9\u5e94\u4e00\u4e2a\u5ba2\u6237\u7aef\u7684socket\uff0c\u5e76\u4f1a\u5206\u914d\u4e00\u4e2aChannelPipeline\uff0c\u5b83\u5185\u90e8\u5305\u542b\u591a\u4e2aChannelHandlerContext\uff0c\u4ed6\u4eec\u4e00\u8d77\u7ec4\u6210\u4e86\u53cc\u5411\u94fe\u8868\u3002ChannelHandlerContext\u662f\u5bf9ChannelHandler\u7684\u5c01\u88c5\uff0c\u5305\u542b\u4e86\u4e00\u4e9b\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002</p>"},{"location":"java/NIO/#1-channelpipeline","title":"1. ChannelPipeline","text":"<p>\u5b83\u7ee7\u627f\u4e86<code>inBound</code>\uff0c<code>outBound</code>\uff0c<code>Iterable</code> \u63a5\u53e3\uff0c\u8868\u793a\u4ed6\u53ef\u4ee5\u8c03\u7528\u6570\u636e\u51fa\u7ad9\u7684\u65b9\u6cd5\u548c\u5165\u7ad9\u7684\u65b9\u6cd5\uff0c\u540c\u65f6\u4e5f\u80fd\u904d\u5386\u5185\u90e8\u7684\u94fe\u8868\u3002</p> <p></p> <p>\u5b83\u7684\u65b9\u6cd5\u57fa\u672c\u90fd\u662f\u9488\u5bf9channelHandler\u7684\u63d2\u5165\uff0c\u8ffd\u52a0\uff0c\u5220\u9664\uff0c\u66ff\u6362\uff0c\u5c31\u662f\u94fe\u8868\u7684\u4e00\u4e9b\u64cd\u4f5c\uff0c\u53e6\u5916\u4e5f\u80fd\u8fd4\u56de\u5bf9\u5e94\u7684channel\uff08socket)\u3002</p> <p></p> <p>handler\u94fe\u7684\u8c03\u7528\u987a\u5e8f</p> <pre><code>ChannelPipeline pipeline = ch.pipeline();\npipeline.addLast(new MyLongToByteEncoder());\n// \u540e\u52a0\u7684handler\u5728\u961f\u5c3e\uff0c\u66f4\u9760\u8fd1\u81ea\u5df1\u3002\u6700\u5148\u5904\u7406\u51fa\u7ad9\u7684\u6d88\u606f\uff0c\u6700\u540e\u5904\u7406\u5165\u7ad9\u7684\u6d88\u606f\npipeline.addLast(new MyClientHandler());\n</code></pre> <p>\u5728 <code>pipeline</code> \u7684\u63a5\u53e3\u6587\u6863\u4e0a\uff0c\u63d0\u4f9b\u4e86\u4e00\u5e45\u56fe</p> <p></p> <p>\u8fd9\u5e45\u56fe\u5de6\u8fb9\u5e95\u90e8\u63cf\u8ff0\u4e86IO\u7ebf\u7a0b\u901a\u8fc7scoket.read()\u8bfb\u53d6\u5230\u6570\u636e\u540e\uff0c\u4ea4\u7531\u5404\u4e2aInbound channelHandler\u5904\u7406\uff0c\u5176\u4e2d\u901a\u8fc7\u8c03\u7528 <code>ChannelHandlerContext.fireChannelRead</code> \u65b9\u6cd5\u8f6c\u53d1\u7ed9\u5176\u6700\u8fd1\u7684\u5904\u7406\u7a0b\u5e8f\u3002</p> <pre><code>// \u5bfb\u627e\u4e0b\u4e00\u4e2a\u5165\u7ad9\u7684handler\uff0c\u5176\u5b9e\u5c31\u662fwhile\u5faa\u73af\uff0c\u6bcf\u4e2ahandler\u6709\u51fa\u7ad9\u5165\u7ad9\u7684\u6807\u5fd7 \nprivate AbstractChannelHandlerContext findContextInbound() {\n     AbstractChannelHandlerContext ctx = this;\n     do {\n         ctx = ctx.next;\n     } while (!ctx.inbound);\n     return ctx;\n }\n</code></pre>"},{"location":"java/NIO/#2channelhandler","title":"2.ChannelHandler","text":"<p>\u7b80\u5355\u5206\u6790ChannelHandler\u7684\u63a5\u53e3\u4f53\u7cfb\u8bbe\u8ba1\uff1a\u6700\u9876\u5c42ChannelHandler\u53ea\u6709handlerAdded,handlerRemoved\u7684\u65b9\u6cd5\uff0c\u7136\u540e\u56e0\u4e3a\u5165\u7ad9\u548c\u51fa\u7ad9\u7684\u64cd\u4f5c\u4e0d\u540c\u5206\u4e3a\u4e24\u4e2a\u5b50\u63a5\u53e3\uff0c\u6bcf\u4e2a\u63a5\u53e3\u90fd\u6709\u9ed8\u8ba4\u7684\u5b9e\u73b0HandlerAdapter\uff0c\u5b83\u53ea\u662f\u7b80\u5355\u7684\u8f6c\u53d1\u7ed9\u4e0b\u4e00\u4e2ahandler,\u9700\u8981\u5b50\u7c7b\u81ea\u5df1\u8986\u76d6\u5b9e\u73b0\u3002</p> <p>\u5982\u679c\u540c\u65f6\u9700\u8981\u62e6\u622a\u64cd\u4f5c\u548c\u72b6\u6001\u66f4\u65b0\uff0c\u53ef\u4ee5\u4f7f\u7528<code>public class ChannelDuplexHandler extends ChannelInboundHandlerAdapter implements ChannelOutboundHandler {}</code>\uff0c\u5b83\u7ee7\u627f\u4e86\u5165\u7ad9\u5b9e\u73b0\u7c7b\uff0c\u5e76\u76f4\u63a5\u5b9e\u73b0\u4e86\u51fa\u7ad9\u63a5\u53e3\uff0c\u80fd\u591f\u540c\u65f6\u5904\u7406\u5165\u7ad9\u4e8b\u4ef6\u548c\u51fa\u7ad9\u4e8b\u4ef6\u3002\u5b9e\u9645\u751f\u4ea7\u5c3d\u91cf\u907f\u514d\u4f7f\u7528\uff0c\u56e0\u4e3a\u5f88\u5bb9\u6613\u6df7\u6dc6\u5165\u7ad9\u548c\u51fa\u7ad9\u3002</p> <p>ChannelHandler\u7684\u72b6\u6001\u7ba1\u7406 </p> <p>ChannelHandler\u53ef\u4ee5\u4f7f\u7528\u6210\u5458\u53d8\u91cf\u6765\u5b58\u50a8\u72b6\u6001\uff0c\u4f46\u662f\u6ce8\u610f\u8fd9\u65f6\u5728\u6dfb\u52a0\u5230channelPipeline\u4e2d\u65f6\uff0c\u5fc5\u987b\u662fnew ChannelHandler()\u4e3a\u6bcf\u4e2achannelPipeline\u521b\u5efa\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u907f\u514d\u5176\u4ed6channe\u975e\u6cd5\u83b7\u53d6\u5230\u6210\u5458\u53d8\u91cf\u7684\u72b6\u6001\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u53ea\u60f3\u521b\u5efa\u4e00\u4e2aChannelHandler\u5b9e\u4f8b\u6dfb\u52a0\u5230\u591a\u4e2achannelPipeline\u4e2d\uff0c\u5219\u5fc5\u987b\u5728ChannelHandler\u6dfb\u52a0@sharable\u8868\u660e\u8fd9\u4e2ahandler\u662f\u53ef\u4ee5\u5171\u4eab\u7684\u3002\u6b64\u65f6\u53ef\u4ee5\u5229\u7528AttributeKey\u4fdd\u5b58\u6bcf\u4e2ahandler\u7684\u72b6\u6001\u3002</p> <pre><code>@Sharable\npublic class DataServerHandler extends SimpleChannelInboundHandler&lt;Message&gt; {\n    private final AttributeKey&lt;Boolean&gt; auth = AttributeKey.valueOf(\"auth\");\n\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Message message) {\n        Attribute&lt;Boolean&gt; attr = ctx.attr(auth);\n        Channel ch = ctx.channel();\n        if (message instanceof LoginMessage) {\n            authenticate((LoginMessage) o);\n            attr.set(true);\n        } else (message instanceof GetDataMessage) {\n            if (Boolean.TRUE.equals(attr.get())) {\n                ch.write(fetchSecret((GetDataMessage) o));\n            } else {\n                fail();\n            }\n        }\n    }\n    ...\n}\n\n// \u73b0\u5728\u5904\u7406\u7a0b\u5e8f\u7684\u72b6\u6001\u5df2\u9644\u52a0\u5230ChannelHandlerContext \uff0c\u60a8\u53ef\u4ee5\u5c06\u76f8\u540c\u7684\u5904\u7406\u7a0b\u5e8f\u5b9e\u4f8b\u6dfb\u52a0\u5230\u4e0d\u540c\u7684\u7ba1\u9053\uff1a\npublic class DataServerInitializer extends ChannelInitializer&lt;Channel&gt; {\n\n    @Autowired\n    private DataServerHandler dataServerHandler;\n\n    @Override\n    public void initChannel(Channel channel) {\n        channel.pipeline().addLast(\"handler\", dataServerHandler);\n    }\n}\n</code></pre>"},{"location":"java/NIO/#3-channelhandlercontext","title":"3. ChannelHandlerContext","text":"<p>ChannelHandlerContext\u4e0d\u4ec5\u7ee7\u627f\u4e86\u51fa\u7ad9\u548c\u5165\u7ad9\u7684\u65b9\u6cd5\uff0c\u540c\u65f6\u4e5f\u5b9a\u4e49\u4e86\u4e00\u4e9b\u81ea\u5df1\u7684\u65b9\u6cd5\uff0c\u6bd4\u5982\u80fd\u591f\u83b7\u53d6<code>channel</code>\uff0c<code>executor</code>\uff0c<code>handler</code>\uff0c<code>pipeline</code>\uff0c\u5185\u5b58\u5206\u914d\u5668\uff0c\u5173\u8054\u7684 <code>handler</code> \u662f\u5426\u88ab\u5220\u9664\u3002</p> <p></p> <p>\u4f5c\u7528\uff1a</p> <ul> <li>\u53ef\u4ee5\u901a\u77e5\u540c\u4e00\u7ba1\u9053\u91cc\u4e0b\u4e00\u4e2ahandler</li> </ul> <p><code>ChannelFuture writeAndFlush(Object msg)</code>\uff1a\u5c06\u6570\u636e\u5199\u5230   \u5f53\u524dChannelPipeline \u4e2d\u4e0b\u4e00\u4e2aChannelHandler\u5904\u7406\uff08\u51fa\u7ad9\uff09</p> <ul> <li> <p>\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u52a8\u6001\u63d2\u5165\uff0c\u5220\u9664\uff0c\u66ff\u6362ChannelPipeline\u4e2d\u7684handlers</p> </li> <li> <p>\u4fdd\u7559ChannelHandlerContext\uff0c\u5728handler\u65b9\u6cd5\u4e4b\u5916\u89e6\u53d1\u4e8b\u4ef6</p> </li> </ul> <pre><code>public class MyHandler extends ChannelDuplexHandler {\n\n    private ChannelHandlerContext ctx;\n\n    public void beforeAdd(ChannelHandlerContext ctx) {\n        this.ctx = ctx;\n    }\n\n    public void login(String username, password) {\n        ctx.write(new LoginMessage(username, password));\n    }\n    ...\n}\n</code></pre> <ul> <li>handler\u53ef\u4ee5\u6709\u591a\u4e2aContext</li> </ul> <p>\u4e00\u4e2aChannelHandler\u5b9e\u4f8b\u53ef\u4ee5\u88ab\u6dfb\u52a0\u5230\u591a\u4e2aChannelPipeline\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2aChannelHandler\u53ef\u80fd\u6709\u591a\u4e2aChannelHandlerContext\uff0c\u56e0\u6b64ChannelHandler\u53ef\u80fd\u88ab\u591a\u4e2aChannelHandlerContext\u8c03\u7528\u3002 </p> <pre><code>// \u8fd9\u4e2ahandler\u4f1a\u6709\u591a\u4e2a\u72ec\u7acb\u7684AttributeKey\uff0c\u65e0\u8bba\u662f\u6dfb\u52a0\u5230\u4e0d\u540c\u7684ChannelPipeline\u8fd8\u662f\u591a\u6b21\u6dfb\u52a0\u5230\u540c\u4e00\u4e2aChannelPipeline\npublic class FactorialHandler extends ChannelInboundHandlerAdapter {\n\n    private final AttributeKey&lt;Integer&gt; counter = AttributeKey.valueOf(\"counter\");\n\n    // This handler will receive \u4ece1\u5f00\u59cb\u7684\u9012\u589e\u5e8f\u5217msg\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        Integer a = ctx.attr(counter).get();\n\n        if (a == null) {\n            a = 1;\n        }\n\n        attr.set(a * (Integer) msg);\n    }\n}\n\n\n// \u5373\u4f7f\u540c\u4e00\u4e2aFactorialHandler\u5b9e\u4f8bfh\uff0c\u88ab\u6dfb\u52a0\u5230\u4e0d\u540c\u7684ChannelPipeline\u3002\u9636\u4e58\u4e5f\u4f1a\u88ab\u6b63\u786e\u7684\u8ba1\u7b97\u56db\u6b21\uff0c\u56e0\u4e3aAttributeKey\u5c5e\u4e8eChannelHandlerContext\u7684\nFactorialHandler fh = new FactorialHandler();\n\nChannelPipeline p1 =  Channels.pipeline();\np1.addLast(\"f1\", fh);\np1.addLast(\"f2\", fh);\n\nChannelPipeline p2 = Channels.pipeline();\np2.addLast(\"f3\", fh);\np2.addLast(\"f4\", fh);\n</code></pre>"},{"location":"java/NIO/#_1","title":"\u521b\u5efa","text":"<p>\u521b\u5efasocket\u65f6\u4e3a\u5176\u5206\u914dpipeline</p> <pre><code>// \u6784\u9020channel\u7684\u8fc7\u7a0b\nprotected AbstractChannel(Channel parent) {\n    this.parent = parent;\n    // channelID\u7684\u751f\u6210\u6d89\u53ca\u5230\u673a\u5668\uff0c\u8fdb\u7a0bID\uff0c\u65f6\u95f4\u6233\uff0c\u968f\u673a\u6570\n    id = newId();\n    unsafe = newUnsafe();\n    // \u8fd9\u91cc\u521b\u5efachannel\u65f6\u5c31\u4f1a\u4e3a\u5176\u5206\u914d\u4e00\u4e2apipeline\n    pipeline = newChannelPipeline();\n}\n\n// \u751f\u6210pipeline,\u80af\u5b9a\u9700\u8981\u4f20\u5165\u4e00\u4e2aChannel\nprotected DefaultChannelPipeline(Channel channel) {\n    this.channel = ObjectUtil.checkNotNull(channel, \"channel\");\n    succeededFuture = new SucceededChannelFuture(channel, null);\n    voidPromise = new VoidChannelPromise(channel, true);\n\n    // \u53cc\u5411\u94fe\u8868\u7684\u5934\u548c\u5c3e\uff0c\u4ece\u8fd9\u91cc\u53ef\u4ee5\u770b\u51fa\u6bcf\u4e2apipeline\u90fd\u6709\u4e00\u4e2a\u56fa\u5b9a\u7684head\u548ctail\uff0c\n    tail = new TailContext(this);\n    // HeadContext\u5373\u53ef\u4ee5\u5904\u7406\u5165\u7ad9\u53c8\u53ef\u4ee5\u5904\u7406\u51fa\u7ad9\u3002TailContext\u53ea\u5904\u7406\u5165\u7ad9 \n    head = new HeadContext(this);\n\n    // \u9996\u5c3e\u6307\u9488\u8fde\u63a5\n    head.next = tail;\n    tail.prev = head;\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\u770b\u521b\u5efahandler\u7684\u8fc7\u7a0b</p> <pre><code>@Override\npublic final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {\n    final AbstractChannelHandlerContext newCtx;\n    // \u9632\u6b62\u540c\u65f6\u66f4\u65b0\n    synchronized (this) {\n        // \u68c0\u67e5handler\u662f\u5426\u662f\u53ef\u5171\u4eab\u7684\uff0c\u662f\u5426\u88ab\u6dfb\u52a0\u8fc7\n        checkMultiplicity(handler);\n\n        // handler\u90fd\u4f1a\u5c01\u88c5\u6210\u4e00\u4e2a\u5bf9\u5e94\u7684ChannelHandlerContext\n        newCtx = newContext(group, filterName(name, handler), handler);\n\n        // \u6dfb\u52a0\u5230\u94fe\u8868\u5c3e\u90e8\uff0c\u4e4b\u524d\u521d\u59cb\u5316\u597d\u7684tail\u5e76\u4e0d\u53d8\n        addLast0(newCtx);\n\n        // If the registered is false it means that the channel was not registered on an eventLoop yet.\n        // In this case we add the context to the pipeline and add a task that will call\n        // ChannelHandler.handlerAdded(...) once the channel is registered.\n        if (!registered) {\n            newCtx.setAddPending();\n            callHandlerCallbackLater(newCtx, true);\n            return this;\n        }\n\n        EventExecutor executor = newCtx.executor();\n        if (!executor.inEventLoop()) {\n            callHandlerAddedInEventLoop(newCtx, executor);\n            return this;\n        }\n    }\n    callHandlerAdded0(newCtx);\n    return this;\n}\n</code></pre>"},{"location":"java/NIO/#4-channelpipelinehandler","title":"4. channelPipeline\u5982\u4f55\u8c03\u5ea6handler\uff1f","text":"<p>\u5f53\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u6765\u7684\u65f6\u5019\uff0c\u4f1a\u7b2c\u4e00\u4e2a\u8c03\u7528 <code>pipeline</code> \u7684\u76f8\u5173\u65b9\u6cd5\uff0c\u5982\u679c\u662f\u5165\u7ad9\u4e8b\u4ef6\u90fd\u662f <code>fire</code> \u5f00\u5934\uff0c\u8868\u793a\u5f00\u59cb\u7ba1\u9053\u7684\u6d41\u52a8\uff0c\u8ba9\u540e\u9762\u7684 <code>handler</code> \u7ee7\u7eed\u5904\u7406</p> <pre><code>public class DefaultChannelPipeline implements ChannelPipeline {\n    // \u5f53\u4e00\u4e2a\u8bf7\u6c42\u8fc7\u6765\u65f6\uff0c\u9996\u5148\u4f1a\u8c03\u7528ChannelPipeline\u7684fireChannelActive()\n    @Override\n    public final ChannelPipeline fireChannelActive() {\n        AbstractChannelHandlerContext.invokeChannelActive(head);\n        return this;\n    }\n\n    @Override\n    public final ChannelPipelinefireChannelInactive() {\n        AbstractChannelHandlerContext.invokeChannelInactive(head);\n        return this;\n    }\n\n    @Override\n    public final ChannelPipeline fireExceptionCaught(Throwable cause) {\n        AbstractChannelHandlerContext.invokeExceptionCaught(head, cause);\n        return this;\n    }\n\n    @Override\n    public final ChannelPipeline fireUserEventTriggered(Object event) {\n        AbstractChannelHandlerContext.invokeUserEventTriggered(head, event);\n        return this;\n    }\n\n    @Override\n    public final ChannelPipeline fireChannelRead(Objectmsg) {\n        AbstractChannelHandlerContext.invokeChannelRead(head, msg);\n        return this;\n    }\n\n    @Override\n    public final ChannelPipeline fireChannelReadComplete() {\n        AbstractChannelHandlerContext.invokeChannelReadComplete(head);\n        return this;\n    }\n\n    @Override\n    public final ChannelPipeline fireChannelWritabilityChanged() {\n        AbstractChannelHandlerContext.invokeChannelWritabilityChanged(head);\n        return this;\n    }\n}\n</code></pre> <p>\u4ed4\u7ec6\u770b\u4f1a\u53d1\u73b0\uff0c\u8fd9\u4e9b\u90fd\u662finbound\u7684\u65b9\u6cd5\uff0c\u901a\u8fc7AbstractChannelHandlerContext\u7684\u9759\u6001\u65b9\u6cd5\uff0c\u4f20\u5165head\uff08pipeline\u5934\u90e8\u7b2c\u4e00\u4e2ahandler\uff0c\u8fd8\u8bb0\u5f97\u4ed6\u662finbound\u7c7b\u578b\u7684\u5417\uff09\uff0c\u91cc\u9762\u4f1a\u8c03\u7528head\u7684ChannelInboundInvoker\u65b9\u6cd5\uff0c\u7136\u540e\u987a\u5e8f\u89e6\u53d1handler\u7684\u771f\u6b63\u65b9\u6cd5\u3002</p> <p>\u518d\u770bchannelPipeline\u7684\u51fa\u7ad9\u65b9\u6cd5</p> <pre><code>public class DefaultChannelPipeline implements ChannelPipeline {\n    @Override\n    public final ChannelFuture bind(SocketAddress localAddress) {\n        return tail.bind(localAddress);\n    }\n\n    @Override\n    public final ChannelFuture connect(SocketAddress remoteAddress) {\n        return tail.connect(remoteAddress);\n    }\n\n    @Override\n    public final ChannelFuture connect(SocketAddress remoteAddress, SocketAddress localAddress) {\n        return tail.connect(remoteAddress, localAddress);\n    }\n\n    @Override\n    public final ChannelFuture disconnect(){\n        return tail.disconnect();\n    }\n\n    @Override\n    public final ChannelFuture close() {\n        return tail.close();\n    }\n\n    @Override\n    public final ChannelFuture deregister() {\n        return tail.deregister();\n    }\n\n    @Override\n    public final ChannelPipeline flush() {\n        tail.flush();\n        return this;\n    }\n\n    @Override\n    public final ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise) {\n        return tail.bind(localAddress, promise);\n    }\n\n    @Override\n    public final ChannelFuture connect(SocketAddress remoteAddress, ChannelPromise promise) {\n        return tail.connect(remoteAddress, promise);\n    }\n\n    @Override\n    public final ChannelFuture connect(SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise) {\n        return tail.connect(remoteAddress, localAddress, promise);\n    }\n\n    @Override\n    public final ChannelFuture disconnect(ChannelPromise promise) {\n        return tail.disconnect(promise);\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e9b\u51fa\u7ad9\u65b9\u6cd5\u90fd\u662f\u8c03\u7528\u7684tail\u7684\u65b9\u6cd5\uff0c\u901a\u8fc7\u5b83\u6765\u89e6\u53d1\u5176\u4ed6outbound handler\u7684\u65b9\u6cd5\u3002</p> <p>\u51fa\u7ad9\u662f <code>tail</code> \u5f00\u59cb\uff0c\u5165\u7ad9\u4ece <code>head</code> \u5f00\u59cb\u3002</p> <p>\u603b\u7ed3\u6765\u8bf4\uff1a</p> <p>\u5165\u7ad9\u4e8b\u4ef6\uff0c\u4f1a\u501f\u52a9channelHandlerContext\u7684\u9759\u6001\u65b9\u6cd5\uff0c\u4f20\u5165head\uff0c\u9759\u6001\u65b9\u6cd5\u91cc\u4f1a\u8c03\u7528context\u7684invoker\u65b9\u6cd5\uff0cinvoker\u4f1a\u8c03\u7528handler\u7684\u771f\u6b63\u65b9\u6cd5\uff0c\u4e4b\u540e\u4f1a\u8c03\u7528context\u7684fireXXX\u7ee7\u7eed\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2ahandler\uff0c\u76f4\u5230\u7ed3\u675f\u3002</p> <p></p>"},{"location":"java/NIO/#netty_8","title":"netty\u7684\u5fc3\u8df3\u68c0\u6d4b","text":"<p>netty\u63d0\u4f9b\u4e86\u4e0b\u9762\u4e09\u79cdhandler\u6765\u68c0\u6d4bchannel\u8fde\u63a5\u7684\u6709\u6548\u6027</p> <ul> <li>IdleStateHandler \uff1a\u5f53Channel\u6709\u4e00\u6bb5\u65f6\u95f4\u6ca1\u6709\u6267\u884c\u8bfb\u6216\u8005\u5199\u64cd\u4f5c\u65f6\u89e6\u53d1IdleStateEvent \uff0c\u5305\u62ecIdleState#READER_IDLE\uff0cIdleState#WRITER_IDLE\uff0cIdleState#ALL_IDLE\u3002\u4f60\u53ef\u4ee5\u5728\u81ea\u5df1\u7684handler\u4e2duserEventTriggered\u5904\u7406\u8fd9\u4e09\u79cd\u4e8b\u4ef6\u3002</li> </ul> <pre><code>// \u7528\u6cd5\u4ecb\u7ecd\npublic class MyChannelInitializer extends {@link ChannelInitializer}&amp;lt;{@link Channel}&amp;gt; {\n      {@code @Override}\n      public void initChannel({@link Channel} channel) {\n          channel.pipeline().addLast(\"idleStateHandler\", new {@link IdleStateHandler}(60, 30, 0));\n          channel.pipeline().addLast(\"myHandler\", new MyHandler());\n      }\n  }\n\n// Handler should handle the {@link IdleStateEvent} triggered by {@link IdleStateHandler}.\npublic class MyHandler extends {@link ChannelDuplexHandler} {\n    {@code @Override}\n    public void userEventTriggered({@link ChannelHandlerContext} ctx, {@link Object} evt) throws {@link Exception} {\n        if (evt instanceof {@link IdleStateEvent}) {\n            {@link IdleStateEvent} e = ({@link IdleStateEvent}) evt;\n            if (e.state() == {@link IdleState}.READER_IDLE) {\n                ctx.close();\n            } else if (e.state() == {@link IdleState}.WRITER_IDLE) {\n                ctx.writeAndFlush(new PingMessage());\n            }\n        }\n    }\n}\n</code></pre> <ul> <li> <p>ReadTimeoutHandler\uff1a\u5728\u4e00\u5b9a\u65f6\u95f4\u6ca1\u6709\u5199\u64cd\u4f5c\u65f6\u4f1a\u89e6\u53d1WriteTimeoutException</p> </li> <li> <p>WriteTimeoutHandler\uff1a\u5728\u4e00\u5b9a\u65f6\u95f4\u5185channe\u6ca1\u6709\u8bfb\u64cd\u4f5c\u65f6\u4f1a\u89e6\u53d1ReadTimeoutException\uff0c\u8fd9\u4e24\u4e2a\u90fd\u4f1a\u81ea\u52a8\u5173\u95ed\u8fde\u63a5\uff0c\u800c\u4e14\u662f\u629b\u51fa\u5f02\u5e38\u3002</p> </li> </ul> <p>\u4e0b\u9762\u5177\u4f53\u5206\u6790IdleStateHandler\u3002</p> <pre><code>// \u662f\u5426\u8003\u8651\u51fa\u7ad9\u8f83\u6162\u7684\u60c5\u51b5,\u9ed8\u8ba4false\nprivate final boolean observeOutput;\n// \u8bfb\u4e8b\u4ef6\u7684\u7a7a\u95f2\u65f6\u95f4\uff0c0-\u8868\u793a\u7981\u7528\nprivate final long readerIdleTimeNanos;\n// \u5199\u4e8b\u4ef6\u7684\u7a7a\u95f2\u65f6\u95f4\uff0c0-\u8868\u793a\u7981\u7528\nprivate final long writerIdleTimeNanos;\n// \u8bfb\u6216\u8005\u5199\u4e8b\u4ef6\u7684\u7a7a\u95f2\u65f6\u95f4\uff0c0-\u8868\u793a\u7981\u7528\nprivate final long allIdleTimeNanos;\n</code></pre> <p>handler\u521d\u6b21\u6dfb\u52a0\u5230pipeline\u65f6\uff0c\u4f1a\u8fdb\u884c\u521d\u59cb\u5316</p> <pre><code>private void initialize(ChannelHandlerContext ctx) {\n    state = 1;\n    initOutputChanged(ctx);\n\n    lastReadTime = lastWriteTime = ticksInNanos();\n    // \u4e3a\u4e09\u79cd\u4e8b\u4ef6\u5206\u522b\u90fd\u521b\u5efa\u5b9a\u65f6\u4efb\u52a1\n    if (readerIdleTimeNanos &gt; 0) {\n        // \u521b\u5efa\u5b9a\u65f6\u4efb\u52a1\uff0c\u8fd9\u91cc\u4f1a\u8c03\u7528eventLoop \u7684 schedule \u65b9\u6cd5\uff0c\u5c06\u5b9a\u65f6\u4efb\u52a1\u6dfb\u52a0\u5230\u961f\u5217\u4e2d\n        readerIdleTimeout = schedule(ctx, new ReaderIdleTimeoutTask(ctx),\n                                     readerIdleTimeNanos, TimeUnit.NANOSECONDS);\n    }\n    if (writerIdleTimeNanos &gt; 0) {\n        writerIdleTimeout = schedule(ctx, new WriterIdleTimeoutTask(ctx),\n                                     writerIdleTimeNanos, TimeUnit.NANOSECONDS);\n    }\n    if (allIdleTimeNanos &gt; 0) {\n        allIdleTimeout = schedule(ctx, new AllIdleTimeoutTask(ctx),\n                                  allIdleTimeNanos, TimeUnit.NANOSECONDS);\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u7684\u4e09\u4e2atask\u6709\u5171\u540c\u7684\u7236\u7c7bAbstractIdleTask\uff0c\u6a21\u677f\u65b9\u6cd5\u5f53\u901a\u9053\u5173\u95ed\u65f6\u5c31\u4e0d\u518d\u6267\u884c\u4efb\u52a1\u3002\u4e0b\u9762\u4ee5ReaderIdleTimeoutTask\u4e3a\u4f8b\u770b\u4e0b\u5177\u4f53\u600e\u4e48\u68c0\u6d4b\u7684</p> <pre><code>private final class ReaderIdleTimeoutTask extends AbstractIdleTask {\n\n    ReaderIdleTimeoutTask(ChannelHandlerContext ctx) {\n        super(ctx);\n    }\n\n    @Override\n    protected void run(ChannelHandlerContext ctx) {\n        long nextDelay = readerIdleTimeNanos;\n        if (!reading) {\n            // \u5f53\u524d\u65f6\u95f4 - \u4e0a\u6b21\u8bfb\u53d6\u65f6\u95f4\n            nextDelay -= ticksInNanos() - lastReadTime;\n        }\n\n        // \u5982\u679c\u5c0f\u4e8e0\u5c31\u89e6\u53d1\u4e8b\u4ef6\n        if (nextDelay &lt;= 0) {\n            // Reader is idle - set a new timeout and notify the callback.\n            // \u91cd\u65b0\u6ce8\u518c\u4efb\u52a1\n            readerIdleTimeout = schedule(ctx, this, readerIdleTimeNanos, TimeUnit.NANOSECONDS);\n\n            boolean first = firstReaderIdleEvent;\n            firstReaderIdleEvent = false;\n\n            try {\n                // \u521b\u5efa\u4e00\u4e2aIdleStateEvent\uff0c\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2ahandler\n                IdleStateEvent event = newIdleStateEvent(IdleState.READER_IDLE, first);\n                channelIdle(ctx, event);\n            } catch (Throwable t) {\n                ctx.fireExceptionCaught(t);\n            }\n        } else {\n            // \u7528\u5269\u4f59\u7684\u65f6\u95f4nextDelay\u518d\u6b21\u6ce8\u518c\u4e00\u4e2a\u4efb\u52a1\n            // Read occurred before the timeout - set a new timeout with shorter delay.\n            readerIdleTimeout = schedule(ctx, this, nextDelay, TimeUnit.NANOSECONDS);\n        }\n    }\n}\n</code></pre> <p>\u603b\u7ed3\uff1a</p> <p><code>IdleStateHandler</code> \u53ef\u4ee5\u5b9e\u73b0\u5fc3\u8df3\u529f\u80fd\uff0c\u5f53\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u6ca1\u6709\u4efb\u4f55\u8bfb\u5199\u4ea4\u4e92\u65f6\uff0c\u5e76\u8d85\u8fc7\u4e86\u7ed9\u5b9a\u7684\u65f6\u95f4\uff0c\u5219\u4f1a\u89e6\u53d1\u7528\u6237 <code>handler</code> \u7684 <code>userEventTriggered</code> \u65b9\u6cd5\u3002\u7528\u6237\u53ef\u4ee5\u5728\u8fd9\u4e2a\u65b9\u6cd5\u4e2d\u5c1d\u8bd5\u5411\u5bf9\u65b9\u53d1\u9001\u4fe1\u606f\uff0c\u5982\u679c\u53d1\u9001\u5931\u8d25\uff0c\u5219\u5173\u95ed\u8fde\u63a5\u3002<code>IdleStateHandler</code> \u7684\u5b9e\u73b0\u57fa\u4e8e <code>EventLoop</code> \u7684\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u6b21\u8bfb\u5199\u90fd\u4f1a\u8bb0\u5f55\u4e00\u4e2a\u503c\uff0c\u5728\u5b9a\u65f6\u4efb\u52a1\u8fd0\u884c\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u8ba1\u7b97\u5f53\u524d\u65f6\u95f4\u548c\u8bbe\u7f6e\u65f6\u95f4\u548c\u4e0a\u6b21\u4e8b\u4ef6\u53d1\u751f\u65f6\u95f4\u7684\u7ed3\u679c\uff0c\u6765\u5224\u65ad\u662f\u5426\u7a7a\u95f2\u3002</p>"},{"location":"java/NIO/#eventloop","title":"EventLoop\u7684\u5206\u6790","text":"<p>NioEventLoop\u662f\u4e00\u4e2a\u5355\u7ebf\u7a0b\u7684\u7ebf\u7a0b\u6c60\uff0c\u53ef\u4ee5\u63a5\u53d7\u591a\u4e2achannel\u7684\u6ce8\u518c\uff0c\u5904\u7406\u8be5channel\u7684\u6240\u6709IO\u64cd\u4f5c\uff0c\u91cc\u9762\u7684\u6b7b\u5faa\u73af\uff0c\u4e0d\u65ad\u505a\u4e09\u4ef6\u4e8b\uff0c\u76d1\u542c\u7aef\u53e3\uff0c\u5904\u7406\u7aef\u53e3\u4e8b\u4ef6\uff0c\u5904\u7406\u961f\u5217\u4e8b\u4ef6\u3002</p> <p>NioEventLoop\u53ef\u4ee5\u5904\u7406\u4efb\u52a1\uff0c\u4e5f\u53ef\u4ee5\u5904\u7406\u5b9a\u65f6\u4efb\u52a1\u3002</p> <p></p> <p>NioEventLoop\u7684\u6e90\u7801\u8f83\u957f\uff0c\u7b80\u5355\u6765\u8bf4\uff0c\u5b83\u7684run\u65b9\u6cd5\u5c31\u662f\uff1a<code>elect</code> \u83b7\u53d6\u611f\u5174\u8da3\u7684\u4e8b\u4ef6\u3002 <code>processSelectedKeys</code> \u5904\u7406\u4e8b\u4ef6\u3002 <code>runAllTasks</code> \u6267\u884c\u961f\u5217\u4e2d\u7684\u4efb\u52a1\u3002</p> <p>\u603b\u7ed3\uff1a</p> <p>\u6bcf\u6b21\u6267\u884c <code>execute</code> \u65b9\u6cd5\u90fd\u662f\u5411\u961f\u5217\u4e2d\u6dfb\u52a0\u4efb\u52a1\u3002\u5f53\u7b2c\u4e00\u6b21\u6dfb\u52a0\u65f6\u5c31\u542f\u52a8\u7ebf\u7a0b\uff0c\u6267\u884c <code>run</code> \u65b9\u6cd5\uff0c\u800c <code>run</code> \u65b9\u6cd5\u662f\u6574\u4e2a <code>EventLoop</code> \u7684\u6838\u5fc3\uff0c\u5c31\u50cf <code>EventLoop</code> \u7684\u540d\u5b57\u4e00\u6837\uff0c<code>LoopLoop</code>\uff0c\u4e0d\u505c\u7684 <code>Loop</code>\uff0c<code>Loop</code> \u505a\u4ec0\u4e48\u5462\uff1f\u505a <code>3</code> \u4ef6\u4e8b\u60c5\uff1a</p> <ul> <li> <p>\u8c03\u7528 <code>selector</code> \u7684 <code>select</code> \u65b9\u6cd5\uff0c\u9ed8\u8ba4\u963b\u585e\u4e00\u79d2\u949f\uff0c\u5982\u679c\u6709\u5b9a\u65f6\u4efb\u52a1\uff0c\u5219\u5728\u5b9a\u65f6\u4efb\u52a1\u5269\u4f59\u65f6\u95f4\u7684\u57fa\u7840\u4e0a\u5728\u52a0\u4e0a <code>0.5</code> \u79d2\u8fdb\u884c\u963b\u585e\u3002\u5f53\u6267\u884c <code>execute</code> \u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u4e5f\u5c31\u662f\u6dfb\u52a0\u4efb\u52a1\u7684\u65f6\u5019\uff0c\u5524\u9192 <code>selecor</code>\uff0c\u9632\u6b62 <code>selector</code> \u963b\u585e\u65f6\u95f4\u8fc7\u957f\u3002</p> </li> <li> <p>\u5f53 <code>selector</code> \u8fd4\u56de\u7684\u65f6\u5019\uff0c\u56de\u8c03\u7528 <code>processSelectedKeys</code> \u65b9\u6cd5\u5bf9 <code>selectKey</code> \u8fdb\u884c\u5904\u7406\u3002</p> </li> <li> <p>\u5f53 <code>processSelectedKeys</code> \u65b9\u6cd5\u6267\u884c\u7ed3\u675f\u540e\uff0c\u5219\u6309\u7167 <code>ioRatio</code> \u7684\u6bd4\u4f8b\u6267\u884c <code>runAllTasks</code> \u65b9\u6cd5\uff0c\u9ed8\u8ba4\u662f <code>IO</code> \u4efb\u52a1\u65f6\u95f4\u548c\u975e <code>IO</code> \u4efb\u52a1\u65f6\u95f4\u662f\u76f8\u540c\u7684\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u4f60\u7684\u5e94\u7528\u7279\u70b9\u8fdb\u884c\u8c03\u4f18\u3002\u6bd4\u5982\u975e <code>IO</code> \u4efb\u52a1\u6bd4\u8f83\u591a\uff0c\u90a3\u4e48\u4f60\u5c31\u5c06<code>ioRatio</code> \u8c03\u5c0f\u4e00\u70b9\uff0c\u8fd9\u6837\u975e <code>IO</code> \u4efb\u52a1\u5c31\u80fd\u6267\u884c\u7684\u957f\u4e00\u70b9,\u9632\u6b62\u961f\u5217\u79ef\u6512\u8fc7\u591a\u7684\u4efb\u52a1\u3002</p> </li> </ul>"},{"location":"java/NIO/#_2","title":"\u5982\u4f55\u6267\u884c\u5f02\u6b65\u4efb\u52a1","text":"<p>\u5728netty\u4e2d\u505a\u8017\u65f6\u7684\uff0c\u4e0d\u53ef\u9884\u6599\u7684\u64cd\u4f5c\uff0c\u4f1a\u5f71\u54cdnetty\u5bf9socket\u7684\u8bfb\u53d6\u901f\u5ea6\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u8017\u65f6\u7684\u4efb\u52a1\u6dfb\u52a0\u5230\u5f02\u6b65\u7ebf\u7a0b\u6c60\u4e2d\uff0c\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u8017\u65f6handler \u91cc\u6dfb\u52a0\u4e1a\u52a1\u7ebf\u7a0b\u6c60</li> </ul> <pre><code>static final EventExecutorGroup businessGroup = new DefaultEventExecutorGroup(16);\n\n@Override\npublic void channelRead(ChannelHandlerContext ctx, Object msg) throws UnsupportedEncodingException, InterruptedException {\n    // \u521a\u8fdb\u6765\u65f6\uff0c\u5f53\u524d\u7ebf\u7a0b\u65f6workerGroup\u7684\u67d0\u4e2a\u5b50\u7ebf\u7a0b\n    final Object msgCop = msg;\n    final ChannelHandlerContext cxtCop = ctx;\n    // \u4ea4\u7ed9\u4e1a\u52a1\u7ebf\u7a0b\u6c60\n    group.submit(new Callable&lt;Object&gt;() {\n        @Override\n        public Object call() throws Exception {\n            ByteBuf buf = (ByteBuf)msgCop;\n            byte[] req = new byte[buf.readableBytes()];\n            buf.readBytes(req);\n            String body = new String(req, \"UTF-8\");\n            Thread.sleep(10 * 1000);\n            System.err.println(body + \" \" + Thread.currentThread().getName());\n            String reqString = \"Helloiamserver~~~\";\n            ByteBuf resp = Unpooled.copiedBuffer(reqString.getBytes());\n            // \u5f53\u8fd9\u91cc\u8c03\u7528ctx.writeAndFlush\u65f6\uff0c\u53c8\u5c06\u4efb\u52a1\u4ea4\u7ed9IO\u7ebf\u7a0b\n            cxtCop.writeAndFlush(resp);\n            return null;\n        }\n    });\n}\n</code></pre> <ul> <li>\u5728ChannelHandlerContext\u4e2d\u6dfb\u52a0\u7ebf\u7a0b\u6c60 </li> </ul> <pre><code>static EventExecutorGroup executors = new DefaultEventLoopGroup(2);\n\npublic static void main(String[] args) throws Exception {\n    // Configure the server.\n    EventLoopGroup bossGroup = new NioEventLoopGroup(1);\n    EventLoopGroup workerGroup = new NioEventLoopGroup();\n    final EchoServerHandler serverHandler = new EchoServerHandler();\n    try {\n        ServerBootstrap b = new ServerBootstrap();\n        b.group(bossGroup, workerGroup)\n            .channel(NioServerSocketChannel.class)\n            .option(ChannelOption.SO_BACKLOG, 100)\n            .handler(new LoggingHandler(LogLevel.INFO))\n            .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {\n                @Override\n                public void initChannel(SocketChannel ch) throws Exception {\n                    ChannelPipeline p = ch.pipeline();\n                    if (sslCtx != null) {\n                        p.addLast(sslCtx.newHandler(ch.alloc()));\n                    }\n                    // \u8fd9\u91cc\u8868\u793aserverHandler\u5148\u4ea4\u7ed9\u81ea\u5b9a\u4e49\u7684executors\u6267\u884c\uff0c\u800c\u4e0d\u662fworkerGroup\n                    p.addLast(executors, serverHandler);\n                }\n            });\n\n        // Start the server.\n        ChannelFuture f = b.bind(PORT).sync();\n\n        // Wait until the server socket is closed.\n        f.channel().closeFuture().sync();\n    } finally {\n        // Shut down all event loops to terminate all threads.\n        bossGroup.shutdownGracefully();\n        workerGroup.shutdownGracefully();\n    }\n}\n</code></pre> <p>\u7b2c\u4e00\u79cd\u65b9\u5f0f\u6bd4\u8f83\u81ea\u7531\u7075\u6d3b  \uff0c\u53ef\u4ee5\u6309\u9700\u5c06\u8017\u65f6\u957f\u7684\u4efb\u52a1\u653e\u5165\u5f02\u6b65\u7ebf\u7a0b\u6c60\u3002\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u5c06\u5bf9\u5e94handler\u7684\u6240\u6709\u4efb\u52a1\u90fd\u4ea4\u7ed9\u5f02\u6b65\u7ebf\u7a0b\u6c60\u3002</p>"},{"location":"java/java8/","title":"\u51fd\u6570\u5f0f\u7f16\u7a0b-\u884c\u4e3a\u53c2\u6570\u5316","text":"<p>Java8\u65b0\u589e\u4e86\u5c06\u65b9\u6cd5\u548c\u51fd\u6570\uff0c\u5373\u4ee3\u7801\u4f20\u9012\u7ed9\u5176\u4ed6\u65b9\u6cd5\u7684\u80fd\u529b\u3002\u4eceJava8\u5f00\u59cb\uff0c\u65b9\u6cd5\u548c\u51fd\u6570\u4e5f\u662f\u4e00\u7b49\u516c\u6c11\u4e86\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u3002Lambda\u533f\u540d\u51fd\u6570\uff0c\u540c\u6837\u4f53\u73b0\u4e86\u66f4\u5e7f\u4e49\u7684\u5c06\u51fd\u6570\u4f5c\u4e3a\u503c\u7684\u601d\u60f3\uff0c(int x)-&gt; x+1\uff0c\u8868\u793a\u201c\u8c03\u7528\u65f6\u7ed9\u5b9a\u53c2\u6570x\uff0c\u5c31\u8fd4\u56dex+1\u503c\u7684\u51fd\u6570\u201d\u3002</p> <pre><code>        filter(inventory, (Apple a)-&gt; a.getWeight() &gt; 150 );\n</code></pre> <p>Java 8\u4e2d\u52a0\u5165\u9ed8\u8ba4\u65b9\u6cd5\u4e3b\u8981\u662f\u4e3a\u4e86\u652f\u6301\u5e93\u8bbe\u8ba1\u5e08\uff0c\u8ba9\u4ed6\u4eec\u80fd\u591f\u5199\u51fa\u66f4\u5bb9\u6613\u6539\u8fdb\u7684\u63a5\u53e3\u3002</p> <p>\u884c\u4e3a\u53c2\u6570\u5316\u5c31\u662f\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5904\u7406\u9891\u7e41\u53d8\u66f4\u7684\u9700\u6c42\u7684\u4e00\u79cd\u8f6f\u4ef6\u5f00\u53d1\u6a21\u5f0f\u3002\u4e00\u8a00\u4ee5\u853d\u4e4b\uff0c\u5b83\u610f\u5473\u7740\u62ff\u51fa\u4e00\u4e2a\u4ee3\u7801\u5757\uff0c\u628a\u5b83\u51c6\u5907\u597d\u5374\u4e0d\u53bb\u6267\u884c\u5b83\u3002\u8fd9\u4e2a\u4ee3\u7801\u5757\u4ee5\u540e\u53ef\u4ee5\u88ab\u4f60\u7a0b\u5e8f\u7684\u5176\u4ed6\u90e8\u5206\u8c03\u7528\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u63a8\u8fdf\u8fd9\u5757\u4ee3\u7801\u7684\u6267\u884c\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u5c06\u4ee3\u7801\u5757\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u53e6\u4e00\u4e2a\u65b9\u6cd5\uff0c\u7a0d\u540e\u518d\u53bb\u6267\u884c\u5b83\u3002\u8fd9\u6837\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u884c\u4e3a\u5c31\u57fa\u4e8e\u90a3\u5757\u4ee3\u7801\u88ab\u53c2\u6570\u5316\u4e86\u3002</p> <p>\u5c06\u65b9\u6cd5\u53c2\u6570\u5316\u5f88\u5570\u55e6\uff0c\u53ef\u4ee5\u5229\u7528\u533f\u540d\u65b9\u6cd5\uff0c\u4f46\u8fd8\u662f\u5f88\u9ebb\u70e6\u3002\u6240\u4ee5\u5f15\u5165lambda\u8868\u8fbe\u5f0f\uff01</p> <pre><code>          Thread t=new Thread(new Runnable() {\n              public void run(){\n                  System.out.println(\"Hello world\");\n              }\n          });\n</code></pre> <p>\u200b        \u5982\u679c\u7528lambda\u8868\u8fbe\u5f0f</p> <pre><code>          Thread t=new Thread(()-&gt; System.out.println(\"Hello world\"));\n</code></pre> <p>\u884c\u4e3a\u53c2\u6570\u5316\uff0c\u5c31\u662f\u4e00\u4e2a\u65b9\u6cd5\u63a5\u53d7\u591a\u4e2a\u4e0d\u540c\u7684\u884c\u4e3a\u4f5c\u4e3a\u53c2\u6570\uff0c\u5e76\u5728\u5185\u90e8\u4f7f\u7528\u5b83\u4eec\uff0c\u5b8c\u6210\u4e0d\u540c\u884c\u4e3a\u7684\u80fd\u529b\u3002\u884c\u4e3a\u53c2\u6570\u5316\u53ef\u8ba9\u4ee3\u7801\u66f4\u597d\u5730\u9002\u5e94\u4e0d\u65ad\u53d8\u5316\u7684\u8981\u6c42\uff0c\u51cf\u8f7b\u672a\u6765\u7684\u5de5\u4f5c\u91cf\u3002 \u4f20\u9012\u4ee3\u7801\uff0c\u5c31\u662f\u5c06\u65b0\u884c\u4e3a\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u65b9\u6cd5\u3002\u4f46\u5728Java 8\u4e4b\u524d\u8fd9\u5b9e\u73b0\u8d77\u6765\u5f88\u5570\u55e6\u3002\u4e3a\u63a5\u53e3\u58f0\u660e\u8bb8\u591a\u53ea\u7528\u4e00\u6b21\u7684\u5b9e\u4f53\u7c7b\u800c\u9020\u6210\u7684\u5570\u55e6\u4ee3\u7801\uff0c\u5728Java 8\u4e4b\u524d\u53ef\u4ee5\u7528\u533f\u540d\u7c7b\u6765\u51cf\u5c11\u3002</p>"},{"location":"java/java8/#lamdba","title":"lamdba\u8868\u8fbe\u5f0f","text":"<p>\u53ef\u4ee5\u628aLambda\u8868\u8fbe\u5f0f\u7406\u89e3\u4e3a\u7b80\u6d01\u5730\u8868\u793a\u53ef\u4f20\u9012\u7684\u533f\u540d\u51fd\u6570\u7684\u4e00\u79cd\u65b9\u5f0f\uff1a\u5b83\u6ca1\u6709\u540d\u79f0\uff0c\u4f46\u5b83\u6709\u53c2\u6570\u5217\u8868\u3001\u51fd\u6570\u4e3b\u4f53\u3001\u8fd4\u56de\u7c7b\u578b\uff0c\u53ef\u80fd\u8fd8\u6709\u4e00\u4e2a\u53ef\u4ee5\u629b\u51fa\u7684\u5f02\u5e38\u5217\u8868\u3002\u6211\u4eec\u8bf4\u5b83\u662f\u51fd\u6570\uff0c\u662f\u56e0\u4e3aLambda\u51fd\u6570\u4e0d\u50cf\u65b9\u6cd5\u90a3\u6837\u5c5e\u4e8e\u67d0\u4e2a\u7279\u5b9a\u7684\u7c7b\u3002\u4f46\u548c\u65b9\u6cd5\u4e00\u6837\uff0cLambda\u6709\u53c2\u6570\u5217\u8868\u3001\u51fd\u6570\u4e3b\u4f53\u3001\u8fd4\u56de\u7c7b\u578b\uff0c\u8fd8\u53ef\u80fd\u6709\u53ef\u4ee5\u629b\u51fa\u7684\u5f02\u5e38\u5217\u8868\u3002\u2751 \u4f20\u9012\u2014\u2014Lambda\u8868\u8fbe\u5f0f\u53ef\u4ee5\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u65b9\u6cd5\u6216\u5b58\u50a8\u5728\u53d8\u91cf\u4e2d\u3002</p> <p></p> <p>lambda\u7684\u6709\u6548\u8868\u8fbe\u5f0f\u662f  <code>(parameters)-&gt; expression</code>\u6216\u8005  <code>(parameters)-&gt; { statements; }</code></p> <p></p> <p>\u5728\u54ea\u4e9b\u5730\u65b9\u53ef\u4ee5\u4f7f\u7528lambda\u8868\u8fbe\u5f0f\u5462\uff1f\u4f60\u53ea\u53ef\u4ee5\u5728\u51fd\u6570\u5f0f\u63a5\u53e3\u4e0a\u4f7f\u7528lambda\u8868\u8fbe\u5f0f\uff01</p>"},{"location":"java/java8/#_1","title":"\u51fd\u6570\u5f0f\u63a5\u53e3","text":"<p>\u51fd\u6570\u5f0f\u63a5\u53e3\u5c31\u662f\u53ea\u5b9a\u4e49\u4e00\u4e2a\u62bd\u8c61\u65b9\u6cd5\u7684\u63a5\u53e3\uff0c\u6bd4\u5982Predicate\uff0cCallable\uff0cComparator\u548cRunnable\u3002</p> <p>Lambda\u8868\u8fbe\u5f0f\u5141\u8bb8\u4f60\u76f4\u63a5\u4ee5\u5185\u8054\u7684\u5f62\u5f0f\u4e3a\u51fd\u6570\u5f0f\u63a5\u53e3\u7684\u62bd\u8c61\u65b9\u6cd5\u63d0\u4f9b\u5b9e\u73b0\uff0c\u5e76\u628a\u6574\u4e2a\u8868\u8fbe\u5f0f\u4f5c\u4e3a\u51fd\u6570\u5f0f\u63a5\u53e3\u7684\u5b9e\u4f8b\uff08\u5177\u4f53\u8bf4\u6765\uff0c\u662f\u51fd\u6570\u5f0f\u63a5\u53e3\u4e00\u4e2a\u5177\u4f53\u5b9e\u73b0\u7684\u5b9e\u4f8b\uff09\u3002\u4f60\u7528\u533f\u540d\u5185\u90e8\u7c7b\u4e5f\u53ef\u4ee5\u5b8c\u6210\u540c\u6837\u7684\u4e8b\u60c5\uff0c\u53ea\u4e0d\u8fc7\u6bd4\u8f83\u7b28\u62d9\uff1a\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u5b9e\u73b0\uff0c\u7136\u540e\u518d\u76f4\u63a5\u5185\u8054\u5c06\u5b83\u5b9e\u4f8b\u5316\u3002</p> <p>@FunctionalInterface\u8868\u793a\u8be5\u63a5\u53e3\u4f1a\u8bbe\u8ba1\u6210\u4e00\u4e2a\u51fd\u6570\u5f0f\u63a5\u53e3\u3002Java8\u4e2d\u5e38\u7528\u7684\u51fd\u6570\u5f0f\u63a5\u53e3\uff1a</p> <p></p> <p>\u51fd\u6570\u5f0f\u63a5\u53e3\u7684\u62bd\u8c61\u65b9\u6cd5\u7684\u7b7e\u540d\u53ef\u4ee5\u63cf\u8ff0Lambda\u8868\u8fbe\u5f0f\u7684\u7b7e\u540d\u3002\u51fd\u6570\u5f0f\u63a5\u53e3\u7684\u62bd\u8c61\u65b9\u6cd5\u7684\u7b7e\u540d\u79f0\u4e3a\u51fd\u6570\u63cf\u8ff0\u7b26\u3002</p> <p>\u6709\u65f6\u5019\u663e\u5f0f\u5199\u51fa\u7c7b\u578b\u66f4\u6613\u8bfb\uff0c\u6709\u65f6\u5019\u53bb\u6389\u5b83\u4eec\u66f4\u6613\u8bfb\u3002\u6ca1\u6709\u4ec0\u4e48\u6cd5\u5219\u8bf4\u54ea\u79cd\u66f4\u597d\uff1b\u5bf9\u4e8e\u5982\u4f55\u8ba9\u4ee3\u7801\u66f4\u6613\u8bfb\uff0c\u7a0b\u5e8f\u5458\u5fc5\u987b\u505a\u51fa\u81ea\u5df1\u7684\u9009\u62e9\u3002</p> <p></p> <p>Lambda\u53ef\u4ee5\u6ca1\u6709\u9650\u5236\u5730\u6355\u83b7\uff08\u4e5f\u5c31\u662f\u5728\u5176\u4e3b\u4f53\u4e2d\u5f15\u7528\uff09\u5b9e\u4f8b\u53d8\u91cf\u548c\u9759\u6001\u53d8\u91cf\u3002\u4f46\u5c40\u90e8\u53d8\u91cf\u5fc5\u987b\u663e\u5f0f\u58f0\u660e\u4e3afinal\uff0c\u6216\u4e8b\u5b9e\u4e0a\u662ffinal\u3002\u6362\u53e5\u8bdd\u8bf4\uff0cLambda\u8868\u8fbe\u5f0f\u53ea\u80fd\u6355\u83b7\u6307\u6d3e\u7ed9\u5b83\u4eec\u7684\u5c40\u90e8\u53d8\u91cf\u4e00\u6b21\u3002\u4e3a\u4ec0\u4e48\u5c40\u90e8\u53d8\u91cf\u6709\u8fd9\u4e9b\u9650\u5236\uff1f\u7b2c\u4e00\uff0c\u5b9e\u4f8b\u53d8\u91cf\u548c\u5c40\u90e8\u53d8\u91cf\u80cc\u540e\u7684\u5b9e\u73b0\u6709\u4e00\u4e2a\u5173\u952e\u4e0d\u540c\u3002\u5b9e\u4f8b\u53d8\u91cf\u90fd\u5b58\u50a8\u5728\u5806\u4e2d\uff0c\u800c\u5c40\u90e8\u53d8\u91cf\u5219\u4fdd\u5b58\u5728\u6808\u4e0a\u3002\u5982\u679cLambda\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u5c40\u90e8\u53d8\u91cf\uff0c\u800c\u4e14Lambda\u662f\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u4f7f\u7528\u7684\uff0c\u5219\u4f7f\u7528Lambda\u7684\u7ebf\u7a0b\uff0c\u53ef\u80fd\u4f1a\u5728\u5206\u914d\u8be5\u53d8\u91cf\u7684\u7ebf\u7a0b\u5c06\u8fd9\u4e2a\u53d8\u91cf\u6536\u56de\u4e4b\u540e\uff0c\u53bb\u8bbf\u95ee\u8be5\u53d8\u91cf\u3002\u56e0\u6b64\uff0cJava\u5728\u8bbf\u95ee\u81ea\u7531\u5c40\u90e8\u53d8\u91cf\u65f6\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u8bbf\u95ee\u5b83\u7684\u526f\u672c\uff0c\u800c\u4e0d\u662f\u8bbf\u95ee\u539f\u59cb\u53d8\u91cf\u3002\u5982\u679c\u5c40\u90e8\u53d8\u91cf\u4ec5\u4ec5\u8d4b\u503c\u4e00\u6b21\u90a3\u5c31\u6ca1\u6709\u4ec0\u4e48\u533a\u522b\u4e86\u2014\u2014\u56e0\u6b64\u5c31\u6709\u4e86\u8fd9\u4e2a\u9650\u5236\u3002</p>"},{"location":"java/java8/#_2","title":"\u65b9\u6cd5\u5f15\u7528","text":"<p>\u5982\u679c\u4f60\u5e0c\u671b\u5c06\u4e00\u4e2a\u65e2\u6709\u7684\u65b9\u6cd5\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u53e6\u4e00\u4e2a\u65b9\u6cd5\uff0c\u90a3\u4e48\u65b9\u6cd5\u5f15\u7528\u65e0\u7591\u662f\u6211\u4eec\u63a8\u8350\u7684\u65b9\u6cd5\uff0c\u5229\u7528\u8fd9\u79cd\u65b9\u5f0f\u6211\u4eec\u80fd\u5199\u51fa\u975e\u5e38\u7b80\u6d01\u7684\u4ee3\u7801\u3002</p> <p>\u65b9\u6cd5\u5f15\u7528\u53ef\u4ee5\u88ab\u770b\u4f5c\u4ec5\u4ec5\u8c03\u7528\u7279\u5b9a\u65b9\u6cd5\u7684Lambda\u7684\u4e00\u79cd\u5feb\u6377\u5199\u6cd5\u3002\u5b83\u7684\u57fa\u672c\u601d\u60f3\u662f\uff0c\u5982\u679c\u4e00\u4e2aLambda\u4ee3\u8868\u7684\u53ea\u662f\u201c\u76f4\u63a5\u8c03\u7528\u8fd9\u4e2a\u65b9\u6cd5\u201d\uff0c\u90a3\u6700\u597d\u8fd8\u662f\u7528\u540d\u79f0\u6765\u8c03\u7528\u5b83\uff0c\u800c\u4e0d\u662f\u53bb\u63cf\u8ff0\u5982\u4f55\u8c03\u7528\u5b83\u3002</p> <p></p>"},{"location":"java/java8/#stream","title":"stream\u6d41","text":"<p>Java 8\u4e5f\u7528Stream API\uff08java.util.stream\uff09\u89e3\u51b3\u4e86\u8fd9\u4e24\u4e2a\u95ee\u9898\uff1a\u96c6\u5408\u5904\u7406\u65f6\u7684\u5957\u8def\u548c\u6666\u6da9\uff0c\u4ee5\u53ca\u96be\u4ee5\u5229\u7528\u591a\u6838\u3002stream\u4f7f\u7528\u58f0\u660e\u5f0f\u7684\u65b9\u5f0f\uff0c\u8fd9\u6837\u66f4\u7b80\u6d01\u66f4\u6613\u8bfb\uff0c\u800c\u4e14\u66f4\u7075\u6d3b\uff0c\u4e5f\u80fd\u5e76\u884c\u3002</p> <p>\u96c6\u5408\u8bb2\u7684\u662f\u6570\u636e\uff0c\u6d41\u8bb2\u7684\u662f\u8ba1\u7b97\uff01\u96c6\u5408\u662f\u5916\u90e8\u8fed\u4ee3\uff0c\u6d41\u662f\u5185\u90e8\u8fed\u4ee3\uff0c\u66ff\u4f60\u628a\u8fed\u4ee3\u505a\u4e86\u3002</p>"},{"location":"java/java8/#_3","title":"\u6d41\u652f\u6301\u7684\u64cd\u4f5c","text":"<p>\u53ef\u4ee5\u8fde\u63a5\u8d77\u6765\u7684\u6d41\u64cd\u4f5c\u79f0\u4e3a\u4e2d\u95f4\u64cd\u4f5c\uff0c\u5173\u95ed\u6d41\u7684\u64cd\u4f5c\u79f0\u4e3a\u7ec8\u7aef\u64cd\u4f5c\u3002filter\u3001map\u548climit\u53ef\u4ee5\u8fde\u6210\u4e00\u6761\u6d41\u6c34\u7ebf\uff0ccollect\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\u5e76\u5173\u95ed\u5b83\u3002</p> <p>\u6d41\u90fd\u5229\u7528\u4e86\u77ed\u8def\uff1a\u627e\u5230\u7ed3\u679c\u5c31\u7acb\u5373\u505c\u6b62\u8ba1\u7b97\uff1b\u6ca1\u6709\u5fc5\u8981\u5904\u7406\u6574\u4e2a\u6d41</p> <p>\u6d41\u652f\u6301\u7684\u7b5b\u9009\u64cd\u4f5c\uff1afilter\uff0cdistinct\uff0climit\uff0cskip\u3002</p> <p>\u6d41\u652f\u6301\u7684\u6620\u5c04\u64cd\u4f5c\uff1amap\uff0cflatmap\uff0c</p> <p>\u6d41\u652f\u6301\u7684\u67e5\u627e\u548c\u5339\u914d\uff1aallMatch\u3001anyMatch\u3001noneMatch\u3001findFirst\uff0cfindAny</p> <p>\u6d41\u652f\u6301\u7684\u5f52\u7ea6\u64cd\u4f5c\uff1areduce</p> <pre><code>int sum = numbers.stream().reduce(0, Integer::sum);\nOptional&lt;Integer&gt; max = numbers.stream().reduce(Integer::max);\n// \u96c6\u5408\u4e2d\u7684\u4e2a\u6570\nint count = menu.stream()\n    .map(d-&gt; 1)\n    .reduce(0, (a, b)-&gt; a+b);\n</code></pre> <p></p>"},{"location":"java/java8/#_4","title":"\u539f\u59cb\u7c7b\u578b\u7279\u5316","text":"<p>Java 8\u5f15\u5165\u4e86\u4e09\u4e2a\u539f\u59cb\u7c7b\u578b\u7279\u5316\u6d41\u63a5\u53e3\uff1aIntStream\u3001DoubleStream\u548cLongStream\uff0c\u5206\u522b\u5c06\u6d41\u4e2d\u7684\u5143\u7d20\u7279\u5316\u4e3aint\u3001long\u548cdouble\uff0c\u4ece\u800c\u907f\u514d\u4e86\u6697\u542b\u7684\u88c5\u7bb1\u6210\u672c\u3002\u6bcf\u4e2a\u63a5\u53e3\u90fd\u5e26\u6765\u4e86\u8fdb\u884c\u5e38\u7528\u6570\u503c\u5f52\u7ea6\u7684\u65b0\u65b9\u6cd5\uff0c\u6bd4\u5982\u5bf9\u6570\u503c\u6d41\u6c42\u548c\u7684sum\uff0c\u627e\u5230\u6700\u5927\u5143\u7d20\u7684max\u3002\u6b64\u5916\u8fd8\u6709\u5728\u5fc5\u8981\u65f6\u518d\u628a\u5b83\u4eec\u8f6c\u6362\u56de\u5bf9\u8c61\u6d41\u7684\u65b9\u6cd5\u3002\u8981\u8bb0\u4f4f\u7684\u662f\uff0c\u8fd9\u4e9b\u7279\u5316\u7684\u539f\u56e0\u5e76\u4e0d\u5728\u4e8e\u6d41\u7684\u590d\u6742\u6027\uff0c\u800c\u662f\u88c5\u7bb1\u9020\u6210\u7684\u590d\u6742\u6027\u2014\u2014\u5373\u7c7b\u4f3cint\u548cInteger\u4e4b\u95f4\u7684\u6548\u7387\u5dee\u5f02\u3002</p>"},{"location":"java/java8/#_5","title":"\u6784\u5efa\u6d41","text":"<ul> <li>\u7531\u503c\u521b\u5efa\u6d41</li> </ul> <pre><code>        Stream&lt;String&gt; stream=Stream.of(\"Java 8 \", \"Lambdas \", \"In \", \"Action\");\n        stream.map(String::toUpperCase).forEach(System.out::println);\n</code></pre> <ul> <li>\u7531\u6570\u7ec4\u521b\u5efa\u6d41</li> </ul> <p>Arrays.stream()</p> <ul> <li> <p>\u7531\u6587\u4ef6\u751f\u6210\u6d41</p> </li> <li> <p>\u7531\u51fd\u6570\u751f\u6210\u6d41</p> </li> </ul> <pre><code>Stream.iterate(0, n-&gt; n+2)\n    .limit(10)\n    .forEach(System.out::println);\n</code></pre> <p>iterate\u65b9\u6cd5\u63a5\u53d7\u4e00\u4e2a\u521d\u59cb\u503c\uff08\u5728\u8fd9\u91cc\u662f0\uff09\uff0c\u8fd8\u6709\u4e00\u4e2a\u4f9d\u6b21\u5e94\u7528\u5728\u6bcf\u4e2a\u4ea7\u751f\u7684\u65b0\u503c\u4e0a\u7684Lambda\uff08UnaryOperator\u7c7b\u578b\uff09\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u4f7f\u7528Lambda n-&gt; n+2\uff0c\u8fd4\u56de\u7684\u662f\u524d\u4e00\u4e2a\u5143\u7d20\u52a0\u4e0a2\u3002\u56e0\u6b64\uff0citerate\u65b9\u6cd5\u751f\u6210\u4e86\u4e00\u4e2a\u6240\u6709\u6b63\u5076\u6570\u7684\u6d41\uff1a\u6d41\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u662f\u521d\u59cb\u503c0\u3002\u7136\u540e\u52a0\u4e0a2\u6765\u751f\u6210\u65b0\u7684\u503c2\uff0c\u518d\u52a0\u4e0a2\u6765\u5f97\u5230\u65b0\u7684\u503c4\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002\u8fd9\u79cditerate\u64cd\u4f5c\u57fa\u672c\u4e0a\u662f\u987a\u5e8f\u7684\uff0c\u56e0\u4e3a\u7ed3\u679c\u53d6\u51b3\u4e8e\u524d\u4e00\u6b21\u5e94\u7528\u3002\u8bf7\u6ce8\u610f\uff0c\u6b64\u64cd\u4f5c\u5c06\u751f\u6210\u4e00\u4e2a\u65e0\u9650\u6d41\u2014\u2014\u8fd9\u4e2a\u6d41\u6ca1\u6709\u7ed3\u5c3e\uff0c\u56e0\u4e3a\u503c\u662f\u6309\u9700\u8ba1\u7b97\u7684\uff0c\u53ef\u4ee5\u6c38\u8fdc\u8ba1\u7b97\u4e0b\u53bb\u3002\u6211\u4eec\u8bf4\u8fd9\u4e2a\u6d41\u662f\u65e0\u754c\u7684 <pre><code>Stream.generate(Math::random)\n    .limit(5)\n    .forEach(System.out::println);\n</code></pre> <p>generate\u65b9\u6cd5\u4e5f\u53ef\u8ba9\u4f60\u6309\u9700\u751f\u6210\u4e00\u4e2a\u65e0\u9650\u6d41\u3002\u4f46generate\u4e0d\u662f\u4f9d\u6b21\u5bf9\u6bcf\u4e2a\u65b0\u751f\u6210\u7684\u503c\u5e94\u7528\u51fd\u6570\u7684\u3002\u5b83\u63a5\u53d7\u4e00\u4e2aSupplier\u7c7b\u578b\u7684Lambda\u63d0\u4f9b\u65b0\u7684\u503c\u3002"},{"location":"java/java8/#_6","title":"\u7528\u6d41\u6536\u96c6\u64cd\u4f5c","text":"<p>collect\u662f\u4e00\u4e2a\u5f52\u7ea6\u64cd\u4f5c\uff0c\u5c31\u50cfreduce\u4e00\u6837\u53ef\u4ee5\u63a5\u53d7\u5404\u79cd\u505a\u6cd5\u4f5c\u4e3a\u53c2\u6570\uff0c\u5c06\u6d41\u4e2d\u7684\u5143\u7d20\u7d2f\u79ef\u6210\u4e00\u4e2a\u6c47\u603b\u7ed3\u679c\u3002\u5177\u4f53\u7684\u505a\u6cd5\u662f\u901a\u8fc7\u5b9a\u4e49\u65b0\u7684Collector\u63a5\u53e3\u6765\u5b9a\u4e49\u7684\uff0c\u56e0\u6b64\u533a\u5206Collection\u3001Collector\u548ccollect\u662f\u5f88\u91cd\u8981\u7684\u3002</p> <p>\u6536\u96c6\u5668\u53ef\u4ee5\u9ad8\u6548\u5730\u590d\u5408\u8d77\u6765\uff0c\u8fdb\u884c\u591a\u7ea7\u5206\u7ec4\u3001\u5206\u533a\u548c\u5f52\u7ea6\u3002</p> <p>\u4f60\u53ef\u4ee5\u5b9e\u73b0Collector\u63a5\u53e3\u4e2d\u5b9a\u4e49\u7684\u65b9\u6cd5\u6765\u5f00\u53d1\u4f60\u81ea\u5df1\u7684\u6536\u96c6\u5668\u3002</p> <p>collect\u662f\u4e00\u4e2a\u7ec8\u7aef\u64cd\u4f5c\uff0c\u5b83\u63a5\u53d7\u7684\u53c2\u6570\u662f\u5c06\u6d41\u4e2d\u5143\u7d20\u7d2f\u79ef\u5230\u6c47\u603b\u7ed3\u679c\u7684\u5404\u79cd\u65b9\u5f0f\uff08\u79f0\u4e3a\u6536\u96c6\u5668\uff09\u3002Collectors\u7c7b\u63d0\u4f9b\u7684\u9884\u5b9a\u4e49\u7684\u6536\u96c6\u5668\u4e3b\u8981\u7531\u4e09\u5927\u529f\u80fd\uff0c1. \u5c06\u6d41\u5143\u7d20\u5f52\u7ea6\u548c\u6c47\u603b\u4e3a\u4e00\u4e2a\u503c\uff0c 2. \u5143\u7d20\u5206\u7ec4\uff0c 3.\u5143\u7d20\u5206\u533a</p>"},{"location":"java/java8/#_7","title":"\u5c06\u6d41\u5143\u7d20\u5f52\u7ea6\u548c\u6c47\u603b\u4e3a\u4e00\u4e2a\u503c","text":"<p>\u8ba1\u7b97\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\uff1a   </p> <pre><code>Comparator&lt;Dish&gt; dishCaloriesComparator=\n    Comparator.comparingInt(Dish::getCalories);\n\nOptional&lt;Dish&gt; mostCalorieDish=\n    menu.stream()\n    .collect(maxBy(dishCaloriesComparator));\n</code></pre> <p>\u6c47\u603b\uff1a</p> <pre><code>// \u6c42\u51fa\u6bcf\u4e2a\u83dc\u5355\u7684\u603b\u70ed\u91cf\nint totalCalories=menu.stream().collect(summingInt(Dish::getCalories));\n</code></pre> <p>Collectors.summingLong\u548cCollectors.summingDouble\u65b9\u6cd5\u7684\u4f5c\u7528\u5b8c\u5168\u4e00\u6837\uff0c\u53ef\u4ee5\u7528\u4e8e\u6c42\u548c\u5b57\u6bb5\u4e3along\u6216double\u7684\u60c5\u51b5\u3002\u4f46\u6c47\u603b\u4e0d\u4ec5\u4ec5\u662f\u6c42\u548c\uff1b\u8fd8\u6709Collectors.averagingInt\uff0c\u8fde\u540c\u5bf9\u5e94\u7684averagingLong\u548caveragingDouble\u53ef\u4ee5\u8ba1\u7b97\u6570\u503c\u7684\u5e73\u5747\u6570\u3002</p> <p>\u4f60\u5df2\u7ecf\u770b\u5230\u4e86\u5982\u4f55\u4f7f\u7528\u6536\u96c6\u5668\u6765\u7ed9\u6d41\u4e2d\u7684\u5143\u7d20\u8ba1\u6570\uff0c\u627e\u5230\u8fd9\u4e9b\u5143\u7d20\u6570\u503c\u5c5e\u6027\u7684\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\uff0c\u4ee5\u53ca\u8ba1\u7b97\u5176\u603b\u548c\u548c\u5e73\u5747\u503c\u3002\u4e0d\u8fc7\u5f88\u591a\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u60f3\u8981\u5f97\u5230\u4e24\u4e2a\u6216\u66f4\u591a\u8fd9\u6837\u7684\u7ed3\u679c\uff0c\u800c\u4e14\u4f60\u5e0c\u671b\u53ea\u9700\u4e00\u6b21\u64cd\u4f5c\u5c31\u53ef\u4ee5\u5b8c\u6210\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528summarizingInt\u5de5\u5382\u65b9\u6cd5\u8fd4\u56de\u7684\u6536\u96c6\u5668\u3002\u4f8b\u5982\uff0c\u901a\u8fc7\u4e00\u6b21summarizing\u64cd\u4f5c\u4f60\u53ef\u4ee5\u5c31\u6570\u51fa\u83dc\u5355\u4e2d\u5143\u7d20\u7684\u4e2a\u6570\uff0c\u5e76\u5f97\u5230\u83dc\u80b4\u70ed\u91cf\u603b\u548c\u3001\u5e73\u5747\u503c\u3001\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\uff1a</p> <pre><code>IntSummaryStatistics menuStatistics=\n                menu.stream().collect(summarizingInt(Dish::getCalories));\n// \u4f1a\u628a\u6240\u6709\u8fd9\u4e9b\u4fe1\u606f\u6536\u96c6\u5230\u4e00\u4e2a\u53eb\u4f5cIntSummaryStatistics\u7684\u7c7b\u91cc\uff0c\u5b83\u63d0\u4f9b\u4e86\u65b9\u4fbf\u7684\u53d6\u503c\uff08getter\uff09\u65b9\u6cd5\u6765\u8bbf\u95ee\u7ed3\u679c\nIntSummaryStatistics{count=9, sum=4300, min=120,\n                              average=477.777778, max=800}\n</code></pre> <p>\u8fde\u63a5\u5b57\u7b26\u4e32\uff1a</p> <p>joining\u5de5\u5382\u65b9\u6cd5\u8fd4\u56de\u7684\u6536\u96c6\u5668\u4f1a\u628a\u5bf9\u6d41\u4e2d\u6bcf\u4e00\u4e2a\u5bf9\u8c61\u5e94\u7528toString\u65b9\u6cd5\u5f97\u5230\u7684\u6240\u6709\u5b57\u7b26\u4e32\u8fde\u63a5\u6210\u4e00\u4e2a\u5b57\u7b26\u4e32\u3002</p> <pre><code>String shortMenu=menu.stream().collect(joining());\n// \u7528\u9017\u53f7\u8fde\u63a5\nString shortMenu=menu.stream().map(Dish::getName).collect(joining(\", \"));\n</code></pre> <p>\u66f4\u4e00\u822c\u5316\u7684\u5f52\u7ea6\u64cd\u4f5c\uff1a</p> <p>\u524d\u9762\u8ba8\u8bba\u7684\u6240\u6709\u6536\u96c6\u5668\uff0c\u90fd\u662f\u4e00\u4e2a\u53ef\u4ee5\u7528reducing\u5de5\u5382\u65b9\u6cd5\u5b9a\u4e49\u7684\u5f52\u7ea6\u8fc7\u7a0b\u7684\u7279\u6b8a\u60c5\u51b5\u800c\u5df2\u3002Collectors.reducing\u5de5\u5382\u65b9\u6cd5\u662f\u6240\u6709\u8fd9\u4e9b\u7279\u6b8a\u60c5\u51b5\u7684\u4e00\u822c\u5316\u3002</p> <pre><code>int totalCalories=menu.stream().collect(reducing(\n                                            0, Dish::getCalories, (i, j)-&gt; i+j));\n</code></pre> <ul> <li>\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u5f52\u7ea6\u64cd\u4f5c\u7684\u8d77\u59cb\u503c\uff0c\u4e5f\u662f\u6d41\u4e2d\u6ca1\u6709\u5143\u7d20\u65f6\u7684\u8fd4\u56de\u503c\uff0c\u6240\u4ee5\u5f88\u663e\u7136\u5bf9\u4e8e\u6570\u503c\u548c\u800c\u8a000\u662f\u4e00\u4e2a\u5408\u9002\u7684\u503c\u3002</li> <li> <p>\u7b2c\u4e8c\u4e2a\u53c2\u6570\u5c31\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u5c06\u83dc\u80b4\u8f6c\u6362\u6210\u4e00\u4e2a\u8868\u793a\u5176\u6240\u542b\u70ed\u91cf\u7684int\u3002</p> </li> <li> <p>\u7b2c\u4e09\u4e2a\u53c2\u6570\u662f\u4e00\u4e2aBinaryOperator\uff0c\u5c06\u4e24\u4e2a\u9879\u76ee\u7d2f\u79ef\u6210\u4e00\u4e2a\u540c\u7c7b\u578b\u7684\u503c\u3002\u8fd9\u91cc\u5b83\u5c31\u662f\u5bf9\u4e24\u4e2aint\u6c42\u548c\u3002</p> </li> </ul> <p>\u8fd8\u6709\u4e00\u4e2a\u5355\u53c2\u6570\u7684reducing\uff1a</p> <pre><code>String shortMenu=menu.stream().map(Dish::getName)\n                              .collect( reducing( (s1, s2)-&gt; s1+s2 ) ).get();\n</code></pre> <p>\u51fd\u6570\u5f0f\u7f16\u7a0b\uff08\u7279\u522b\u662fJava 8\u7684Collections\u6846\u67b6\u4e2d\u52a0\u5165\u7684\u57fa\u4e8e\u51fd\u6570\u5f0f\u98ce\u683c\u539f\u7406\u8bbe\u8ba1\u7684\u65b0API\uff09\u901a\u5e38\u63d0\u4f9b\u4e86\u591a\u79cd\u65b9\u6cd5\u6765\u6267\u884c\u540c\u4e00\u4e2a\u64cd\u4f5c\u3002\u8fd9\u4e2a\u4f8b\u5b50\u8fd8\u8bf4\u660e\uff0c\u6536\u96c6\u5668\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u6bd4Stream\u63a5\u53e3\u4e0a\u76f4\u63a5\u63d0\u4f9b\u7684\u65b9\u6cd5\u7528\u8d77\u6765\u66f4\u590d\u6742\uff0c\u4f46\u597d\u5904\u5728\u4e8e\u5b83\u4eec\u80fd\u63d0\u4f9b\u66f4\u9ad8\u6c34\u5e73\u7684\u62bd\u8c61\u548c\u6982\u62ec\uff0c\u4e5f\u66f4\u5bb9\u6613\u91cd\u7528\u548c\u81ea\u5b9a\u4e49\u3002\u6211\u4eec\u7684\u5efa\u8bae\u662f\uff0c\u5c3d\u53ef\u80fd\u4e3a\u624b\u5934\u7684\u95ee\u9898\u63a2\u7d22\u4e0d\u540c\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4f46\u5728\u901a\u7528\u7684\u65b9\u6848\u91cc\u9762\uff0c\u59cb\u7ec8\u9009\u62e9\u6700\u4e13\u95e8\u5316\u7684\u4e00\u4e2a\u3002\u65e0\u8bba\u662f\u4ece\u53ef\u8bfb\u6027\u8fd8\u662f\u6027\u80fd\u4e0a\u770b\uff0c\u8fd9\u4e00\u822c\u90fd\u662f\u6700\u597d\u7684\u51b3\u5b9a</p> <p>\u4f60\u53ef\u80fd\u60f3\u77e5\u9053\uff0cStream\u63a5\u53e3\u7684collect\u548creduce\u65b9\u6cd5\u6709\u4f55\u4e0d\u540c\uff1f\u56e0\u4e3a\u4e24\u79cd\u65b9\u6cd5\u901a\u5e38\u4f1a\u83b7\u5f97\u76f8\u540c\u7684\u7ed3\u679c\u3002</p> <p>\u4e00\u4e2a\u8bed\u4e49\u95ee\u9898\u548c\u4e00\u4e2a\u5b9e\u9645\u95ee\u9898\u3002\u8bed\u4e49\u95ee\u9898\u5728\u4e8e\uff0creduce\u65b9\u6cd5\u65e8\u5728\u628a\u4e24\u4e2a\u503c\u7ed3\u5408\u8d77\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u503c\uff0c\u5b83\u662f\u4e00\u4e2a\u4e0d\u53ef\u53d8\u7684\u5f52\u7ea6\u3002\u4e0e\u6b64\u76f8\u53cd\uff0ccollect\u65b9\u6cd5\u7684\u8bbe\u8ba1\u5c31\u662f\u8981\u6539\u53d8\u5bb9\u5668\uff0c\u4ece\u800c\u7d2f\u79ef\u8981\u8f93\u51fa\u7684\u7ed3\u679c\u3002\u4ee5\u9519\u8bef\u7684\u8bed\u4e49\u4f7f\u7528reduce\u65b9\u6cd5\u8fd8\u4f1a\u9020\u6210\u4e00\u4e2a\u5b9e\u9645\u95ee\u9898\uff1a\u8fd9\u4e2a\u5f52\u7ea6\u8fc7\u7a0b\u4e0d\u80fd\u5e76\u884c\u5de5\u4f5c\uff0c\u56e0\u4e3a\u7531\u591a\u4e2a\u7ebf\u7a0b\u5e76\u53d1\u4fee\u6539\u540c\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u53ef\u80fd\u4f1a\u7834\u574fList\u672c\u8eab\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4f60\u60f3\u8981\u7ebf\u7a0b\u5b89\u5168\uff0c\u5c31\u9700\u8981\u6bcf\u6b21\u5206\u914d\u4e00\u4e2a\u65b0\u7684List\uff0c\u800c\u5bf9\u8c61\u5206\u914d\u53c8\u4f1a\u5f71\u54cd\u6027\u80fd\u3002\u8fd9\u5c31\u662fcollect\u65b9\u6cd5\u7279\u522b\u9002\u5408\u8868\u8fbe\u53ef\u53d8\u5bb9\u5668\u4e0a\u7684\u5f52\u7ea6\u7684\u539f\u56e0\uff0c\u66f4\u5173\u952e\u7684\u662f\u5b83\u9002\u5408\u5e76\u884c\u64cd\u4f5c</p>"},{"location":"java/java8/#_8","title":"\u5206\u7ec4","text":"<pre><code> Map&lt;Dish.Type, List&lt;Dish&gt;&gt; dishesByType=\n                                menu.stream().collect(groupingBy(Dish::getType));\n// \u66f4\u590d\u6742\u7684\u81ea\u5b9a\u4e49\u5206\u7ec4\npublic enum CaloricLevel { DIET, NORMAL, FAT }\nMap&lt;CaloricLevel, List&lt;Dish&gt;&gt; dishesByCaloricLevel=menu.stream().collect(\n    groupingBy(dish-&gt; {\n        if (dish.getCalories() &lt;=400) return CaloricLevel.DIET;\n        else if (dish.getCalories() &lt;=700) return\n            CaloricLevel.NORMAL;\n        else return CaloricLevel.FAT;\n    } ));\n</code></pre> <p>\u591a\u7ea7\u5206\u7ec4\uff1a\u8fd8\u53ef\u4ee5\u63a5\u53d7collector\u7c7b\u578b\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u3002\u90a3\u4e48\u8981\u8fdb\u884c\u4e8c\u7ea7\u5206\u7ec4\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u4e00\u4e2a\u5185\u5c42groupingBy\u4f20\u9012\u7ed9\u5916\u5c42groupingBy\uff0c\u5e76\u5b9a\u4e49\u4e00\u4e2a\u4e3a\u6d41\u4e2d\u9879\u76ee\u5206\u7c7b\u7684\u4e8c\u7ea7\u6807\u51c6</p> <p></p> <p>\u8fdb\u4e00\u6b65\u8bf4\uff0c\u4f20\u9012\u7ed9\u7b2c\u4e00\u4e2agroupingBy\u7684\u7b2c\u4e8c\u4e2a\u6536\u96c6\u5668\u53ef\u4ee5\u662f\u4efb\u4f55\u7c7b\u578b\uff0c\u800c\u4e0d\u4e00\u5b9a\u662f\u53e6\u4e00\u4e2agroupingBy\u3002\u4f8b\u5982\uff0c\u8981\u6570\u4e00\u6570\u83dc\u5355\u4e2d\u6bcf\u7c7b\u83dc\u6709\u591a\u5c11\u4e2a\uff0c\u53ef\u4ee5\u4f20\u9012counting\u6536\u96c6\u5668\u4f5c\u4e3agroupingBy\u6536\u96c6\u5668\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\uff1a</p> <pre><code>Map&lt;Dish.Type, Long&gt; typesCount=menu.stream().collect(\n                      groupingBy(Dish::getType, counting()));\n// \u6309\u7167\u7c7b\u578b\uff0c\u6bcf\u79cd\u6700\u5927\u70ed\u91cf\u7684\u83dc\u80b4\n Map&lt;Dish.Type, Optional&lt;Dish&gt;&gt; mostCaloricByType=\n            menu.stream()\n                .collect(groupingBy(Dish::getType,\n                                      maxBy(comparingInt(Dish::getCalories))));\n\n  Map&lt;Dish.Type, Optional&lt;Dish&gt;&gt; mostCaloricByType=\n                menu.stream()\n                        .collect(groupingBy(Dish::getType,CollectingAndThen(\n                                maxBy(comparingInt(Dish::getCalories)), Optional::get)));\n</code></pre> <p>groupingBy\u548cmapping\u7ed3\u5408\u8d77\u6765\uff1a</p> <pre><code>Map&lt;Dish.Type, Set&lt;CaloricLevel&gt;&gt; caloricLevelsByType=\n    menu.stream().collect(\n    groupingBy(Dish::getType, mapping(\n        dish-&gt; { if (dish.getCalories() &lt;=400) return CaloricLevel.DIET;\n                else if (dish.getCalories() &lt;=700) return CaloricLevel.NORMAL;\n                else return CaloricLevel.FAT; },\n        toSet() )));\n</code></pre>"},{"location":"java/java8/#_9","title":"\u5206\u533a","text":"<p>\u5206\u533a\u662f\u5206\u7ec4\u7684\u7279\u6b8a\u60c5\u51b5\uff1a\u7531\u4e00\u4e2a\u8c13\u8bcd\uff08\u8fd4\u56de\u4e00\u4e2a\u5e03\u5c14\u503c\u7684\u51fd\u6570\uff09\u4f5c\u4e3a\u5206\u7c7b\u51fd\u6570\uff0c\u5b83\u79f0\u5206\u533a\u51fd\u6570\u3002\u5206\u533a\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a\u5e03\u5c14\u503c\uff0c\u8fd9\u610f\u5473\u7740\u5f97\u5230\u7684\u5206\u7ec4Map\u7684\u952e\u7c7b\u578b\u662fBoolean\uff0c\u4e8e\u662f\u5b83\u6700\u591a\u53ef\u4ee5\u5206\u4e3a\u4e24\u7ec4\u2014\u2014true\u662f\u4e00\u7ec4\uff0cfalse\u662f\u4e00\u7ec4\u3002</p> <p></p> <p>Collectors\u7c7b\u7684\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u80fd\u591f\u521b\u5efa\u7684\u6240\u6709\u6536\u96c6\u5668\uff0c\u6240\u6709\u8fd9\u4e9b\u6536\u96c6\u5668\u90fd\u662f\u5bf9Collector\u63a5\u53e3\u7684\u5b9e\u73b0\uff0c</p> <p></p> <p></p>"},{"location":"java/java8/#java8","title":"\u5229\u7528Java8\u65b0\u7279\u6027\u91cd\u6784","text":"<p>\u91cd\u6784\u4ee3\u7801</p> <ul> <li>\u7528Lambda\u8868\u8fbe\u5f0f\u53d6\u4ee3\u533f\u540d\u7c7b\uff0c\u4f46\u662f\u8981\u6ce8\u610f\u4e8c\u8005\u95f4\u8bed\u4e49\u7684\u5fae\u5999\u5dee\u522b\uff0c\u6bd4\u5982\u5173\u952e\u5b57this\uff0c\u4ee5\u53ca\u53d8\u91cf\u9690\u85cf\u3002</li> <li>\u7528\u65b9\u6cd5\u5f15\u7528\u91cd\u6784Lambda\u8868\u8fbe\u5f0f\uff0c\u65b9\u6cd5\u5f15\u7528\u7684\u53ef\u8bfb\u6027\u66f4\u597d\u3002</li> <li>\u7528Stream API\u91cd\u6784\u547d\u4ee4\u5f0f\u7684\u6570\u636e\u5904\u7406</li> </ul> <p>\u4f18\u5316\u5df2\u6709\u7684\u8bbe\u8ba1\u7684\u6a21\u5f0f\uff1a\u5229\u7528lambda\u8868\u8fbe\u5f0f\u53ef\u4ee5\u7b80\u5316\u7b56\u7565\u6a21\u5f0f\uff0c\u6a21\u677f\u6a21\u5f0f\uff0c\u89c2\u5bdf\u8005\u6a21\u5f0f\uff0c\u5de5\u5382\u6a21\u5f0f\u4e2d\u4e00\u4e9b\u50f5\u5316\u7684\u4ee3\u7801\u3002</p> <p>\u4f7f\u7528peek\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8c03\u8bd5stream\u6d41\u4ee3\u7801\uff0c\u80fd\u5c06\u4e2d\u95f4\u53d8\u91cf\u7684\u503c\u8f93\u51fa\u5230\u65e5\u5fd7\u4e2d\uff0c\u662f\u975e\u5e38\u6709\u7528\u7684\u5de5\u5177\u3002</p> <p></p>"},{"location":"java/java8/#java8_1","title":"Java8\u5176\u4ed6\u7279\u6027","text":""},{"location":"java/java8/#_10","title":"\u9ed8\u8ba4\u65b9\u6cd5","text":"<p>Java8\u4e2d\u7684\u63a5\u53e3\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u9ed8\u8ba4\u65b9\u6cd5\u548c\u9759\u6001\u65b9\u6cd5\u63d0\u4f9b\u65b9\u6cd5\u7684\u4ee3\u7801\u5b9e\u73b0\uff01\u9ed8\u8ba4\u65b9\u6cd5\u5f00\u5934\u662fdefault\u3002</p> <p>\u9ed8\u8ba4\u65b9\u6cd5\u7684\u51fa\u73b0\u662f\u4e3a\u4e86\u65b9\u4fbf\u7c7b\u5e93\u7684\u8bbe\u8ba1\u8005\u4ee5\u5411\u540e\u517c\u5bb9\u7684\u65b9\u5f0f\u6dfb\u52a0\u63a5\u53e3\u5b9a\u4e49\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5411\u63a5\u53e3\u6dfb\u52a0\u65b9\u6cd5\u662f\u4e07\u6076\u4e4b\u6e90\uff0c\u4e00\u65e6\u63a5\u53e3\u53d1\u751f\u53d8\u5316\uff0c\u5b9e\u73b0\u8fd9\u4e9b\u63a5\u53e3\u7684\u7c7b\u5f80\u5f80\u4e5f\u9700\u8981\u66f4\u65b0\uff0c\u63d0\u4f9b\u65b0\u6dfb\u65b9\u6cd5\u7684\u5b9e\u73b0\u624d\u80fd\u9002\u914d\u63a5\u53e3\u7684\u53d8\u5316\u3002\u5982\u679c\u4f60\u5bf9\u63a5\u53e3\u4ee5\u53ca\u5b83\u6240\u6709\u76f8\u5173\u7684\u5b9e\u73b0\u6709\u5b8c\u5168\u7684\u63a7\u5236\uff0c\u8fd9\u53ef\u80fd\u4e0d\u662f\u4e2a\u5927\u95ee\u9898\u3002\u4f46\u662f\u8fd9\u79cd\u60c5\u51b5\u662f\u6781\u5c11\u7684\u3002\u8fd9\u5c31\u662f\u5f15\u5165\u9ed8\u8ba4\u65b9\u6cd5\u7684\u76ee\u7684\uff1a\u5b83\u8ba9\u7c7b\u53ef\u4ee5\u81ea\u52a8\u5730\u7ee7\u627f\u63a5\u53e3\u7684\u4e00\u4e2a\u9ed8\u8ba4\u5b9e\u73b0\u3002</p> <p>\u9ed8\u8ba4\u65b9\u6cd5\u8fd8\u4f7f\u5f97\u4f60\u73b0\u5728\u53ef\u4ee5\u5b9e\u73b0\u884c\u4e3a\u7684\u591a\u7ee7\u627f\uff01\u8fd9\u662f\u4e00\u79cd\u8ba9\u7c7b\u4ece\u591a\u4e2a\u6765\u6e90\u91cd\u7528\u4ee3\u7801\u7684\u80fd\u529b</p> <p>\u9759\u6001\u65b9\u6cd5\u53ca\u63a5\u53e3\u540c\u65f6\u5b9a\u4e49\u63a5\u53e3\u4ee5\u53ca\u5de5\u5177\u8f85\u52a9\u7c7b\uff08companion class\uff09\u662fJava\u8bed\u8a00\u5e38\u7528\u7684\u4e00\u79cd\u6a21\u5f0f\uff0c\u5de5\u5177\u7c7b\u5b9a\u4e49\u4e86\u4e0e\u63a5\u53e3\u5b9e\u4f8b\u534f\u4f5c\u7684\u5f88\u591a\u9759\u6001\u65b9\u6cd5\u3002\u6bd4\u5982\uff0cCollections\u5c31\u662f\u5904\u7406Collection\u5bf9\u8c61\u7684\u8f85\u52a9\u7c7b\u3002\u7531\u4e8e\u9759\u6001\u65b9\u6cd5\u53ef\u4ee5\u5b58\u5728\u4e8e\u63a5\u53e3\u5185\u90e8\uff0c\u4f60\u4ee3\u7801\u4e2d\u7684\u8fd9\u4e9b\u8f85\u52a9\u7c7b\u5c31\u6ca1\u6709\u4e86\u5b58\u5728\u7684\u5fc5\u8981\uff0c\u4f60\u53ef\u4ee5\u628a\u8fd9\u4e9b\u9759\u6001\u65b9\u6cd5\u8f6c\u79fb\u5230\u63a5\u53e3\u5185\u90e8\u3002\u4e3a\u4e86\u4fdd\u6301\u540e\u5411\u7684\u517c\u5bb9\u6027\uff0c\u8fd9\u4e9b\u7c7b\u4f9d\u7136\u4f1a\u5b58\u5728\u4e8eJava\u5e94\u7528\u7a0b\u5e8f\u7684\u63a5\u53e3\u4e4b\u4e2d\u3002</p> <p>Java 8\u4e2d\u7684\u62bd\u8c61\u7c7b\u548c\u62bd\u8c61\u63a5\u53e3\u90a3\u4e48\u62bd\u8c61\u7c7b\u548c\u62bd\u8c61\u63a5\u53e3\u4e4b\u95f4\u7684\u533a\u522b\u662f\u4ec0\u4e48\u5462\uff1f\u5b83\u4eec\u4e0d\u90fd\u80fd\u5305\u542b\u62bd\u8c61\u65b9\u6cd5\u548c\u5305\u542b\u65b9\u6cd5\u4f53\u7684\u5b9e\u73b0\u5417\uff1f\u9996\u5148\uff0c\u4e00\u4e2a\u7c7b\u53ea\u80fd\u7ee7\u627f\u4e00\u4e2a\u62bd\u8c61\u7c7b\uff0c\u4f46\u662f\u4e00\u4e2a\u7c7b\u53ef\u4ee5\u5b9e\u73b0\u591a\u4e2a\u63a5\u53e3\u3002\u5176\u6b21\uff0c\u4e00\u4e2a\u62bd\u8c61\u7c7b\u53ef\u4ee5\u901a\u8fc7\u5b9e\u4f8b\u53d8\u91cf\uff08\u5b57\u6bb5\uff09\u4fdd\u5b58\u4e00\u4e2a\u901a\u7528\u72b6\u6001\uff0c\u800c\u63a5\u53e3\u662f\u4e0d\u80fd\u6709\u5b9e\u4f8b\u53d8\u91cf\u7684\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u7c7b\u7684\u9ed8\u8ba4\u65b9\u6cd5\u4f7f\u7528\u76f8\u540c\u7684\u51fd\u6570\u7b7e\u540d\u7ee7\u627f\u81ea\u591a\u4e2a\u63a5\u53e3\uff0c\u89e3\u51b3\u51b2\u7a81\u7684\u673a\u5236\u5176\u5b9e\u76f8\u5f53\u7b80\u5355\u3002\u4f60\u53ea\u9700\u8981\u9075\u5b88\u4e0b\u9762\u8fd9\u4e09\u6761\u51c6\u5219\u5c31\u80fd\u89e3\u51b3\u6240\u6709\u53ef\u80fd\u7684\u51b2\u7a81\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u7c7b\u6216\u7236\u7c7b\u4e2d\u663e\u5f0f\u58f0\u660e\u7684\u65b9\u6cd5\uff0c\u5176\u4f18\u5148\u7ea7\u9ad8\u4e8e\u6240\u6709\u7684\u9ed8\u8ba4\u65b9\u6cd5\u3002</li> <li>\u5982\u679c\u7528\u7b2c\u4e00\u6761\u65e0\u6cd5\u5224\u65ad\uff0c\u65b9\u6cd5\u7b7e\u540d\u53c8\u6ca1\u6709\u533a\u522b\uff0c\u90a3\u4e48\u9009\u62e9\u63d0\u4f9b\u6700\u5177\u4f53\u5b9e\u73b0\u7684\u9ed8\u8ba4\u65b9\u6cd5\u7684\u63a5\u53e3\u3002</li> <li>\u6700\u540e\uff0c\u5982\u679c\u51b2\u7a81\u4f9d\u65e7\u65e0\u6cd5\u89e3\u51b3\uff0c\u4f60\u5c31\u53ea\u80fd\u5728\u4f60\u7684\u7c7b\u4e2d\u8986\u76d6\u8be5\u9ed8\u8ba4\u65b9\u6cd5\uff0c\u663e\u5f0f\u5730\u6307\u5b9a\u5728\u4f60\u7684\u7c7b\u4e2d\u4f7f\u7528\u54ea\u4e00\u4e2a\u63a5\u53e3\u4e2d\u7684\u65b9\u6cd5\u3002</li> </ul>"},{"location":"java/java8/#optional","title":"optional","text":"<p>\u5c06\u7c7b\u5c5e\u6027\u6216\u65b9\u6cd5\u53c2\u6570\u58f0\u660e\u79f0Optional <p>Optional\u662f\u5982\u4f55\u4e30\u5bcc\u4f60\u6a21\u578b\u7684\u8bed\u4e49\uff1f\u4f7f\u7528Optional\u800c\u4e0d\u662fnull\u7684\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u800c\u53c8\u5b9e\u9645\u7684\u8bed\u4e49\u533a\u522b\u662f\uff0c\u8fd9\u53e5\u58f0\u660e\u975e\u5e38\u6e05\u695a\u5730\u8868\u660e\u4e86\u8fd9\u91cc\u53d1\u751f\u53d8\u91cf\u7f3a\u5931\u662f\u5141\u8bb8\u7684\u3002\u5f15\u5165Optional\u7c7b\u7684\u610f\u56fe\u5e76\u975e\u8981\u6d88\u9664\u6bcf\u4e00\u4e2anull\u5f15\u7528\u3002\u4e0e\u6b64\u76f8\u53cd\uff0c\u5b83\u7684\u76ee\u6807\u662f\u5e2e\u52a9\u4f60\u66f4\u597d\u5730\u8bbe\u8ba1\u51fa\u666e\u9002\u7684API\uff0c\u8ba9\u7a0b\u5e8f\u5458\u770b\u5230\u65b9\u6cd5\u7b7e\u540d\uff0c\u5c31\u80fd\u4e86\u89e3\u5b83\u662f\u5426\u63a5\u53d7\u4e00\u4e2aOptional\u7684\u503c\u3002\u8fd9\u79cd\u5f3a\u5236\u4f1a\u8ba9\u4f60\u66f4\u79ef\u6781\u5730\u5c06\u53d8\u91cf\u4eceOptional\u4e2d\u89e3\u5305\u51fa\u6765\uff0c\u76f4\u9762\u7f3a\u5931\u7684\u53d8\u91cf\u503c\u3002</p> <p>\u4f7f\u7528map\u63d0\u53d6\u548c\u8f6c\u6362\u503c</p> <p>map\u7684\u4f5c\u7528\u662f\uff0c\u5982\u679cOptional\u5305\u542b\u4e00\u4e2a\u503c\uff0c\u90a3\u51fd\u6570\u5c31\u5c06\u8be5\u503c\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9map\uff0c\u5bf9\u8be5\u503c\u8fdb\u884c\u8f6c\u6362\u3002\u5982\u679cOptional\u4e3a\u7a7a\uff0c\u5c31\u4ec0\u4e48\u4e5f\u4e0d\u505a\u3002</p> <pre><code>// \u63d0\u53d6\u503c\nboardSiteReqOptional.map(req -&gt; queryWrapper.eq(SiteInfo::getManagementType, req.getManagementType()));\n// \u8f6c\u6362\u503c\nOptional&lt;String&gt; name=optInsurance.map(Insurance::getName);\n\n// \u7ec4\u5408\u4f7f\u7528\u3002\u5982\u679c\u662f\u591a\u5c42\u7684Optional\u5bf9\u8c61\uff0c\u9700\u8981\u7528flatMap\u94fe\u63a5\npublic Optional&lt;Insurance&gt; nullSafeFindCheapestInsurance( Optional&lt;Person&gt; person,                                                                  Optional&lt;Car&gt; car) {\n      return person.flatMap(p-&gt; car.map(c-&gt; findCheapestInsurance(p, c)));\n}\n</code></pre> <p>\u5b9a\u4e49\u9ed8\u8ba4\u503c</p> <ul> <li> <p>get()\u662f\u8fd9\u4e9b\u65b9\u6cd5\u4e2d\u6700\u7b80\u5355\u4f46\u53c8\u6700\u4e0d\u5b89\u5168\u7684\u65b9\u6cd5\u3002\u5982\u679c\u53d8\u91cf\u5b58\u5728\uff0c\u5b83\u76f4\u63a5\u8fd4\u56de\u5c01\u88c5\u7684\u53d8\u91cf\u503c\uff0c\u5426\u5219\u5c31\u629b\u51fa\u4e00\u4e2aNoSuchElementException\u5f02\u5e38\u3002\u6240\u4ee5\uff0c\u9664\u975e\u4f60\u975e\u5e38\u786e\u5b9aOptional\u53d8\u91cf\u4e00\u5b9a\u5305\u542b\u503c\uff0c\u5426\u5219\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6cd5\u662f\u4e2a\u76f8\u5f53\u7cdf\u7cd5\u7684\u4e3b\u610f</p> </li> <li> <p>orElse(T other)\u5141\u8bb8\u4f60\u5728Optional\u5bf9\u8c61\u4e0d\u5305\u542b\u503c\u65f6\u63d0\u4f9b\u4e00\u4e2a\u9ed8\u8ba4\u503c\u3002</p> </li> <li> <p>orElseGet(Supplier&lt;? extends T&gt; other)\u662forElse\u65b9\u6cd5\u7684\u5ef6\u8fdf\u8c03\u7528\u7248\uff0cSupplier\u65b9\u6cd5\u53ea\u6709\u5728Optional\u5bf9\u8c61\u4e0d\u542b\u503c\u65f6\u624d\u6267\u884c\u8c03\u7528</p> </li> <li> <p>orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier)\u548cget\u65b9\u6cd5\u975e\u5e38\u7c7b\u4f3c\uff0c\u5b83\u4eec\u906d\u9047Optional\u5bf9\u8c61\u4e3a\u7a7a\u65f6\u90fd\u4f1a\u629b\u51fa\u4e00\u4e2a\u5f02\u5e38\uff0c\u4f46\u662f\u4f7f\u7528orElseThrow\u4f60\u53ef\u4ee5\u5b9a\u5236\u5e0c\u671b\u629b\u51fa\u7684\u5f02\u5e38\u7c7b\u578b\u3002ifPresent(Consumer&lt;? super T&gt;)\u8ba9\u4f60\u80fd\u5728\u53d8\u91cf\u503c\u5b58\u5728\u65f6\u6267\u884c\u4e00\u4e2a\u4f5c\u4e3a\u53c2\u6570\u4f20\u5165\u7684\u65b9\u6cd5\uff0c\u5426\u5219\u5c31\u4e0d\u8fdb\u884c\u4efb\u4f55\u64cd\u4f5c</p> </li> </ul> <p>\u4f7f\u7528filter\u5254\u9664\u7279\u5b9a\u7684\u503c</p> <p>\u4f60\u7ecf\u5e38\u9700\u8981\u8c03\u7528\u67d0\u4e2a\u5bf9\u8c61\u7684\u65b9\u6cd5\uff0c\u67e5\u770b\u5b83\u7684\u67d0\u4e9b\u5c5e\u6027\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u68c0\u67e5\u4fdd\u9669\u516c\u53f8\u7684\u540d\u79f0\u662f\u5426\u4e3a\u201cCambridge-Insurance\u201d\u3002\u4e3a\u4e86\u4ee5\u4e00\u79cd\u5b89\u5168\u7684\u65b9\u5f0f\u8fdb\u884c\u8fd9\u4e9b\u64cd\u4f5c\uff0c\u4f60\u9996\u5148\u9700\u8981\u786e\u5b9a\u5f15\u7528\u6307\u5411\u7684Insurance\u5bf9\u8c61\u662f\u5426\u4e3anull\uff0c\u4e4b\u540e\u518d\u8c03\u7528\u5b83\u7684getName\u65b9\u6cd5\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>Insurance insurance=...;\nif(insurance !=null &amp;&amp; \"CambridgeInsurance\".equals(insurance.getName())){\n      System.out.println(\"ok\");\n }\n\n// \u53ef\u4ee5\u6539\u6210\nOptional&lt;Insurance&gt; optInsurance=...;\noptInsurance.filter(insurance-&gt;\n                \"CambridgeInsurance\".equals(insurance.getName()))\n          .ifPresent(x-&gt; System.out.println(\"ok\"));\n</code></pre> <p>filter\u65b9\u6cd5\u63a5\u53d7\u4e00\u4e2a\u8c13\u8bcd\u4f5c\u4e3a\u53c2\u6570\u3002\u5982\u679cOptional\u5bf9\u8c61\u7684\u503c\u5b58\u5728\uff0c\u5e76\u4e14\u5b83\u7b26\u5408\u8c13\u8bcd\u7684\u6761\u4ef6\uff0cfilter\u65b9\u6cd5\u5c31\u8fd4\u56de\u5176\u503c\uff1b\u5426\u5219\u5b83\u5c31\u8fd4\u56de\u4e00\u4e2a\u7a7a\u7684Optional\u5bf9\u8c61\u3002\u5982\u679c\u4f60\u8fd8\u8bb0\u5f97\u6211\u4eec\u53ef\u4ee5\u5c06Optional\u770b\u6210\u6700\u591a\u5305\u542b\u4e00\u4e2a\u5143\u7d20\u7684Stream\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u884c\u4e3a\u5c31\u975e\u5e38\u6e05\u6670\u4e86\u3002\u5982\u679cOptional\u5bf9\u8c61\u4e3a\u7a7a\uff0c\u5b83\u4e0d\u505a\u4efb\u4f55\u64cd\u4f5c\uff0c\u53cd\u4e4b\uff0c\u5b83\u5c31\u5bf9Optional\u5bf9\u8c61\u4e2d\u5305\u542b\u7684\u503c\u65bd\u52a0\u8c13\u8bcd\u64cd\u4f5c\u3002\u5982\u679c\u8be5\u64cd\u4f5c\u7684\u7ed3\u679c\u4e3atrue\uff0c\u5b83\u4e0d\u505a\u4efb\u4f55\u6539\u53d8\uff0c\u76f4\u63a5\u8fd4\u56de\u8be5Optional\u5bf9\u8c61\uff0c\u5426\u5219\u5c31\u5c06\u8be5\u503c\u8fc7\u6ee4\u6389\uff0c\u5c06Optional\u7684\u503c\u7f6e\u7a7a</p> <p></p> <p>\u91cd\u6784\u5b9e\u6218</p> <p>\u7528Optional\u5c01\u88c5\u53ef\u80fd\u4e3anull\u7684\u503c\uff0c\u5982 <code>Optional&lt;Object&gt; value = Optional.ofNullable(map.get(\"key\"));</code></p> <p>\u4e0eStream\u5bf9\u8c61\u4e00\u6837\uff0cOptional\u4e5f\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u57fa\u7840\u7c7b\u578b\u2014\u2014OptionalInt\u3001OptionalLong\u4ee5\u53caOptionalDouble,\u4f46\u6211\u4eec\u4e0d\u63a8\u8350\u5927\u5bb6\u4f7f\u7528\u57fa\u7840\u7c7b\u578b\u7684Optional\uff0c\u56e0\u4e3a\u57fa\u7840\u7c7b\u578b\u7684Optional\u4e0d\u652f\u6301map\u3001flatMap\u4ee5\u53cafilter\u65b9\u6cd5\uff0c\u800c\u8fd9\u4e9b\u5374\u662fOptional\u7c7b\u6700\u6709\u7528\u7684\u65b9\u6cd5</p> <p>\u57fa\u4e8e\u65e7\u5199\u6cd5\u7684\u6539\u9020</p> <pre><code>public int readDuration(Properties props, String name) {\n      return Optional.ofNullable(props.getProperty(name))\n              .flatMap(OptionalUtility::stringToInt)\n               .filter(i-&gt; i &gt; 0)\n              .orElse(0);\n}\n</code></pre>"},{"location":"java/java8/#completablefuture","title":"CompletableFuture\uff1a\u7ec4\u5408\u5f0f\u5f02\u6b65\u7f16\u7a0b","text":"<p>Future\u63a5\u53e3\u5728Java 5\u4e2d\u88ab\u5f15\u5165\uff0c\u8bbe\u8ba1\u521d\u8877\u662f\u5bf9\u5c06\u6765\u67d0\u4e2a\u65f6\u523b\u4f1a\u53d1\u751f\u7684\u7ed3\u679c\u8fdb\u884c\u5efa\u6a21\u3002\u5b83\u5efa\u6a21\u4e86\u4e00\u79cd\u5f02\u6b65\u8ba1\u7b97\uff0c\u8fd4\u56de\u4e00\u4e2a\u6267\u884c\u8fd0\u7b97\u7ed3\u679c\u7684\u5f15\u7528\uff0c\u5f53\u8fd0\u7b97\u7ed3\u675f\u540e\uff0c\u8fd9\u4e2a\u5f15\u7528\u88ab\u8fd4\u56de\u7ed9\u8c03\u7528\u65b9\u3002\u5728Future\u4e2d\u89e6\u53d1\u90a3\u4e9b\u6f5c\u5728\u8017\u65f6\u7684\u64cd\u4f5c\u628a\u8c03\u7528\u7ebf\u7a0b\u89e3\u653e\u51fa\u6765\uff0c\u8ba9\u5b83\u80fd\u7ee7\u7eed\u6267\u884c\u5176\u4ed6\u6709\u4ef7\u503c\u7684\u5de5\u4f5c\uff0c\u4e0d\u518d\u9700\u8981\u5446\u5446\u7b49\u5f85\u8017\u65f6\u7684\u64cd\u4f5c\u5b8c\u6210\u3002\u6253\u4e2a\u6bd4\u65b9\uff0c\u4f60\u53ef\u4ee5\u628a\u5b83\u60f3\u8c61\u6210\u8fd9\u6837\u7684\u573a\u666f\uff1a\u4f60\u62ff\u4e86\u4e00\u888b\u5b50\u8863\u670d\u5230\u4f60\u4e2d\u610f\u7684\u5e72\u6d17\u5e97\u53bb\u6d17\u3002\u5e72\u6d17\u5e97\u7684\u5458\u5de5\u4f1a\u7ed9\u4f60\u5f20\u53d1\u7968\uff0c\u544a\u8bc9\u4f60\u4ec0\u4e48\u65f6\u5019\u4f60\u7684\u8863\u670d\u4f1a\u6d17\u597d\uff08\u8fd9\u5c31\u662f\u4e00\u4e2aFuture\u4e8b\u4ef6\uff09\u3002\u8863\u670d\u5e72\u6d17\u7684\u540c\u65f6\uff0c\u4f60\u53ef\u4ee5\u53bb\u505a\u5176\u4ed6\u7684\u4e8b\u60c5\u3002</p> <p>\u4f46\u662ffuture\u63a5\u53e3\u6709\u5f88\u591a\u5c40\u9650\u6027\uff0c\u6bd4\u5982\u5c06\u4e24\u4e2a\u5f02\u6b65\u8ba1\u7b97\u5408\u5e76\u4e3a\u4e00\u4e2a\u2014\u2014\u8fd9\u4e24\u4e2a\u5f02\u6b65\u8ba1\u7b97\u4e4b\u95f4\u76f8\u4e92\u72ec\u7acb\uff0c\u540c\u65f6\u7b2c\u4e8c\u4e2a\u53c8\u4f9d\u8d56\u4e8e\u7b2c\u4e00\u4e2a\u7684\u7ed3\u679c\u3002\u2751 \u7b49\u5f85Future\u96c6\u5408\u4e2d\u7684\u6240\u6709\u4efb\u52a1\u90fd\u5b8c\u6210\u3002\u2751 \u4ec5\u7b49\u5f85Future\u96c6\u5408\u4e2d\u6700\u5feb\u7ed3\u675f\u7684\u4efb\u52a1\u5b8c\u6210\uff08\u6709\u53ef\u80fd\u56e0\u4e3a\u5b83\u4eec\u8bd5\u56fe\u901a\u8fc7\u4e0d\u540c\u7684\u65b9\u5f0f\u8ba1\u7b97\u540c\u4e00\u4e2a\u503c\uff09\uff0c\u5e76\u8fd4\u56de\u5b83\u7684\u7ed3\u679c\u3002 \u5e94\u5bf9Future\u7684\u5b8c\u6210\u4e8b\u4ef6\uff08\u5373\u5f53Future\u7684\u5b8c\u6210\u4e8b\u4ef6\u53d1\u751f\u65f6\u4f1a\u6536\u5230\u901a\u77e5\uff0c\u5e76\u80fd\u4f7f\u7528Future\u8ba1\u7b97\u7684\u7ed3\u679c\u8fdb\u884c\u4e0b\u4e00\u6b65\u7684\u64cd\u4f5c\uff0c\u4e0d\u53ea\u662f\u7b80\u5355\u5730\u963b\u585e\u7b49\u5f85\u64cd\u4f5c\u7684\u7ed3\u679c\uff09</p>"},{"location":"java/java8/#api","title":"\u63d0\u4f9b\u5f02\u6b65\u7684API","text":"<p>\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u4ee3\u8868\u5f02\u6b65\u8ba1\u7b97\u7684CompletableFuture\u5bf9\u8c61\u5b9e\u4f8b\uff0c\u5b83\u5728\u8ba1\u7b97\u5b8c\u6210\u65f6\u4f1a\u5305\u542b\u8ba1\u7b97\u7684\u7ed3\u679c\u3002\u63a5\u7740\uff0c\u4f60\u8c03\u7528fork\u521b\u5efa\u4e86\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u53bb\u6267\u884c\u5b9e\u9645\u7684\u4ef7\u683c\u8ba1\u7b97\u5de5\u4f5c\uff0c\u4e0d\u7b49\u8be5\u8017\u65f6\u8ba1\u7b97\u4efb\u52a1\u7ed3\u675f\uff0c\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2aFuture\u5b9e\u4f8b\u3002</p> <p></p> <p>\u5982\u679c\u6ca1\u6709\u610f\u5916\uff0c\u6211\u4eec\u76ee\u524d\u5f00\u53d1\u7684\u4ee3\u7801\u5de5\u4f5c\u5f97\u5f88\u6b63\u5e38\u3002\u4f46\u662f\uff0c\u5982\u679c\u4ef7\u683c\u8ba1\u7b97\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u4e86\u9519\u8bef\u4f1a\u600e\u6837\u5462\uff1f\u975e\u5e38\u4e0d\u5e78\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u4f60\u4f1a\u5f97\u5230\u4e00\u4e2a\u76f8\u5f53\u7cdf\u7cd5\u7684\u7ed3\u679c\uff1a\u7528\u4e8e\u63d0\u793a\u9519\u8bef\u7684\u5f02\u5e38\u4f1a\u88ab\u9650\u5236\u5728\u8bd5\u56fe\u8ba1\u7b97\u5546\u54c1\u4ef7\u683c\u7684\u5f53\u524d\u7ebf\u7a0b\u7684\u8303\u56f4\u5185\uff0c\u6700\u7ec8\u4f1a\u6740\u6b7b\u8be5\u7ebf\u7a0b\uff0c\u800c\u8fd9\u4f1a\u5bfc\u81f4\u7b49\u5f85get\u65b9\u6cd5\u8fd4\u56de\u7ed3\u679c\u7684\u5ba2\u6237\u7aef\u6c38\u4e45\u5730\u88ab\u963b\u585e\uff01</p> <p>\u5ba2\u6237\u7aef\u53ef\u4ee5\u4f7f\u7528\u91cd\u8f7d\u7248\u672c\u7684get\u65b9\u6cd5\uff0c\u5b83\u4f7f\u7528\u4e00\u4e2a\u8d85\u65f6\u53c2\u6570\u6765\u907f\u514d\u53d1\u751f\u8fd9\u6837\u7684\u60c5\u51b5\u3002\u8fd9\u662f\u4e00\u79cd\u503c\u5f97\u63a8\u8350\u7684\u505a\u6cd5\uff0c\u4f60\u5e94\u8be5\u5c3d\u91cf\u5728\u4f60\u7684\u4ee3\u7801\u4e2d\u6dfb\u52a0\u8d85\u65f6\u5224\u65ad\u7684\u903b\u8f91\uff0c\u907f\u514d\u53d1\u751f\u7c7b\u4f3c\u7684\u95ee\u9898\u3002\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u81f3\u5c11\u80fd\u9632\u6b62\u7a0b\u5e8f\u6c38\u4e45\u5730\u7b49\u5f85\u4e0b\u53bb\u3002\u4e0d\u8fc7\uff0c\u4e5f\u56e0\u4e3a\u5982\u6b64\uff0c\u4f60\u4e0d\u4f1a\u6709\u673a\u4f1a\u53d1\u73b0\u8ba1\u7b97\u5546\u54c1\u4ef7\u683c\u7684\u7ebf\u7a0b\u5185\u5230\u5e95\u53d1\u751f\u4e86\u4ec0\u4e48\u95ee\u9898\u624d\u5f15\u53d1\u4e86\u8fd9\u6837\u7684\u5931\u6548\u3002\u4e3a\u4e86\u8ba9\u5ba2\u6237\u7aef\u80fd\u4e86\u89e3\u5546\u5e97\u65e0\u6cd5\u63d0\u4f9b\u8bf7\u6c42\u5546\u54c1\u4ef7\u683c\u7684\u539f\u56e0\uff0c\u4f60\u9700\u8981\u4f7f\u7528CompletableFuture\u7684completeExceptionally\u65b9\u6cd5\u5c06\u5bfc\u81f4CompletableFuture\u5185\u53d1\u751f\u95ee\u9898\u7684\u5f02\u5e38\u629b\u51fa</p> <p></p> <p>\u5ba2\u6237\u7aef\u73b0\u5728\u4f1a\u6536\u5230\u4e00\u4e2aExecutionException\u5f02\u5e38\uff0c\u8be5\u5f02\u5e38\u63a5\u6536\u4e86\u4e00\u4e2a\u5305\u542b\u5931\u8d25\u539f\u56e0\u7684Exception\u53c2\u6570\uff0c\u5373\u4ef7\u683c\u8ba1\u7b97\u65b9\u6cd5\u6700\u521d\u629b\u51fa\u7684\u5f02\u5e38</p>"},{"location":"java/java8/#completablefuture_1","title":"CompletableFuture\u7c7b\u63d0\u4f9b\u7684\u5de5\u5382\u65b9\u6cd5","text":"<p>CompletableFuture\u7c7b\u81ea\u8eab\u63d0\u4f9b\u4e86\u5927\u91cf\u7cbe\u5de7\u7684\u5de5\u5382\u65b9\u6cd5\uff0c\u4f7f\u7528\u8fd9\u4e9b\u65b9\u6cd5\u80fd\u66f4\u5bb9\u6613\u5730\u5b8c\u6210\u6574\u4e2a\u6d41\u7a0b\uff0c\u8fd8\u4e0d\u7528\u62c5\u5fc3\u5b9e\u73b0\u7684\u7ec6\u8282\u3002</p> <p>\u6bd4\u5982\u91c7\u7528supplyAsync\u65b9\u6cd5\u91cd\u5199\u4e0a\u9762\u7684\u5f02\u6b65\u65b9\u6cd5\uff0csupplyAsync\u65b9\u6cd5\u63a5\u53d7\u4e00\u4e2a\u751f\u4ea7\u8005\uff08Supplier\uff09\u4f5c\u4e3a\u53c2\u6570\uff0c\u8fd4\u56de\u4e00\u4e2aCompletableFuture\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u5b8c\u6210\u5f02\u6b65\u6267\u884c\u540e\u4f1a\u8bfb\u53d6\u8c03\u7528\u751f\u4ea7\u8005\u65b9\u6cd5\u7684\u8fd4\u56de\u503c</p> <pre><code>public Future&lt;Double&gt; getPriceAsync(String product) {\n    return CompletableFuture.supplyAsync(()-&gt; calculatePrice(product));\n}\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u81ea\u5b9a\u4e49\u914d\u7f6e\u7684\u7ebf\u7a0b\u6c60</p>"},{"location":"java/java8/#_11","title":"\u7b49\u5f85\u6240\u6709\u5f02\u6b65\u64cd\u4f5c\u7684\u7ed3\u679c","text":"<p>\u73b0\u5728\u5047\u8bbe\u4f60\u5206\u522b\u8bf7\u6c42\u4e0d\u540c\u7684\u5546\u5e97\u83b7\u53d6\u4ea7\u54c1\u7684\u4ef7\u683c\uff0c\u63a8\u8350\u7684\u505a\u6cd5</p> <p></p> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u5fc5\u987b\u4f7f\u7528\u4e24\u4e2a\u4e0d\u540c\u7684\u6d41\uff0c\u4e0d\u7136\u56e0\u4e3a\u6d41\u7684\u5ef6\u8fdf\u7279\u6027\uff0c\u5355\u4e00\u6d41\u667a\u80fd\u4ee5\u540c\u6b65\u987a\u5e8f\u7684\u65b9\u5f0f\u6267\u884c\u3002</p> <p>CompletableFuture\u7c7b\u4e2d\u7684join\u65b9\u6cd5\u548cFuture\u63a5\u53e3\u4e2d\u7684get\u6709\u76f8\u540c\u7684\u542b\u4e49\uff0c\u5e76\u4e14\u4e5f\u58f0\u660e\u5728Future\u63a5\u53e3\u4e2d\uff0c\u5b83\u4eec\u552f\u4e00\u7684\u4e0d\u540c\u662fjoin\u4e0d\u4f1a\u629b\u51fa\u4efb\u4f55\u68c0\u6d4b\u5230\u7684\u5f02\u5e38</p>"},{"location":"java/java8/#_12","title":"\u7ec4\u5408\u591a\u4e2a\u5f02\u6b65\u4efb\u52a1","text":"<p>thenCompose\u65b9\u6cd5\u5141\u8bb8\u4f60\u5bf9\u4e24\u4e2a\u5f02\u6b65\u64cd\u4f5c\u8fdb\u884c\u6d41\u6c34\u7ebf\uff0c\u7b2c\u4e00\u4e2a\u64cd\u4f5c\u5b8c\u6210\u65f6\uff0c\u5c06\u5176\u7ed3\u679c\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u7b2c\u4e8c\u4e2a\u64cd\u4f5c\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u4f60\u53ef\u4ee5\u521b\u5efa\u4e24\u4e2aCompletableFutures\u5bf9\u8c61\uff0c\u5bf9\u7b2c\u4e00\u4e2aCompletableFuture\u5bf9\u8c61\u8c03\u7528thenCompose\uff0c\u5e76\u5411\u5176\u4f20\u9012\u4e00\u4e2a\u51fd\u6570\u3002\u5f53\u7b2c\u4e00\u4e2aCompletableFuture\u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u5b83\u7684\u7ed3\u679c\u5c06\u4f5c\u4e3a\u8be5\u51fd\u6570\u7684\u53c2\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u7684\u8fd4\u56de\u503c\u662f\u4ee5\u7b2c\u4e00\u4e2aCompletableFuture\u7684\u8fd4\u56de\u505a\u8f93\u5165\u8ba1\u7b97\u51fa\u7684\u7b2c\u4e8c\u4e2aCompletableFuture\u5bf9\u8c61</p> <p></p>"},{"location":"java/java8/#thencombine","title":"thenCombine\u65b9\u6cd5","text":"<p>\u5982\u679c\u4f60\u9700\u8981\u5c06\u4e24\u4e2a\u5b8c\u5168\u4e0d\u76f8\u5e72\u7684CompletableFuture\u5bf9\u8c61\u7684\u7ed3\u679c\u6574\u5408\u8d77\u6765\uff0c\u800c\u4e14\u4f60\u4e5f\u4e0d\u5e0c\u671b\u7b49\u5230\u7b2c\u4e00\u4e2a\u4efb\u52a1\u5b8c\u5168\u7ed3\u675f\u624d\u5f00\u59cb\u7b2c\u4e8c\u9879\u4efb\u52a1\u3002\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528thenCombine\u65b9\u6cd5\uff0c\u5b83\u63a5\u6536\u540d\u4e3aBiFunction\u7684\u7b2c\u4e8c\u53c2\u6570\uff0c\u8fd9\u4e2a\u53c2\u6570\u5b9a\u4e49\u4e86\u5f53\u4e24\u4e2aCompletableFuture\u5bf9\u8c61\u5b8c\u6210\u8ba1\u7b97\u540e\uff0c\u7ed3\u679c\u5982\u4f55\u5408\u5e76\u3002</p> <p>\u6bd4\u5982\u6709\u4e00\u5bb6\u5546\u5e97\u63d0\u4f9b\u7684\u4ef7\u683c\u662f\u4ee5\u6b27\u5143\uff08EUR\uff09\u8ba1\u4ef7\u7684\uff0c\u4f46\u662f\u4f60\u5e0c\u671b\u4ee5\u7f8e\u5143\u7684\u65b9\u5f0f\u63d0\u4f9b\u7ed9\u4f60\u7684\u5ba2\u6237\u3002\u4f60\u53ef\u4ee5\u7528\u5f02\u6b65\u7684\u65b9\u5f0f\u5411\u5546\u5e97\u67e5\u8be2\u6307\u5b9a\u5546\u54c1\u7684\u4ef7\u683c\uff0c\u540c\u65f6\u4ece\u8fdc\u7a0b\u7684\u6c47\u7387\u670d\u52a1\u90a3\u91cc\u67e5\u5230\u6b27\u5143\u548c\u7f8e\u5143\u4e4b\u95f4\u7684\u6c47\u7387\u3002\u5f53\u4e8c\u8005\u90fd\u7ed3\u675f\u65f6\uff0c\u518d\u5c06\u8fd9\u4e24\u4e2a\u7ed3\u679c\u7ed3\u5408\u8d77\u6765\uff0c\u7528\u8fd4\u56de\u7684\u5546\u54c1\u4ef7\u683c\u4e58\u4ee5\u5f53\u65f6\u7684\u6c47\u7387\uff0c\u5f97\u5230\u4ee5\u7f8e\u5143\u8ba1\u4ef7\u7684\u5546\u54c1\u4ef7\u683c</p> <p></p> <p></p> <p>thenAccep\u63a5\u6536CompletableFuture\u6267\u884c\u5b8c\u6bd5\u540e\u7684\u8fd4\u56de\u503c\u505a\u53c2\u6570\uff0c<code>findPricesStream(\"myPhone\").map(f-&gt; f.thenAccept(System.out::println));</code></p> <p>allOf\u5de5\u5382\u65b9\u6cd5\u63a5\u6536\u4e00\u4e2a\u7531CompletableFuture\u6784\u6210\u7684\u6570\u7ec4\uff0c\u5bf9allOf\u65b9\u6cd5\u8fd4\u56de\u7684CompletableFuture\u6267\u884cjoin\u64cd\u4f5c\u662f\u4e2a\u4e0d\u9519\u7684\u4e3b\u610f\u3002anyOf\u53ef\u4ee5\u5728\u7531\u7b2c\u4e00\u4e2afuture\u6267\u884c\u5b8c\u6bd5\u7acb\u5373\u8fd4\u56de</p> <pre><code>long start=System.nanoTime();\nCompletableFuture[] futures=findPricesStream(\"myPhone27S\")\n    // thenAccept \u6d88\u8d39\n    .map(f-&gt; f.thenAccept(\n        s-&gt; System.out.println(s+\" (done in \"+\n                               ((System.nanoTime() - start) / 1_000_000)+\" msecs)\")))\n    .toArray(size-&gt; new CompletableFuture[size]);\nCompletableFuture.allOf(futures).join();\nSystem.out.println(\"All shops have now responded in \"\n                   +((System.nanoTime() - start) / 1_000_000)+\" msecs\");\n</code></pre>"},{"location":"java/java8/#localdatetime","title":"\u5168\u65b0\u7684\u65e5\u671f\u65f6\u95f4\u7c7b LocalDateTime","text":"<p>\u65e7\u7684Date\u548cCalendar\u90fd\u5f88\u96be\u7528\uff0c\u800c\u4e14\u4e5f\u662f\u53ef\u4ee5\u53d8\u7684\u3002DateFormat\u4e0d\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u3002\u8fd9\u610f\u5473\u7740\u4e24\u4e2a\u7ebf\u7a0b\u5982\u679c\u5c1d\u8bd5\u4f7f\u7528\u540c\u4e00\u4e2aformatter\u89e3\u6790\u65e5\u671f\uff0c\u4f60\u53ef\u80fd\u4f1a\u5f97\u5230\u65e0\u6cd5\u9884\u671f\u7684\u7ed3\u679c</p>"},{"location":"java/java8/#localdatelocaltime","title":"LocalDate\u548cLocalTime","text":"<p>LocalDate\u7c7b\u7684\u5b9e\u4f8b\u662f\u4e00\u4e2a\u4e0d\u53ef\u53d8\u5bf9\u8c61\uff0c\u5b83\u53ea\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u65e5\u671f\uff0c\u5e76\u4e0d\u542b\u5f53\u5929\u7684\u65f6\u95f4\u4fe1\u606f\u3002\u53e6\u5916\uff0c\u5b83\u4e5f\u4e0d\u9644\u5e26\u4efb\u4f55\u4e0e\u65f6\u533a\u76f8\u5173\u7684\u4fe1\u606f\u3002</p> <pre><code>LocalDate.now();\nLocalDate date = LocalDate.of(2022, 3, 23);\nint year = date.getYear();\nDayOfWeek dow = date.getDayOfWeek();\nint len = date.lengthOfMonth(); // \u8fd4\u56de31\n</code></pre> <p>\u4f60\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4f20\u9012\u4e00\u4e2aTemporalField\u53c2\u6570\u7ed9get\u65b9\u6cd5\u62ff\u5230\u540c\u6837\u7684\u4fe1\u606f\u3002TemporalField\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u5b9a\u4e49\u4e86\u5982\u4f55\u8bbf\u95eetemporal\u5bf9\u8c61\u67d0\u4e2a\u5b57\u6bb5\u7684\u503c\u3002ChronoField\u679a\u4e3e\u5b9e\u73b0\u4e86\u8fd9\u4e00\u63a5\u53e3\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u4f7f\u7528get\u65b9\u6cd5\u5f97\u5230\u679a\u4e3e\u5143\u7d20\u7684\u503c\uff0c\u5982\u4e0b\u6240\u793a</p> <pre><code>int year=date.get(ChronoField.YEAR);\nint month=date.get(ChronoField.MONTH_OF_YEAR);\nint day=date.get(ChronoField.DAY_OF_MONTH);\n</code></pre> <p>\u4f60\u53ef\u4ee5\u5411parse\u65b9\u6cd5\u4f20\u9012\u4e00\u4e2aDateTimeFormatter\u3002\u8be5\u7c7b\u7684\u5b9e\u4f8b\u5b9a\u4e49\u4e86\u5982\u4f55\u683c\u5f0f\u5316\u4e00\u4e2a\u65e5\u671f\u6216\u8005\u65f6\u95f4\u5bf9\u8c61\u3002\u6b63\u5982\u6211\u4eec\u4e4b\u524d\u6240\u4ecb\u7ecd\u7684\uff0c\u5b83\u662f\u66ff\u6362\u8001\u7248java.util.DateFormat\u7684\u63a8\u8350\u66ff\u4ee3\u54c1</p> <pre><code>LocalDate date=LocalDate.parse(\"2014-03-18\");\nLocalTime time=LocalTime.parse(\"13:45:20\");\n</code></pre>"},{"location":"java/java8/#_13","title":"\u673a\u5668\u7684\u65f6\u95f4\u683c\u5f0f","text":"<p>\u4ece\u8ba1\u7b97\u673a\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5efa\u6a21\u65f6\u95f4\u6700\u81ea\u7136\u7684\u683c\u5f0f\u662f\u8868\u793a\u4e00\u4e2a\u6301\u7eed\u65f6\u95f4\u6bb5\u4e0a\u67d0\u4e2a\u70b9\u7684\u5355\u4e00\u5927\u6574\u578b\u6570\u3002\u8fd9\u4e5f\u662f\u65b0\u7684java.time.Instant\u7c7b\u5bf9\u65f6\u95f4\u5efa\u6a21\u7684\u65b9\u5f0f\uff0c\u57fa\u672c\u4e0a\u5b83\u662f\u4ee5Unix\u5143\u5e74\u65f6\u95f4\uff08\u4f20\u7edf\u7684\u8bbe\u5b9a\u4e3aUTC\u65f6\u533a1970\u5e741\u67081\u65e5\u5348\u591c\u65f6\u5206\uff09\u5f00\u59cb\u6240\u7ecf\u5386\u7684\u79d2\u6570\u8fdb\u884c\u8ba1\u7b97\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u5411\u9759\u6001\u5de5\u5382\u65b9\u6cd5ofEpochSecond\u4f20\u9012\u4e00\u4e2a\u4ee3\u8868\u79d2\u6570\u7684\u503c\u521b\u5efa\u4e00\u4e2a\u8be5\u7c7b\u7684\u5b9e\u4f8b\u3002\u9759\u6001\u5de5\u5382\u65b9\u6cd5ofEpochSecond\u8fd8\u6709\u4e00\u4e2a\u589e\u5f3a\u7684\u91cd\u8f7d\u7248\u672c\uff0c\u5b83\u63a5\u6536\u7b2c\u4e8c\u4e2a\u4ee5\u7eb3\u79d2\u4e3a\u5355\u4f4d\u7684\u53c2\u6570\u503c\uff0c\u5bf9\u4f20\u5165\u4f5c\u4e3a\u79d2\u6570\u7684\u53c2\u6570\u8fdb\u884c\u8c03\u6574\u3002\u91cd\u8f7d\u7684\u7248\u672c\u4f1a\u8c03\u6574\u7eb3\u79d2\u53c2\u6570\uff0c\u786e\u4fdd\u4fdd\u5b58\u7684\u7eb3\u79d2\u5206\u7247\u57280\u5230999999999\u4e4b\u95f4\u3002\u8fd9\u610f\u5473\u7740\u4e0b\u9762\u8fd9\u4e9b\u5bf9ofEpochSecond\u5de5\u5382\u65b9\u6cd5\u7684\u8c03\u7528\u4f1a\u8fd4\u56de\u51e0\u4e4e\u540c\u6837\u7684Instant\u5bf9\u8c61\uff1a</p> <p></p> <p>\u6b63\u5982\u4f60\u5df2\u7ecf\u5728LocalDate\u53ca\u5176\u4ed6\u4e3a\u4fbf\u4e8e\u9605\u8bfb\u800c\u8bbe\u8ba1\u7684\u65e5\u671f-\u65f6\u95f4\u7c7b\u4e2d\u6240\u770b\u5230\u7684\u90a3\u6837\uff0cInstant\u7c7b\u4e5f\u652f\u6301\u9759\u6001\u5de5\u5382\u65b9\u6cd5now\uff0c\u5b83\u80fd\u591f\u5e2e\u4f60\u83b7\u53d6\u5f53\u524d\u65f6\u523b\u7684\u65f6\u95f4\u6233\u3002\u6211\u4eec\u60f3\u8981\u7279\u522b\u5f3a\u8c03\u4e00\u70b9\uff0cInstant\u7684\u8bbe\u8ba1\u521d\u8877\u662f\u4e3a\u4e86\u4fbf\u4e8e\u673a\u5668\u4f7f\u7528\u3002\u5b83\u5305\u542b\u7684\u662f\u7531\u79d2\u53ca\u7eb3\u79d2\u6240\u6784\u6210\u7684\u6570\u5b57\u3002\u6240\u4ee5\uff0c\u5b83\u65e0\u6cd5\u5904\u7406\u90a3\u4e9b\u6211\u4eec\u975e\u5e38\u5bb9\u6613\u7406\u89e3\u7684\u65f6\u95f4\u5355\u4f4d</p>"},{"location":"java/java8/#durationperiod","title":"\u5b9a\u4e49Duration\u6216Period","text":"<p>\u76ee\u524d\u4e3a\u6b62\uff0c\u4f60\u770b\u5230\u7684\u6240\u6709\u7c7b\u90fd\u5b9e\u73b0\u4e86Temporal\u63a5\u53e3\uff0cTemporal\u63a5\u53e3\u5b9a\u4e49\u4e86\u5982\u4f55\u8bfb\u53d6\u548c\u64cd\u7eb5\u4e3a\u65f6\u95f4\u5efa\u6a21\u7684\u5bf9\u8c61\u7684\u503c\u3002</p> <p>Duration\u7c7b\u662f\u8868\u793a\u4e24\u4e2aTemporal\u5bf9\u8c61\u4e4b\u95f4\u7684\u95f4\u9694\u3002</p> <pre><code>Duration d1=Duration.between(time1, time2);\nDuration d1=Duration.between(dateTime1, dateTime2);\nDuration d2=Duration.between(instant1, instant2);\n</code></pre> <p>\u5982\u679c\u4f60\u9700\u8981\u4ee5\u5e74\u3001\u6708\u6216\u8005\u65e5\u7684\u65b9\u5f0f\u5bf9\u591a\u4e2a\u65f6\u95f4\u5355\u4f4d\u5efa\u6a21\uff0c\u53ef\u4ee5\u4f7f\u7528Period\u7c7b\u3002\u4f7f\u7528\u8be5\u7c7b\u7684\u5de5\u5382\u65b9\u6cd5between\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u5f97\u5230\u4e24\u4e2aLocalDate\u4e4b\u95f4\u7684\u65f6\u957f</p> <pre><code>Period tenDays=Period.between(LocalDate.of(2014, 3, 8),\n                              LocalDate.of(2014, 3, 18));\n\n// \u4e0d\u4ec5\u53ef\u4ee5\u4ee5\u4e24\u4e2atemporal\u5bf9\u8c61\u7684\u5dee\u503c\u7684\u65b9\u5f0f\u6765\u5b9a\u4e49\uff0c\u8fd8\u80fd\u76f4\u63a5\u521b\u5efa\u5bf9\u5e94\u7684\u5b9e\u4f8b\nDuration threeMinutes=Duration.of(3, ChronoUnit.MINUTES);\n\nPeriod tenDays=Period.ofDays(10);\nPeriod threeWeeks=Period.ofWeeks(3);\nPeriod twoYearsSixMonthsOneDay=Period.of(2, 6, 1);\n</code></pre> <p>Duration\u7c7b\u548cPeriod\u7c7b\u5171\u4eab\u4e86\u5f88\u591a\u76f8\u4f3c\u7684\u65b9\u6cd5</p> <p></p>"},{"location":"java/java8/#_14","title":"\u64cd\u7eb5\u65e5\u671f","text":"<p>\u5982\u679c\u4f60\u5df2\u7ecf\u6709\u4e00\u4e2aLocalDate\u5bf9\u8c61\uff0c\u60f3\u8981\u521b\u5efa\u5b83\u7684\u4e00\u4e2a\u4fee\u6539\u7248\uff0c\u6700\u76f4\u63a5\u4e5f\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u4f7f\u7528withAttribute\u65b9\u6cd5\u3002withAttribute\u65b9\u6cd5\u4f1a\u521b\u5efa\u5bf9\u8c61\u7684\u4e00\u4e2a\u526f\u672c\uff0c\u5e76\u6309\u7167\u9700\u8981\u4fee\u6539\u5b83\u7684\u5c5e\u6027\u3002\u6ce8\u610f\uff0c\u4e0b\u9762\u7684\u8fd9\u6bb5\u4ee3\u7801\u4e2d\u6240\u6709\u7684\u65b9\u6cd5\u90fd\u8fd4\u56de\u4e00\u4e2a\u4fee\u6539\u4e86\u5c5e\u6027\u7684\u5bf9\u8c61\u3002\u5b83\u4eec\u90fd\u4e0d\u4f1a\u4fee\u6539\u539f\u6765\u7684\u5bf9\u8c61\uff01\u66f4\u786e\u5207\u5730\u8bf4\uff0c\u4f7f\u7528get\u548cwith\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06Temporal\u5bf9\u8c61\u503c\u7684\u8bfb\u53d6\u548c\u4fee\u6539\u533a\u5206\u5f00</p> <pre><code>LocalDate date=LocalDate.of(2014, 3, 18);\ndate=date.with(ChronoField.MONTH_OF_YEAR, 9);\ndate=date.plusYears(2).minusDays(10);\ndate.withYear(2011);\n</code></pre> <p>\u50cfLocalDate\u3001LocalTime\u3001LocalDateTime\u4ee5\u53caInstant\u8fd9\u6837\u8868\u793a\u65f6\u95f4\u70b9\u7684\u65e5\u671f-\u65f6\u95f4\u7c7b\u63d0\u4f9b\u4e86\u5927\u91cf\u901a\u7528\u7684\u65b9\u6cd5\uff1a</p> <p></p> <p>\u4f7f\u7528TemporalAdjuster</p> <p>\u6709\u7684\u65f6\u5019\uff0c\u4f60\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u66f4\u52a0\u590d\u6742\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\uff0c\u5c06\u65e5\u671f\u8c03\u6574\u5230\u4e0b\u4e2a\u5468\u65e5\u3001\u4e0b\u4e2a\u5de5\u4f5c\u65e5\uff0c\u6216\u8005\u662f\u672c\u6708\u7684\u6700\u540e\u4e00\u5929\u3002\u8fd9\u65f6\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u91cd\u8f7d\u7248\u672c\u7684with\u65b9\u6cd5\uff0c\u5411\u5176\u4f20\u9012\u4e00\u4e2a\u63d0\u4f9b\u4e86\u66f4\u591a\u5b9a\u5236\u5316\u9009\u62e9\u7684TemporalAdjuster\u5bf9\u8c61\uff0c\u66f4\u52a0\u7075\u6d3b\u5730\u5904\u7406\u65e5\u671f\u3002\u5bf9\u4e8e\u6700\u5e38\u89c1\u7684\u7528\u4f8b\uff0c\u65e5\u671f\u548c\u65f6\u95f4API\u5df2\u7ecf\u63d0\u4f9b\u4e86\u5927\u91cf\u9884\u5b9a\u4e49\u7684TemporalAdjuster\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7TemporalAdjuster\u7c7b\u7684\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u8bbf\u95ee\u5b83\u4eec</p> <p></p> <p></p> <p>\u6b63\u5982\u6211\u4eec\u770b\u5230\u7684\uff0c\u4f7f\u7528TemporalAdjuster\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\u66f4\u52a0\u590d\u6742\u7684\u65e5\u671f\u64cd\u4f5c\uff0c\u800c\u4e14\u8fd9\u4e9b\u65b9\u6cd5\u7684\u540d\u79f0\u4e5f\u975e\u5e38\u76f4\u89c2\uff0c\u65b9\u6cd5\u540d\u57fa\u672c\u5c31\u662f\u95ee\u9898\u9648\u8ff0\u3002\u6b64\u5916\uff0c\u5373\u4f7f\u4f60\u6ca1\u6709\u627e\u5230\u7b26\u5408\u4f60\u8981\u6c42\u7684\u9884\u5b9a\u4e49\u7684TemporalAdjuster\uff0c\u521b\u5efa\u4f60\u81ea\u5df1\u7684TemporalAdjuster\u4e5f\u5e76\u975e\u96be\u4e8b\u3002\u5b9e\u9645\u4e0a\uff0cTemporal-Adjuster\u63a5\u53e3\u53ea\u58f0\u660e\u4e86\u5355\u4e00\u7684\u4e00\u4e2a\u65b9\u6cd5\uff08\u8fd9\u4f7f\u5f97\u5b83\u6210\u4e3a\u4e86\u4e00\u4e2a\u51fd\u6570\u5f0f\u63a5\u53e3</p> <pre><code>@FunctionalInterface\npublic interface TemporalAdjuster {\n    Temporal adjustInto(Temporal temporal);\n}\n</code></pre> <p>\u81ea\u5b9a\u4e49\u4e00\u4e2a\uff0c\u8fd4\u56de\u5728\u4e00\u4e2a\u5de5\u4f5c\u65e5\uff0c\u5982\u679c\u662f\u5468\u4e94\u6216\u5468\u516d\u5c31\u5ef6\u957f\u81f3\u4e0b\u5468\u4e00\u3002\u5f88\u597d\u7528\uff01</p> <p></p> <pre><code>TemporalAdjuster nextWorkingDay=TemporalAdjusters.ofDateAdjuster(\n    temporal-&gt; {\n        DayOfWeek dow=\n            DayOfWeek.of(temporal.get(ChronoField.DAY_OF_WEEK));\n        int dayToAdd=1;\n        if (dow==DayOfWeek.FRIDAY) dayToAdd=3;\n        if (dow==DayOfWeek.SATURDAY) dayToAdd=2;\n        return temporal.plus(dayToAdd, ChronoUnit.DAYS);\n    });\n\ndate=date.with(nextWorkingDay);\n</code></pre>"},{"location":"java/java8/#_15","title":"\u89e3\u6790\u548c\u683c\u5f0f\u5316\u65e5\u671f","text":"<p>\u65b0\u7684java.time.format\u5305\u4e2d\uff0c\u6700\u91cd\u8981\u7684\u7c7b\u662fDateTime-Formatter\uff0c\u7528\u6765\u89e3\u6790\u548c\u683c\u5f0f\u5316\u65e5\u671f\u3002\u548c\u8001\u7684java.util.DateFormat\u76f8\u6bd4\u8f83\uff0c\u6240\u6709\u7684DateTimeFormatter\u5b9e\u4f8b\u90fd\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u3002\u6240\u4ee5\uff0c\u4f60\u80fd\u591f\u4ee5\u5355\u4f8b\u6a21\u5f0f\u521b\u5efa\u683c\u5f0f\u5668\u5b9e\u4f8b\uff0c\u5c31\u50cfDateTimeFormatter\u6240\u5b9a\u4e49\u7684\u90a3\u4e9b\u5e38\u91cf\uff0c\u5e76\u80fd\u5728\u591a\u4e2a\u7ebf\u7a0b\u95f4\u5171\u4eab\u8fd9\u4e9b\u5b9e\u4f8b\u3002</p> <pre><code>// \u89e3\u6790\u5b57\u7b26\u4e32\nLocalDate date1=LocalDate.parse(\"20140318\",\n                                DateTimeFormatter.BASIC_ISO_DATE);\nLocalDate date2=LocalDate.parse(\"2014-03-18\",\n                                DateTimeFormatter.ISO_LOCAL_DATE);\n// \u81ea\u5b9a\u4e49DateTimeFormatter\nDateTimeFormatter formatter=DateTimeFormatter.ofPattern(\"dd/MM/yyyy\");\nLocalDate date1=LocalDate.of(2014, 3, 18);\nString formattedDate=date1.format(formatter);\nLocalDate date2=LocalDate.parse(formattedDate, formatter);\n</code></pre> <p>\u5982\u679c\u4f60\u8fd8\u9700\u8981\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0cDateTimeFormatterBuilder\u7c7b\u8fd8\u63d0\u4f9b\u4e86\u66f4\u590d\u6742\u7684\u683c\u5f0f\u5668\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u6070\u5f53\u7684\u65b9\u6cd5\uff0c\u4e00\u6b65\u4e00\u6b65\u5730\u6784\u9020\u81ea\u5df1\u7684\u683c\u5f0f\u5668\u3002\u53e6\u5916\uff0c\u5b83\u8fd8\u63d0\u4f9b\u4e86\u975e\u5e38\u5f3a\u5927\u7684\u89e3\u6790\u529f\u80fd\uff0c\u6bd4\u5982\u533a\u5206\u5927\u5c0f\u5199\u7684\u89e3\u6790\u3001\u67d4\u6027\u89e3\u6790\uff08\u5141\u8bb8\u89e3\u6790\u5668\u4f7f\u7528\u542f\u53d1\u5f0f\u7684\u673a\u5236\u53bb\u89e3\u6790\u8f93\u5165\uff0c\u4e0d\u7cbe\u786e\u5730\u5339\u914d\u6307\u5b9a\u7684\u6a21\u5f0f\uff09\u3001\u586b\u5145\uff0c\u4ee5\u53ca\u5728\u683c\u5f0f\u5668\u4e2d\u6307\u5b9a\u53ef\u9009\u8282</p> <pre><code>DateTimeFormatter italianFormatter=new DateTimeFormatterBuilder()\n    .appendText(ChronoField.DAY_OF_MONTH)\n    .appendLiteral(\". \")\n    .appendText(ChronoField.MONTH_OF_YEAR)\n    .appendLiteral(\" \")\n    .appendText(ChronoField.YEAR)\n    .parseCaseInsensitive()\n    .toFormatter(Locale.ITALIAN);\n</code></pre>"},{"location":"java/java8/#_16","title":"\u5904\u7406\u4e0d\u540c\u7684\u65f6\u533a","text":"<p>\u65b0\u7684java.time.ZoneId\u7c7b\u662f\u8001\u7248java.util.TimeZone\u7684\u66ff\u4ee3\u54c1\u3002</p> <p>\u6bcf\u4e2a\u7279\u5b9a\u7684ZoneId\u5bf9\u8c61\u90fd\u7531\u4e00\u4e2a\u5730\u533aID\u6807\u8bc6\uff0c\u6bd4\u5982\uff1a\u5730\u533aID\u90fd\u4e3a\u201c{\u533a\u57df}/{\u57ce\u5e02}\u201d\u7684\u683c\u5f0f\uff0c\u8fd9\u4e9b\u5730\u533a\u96c6\u5408\u7684\u8bbe\u5b9a\u90fd\u7531\u82f1\u7279\u7f51\u7f16\u53f7\u5206\u914d\u673a\u6784\uff08IANA\uff09\u7684\u65f6\u533a\u6570\u636e\u5e93\u63d0\u4f9b</p> <pre><code>ZoneId romeZone=ZoneId.of(\"Europe/Rome\");\n\n// \u5c06\u4e00\u4e2a\u8001\u7684\u65f6\u533a\u5bf9\u8c61\u8f6c\u6362\u4e3aZoneId\n ZoneId zoneId=TimeZone.getDefault().toZoneId();\n</code></pre> <p>\u4e00\u65e6\u5f97\u5230\u4e00\u4e2aZoneId\u5bf9\u8c61\uff0c\u4f60\u5c31\u53ef\u4ee5\u5c06\u5b83\u4e0eLocalDate\u3001LocalDateTime\u6216\u8005\u662fInstant\u5bf9\u8c61\u6574\u5408\u8d77\u6765\uff0c\u6784\u9020\u4e3a\u4e00\u4e2aZonedDateTime\u5b9e\u4f8b\uff0c\u5b83\u4ee3\u8868\u4e86\u76f8\u5bf9\u4e8e\u6307\u5b9a\u65f6\u533a\u7684\u65f6\u95f4\u70b9</p> <pre><code>LocalDate date=LocalDate.of(2014, Month.MARCH, 18);\nZonedDateTime zdt1=date.atStartOfDay(romeZone);\n\nLocalDateTime dateTime=LocalDateTime.of(2014, Month.MARCH, 18, 13, 45);\nZonedDateTime zdt2=dateTime.atZone(romeZone);\n\nInstant instant=Instant.now();\nZonedDateTime zdt3=instant.atZone(romeZone);\n\n// LocalDateTime\u548cInstant\u76f8\u4e92\u8f6c\u6362\nLocalDateTime dateTime=LocalDateTime.of(2014, Month.MARCH, 18, 13, 45);\nInstant instantFromDateTime=dateTime.toInstant(romeZone);\nInstant instant=Instant.now();\nLocalDateTime timeFromInstant=LocalDateTime.ofInstant(instant, romeZone);\n</code></pre> <p></p> <p>\u53e6\u4e00\u79cd\u6bd4\u8f83\u901a\u7528\u7684\u8868\u8fbe\u65f6\u533a\u7684\u65b9\u5f0f\u662f\u5229\u7528\u5f53\u524d\u65f6\u533a\u548cUTC/\u683c\u6797\u5c3c\u6cbb\u7684\u56fa\u5b9a\u504f\u5dee\u3002\u6bd4\u5982\uff0c\u57fa\u4e8e\u8fd9\u4e2a\u7406\u8bba\uff0c\u4f60\u53ef\u4ee5\u8bf4\u201c\u7ebd\u7ea6\u843d\u540e\u4e8e\u4f26\u65665\u5c0f\u65f6\u201d\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528ZoneOffset\u7c7b\uff0c\u5b83\u662fZoneId\u7684\u4e00\u4e2a\u5b50\u7c7b\uff0c\u8868\u793a\u7684\u662f\u5f53\u524d\u65f6\u95f4\u548c\u4f26\u6566\u683c\u6797\u5c3c\u6cbb\u5b50\u5348\u7ebf\u65f6\u95f4\u7684\u5dee\u5f02\uff1a</p> <pre><code>ZoneOffset newYorkOffset=ZoneOffset.of(\"-05:00\");\n// ZoneOffset\u662fZoneId\u7684\u4e00\u4e2a\u5b50\u7c7b\nLocalDateTime dateTime=LocalDateTime.of(2014, Month.MARCH, 18, 13, 45);\nOffsetDateTime dateTimeInNewYork=OffsetDateTime.of(date, newYorkOffset);\n</code></pre>"},{"location":"java/tomcat/","title":"tomcat\u7684\u7c7b\u52a0\u8f7d\u673a\u5236","text":"<p>\u9996\u5148\u5206\u6790\u4e0btomcat\u8981\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\uff1f</p> <ol> <li>\u4e00\u4e2aweb\u5bb9\u5668\u53ef\u80fd\u9700\u8981\u90e8\u7f72\u4e24\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u4f9d\u8d56\u540c\u4e00\u4e2a\u7b2c\u4e09\u65b9\u7c7b\u5e93\u7684\u4e0d\u540c\u7248\u672c\uff0c\u4e0d\u80fd\u8981\u6c42\u540c\u4e00\u4e2a\u7c7b\u5e93\u5728\u540c\u4e00\u4e2a\u670d\u52a1\u5668\u53ea\u6709\u4e00\u4efd\uff0c\u56e0\u6b64\u8981\u4fdd\u8bc1\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u7c7b\u5e93\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u4fdd\u8bc1\u76f8\u4e92\u9694\u79bb\u3002 </li> <li>\u90e8\u7f72\u5728\u540c\u4e00\u4e2aweb\u5bb9\u5668\u4e2d\u76f8\u540c\u7684\u7c7b\u5e93\u76f8\u540c\u7684\u7248\u672c\u53ef\u4ee5\u5171\u4eab\u3002\u5426\u5219\uff0c\u5982\u679c\u670d\u52a1\u5668\u670910\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u90a3\u4e48\u8981\u670910\u4efd\u76f8\u540c\u7684\u7c7b\u5e93\u52a0\u8f7d\u8fdb\u865a\u62df\u673a\uff0c\u8fd9\u662f\u626f\u6de1\u7684\u3002 </li> <li>web\u5bb9\u5668\u4e5f\u6709\u81ea\u5df1\u4f9d\u8d56\u7684\u7c7b\u5e93\uff0c\u4e0d\u80fd\u4e8e\u5e94\u7528\u7a0b\u5e8f\u7684\u7c7b\u5e93\u6df7\u6dc6\u3002\u57fa\u4e8e\u5b89\u5168\u8003\u8651\uff0c\u5e94\u8be5\u8ba9\u5bb9\u5668\u7684\u7c7b\u5e93\u548c\u7a0b\u5e8f\u7684\u7c7b\u5e93\u9694\u79bb\u5f00\u6765\u3002 </li> <li>web\u5bb9\u5668\u8981\u652f\u6301jsp\u7684\u4fee\u6539\uff0c\u6211\u4eec\u77e5\u9053\uff0cjsp \u6587\u4ef6\u6700\u7ec8\u4e5f\u662f\u8981\u7f16\u8bd1\u6210class\u6587\u4ef6\u624d\u80fd\u5728\u865a\u62df\u673a\u4e2d\u8fd0\u884c\uff0c\u4f46\u7a0b\u5e8f\u8fd0\u884c\u540e\u4fee\u6539jsp\u5df2\u7ecf\u662f\u53f8\u7a7a\u89c1\u60ef\u7684\u4e8b\u60c5\uff0c\u5426\u5219\u8981\u4f60\u4f55\u7528\uff1f \u6240\u4ee5\uff0cweb\u5bb9\u5668\u9700\u8981\u652f\u6301 jsp \u4fee\u6539\u540e\u4e0d\u7528\u91cd\u542f\u3002</li> </ol> <p></p> <ul> <li>commonLoader\uff1aTomcat\u6700\u57fa\u672c\u7684\u7c7b\u52a0\u8f7d\u5668\uff0c\u52a0\u8f7d\u8def\u5f84\u4e2d\u7684class\u53ef\u4ee5\u88abTomcat\u5bb9\u5668\u672c\u8eab\u4ee5\u53ca\u5404\u4e2aWebapp\u8bbf\u95ee\uff1b</li> <li>catalinaLoader\uff1aTomcat\u5bb9\u5668\u79c1\u6709\u7684\u7c7b\u52a0\u8f7d\u5668\uff0c\u52a0\u8f7d\u8def\u5f84\u4e2d\u7684class\u5bf9\u4e8eWebapp\u4e0d\u53ef\u89c1\uff1b</li> <li>sharedLoader\uff1a\u5404\u4e2aWebapp\u5171\u4eab\u7684\u7c7b\u52a0\u8f7d\u5668\uff0c\u52a0\u8f7d\u8def\u5f84\u4e2d\u7684class\u5bf9\u4e8e\u6240\u6709Webapp\u53ef\u89c1\uff0c\u4f46\u662f\u5bf9\u4e8eTomcat\u5bb9\u5668\u4e0d\u53ef\u89c1\uff1b</li> <li>WebappClassLoader\uff1a\u5404\u4e2aWebapp\u79c1\u6709\u7684\u7c7b\u52a0\u8f7d\u5668\uff0c\u52a0\u8f7d\u8def\u5f84\u4e2d\u7684class\u53ea\u5bf9\u5f53\u524dWebapp\u53ef\u89c1\uff1b</li> </ul> <p>Tomcat\u7684\u7c7b\u52a0\u8f7d\u673a\u5236\u662f\u8fdd\u53cd\u4e86\u53cc\u4eb2\u59d4\u6258\u539f\u5219</p>"},{"location":"java/tomcat/#tomcat_1","title":"tomcat\u7684\u7c7b\u52a0\u8f7d\u6d41\u7a0b","text":"<pre><code>public Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException {\n    synchronized (getClassLoadingLock(name)) {\n        Class&lt;?&gt; clazz = null;\n        //1. \u5148\u5728\u672c\u5730cache\u67e5\u627e\u8be5\u7c7b\u662f\u5426\u5df2\u7ecf\u52a0\u8f7d\u8fc7\n        clazz = findLoadedClass0(name);\n        if (clazz != null) {\n            if (resolve)\n                resolveClass(clazz);\n            return clazz;\n        }\n        //2. \u4ece\u7cfb\u7edf\u7c7b\u52a0\u8f7d\u5668\u7684cache\u4e2d\u67e5\u627e\u662f\u5426\u52a0\u8f7d\u8fc7\n        clazz = findLoadedClass(name);\n        if (clazz != null) {\n            if (resolve)\n                resolveClass(clazz);\n            return clazz;\n        }\n       // 3. \u5c1d\u8bd5\u7528ExtClassLoader\u7c7b\u52a0\u8f7d\u5668\u7c7b\u52a0\u8f7d\n        ClassLoader javaseLoader = getJavaseClassLoader();\n        try {\n            clazz = javaseLoader.loadClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return clazz;\n            }\n        } catch (ClassNotFoundException e) {\n            // Ignore\n        }\n        // 4. \u5c1d\u8bd5\u5728\u672c\u5730\u76ee\u5f55\u641c\u7d22class\u5e76\u52a0\u8f7d\n        try {\n            clazz = findClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return clazz;\n            }\n        } catch (ClassNotFoundException e) {\n            // Ignore\n        }\n        // 5. \u5c1d\u8bd5\u7528\u7cfb\u7edf\u7c7b\u52a0\u8f7d\u5668(\u4e5f\u5c31\u662fAppClassLoader)\u6765\u52a0\u8f7d\n            try {\n                clazz = Class.forName(name, false, parent);\n                if (clazz != null) {\n                    if (resolve)\n                        resolveClass(clazz);\n                    return clazz;\n                }\n            } catch (ClassNotFoundException e) {\n                // Ignore\n            }\n       }\n    //6. \u4e0a\u8ff0\u8fc7\u7a0b\u90fd\u52a0\u8f7d\u5931\u8d25\uff0c\u629b\u51fa\u5f02\u5e38\n    throw new ClassNotFoundException(name);\n}\n</code></pre> <ol> <li> <p>\u5148\u5728\u672c\u5730cache\u67e5\u627e\u8be5\u7c7b\u662f\u5426\u5df2\u7ecf\u52a0\u8f7d\u8fc7\uff0c\u770b\u770b Tomcat \u6709\u6ca1\u6709\u52a0\u8f7d\u8fc7\u8fd9\u4e2a\u7c7b\u3002</p> </li> <li> <p>\u5982\u679cTomcat \u6ca1\u6709\u52a0\u8f7d\u8fc7\u8fd9\u4e2a\u7c7b\uff0c\u5219\u4ece\u7cfb\u7edf\u7c7b\u52a0\u8f7d\u5668\u7684cache\u4e2d\u67e5\u627e\u662f\u5426\u52a0\u8f7d\u8fc7\u3002</p> </li> <li> <p>\u5982\u679c\u6ca1\u6709\u52a0\u8f7d\u8fc7\u8fd9\u4e2a\u7c7b\uff0c\u5c1d\u8bd5\u7528ExtClassLoader\u7c7b\u52a0\u8f7d\u5668\u7c7b\u52a0\u8f7d\uff0c\u91cd\u70b9\u6765\u4e86\uff0c\u8fd9\u91cc\u5e76\u6ca1\u6709\u9996\u5148\u4f7f\u7528 AppClassLoader \u6765\u52a0\u8f7d\u7c7b\u3002\u8fd9\u91ccTomcat \u7684 WebAPPClassLoader \u8fdd\u80cc\u4e86\u53cc\u4eb2\u59d4\u6d3e\u673a\u5236\uff0c\u76f4\u63a5\u4f7f\u7528\u4e86 ExtClassLoader\u6765\u52a0\u8f7d\u7c7b\u3002</p> </li> </ol> <p>\u4f46\u662f\u8fd9\u91cc\u6ce8\u610f ExtClassLoader \u53cc\u4eb2\u59d4\u6d3e\u4f9d\u7136\u6709\u6548\uff0cExtClassLoader \u5c31\u4f1a\u4f7f\u7528 Bootstrap ClassLoader \u6765\u5bf9\u7c7b\u8fdb\u884c\u52a0\u8f7d\uff0c\u4fdd\u8bc1\u4e86 Jre \u91cc\u9762\u7684\u6838\u5fc3\u7c7b\u4e0d\u4f1a\u88ab\u91cd\u590d\u52a0\u8f7d\u3002 \u6bd4\u5982\u5728 Web \u4e2d\u52a0\u8f7d\u4e00\u4e2a Object \u7c7b\u3002WebAppClassLoader \u2192 ExtClassLoader \u2192 Bootstrap ClassLoader\uff0c\u8fd9\u4e2a\u52a0\u8f7d\u94fe\uff0c\u5c31\u4fdd\u8bc1\u4e86 Object \u4e0d\u4f1a\u88ab\u91cd\u590d\u52a0\u8f7d\u3002</p> <ol> <li> <p>\u5982\u679c BoostrapClassLoader\uff0c\u6ca1\u6709\u52a0\u8f7d\u6210\u529f\uff0c\u5c31\u4f1a\u8c03\u7528\u81ea\u5df1\u7684 findClass \u65b9\u6cd5\u7531\u81ea\u5df1\u6765\u5bf9\u7c7b\u8fdb\u884c\u52a0\u8f7d\uff0cfindClass \u52a0\u8f7d\u7c7b\u7684\u5730\u5740\u662f\u81ea\u5df1\u672c web \u5e94\u7528\u4e0b\u7684 class\u3002</p> </li> <li> <p>\u52a0\u8f7d\u4f9d\u7136\u5931\u8d25\uff0c\u624d\u4f7f\u7528 AppClassLoader \u7ee7\u7eed\u52a0\u8f7d\u3002</p> </li> <li> <p>\u90fd\u6ca1\u6709\u52a0\u8f7d\u6210\u529f\u7684\u8bdd\uff0c\u629b\u51fa\u5f02\u5e38\u3002</p> </li> </ol> <p>\u603b\u7ed3\u4e00\u4e0b\u4ee5\u4e0a\u6b65\u9aa4\uff0cWebAppClassLoader \u52a0\u8f7d\u7c7b\u7684\u65f6\u5019\uff0c\u6545\u610f\u6253\u7834\u4e86JVM \u53cc\u4eb2\u59d4\u6d3e\u673a\u5236\uff0c\u7ed5\u5f00\u4e86 AppClassLoader\uff0c\u76f4\u63a5\u5148\u4f7f\u7528 ExtClassLoader \u6765\u52a0\u8f7d\u7c7b\uff0c\u4fdd\u8bc1\u4e86\u57fa\u7840\u7c7b\u4e0d\u4f1a\u88ab\u540c\u65f6\u52a0\u8f7d\u3002</p> <p>\u800c\u7b2c4\u6b65\u5148\u81ea\u5df1\u52a0\u8f7d\uff0c\u7136\u540e\u624d\u7b2c5\u6b65\u6559\u7531AppClassLoader\u52a0\u8f7d\uff0c\u4fdd\u8bc1\u4e86\u5728\u540c\u4e00\u4e2a Tomcat \u4e0b\u4e0d\u540c web \u4e4b\u95f4\u7684 class \u662f\u76f8\u4e92\u9694\u79bb\u7684\u3002</p>"},{"location":"java/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/","title":"\u7ebf\u4e0a\u95ee\u9898","text":""},{"location":"java/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/#fullgc","title":"\u4e00\u6b21\u7ebf\u4e0aFullGC","text":"<p>\u73b0\u8c61\uff1a\u76d1\u63a7\u544a\u8b66\u63d0\u793afullGC\u6b21\u6570\u5f02\u5e38\u589e\u52a0\uff0c\u51e0\u5206\u949f\u5c31\u4e00\u6b21fullGC\u3002\u6392\u67e5\u8fc7\u7a0b\u4e2d\u4e1a\u52a1\u901a\u77e5\u53d1\u9001\u7269\u54c1\u5931\u8d25 \u6392\u67e5\uff1a1. \u65e2\u7136\u662fFULL GC\uff0c\u90a3\u5c31\u628a\u5185\u5b58dump\u51fa\u6765\uff08\u516c\u53f8\u6b63\u597d\u63d0\u4f9b\u7684\u5de5\u5177\uff0c\u4f1a\u6682\u65f6\u6458\u9664\u7ebf\u4e0a\u6d41\u91cf\uff09\uff0c\u4f46\u662f\u5806\u7a7a\u95f4200M\u5e76\u4e0d\u5927\uff0c\u5806\u5916\u5185\u5b581.5M\u4e5f\u4e0d\u5927\uff0c\u770b\u4e0d\u51fa\u6709\u5565\u95ee\u9898\u30022. \u67e5\u770b\u65e5\u5fd7\uff0c\u6709error\u63d0\u793a\u5143\u7a7a\u95f4\u6ea2\u51fa\uff0c\u67e5\u770b\u8bbe\u7f6e\u7684256M\uff0c\u7136\u540e\u67e5\u770b\u5806\u6808\u4fe1\u606f\uff0c\u627e\u5230\u53ef\u7591\u4ee3\u7801\u7ed9\u5927\u8c61\u53d1\u6d88\u606f\uff0cnew NotifyClient \u3002 3.\u67e5\u770bJVM\u5185\u5b58\u76d1\u63a7\uff0c\u53d1\u73b0\u5143\u7a7a\u95f4\u5728\u4e0a\u6b21\u53d1\u5e03\u540e4\u5929\u5185\u662f\u4e0d\u65ad\u589e\u957f\u7684\uff0c\u57fa\u672c\u4e0a10\u4e2a\u5c0f\u65f6\u589e\u957f10%\uff08\u5143\u7a7a\u95f4\u5927\u5c0f\u8bbe\u7f6e\u7684256M\uff09</p> <p>\u7ebf\u4e0b\u590d\u663e\uff1a \u6ca1\u6709\u590d\u73b0\u51fa\u6765\uff0c\u4f46\u57fa\u672c\u786e\u5b9a\u95ee\u9898 \u89e3\u51b3\uff1a\u786e\u5b9a\u53ef\u7591\u4ee3\u7801\u4f46\u662f\u7ebf\u4e0b\u6ca1\u6709\u590d\u73b0\uff0c\u6240\u4ee5\u51b3\u5b9a\u5148\u91cd\u542f\uff0c\u5143\u7a7a\u95f4\u6062\u590d\u6b63\u5e38\u3002\u665a\u4e0a\u6b63\u597d\u53d1\u5e03\uff0c\u628a\u4ee3\u7801\u6539\u6210\u5355\u4f8bBean\uff08\u672c\u6765\u4e5f\u5e94\u8be5\u8fd9\u6837\u5199\uff09\u3002\u7b2c\u4e8c\u5929\u89c2\u5bdf\u5143\u7a7a\u95f4\u57fa\u672c\u4e0d\u53d8\uff0c\u7a33\u5b9a\u572820% \u5de6\u53f3\u3002\u4ecd\u9700\u8981\u518d\u89c2\u5bdf\u51e0\u5929</p> <p>\u4e8b\u540e\u5206\u6790\uff1a \u539f\u56e0\uff1a\u4e00\u4f4d\u5916\u5305\u540c\u4e8b\u5199\u7684\u4ee3\u7801\uff0c\u5c31\u662f\u53d1\u6d88\u606fRPC\u8c03\u7528\uff0c\u7528\u5230client\uff0c\u4ed6\u6bcf\u6b21\u8c03\u7528\u90fd\u91cd\u65b0new client\uff0c\u91cc\u9762\u4f1a\u901a\u8fc7\u53cd\u5c04\u521b\u5efaThrift\u7c7b\uff0c\u5c5e\u6027\u76f8\u540c\u4f46\u662f\u7c7b\u540d\u4e0d\u540c\uff0c\u5bfc\u81f4\u4e0d\u65ad\u52a0\u8f7d\u7c7b\u5230\u5143\u7a7a\u95f4\uff0c\uff0c\u7136\u540e4\u5929\u540e\u5bfc\u81f4\u5143\u7a7a\u95f4\u6ea2\u51fa\uff0c\u7206\u53d1\u51fa\u95ee\u9898</p>"},{"location":"java/concurrent/park/","title":"Park","text":"<p>\u597d\u7684\uff0c\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u7ecf\u5178\u7684Java\u5e76\u53d1\u9762\u8bd5\u9898\u3002\u6211\u4eec\u6765\u8be6\u7ec6\u89e3\u6790 <code>LockSupport.park()</code> \u548c <code>Thread.sleep()</code> \u7684\u533a\u522b\u3002</p>"},{"location":"java/concurrent/park/#_1","title":"\u4e00\u3001\u6838\u5fc3\u533a\u522b\u5bf9\u6bd4","text":"\u7279\u6027 <code>LockSupport.park()</code> <code>Thread.sleep()</code> \u6240\u5c5e\u5305 <code>java.util.concurrent.locks.LockSupport</code> <code>java.lang.Thread</code> \u5524\u9192\u673a\u5236 \u9700\u8981\u663e\u5f0f\u8c03\u7528 <code>unpark(thread)</code> \u8d85\u65f6\u81ea\u52a8\u5524\u9192\uff0c\u53ef\u88ab <code>interrupt()</code> \u4e2d\u65ad \u4e2d\u65ad\u54cd\u5e94 \u88ab\u4e2d\u65ad\u65f6\u7acb\u5373\u8fd4\u56de\uff0c\u4e0d\u4f1a\u629b\u5f02\u5e38 \u88ab\u4e2d\u65ad\u65f6\u629b\u51faInterruptedException \u9501\u7684\u72b6\u6001 \u4e0d\u4f1a\u91ca\u653e\u5df2\u6301\u6709\u7684\u9501 \u4e0d\u4f1a\u91ca\u653e\u5df2\u6301\u6709\u7684\u9501 \u65f6\u95f4\u7cbe\u5ea6 \u65e0\u9650\u671f\u6216\u7eb3\u79d2\u7ea7\u8d85\u65f6 \u6beb\u79d2\u7ea7\uff08\u6216\u6beb\u79d2+\u7eb3\u79d2\uff09 \u8bb8\u53ef\u8bc1\u673a\u5236 \u6709\uff08\u6838\u5fc3\u7279\u6027\uff09 \u65e0 \u9762\u5411\u5bf9\u8c61 \u4ee5\u7ebf\u7a0b\u5bf9\u8c61\u4e3a\u53c2\u6570\u64cd\u4f5c\u5176\u4ed6\u7ebf\u7a0b \u9759\u6001\u65b9\u6cd5\uff0c\u64cd\u4f5c\u5f53\u524d\u7ebf\u7a0b"},{"location":"java/concurrent/park/#parkunpark","title":"\u4e8c\u3001\u6df1\u5165\u7406\u89e3 park/unpark \u673a\u5236","text":""},{"location":"java/concurrent/park/#permit","title":"\u8bb8\u53ef\u8bc1\uff08Permit\uff09\u6982\u5ff5","text":"<p><code>LockSupport</code> \u4f7f\u7528\u4e86\u4e00\u4e2a\u9690\u5f0f\u7684\"\u8bb8\u53ef\u8bc1\"\u673a\u5236\uff1a - \u6bcf\u4e2a\u7ebf\u7a0b\u6709\u4e00\u4e2a\u8bb8\u53ef\u8bc1\uff08\u6700\u591a\u4e3a1\uff09 - <code>unpark(thread)</code>\uff1a\u7ed9\u6307\u5b9a\u7ebf\u7a0b\u53d1\u653e\u4e00\u4e2a\u8bb8\u53ef\u8bc1 - <code>park()</code>\uff1a\u6d88\u8017\u4e00\u4e2a\u8bb8\u53ef\u8bc1\uff0c\u5982\u679c\u5df2\u6709\u8bb8\u53ef\u8bc1\u5219\u7acb\u5373\u8fd4\u56de</p>"},{"location":"java/concurrent/park/#_2","title":"\u4ee3\u7801\u793a\u4f8b","text":"<pre><code>import java.util.concurrent.locks.LockSupport;\n\npublic class ParkExample {\n    public static void main(String[] args) throws InterruptedException {\n        Thread thread = new Thread(() -&gt; {\n            System.out.println(\"\u5b50\u7ebf\u7a0b\u5f00\u59cb\u6267\u884c\");\n\n            // \u60c5\u51b51\uff1a\u5148unpark\u540epark - \u7acb\u5373\u7ee7\u7eed\u6267\u884c\n            // LockSupport.unpark(Thread.currentThread());\n\n            System.out.println(\"\u5b50\u7ebf\u7a0b\u5373\u5c06park\");\n            LockSupport.park(); // \u7b49\u5f85\u8bb8\u53ef\u8bc1\n            System.out.println(\"\u5b50\u7ebf\u7a0b\u88ab\u5524\u9192\");\n        });\n\n        thread.start();\n        Thread.sleep(1000); // \u4e3b\u7ebf\u7a0b\u7b49\u5f851\u79d2\n\n        System.out.println(\"\u4e3b\u7ebf\u7a0bunpark\u5b50\u7ebf\u7a0b\");\n        LockSupport.unpark(thread); // \u53d1\u653e\u8bb8\u53ef\u8bc1\n    }\n}\n</code></pre>"},{"location":"java/concurrent/park/#_3","title":"\u4e09\u3001\u4f7f\u7528\u573a\u666f\u548c\u4f18\u52bf","text":""},{"location":"java/concurrent/park/#parkunpark_1","title":"\u4ec0\u4e48\u65f6\u5019\u4f7f\u7528 park/unpark\uff1f","text":"<ol> <li> <p>\u6784\u5efa\u9ad8\u7ea7\u540c\u6b65\u5de5\u5177 <pre><code>// \u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684\u9501\nclass SimpleLock {\n    private volatile Thread owner = null;\n\n    public void lock() {\n        Thread current = Thread.currentThread();\n        while (!compareAndSetOwner(null, current)) {\n            LockSupport.park(); // \u7b49\u5f85\u9501\u91ca\u653e\n        }\n    }\n\n    public void unlock() {\n        owner = null;\n        LockSupport.unpark(waitingThread); // \u5524\u9192\u7b49\u5f85\u7ebf\u7a0b\n    }\n}\n</code></pre></p> </li> <li> <p>\u7cbe\u786e\u7684\u7ebf\u7a0b\u63a7\u5236 <pre><code>// \u7ebf\u7a0b\u95f4\u7cbe\u786e\u534f\u8c03\uff0c\u907f\u514dsleep\u7684\u4e0d\u786e\u5b9a\u6027\npublic class ThreadCoordination {\n    private Thread workerThread;\n\n    public void startWorker() {\n        workerThread = new Thread(() -&gt; {\n            while (!Thread.currentThread().isInterrupted()) {\n                // \u6267\u884c\u4efb\u52a1...\n                LockSupport.park(); // \u7b49\u5f85\u4e0b\u4e00\u8f6e\u8c03\u5ea6\n            }\n        });\n        workerThread.start();\n    }\n\n    public void wakeupWorker() {\n        LockSupport.unpark(workerThread); // \u7cbe\u786e\u5524\u9192\n    }\n}\n</code></pre></p> </li> <li> <p>\u6027\u80fd\u654f\u611f\u7684\u7b49\u5f85 <pre><code>// \u5728\u81ea\u65cb\u9501\u4e2d\u51cf\u5c11\u7a7a\u8f6c\nwhile (!canProceed()) {\n    if (spinCount &gt; MAX_SPINS) {\n        LockSupport.parkNanos(1000); // \u77ed\u6682park\u800c\u4e0d\u662f\u5fd9\u7b49\u5f85\n    } else {\n        spinCount++;\n    }\n}\n</code></pre></p> </li> </ol>"},{"location":"java/concurrent/park/#park","title":"park \u7684\u4f18\u52bf","text":"<ol> <li>\u66f4\u7cbe\u786e\u7684\u7ebf\u7a0b\u63a7\u5236\uff1a\u53ef\u4ee5\u7cbe\u786e\u5524\u9192\u7279\u5b9a\u7ebf\u7a0b</li> <li>\u4e0d\u4f1a\u629b\u4e2d\u65ad\u5f02\u5e38\uff1a\u4ee3\u7801\u66f4\u7b80\u6d01\uff0c\u4e0d\u9700\u8981\u5904\u7406\u53d7\u68c0\u5f02\u5e38</li> <li>\u5148\u5524\u9192\u540e\u7b49\u5f85\u4ecd\u6709\u6548\uff1a<code>unpark</code> \u53d1\u751f\u5728 <code>park</code> \u4e4b\u524d\u65f6\uff0c<code>park</code> \u4e0d\u4f1a\u963b\u585e</li> <li>\u9ad8\u6027\u80fd\uff1a\u5e95\u5c42\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u539f\u8bed\uff0c\u6bd4 <code>Object.wait()</code> \u66f4\u9ad8\u6548</li> </ol>"},{"location":"java/concurrent/park/#_4","title":"\u56db\u3001\u9762\u8bd5\u5e38\u89c1\u95ee\u9898","text":""},{"location":"java/concurrent/park/#_5","title":"\u57fa\u7840\u95ee\u9898","text":"<ol> <li> <p>park/sleep \u7684\u4e3b\u8981\u533a\u522b\u662f\u4ec0\u4e48\uff1f</p> <ul> <li>\u5524\u9192\u673a\u5236\u3001\u4e2d\u65ad\u54cd\u5e94\u3001\u8bb8\u53ef\u8bc1\u6982\u5ff5</li> </ul> </li> <li> <p>\u4e3a\u4ec0\u4e48 park \u4e0d\u4f1a\u91ca\u653e\u9501\uff1f</p> <ul> <li>\u56e0\u4e3a park \u662f\u5e95\u5c42\u7684\u7ebf\u7a0b\u963b\u585e\u539f\u8bed\uff0c\u4e0d\u6d89\u53ca\u76d1\u89c6\u5668\u9501</li> </ul> </li> <li> <p>park \u548c wait \u7684\u533a\u522b\uff1f</p> <ul> <li><code>wait()</code> \u5fc5\u987b\u5728 synchronized \u5757\u4e2d\u4f7f\u7528\uff0c\u4f1a\u91ca\u653e\u9501</li> <li><code>park()</code> \u53ef\u4ee5\u5728\u4efb\u4f55\u5730\u65b9\u4f7f\u7528\uff0c\u4e0d\u4f1a\u91ca\u653e\u9501</li> </ul> </li> </ol>"},{"location":"java/concurrent/park/#_6","title":"\u8fdb\u9636\u95ee\u9898","text":"<ol> <li> <p>\u5982\u679c\u5148\u8c03\u7528 unpark \u518d\u8c03\u7528 park\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f</p> <ul> <li>\u7ebf\u7a0b\u4e0d\u4f1a\u963b\u585e\uff0c\u56e0\u4e3a\u8bb8\u53ef\u8bc1\u5df2\u7ecf\u88ab\u6d88\u8d39</li> </ul> </li> <li> <p>park \u88ab\u4e2d\u65ad\u65f6\u4f1a\u600e\u6837\uff1f</p> <ul> <li>\u7acb\u5373\u8fd4\u56de\uff0c\u4f46\u4e0d\u4f1a\u629b\u5f02\u5e38\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>Thread.interrupted()</code> \u68c0\u67e5\u4e2d\u65ad\u72b6\u6001</li> </ul> </li> <li> <p>\u5982\u4f55\u5728 park \u65f6\u8bbe\u7f6e\u8d85\u65f6\uff1f</p> <ul> <li>\u4f7f\u7528 <code>parkNanos(long nanos)</code> \u6216 <code>parkUntil(long deadline)</code></li> </ul> </li> </ol>"},{"location":"java/concurrent/park/#_7","title":"\u5b9e\u6218\u95ee\u9898","text":"<ol> <li> <p>\u4e0b\u9762\u4ee3\u7801\u7684\u8f93\u51fa\u987a\u5e8f\u662f\u4ec0\u4e48\uff1f <pre><code>Thread t = new Thread(() -&gt; {\n    LockSupport.unpark(Thread.currentThread());\n    System.out.println(\"A\");\n    LockSupport.park();\n    System.out.println(\"B\");\n});\nt.start();\n</code></pre> \u7b54\u6848\uff1aA \u548c B \u90fd\u4f1a\u8f93\u51fa\uff0c\u56e0\u4e3a\u5148 unpark \u540e park \u4e0d\u4f1a\u963b\u585e</p> </li> <li> <p>\u8bbe\u8ba1\u9898\uff1a\u7528 park/unpark \u5b9e\u73b0\u751f\u4ea7\u8005\u6d88\u8d39\u8005 <pre><code>class ParkBlockingQueue&lt;T&gt; {\n    private final Queue&lt;T&gt; queue = new LinkedList&lt;&gt;();\n    private final Thread consumerThread;\n\n    public ParkBlockingQueue() {\n        consumerThread = new Thread(() -&gt; {\n            while (!Thread.interrupted()) {\n                if (queue.isEmpty()) {\n                    LockSupport.park();\n                }\n                T item = queue.poll();\n                // \u5904\u7406item...\n            }\n        });\n    }\n\n    public void put(T item) {\n        queue.offer(item);\n        LockSupport.unpark(consumerThread);\n    }\n}\n</code></pre></p> </li> </ol>"},{"location":"java/concurrent/park/#_8","title":"\u4e94\u3001\u6700\u4f73\u5b9e\u8df5\u548c\u6ce8\u610f\u4e8b\u9879","text":"<ol> <li> <p>\u603b\u662f\u68c0\u67e5\u4e2d\u65ad\u72b6\u6001 <pre><code>LockSupport.park();\nif (Thread.interrupted()) {\n    // \u5904\u7406\u4e2d\u65ad\u903b\u8f91\n}\n</code></pre></p> </li> <li> <p>\u907f\u514d\u957f\u65f6\u95f4 park <pre><code>// \u4f7f\u7528\u5e26\u8d85\u65f6\u7684\u7248\u672c\nLockSupport.parkNanos(TimeUnit.SECONDS.toNanos(5));\n</code></pre></p> </li> <li> <p>\u7ed3\u5408 volatile \u53d8\u91cf\u4f7f\u7528 <pre><code>private volatile boolean condition = false;\n\npublic void waitForCondition() {\n    while (!condition) {\n        LockSupport.park();\n    }\n}\n</code></pre></p> </li> </ol>"},{"location":"java/concurrent/park/#_9","title":"\u603b\u7ed3","text":"<ul> <li><code>park/unpark</code> \u662f\u66f4\u5e95\u5c42\u7684\u7ebf\u7a0b\u963b\u585e\u673a\u5236\uff0c\u7528\u4e8e\u6784\u5efa\u9ad8\u7ea7\u540c\u6b65\u5de5\u5177</li> <li><code>sleep</code> \u662f\u7b80\u5355\u7684\u5ef6\u65f6\u5de5\u5177\uff0c\u9002\u5408\u7b80\u5355\u7684\u7b49\u5f85\u573a\u666f</li> <li>\u5728\u9700\u8981\u7cbe\u786e\u7ebf\u7a0b\u63a7\u5236\u3001\u6784\u5efa\u9501\u3001\u6027\u80fd\u4f18\u5316\u65f6\u9009\u62e9 <code>park/unpark</code></li> <li>\u5728\u7b80\u5355\u5ef6\u65f6\u573a\u666f\u4f7f\u7528 <code>sleep</code> \u66f4\u76f4\u89c2</li> </ul> <p>\u638c\u63e1\u8fd9\u4e9b\u533a\u522b\u5bf9\u4e8e\u6df1\u5165\u7406\u89e3Java\u5e76\u53d1\u7f16\u7a0b\u548c\u5e94\u5bf9\u6280\u672f\u9762\u8bd5\u90fd\u975e\u5e38\u91cd\u8981\uff01</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/","title":"\u5e76\u53d1\u7f16\u7a0b","text":""},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#_1","title":"\u57fa\u672c\u6982\u5ff5","text":"<p>\u5e76\u53d1\u7f16\u7a0b\u7684\u4e09\u4e2a\u6838\u5fc3\u95ee\u9898\uff1a - \u4e92\u65a5\uff1a\u4fdd\u8bc1\u539f\u5b50\u6027\uff0c\u4e34\u754c\u533a\u4ee3\u7801\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c - \u540c\u6b65\uff1a\u7ebf\u7a0b\u6267\u884c\u987a\u5e8f - \u901a\u4fe1\u95ee\u9898\uff1a\u7ebf\u7a0b\u95f4\u4f20\u9012\u4fe1\u606f\uff0c\u5206\u5de5</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#_2","title":"\u7ba1\u7a0b","text":"<p>\u7ba1\u7a0b\u5bf9\u5e94\u7684\u82f1\u6587\u662fmonitor\uff0c\u6307\u7684\u662f\u7ba1\u7406\u5171\u4eab\u53d8\u91cf\u4ee5\u53ca\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u64cd\u4f5c\u8fc7\u7a0b\uff0c\u8ba9\u4ed6\u4eec\u652f\u6301\u5e76\u53d1\u3002 \u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u4e66\u4e0a\u4ecb\u7ecd\uff0c\u7ba1\u7a0b\u662f\u89e3\u51b3\u5e76\u53d1\u95ee\u9898\u7684\u6838\u5fc3\u6280\u672f\uff0c\u5b83\u548c\u4fe1\u53f7\u91cf\u662f\u7b49\u4ef7\u7684\uff0c\u5373\u7528\u7ba1\u7a0b\u80fd\u5b9e\u73b0\u4fe1\u53f7\u91cf\uff0c\u4e5f\u80fd\u7528\u4fe1\u53f7\u91cf\u5b9e\u73b0\u7ba1\u7a0b\u3002 \u90a3\u4e3a\u5565java\u4e0d\u7528\u4fe1\u53f7\u91cf\u5462\uff1f\u56e0\u4e3a\u7ba1\u7a0b\u66f4\u6613\u4f7f\u7528,\u7f16\u7a0b\u4e0d\u5bb9\u6613\u51fa\u9519\uff0c\u6240\u4ee5Java\u9009\u62e9\u4e86\u7ba1\u7a0b\uff0cC#/C++\u7b49\u9ad8\u7ea7\u8bed\u8a00\u4e5f\u662f\u652f\u6301\u7ba1\u7a0b\u7684\uff0c\u4f46C\u662f\u4e0d\u652f\u6301\u7ba1\u7a0b\u7684\u3002 \u5e76\u53d1\u7f16\u7a0b\u91cc\u7684\u4e24\u4e2a\u6838\u5fc3\u95ee\u9898\uff1a\u4e92\u65a5\u548c\u540c\u6b65\u90fd\u53ef\u4ee5\u7531\u7ba1\u7a0b\u6765\u89e3\u51b3\u3002\u7ba1\u7a0b\u662f\u89e3\u51b3\u5e76\u53d1\u95ee\u9898\u7684\u901a\u7528\u6a21\u578b\uff0c\u5b66\u597d\u7ba1\u7a0b\uff0c\u7406\u8bba\u4e0a\u6240\u6709\u7684\u5e76\u53d1\u95ee\u9898\u90fd\u53ef\u4ee5\u89e3\u51b3\uff0c\u5f88\u591a\u5e76\u53d1\u5de5\u5177\u4e5f\u90fd\u662f\u5229\u7528\u7ba1\u7a0b\u5b9e\u73b0\u7684\u3002 \u5728\u7ba1\u7a0b\u7684\u53d1\u5c55\u53f2\u4e0a\uff0c\u6709\u4e09\u4e2a\u6a21\u578b\uff0cHasen\u6a21\u578b\uff0cHoare\u6a21\u578b\u548cMESA\u6a21\u578b\uff0c\u5176\u4e2d\u5e7f\u6cdb\u5e94\u7528\u7684\u662fMESA\u6a21\u578b\uff0cJava\u91c7\u7528\u7684\u4e5f\u662fMESA\u6a21\u578b\u3002MESA\u6a21\u578b\u7684\u7279\u70b9\u662f1. \u88ab\u5524\u9192\u7684\u7ebf\u7a0b\u4e0d\u4f1a\u7acb\u5373\u6267\u884c\uff0c\u8981\u91cd\u65b0\u7ade\u4e89\u9501  2. \u9700\u8981\u5728\u5faa\u73af\u4e2d\u68c0\u67e5\u6761\u4ef6\uff0c\u56e0\u4e3a\u6761\u4ef6\u53ef\u80fd\u5728\u88ab\u5524\u9192\u540e\u518d\u6b21\u53d8\u5316</p> <p>\u7ba1\u7a0b\u662f\u5982\u4f55\u89e3\u51b3\u4e92\u65a5\u7684\u95ee\u9898\u5462\uff1f \u7ba1\u7a0b\u6709\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u7279\u6027\u662f\u4efb\u4e00\u65f6\u523b\u7ba1\u7a0b\u4e2d\u53ea\u80fd\u6709\u4e00\u4e2a\u6d3b\u8dc3\u7ebf\u7a0b\uff08Java\u662f\u901a\u8fc7synchronized\uff09\uff0c\u8fd9\u4e00\u7279\u6027\u4f7f\u5f97\u7ba1\u7a0b\u80fd\u6709\u6548\u5b8c\u6210\u4e92\u65a5\u3002\u5c31\u662f\u5c06\u5171\u4eab\u53d8\u91cf\u548c\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u64cd\u4f5c\u5c01\u88c5\u8d77\u6765\uff0c\u591a\u4e2a\u7ebf\u7a0b\u60f3\u8981\u8bbf\u95ee\u548c\u64cd\u4f5c\u5171\u4eab\u53d8\u91cf\uff0c\u53ea\u80fd\u901a\u8fc7\u7ba1\u7a0b\u63d0\u4f9b\u7684\u65b9\u6cd5\uff0c\u7ba1\u7a0b\u5185\u90e8\u4fdd\u8bc1\u65b9\u6cd5\u7684\u4e92\u65a5\u6027\u3002</p> <p></p> <p>\u7ba1\u7a0b\u5982\u4f55\u89e3\u51b3\u540c\u6b65\u95ee\u9898\u5462\uff1f \u7ba1\u7a0b\u5f15\u5165\u4e86\u6761\u4ef6\u53d8\u91cf\u548c\u5176\u5bf9\u5e94\u7684\u7b49\u5f85\u961f\u5217\uff0c\u4e14\u6bcf\u4e2a\u6761\u4ef6\u53d8\u91cf\u90fd\u6709\u4e00\u4e2a\u7b49\u5f85\u961f\u5217\u3002\u7c7b\u4f3c\u4e8eJava\u4e2d\u963b\u585e\u961f\u5217\u7684\u5b9e\u73b0\uff0c\u5185\u90e8\u662f\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5982\u679c\u961f\u5217\u6ee1\u4e86\uff0c\u751f\u4ea7\u8005\u5fc5\u987b\u963b\u585e\u7b49\u5f85\u3002Java\u5185\u7f6e\u7684synchronized\u65b9\u6848\uff0c\u4f7f\u7528\u7b80\u5355\uff0c\u4f46\u662f\u53ea\u652f\u6301\u4e00\u4e2a\u6761\u4ef6\u53d8\u91cf\uff0cJava\u63d0\u4f9b\u7684Lock\u9501\uff0cawait()\uff0csignal()\u53ef\u4ee5\u6709\u591a\u4e2a\u6761\u4ef6\u53d8\u91cfCondition\u3002</p> <p></p> <p>\u9ad8\u7ea7\u5de5\u5177\u90fd\u662f\u7ba1\u7a0b\u7684\"\u8bed\u6cd5\u7cd6\"\uff0c\u6240\u6709\u540c\u6b65\u5de5\u5177\u90fd\u662f\u7ba1\u7a0b\u7684\u4e0d\u540c\u8868\u73b0\u5f62\u5f0f\u3002 - synchronized\u5173\u952e\u5b57\u548cwait(),notify(),notifyAll()\u65b9\u6cd5\u5176\u5b9e\u5c31\u662f\u7ba1\u7a0b\u7684\u5177\u4f53\u5b9e\u73b0 - ReentrantLock - BlockingQueue = \u7ba1\u7a0b + \u961f\u5217\u72b6\u6001\u6761\u4ef6 - CyclicBarrier = \u7ba1\u7a0b + \u7ebf\u7a0b\u5230\u8fbe\u6761\u4ef6 - CountDownLatch = \u7ba1\u7a0b + \u8ba1\u6570\u5668\u6761\u4ef6</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#_3","title":"\u7ebf\u7a0b\u5b89\u5168","text":""},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#_4","title":"\u5e76\u53d1\u7ebf\u7a0b\u7684\u5b89\u5168\u95ee\u9898\u6e90\u5934","text":"<ol> <li> <p>\u7f13\u5b58\u4e00\u81f4\u6027\u5bfc\u81f4\u7684\u53ef\u89c1\u6027\u95ee\u9898\u3002 CPU\u5728\u6267\u884c\u6307\u4ee4\u65f6\uff0c\u4f1a\u5c06\u8fd0\u7b97\u9700\u8981\u7684\u6570\u636e\u4ece\u4e3b\u5b58\u590d\u5236\u4e00\u4efd\u5230CPU\u7684\u9ad8\u901f\u7f13\u5b58\u5f53\u4e2d\uff0c\u90a3\u4e48CPU\u8fdb\u884c\u8ba1\u7b97\u65f6\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u5b83\u7684\u9ad8\u901f\u7f13\u5b58\u8bfb\u53d6\u6570\u636e\u548c\u5411\u5176\u4e2d\u5199\u5165\u6570\u636e\uff0c\u5f53\u8fd0\u7b97\u7ed3\u675f\u4e4b\u540e\uff0c\u518d\u5c06\u9ad8\u901f\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u5237\u65b0\u5230\u4e3b\u5b58\u5f53\u4e2d\u3002</p> </li> <li> <p>\u7f16\u8bd1\u4f18\u5316\u5e26\u6765\u7684\u6709\u5e8f\u6027\u548c\u7ebf\u7a0b\u5207\u6362\u539f\u5b50\u6027\u95ee\u9898</p> </li> </ol> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5904\u7406\u5668\u4e3a\u4e86\u63d0\u9ad8\u7a0b\u5e8f\u8fd0\u884c\u6548\u7387\uff0c\u53ef\u80fd\u4f1a\u5bf9\u8f93\u5165\u4ee3\u7801\u8fdb\u884c\u4f18\u5316\uff0c\u5b83\u4e0d\u4fdd\u8bc1\u7a0b\u5e8f\u4e2d\u5404\u4e2a\u8bed\u53e5\u7684\u6267\u884c\u5148\u540e\u987a\u5e8f\u540c\u4ee3\u7801\u4e2d\u7684\u987a\u5e8f\u4e00\u81f4\uff0c\u4f46\u662f\u5b83\u4f1a\u4fdd\u8bc1\u7a0b\u5e8f\u6700\u7ec8\u6267\u884c\u7ed3\u679c\u548c\u4ee3\u7801\u987a\u5e8f\u6267\u884c\u7684\u7ed3\u679c\u662f\u4e00\u81f4\u7684\u3002\u6307\u4ee4\u91cd\u6392\u5e8f\u4e0d\u4f1a\u5f71\u54cd\u5355\u4e2a\u7ebf\u7a0b\u7684\u6267\u884c\uff0c\u4f46\u662f\u4f1a\u5f71\u54cd\u5230\u591a\u4e2a\u7ebf\u7a0b\u5e76\u53d1\u6267\u884c\u7684\u6b63\u786e\u6027\u3002</p> <p>CPU\u6bcf\u4e2a\u6307\u4ee4\u7684\u64cd\u4f5c\u662f\u539f\u5b50\u6027\u7684\uff0c\u4f46\u662f\u5bf9\u4e8e\u9ad8\u7ea7\u8bed\u8a00\u7684\u5982count++\u5374\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u539f\u5b50\u6027\uff0c\u56e0\u4e3a\u5b83\u5bf9\u5e94\u7740\u4e09\u4e2aCPU\u6307\u4ee4\u3002</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#javajmm","title":"Java\u5185\u5b58\u6a21\u578bJMM","text":"<p>\u5728Java\u865a\u62df\u673a\u89c4\u8303\u4e2d\u8bd5\u56fe\u5b9a\u4e49\u4e00\u79cdJava\u5185\u5b58\u6a21\u578b\uff08Java Memory Model\uff0cJMM\uff09\u6765\u5c4f\u853d\u5404\u4e2a\u786c\u4ef6\u5e73\u53f0\u548c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u5b58\u8bbf\u95ee\u5dee\u5f02\uff0c\u4ee5\u5b9e\u73b0\u8ba9Java\u7a0b\u5e8f\u5728\u5404\u79cd\u5e73\u53f0\u4e0b\u90fd\u80fd\u8fbe\u5230\u4e00\u81f4\u7684\u5185\u5b58\u8bbf\u95ee\u6548\u679c\u3002\u90a3\u4e48Java\u5185\u5b58\u6a21\u578b\u89c4\u5b9a\u4e86\u54ea\u4e9b\u4e1c\u897f\uff1f\u5b83\u5b9a\u4e49\u4e86\u7a0b\u5e8f\u4e2d\u53d8\u91cf\u7684\u8bbf\u95ee\u89c4\u5219\uff0c\u5f80\u5927\u4e00\u70b9\u8bf4\u662f\u5b9a\u4e49\u4e86\u7a0b\u5e8f\u6267\u884c\u7684\u6b21\u5e8f\u3002\u6ce8\u610f\uff0c\u4e3a\u4e86\u83b7\u5f97\u8f83\u597d\u7684\u6267\u884c\u6027\u80fd\uff0cJava\u5185\u5b58\u6a21\u578b\u5e76\u6ca1\u6709\u9650\u5236\u6267\u884c\u5f15\u64ce\u4f7f\u7528\u5904\u7406\u5668\u7684\u5bc4\u5b58\u5668\u6216\u8005\u9ad8\u901f\u7f13\u5b58\u6765\u63d0\u5347\u6307\u4ee4\u6267\u884c\u901f\u5ea6\uff0c\u4e5f\u6ca1\u6709\u9650\u5236\u7f16\u8bd1\u5668\u5bf9\u6307\u4ee4\u8fdb\u884c\u91cd\u6392\u5e8f\u3002\u4e5f\u5c31\u662f\u8bf4\u5728java\u5185\u5b58\u6a21\u578b\u4e2d\uff0c\u4e5f\u4f1a\u5b58\u5728\u7f13\u5b58\u4e00\u81f4\u6027\u95ee\u9898\u548c\u6307\u4ee4\u91cd\u6392\u5e8f\u7684\u95ee\u9898\u3002</p> <p>\u53ef\u89c1\u6027\uff1a Java\u5185\u5b58\u6a21\u578b\u89c4\u5b9a\u6240\u6709\u7684\u53d8\u91cf\u90fd\u662f\u5b58\u5728\u4e3b\u5b58\u5f53\u4e2d\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u5de5\u4f5c\u5185\u5b58\u3002\u7ebf\u7a0b\u5bf9\u53d8\u91cf\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u5fc5\u987b\u5728\u5de5\u4f5c\u5185\u5b58\u4e2d\u8fdb\u884c\uff0c\u800c\u4e0d\u80fd\u76f4\u63a5\u5bf9\u4e3b\u5b58\u8fdb\u884c\u64cd\u4f5c\uff0c\u5e76\u4e14\u6bcf\u4e2a\u7ebf\u7a0b\u4e0d\u80fd\u8bbf\u95ee\u5176\u4ed6\u7ebf\u7a0b\u7684\u5de5\u4f5c\u5185\u5b58\u3002</p> <p>\u6709\u5e8f\u6027\uff1a Java\u5185\u5b58\u6a21\u578b\u5177\u5907\u4e00\u4e9b\u5148\u5929\u7684\u6709\u5e8f\u6027\uff0c\u5373\u4e0d\u9700\u8981\u901a\u8fc7\u4efb\u4f55\u624b\u6bb5\u5c31\u80fd\u591f\u5f97\u5230\u4fdd\u8bc1\u7684\u6709\u5e8f\u6027\uff0c\u8fd9\u4e2a\u901a\u5e38\u4e5f\u79f0\u4e3a happens-before \u539f\u5219\u3002\u5982\u679c\u4e24\u4e2a\u64cd\u4f5c\u7684\u6267\u884c\u6b21\u5e8f\u65e0\u6cd5\u4ecehappens-before\u539f\u5219\u63a8\u5bfc\u51fa\u6765\uff0c\u90a3\u4e48\u5b83\u4eec\u5c31\u4e0d\u80fd\u4fdd\u8bc1\u5b83\u4eec\u7684\u6709\u5e8f\u6027\uff0c\u865a\u62df\u673a\u53ef\u4ee5\u968f\u610f\u5730\u5bf9\u5b83\u4eec\u8fdb\u884c\u91cd\u6392\u5e8f\u3002 happens-before \u539f\u5219\u7684\u6838\u5fc3\u662f\u524d\u4e00\u4e2a\u64cd\u4f5c\u7684\u7ed3\u679c\u5bf9\u540e\u4e00\u4e2a\u64cd\u4f5c\u662f\u53ef\u89c1\u7684\uff0c\u5b83\u7ea6\u675f\u4e86\u7f16\u8bd1\u5668\u7684\u4f18\u5316\u884c\u4e3a\uff0c\u867d\u7136\u5141\u8bb8\u7f16\u8f91\u5668\u4f18\u5316\uff0c\u4f46\u662f\u4f18\u5316\u540e\u8981\u9075\u5b88happens-before \u539f\u5219\u3002</p> <ul> <li>\u5355\u4e2a\u7ebf\u7a0b\u91cc\uff0c\u6309\u7167\u7a0b\u5e8f\u7684\u987a\u5e8f\uff0c\u524d\u9762\u7684\u64cd\u4f5chappens-before\u540e\u9762\u7684\u64cd\u4f5c</li> <li>\u5bf9\u4e8evolatile\u53d8\u91cf\u7684\u5199\u64cd\u4f5chappens-before\u4e8e\u540e\u7eed\u5bf9\u8fd9\u4e2a\u53d8\u91cf\u7684\u8bfb\u64cd\u4f5c</li> <li>\u4f20\u9012\u6027</li> <li>\u5bf9\u4e8e\u4e00\u4e2a\u9501\u7684\u89e3\u9501happens-before\u540e\u7eed\u5bf9\u8fd9\u4e2a\u9501\u7684\u52a0\u9501</li> <li>\u7ebf\u7a0bStart\u539f\u5219\uff0c\u5373\u5982\u679c\u5728\u7ebf\u7a0bA\u4e2d\u8c03\u7528\u7ebf\u7a0bB\u7684start()\u65b9\u6cd5\uff0c\u5219\u7ebf\u7a0bB\u7684start()\u64cd\u4f5chappens-before\u4e8e\u7ebf\u7a0bB\u7684\u4efb\u4f55\u64cd\u4f5c\u3002</li> <li>\u4e3b\u7ebf\u7a0bA\u7b49\u5f85\u7ebf\u7a0bB\u5b8c\u6210\uff0c\u5219\u4e3b\u7ebf\u7a0bA\u80fd\u770b\u5230\u7ebf\u7a0bB\u7684\u6240\u6709\u64cd\u4f5c\uff0c\u5373\u7ebf\u7a0bBhappens-before\u4e3b\u7ebf\u7a0bA</li> </ul> <p>\u539f\u5b50\u6027\uff1a\u53ea\u6709\u7b80\u5355\u7684\u8bfb\u53d6\u3001\u8d4b\u503c\uff08\u800c\u4e14\u5fc5\u987b\u662f\u5c06\u6570\u5b57\u8d4b\u503c\u7ed9\u67d0\u4e2a\u53d8\u91cf\uff0c\u53d8\u91cf\u4e4b\u95f4\u7684\u76f8\u4e92\u8d4b\u503c\u4e0d\u662f\u539f\u5b50\u64cd\u4f5c\uff09\u624d\u662f\u539f\u5b50\u64cd\u4f5c\u3002Java\u4e2d\u7684\u539f\u5b50\u64cd\u4f5c\u5305\u62ec\uff1a</p> <ul> <li>\u9664long\u548cdouble\u4e4b\u5916\u7684\u57fa\u672c\u7c7b\u578b\u7684\u8d4b\u503c\u64cd\u4f5c</li> <li>\u6240\u6709\u5f15\u7528reference\u7684\u8d4b\u503c\u64cd\u4f5c</li> <li>java.concurrent.Atomic.* \u5305\u4e2d\u6240\u6709\u7c7b\u7684\u4e00\u5207\u64cd\u4f5c\u3002</li> </ul> <p>volatile\u5173\u952e\u5b57\u7684\u4e24\u5c42\u8bed\u4e49</p> <p>\u4e00\u65e6\u4e00\u4e2a\u5171\u4eab\u53d8\u91cf\uff08\u7c7b\u7684\u6210\u5458\u53d8\u91cf\u3001\u7c7b\u7684\u9759\u6001\u6210\u5458\u53d8\u91cf\uff09\u88abvolatile\u4fee\u9970\u4e4b\u540e\uff0c\u90a3\u4e48\u5c31\u5177\u5907\u4e86\u4e24\u5c42\u8bed\u4e49\uff1a</p> <p>1\uff09\u4fdd\u8bc1\u4e86\u4e0d\u540c\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u53d8\u91cf\u8fdb\u884c\u64cd\u4f5c\u65f6\u7684\u53ef\u89c1\u6027\uff0c\u5373\u4e00\u4e2a\u7ebf\u7a0b\u4fee\u6539\u4e86\u67d0\u4e2a\u53d8\u91cf\u7684\u503c\uff0c\u8fd9\u65b0\u503c\u5bf9\u5176\u4ed6\u7ebf\u7a0b\u6765\u8bf4\u662f\u7acb\u5373\u53ef\u89c1\u7684\u3002\u5f53\u4e00\u4e2a\u5171\u4eab\u53d8\u91cf\u88abvolatile\u4fee\u9970\u65f6\uff0c\u5b83\u4f1a\u4fdd\u8bc1\u4fee\u6539\u7684\u503c\u4f1a\u7acb\u5373\u66f4\u65b0\u5230\u4e3b\u5b58\uff0c\u5f53\u6709\u5176\u4ed6\u7ebf\u7a0b\u9700\u8981\u8bfb\u53d6\u65f6\uff0c\u5b83\u4f1a\u53bb\u5185\u5b58\u4e2d\u8bfb\u53d6\u65b0\u503c\u3002\u800c\u666e\u901a\u7684\u5171\u4eab\u53d8\u91cf\u4e0d\u80fd\u4fdd\u8bc1\u53ef\u89c1\u6027\uff0c\u56e0\u4e3a\u666e\u901a\u5171\u4eab\u53d8\u91cf\u88ab\u4fee\u6539\u4e4b\u540e\uff0c\u4ec0\u4e48\u65f6\u5019\u88ab\u5199\u5165\u4e3b\u5b58\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u5f53\u5176\u4ed6\u7ebf\u7a0b\u53bb\u8bfb\u53d6\u65f6\uff0c\u6b64\u65f6\u5185\u5b58\u4e2d\u53ef\u80fd\u8fd8\u662f\u539f\u6765\u7684\u65e7\u503c\uff0c\u56e0\u6b64\u65e0\u6cd5\u4fdd\u8bc1\u53ef\u89c1\u6027\u3002</p> <p>2\uff09\u7981\u6b62\u8fdb\u884c\u6307\u4ee4\u91cd\u6392\u5e8f\u3002</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#_5","title":"\u9501","text":"<p>synchronized\u662fJava\u91cc\u63d0\u4f9b\u7684\u9501\uff0c\u5176\u5b9e\u5bf9\u5e94\u7740\u7ba1\u7a0b\u7684\u539f\u8bed\u3002\u9501\u8981\u6ce8\u610f\u4fdd\u62a4\u662f\u4ec0\u4e48\u8d44\u6e90\uff0c\u9501\u7684\u662f\u4ec0\u4e48\u3002</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#_6","title":"\u7ebf\u7a0b\u7684\u751f\u547d\u5468\u671f","text":"<p>\u5e76\u53d1\u7f16\u7a0b\u5b66\u4e60\u7f51\u7ad9</p> <p>\u901a\u7528\u7684\u7ebf\u7a0b\u751f\u547d\u5468\u671f\u5206\u522b\u662f\uff1a\u521d\u59cb\u72b6\u6001\u3001\u53ef\u8fd0\u884c\u72b6\u6001\u3001\u8fd0\u884c\u72b6\u6001\u3001\u4f11\u7720\u72b6\u6001\u548c\u7ec8\u6b62\u72b6\u6001\u3002\u4f46\u662f\u5728\u4e0d\u540c\u7684\u7f16\u7a0b\u8bed\u8a00\u91cc\uff0c\u8fd95\u79cd\u72b6\u6001\u4f1a\u6709\u7b80\u5316\u5408\u5e76\u3002Java\u8bed\u8a00\u4e2d\u7ebf\u7a0b\u5171\u6709\u516d\u79cd\u72b6\u6001\uff0c\u5206\u522b\u662f\uff1a</p> <p></p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#new","title":"NEW:","text":"<p>A thread that has not yet started is in this state</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#runnable","title":"RUNNABLE:","text":"<p>Thread state for a runnable thread.  A thread in the runnable state is executing in the Java virtual machine but it may be waiting for other resources from the operating system such as processor.</p> <p>java\u7ebf\u7a0b\u6839\u636e\u5bfc\u81f4\u7ebf\u7a0b\u4f11\u7720\u7684\u539f\u56e0\u4e0d\u540c\uff0c\u5206\u4e3aBLOCKED\uff08\u963b\u585e\u72b6\u6001\uff09\uff0cWATING\uff08\u65e0\u65f6\u9650\u7b49\u5f85\uff09\uff0cTIMED_WAITING\uff08\u6709\u65f6\u9650\u7b49\u5f85\uff09</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#blocked","title":"BLOCKED:","text":"<p>Thread state for a thread blocked waiting for a monitor lock. A thread in the blocked state is waiting for a monitor lock to enter a synchronized block/method or reenter a synchronized block/method after calling</p> <p>\u7ebf\u7a0b\u7531runnable\u8f6c\u4e3aBlocked\u72b6\u6001\u662f\u7531\u4e8e\u7b49\u5f85synchronized\u7684\u9690\u5f0f\u9501\u3002\u5982\u679c\u4f60\u719f\u6089\u64cd\u4f5c\u7cfb\u7edf\u7ebf\u7a0b\u7684\u751f\u547d\u5468\u671f\u7684\u8bdd\uff0c\u53ef\u80fd\u4f1a\u6709\u4e2a\u7591\u95ee\uff1a\u7ebf\u7a0b\u8c03\u7528\u963b\u585e\u5f0fAPI\u65f6\uff0c\u662f\u5426\u4f1a\u8f6c\u6362\u5230BLOCKED\u72b6\u6001\u5462\uff1f\u5728\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\uff0c\u7ebf\u7a0b\u662f\u4f1a\u8f6c\u6362\u5230\u4f11\u7720\u72b6\u6001\u7684\uff0c\u4f46\u662f\u5728JVM\u5c42\u9762\uff0cJava\u7ebf\u7a0b\u7684\u72b6\u6001\u4e0d\u4f1a\u53d1\u751f\u53d8\u5316\uff0c\u4e5f\u5c31\u662f\u8bf4Java\u7ebf\u7a0b\u7684\u72b6\u6001\u4f1a\u4f9d\u7136\u4fdd\u6301RUNNABLE\u72b6\u6001\u3002JVM\u5c42\u9762\u5e76\u4e0d\u5173\u5fc3\u64cd\u4f5c\u7cfb\u7edf\u8c03\u5ea6\u76f8\u5173\u7684\u72b6\u6001\uff0c\u56e0\u4e3a\u5728JVM\u770b\u6765\uff0c\u7b49\u5f85CPU\u4f7f\u7528\u6743\uff08\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u6b64\u65f6\u5904\u4e8e\u53ef\u6267\u884c\u72b6\u6001\uff09\u4e0e\u7b49\u5f85I/O\uff08\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u6b64\u65f6\u5904\u4e8e\u4f11\u7720\u72b6\u6001\uff09\u6ca1\u6709\u533a\u522b\uff0c\u90fd\u662f\u5728\u7b49\u5f85\u67d0\u4e2a\u8d44\u6e90\uff0c\u6240\u4ee5\u90fd\u5f52\u5165\u4e86RUNNABLE\u72b6\u6001\u3002\u800c\u6211\u4eec\u5e73\u65f6\u6240\u8c13\u7684Java\u5728\u8c03\u7528\u963b\u585e\u5f0fAPI\u65f6\uff0c\u7ebf\u7a0b\u4f1a\u963b\u585e\uff0c\u6307\u7684\u662f\u64cd\u4f5c\u7cfb\u7edf\u7ebf\u7a0b\u7684\u72b6\u6001\uff0c\u5e76\u4e0d\u662fJava\u7ebf\u7a0b\u7684\u72b6\u6001</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#waiting","title":"WAITING:","text":"<p>A thread that is waiting indefinitely for another thread to perform a particular action is in this state\u3002\u8c03\u7528\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6cd5\u4e4b\u4e00\u4f1a\u89e6\u53d1\u8fd9\u79cd\u8f6c\u6362\u3002</p> <ol> <li>\u83b7\u5f97synchronized\u9690\u5f0f\u9501\u7684\u7ebf\u7a0b\uff0c\u8c03\u7528\u65e0\u53c2\u6570\u7684Object.wait()\u65b9\u6cd5\uff0c\u4f1a\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u8c03\u7528notify()\u6216\u8005notifyAll()\u65b9\u6cd5\u3002</li> <li>\u8c03\u7528\u65e0\u53c2\u6570\u7684Thread.join()\u65b9\u6cd5\u3002\u5176\u4e2d\u7684join()\u662f\u4e00\u79cd\u7ebf\u7a0b\u540c\u6b65\u65b9\u6cd5\uff0c\u4f8b\u5982\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8c61thread A\uff0c\u5f53\u8c03\u7528A.join()\u7684\u65f6\u5019\uff0c\u6267\u884c\u8fd9\u6761\u8bed\u53e5\u7684\u7ebf\u7a0b\u4f1a\u7b49\u5f85thread A\u6267\u884c\u5b8c\u3002\u800c\u7b49\u5f85\u4e2d\u7684\u8fd9\u4e2a\u7ebf\u7a0b\uff0c\u5176\u72b6\u6001\u4f1a\u4eceRUNNABLE\u8f6c\u6362\u5230WAITING\uff0c\u5f53\u7ebf\u7a0bthread A\u6267\u884c\u5b8c\uff0c\u539f\u6765\u7b49\u5f85\u5b83\u7684\u7ebf\u7a0b\u53c8\u4f1a\u4eceWAITING\u72b6\u6001\u8f6c\u6362\u5230RUNNABLE\u3002</li> <li>\u8c03\u7528LockSupport.park()\u65b9\u6cd5\u3002\u5176\u4e2d\u7684LockSupport\u5bf9\u8c61\uff0c\u4e5f\u8bb8\u4f60\u6709\u70b9\u964c\u751f\uff0c\u5176\u5b9eJava\u5e76\u53d1\u5305\u4e2d\u7684\u9501\uff0c\u90fd\u662f\u57fa\u4e8e\u5b83\u5b9e\u73b0\u7684\u3002\u8c03\u7528LockSupport.park()\u65b9\u6cd5\uff0c\u5f53\u524d\u7ebf\u7a0b\u4f1a\u963b\u585e\uff0c\u7ebf\u7a0b\u7684\u72b6\u6001\u4f1a\u4eceRUNNABLE\u8f6c\u6362\u5230WAITING\u3002\u8c03\u7528LockSupport.unpark(Thread thread)\u53ef\u5524\u9192\u76ee\u6807\u7ebf\u7a0b\uff0c\u76ee\u6807\u7ebf\u7a0b\u7684\u72b6\u6001\u53c8\u4f1a\u4eceWAITING\u72b6\u6001\u8f6c\u6362\u5230RUNNABLE\u3002</li> </ol>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#timed_waiting","title":"TIMED_WAITING:","text":"<p>A thread that is waiting for another thread to perform an action for up to a specified waiting time is in this state\u3002\u8c03\u7528\u4ee5\u4e0b\u4e94\u79cd\u65b9\u6cd5\u4e4b\u4e00\u4f1a\u8fdb\u5165TIMED_WAITING\u72b6\u6001\uff1a</p> <p>\u200b   1.  \u8c03\u7528Thread.sleep(long millis)\u65b9\u6cd5\uff1b</p> <p>\u200b   2.  \u83b7\u5f97synchronized\u9690\u5f0f\u9501\u7684\u7ebf\u7a0b\uff0c\u8c03\u7528\u5e26\u8d85\u65f6\u53c2\u6570\u7684Object.wait(long timeout)\u65b9\u6cd5\uff1b</p> <p>\u200b   3.  \u8c03\u7528\u5e26\u8d85\u65f6\u53c2\u6570\u7684Thread.join(long millis)\u65b9\u6cd5\uff1b</p> <p>\u200b   4.  \u8c03\u7528\u5e26\u8d85\u65f6\u53c2\u6570\u7684LockSupport.parkNanos(Object blocker, long deadline)\u65b9\u6cd5\uff1b</p> <p>\u200b   5.  \u8c03\u7528\u5e26\u8d85\u65f6\u53c2\u6570\u7684LockSupport.parkUntil(long deadline)\u65b9\u6cd5\u3002</p> <p>\u8fd9\u91cc\u4f60\u4f1a\u53d1\u73b0TIMED_WAITING\u548cWAITING\u72b6\u6001\u7684\u533a\u522b\uff0c\u4ec5\u4ec5\u662f\u89e6\u53d1\u6761\u4ef6\u591a\u4e86\u8d85\u65f6\u53c2\u6570</p>"},{"location":"java/concurrent/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/#terminated","title":"TERMINATED:","text":"<p>A thread that has exited is in this state</p> <p>interrupt()\u65b9\u6cd5\u4ec5\u4ec5\u662f\u901a\u77e5\u7ebf\u7a0b\uff0c\u7ebf\u7a0b\u6709\u673a\u4f1a\u6267\u884c\u4e00\u4e9b\u540e\u7eed\u64cd\u4f5c\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u65e0\u89c6\u8fd9\u4e2a\u901a\u77e5\u3002\u88abinterrupt\u7684\u7ebf\u7a0b\uff0c\u662f\u600e\u4e48\u6536\u5230\u901a\u77e5\u7684\u5462\uff1f\u4e00\u79cd\u662f\u5f02\u5e38\uff0c\u53e6\u4e00\u79cd\u662f\u4e3b\u52a8\u68c0\u6d4b\u3002</p> <p>\u5f53\u7ebf\u7a0bA\u5904\u4e8eWAITING\u3001TIMED_WAITING\u72b6\u6001\u65f6\uff0c\u5982\u679c\u5176\u4ed6\u7ebf\u7a0b\u8c03\u7528\u7ebf\u7a0bA\u7684interrupt()\u65b9\u6cd5\uff0c\u4f1a\u4f7f\u7ebf\u7a0bA\u8fd4\u56de\u5230RUNNABLE\u72b6\u6001\uff0c\u540c\u65f6\u7ebf\u7a0bA\u7684\u4ee3\u7801\u4f1a\u89e6\u53d1InterruptedException\u5f02\u5e38\u3002\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u8f6c\u6362\u5230WAITING\u3001TIMED_WAITING\u72b6\u6001\u7684\u89e6\u53d1\u6761\u4ef6\uff0c\u90fd\u662f\u8c03\u7528\u4e86\u7c7b\u4f3cwait()\u3001join()\u3001sleep()\u8fd9\u6837\u7684\u65b9\u6cd5\uff0c\u6211\u4eec\u770b\u8fd9\u4e9b\u65b9\u6cd5\u7684\u7b7e\u540d\uff0c\u53d1\u73b0\u90fd\u4f1athrows InterruptedException\u8fd9\u4e2a\u5f02\u5e38\u3002\u8fd9\u4e2a\u5f02\u5e38\u7684\u89e6\u53d1\u6761\u4ef6\u5c31\u662f\uff1a\u5176\u4ed6\u7ebf\u7a0b\u8c03\u7528\u4e86\u8be5\u7ebf\u7a0b\u7684interrupt()\u65b9\u6cd5\u3002</p> <p>\u5f53\u7ebf\u7a0bA\u5904\u4e8eRUNNABLE\u72b6\u6001\u65f6\uff0c\u5e76\u4e14\u963b\u585e\u5728java.nio.channels.InterruptibleChannel\u4e0a\u65f6\uff0c\u5982\u679c\u5176\u4ed6\u7ebf\u7a0b\u8c03\u7528\u7ebf\u7a0bA\u7684interrupt()\u65b9\u6cd5\uff0c\u7ebf\u7a0bA\u4f1a\u89e6\u53d1java.nio.channels.ClosedByInterruptException\u8fd9\u4e2a\u5f02\u5e38\uff1b\u800c\u963b\u585e\u5728java.nio.channels.Selector\u4e0a\u65f6\uff0c\u5982\u679c\u5176\u4ed6\u7ebf\u7a0b\u8c03\u7528\u7ebf\u7a0bA\u7684interrupt()\u65b9\u6cd5\uff0c\u7ebf\u7a0bA\u7684java.nio.channels.Selector\u4f1a\u7acb\u5373\u8fd4\u56de\u3002</p> <p>\u4e0a\u9762\u8fd9\u4e24\u79cd\u60c5\u51b5\u5c5e\u4e8e\u88ab\u4e2d\u65ad\u7684\u7ebf\u7a0b\u901a\u8fc7\u5f02\u5e38\u7684\u65b9\u5f0f\u83b7\u5f97\u4e86\u901a\u77e5\u3002\u8fd8\u6709\u4e00\u79cd\u662f\u4e3b\u52a8\u68c0\u6d4b\uff0c\u5982\u679c\u7ebf\u7a0b\u5904\u4e8eRUNNABLE\u72b6\u6001\uff0c\u5e76\u4e14\u6ca1\u6709\u963b\u585e\u5728\u67d0\u4e2aI/O\u64cd\u4f5c\u4e0a\uff0c\u4f8b\u5982\u4e2d\u65ad\u8ba1\u7b97\u5706\u5468\u7387\u7684\u7ebf\u7a0bA\uff0c\u8fd9\u65f6\u5c31\u5f97\u4f9d\u8d56\u7ebf\u7a0bA\u4e3b\u52a8\u68c0\u6d4b\u4e2d\u65ad\u72b6\u6001\u4e86\u3002\u5982\u679c\u5176\u4ed6\u7ebf\u7a0b\u8c03\u7528\u7ebf\u7a0bA\u7684interrupt()\u65b9\u6cd5\uff0c\u90a3\u4e48\u7ebf\u7a0bA\u53ef\u4ee5\u901a\u8fc7isInterrupted()\u65b9\u6cd5\uff0c\u68c0\u6d4b\u662f\u4e0d\u662f\u81ea\u5df1\u88ab\u4e2d\u65ad\u4e86\u3002</p> <p>\u6ce8\u610f\uff1a\u5904\u4e8e\u963b\u585e\u72b6\u6001\u7684\u7ebf\u7a0b\u88ab\u6253\u65ad\u65f6\u4f1a\u6e05\u9664\u4e2d\u65ad\u6807\u8bb0\u4f4d\u5e76\u629b\u51fa\u4e2d\u65ad\u5f02\u5e38</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/","title":"java thread","text":"<p>\u7ebf\u7a0b\u662f\u7a0b\u5e8f\u4e2d\u7684\u6267\u884c\u7ebf\u7a0b\u3002 Java \u865a\u62df\u673a\u5141\u8bb8\u5e94\u7528\u7a0b\u5e8f\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u6267\u884c\u7ebf\u7a0b\u3002</p> <ul> <li> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u4f18\u5148\u7ea71-10,\u9ed8\u8ba4\u662f5\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7ebf\u7a0b\u65f6\u9ed8\u8ba4\u7ee7\u627f\u7236\u7ebf\u7a0b\u7684\u4f18\u5148\u7ea7\u3002</p> </li> <li> <p>\u5b88\u62a4\u8fdb\u7a0b\u4e00\u822c\u7528\u4e8e\u5b9a\u65f6\u5668\u6216\u6e05\u9664\u8fc7\u65f6\u7684\u7f13\u5b58\u7b49\u4efb\u52a1\u3002\u6ce8\u610f\u5b88\u62a4\u8fdb\u7a0b\u4e0d\u8981\u53bb\u8bbf\u95ee\u4efb\u4f55\u6587\u4ef6\uff0c\u6570\u636e\u5e93\uff0c\u56e0\u4e3a\u53ef\u80fd\u5728\u4efb\u610f\u65f6\u523b\u4e2d\u65ad\u3002 </p> </li> <li> <p>\u7ebf\u7a0b\u5728\u629b\u51fa\u4e0d\u88ab\u68c0\u6d4b\u5230\u7684\u5f02\u5e38\u65f6\u4f1a\u5bfc\u81f4\u7ebf\u7a0b\u7ec8\u6b62\uff0c\u53ef\u4ee5\u91cd\u5199uncaughtException\u65b9\u6cd5\u6765\u5904\u7406\u6ca1\u6709\u88ab\u6355\u83b7\u7684\u5f02\u5e38\uff0c\u751f\u4ea7\u4e2d\u4e00\u822c\u53ea\u662f\u6253\u5370\u65e5\u5fd7\uff1a</p> </li> </ul> <pre><code>public static Thread newThread(String name, Runnable runnable, boolean daemon) {\n    Thread thread = new Thread(runnable, name);\n    thread.setDaemon(daemon);\n    thread.setUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {\n        public void uncaughtException(Thread t, Throwable e) {\n            log.error(\"Uncaught exception in thread '\" + t.getName() + \"':\", e);\n        }\n    });\n    return thread;\n}\n\n// \u5982\u679c\u6ca1\u6709\u91cd\u5199\uff0c\u4f1a\u8c03\u7528\u7684\u9ed8\u8ba4\u7684ThreadGroup implements Thread.UncaughtExceptionHandler\npublic void uncaughtException(Thread t, Throwable e) {\n    // \u5148\u8c03\u7528\u7236\u7c7b\u7684\u5982\u679c\u4e0d\u4e3a\u7a7a\n    if (parent != null) {\n        parent.uncaughtException(t, e);\n    } else {\n        Thread.UncaughtExceptionHandler ueh =\n            Thread.getDefaultUncaughtExceptionHandler();\n        if (ueh != null) {\n            ueh.uncaughtException(t, e);\n         // System.err\u8f93\u51fa\uff0c\u8fd9\u4e2a\u5e94\u8be5\u7ecf\u5e38\u9047\u5230\n        } else if (!(e instanceof ThreadDeath)) {\n            System.err.print(\"Exception in thread \\\"\"\n                             + t.getName() + \"\\\" \");\n            e.printStackTrace(System.err);\n        }\n    }\n}\n</code></pre> <p>\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u4ee5\u521b\u5efa\u7ebf\u7a0b\uff0cextends Thread \u548cimplements Runnable\u3002</p> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u7528\u4e8e\u8bc6\u522b\u7684\u540d\u79f0\u3002 \u591a\u4e2a\u7ebf\u7a0b\u53ef\u80fd\u5177\u6709\u76f8\u540c\u7684\u540d\u79f0\u3002 \u5982\u679c\u5728\u521b\u5efa\u7ebf\u7a0b\u65f6\u672a\u6307\u5b9a\u540d\u79f0\uff0c\u5219\u4f1a\u4e3a\u5176\u751f\u6210\u4e00\u4e2a\u65b0\u540d\u79f0\u3002</p> <p>\u5982\u4f55\u7ec8\u6b62\u4e00\u4e2a\u7ebf\u7a0b\uff1f</p> <ul> <li>\u6b63\u5e38\u903b\u8f91\u6267\u884c\u5b8c\u4e86\uff0c\u7ebf\u7a0b\u4e5f\u5c31\u7ed3\u675f\u4e86</li> <li>\u901a\u8fc7volitail\u53d8\u91cf\u4f5c\u4e3a\u6807\u5fd7\u4f4d\uff0c\u5916\u9762\u8bbe\u7f6e\u4f4dfalse\uff0c\u7ebf\u7a0b\u4f1a\u7acb\u5373\u7ed3\u675f</li> <li>\u901a\u8fc7interrupt\u6765\u7ed3\u675f\u7ebf\u7a0b\u3002\u5982\u679c\u7ebf\u7a0b\u5728\u4f11\u7720\u72b6\u6001\uff0c\u4f1a\u629b\u51faInterruptedException\u5f02\u5e38\uff0ccatch\u91cc\u53ef\u4ee5\u7ed3\u675f\u7ebf\u7a0b\u3002\u5982\u679c\u7ebf\u7a0b\u6b63\u5e38\u6267\u884c\uff0c\u901a\u8fc7\u5224\u65adinterrupted\u6807\u5fd7\u4f4d</li> </ul>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#_1","title":"\u7ebf\u7a0b\u7684\u963b\u585e\u548c\u5524\u9192","text":"<p>\u963b\u585e\u7684\u672c\u8d28\u5c31\u662f\u5c06\u8fdb\u7a0b\u6302\u8d77\uff0c\u4e0d\u518d\u53c2\u4e0eCPU\u8c03\u5ea6\uff0c\u4e5f\u5c31\u662f\u4fee\u6539\u8fdb\u7a0b\u7684\u72b6\u6001\u4e3a\u975eRunnable\uff0c\u8fd9\u6837CPU\u4e0b\u6b21\u8fdb\u884c\u8c03\u5ea6\u7684\u65f6\u5019\u5c31\u4e0d\u4f1a\u628a\u5b83\u4f5c\u4e3a\u53ef\u9009\u9879\u4e86\u3002</p> <p>\u81f3\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u7684\u963b\u585e\u548c\u6302\u8d77\uff0c\u5bf9\u4e0a\u5c42\u5e94\u7528\u6765\u8bf4\u5176\u5b9e\u662f\u4e00\u6837\u7684\uff0c\u90fd\u5bf9\u5e94\u7740\u963b\u585e\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#1-parkunpark","title":"1. park()\u548cunpark()","text":"<p>\u5c5e\u4e8ejava.util.concurrent.locks.LockSupport\u63d0\u4f9b\u7684\u65b9\u6cd5\uff0c\u4e3alock\u548c\u5176\u4ed6\u540c\u6b65\u7c7b\u63d0\u4f9b\u7ebf\u7a0b\u963b\u585e\u7684\u57fa\u7840\u8bed\u4e49\uff0c\u662f\u4e00\u4e2a\u57fa\u7840\u65b9\u6cd5\uff01\uff01</p> <ul> <li>\u8c03\u7528park()\u65b9\u6cd5\uff0c\u4f1a\u68c0\u67e5\u662f\u5426\u6709\u8c03\u7528\u8005\u7ebf\u7a0b\u662f\u5426\u62e5\u6709\u4e00\u4e2a\u8bb8\u53efpermit\uff0c\u5982\u679c\u6709\u6d88\u8017\u6389\u5e76\u7acb\u5373\u8fd4\u56de\uff0c\u5426\u5219\u5c31\u4f1a\u963b\u585e\uff0c\u76f4\u5230\u6709\u9488\u5bf9\u8fd9\u4e2a\u7ebf\u7a0b\u7684unpark\u6216\u8005\u4e2d\u65ad\uff08\u8fd9\u4e5f\u662f\u548cwait\u65b9\u6cd5\u7684\u4e0d\u540c\uff0c\u4e0d\u4f1a\u629b\u51faInterruptedException\uff01\uff09\uff0c\u6216\u8005\u865a\u5047\u8c03\u7528\u3002</li> <li>\u8c03\u7528unpark(thread)\u4f7f\u7ed9\u5b9a\u7ebf\u7a0b\u7684permit\u53ef\u7528\uff08\u5982\u679c\u5b83\u5c1a\u4e0d\u53ef\u7528\uff09\uff0c \u5982\u679c\u7ebf\u7a0b\u5728park\u4e0a\u88ab\u963b\u585e\uff0c\u90a3\u4e48\u5b83\u5c06\u89e3\u9664\u963b\u585e\uff0c\u53e6\u5916\u5982\u679c\u5148\u8c03\u7528unpark\u4e5f\u80fd\u4fdd\u8bc1\u4e0b\u4e00\u6b21park\u8c03\u7528\u4e0d\u4f1a\u963b\u585e\u3002\u548cSemaphores\u4e0d\u540c\u7684\u662f\uff0cpark\u7684permit\u6700\u591a\u6709\u4e00\u4e2a\u3002</li> </ul> <p>park\u548cunpark\u662f\u9ad8\u6548\u7684\u5b9e\u73b0\u963b\u585e\u548c\u5524\u9192\u6307\u5b9a\u7ebf\u7a0b\u7684\u65b9\u5f0f\uff0c\u66ff\u4ee3\u5e9f\u5f03\u7684Thread.suspend\u548cThread.resume\u3002park\u4e5f\u652f\u6301timeout\u7684\u53c2\u6570\uff0c\u975e\u5e38\u9002\u5408\u5fd9\u7b49\u5f85\u6a21\u578b\uff0c</p> <p>park\u652f\u6301\u53c2\u6570\uff0cwhile (!canProceed()) { ... LockSupport.park(this); }}</p> <p>\u5e95\u5c42\u539f\u7406\uff1a</p> <p>park\u5e95\u5c42\u662f\u57fa\u4e8e\u672c\u5730\u65b9\u6cd5UNSAFE.park(false, 0L);</p> <p>\u5728Linux\u7cfb\u7edf\u4e0b\uff0cpark\u548cunpark\u662f\u7528\u7684Posix\u7ebf\u7a0b\u5e93pthread\u4e2d\u7684mutex\uff08\u4e92\u65a5\u91cf\uff09\uff0ccondition\uff08\u6761\u4ef6\u53d8\u91cf\uff09\u6765\u5b9e\u73b0\u7684\u3002\u7b80\u5355\u6765\u8bf4\uff0cmutex\u548ccondition\u4fdd\u62a4\u4e86\u4e00\u4e2a\u53eb_counter\u7684\u4fe1\u53f7\u91cf\u3002</p> <p>_\u5f53park\u65f6\uff0c\u68c0\u67e5_counter\u662f\u4e0d\u662f\u5927\u4e8e0\uff0c\u5982\u679c\u662f\uff0c\u5219\u628a_counter\u8bbe\u7f6e\u4e3a0\uff0c\u8fd4\u56de\u3002\u5982\u679c\u7b49\u4e8e\u96f6\uff0c\u7ee7\u7eed\u6267\u884c\uff0c\u963b\u585e\u7b49\u5f85\uff1b</p> <pre><code>void Parker::park(bool isAbsolute, jlong time) {\n  //\u5224\u65ad\u4fe1\u53f7\u91cfcounter\u662f\u5426\u5927\u4e8e0\uff0c\u5982\u679c\u5927\u4e8e\u8bbe\u4e3a0\u8fd4\u56de\n  if (Atomic::xchg(0, &amp;_counter) &gt; 0) return;\n\n  //\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\n  Thread* thread = Thread::current();\n  assert(thread-&gt;is_Java_thread(), \"Must be JavaThread\");\n  JavaThread *jt = (JavaThread *)thread;\n\n  //\u5982\u679c\u4e2d\u9014\u5df2\u7ecf\u662finterrupt\u4e86\uff0c\u90a3\u4e48\u7acb\u523b\u8fd4\u56de\uff0c\u4e0d\u963b\u585e\n  // Check interrupt before trying to wait\n  if (Thread::is_interrupted(thread, false)) {\n    return;\n  }\n\n  //\u8bb0\u5f55\u5f53\u524d\u7edd\u5bf9\u65f6\u95f4\u6233\n  // Next, demultiplex/decode time arguments\n  timespec absTime;\n  //\u5982\u679cpark\u7684\u8d85\u65f6\u65f6\u95f4\u5df2\u5230\uff0c\u5219\u8fd4\u56de\n  if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0) ) { // don't wait at all\n    return;\n  }\n  //\u66f4\u6362\u65f6\u95f4\u6233\n  if (time &gt; 0) {\n    unpackTime(&amp;absTime, isAbsolute, time);\n  }\n\n  // Enter safepoint region\n  // Beware of deadlocks such as 6317397.\n  // The per-thread Parker:: mutex is a classic leaf-lock.\n  // In particular a thread must never block on the Threads_lock while\n  // holding the Parker:: mutex.  If safepoints are pending both the\n  // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.\n  //\u8fdb\u5165\u5b89\u5168\u70b9\uff0c\u5229\u7528\u8be5thread\u6784\u9020\u4e00\u4e2aThreadBlockInVM\n  ThreadBlockInVM tbivm(jt); \n\n  // Don't wait if cannot get lock since interference arises from\n  // unblocking.  Also. check interrupt before trying wait\n  if (Thread::is_interrupted(thread, false) || pthread_mutex_trylock(_mutex) != 0) {\n    return;\n  } \n\n  //\u8bb0\u5f55\u7b49\u5f85\u72b6\u6001\n  int status ;\n  //\u4e2d\u9014\u518d\u6b21\u68c0\u67e5\u8bb8\u53ef\uff0c\u6709\u5219\u76f4\u63a5\u8fd4\u56de\u4e0d\u7b49\u5e26\u3002\n  if (_counter &gt; 0)  { // no wait needed\n    _counter = 0;\n    status = pthread_mutex_unlock(_mutex);\n    assert (status == 0, \"invariant\") ;\n    // Paranoia to ensure our locked and lock-free paths interact\n    // correctly with each other and Java-level accesses.\n    OrderAccess::fence();\n    return;\n  }\n\n  OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);\n  jt-&gt;set_suspend_equivalent();\n  // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()\n\n\n  assert(_cur_index == -1, \"invariant\");\n  if (time == 0) {\n    _cur_index = REL_INDEX; // arbitrary choice when not timed\n    //\u7ebf\u7a0b\u6761\u4ef6\u7b49\u5f85 \u7ebf\u7a0b\u7b49\u5f85\u4fe1\u53f7\u89e6\u53d1\uff0c\u5982\u679c\u6ca1\u6709\u4fe1\u53f7\u89e6\u53d1\uff0c\u65e0\u9650\u671f\u7b49\u5f85\u4e0b\u53bb\u3002\n    status = pthread_cond_wait (&amp;_cond[_cur_index], _mutex) ;\n  } else {\n    _cur_index = isAbsolute ? ABS_INDEX : REL_INDEX;\n    //\u7ebf\u7a0b\u7b49\u5f85\u4e00\u5b9a\u7684\u65f6\u95f4\uff0c\u5982\u679c\u8d85\u65f6\u6216\u6709\u4fe1\u53f7\u89e6\u53d1\uff0c\u7ebf\u7a0b\u5524\u9192\n    status = os::Linux::safe_cond_timedwait (&amp;_cond[_cur_index], _mutex, &amp;absTime) ;\n    if (status != 0 &amp;&amp; WorkAroundNPTLTimedWaitHang) {\n      pthread_cond_destroy (&amp;_cond[_cur_index]) ;\n      pthread_cond_init    (&amp;_cond[_cur_index], isAbsolute ? NULL : os::Linux::condAttr());\n    }\n  }\n  _cur_index = -1;\n  assert_status(status == 0 || status == EINTR ||\n                status == ETIME || status == ETIMEDOUT,\n                status, \"cond_timedwait\");\n\n\n  _counter = 0 ;\n  status = pthread_mutex_unlock(_mutex) ;\n  assert_status(status == 0, status, \"invariant\") ;\n  // Paranoia to ensure our locked and lock-free paths interact\n  // correctly with each other and Java-level accesses.\n  OrderAccess::fence();\n\n\n  // If externally suspended while waiting, re-suspend\n  if (jt-&gt;handle_special_suspend_equivalent_condition()) {\n    jt-&gt;java_suspend_self();\n  }\n}\n</code></pre> <p>\u5f53unpark\u65f6\uff0cunpark\u8bbe\u7f6e_counter\u4e3a1\uff0c\u7136\u540e\u89e3\u9501 mutex\u8fd4\u56de\u3002\u5982\u679ccounter\u4e4b\u524d\u7684\u503c\u662f0\uff0c\u5219\u8fd8\u8981\u8c03\u7528pthread_cond_signal\u5524\u9192\u5728park\u4e2d\u7b49\u5f85\u7684\u7ebf\u7a0b\u3002</p> <pre><code>void Parker::unpark() {\n  //\u5b9a\u4e49\u4e24\u4e2a\u53d8\u91cf\uff0cstaus\u7528\u4e8e\u5224\u65ad\u662f\u5426\u83b7\u53d6\u9501\n  int s, status ;\n  //\u83b7\u53d6\u9501\n  status = pthread_mutex_lock(_mutex);\n  //\u5224\u65ad\u662f\u5426\u6210\u529f\n  assert (status == 0, \"invariant\") ;\n  //\u5b58\u50a8\u539f\u5148\u53d8\u91cf_counter\n  s = _counter;\n  //\u628a_counter\u8bbe\u4e3a1\n  _counter = 1;\n  if (s &lt; 1) {\n    // thread might be parked\n    if (_cur_index != -1) {\n      // thread is definitely parked\n      if (WorkAroundNPTLTimedWaitHang) {\n        status = pthread_cond_signal (&amp;_cond[_cur_index]);\n        assert (status == 0, \"invariant\");\n        status = pthread_mutex_unlock(_mutex);\n        assert (status == 0, \"invariant\");\n      } else {\n        status = pthread_mutex_unlock(_mutex);\n        assert (status == 0, \"invariant\");\n        status = pthread_cond_signal (&amp;_cond[_cur_index]);\n        assert (status == 0, \"invariant\");\n      }\n    } else {\n        //\u91ca\u653e\u9501\n      pthread_mutex_unlock(_mutex);\n      assert (status == 0, \"invariant\") ;\n    }\n  } else {\n      //\u91ca\u653e\u9501\n    pthread_mutex_unlock(_mutex);\n    assert (status == 0, \"invariant\") ;\n  }\n}\n</code></pre> <p>\u611f\u89c9park\u548cunpark\u662f\u57fa\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5df2\u6709\u51fd\u6570\u63d0\u4f9b\u7684\u57fa\u7840\u8bed\u4e49\uff0c\u672c\u8eab\u548c\u9501\u6ca1\u6709\u5565\u5173\u7cfb\uff0c\u53ea\u662f\u7528\u4e8e\u963b\u585e\u548c\u5524\u9192\u6307\u5b9a\u7ebf\u7a0b\uff0c\u50cfReentranLock\u7684\u5e95\u5c42AQS\u91cc\u9762\u4f1a\u4f7f\u7528<code>LockSupport.park(this);</code>\uff0clock\u548cwait\u662f\u66f4\u9ad8\u5c42\u6b21\u7684\u65b9\u6cd5\uff0c\u63d0\u4f9b\u540c\u6b65\u4ee3\u7801\u5757\u7ea7\u522b\u7684\u963b\u585e\u5524\u9192\uff0c\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#2-waitnotify","title":"2. wait()\u548cnotify()","text":"<p>wait()\u662f\u5c5e\u4e8eObject\u91cc\u7684\u65b9\u6cd5\uff0c\u8c03\u7528wait\u65b9\u6cd5\uff0c\u4f1a\u91ca\u653e\u6b64\u5bf9\u8c61\u4e0a\u7684\u9501\uff0c\u4f7f\u7684\u5f53\u524d\u7ebf\u7a0b\u5904\u4e8e\u5bf9\u8c61\u7684wait_set\u4e2d\u3002</p> <p>\u7ebf\u7a0b\u5904\u4e8e\u7ebf\u7a0b\u8c03\u5ea6\u7684\u76ee\u7684\u5904\u4e8e\u4f11\u7720\u72b6\u6001\uff0c\u76f4\u5230\u5b83\u88ab\u5524\u9192\uff1anotify\u6070\u597d\u662f\u5f53\u524d\u7ebf\u7a0b\uff1bnotifyAll()\uff1b\u4e2d\u65ad\uff1b\u6216\u8005\u7ecf\u8fc7\u4e00\u5b9a\u7684\u65f6\u95f4\uff1b\u865a\u5047\u8c03\u7528\u3002</p> <p>\u5f53\u524d\u7ebf\u7a0b\u5fc5\u987b\u62e5\u6709\u6b64\u5bf9\u8c61\u7684\u76d1\u89c6\u5668\u9501object's monitor\uff0c\u5426\u5219\u4f1a\u629b\u51faIllegalMonitorStateException\uff0c\u4e5f\u5c31\u662f\u4e00\u5b9a\u8981\u5728synchronized\u540c\u6b65\u4ee3\u7801\u5757\u5185\u8c03\u7528wait()\u3002\u56e0\u4e3a\u5e95\u5c42\u662f\u57fa\u4e8e\u9501\u5bf9\u8c61\u7684monitor\u5b9e\u73b0\u7684\u3002</p> <pre><code>public final native void wait(long timeout) throws InterruptedException;\n\npublic final void wait(long timeout, int nanos) throws InterruptedException {\n    if (nanos &lt; 0 || nanos &gt; 999999) {\n        throw new IllegalArgumentException(\n            \"nanosecond timeout value out of range\");\n    }\n    if (nanos &gt;= 500000 || (nanos != 0 &amp;&amp; timeout == 0)) {\n        timeout++;\n    }\n\n    wait(timeout);\n}\n\npublic final void wait() throws InterruptedException {\n    wait(0);\n}\n</code></pre> <p>wait\u65b9\u6cd5\u5bf9\u5e94\u7684native\u662fJVM_MonitorWait\uff1a\u91cc\u9762\u901a\u8fc7ObjectMonitor\u7684<code>void wait(jlong millis, bool interruptable, TRAPS);</code>\u5b9e\u73b0\uff0c\u5c06\u5f53\u524d\u7ebf\u7a0b\u5c01\u88c5\u6210node\uff0c\u653e\u5165ObjectWaiter \u7684_WaitSet \u4e2d\uff0c\u5e76\u9000\u51famonitor\u91ca\u653e\u9501\uff0c\u7136\u540e\u8c03\u7528park()\u6302\u8d77\u81ea\u8eab\u3002</p> <p>notify()\u65b9\u6cd5\u6700\u7ec8\u901a\u8fc7ObjectMonitor\u7684notify(TRAPS)\u5b9e\u73b0\uff1a\u5982\u679c\u5f53\u524d<code>_WaitSet</code>\u4e3a\u7a7a\uff0c\u5373\u6ca1\u6709\u6b63\u5728\u7b49\u5f85\u7684\u7ebf\u7a0b\uff0c\u76f4\u63a5\u8fd4\u56de\uff1b\u5426\u5219\u83b7\u53d6<code>_WaitSet</code>\u5217\u8868\u7684\u7b2c\u4e00\u4e2aObjectWaitor\u8282\u70b9\uff0c\u7136\u540e\u6839\u636e\u4e0d\u540c\u7684\u8c03\u5ea6\u7b56\u7565\uff0c\u9009\u62e9\u5934\u63d2\u5165\u6cd5\u6216\u8005\u5c3e\u63d2\u5165\u6cd5\u653e\u5230entryList\u6216\u8005cxq;\u6700\u540e\u8c03\u7528unpark()\u65b9\u6cd5\u5524\u9192\u963b\u585e\u5728\u6761\u4ef6\u53d8\u91cf\u4e0a\u7684\u7ebf\u7a0b\u3002</p> <p>\u88ab\u5524\u9192\u7684\u7ebf\u7a0b\u4f1a\u91cd\u65b0\u7ade\u4e89\u8be5\u9501\u5bf9\u8c61\uff0c\u5982\u679c\u8c03\u7528notify\u7684\u7ebf\u7a0b\u9000\u51fa\u540c\u6b65\u4ee3\u7801\u5757\uff0cwait\u7684\u7ebf\u7a0b\u6709\u53ef\u80fd\u83b7\u53d6\u5230\u9501\u5bf9\u8c61\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#3-sleeptimeout","title":"3. sleep(timeout)","text":"<p>sleep\u51fd\u6570\u8ba9\u6267\u884c\u7ebf\u7a0b\u4f11\u7720\u6307\u5b9a\u65f6\u95f4\uff0c\u4e0d\u91ca\u653e\u9501\u8d44\u6e90\uff08\u76f4\u63a5\u8d70\u7684\u7cfb\u7edf\u5e93\u51fd\u6570\uff0c\u4e0d\u6d89\u53ca\u4ec0\u4e48\u9501\uff09\uff0c\u7761\u7720\u671f\u95f4\u4e2d\u65ad\u4f1a\u629b\u51faInterruptedException\u3002</p> <pre><code>JVM_ENTRY(void, JVM_Sleep(JNIEnv* env, jclass threadClass, jlong millis))\n  if (millis &lt; 0) {\n    THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), \"timeout value is negative\");\n  }\n\n  // \u5982\u679c\u7ebf\u7a0b\u88ab\u4e2d\u65ad\uff0c\u629b\u51fa\u4e2d\u65ad\u5f02\u5e38\n  if (thread-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {\n    THROW_MSG(vmSymbols::java_lang_InterruptedException(), \"sleep interrupted\");\n  }\n\n  // Save current thread state and restore it at the end of this block.\n  // And set new thread state to SLEEPING.\n  JavaThreadSleepState jtss(thread);\n\n  HOTSPOT_THREAD_SLEEP_BEGIN(millis);\n  EventThreadSleep event;\n\n  if (millis == 0) {\n    // \u5982\u679csleep(0),\u6548\u679c\u7b49\u540c\u4e8eyield\n    os::naked_yield();\n  } else {\n    ThreadState old_state = thread-&gt;osthread()-&gt;get_state();\n    thread-&gt;osthread()-&gt;set_state(SLEEPING);\n    // \u5982\u679c\u7761\u7720\u671f\u95f4\u88ab\u4e2d\u65ad,\u629b\u51fa\u5f02\u5e38\n    if (!thread-&gt;sleep(millis)) { // interrupted\n      // An asynchronous exception (e.g., ThreadDeathException) could have been thrown on\n      // us while we were sleeping. We do not overwrite those.\n      if (!HAS_PENDING_EXCEPTION) {\n        if (event.should_commit()) {\n          post_thread_sleep_event(&amp;event, millis);\n        }\n        // \u8bbe\u7f6e\u5f02\u5e38\u7ed3\u675f\uff0c\u6b63\u5e38\u7ed3\u675f\u89c1\u672b\u5c3e\u4e3a0\n        HOTSPOT_THREAD_SLEEP_END(1);\n\n        // TODO-FIXME: THROW_MSG returns which means we will not call set_state()\n        // to properly restore the thread state.  That's likely wrong.\n        THROW_MSG(vmSymbols::java_lang_InterruptedException(), \"sleep interrupted\");\n      }\n    }\n    // sleep\u7ed3\u675f\uff0c\u91cd\u65b0\u8bbe\u7f6e\u4e3a\u65e7\u72b6\u6001\n    thread-&gt;osthread()-&gt;set_state(old_state);\n  }\n  if (event.should_commit()) {\n    post_thread_sleep_event(&amp;event, millis);\n  }\n  HOTSPOT_THREAD_SLEEP_END(0);\nJVM_END\n</code></pre> <p>\u64cd\u4f5c\u7cfb\u7edf\u7684sleep(millis)\u51fd\u6570\u662f\u5728\u6302\u8d77\u539f\u8bed\u7684\u57fa\u7840\u4e0a\u5229\u7528\u5b9a\u65f6\u5668\u5b9e\u73b0\u7684\u3002</p> <ul> <li>\u6302\u8d77\u8fdb\u7a0b\uff08\u6216\u7ebf\u7a0b\uff09\u5e76\u4fee\u6539\u5176\u8fd0\u884c\u72b6\u6001</li> <li>\u7528sleep()\u63d0\u4f9b\u7684\u53c2\u6570\u6765\u8bbe\u7f6e\u4e00\u4e2a\u5b9a\u65f6\u5668\u3002</li> <li>\u5f53\u65f6\u95f4\u7ed3\u675f\uff0c\u5b9a\u65f6\u5668\u4f1a\u89e6\u53d1\uff0c\u5185\u6838\u6536\u5230\u4e2d\u65ad\u540e\u4fee\u6539\u8fdb\u7a0b\uff08\u6216\u7ebf\u7a0b\uff09\u7684\u8fd0\u884c\u72b6\u6001\u3002\u4f8b\u5982\u7ebf\u7a0b\u4f1a\u88ab\u6807\u5fd7\u4e3a\u5c31\u7eea\u800c\u8fdb\u5165\u5c31\u7eea\u961f\u5217\u7b49\u5f85\u8c03\u5ea6\u3002</li> </ul>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#4-yield","title":"4. Yield()","text":"<p>\u5411\u8c03\u5ea6\u7a0b\u5e8f\u63d0\u793a\u5f53\u524d\u7ebf\u7a0b\u613f\u610f\u653e\u5f03\u5176\u5f53\u524d\u5bf9\u5904\u7406\u5668\u7684\u4f7f\u7528\u3002 \u8c03\u5ea6\u7a0b\u5e8f\u53ef\u4ee5\u968f\u610f\u5ffd\u7565\u6b64\u63d0\u793a\u3002</p> <pre><code>JVM_ENTRY(void, JVM_Yield(JNIEnv *env, jclass threadClass))\n  // \u662f\u5426\u8bbe\u7f6e\u4e86DontYieldALot\u53c2\u6570,\u9ed8\u8ba4\u4e3afasle\u3002\u4e3atrue\u5219\u76f4\u63a5\u8fd4\u56de\n  if (os::dont_yield()) return;\n  HOTSPOT_THREAD_YIELD();\n  // \u8c03\u7528\u7cfb\u7edf\u7684naked_yield\uff0c\u5b83\u4f1a\u4f7f\u8c03\u7528\u7ebf\u7a0b\u653e\u5f03CPU\u4f7f\u7528\u6743\uff0c\u52a0\u5165\u5230\u540c\u7b49\u4f18\u5148\u7ea7\u961f\u5217\u7684\u672b\u5c3e\n  os::naked_yield();\nJVM_END\n</code></pre>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#_2","title":"\u7ebf\u7a0b\u7684\u4e2d\u65ad","text":"<p>\u8981\u7406\u89e3\uff0c\u7ebf\u7a0b\u4efb\u4f55\u65f6\u5019\u90fd\u53ef\u80fd\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u4e0b\u9762\u5206\u4e24\u4e2a\u60c5\u51b5\u6765\u8ba8\u8bba\uff1a</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#1","title":"1. \u7ebf\u7a0b\u8fd0\u884c\u671f\u95f4\u6536\u5230\u4e2d\u65ad","text":"<p>\u7ebf\u7a0b\u5728\u8fd0\u884c\u671f\u95f4RUNNABLE,\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u662f\u53ef\u5904\u7406\u53ef\u4e0d\u5904\u7406\u7684\uff01\u5982\u679c\u60f3\u5904\u7406\uff0c\u6709\u4e24\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u68c0\u6d4b\u5230\u4e2d\u65ad\u4fe1\u53f7:</p> <ul> <li>Thread.interrupted() \u9759\u6001\u65b9\u6cd5</li> </ul> <pre><code>// \u6d4b\u8bd5\u5f53\u524d\u7ebf\u7a0b\u662f\u5426\u88ab\u4e2d\u65ad\u3002 \u901a\u8fc7\u8be5\u65b9\u6cd5\u6e05\u9664\u7ebf\u7a0b\u7684\u4e2d\u65ad\u72b6\u6001\npublic static boolean interrupted() {\n    return currentThread().isInterrupted(true);\n}\n</code></pre> <ul> <li>\u68c0\u6d4b\u662f\u5426\u4e2d\u65ad</li> </ul> <pre><code>// \u5b9e\u4f8b\u65b9\u6cd5\uff0c\u6d4b\u8bd5\u6b64\u7ebf\u7a0b\u662f\u5426\u5df2\u88ab\u4e2d\u65ad\u3002 \u7ebf\u7a0b\u7684\u4e2d\u65ad\u72b6\u6001\u4e0d\u53d7\u6b64\u65b9\u6cd5\u7684\u5f71\u54cd\npublic boolean isInterrupted() {\n    return isInterrupted(false);\n}\n</code></pre> <p>\u6ce8\u610f\u5982\u679c\u7ebf\u7a0b\u6ca1\u6709\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u5c06\u4e0d\u4f1a\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u4e0a\u9762\u4e24\u4e2a\u65b9\u6cd5\u8fd4\u56defalse\u3002</p> <p>\u4e24\u4e2a\u65b9\u6cd5\u8c03\u7528\u7684\u90fd\u662f\u7cfb\u7edf\u63d0\u4f9b\u7684<code>private native boolean isInterrupted(boolean ClearInterrupted);</code>\uff0c\u533a\u522b\u662f\u4e00\u4e2a\u4f1a\u6e05\u9664\u4e2d\u65ad\u72b6\u6001\uff0c\u4e00\u4e2a\u4e0d\u4f1a\u6e05\u9664\u4e2d\u65ad\u72b6\u6001\u3002</p> <p>apollo\u91cc\u6709\u5f88\u591a\u8fd9\u6837\u7684\u4f8b\u5b50\uff1awhile\u5faa\u73af\u7684\u5224\u65ad\u6761\u4ef6\u91cc\uff0c\u5982\u679c\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u5c31\u505c\u6b62\u5faa\u73af\u6267\u884c\uff1a</p> <pre><code>executorService.submit((Runnable) () -&gt; {\n    //wait for the request connected to server\n    while (!stop.get() &amp;&amp; !Thread.currentThread().isInterrupted()) {\n        try {\n            TimeUnit.MILLISECONDS.sleep(100);\n        } catch (InterruptedException e) {\n        }\n\n        //double check\n        if (stop.get()) {\n            break;\n        }\n\n        sendReleaseMessage(message);\n    }\n});\n</code></pre>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#2-interruptedexception","title":"2. \u7ebf\u7a0b\u4f11\u7720\u6216\u963b\u585e\u72b6\u6001 \u629b\u51faInterruptedException","text":"<p>\u5f53\u7ebf\u7a0b\u5904\u4e8ewaiting, sleeping\u6216\u8005\u5176\u4ed6\u88ab\u5360\u7528\u5982\u7b49\u5f85IO\u65f6\uff0c\u5982\u679c\u6536\u5230\u4e2d\u65ad\u4fe1\u53f7\uff0c\u4f1a\u629b\u51faInterruptedException\u3002\uff08\u53ef\u4ee5\u8fd9\u6837\u7406\u89e3\uff0c\u5904\u7406\u4e2d\u65ad\u7a0b\u5e8f\u662f\u9700\u8981\u7ebf\u7a0b\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\u83b7\u53d6CPU\u6267\u884c\u6743\u7684\uff0c\u4f46\u662f\u73b0\u5728\u65f6\u4f11\u7720\u6216\u8005\u963b\u585e\u72b6\u6001\u6ca1\u6709CPU\u6267\u884c\u6743\uff0c\u6240\u4ee5\u662f\u4e0d\u53ef\u4e2d\u65ad\u7684\uff0c\u4f1a\u629b\u51fa\u5f02\u5e38\uff09</p> <p>\u50cfwait()\uff0cwait(long)\uff0csleep(long)\u65b9\u6cd5\uff0c\u4e5f\u5c31\u662f\u7ebf\u7a0b\u5728WAITING, TIMED_WAITING,\u671f\u95f4\u90fd\u4f1a\u629b\u51faInterruptedException</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#future","title":"Future\u5f02\u6b65\u6267\u884c\u7ed3\u679c","text":""},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#1-futuretask","title":"1. FutureTask\u83b7\u53d6\u5f02\u6b65\u7684\u6267\u884c\u7ed3\u679c","text":"<p>Future\u53ef\u4ee5\u83b7\u53d6\u5f02\u6b65\u8ba1\u7b97\u7684\u7ed3\u679c\uff0c\u5e76\u63d0\u4f9b\u8d85\u65f6\u529f\u80fd\u3002 \u63d0\u4f9b\u4e86</p> <ul> <li>\u68c0\u67e5\u8ba1\u7b97\u662f\u5426\u5b8c\u6210isDone()\u65b9\u6cd5\uff1a\u5982\u679c\u4efb\u52a1\u6b63\u5e38\u6267\u884c\u7ed3\u675f\uff0c\u629b\u51fa\u5f02\u5e38\u6216\u8005\u88ab\u53d6\u6d88\uff0c\u90fd\u4f1a\u8fd4\u56detrue</li> <li>\u7b49\u5f85\u8ba1\u7b97\u5b8c\u6210get(timeout)\uff1a\u963b\u585e\u7684\u8fdb\u884c\u7b49\u5f85\uff0c\u76f4\u5230\u8ba1\u7b97\u5b8c\u6210\u6216\u8005\u8d85\u65f6\u3002\u8ba1\u7b97\u5b8c\u6210\u540e\u53ef\u4ee5\u68c0\u7d22\u7ed3\u679c</li> </ul> <p>FutureTask\u662fFuture\u7684\u57fa\u672c\u5b9e\u73b0\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86Runnable\u63a5\u53e3\uff0c\u53ef\u4ee5\u76f4\u63a5\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\u6267\u884c\u3002</p> <p></p> <p>\u6211\u4eec\u8981\u77e5\u9053FutureTask\u7684\u5e95\u5c42\u539f\u7406\uff0c\u600e\u4e48\u83b7\u53d6\u5f02\u6b65\u7684\u6267\u884c\u7ed3\u679c\uff1f</p> <p>\u4efb\u52a1\u7684\u72b6\u6001\u6709\uff1a</p> <pre><code>private static final int NEW          = 0;\nprivate static final int COMPLETING   = 1;\nprivate static final int NORMAL       = 2;\nprivate static final int EXCEPTIONAL  = 3;\nprivate static final int CANCELLED    = 4;\nprivate static final int INTERRUPTING = 5;\nprivate static final int INTERRUPTED  = 6;\n</code></pre> <p>\u53ef\u80fd\u7684\u72b6\u6001\u8f6c\u6362\uff1a CAS\u8fdb\u884c\u72b6\u6001\u8f6c\u6362</p> <ul> <li>NEW -&gt; COMPLETING -&gt; NORMAL \u6b63\u5e38\u6267\u884c\u5f97\u5230\u7ed3\u679c</li> <li>NEW -&gt; COMPLETING -&gt; EXCEPTIONAL  \u6267\u884c\u8fc7\u7a0b\u4e2d\u53d1\u751f\u5f02\u5e38</li> <li>NEW -&gt; CANCELED </li> <li>NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</li> </ul> <p>\u6784\u9020\u51fd\u6570\u6709\uff1a</p> <pre><code>// \u901a\u8fc7Callable\u6765\u521b\u5efa\npublic FutureTask(Callable&lt;V&gt; callable) {\n    if (callable == null)\n        throw new NullPointerException();\n    this.callable = callable;\n    this.state = NEW;       // ensure visibility of callable\n}\n\n// \u901a\u8fc7Runnable\u6765\u521b\u5efa\uff0c\u5185\u90e8\u4f1a\u5c06Runnable\u8f6c\u6362\u4e3acallable\u3002result\u8d1f\u8d23\u6267\u884c\u8fc7\u7a0b\u4e2d\u63a5\u53d7\u7ed3\u679c\u5f15\u7528\npublic FutureTask(Runnable runnable, V result) {\n    this.callable = Executors.callable(runnable, result);\n    this.state = NEW;       // ensure visibility of callable\n}\n</code></pre> <p>FutureTask\u672c\u8eab\u662f\u5b9e\u73b0\u4e86Runnable\u63a5\u53e3\u7684\uff0c\u5148\u770b\u5176run\u65b9\u6cd5</p> <pre><code>public void run() {\n    // \u4efb\u52a1\u72b6\u6001\u4e0d\u662fnew\uff0c\u6216\u8005CAS\u8bbe\u7f6e\u4e3a\u5f53\u524d\u7ebf\u7a0b\uff0c\u56e0\u4e3a\u53ef\u80fd\u6709\u591a\u4e2a\u7ebf\u7a0b\u7ade\u4e89\n    if (state != NEW ||\n        !RUNNER.compareAndSet(this, null, Thread.currentThread()))\n        return;\n    try {\n        Callable&lt;V&gt; c = callable;\n        if (c != null &amp;&amp; state == NEW) {\n            V result;\n            boolean ran;\n            try {\n                // \u6267\u884ccallable,\n                result = c.call();\n                // ran\u662frun\u7684\u8fc7\u53bb\u5f0f\uff0c\u8868\u793a\u662f\u5426\u6267\u884c\u8fc7\n                ran = true;\n            } catch (Throwable ex) {\n                result = null;\n                ran = false;\n                // \u8bbe\u7f6e\u72b6\u6001\u4e3a\u5f02\u5e38\uff0c\u91cc\u9762\u4e5f\u4f1a\u6267\u884cfinishCompletion()\n                setException(ex);\n            }\n            // \u5982\u679c\u6267\u884c\u6210\u529f\uff0c\u8bbe\u7f6e\u7ed3\u679c\uff0c\u91cc\u9762\u4e5f\u4f1a\u6267\u884cfinishCompletion()\n            if (ran)\n                set(result);\n        }\n    } finally {\n        // runner must be non-null until state is settled to\n        // prevent concurrent calls to run()\n        runner = null;\n        // state must be re-read after nulling runner to prevent\n        // leaked interrupts\n        int s = state;\n        if (s &gt;= INTERRUPTING)\n            handlePossibleCancellationInterrupt(s);\n    }\n}\n</code></pre> <p>\u770b\u4e00\u4e0b\u5185\u90e8\u7684\u65b9\u6cd5</p> <pre><code>// \u6b63\u5e38\u7ebf\u7a0b\u6267\u884c\u5b8c\u6210\u4f1a\u8c03\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u628a\u6267\u884c\u7ed3\u679c\u8d4b\u503c\u7ed9outcome\nprotected void set(V v) {\n    // \u6ce8\u610f\u8fd9\u91cc\u662f\u6ca1\u6709\u9501\u7684\uff0c\u800c\u662f\u91c7\u7528\u4e86cas\u7684\u65b9\u5f0f\uff0c\u53ea\u6709\u5728\u66f4\u65b0\u6210\u529f\u7684\u60c5\u51b5\u4e0b\u4f1a\u8fdb\u5165\u903b\u8f91\n    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n        outcome = v;\n        // \u8d4b\u503c\u5b8c\u6210\u66f4\u65b0\u6700\u540e\u7684\u7ebf\u7a0b\u72b6\u6001\n        UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state\n        finishCompletion();\n    }\n}\n\n// \u7b49\u5f85\u7ebf\u7a0b\u7684\u5524\u9192\u4ee5\u53ca\u7ebf\u7a0b\u6267\u884c\u5b8c\u6210\u7684\u6536\u5c3e\u5de5\u4f5c\uff0c\u5982\u8f85\u52a9gc\u7684\u63aa\u65bd\nprivate void finishCompletion() {\n    // \u5047\u8bbe state &gt; COMPLETING;\n    // \u8fd9\u91cc\u5b83\u6ca1\u6709\u76f4\u63a5\u83b7\u53d6\u6240\u6709waiter\u5bf9\u8c61\u7684\u65b9\u6cd5\uff0c\u50cf\u662flist\u90a3\u79cd\uff0c\u53ea\u80fd\u5faa\u73af\u83b7\u53d6next\n    for (WaitNode q; (q = waiters) != null;) {\n        // \u5c1d\u8bd5\u5c06\u6240\u6709waiters\u5168\u90e8\u7f6e\u4e3anull\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            for (;;) {\n                Thread t = q.thread;\n                if (t != null) {\n                    // \u8f85\u52a9gc\u5c06\u6307\u9488\u5bf9\u8c61\u7f6e\u7a7a\uff0c\u8fd9\u6837\u5b83\u5c31\u6ca1\u6709\u5f15\u7528\u8def\u5f84\u4e86\n                    q.thread = null;\n                    // \u5524\u9192\u90a3\u4e9b\u8c03\u7528get\u65b9\u6cd5 \u800cpark\u963b\u585e\u7b49\u5f85\u7684\u7ebf\u7a0b\n                    LockSupport.unpark(t);\n                }\n                // \u67e5\u770b\u4e0b\u4e2a\u8282\u70b9\u662f\u4e0d\u662f\u8fd8\u662f\u7a7a\u7684\uff0c\u5982\u679c\u4e0d\u662f\u7a7a\u7684\u5c31\u7ee7\u7eed\uff0c\u4e3a\u7a7a\u5c31\u9000\u51fa\u5faa\u73af\n                WaitNode next = q.next;\n                if (next == null)\n                    break;\n                // \u8fd9\u91cc\u540c\u6837\u9700\u8981\u5c06\u6307\u9488\u5bf9\u8c61\u7f6e\u7a7a\n                q.next = null;\n                q = next;\n            }\n            break;\n        }\n    }\n    // \u8fd9\u4e2a\u65b9\u6cd5\u9ed8\u8ba4\u662f\u7a7a\u7684\uff0c\u53ef\u4ee5\u5728\u7ee7\u627f\u7c7b\u4e2d\u5b9e\u73b0\u5b83\uff0c\u7136\u540e\u5728\u7ebf\u7a0b\u6267\u884c\u5b8c\u6210\u4e4b\u540e\u9644\u52a0\u4e00\u4e9b\u65b9\u6cd5\n    done();\n    callable = null;        // to reduce footprint\n}\n</code></pre> <p>\u6211\u4eec\u80af\u5b9a\u662f\u8981\u83b7\u53d6\u5f02\u6b65\u6267\u884c\u7ed3\u679c\u7684\uff0c\u6240\u4ee5\u770b\u4e0bget()\u65b9\u6cd5\uff1a</p> <p>\u7b80\u5355\u603b\u7ed3\u5c31\u662f\uff1a\u5982\u679c\u4efb\u52a1\u72b6\u6001\u6ca1\u6709\u7ed3\u675f\uff0cget\u7ebf\u7a0b\u5c31\u901a\u8fc7park()\u963b\u585e\uff0c\u5e76\u4f1a\u5f62\u6210\u4e00\u4e2a\u7b80\u5355\u7684waiters\u7b49\u5f85\u94fe\u8868\u3002\u5f53\u4efb\u52a1\u7ed3\u675f\u65f6\u4e0d\u7ba1\u4efb\u52a1\u72b6\u6001\u662f\u5f02\u5e38\u8fd8\u662f\u6b63\u5e38\u7ed3\u675f\uff0c\u90fd\u4f1a\u6328\u4e2a\u5524\u9192\u7b49\u5f85\u7684\u7ebf\u7a0b\u3002</p> <pre><code>public V get() throws InterruptedException, ExecutionException {\n    int s = state;\n    // \u5c0f\u4e8eCOMPLETING\u53ea\u6709new\u72b6\u6001\uff0c\u8fdb\u884c\u7b49\u5f85\n    if (s &lt;= COMPLETING)\n        s = awaitDone(false, 0L);\n    // \u4efb\u52a1\u7ed3\u675f\uff0c\u4f1a\u5524\u9192\u5f53\u524d\u7ebf\u7a0b\uff0c\u6267\u884c\u4e0b\u9762\u4ee3\u7801\u8fd4\u56de\u7ed3\u679c\n    return report(s);\n}\n\n//\u542b\u8d85\u65f6\u65f6\u95f4\u7684\u53d6\u503c\u8fc7\u7a0b\npublic V get(long timeout, TimeUnit unit) \n    throws InterruptedException, ExecutionException, TimeoutException {\n    if (unit == null)\n        throw new NullPointerException();\n    int s = state;\n    //\u5982\u679c\u662f\u4e2d\u95f4\u72b6\u6001\uff0c\u5c31\u7b49\u5f85task\u5b8c\u6210\uff0c\u5982\u679c\u8d85\u8fc7\u4e86\u6307\u5b9a\u65f6\u95f4\uff0ctask\u4ecd\u672a\u5b8c\u6210\uff0c\u5219\u629b\u51fa\u8d85\u65f6\u5f02\u5e38\n    if (s &lt;= COMPLETING &amp;&amp; (s = awaitDone(true, unit.toNanos(timeout))) &lt;= COMPLETING) \n        throw new TimeoutException();\n    return report(s); //\u8fd4\u56de\u5bf9\u5e94\u7684\u7ed3\u679c\n}\n\n// \u7b49\u5f85\u65b9\u6cd5\u6709\u4e24\u4e2a\u5165\u53c2\uff0c\u4e00\u4e2a\u662f\u5426\u5141\u8bb8\u7b49\u5f85\uff0c\u4e00\u4e2a\u662f\u7b49\u5f85\u65f6\u95f4\nprivate int awaitDone(boolean timed, long nanos)\n    throws InterruptedException {\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    WaitNode q = null;\n    // \u662f\u5426\u5165\u961f\n    boolean queued = false;\n    // \u8fd9\u91cc\u7684\u65e0\u9650\u5faa\u73af\u662f\u4e3a\u4e86\u5565\u5462\uff1f\u5c3d\u53ef\u80fd\u7684\u66f4\u65e9\u83b7\u53d6\u6700\u65b0\u4efb\u52a1\u72b6\u6001\uff1f\n    for (;;) {\n        // 0.\u5982\u679c\u7ebf\u7a0b\u88ab\u4e2d\u65ad\uff0c\u79fb\u9664\u5f53\u524d\u7ed3\u70b9\uff0c\u5e76\u629b\u51fa\u5f02\u5e38\n        if (Thread.interrupted()) {\n            removeWaiter(q);\n            throw new InterruptedException();\n        }\n        // \u8fd9\u91cc\u6839\u636e\u4efb\u52a1\u7684\u72b6\u6001\u5206\u51e0\u79cd\u60c5\u51b5\u5904\u7406\n        int s = state;\n        // 1.\u5982\u679c\u4efb\u52a1\u5df2\u7ecf\u7ed3\u675f\uff0c\u628a\u7b49\u5f85\u7684\u7ebf\u7a0b\u7f6e\u7a7a\uff0c\u7136\u540e\u8fd4\u56de\n        if (s &gt; COMPLETING) {\n            if (q != null)\n                q.thread = null;\n            return s;\n        }\n        // 2.\u5982\u679c\u4efb\u52a1\u6b63\u5728\u6267\u884c\u4e2d\uff0c\u90a3\u5f88\u5feb\u5e94\u8be5\u6267\u884c\u5b8c\uff0cyield()\u8ba9\u51faCPU\u6267\u884c\u6743\u5373\u53ef\n        else if (s == COMPLETING) // cannot time out yet\n            Thread.yield();\n        // 3.\u4ee3\u7801\u5230\u8fd9\u91cc\u4efb\u52a1\u72b6\u6001\u5e94\u8be5\u662fNEW\u5427\uff1f\u521d\u59cb\u5316\u4e00\u4e2a\u7b49\u5f85\u8282\u70b9\uff0c\u5bf9\u8c61\u4e2d\u5305\u542b\u4e0b\u4e2a\u8282\u70b9\u7684\u6307\u9488\u4ee5\u53ca\u5f53\u524d\u7ebf\u7a0b\n        else if (q == null)\n            q = new WaitNode();\n        // 4.\u7b2c\u4e00\u6b21\u80af\u5b9aqueued=false\n        else if (!queued)\n            // \u8fd9\u628a\u65b0\u7684WaitNode\u653e\u5728waiters\u7684\u6700\u524d\u9762\n            queued = UNSAFE.compareAndSwapObject(this, waitersOffset,\n                                                 q.next = waiters, q);\n        // 5.\u8fd9\u91cc\u6309\u7167\u5165\u53c2\u8981\u6c42\u6267\u884cpark\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\n        // \u540e\u7eed\u4efb\u52a1\u7ed3\u675f\u4f1a\u5728finishCompletion\u91cc\u9762\u8c03\u7528unpark\u5b8c\u6210\u7ebf\u7a0b\u7684\u5524\u9192\n        else if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos &lt;= 0L) {\n                removeWaiter(q);\n                return state;\n            }\n            LockSupport.parkNanos(this, nanos);\n        }\n        // 6. \u4ee3\u7801\u5230\u8fd9\u91cc\u8bf4\u660e\uff0c\u5df2\u7ecf\u6dfb\u52a0\u5230waiter\u91cc\uff0c\u4e14\u8fd8\u662fNEW\u72b6\u6001\u3002\u90a3\u4e48\u7ebf\u7a0b\u963b\u585e\uff0c\u76f4\u5230\u88ab\u5524\u9192\n        else\n            LockSupport.park(this);\n    }\n}\n</code></pre>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#2completablefuture","title":"2.CompletableFuture","text":"<p>\u4e0a\u9762\u7684Future\u867d\u7136\u53ef\u4ee5\u83b7\u53d6\u5f02\u6b65\u6267\u884c\u7684\u7ed3\u679c\uff0c\u4f46\u662f\u83b7\u53d6\u662f\u963b\u585e\u5f0f\u7684\uff0c\u53c8\u53d8\u6210\u4e86\u540c\u6b65\uff0c\u5f88\u4e0d\u65b9\u4fbf\u3002</p> <p>Java8\u65b0\u589e\u7684CompletableFuture\u7c7b\u501f\u9274\u4e86Google Guava\u7684ListenableFuture\uff0c\u5b83\u5305\u542b50\u591a\u4e2a\u65b9\u6cd5\uff0c\u63d0\u4f9b\u4e86\u975e\u5e38\u5f3a\u5927\u7684Future\u6269\u5c55\u529f\u80fd\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u7b80\u5316\u5f02\u6b65\u7f16\u7a0b\u7684\u590d\u6742\u6027\uff0c\u7ed3\u5408\u51fd\u6570\u5f0f\u7f16\u7a0b\uff0c\u901a\u8fc7\u56de\u8c03\u7684\u65b9\u5f0f\u5904\u7406\u8ba1\u7b97\u7ed3\u679c\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86\u8f6c\u6362\u548c\u7ec4\u5408CompletableFuture\u7684\u591a\u79cd\u65b9\u6cd5\uff0c\u53ef\u4ee5\u6ee1\u8db3\u5927\u90e8\u5206\u5f02\u6b65\u56de\u8c03\u573a\u666f\u3002</p> <p>CompletableFuture\u9ed8\u8ba4\u4f7f\u7528\u7684\u7ebf\u7a0b\u6c60\u662fforkJoinPool\uff0c<code>execAsync(ForkJoinPool.commonPool(), new AsyncSupply&lt;U&gt;(supplier, f));</code></p> <p>\u5e38\u89c1API</p> <ul> <li>\u8f6c\u6362 thenApplyAsync</li> </ul> <p>\u5f02\u6b65\u4efb\u52a1f2\u9700\u8981\u5f02\u6b65\u4efb\u52a1f1\u7684\u7ed3\u679c\u624d\u80fd\u6267\u884c\uff0c\u4f46\u5bf9\u4e8e\u6211\u4eec\u7684\u4e3b\u7ebf\u7a0b\u6765\u8bf4\uff0c\u65e0\u987b\u7b49\u5230f1\u8fd4\u56de\u7ed3\u679c\u540e\u518d\u8c03\u7528\u51fd\u6570f2\uff0c\u5373\u4e0d\u4f1a\u963b\u585e\u4e3b\u6d41\u7a0b\uff0c\u800c\u662f\u544a\u8bc9CompletableFuture\u5f53\u6267\u884c\u5b8c\u4e86f1\u7684\u65b9\u6cd5\u518d\u53bb\u6267\u884cf2\uff0c\u53ea\u6709\u5f53\u9700\u8981\u6700\u540e\u7684\u7ed3\u679c\u65f6\u518d\u83b7\u53d6\u3002</p> <pre><code>CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -&gt;\n    \"hello\"\n);\n// f2\u4f9d\u8d56f1\u7684\u7ed3\u679c\u505a\u8f6c\u6362\nCompletableFuture&lt;String&gt; f2 = f1.thenApplyAsync(t -&gt;\n    t + \" world\"\n);\nSystem.out.println(\"\u5f02\u6b65\u7ed3\u679c:\" + f2.get());\n\n// \u8f93\u51fa\u7ed3\u679c\uff1a\n\u5f02\u6b65\u7ed3\u679c:hello world\n</code></pre> <ul> <li>\u7ec4\u5408\uff1athenComposeAsync</li> </ul> <pre><code>CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -&gt;\n    \"hello\"\n);\n// f2\u867d\u7136\u4f9d\u8d56f1\u7684\u7ed3\u679c\uff0c\u4f46\u4e0d\u4f1a\u7b49\u5f85f1\u7ed3\u679c\u8fd4\u56de\uff0c\u800c\u662f\u518d\u5305\u88c5\u6210\u4e00\u4e2afuture\u8fd4\u56de\nCompletableFuture&lt;String&gt; f2 = f1.thenComposeAsync(t -&gt;\n    CompletableFuture.supplyAsync(() -&gt;\n            t + \" world\"\n    )\n);\n// \u7b49\u5230\u771f\u6b63\u8c03\u7528\u7684\u65f6\u5019\u518d\u6267\u884cf2\u91cc\u7684\u903b\u8f91\nSystem.out.println(\"\u5f02\u6b65\u7ed3\u679c:\" + f2.get());\n\n// \u8f93\u51fa\u7ed3\u679c\uff1a\n\u5f02\u6b65\u7ed3\u679c:hello world\n</code></pre> <ul> <li>\u5408\u5e76\uff1athenCombineAsync</li> </ul> <p>\u4e24\u4e2a\u5f02\u6b65\u4efb\u52a1f1\u3001f2\u662f\u5e76\u884c\u6267\u884c\uff0c\u5f7c\u6b64\u65e0\u5148\u540e\u4f9d\u8d56\u987a\u5e8f\uff0cthenCombineAsync\u9002\u5408\u5c06\u4e24\u4e2a\u5e76\u884c\u6267\u884c\u7684\u5f02\u6b65\u4efb\u52a1\u7684\u7ed3\u679c\u5408\u5e76\u8fd4\u56de\u6210\u4e00\u4e2a\u65b0\u7684future\u3002</p> <pre><code>CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -&gt; {\n    try {\n        Thread.sleep(1000); // \u6a21\u62df\u63a5\u53e3\u8c03\u7528\u8017\u65f61\u79d2\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n    return \"hello\";\n});\nCompletableFuture&lt;String&gt; f2 = CompletableFuture.supplyAsync(() -&gt; {\n    try {\n        Thread.sleep(1000); // \u6a21\u62df\u63a5\u53e3\u8c03\u7528\u8017\u65f61\u79d2\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n    return \" world\";\n});\nCompletableFuture&lt;String&gt; f3 = f1.thenCombineAsync(f2, (t1, t2) -&gt;\n    t1 + t2\n);\nlong time = System.currentTimeMillis();\nSystem.out.println(\"\u5f02\u6b65\u7ed3\u679c:\" + f3.get());\nSystem.out.println(\"\u8017\u65f6:\" + (System.currentTimeMillis() - time));\n\n// \u8f93\u51fa\u7ed3\u679c\uff1a\n\u5f02\u6b65\u7ed3\u679c:hello world\n\u8017\u65f6:1002\n</code></pre> <p>applyToEitherAsync\u662f\u54ea\u4e2afuture\u5148\u6267\u884c\u5b8c\u5c31\u8fd4\u56de\u54ea\u4e2a\uff0c\u53e6\u5916acceptEither\u65b9\u6cd5\u548c\u8fd9\u4e2a\u7c7b\u4f3c\uff0c\u4f46\u662f\u6ca1\u6709\u8fd4\u56de\u503c\u3002</p> <p>\u524d\u9762\u8bb2\u7684compose,combine,either\u90fd\u662f\u5904\u7406\u4e24\u4e2afuture\u7684\u65b9\u6cd5\uff0c\u5982\u679c\u662f\u8d85\u8fc72\u4e2a\u7684\u53ef\u4ee5\u4f7f\u7528allOf\u6216anyOf\u3002allOf\u65b9\u6cd5\u662f\u5f53\u6240\u6709\u7684CompletableFuture\u90fd\u6267\u884c\u5b8c\u540e\u6267\u884c\u8ba1\u7b97\uff0c\u65e0\u8fd4\u56de\u503c\u3002anyOf\u65b9\u6cd5\u5f53\u4efb\u610f\u4e00\u4e2aCompletableFuture\u6267\u884c\u5b8c\u540e\u5c31\u4f1a\u6267\u884c\u8ba1\u7b97\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B/#cas-compare-and-swapset","title":"CAS \uff08compare and swap/set\uff09","text":"<p>\u662f\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u6bd4\u8f83\u5e76\u4ea4\u6362\uff0c\u5b83\u5305\u542b\u4e09\u4e2a\u53c2\u6570CAS\uff08V\uff0cE\uff0cN\uff09\uff0cV\u8868\u793a\u8981\u4fee\u6539\u7684\u53d8\u91cf\uff0cE\u8868\u793a\u9884\u671f\u503c\uff08\u65e7\u7684\uff09\uff0cN\u8868\u793a\u65b0\u503c\uff0c\u5f53\u4e14\u4ec5\u5f53\uff0cV\u53d8\u91cf\u7684\u503c\u7b49\u4e8eE\u65f6\uff0c\u624d\u4f1a\u5c06V\u53d8\u91cf\u7684\u503c\u8bbe\u7f6e\u4e3aN\uff0c\u5982\u679c\u4e0d\u540c\u5219\u4ec0\u4e48\u90fd\u4e0d\u505a\u3002</p> <p>\u8fd9\u662f\u4e00\u79cd\u4e50\u89c2\u9501\u7684\u5b9e\u73b0\u3002</p> <p>Atomic\u662fJDK\u91cc\u539f\u5b50\u5305\u4e0b\u7684\uff0c</p> <p>CAS\u4f1a\u5bfc\u81f4ABA\u95ee\u9898\uff0c\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u7248\u672c\u53f7\u89e3\u51b3\uff0c\u56e0\u4e3a\u6bcf\u6b21\u64cd\u4f5cversion\u90fd\u53ea\u4f1a\u589e\u52a0</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/","title":"\u7ebf\u7a0b\u6c60\u89e3\u6790","text":"<p>java\u7ebf\u7a0b\u5bf9\u5e94\u5185\u6838\u7ebf\u7a0b\uff0c\u521b\u5efa\u4e0e\u9500\u6bc1\u9700\u8981\u5207\u6362\u5230\u5185\u6838\u6001\uff0c\u662f\u7cfb\u7edf\u5f00\u9500\u8f83\u5927\u7684\u64cd\u4f5c\uff0c\u56e0\u6b64\u9700\u8981\u8bbe\u6cd5\u590d\u7528\u7ebf\u7a0b\u3002\u7ebf\u7a0b\u6c60\u5c31\u662f\u4e00\u4e2a\u7ebf\u7a0b\u7f13\u5b58\uff0c\u8d1f\u8d23\u5bf9\u7ebf\u7a0b\u7edf\u4e00\u5206\u914d\uff0c\u8c03\u4f18\u4e0e\u76d1\u63a7\uff0c\u7ebf\u7a0b\u6c60\u7684\u4f18\u52bf\uff1a</p> <p>\u63d0\u9ad8\u6027\u80fd\uff1a\u91cd\u7528\u7ebf\u7a0b\u51cf\u5c11\u7ebf\u7a0b\u521b\u5efa\u6d88\u4ea1\u7684\u5f00\u9500 \u63d0\u9ad8\u54cd\u5e94\u901f\u5ea6\uff1a\u4efb\u52a1\u5230\u8fbe\u65f6\u53ef\u4ee5\u7acb\u5373\u6267\u884c\uff0c\u4e0d\u9700\u8981\u518d\u53bb\u521b\u5efa\u7ebf\u7a0b \u65b9\u4fbf\u7ba1\u7406\u7ebf\u7a0b\uff1a\u4fbf\u4e8e\u7edf\u4e00\u5206\u914d\u3001\u8c03\u63a7\u548c\u76d1\u63a7</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#runnable","title":"\u6267\u884cRunnable\u4efb\u52a1\u6d41\u7a0b","text":"<p>\u7b80\u5355\u8bf4\u5904\u7406\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u4e3a\uff1a\u6838\u5fc3\u7ebf\u7a0b\u3001\u4efb\u52a1\u961f\u5217\u3001\u6700\u5927\u7ebf\u7a0b\uff0c\u5982\u679c\u4e09\u8005\u90fd\u6ee1\u4e86\uff0c\u4f7f\u7528handler\u5904\u7406\u88ab\u62d2\u7edd\u7684\u4efb\u52a1\u3002</p> <p></p> <p>\u5177\u4f53\u5982\u4f55\u5b9e\u73b0\u7684\u5462\uff1f</p> <pre><code>/**\n* \u5728\u5c06\u6765\u67d0\u4e2a\u65f6\u95f4\u6267\u884c\u8be5\u4efb\u52a1Runnable\uff0c\u53ef\u80fd\u662f\u65b0\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u6216\u8005\u590d\u7528\u7ebf\u7a0b\u6c60\u5df2\u6709\u7684\u7ebf\u7a0b\u3002\n* \u5982\u679c\u4e00\u4e2a\u4efb\u52a1\u4e0d\u80fd\u63d0\u4ea4\u6267\u884c\uff0c\u8981\u4e48\u662f\u56e0\u4e3a\u7ebf\u7a0b\u6c60shutdown\u4e86\uff0c\u8981\u4e48\u662f\u5bb9\u91cf\u8fbe\u5230\u4e0a\u9650\uff0c\u6b64\u65f6\u6267\u884c\u62d2\u7edd\u7b56\u7565\n*/\npublic void execute(Runnable command) {\n    if (command == null)\n        throw new NullPointerException();\n    // AtomicInteger\u539f\u5b50\u53d8\u91cf\uff0c\u524d3\u4f4d\u8868\u793a\u72b6\u6001\uff0c\u540e29\u4f4d\u8868\u793a\u7ebf\u7a0b\u6570\n    int c = ctl.get();\n    if (workerCountOf(c) &lt; corePoolSize) {\n        // 1. addWorker\u65b9\u6cd5\u91cc\u9762\u4f1a\u539f\u5b50\u68c0\u67e5\u5f53\u524drunning State\u548c\u5de5\u4f5c\u7ebf\u7a0b\u6570\u76ee\uff0c\u9632\u6b62\u5e76\u53d1\u65f6\u9519\u8bef\u7684\u591a\u521b\u5efa\uff0c\n        // \u4e5f\u5c31\u662f\u5982\u679c\u6709\u522b\u7684\u7ebf\u7a0b\u6dfb\u52a0\u4efb\u52a1\u8fbe\u5230corePoolSize\uff0caddWorker\u4f1a\u8fd4\u56defalse\u8868\u793a\u521b\u5efa\u5931\u8d25\n        if (addWorker(command, true))\n            return;\n        c = ctl.get();\n    }\n\n    if (isRunning(c) &amp;&amp; workQueue.offer(command)) {\n        // 2. \u5373\u4f7f\u4efb\u52a1\u6210\u529f\u7684\u5165\u961f\uff0c\u4ecd\u7136\u9700\u8981\u518d\u6b21\u68c0\u67e5\u662f\u5426\u5e94\u8be5\u589e\u52a0\u7ebf\u7a0b\uff0c\u56e0\u4e3a\u6b64\u65f6\u4ecelast checking\u53ef\u80fd\u7ebf\u7a0b\u90fd\u6b7b\u4ea1\u6216\u8005\u7ebf\u7a0b\u6c60shutdown\n        int recheck = ctl.get();\n        // \u6240\u4ee5\u6211\u4eec\u9700\u8981\u518d\u6b21\u68c0\u67e5\u7ebf\u7a0b\u6c60\u72b6\u6001\uff0c\u5982\u679c\u5df2\u7ecfshutdown\u9700\u8981\u79fb\u9664\u4efb\u52a1\u5e76\u62d2\u7edd\u8be5\u4efb\u52a1\n        if (! isRunning(recheck) &amp;&amp; remove(command))\n            reject(command);\n        // \u5982\u679c\u7ebf\u7a0b\u90fd\u5df2\u6b7b\u4ea1\u5c31\u65b0\u5efa\u4e00\u4e2a\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n\n     // \u5982\u679c\u5165\u961f\u5931\u8d25\uff0c\u518d\u5c1d\u8bd5\u65b0\u5efa\u7ebf\u7a0b\u3002\u5982\u679c\u5931\u8d25\u8bf4\u660e\u7ebf\u7a0b\u6c60shutdown\uff0c\u6216\u8005\u9971\u548c\u8fbe\u5230maximumPoolSize,\u5e94\u8be5\u6267\u884c\u62d2\u7edd\u7b56\u7565\n    }else if (!addWorker(command, false))\n        reject(command);\n}\n</code></pre> <p>\u53e6\u5916\u5f88\u91cd\u8981\u7684\u65b9\u6cd5addWorker()\uff0c\u6ce8\u610f\u8c03\u7528\u6b64\u65b9\u6cd5\u662f\u7528\u6765\u65b0\u5efa\u7ebf\u7a0b</p> <pre><code>/**\n* \u68c0\u67e5\u662f\u5426\u53ef\u4ee5\u6839\u636e\u5f53\u524d\u6c60\u72b6\u6001\u548c\u7ed9\u5b9a\u754c\u9650\uff08corePoolSize\u6216maximumPoolSize\uff09\u6dfb\u52a0\u65b0\u7684\u5de5\u4f5c\u7ebf\u7a0b\u3002\n* \u5982\u679c\u53ef\u80fd\uff0c\u5c06\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2aworker\uff0c\u5c06firstTask\u4f5c\u4e3a\u5176\u7b2c\u4e00\u4e2a\u4efb\u52a1\u8fd0\u884c\u3002\n*\n* \u5982\u679c\u6c60\u5df2stopped\u6216shutdown\u4e2d\uff0c\u6216\u8005threadfactory\u521b\u5efa\u7ebf\u7a0b\u5931\u8d25\uff0c\u5219\u6b64\u65b9\u6cd5\u8fd4\u56de false\u3002 \n* \u5982\u679c\u7ebf\u7a0b\u521b\u5efa\u5931\u8d25\uff0c\u6216\u8005threadfactory\u8fd4\u56denull\uff0c\u6216\u8005\u7531\u4e8e\u5f02\u5e38\uff08\u901a\u5e38\u662fThread.start()\u4e2d\u7684 OutOfMemoryError\uff09\uff0c\u6211\u4eec\u4f1a\u5e72\u51c0\u5229\u843d\u5730\u56de\u6eda\u3002\n*\n* @firstTask \u2013 \u65b0\u7ebf\u7a0b\u5e94\u8be5\u9996\u5148\u8fd0\u884c\u7684\u4efb\u52a1\uff08\u5982\u679c\u6ca1\u6709\uff0c\u5219\u4e3anull\uff09\u3002\u5f53\u7ebf\u7a0b\u5c11\u4e8ecorePoolSize\u65f6\uff08\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u603b\u662f\u542f\u52a8\u4e00\u4e2a\uff09\uff0c\n* \u6216\u8005\u5f53\u961f\u5217\u5df2\u6ee1\uff08\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u5fc5\u987b\u7ed5\u8fc7\u961f\u5217\uff09\u65f6\uff0c\u4f7f\u7528\u521d\u59cb\u7684\u7b2c\u4e00\u4e2a\u4efb\u52a1\uff08\u5728\u65b9\u6cd5 execute() \u4e2d\u521b\u5efa\u5de5\u4f5c\u7ebf\u7a0b.\n* \u6700\u521d\u7a7a\u95f2\u7ebf\u7a0b\u901a\u5e38\u901a\u8fc7 prestartCoreThread \u521b\u5efa\u6216\u66ff\u6362\u5176\u4ed6\u5782\u6b7b\u7684\u5de5\u4eba\u3002\n*/\nprivate boolean addWorker(Runnable firstTask, boolean core) {\n    retry:\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\n        // Check if queue empty only if necessary.\n        if (rs &gt;= SHUTDOWN &amp;&amp;\n            ! (rs == SHUTDOWN &amp;&amp;\n               firstTask == null &amp;&amp;\n               ! workQueue.isEmpty()))\n            return false;\n\n        for (;;) {\n            int wc = workerCountOf(c);\n            if (wc &gt;= CAPACITY ||\n                // check\u7ebf\u7a0b\u6570\u662f\u5426\u8d85\u8fc7\u9650\u5236\n                wc &gt;= (core ? corePoolSize : maximumPoolSize))\n                return false;\n            if (compareAndIncrementWorkerCount(c))\n                break retry;\n            c = ctl.get();  // Re-read ctl\n            if (runStateOf(c) != rs)\n                continue retry;\n            // else CAS failed due to workerCount change; retry inner loop\n        }\n    }\n\n    boolean workerStarted = false;\n    boolean workerAdded = false;\n    Worker w = null;\n    try {\n        // \u521b\u5efa\u65b0\u7684\u7ebf\u7a0b\n        w = new Worker(firstTask);\n        final Thread t = w.thread;\n        if (t != null) {\n            // \u83b7\u53d6\u9501\uff01\uff01\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n                // Recheck while holding lock.\n                // Back out on ThreadFactory failure or if\n                // shut down before lock acquired.\n                int rs = runStateOf(ctl.get());\n\n                if (rs &lt; SHUTDOWN ||\n                    (rs == SHUTDOWN &amp;&amp; firstTask == null)) {\n                    if (t.isAlive()) // precheck that t is startable\n                        throw new IllegalThreadStateException();\n                    // \u6dfb\u52a0worker\n                    workers.add(w);\n                    // \u66f4\u65b0 \u6c60\u7684\u6700\u5927\u503c \n                    int s = workers.size();\n                    if (s &gt; largestPoolSize)\n                        largestPoolSize = s;\n                    workerAdded = true;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            if (workerAdded) {\n                // \u6dfb\u52a0\u6210\u529f\u5c31\u542f\u52a8\u7ebf\u7a0b\n                t.start();\n                workerStarted = true;\n            }\n        }\n    } finally {\n        if (! workerStarted)\n            addWorkerFailed(w);\n    }\n    return workerStarted;\n}\n</code></pre>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#_2","title":"\u5982\u4f55\u5faa\u73af\u53d6\u4efb\u52a1\u6267\u884c\u7684\uff1f","text":"<p>\u6ce8\u610fWorker\u5b9e\u73b0\u4e86AQS\uff0c\u9632\u6b62\u6b63\u5728\u7b49\u5f85\u4efb\u52a1\u7684\u7ebf\u7a0b\u88ab\u4e2d\u65ad</p> <pre><code>final void runWorker(Worker w) {\n    Thread wt = Thread.currentThread();\n    Runnable task = w.firstTask;\n    w.firstTask = null;\n    w.unlock(); // allow interrupts\n    boolean completedAbruptly = true;\n    try {\n        // \u8fd9\u91cc\u9664\u4e86\u6267\u884c\u5f53\u524dtask\uff0c\u53ea\u8981\u4ece\u961f\u5217\u4e2d\u80fd\u53d6getTask()\u5c31\u4f1a\u4e0d\u505c\u7684\u5faa\u73af\n        while (task != null || (task = getTask()) != null) {\n            w.lock();\n            // If pool is stopping, ensure thread is interrupted;\n            // if not, ensure thread is not interrupted.  This\n            // requires a recheck in second case to deal with\n            // shutdownNow race while clearing interrupt\n            if ((runStateAtLeast(ctl.get(), STOP) ||\n                 (Thread.interrupted() &amp;&amp;\n                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;\n                !wt.isInterrupted())\n                wt.interrupt();\n            try {\n                beforeExecute(wt, task);\n                Throwable thrown = null;\n                try {\n                    task.run();\n                } catch (RuntimeException x) {\n                    thrown = x; throw x;\n                } catch (Error x) {\n                    thrown = x; throw x;\n                } catch (Throwable x) {\n                    thrown = x; throw new Error(x);\n                } finally {\n                    afterExecute(task, thrown);\n                }\n            } finally {\n                task = null;\n                w.completedTasks++;\n                w.unlock();\n            }\n        }\n        completedAbruptly = false;\n    } finally {\n        // \u6ca1\u6709\u4efb\u52a1\u4e86\u5c31\u9000\u51fa\u903b\u8f91\uff1a\u505c\u6b62\u7ebf\u7a0b\uff0c\u4f46\u4f1a\u4fdd\u8bc1\u7ef4\u6301corePoolSize\n        processWorkerExit(w, completedAbruptly);\n    }\n}\n</code></pre>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#_3","title":"\u7ebf\u7a0b\u6c60\u72b6\u6001","text":"<p>\u7ebf\u7a0b\u6c60\u72b6\u6001\u662f\u901a\u8fc7\u4e00\u4e2aAtomicInteger\u7684\u524d3\u4f4d\u8868\u793a\u7684</p> <p></p> <ul> <li>Running\uff1a\u8868\u793a\u80fd\u63a5\u53d7\u65b0\u4efb\u52a1\u53ca\u5904\u7406\u961f\u5217\u4e2d\u7684\u4efb\u52a1</li> <li>Shutdown\uff1a\u8868\u793a\u4e0d\u63a5\u53d7\u65b0\u4efb\u52a1\uff0c\u4f46\u662f\u4f1a\u5904\u7406\u961f\u5217\u4e2d\u7684\u4efb\u52a1</li> <li>stop\uff1a\u8868\u793a\u4e0d\u63a5\u53d7\u65b0\u4efb\u52a1\uff0c\u4e0d\u5904\u7406\u961f\u5217\u4e2d\u7684\u4efb\u52a1\uff0c\u5e76\u4e14\u4e2d\u65ad\u6b63\u5728\u5904\u7406\u7684\u4efb\u52a1</li> <li>Tidying\uff1a\u8868\u793a\u6240\u6709\u7684\u4efb\u52a1\u5df2\u7ecf\u7ec8\u6b62\uff0cctl\u8bb0\u5f55\u7684\u201cworkerCount\u201d\u4e3a0\uff0c\u5c06\u4f1a\u6267\u884cterminated()\u7684\u94a9\u5b50\u65b9\u6cd5</li> <li>Terminated\uff1aterminated()\u65b9\u6cd5\u6267\u884c\u5b8c\u6bd5</li> </ul> <p>\u8f6c\u6362\u8fc7\u7a0b\u5982\u4e0b\uff1a</p> <p>SHUTDOWN -&gt; TIDYING\uff1a\u7ebf\u7a0b\u6c60\u7ebf\u7a0b\u6570\u4e3a\u7a7a\uff0c\u5de5\u4f5c\u961f\u5217\u4e3a\u7a7a</p> <p>STOP -&gt; TIDYING\uff1a\u53ea\u8981\u7ebf\u7a0b\u6c60\u7ebf\u7a0b\u6570\u4e3a\u7a7a\u5373\u53ef</p> <p>TIDYING -&gt; TERMINATED\uff1aterminated() \u7684\u94a9\u5b50\u65b9\u6cd5\u6267\u884c\u5b8c\u540e</p> <p></p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#_4","title":"\u7ebf\u7a0b\u6c60\u4e2d\u7684\u963b\u585e\u5de5\u4f5c\u961f\u5217","text":"<p>\u963b\u585e\u961f\u5217\u662f\u961f\u5217\u7684\u5e38\u89c1\u5e94\u7528\u3002\u5e38\u89c1\u7684BlockingQueue\u4e3b\u8981\u6709\u4e09\u79cd\u5b9e\u73b0\uff1a</p> <p>SynchronousQueue\u662f\u4e0d\u7f13\u5b58\u4efb\u52a1\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u4e2d\u8f6c\u7ad9</p> <p>ArrayBlockingQueue\u662f\u4e00\u4e2a\u7528\u6570\u7ec4\u5b9e\u73b0\u7684\u6709\u754c\u963b\u585e\u961f\u5217\uff0c\u5fc5\u987b\u8bbe\u7f6e\u5bb9\u91cf\u3002</p> <p>LinkedBlockingQueue\u662f\u4e00\u4e2a\u7528\u94fe\u8868\u5b9e\u73b0\u7684\u963b\u585e\u961f\u5217\uff0c\u5bb9\u91cf\u53ef\u4ee5\u8bbe\u7f6e\uff0c\u4e0d\u8bbe\u7f6e\u7684\u8bdd\u6700\u5927\u957f\u5ea6\u4e3aInteger.MAX_VALUE\uff0c\u5c06\u662f\u4e00\u4e2a\u65e0\u8fb9\u754c\u7684\u963b\u585e\u961f\u5217\u3002\u5bf9\u4e8e\u4e00\u4e2a\u65e0\u8fb9\u754c\u961f\u5217\u6765\u8bf4\uff0c\u662f\u53ef\u4ee5\u4e0d\u65ad\u7684\u5411\u961f\u5217\u4e2d\u52a0\u5165\u4efb\u52a1\u7684\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5c31\u6709\u53ef\u80fd\u56e0\u4e3a\u4efb\u52a1\u8fc7\u591a\u800c\u5bfc\u81f4\u5185\u5b58\u6ea2\u51fa\u95ee\u9898\u3002newFixedThreadPool\u4e2d\u521b\u5efa\u7684\u5c31\u662f\u672a\u6307\u5b9a\u5bb9\u91cf\u7684LinkedBlockingQueue\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#_5","title":"\u4efb\u52a1\u62d2\u7edd\u7b56\u7565","text":"<p>\u5f53\u6700\u5927\u7ebf\u7a0b\u6ee1\u540e\uff0c\u4f1a\u4f7f\u7528handler\u6765\u5904\u7406\u88ab\u62d2\u7edd\u7684\u4efb\u52a1\uff0c\u5148\u770b\u4e0b JDK \u5b9a\u4e49\u7684 \u62d2\u7edd\u7b56\u7565\u63a5\u53e3</p> <p><pre><code>public interface RejectedExecutionHandler {\n    void rejectedExecution(Runnable r, ThreadPoolExecutor executor);\n}\n</code></pre> \u63a5\u53e3\u5b9a\u4e49\u5f88\u660e\u786e\uff0c\u5f53\u89e6\u53d1\u62d2\u7edd\u7b56\u7565\u65f6\uff0c\u7ebf\u7a0b\u6c60\u4f1a\u8c03\u7528\u4f60\u8bbe\u7f6e\u7684\u5177\u4f53\u7684\u7b56\u7565\uff0c\u5c06\u5f53\u524d\u63d0\u4ea4\u7684\u4efb\u52a1\u4ee5\u53ca\u7ebf\u7a0b\u6c60\u5b9e\u4f8b\u672c\u8eab\u4f20\u9012\u7ed9\u4f60\u5904\u7406\uff0c\u5177\u4f53\u4f5c\u4f55\u5904\u7406\uff0c\u4e0d\u540c\u573a\u666f\u4f1a\u6709\u4e0d\u540c\u7684\u8003\u8651\uff0c\u4e0b\u9762\u770b JDK \u4e3a\u6211\u4eec\u5185\u7f6e\u4e86\u9ed8\u8ba4\u7684\u56db\u79cd\u5904\u7406\u7b56\u7565\u4e3a\uff1a</p> <ul> <li>AbortPolicy \u629b\u51fa\u5f02\u5e38\u3002</li> </ul> <pre><code>public static class AbortPolicy implements RejectedExecutionHandler {\n    public AbortPolicy() { }\n\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n        throw new RejectedExecutionException(\"Task \" + r.toString() +\n                                             \" rejected from \" +\n                                             e.toString());\n    }\n}\n</code></pre> <p>\u4e0d\u6267\u884c\u6b64\u4efb\u52a1\uff0c\u800c\u4e14\u76f4\u63a5\u629b\u51fa\u4e00\u4e2a\u8fd0\u884c\u65f6\u5f02\u5e38 RejectedExecutionException\uff0c\u4e3ajava\u7ebf\u7a0b\u6c60\u9ed8\u8ba4\u7684\u963b\u585e\u7b56\u7565\u3002\u5207\u8bb0\u4f1a\u4e2d\u65ad\u8c03\u7528\u8005\u7684\u5904\u7406\u8fc7\u7a0b\uff0c\u56e0\u6b64\u9700\u8981try catch\uff0c\u5426\u5219\u7a0b\u5e8f\u4f1a\u76f4\u63a5\u9000\u51fa\u3002 - DiscardPolicy \u76f4\u63a5\u9759\u6084\u6084\u7684\u4e22\u5f03\u8fd9\u4e2a\u4efb\u52a1\uff0c\u4e0d\u89e6\u53d1\u4efb\u4f55\u52a8\u4f5c\u3002\u8fd9\u4e2a\u7b56\u7565\u57fa\u672c\u4e0d\u4f1a\u4f7f\u7528</p> <pre><code>public static class DiscardPolicy implements RejectedExecutionHandler {\n    public DiscardPolicy() { }\n\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n    }\n}\n</code></pre> <ul> <li>DiscardOldestPolicy \u4e22\u5f03\u961f\u5217\u6700\u524d\u9762\uff08\u6700\u65e7\uff09\u7684\u4efb\u52a1\uff0c\u7136\u540e\u91cd\u65b0\u5c1d\u8bd5\u6267\u884c\u4efb\u52a1\uff08\u91cd\u590d\u6b64\u8fc7\u7a0b\uff09\u3002</li> </ul> <pre><code>public static class DiscardOldestPolicy implements RejectedExecutionHandler {\n    public DiscardOldestPolicy() { }\n\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n        if (!e.isShutdown()) {\n            e.getQueue().poll();\n            e.execute(r);\n        }\n    }\n}\n</code></pre> <ul> <li>CallerRunsPolicy \u7531\u8c03\u7528\u7ebf\u7a0b\u5904\u7406\u8be5\u4efb\u52a1 \u3002</li> </ul> <p><pre><code>public static class CallerRunsPolicy implements RejectedExecutionHandler {\n    public CallerRunsPolicy() { }\n\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n        if (!e.isShutdown()) {\n            r.run();\n        }\n    }\n}\n</code></pre> \u529f\u80fd\uff1a\u5f53\u89e6\u53d1\u62d2\u7edd\u7b56\u7565\u65f6\uff0c\u53ea\u8981\u7ebf\u7a0b\u6c60\u6ca1\u6709\u5173\u95ed\uff0c\u5c31\u7531\u63d0\u4ea4\u4efb\u52a1\u7684\u5f53\u524d\u7ebf\u7a0b\u5904\u7406\u3002</p> <p>\u4f7f\u7528\u573a\u666f\uff1a\u4e00\u822c\u5728\u4e0d\u5141\u8bb8\u5931\u8d25\u7684\u3001\u5bf9\u6027\u80fd\u8981\u6c42\u4e0d\u9ad8\u3001\u5e76\u53d1\u91cf\u8f83\u5c0f\u7684\u573a\u666f\u4e0b\u4f7f\u7528\uff0c\u56e0\u4e3a\u7ebf\u7a0b\u6c60\u4e00\u822c\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u5173\u95ed\uff0c\u4e5f\u5c31\u662f\u63d0\u4ea4\u7684\u4efb\u52a1\u4e00\u5b9a\u4f1a\u88ab\u8fd0\u884c\uff0c\u4f46\u662f\u7531\u4e8e\u662f\u8c03\u7528\u8005\u7ebf\u7a0b\u81ea\u5df1\u6267\u884c\u7684\uff0c\u5f53\u591a\u6b21\u63d0\u4ea4\u4efb\u52a1\u65f6\uff0c\u5c31\u4f1a\u963b\u585e\u540e\u7eed\u4efb\u52a1\u6267\u884c\uff0c\u6027\u80fd\u548c\u6548\u7387\u81ea\u7136\u5c31\u6162\u4e86\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u770b\u4e0b\u7b2c\u4e09\u65b9\u6846\u67b6\u4e2d\u90fd\u6709\u54ea\u4e9b\u62d2\u7edd\u7b56\u7565</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#dubbo","title":"Dubbo \u4e2d\u7684\u7ebf\u7a0b\u62d2\u7edd\u7b56\u7565","text":"<p><pre><code>public class AbortPolicyWithReport extends ThreadPoolExecutor.AbortPolicy {\n\n    protected static final Logger logger = LoggerFactory.getLogger(AbortPolicyWithReport.class);\n\n    private final String threadName;\n\n    private final URL url;\n\n    private static volatile long lastPrintTime = 0;\n\n    private static Semaphore guard = new Semaphore(1);\n\n    public AbortPolicyWithReport(String threadName, URL url) {\n        this.threadName = threadName;\n        this.url = url;\n    }\n\n    @Override\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n        String msg = String.format(\"Thread pool is EXHAUSTED!\" +\n                        \" Thread Name: %s, Pool Size: %d (active: %d, core: %d, max: %d, largest: %d), Task: %d (completed: %d),\" +\n                        \" Executor status:(isShutdown:%s, isTerminated:%s, isTerminating:%s), in %s://%s:%d!\",\n                threadName, e.getPoolSize(), e.getActiveCount(), e.getCorePoolSize(), e.getMaximumPoolSize(), e.getLargestPoolSize(),\n                e.getTaskCount(), e.getCompletedTaskCount(), e.isShutdown(), e.isTerminated(), e.isTerminating(),\n                url.getProtocol(), url.getIp(), url.getPort());\n        logger.warn(msg);\n        dumpJStack();\n        throw new RejectedExecutionException(msg);\n    }\n\n    private void dumpJStack() {\n       //\u7701\u7565\u5b9e\u73b0\n    }\n}\n</code></pre> \u53ef\u4ee5\u770b\u5230\uff0c\u5f53dubbo\u7684\u5de5\u4f5c\u7ebf\u7a0b\u89e6\u53d1\u4e86\u7ebf\u7a0b\u62d2\u7edd\u540e\uff0c\u4e3b\u8981\u505a\u4e86\u4e09\u4e2a\u4e8b\u60c5\uff0c\u539f\u5219\u5c31\u662f\u5c3d\u91cf\u8ba9\u4f7f\u7528\u8005\u6e05\u695a\u89e6\u53d1\u7ebf\u7a0b\u62d2\u7edd\u7b56\u7565\u7684\u771f\u5b9e\u539f\u56e0</p> <ul> <li>\u8f93\u51fa\u4e86\u4e00\u6761\u8b66\u544a\u7ea7\u522b\u7684\u65e5\u5fd7\uff0c\u65e5\u5fd7\u5185\u5bb9\u4e3a\u7ebf\u7a0b\u6c60\u7684\u8be6\u7ec6\u8bbe\u7f6e\u53c2\u6570\uff0c\u4ee5\u53ca\u7ebf\u7a0b\u6c60\u5f53\u524d\u7684\u72b6\u6001\uff0c\u8fd8\u6709\u5f53\u524d\u62d2\u7edd\u4efb\u52a1\u7684\u4e00\u4e9b\u8be6\u7ec6\u4fe1\u606f\u3002\u53ef\u4ee5\u8bf4\uff0c\u8fd9\u6761\u65e5\u5fd7\uff0c\u4f7f\u7528dubbo\u7684\u6709\u8fc7\u751f\u4ea7\u8fd0\u7ef4\u7ecf\u9a8c\u7684\u6216\u591a\u6216\u5c11\u662f\u89c1\u8fc7\u7684\uff0c\u8fd9\u4e2a\u65e5\u5fd7\u7b80\u76f4\u5c31\u662f\u65e5\u5fd7\u6253\u5370\u7684\u5178\u8303\uff0c\u5176\u4ed6\u7684\u65e5\u5fd7\u6253\u5370\u7684\u5178\u8303\u8fd8\u6709spring\u3002\u5f97\u76ca\u4e8e\u8fd9\u4e48\u8be6\u7ec6\u7684\u65e5\u5fd7\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u5b9a\u4f4d\u5230\u95ee\u9898\u6240\u5728</li> <li>\u8f93\u51fa\u5f53\u524d\u7ebf\u7a0b\u5806\u6808\u8be6\u60c5\uff0c\u8fd9\u4e2a\u592a\u6709\u7528\u4e86\uff0c\u5f53\u4f60\u901a\u8fc7\u4e0a\u9762\u7684\u65e5\u5fd7\u4fe1\u606f\u8fd8\u4e0d\u80fd\u5b9a\u4f4d\u95ee\u9898\u65f6\uff0c\u6848\u53d1\u73b0\u573a\u7684dump\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u4fe1\u606f\u5c31\u662f\u4f60\u53d1\u73b0\u95ee\u9898\u7684\u6551\u547d\u7a3b\u8349</li> <li>\u7ee7\u7eed\u629b\u51fa\u62d2\u7edd\u6267\u884c\u5f02\u5e38\uff0c\u4f7f\u672c\u6b21\u4efb\u52a1\u5931\u8d25\uff0c\u8fd9\u4e2a\u7ee7\u627f\u4e86JDK\u9ed8\u8ba4\u62d2\u7edd\u7b56\u7565\u7684\u7279\u6027</li> </ul>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#netty","title":"Netty \u4e2d\u7684\u7ebf\u7a0b\u6c60\u62d2\u7edd\u7b56\u7565","text":"<p><pre><code>private static final class NewThreadRunsPolicy implements RejectedExecutionHandler {\n    NewThreadRunsPolicy() {\n        super();\n    }\n\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {\n        try {\n            final Thread t = new Thread(r, \"Temporary task executor\");\n            t.start();\n        } catch (Throwable e) {\n            throw new RejectedExecutionException(\n                \"Failed to start a new thread\", e);\n        }\n    }\n}\n</code></pre> Netty\u65b0\u5efa\u4e86\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5904\u7406\u7684\u3002\u6240\u4ee5\uff0cNetty\u7684\u5b9e\u73b0\u76f8\u8f83\u4e8e\u8c03\u7528\u8005\u6267\u884c\u7b56\u7565\u7684\u4f7f\u7528\u9762\u5c31\u53ef\u4ee5\u6269\u5c55\u5230\u652f\u6301\u9ad8\u6548\u7387\u9ad8\u6027\u80fd\u7684\u573a\u666f\u4e86\u3002\u4f46\u662f\u4e5f\u8981\u6ce8\u610f\u4e00\u70b9\uff0cNetty\u7684\u5b9e\u73b0\u91cc\uff0c\u5728\u521b\u5efa\u7ebf\u7a0b\u65f6\u672a\u505a\u4efb\u4f55\u7684\u5224\u65ad\u7ea6\u675f\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ea\u8981\u7cfb\u7edf\u8fd8\u6709\u8d44\u6e90\u5c31\u4f1a\u521b\u5efa\u65b0\u7684\u7ebf\u7a0b\u6765\u5904\u7406\uff0c\u76f4\u5230new\u4e0d\u51fa\u65b0\u7684\u7ebf\u7a0b\u4e86\uff0c\u624d\u4f1a\u629b\u521b\u5efa\u7ebf\u7a0b\u5931\u8d25\u7684\u5f02\u5e38</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#pinpoint","title":"PinPoint \u4e2d\u7684\u7ebf\u7a0b\u6c60\u62d2\u7edd\u7b56\u7565","text":"<p><pre><code>public class RejectedExecutionHandlerChain implements RejectedExecutionHandler {\n    private final RejectedExecutionHandler[] handlerChain;\n\n    //\u901a\u8fc7\u9759\u6001\u65b9\u6cd5\u6765\u8fd4\u56de\u4e00\u4e2a\u5bf9\u8c61\n    public static RejectedExecutionHandler build(List&lt;RejectedExecutionHandler&gt; chain) {\n        Objects.requireNonNull(chain, \"handlerChain must not be null\");\n        RejectedExecutionHandler[] handlerChain = chain.toArray(new RejectedExecutionHandler[0]);\n        return new RejectedExecutionHandlerChain(handlerChain);\n    }\n\n    private RejectedExecutionHandlerChain(RejectedExecutionHandler[] handlerChain) {\n        this.handlerChain = Objects.requireNonNull(handlerChain, \"handlerChain must not be null\");\n    }\n\n    @Override\n    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {\n        for (RejectedExecutionHandler rejectedExecutionHandler : handlerChain) {\n            rejectedExecutionHandler.rejectedExecution(r, executor);\n        }\n    }\n}\n</code></pre> pinpoint\u7684\u62d2\u7edd\u7b56\u7565\u5b9e\u73b0\u5f88\u6709\u7279\u70b9\uff0c\u548c\u5176\u4ed6\u7684\u5b9e\u73b0\u90fd\u4e0d\u540c\u3002\u4ed6\u5b9a\u4e49\u4e86\u4e00\u4e2a\u62d2\u7edd\u7b56\u7565\u94fe\uff0c\u5305\u88c5\u4e86\u4e00\u4e2a\u62d2\u7edd\u7b56\u7565\u5217\u8868\uff0c\u5f53\u89e6\u53d1\u62d2\u7edd\u7b56\u7565\u65f6\uff0c\u4f1a\u5c06\u7b56\u7565\u94fe\u4e2d\u7684rejectedExecution\u4f9d\u6b21\u6267\u884c\u4e00\u904d</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#activemq","title":"ActiveMQ \u4e2d\u7684\u7ebf\u7a0b\u6c60\u62d2\u7edd\u7b56\u7565","text":"<p><pre><code>new RejectedExecutionHandler() {\n    @Override\n    public void rejectedExecution(final Runnable r, final ThreadPoolExecutor executor) {\n        try {\n            executor.getQueue().offer(r, 60, TimeUnit.SECONDS);\n        } catch (InterruptedException e) {\n            throw new RejectedExecutionException(\"Interrupted waiting for BrokerService.worker\");\n        }\n        throw new RejectedExecutionException(\"Timed Out while attempting to enqueue Task.\");\n    }\n});\n</code></pre> activeMq\u4e2d\u7684\u7b56\u7565\u5c5e\u4e8e\u6700\u5927\u52aa\u529b\u6267\u884c\u4efb\u52a1\u578b\uff0c\u5f53\u89e6\u53d1\u62d2\u7edd\u7b56\u7565\u65f6\uff0c\u5728\u5c1d\u8bd5\u4e00\u5206\u949f\u7684\u65f6\u95f4\u91cd\u65b0\u5c06\u4efb\u52a1\u585e\u8fdb\u4efb\u52a1\u961f\u5217\uff0c\u5f53\u4e00\u5206\u949f\u8d85\u65f6\u8fd8\u6ca1\u6210\u529f\u65f6\uff0c\u5c31\u629b\u51fa\u5f02\u5e38\u3002\u8fd9\u79cd\u65b9\u5f0f\u611f\u89c9\u53ef\u4ee5\u7528\u4e8e\u8fd9\u6837\u7684\u573a\u666f\uff0c\u6bd4\u5982\u63a5\u53d7\u8bbe\u5907\u4e0a\u62a5\u7684\u6d88\u606f\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u90fd\u662f\u6bd4\u8f83\u5c11\u80fd\u5904\u7406\u7684\u8fc7\u6765\uff0c\u6bcf\u4e2a\u4efb\u52a1\u5904\u7406\u65f6\u95f4\u4e0d\u957f\uff0c\u53ea\u6709\u5f88\u5c0f\u6982\u7387\u6d88\u606f\u4efb\u52a1\u6570\u91cf\u589e\u52a0\uff0c\u5c31\u53ef\u4ee5\u963b\u585e\u4e00\u6bb5\u65f6\u95f4\uff0c\u7b49\u5f85\u5176\u4ed6\u4efb\u52a1\u5b8c\u6210\u3002</p> <p>BlockingQueue\u7684\u6838\u5fc3\u65b9\u6cd5\uff1a \u653e\u5165\u6570\u636e\uff1a \u3000\u3000offer(anObject):\u8868\u793a\u5982\u679c\u53ef\u80fd\u7684\u8bdd,\u5c06anObject\u52a0\u5230BlockingQueue\u91cc,\u5373\u5982\u679cBlockingQueue\u53ef\u4ee5\u5bb9\u7eb3, \u3000\u3000\u3000\u3000\u5219\u8fd4\u56detrue,\u5426\u5219\u8fd4\u56defalse.\uff08\u672c\u65b9\u6cd5\u4e0d\u963b\u585e\u5f53\u524d\u6267\u884c\u65b9\u6cd5\u7684\u7ebf\u7a0b\uff09 \u3000\u3000offer(E o, long timeout, TimeUnit unit),\u53ef\u4ee5\u8bbe\u5b9a\u7b49\u5f85\u7684\u65f6\u95f4\uff0c\u5982\u679c\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u5185\uff0c\u8fd8\u4e0d\u80fd\u5f80\u961f\u5217\u4e2d \u3000\u3000\u3000\u3000\u52a0\u5165BlockingQueue\uff0c\u5219\u8fd4\u56de\u5931\u8d25\u3002 \u3000\u3000put(anObject):\u628aanObject\u52a0\u5230BlockingQueue\u91cc,\u5982\u679cBlockQueue\u6ca1\u6709\u7a7a\u95f4,\u5219\u8c03\u7528\u6b64\u65b9\u6cd5\u7684\u7ebf\u7a0b\u88ab\u963b\u585e \u3000\u3000\u3000\u3000\u76f4\u5230BlockingQueue\u91cc\u9762\u6709\u7a7a\u95f4\u518d\u7ee7\u7eed. \u83b7\u53d6\u6570\u636e\uff1a \u3000\u3000poll(time):\u53d6\u8d70BlockingQueue\u91cc\u6392\u5728\u9996\u4f4d\u7684\u5bf9\u8c61,\u82e5\u4e0d\u80fd\u7acb\u5373\u53d6\u51fa,\u5219\u53ef\u4ee5\u7b49time\u53c2\u6570\u89c4\u5b9a\u7684\u65f6\u95f4, \u3000\u3000\u3000\u3000\u53d6\u4e0d\u5230\u65f6\u8fd4\u56denull; \u3000\u3000poll(long timeout, TimeUnit unit)\uff1a\u4eceBlockingQueue\u53d6\u51fa\u4e00\u4e2a\u961f\u9996\u7684\u5bf9\u8c61\uff0c\u5982\u679c\u5728\u6307\u5b9a\u65f6\u95f4\u5185\uff0c \u3000\u3000\u3000\u3000\u961f\u5217\u4e00\u65e6\u6709\u6570\u636e\u53ef\u53d6\uff0c\u5219\u7acb\u5373\u8fd4\u56de\u961f\u5217\u4e2d\u7684\u6570\u636e\u3002\u5426\u5219\u76f4\u5230\u65f6\u95f4\u8d85\u65f6\u8fd8\u6ca1\u6709\u6570\u636e\u53ef\u53d6\uff0c\u8fd4\u56de\u5931\u8d25\u3002 \u3000\u3000take():\u53d6\u8d70BlockingQueue\u91cc\u6392\u5728\u9996\u4f4d\u7684\u5bf9\u8c61,\u82e5BlockingQueue\u4e3a\u7a7a,\u963b\u65ad\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u76f4\u5230 \u3000\u3000\u3000\u3000BlockingQueue\u6709\u65b0\u7684\u6570\u636e\u88ab\u52a0\u5165;  \u3000\u3000drainTo():\u4e00\u6b21\u6027\u4eceBlockingQueue\u83b7\u53d6\u6240\u6709\u53ef\u7528\u7684\u6570\u636e\u5bf9\u8c61\uff08\u8fd8\u53ef\u4ee5\u6307\u5b9a\u83b7\u53d6\u6570\u636e\u7684\u4e2a\u6570\uff09\uff0c  \u3000\u3000\u3000\u3000\u901a\u8fc7\u8be5\u65b9\u6cd5\uff0c\u53ef\u4ee5\u63d0\u5347\u83b7\u53d6\u6570\u636e\u6548\u7387\uff1b\u4e0d\u9700\u8981\u591a\u6b21\u5206\u6279\u52a0\u9501\u6216\u91ca\u653e\u9501\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#java","title":"Java\u63d0\u4f9b\u7684\u51e0\u79cd\u7ebf\u7a0b\u6c60","text":"<ul> <li>FixedThreadPool(int n)</li> </ul> <p><code>new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS,  new LinkedBlockingQueue&lt;Runnable&gt;());</code>\u6838\u5fc3\u7ebf\u7a0b\u548c\u6700\u5927\u7ebf\u7a0b\u90fd\u662fn\uff0c\u4f7f\u7528LinkedBlockingQueue\u65e0\u754c\u961f\u5217\u3002\u6240\u4ee5\u5f53\u8bf7\u6c42\u8d8a\u6765\u8d8a\u591a\u65e0\u6cd5\u53ca\u65f6\u5904\u7406\u65f6\uff0c\u5c31\u4f1a\u4e0d\u65ad\u5806\u79ef\uff0c\u5bb9\u6613\u9020\u6210\u5185\u5b58\u6ea2\u51faOOM\u3002</p> <ul> <li>SingleThreadExecutor \u5355\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u7684\u7ebf\u7a0b\u6c60</li> </ul> <p><code>new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())</code>\u7b49\u540c\u4e8eFixedThreadPool(1)\uff0c\u53ea\u6709\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u3002\u4fdd\u8bc1\u63d0\u4ea4\u7684\u4efb\u52a1\u6309\u987a\u5e8f\u6267\u884c\uff0c\u6240\u4ee5\u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u9762\u8bd5\u7ecf\u5e38\u95ee\u5230\u7684\u5982\u4f55\u63a7\u5236\u591a\u4e2a\u7ebf\u7a0b\u987a\u5e8f\u6253\u5370\u2019ABCABC\u2019\u95ee\u9898\u5982\u4f55\u63a7\u5236\u591a\u4e2a\u7ebf\u7a0b\u7684\u6267\u884c\u987a\u5e8f</p> <ul> <li>CachedThreadPool</li> </ul> <p>\u5e95\u5c42\u662f`return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue());\uff0csynchronousQueue\u662f\u76f4\u63a5\u4ea4\u6362\u961f\u5217\uff0c\u4e0d\u7f13\u5b58\u4efb\u52a1\u3002\u8fd9\u4e2a\u7ebf\u7a0b\u6c60\u4f1a\u5229\u7528\u5df2\u6709\u7684\u7ebf\u7a0b\uff0c\u6ca1\u6709\u5c31\u65b0\u5efa\uff0c\u9002\u5408\u7528\u6765\u5904\u7406\u5904\u7406\u65f6\u95f4\u8f83\u77ed\u7684\u5f02\u6b65\u4efb\u52a1\uff0c\u4f46\u662f\u5982\u679c\u4efb\u52a1\u5f88\u591a\uff0c\u4f1a\u4e0d\u65ad\u521b\u5efa\u7ebf\u7a0b\u76f4\u5230\u8d85\u51fa\u7cfb\u7edf\u9650\u5236\uff08\u5982\u53d1\u751f\u7ebf\u7a0b\u5185\u5b58\u5206\u914d\u4e0d\u8db3\uff09\u3002\u5982\u679c\u7ebf\u7a0b\u8d85\u8fc760s\u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u4f1a\u88ab\u56de\u6536\u3002 <ul> <li>ScheduledThreadPool(int corePoolSize)</li> </ul> <p>\u53ef\u4ee5\u7528\u6765\u6267\u884c\u4e00\u4e9b\u7b80\u5355\u7684\u5ef6\u8fdf\u6216\u6309\u56fa\u5b9a\u9891\u7387\u7684\u4efb\u52a1\u3002 \u5ef6\u8fdf5\u79d2\u540e\u6267\u884c\u4efb\u52a1scheduledExecutorService.schedule(thread,5, TimeUnit.SECONDS);   \u57281s\u540e\u6267\u884c\u4e00\u6b21\uff0c\u7136\u540e\u6bcf\u96943\u79d2\u6267\u884c\u4efb\u52a1#scheduledExecutorService.scheduleAtFixedRate(thread,1,3,TimeUnit.SECONDS);</p> <ul> <li>WorkStealingPool</li> </ul> <p><code>return new ForkJoinPool(parallelism, ForkJoinPool.defaultForkJoinWorkerThreadFactory, null, true);</code>\uff0cJDK8\u52a0\u5165\u7684\uff0c\u8fd4\u56de\u4e00\u4e2a\u5de5\u4f5c\u7a83\u53d6\u7ebf\u7a0b\u6c60ForkJoinPool\uff0c\u4f1a\u7ef4\u62a4\u8db3\u591f\u7684\u7ebf\u7a0b\u4ee5\u652f\u6301\u7ed9\u5b9a\u7684\u5e76\u884c\u5ea6\u7ea7\u522b\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u961f\u5217\u6765\u51cf\u5c11\u4e89\u7528\u3002 \u5e76\u884c\u5ea6\u7ea7\u522b\u5bf9\u5e94\u4e8e\u4e3b\u52a8\u53c2\u4e0e\u6216\u53ef\u7528\u4e8e\u53c2\u4e0e\u4efb\u52a1\u5904\u7406\u7684\u6700\u5927\u7ebf\u7a0b\u6570\u3002 \u7ebf\u7a0b\u7684\u5b9e\u9645\u6570\u91cf\u53ef\u80fd\u4f1a\u52a8\u6001\u589e\u957f\u548c\u6536\u7f29\u3002 \u5de5\u4f5c\u7a83\u53d6\u6c60\u4e0d\u4fdd\u8bc1\u63d0\u4ea4\u4efb\u52a1\u7684\u6267\u884c\u987a\u5e8f</p> <p>\u9002\u5408\u7ebf\u7a0b\u4f1a\u4ea7\u751f\u5b50\u4efb\u52a1\u7684\uff0c\u7ebf\u7a0b\u4f1a\u628a\u4ea7\u751f\u7684\u5b50\u4efb\u52a1\u653e\u8fdb\u81ea\u5df1\u7684\u5de5\u4f5c\u961f\u5217\uff0c\u5176\u4ed6\u7ebf\u7a0b\u53ef\u4ee5\u5e2e\u52a9\u8fd9\u4e2a\u7ebf\u7a0b\u6267\u884c\u3002</p> <p>Spring\u63d0\u4f9b\u7684\u7ebf\u7a0b\u6c60ThreadPoolTaskExecutor\uff0c\u65b9\u4fbf\u6211\u4eec\u81ea\u5b9a\u4e49\u7ebf\u7a0b\u6c60\uff1a</p> <pre><code>@Configuration\n@EnableAsync//\u5f00\u542f\u5f02\u6b65\u4efb\u52a1\u7684\u652f\u6301\npublic class TaskExecutorConfig {\n\n    @Bean(value = \"businessEventProcessTaskExecutor\", destroyMethod = \"destroy\")\n    public ThreadPoolTaskExecutor getAsyncExecutor() {\n        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();\n        // \u83b7\u53d6JAVA\u865a\u62df\u673a\u7684\u53ef\u7528\u5904\u7406\u5668\u6570\u91cf\u3002IO\u5bc6\u96c6\u578b\u5efa\u8bae\u6838\u5fc3\u7ebf\u7a0b\u6570\u662f\u8be5\u503c2\u500d\uff1b\u8ba1\u7b97\u5bc6\u96c6\u578b\u5efa\u8bae\u6838\u5fc3\u7ebf\u7a0b\u6570\u662f\u8be5\u503c1\u500d\n        int processorNum = Runtime.getRuntime().availableProcessors();\n\n        // \u8bbe\u7f6e\u6838\u5fc3\u7ebf\u7a0b\u6570\u91cf\u3002\u82e5\u6c60\u4e2d\u7684\u5b9e\u9645\u7ebf\u7a0b\u6570\u5c0f\u4e8e\u8be5\u503c\uff0c\u65e0\u8bba\u5176\u4e2d\u662f\u5426\u6709\u7a7a\u95f2\u7684\u7ebf\u7a0b\uff0c\u90fd\u4f1a\u4ea7\u751f\u65b0\u7684\u7ebf\u7a0b\n        executor.setCorePoolSize(processorNum * 2);\n\n        // \u8bbe\u7f6e\u6700\u5927\u7ebf\u7a0b\u6570\u91cf\n        executor.setMaxPoolSize(processorNum * 4);\n\n        // \u8bbe\u7f6e\u963b\u585e\u4efb\u52a1\u961f\u5217\u5927\u5c0f\n        executor.setQueueCapacity(100);\n\n        // \u7ebf\u7a0b\u540d\u79f0\u524d\u7f00\n        executor.setThreadNamePrefix(\"demo-\");\n\n        // \u8bbe\u7f6e\u7ebf\u7a0b\u6c60\u4e2d\u4efb\u52a1\u7684\u7b49\u5f85\u65f6\u95f4\uff0c\u82e5\u8d85\u8fc7\u7b49\u5f85\u65f6\u95f4\u4ecd\u672a\u9500\u6bc1\u5219\u5f3a\u5236\u9500\u6bc1\uff0c\u4ee5\u786e\u4fdd\u5e94\u7528\u6700\u540e\u80fd\u591f\u88ab\u5173\u95ed\uff0c\u800c\u4e0d\u662f\u963b\u585e\u4f4f\n        executor.setAwaitTerminationSeconds(AWAIT_TERMINATION_SECONDS);\n\n        // \u8bbe\u7f6e\u62d2\u7edd\u7b56\u7565\uff0c\u5f53\u7ebf\u7a0b\u6c60\u963b\u585e\u961f\u5217\u5df2\u6ee1\u65f6\u5bf9\u65b0\u4efb\u52a1\u7684\u5904\u7406\u3002\u8c03\u8282\u673a\u5236\uff0c\u5373\u9971\u548c\u65f6\u56de\u9000\u4e3b\u7ebf\u7a0b\u6267\u884c\n        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());\n        executor.initialize();\n        return executor;\n    }\n}\n</code></pre> <p>\u7ebf\u7a0b\u6c60\u5982\u4f55\u8bbe\u7f6e\u7ebf\u7a0b\u6570\uff1a \u8017\u65f6IO\u5bc6\u96c6\u578b\uff1a\u5982\u8bfb\u5199\u6570\u636e\u5e93\u3001\u6587\u4ef6\u3001\u7f51\u7edc\u901a\u4fe1\u4e86\uff0c\u5efa\u8bae\u6838\u5fc3\u7ebf\u7a0b\u6570\u662f\u5904\u7406\u5668\u6570\u91cf\u7684\u6570\u500d\uff0c\u56e0\u4e3aIO\u64cd\u4f5c\u76f8\u5bf9\u4e8eCPU\u6765\u8bf4\u6bd4\u8f83\u6162\uff0c\u4e3a\u4e86\u4e0d\u8ba9CPU\u8fc7\u591a\u7684\u7b49\u5f85\u7a7a\u8017\uff1b \u8ba1\u7b97\u5bc6\u96c6\u578b\uff1a\u5efa\u8bae\u6838\u5fc3\u7ebf\u7a0b\u6570\u662f\u5904\u7406\u5668\u6570\u91cf\u76841-2\u500d\uff0c\u56e0\u4e3aCPU\u57fa\u672c\u4e00\u76f4\u5728\u5de5\u4f5c\u3002</p>"},{"location":"java/concurrent/%E7%BA%BF%E7%A8%8B%E6%B1%A0/#_6","title":"\u6e90\u7801\u4f7f\u7528\u4e3e\u4f8b","text":"<p>\u5b9a\u65f6\u4efb\u52a1</p> <pre><code>// rocket-mq namesrv\u4e2d\nprivate final ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(new ThreadFactoryImpl(\"NSScheduledThread\"));\n\n// \u521d\u59cb\u5316\u5fc3\u8df3\u68c0\u6d4b\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf10\u79d2\u53bb\u626b\u63cf\u4e0d\u6d3b\u52a8\u7684broke\nthis.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {\n    @Override\n    public void run() {\n        NamesrvController.this.routeInfoManager.scanNotActiveBroker();\n    }\n}, 5, 10, TimeUnit.SECONDS);\n</code></pre> <p>\u56fa\u5b9a\u7ebf\u7a0b\u6c60\uff1a</p> <pre><code>this.adminBrokerExecutor = Executors.newFixedThreadPool(this.brokerConfig.getAdminBrokerThreadPoolNums(), new ThreadFactoryImpl(\"AdminBrokerThread_\"));\n</code></pre>"},{"location":"java/design/design/","title":"\u5de5\u5382\u6a21\u5f0f","text":"<p>\u5de5\u5382\u6a21\u5f0f\uff0c\u7b80\u5355\u5de5\u5382\u6a21\u5f0f\uff0c\u62bd\u8c61\u5de5\u5382\u6a21\u5f0f</p> <p>\u89d2\u8272\uff1a\u62bd\u8c61\u4ea7\u54c1\uff0c\u5177\u4f53\u4ea7\u54c1\uff1b\u62bd\u8c61\u5de5\u5382\uff0c\u5177\u4f53\u5de5\u5382\uff1b\u4e0a\u4e0b\u6587\u3002</p>"},{"location":"java/design/design/#_2","title":"\u7b80\u5355\u5de5\u5382","text":"<p>\u4ea7\u54c1\u6709\u62bd\u8c61\u5c42\uff0c\u4f46\u662f\u5de5\u5382\u6ca1\u6709\u62bd\u8c61\u5c42\uff0c\u53ea\u6709\u4e00\u4e2a\u5de5\u5382\u4e2d\u6839\u636e\u4f20\u53c2\u521b\u5efa\u76f8\u5e94\u7684\u4ea7\u54c1\u3002</p> <p>\u5982\u679c\u8981\u65b0\u589e\u4ea7\u54c1\uff0c\u9700\u8981\u4fee\u6539\u5de5\u5382\u65b9\u6cd5\u903b\u8f91\uff0c\u4e0d\u7b26\u5408\u5f00\u95ed\u539f\u5219\u3002\u56e0\u4e3a\u5de5\u5382\u65b9\u6cd5\u662f\u9759\u6001\u7684\uff0c\u4e5f\u53eb\u9759\u6001\u5de5\u5382\u6a21\u5f0f\u3002</p>"},{"location":"java/design/design/#_3","title":"\u5de5\u5382\u6a21\u5f0f","text":"<p>\u4ea7\u54c1\u6709\u62bd\u8c61\u5c42\uff0c\u5de5\u5382\u4e5f\u6709\u62bd\u8c61\u5c42\uff0c\u5373\u4e00\u4e2a\u5de5\u5382\u53ea\u80fd\u521b\u5efa\u4e00\u4e2a\u4ea7\u54c1\u7c7b\u522b\u3002</p> <p>\u5982\u679c\u65b0\u589e\u4ea7\u54c1\uff0c\u53ea\u9700\u8981\u65b0\u589e\u5de5\u5382\u5b9e\u73b0\uff0c\u4e0d\u9700\u8981\u5bf9\u5de5\u5382\u903b\u8f91\u8fdb\u884c\u4fee\u6539\uff0c\u7b26\u5408\u5f00\u95ed\u539f\u5219\u3002</p> <p></p> <p>\u76f8\u6bd4\u7b80\u5355\u5de5\u5382\u6a21\u5f0f\u5185\u90e8\u51b3\u5b9a\u751f\u4ea7\u54ea\u79cd\u4ea7\u54c1\uff0c\u5de5\u5382\u6a21\u5f0f\u4e2d\u51b3\u5b9a\u751f\u6210\u54ea\u79cd\u4ea7\u54c1\u7684\u903b\u8f91\u5728\u5916\u90e8\u5ba2\u6237\u7aef\u9009\u62e9\u4e86\u4ec0\u4e48\u6837\u7684\u5de5\u5382\u3002</p> <p>\u7f3a\u70b9\uff1a</p> <p>\u5de5\u5382\u6a21\u5f0f\u4e2d\uff0c\u5982\u679c\u8981\u591a\u4e00\u4e2a\u62bd\u8c61\u4ea7\u54c1\u5c31\u9700\u8981\u65b0\u5efa\u7acb\u4e00\u4e2a\u62bd\u8c61\u5de5\u5382\uff0c\u4e14\u9700\u8981\u7ec4\u5408\u4f7f\u7528\u591a\u4e2a\u62bd\u8c61\u4ea7\u54c1\u65f6\uff0c\u4f1a\u6bd4\u8f83\u6df7\u4e71\u3002</p>"},{"location":"java/design/design/#_4","title":"\u62bd\u8c61\u5de5\u5382","text":"<p>\u4ea7\u54c1\u6709\u62bd\u8c61\u5c42\uff0c\u5de5\u5382\u6709\u62bd\u8c61\u5c42\uff0c\u4e00\u4e2a\u5de5\u5382\u53ef\u4ee5\u521b\u5efa\u591a\u4e2a\u4ea7\u54c1\u3002\u8fd9\u591a\u4e2a\u4ea7\u54c1\u662f\u6709\u5173\u8054\u7684</p> <p>\u7528\u4e8e\u89e3\u51b3\u6709\u591a\u4ea7\u54c1\u7c7b\u522b(\u82af\u7247\u3001\u4e3b\u677f\u3001\u663e\u5361)\u60c5\u51b5\u4e0b\uff0c\u4ea7\u54c1\u65cf(A\u4ea7\u54c1\u65cf\u3001B\u4ea7\u54c1\u65cf)\u7684\u5207\u6362\u66ff\u4ee3\u95ee\u9898\u3002</p> <p></p> <p>\u4ea7\u54c1\u65cf\uff1a\u5982java\u8bfe\u7a0b \uff0cPython\u8bfe\u7a0b\u3002\u5982\u679c\u8981\u589e\u52a0\u4e00\u4e2aC\u8bed\u8a00\u8bfe\u7a0b\uff0c\u4f1a\u5f88\u5bb9\u6613\u3002</p> <p>\u4ea7\u54c1\u7c7b\u522b\uff1a\u5982article\uff0cVideo\u3002\u5982\u679c\u8981\u589e\u52a0\u4e00\u4e2a\u4ea7\u54c1\u7b49\u7ea7\u5982source\uff0c\u90a3\u6539\u52a8\u7684\u5730\u65b9\u5c31\u5f88\u591a\uff0c\u539f\u6765\u7684\u5de5\u5382java\uff0cPython\u90fd\u9700\u8981\u589e\u52a0source\u7684\u65b9\u6cd5\u3002\u4e0d\u7b26\u5408\u5f00\u95ed\u539f\u5219\u3002</p> <p>\u603b\u7ed3\uff1a\u5de5\u5382\u65b9\u6cd5\u6a21\u5f0f\u9488\u5bf9\u7684\u662f\u4e00\u4e2a\u4ea7\u54c1\u7c7b\u522b\uff0c\u800c\u62bd\u8c61\u5de5\u5382\u6a21\u5f0f\u9488\u5bf9\u7684\u662f\u591a\u4e2a\u4ea7\u54c1\u7c7b\u522b\u3002</p> <pre><code>// java.sql.Connection\u63a5\u53e3 \u5c31\u662f\u62bd\u8c61\u5de5\u5382\npublic interface Connection  extends Wrapper, AutoCloseable {\n    //...       \n        //\u8fd4\u56de\u666e\u901a\u7684sql\u6267\u884c\u5668\n        Statement createStatement() throws SQLException;\n        //\u8fd4\u56de\u5177\u6709\u53c2\u6570\u5316\u9884\u7f16\u8bd1\u529f\u80fd\u7684sql\u6267\u884c\u5668\n        PreparedStatement prepareStatement(String sql) throws SQLException;\n        //\u8fd4\u56de\u53ef\u4ee5\u6267\u884c\u5b58\u50a8\u8fc7\u7a0b\u7684sql\u6267\u884c\u5668\n        CallableStatement prepareCall(String sql) throws SQLException;   \n    //...         \n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/","title":"1.1 IoC\u5bb9\u5668\u548cBeans","text":"<p>This chapter covers the Spring Framework implementation of the Inversion of Control (IoC) principle. IoC is also known as dependency injection (DI). It is a process whereby objects define their dependencies (that is, the other objects they work with) only through constructor arguments, arguments to a factory method, or properties that are set on the object instance after it is constructed or returned from a factory method. The container then injects those dependencies when it creates the bean. This process is fundamentally the inverse (hence the name, Inversion of Control) of the bean itself controlling the instantiation or location of its dependencies by using direct construction of classes or a mechanism such as the Service Locator pattern.</p> <p>\u672c\u7ae0\u4ecb\u7ecd\u4e86spring\u6846\u67b6IOC\u5bb9\u5668\u5b9e\u73b0\u7684\u539f\u7406\u3002IoC\u4e5f\u88ab\u79f0\u4e3a\u4f9d\u8d56\u6ce8\u5165DI\u3002\u5b83\u662f\u4e00\u4e2a\u8fc7\u7a0b\uff0c\u5bf9\u8c61\u4ec5\u901a\u8fc7\u6784\u9020\u51fd\u6570\u3001\u5de5\u5382\u65b9\u6cd5\u6216\u5bf9\u8c61\u5b9e\u4f8b\u88ab\u6784\u9020\u6216\u4ece\u5de5\u5382\u65b9\u6cd5\u8fd4\u56de\u540e\u5728\u5176\u4e0a\u8bbe\u7f6e\u7684\u5c5e\u6027\u6765\u5b9a\u4e49\u5b83\u4eec\u7684\u4f9d\u8d56\u5173\u7cfb\uff08\u5373\u5b83\u4eec\u5de5\u4f5c\u7684\u5176\u4ed6\u5bf9\u8c61\uff09\uff0c\u7136\u540e\u5bb9\u5668\u5728\u521b\u5efabean\u65f6\u6ce8\u5165\u8fd9\u4e9b\u4f9d\u8d56\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4ece\u6839\u672c\u4e0a\u8bf4\u662f\u53cd\u8fc7\u6765\u7684\uff08\u6545\u540dInversion of Control\uff09\uff0c\u5373bean\u672c\u8eab\u901a\u8fc7\u76f4\u63a5\u6784\u9020\u7c7b\u6216\u8005\u670d\u52a1Locator \u6a21\u5f0f\u673a\u5236\u6765\u63a7\u5236\u4f9d\u8d56\u7684\u5b9e\u4f8b\u6216\u4f4d\u7f6e\u3002</p> <p><code>org.springframework.beans</code> \u548c<code>org.springframework.context</code> \u5305\u6784\u6210\u4e86spring\u6846\u67b6IoC\u5bb9\u5668\u7684\u57fa\u7840\u3002  BeanFactory \u63a5\u53e3\u63d0\u4f9b\u4e86\u9ad8\u7ea7\u7684\u914d\u7f6e\u673a\u5236\u6765\u7ba1\u7406\u4efb\u4f55\u7c7b\u578b\u7684bean. <code>ApplicationContext</code>\u662f BeanFactory\u7684\u5b50\u7c7b.\uff0c\u589e\u52a0\u4e86:</p> <ul> <li>\u548cSpring  AOP\u66f4\u7b80\u5355\u7684\u96c6\u6210</li> <li>Message resource handling (\u7528\u4e8e\u56fd\u9645\u5316)</li> <li>\u591a\u79cdevent\u53d1\u5e03</li> <li>\u5e94\u7528\u5c42\u7279\u5b9a\u7684\u4e0a\u4e0b\u6587\uff0c\u5982 <code>WebApplicationContext</code> \u7528\u4e8eweb\u5e94\u7528.</li> </ul> <p>\u603b\u800c\u8a00\u4e4b,  <code>BeanFactory</code> \u63d0\u4f9b\u4e86\u6846\u67b6\u914d\u7f6e\u548c\u57fa\u672c\u529f\u80fd, \u800c <code>ApplicationContext</code> \u589e\u52a0\u4e86\u66f4\u591a\u7684\u4f01\u4e1a\u529f\u80fd\u3002 <code>ApplicationContext</code>  \u662f<code>BeanFactory</code> \u7684\u5b8c\u6574\u8d85\u96c6\uff0c\u662f\u672c\u7ae0\u4e13\u95e8\u63cf\u8ff0\u7684spring IoC\u5bb9\u5668\u3002\u5982\u679c\u8981\u4f7f\u7528 <code>BeanFactory</code> \u4ee3\u66ff <code>ApplicationContext,</code> \u67e5\u770bThe <code>BeanFactory</code>\u3002</p> <p>In Spring, the objects that form the backbone of your application and that are managed by the Spring IoC container are called beans. A bean is an object that is instantiated, assembled, and managed by a Spring IoC container. Otherwise, a bean is simply one of many objects in your application. Beans, and the dependencies among them, are reflected in the configuration metadata used by a container.</p> <p>\u5728spring\u4e2d\uff0c\u6784\u6210\u5e94\u7528\u4e3b\u5e72\u5e76\u7531spring IoC\u5bb9\u5668\u7ba1\u7406\u7684\u5bf9\u8c61\u79f0\u4e3aBean\u3002Bean\u662f\u7531Spring IoC\u5bb9\u5668\u8d1f\u8d23\u5b9e\u4f8b\u5316\uff0c\u7ec4\u88c5\u548c\u7ba1\u7406\u7684\u5bf9\u8c61\uff0c\u5426\u5219\uff0cBean\u53ea\u662f\u60a8\u5e94\u7528\u4e2d\u4f17\u591a\u5bf9\u8c61\u4e2d\u7684\u4e00\u4e2a\u3002Bean\u4ee5\u53ca\u4ed6\u4eec\u4e4b\u95f4\u7684\u4f9d\u8d56\uff0c\u90fd\u53cd\u6620\u5728\u5bb9\u5668\u4f7f\u7528\u7684\u914d\u7f6e\u5143\u6570\u636e\u4e2d\u3002</p>"},{"location":"java/spring/spring/IocContainer/#12","title":"1.2 \u5bb9\u5668","text":"<p>The <code>org.springframework.context.ApplicationContext</code> interface represents the Spring IoC container and is responsible for instantiating, configuring, and assembling the beans. The container gets its instructions on what objects to instantiate, configure, and assemble by reading configuration metadata. The configuration metadata is represented in XML, Java annotations, or Java code. It lets you express the objects that compose your application and the rich interdependencies between those objects </p> <p><code>org.springframework.context.ApplicationContext</code>\u63a5\u53e3\u4ee3\u8868\u4e86Spring IoC\u5bb9\u5668\uff0c\u5e76\u8d1f\u8d23\u5b9e\u4f8b\u5316\uff0c\u914d\u7f6e\u548c\u7ec4\u88c5Bean\u3002\u5bb9\u5668\u901a\u8fc7\u8bfb\u53d6\u914d\u7f6e\u5143\u6570\u636e\uff0c\u6765\u83b7\u53d6\u5173\u4e8e\u5b9e\u4f8b\u5316\uff0c\u914d\u7f6e\u548c\u7ec4\u88c5\u54ea\u4e9b\u5bf9\u8c61\u7684\u6307\u4ee4\u3002\u8fd9\u91cc\u7684\u914d\u7f6e\u5143\u6570\u636e\u7528XML\uff0cJava\u6ce8\u89e3\u548cJava\u4ee3\u7801\u8868\u793a\u3002\u53ef\u4ee5\u8ba9\u4f60\u8868\u8fbe\u4f60\u5e94\u7528\u4e2d\u7684\u5bf9\u8c61\u548c\u8fd9\u4e9b\u5bf9\u8c61\u95f4\u7684\u4e30\u5bcc\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>Spring\u63d0\u4f9b\u4e86ApplicationContext\u63a5\u53e3\u7684\u51e0\u79cd\u5b9e\u73b0\u3002\u5728\u72ec\u7acb\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u901a\u5e38\u521b\u5efa\u4e00\u4e2aClassPathXmlApplicationContext\u6216FileSystemXmlApplicationContext\u7684\u5b9e\u4f8b\u3002\u867d\u7136 XML \u4e00\u76f4\u662f\u5b9a\u4e49\u914d\u7f6e\u5143\u6570\u636e\u7684\u4f20\u7edf\u683c\u5f0f\uff0c\u4f46\u60a8\u53ef\u4ee5\u901a\u8fc7\u63d0\u4f9b\u5c11\u91cf\u7684 XML \u914d\u7f6e\u6765\u58f0\u660e\u6027\u5730\u542f\u7528\u5bf9\u8fd9\u4e9b\u9644\u52a0\u5143\u6570\u636e\u683c\u5f0f\u7684\u652f\u6301\uff0c\u4ece\u800c\u6307\u793a\u5bb9\u5668\u4f7f\u7528 Java \u6ce8\u89e3\u6216\u4ee3\u7801\u4f5c\u4e3a\u5143\u6570\u636e\u683c\u5f0f\u3002</p> <p>\u5728\u5927\u591a\u6570\u5e94\u7528\u573a\u666f\u4e2d\uff0c\u4e0d\u9700\u8981\u663e\u5f0f\u7684\u901a\u8fc7\u7528\u6237\u4ee3\u7801\u6765\u5b9e\u4f8b\u5316Spring IoC\u5bb9\u5668\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u5b9e\u4f8b\u3002\u4f8b\u5982\uff0c\u5728 Web \u5e94\u7528\u7a0b\u5e8f\u573a\u666f\u4e2d\uff0c\u5e94\u7528\u7a0b\u5e8f\u7684 web.xml \u6587\u4ef6\u4e2d\u7684\u7b80\u5355\u516b\u884c\uff08\u6216\u5de6\u53f3\uff09\u7684\u6a21\u677f Web \u63cf\u8ff0\u7b26 XML \u901a\u5e38\u5c31\u8db3\u591f\u4e86\uff08\u8bf7\u53c2\u9605 Web \u5e94\u7528\u7a0b\u5e8f\u7684\u4fbf\u6377 ApplicationContext \u5b9e\u4f8b\u5316\uff09\u3002\u5982\u679c\u60a8\u4f7f\u7528Spring Tools for Eclipse\uff08\u4e00\u4e2aEclipse\u652f\u6301\u7684\u5f00\u53d1\u73af\u5883\uff09\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u70b9\u51fb\u51e0\u4e0b\u9f20\u6807\u6216\u51fb\u952e\u8f7b\u677e\u521b\u5efa\u8fd9\u4e2a\u6a21\u677f\u914d\u7f6e\u3002</p> <p>The following diagram shows a high-level view of how Spring works. Your application classes are combined with configuration metadata so that, after the <code>ApplicationContext</code> is created and initialized, you have a fully configured and executable system or application.</p> <p>\u4e0b\u56fe\u663e\u793a\u4e86Spring\u5de5\u4f5c\u65b9\u5f0f\u7684\u9ad8\u7ea7\u89c6\u56fe\u3002\u4f60\u7684\u5e94\u7528\u7c7b\u4e0e\u914d\u7f6e\u5143\u6570\u636e\u76f8\u7ed3\u5408\uff0c\u8fd9\u6837\uff0c\u5728ApplicationContext\u88ab\u521b\u5efa\u548c\u521d\u59cb\u5316\u540e\uff0c\u4f60\u5c31\u62e5\u6709\u4e86\u4e00\u4e2a\u5b8c\u5168\u914d\u7f6e\u597d\u7684\u53ef\u6267\u884c\u7cfb\u7edf\u6216\u5e94\u7528\u3002</p> <p></p>"},{"location":"java/spring/spring/IocContainer/#121","title":"1.2.1 \u914d\u7f6e\u5143\u6570\u636e","text":"<p>\u5982\u4e0a\u56fe\u6240\u793a\uff0cSpring IoC\u5bb9\u5668\u63a5\u53d7\u914d\u7f6e\u5143\u6570\u636e\u3002\u8be5\u914d\u7f6e\u5143\u6570\u636e\u4ee3\u8868\u4e86\u60a8\u4f5c\u4e3a\u5e94\u7528\u5f00\u53d1\u4eba\u5458\u5982\u4f55\u544a\u8bc9Spring\u5bb9\u5668\u5b9e\u4f8b\u5316\uff0c\u914d\u7f6e\u548c\u7ec4\u88c5\u5e94\u7528\u4e2d\u7684\u5bf9\u8c61\u3002</p> <p>\u914d\u7f6e\u5143\u6570\u636e\u4f20\u7edf\u4e0a\u662f\u4ee5\u7b80\u5355\u76f4\u89c2\u7684XML\u683c\u5f0f\u63d0\u4f9b\u7684\uff0c\u672c\u7ae0\u7684\u5927\u90e8\u5206\u5185\u5bb9\u5c31\u7528\u5b83\u6765\u4f20\u8fbeSpring IoC\u5bb9\u5668\u7684\u5173\u952e\u6982\u5ff5\u548c\u7279\u6027\u3002</p> <p>\u57fa\u4e8eXML\u7684\u5143\u6570\u636e\u914d\u7f6e\u5e76\u4e0d\u662f\u552f\u4e00\u7684\u5f62\u5f0f\uff0cSpring IoC\u5bb9\u5668\u672c\u8eab\u4e0e\u8fd9\u4e9b\u914d\u7f6e\u5143\u6570\u636e\u5b9e\u9645\u5199\u5165\u683c\u5f0f\u5b8c\u5168\u9694\u79bb\u3002\u5982\u4eca\uff0c\u8bb8\u591a\u5f00\u53d1\u8005\u9009\u62e9\u4e86\u57fa\u4e8eJava\u7684\u914d\u7f6e\u65b9\u5f0f\u3002</p> <p>\u6709\u5173\u5728spring\u4e2d\u4f7f\u7528\u5176\u4ed6\u5f62\u5f0f\u7684\u5143\u6570\u636e\uff0c\u8bf7\u67e5\u770b\uff1a</p> <ul> <li>1.9 Annotation-based configuration: Spring 2.5\u5f15\u5165\u7684\uff0c\u901a\u8fc7\u6ce8\u89e3\u914d\u7f6e\u5143\u6570\u636e</li> <li>1.12 Java-based configuration: \u4eceSpring3.0\u5f00\u59cb\uff0c\u53ef\u4ee5\u901a\u8fc7Java\u4ee3\u7801\u800c\u4e0d\u662fxml\u6587\u4ef6\u6765\u5b9a\u4e49\u4f60\u5e94\u7528\u7684\u7c7b\u3002\u66f4\u591a\u4fe1\u606f\u67e5\u770b <code>@Configuration</code>, <code>@Bean</code>, <code>@Import</code>, and <code>@DependsOn</code> \u6ce8\u89e3\u3002</li> </ul> <p>spring \u914d\u7f6e\u7531\u5bb9\u5668\u5fc5\u987b\u7ba1\u7406\u7684\u901a\u5e38\u4e0d\u6b62\u4e00\u4e2a bean \u5b9a\u4e49\u7ec4\u6210\u3002\u57fa\u4e8e XML \u7684\u914d\u7f6e\u5143\u6570\u636e\u5c06\u8fd9\u4e9b bean \u914d\u7f6e\u4e3a\u9876\u5c42 <code>&lt;beans/&gt;</code> \u5143\u7d20\u4e2d\u7684 <code>&lt;bean/&gt;</code> \u5143\u7d20\u3002Java \u914d\u7f6e\u901a\u5e38\u5728 @Configuration \u7c7b\u4e2d\u4f7f\u7528 @Bean \u6ce8\u91ca\u7684\u65b9\u6cd5\u3002</p> <p>\u8fd9\u4e9bbean\u5b9a\u4e49\u5bf9\u5e94\u4e8e\u6784\u6210\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5b9e\u9645\u5bf9\u8c61\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4f60\u4f1a\u5b9a\u4e49\u670d\u52a1\u5c42\u5bf9\u8c61\u3001\u6570\u636e\u8bbf\u95ee\u5bf9\u8c61\uff08DAO\uff09\u3001\u8868\u73b0\u5bf9\u8c61\uff08\u5982Struts Action\u5b9e\u4f8b\uff09\u3001\u57fa\u7840\u8bbe\u65bd\u5bf9\u8c61\uff08\u5982Hibernate SessionFactories\u3001JMS\u961f\u5217\u7b49\uff09\u7b49\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4eba\u4eec\u4e0d\u4f1a\u5728\u5bb9\u5668\u4e2d\u914d\u7f6e\u7ec6\u7c92\u5ea6\u7684\u57df\u5bf9\u8c61\uff0c\u56e0\u4e3a\u521b\u5efa\u548c\u52a0\u8f7d\u57df\u5bf9\u8c61\u901a\u5e38\u662fDAO\u548c\u4e1a\u52a1\u903b\u8f91\u7684\u8d23\u4efb\u3002\u7136\u800c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528Spring\u4e0eAspectJ\u7684\u96c6\u6210\u6765\u914d\u7f6e\u5728IoC\u5bb9\u5668\u63a7\u5236\u4e4b\u5916\u521b\u5efa\u7684\u5bf9\u8c61\u3002\u8bf7\u53c2\u9605\u4f7f\u7528 AspectJ \u4e0e Spring \u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\u57df\u5bf9\u8c61\u3002</p>"},{"location":"java/spring/spring/IocContainer/#123","title":"1.2.3 \u4f7f\u7528\u5bb9\u5668","text":"<p>ApplicationContext\u662f\u4e00\u4e2a\u9ad8\u7ea7\u5de5\u5382\u7684\u63a5\u53e3\uff0c\u5b83\u80fd\u591f\u7ef4\u62a4\u4e0d\u540cBean\u53ca\u5176\u4f9d\u8d56\u5173\u7cfb\u7684\u6ce8\u518c\u8868\u3002\u901a\u8fc7\u4f7f\u7528T <code>getBean(String name, Class&lt;T&gt; requiredType)</code>\u65b9\u6cd5\uff0c\u4f60\u53ef\u4ee5\u68c0\u7d22\u4f60\u7684bean\u7684\u5b9e\u4f8b\u3002</p> <p>ApplicationContext\u5141\u8bb8\u4f60\u8bfb\u53d6Bean\u5b9a\u4e49\u548c\u83b7\u53d6\u4ed6\u4eec\uff0c\u5982\uff1a</p> <pre><code>// create and configure beans\nApplicationContext context = new ClassPathXmlApplicationContext(\"services.xml\", \"daos.xml\");\n\n// retrieve configured instance\nPetStoreService service = context.getBean(\"petStore\", PetStoreService.class);\n\n// use configured instance\nList&lt;String&gt; userList = service.getUsernameList();\n</code></pre> <p>\u6700\u7075\u6d3b\u7684\u53d8\u4f53\u662f <code>GenericApplicationContext</code>\u548c\u8bfb\u53d6\u4ee3\u7406\u76f8\u7ed3\u5408\uff0c\u4f8b\u5982\u4e0eXML\u6587\u4ef6\u7684XmlBeanDefinitionReader\u76f8\u7ed3\u5408\uff0c\u5982\uff1a</p> <pre><code>GenericApplicationContext context = new GenericApplicationContext();\nnew XmlBeanDefinitionReader(context).loadBeanDefinitions(\"services.xml\", \"daos.xml\");\ncontext.refresh();\n</code></pre> <p>\u4f60\u53ef\u4ee5\u5728\u540c\u4e00\u4e2aApplicationContext\u4e0a\u6df7\u5408\u548c\u5339\u914d\u8fd9\u6837\u7684\u8bfb\u53d6\u4ee3\u7406\uff0c\u4ece\u4e0d\u540c\u7684\u914d\u7f6e\u6e90\u8bfb\u53d6Bean\u5b9a\u4e49\u3002</p> <p>\u7136\u540e\u4f60\u53ef\u4ee5\u4f7f\u7528getBean()\u6765\u68c0\u7d22Bean\u3002ApplicationContext\u63a5\u53e3\u8fd8\u6709\u5176\u4ed6\u4e00\u4e9b\u65b9\u6cd5\u7528\u4e8e\u68c0\u7d22Bean\uff0c\u4f46\u662f\uff0c\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u4e0d\u5e94\u8be5\u4f7f\u7528\u5b83\u4eec\u3002\u4e8b\u5b9e\u4e0a\uff0c\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u6839\u672c\u4e0d\u5e94\u8be5\u8c03\u7528getBean()\u65b9\u6cd5\uff0c\u8fd9\u6837\u5bf9Spring API\u5b8c\u5168\u6ca1\u6709\u4f9d\u8d56\u6027\u3002\u4f8b\u5982\uff0cSpring\u4e0eWeb\u6846\u67b6\u7684\u96c6\u6210\u4e3a\u5404\u79cdWeb\u6846\u67b6\u7ec4\u4ef6\uff08\u5982\u63a7\u5236\u5668\u548cJSF\u7ba1\u7406\u7684Bean\uff09\u63d0\u4f9b\u4e86\u4f9d\u8d56\u6ce8\u5165\uff0c\u8ba9\u4f60\u901a\u8fc7\u5143\u6570\u636e\uff08\u5982autowiring\u6ce8\u89e3\uff09\u58f0\u660e\u5bf9\u7279\u5b9aBean\u7684\u4f9d\u8d56\u3002</p>"},{"location":"java/spring/spring/IocContainer/#13-bean","title":"1.3 Bean","text":"<p>Spring\u5bb9\u5668\u7ba1\u7406\u4e00\u4e2a\u6216\u591a\u4e2aBean\u3002\u8fd9\u4e9bBean\u901a\u8fc7\u914d\u7f6e\u5143\u6570\u636e\u5e94\u7528\u5230\u5bb9\u5668\u4e2d\uff08\u4f8b\u5982XMl\u4e2d\u7684 <code>&lt;bean/&gt;</code> \u5b9a\u4e49\uff09\u3002</p> <p>Within the container itself, these bean definitions are represented as <code>BeanDefinition</code> objects, which contain (among other information) the following metadata:</p> <ul> <li>A package-qualified class name: typically, the actual implementation class of the bean being defined.</li> <li>Bean behavioral configuration elements, which state how the bean should behave in the container (scope, lifecycle callbacks, and so forth).</li> <li>References to other beans that are needed for the bean to do its work. These references are also called collaborators or dependencies.</li> <li>Other configuration settings to set in the newly created object\u2009\u2014\u2009for example, the size limit of the pool or the number of connections to use in a bean that manages a connection pool.</li> </ul> <p>\u5728\u5bb9\u5668\u672c\u8eab\uff0c\u8fd9\u4e9bBean\u5b9a\u4e49\u88ab\u8868\u793a\u4e3aBeanDefinition\u5bf9\u8c61\uff0c\u5b83\u5305\u542b\u4ee5\u4e0b(\u9664\u4e86\u5176\u4ed6\u4fe1\u606f)\u5143\u6570\u636e</p> <ul> <li>\u5305\u9650\u5b9a\u7684\u7c7b\u540d: \u901a\u5e38\u662f\u88ab\u5b9a\u4e49\u7684Bean\u7684\u5b9e\u9645\u5b9e\u73b0\u7c7b.</li> <li>Bean\u7684\u884c\u4e3a\u914d\u7f6e\uff0c\u5b83\u8bf4\u660e\u4e86Bean\u5728\u5bb9\u5668\u4e2d\u5e94\u8be5\u8868\u73b0\u7684\u72b6\u6001(scope, lifecycle callbacks\u7b49)</li> <li>\u5bf9\u5176\u4ed6Bean\u7684\u5f15\u7528\uff0c\u8fd9\u4e9b\u5f15\u7528\u662fBean\u5de5\u4f5c\u6240\u9700\u8981\u7684\uff0c\u4e5f\u88ab\u6210\u4e3a\u4f9d\u8d56</li> <li>\u8981\u5728\u65b0\u521b\u5efa\u7684\u5bf9\u8c61\u4e2d\u8bbe\u7f6e\u7684\u5176\u4ed6\u914d\u7f6e\u5143\u7d20\u3002\u4f8b\u5982\uff0c\u6c60\u7684\u5927\u5c0f\uff0cBean\u8981\u7ba1\u7406\u7684\u8fde\u63a5\u6c60\u7684\u8fde\u63a5\u6570\u7b49\u3002\u4e5f\u5c31\u662f\u5c5e\u6027\u5427</li> </ul> <p>\u8fd9\u4e9b\u5143\u6570\u636e\u7ec4\u6210\u4e00\u7ec4\u5c5e\u6027\uff0c\u8fd9\u4e9b\u5c5e\u6027\u6784\u6210\u4e86\u6bcf\u4e2aBean\u5b9a\u4e49\uff0c\u5982\u4e0b\u8868\uff1a</p> Property Explained in\u2026 Class Instantiating Beans Name Naming Beans Scope Bean Scopes Constructor arguments Dependency Injection Properties Dependency Injection Autowiring mode Autowiring Collaborators Lazy initialization mode Lazy-initialized Beans Initialization method Initialization Callbacks Destruction method Destruction Callbacks <p>In addition to bean definitions that contain information on how to create a specific bean, the <code>ApplicationContext</code> implementations also permit the registration of existing objects that are created outside the container (by users). This is done by accessing the ApplicationContext\u2019s BeanFactory through the <code>getBeanFactory()</code> method, which returns the BeanFactory <code>DefaultListableBeanFactory</code> implementation. <code>DefaultListableBeanFactory</code> supports this registration through the <code>registerSingleton(..)</code> and <code>registerBeanDefinition(..)</code> methods. However, typical applications work solely with beans defined through regular bean definition metadata.</p> <p>Bean metadata and manually supplied singleton instances need to be registered as early as possible, in order for the container to properly reason about them during autowiring and other introspection steps. While overriding existing metadata and existing singleton instances is supported to some degree, the registration of new beans at runtime (concurrently with live access to the factory) is not officially supported and may lead to concurrent access exceptions, inconsistent state in the bean container, or both.</p> <p>\u9664\u4e86\u5305\u542b\u5982\u4f55\u521b\u5efa\u7279\u5b9aBean\u4fe1\u606f\u7684Bean\u5b9a\u4e49\u4e4b\u5916\uff0cApplicationContext\u5b9e\u73b0\u8fd8\u5141\u8bb8\u6ce8\u518c\u5728\u5bb9\u5668\u4e4b\u5916\uff08\u7531\u7528\u6237\uff09\u521b\u5efa\u7684\u73b0\u6709\u5bf9\u8c61\u3002\u8fd9\u662f\u901a\u8fc7getBeanFactory()\u65b9\u6cd5\u8bbf\u95eeApplicationContext\u7684BeanFactory\u6765\u5b9e\u73b0\u7684\uff0c\u8be5\u65b9\u6cd5\u8fd4\u56deBeanFactory\u7684DefaultListableBeanFactory\u5b9e\u73b0\u3002DefaultListableBeanFactory\u901a\u8fc7registerSingleton(..)\u548cregisterBeanDefinition(..)\u65b9\u6cd5\u652f\u6301\u8fd9\u79cd\u6ce8\u518c\u3002\u7136\u800c\uff0c\u5178\u578b\u7684\u5e94\u7528\u7a0b\u5e8f\u53ea\u4f7f\u7528\u901a\u8fc7\u5e38\u89c4bean\u5b9a\u4e49\u5143\u6570\u636e\u5b9a\u4e49\u7684bean\u3002</p> <p>Bean\u5143\u6570\u636e\u548c\u624b\u52a8\u63d0\u4f9b\u7684\u5355\u4f8b\u9700\u8981\u5c3d\u53ef\u80fd\u65e9\u5730\u6ce8\u518c\uff0c\u4ee5\u4fbf\u5bb9\u5668\u53ef\u4ee5\u5728\u81ea\u52a8\u6ce8\u5165\u548c\u5176\u4ed6set\u8bbe\u7f6e\u65f6\u53ef\u4ee5\u6b63\u786e\u7684\u63a8\u7406\u3002\u867d\u7136\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u652f\u6301\u8986\u76d6\u73b0\u6709\u7684\u5143\u6570\u636e\u548c\u5355\u4f8b\uff0c\u4f46\u662f\u5b98\u65b9\u5e76\u4e0d\u652f\u6301\u5728\u8fd0\u884c\u65f6\u6ce8\u518c\u65b0\u7684bean\uff08\u548c\u5de5\u5382\u7684\u8bbf\u95ee\u540c\u65f6\u8fdb\u884c\uff09\uff0c\u5e76\u4e14\u53ef\u80fd\u5bfc\u81f4\u5e76\u53d1\u8bbf\u95ee\u5f02\u5e38\uff0cbean\u72b6\u6001\u4e0d\u4e00\u81f4\u7b49\u3002</p>"},{"location":"java/spring/spring/IocContainer/#131-bean","title":"1.3.1 Bean\u7684\u547d\u540d","text":"<p>Every bean has one or more identifiers. These identifiers must be unique within the container that hosts the bean. A bean usually has only one identifier. However, if it requires more than one, the extra ones can be considered aliases.</p> <p>In XML-based configuration metadata, you use the <code>id</code> attribute, the <code>name</code> attribute, or both to specify the bean identifiers. The <code>id</code> attribute lets you specify exactly one id. Conventionally, these names are alphanumeric ('myBean', 'someService', etc.), but they can contain special characters as well. If you want to introduce other aliases for the bean, you can also specify them in the <code>name</code> attribute, separated by a comma (<code>,</code>), semicolon (<code>;</code>), or white space. As a historical note, in versions prior to Spring 3.1, the <code>id</code> attribute was defined as an <code>xsd:ID</code> type, which constrained possible characters. As of 3.1, it is defined as an <code>xsd:string</code> type. Note that bean <code>id</code> uniqueness is still enforced by the container, though no longer by XML parsers.</p> <p>You are not required to supply a <code>name</code> or an <code>id</code> for a bean. If you do not supply a <code>name</code> or <code>id</code> explicitly, the container generates a unique name for that bean. However, if you want to refer to that bean by name, through the use of the <code>ref</code> element or a Service Locator style lookup, you must provide a name. Motivations for not supplying a name are related to using inner beans and autowiring collaborators.</p> <p>\u6bcf\u4e2aBean\u90fd\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u8bc6\u7b26\u3002\u8fd9\u4e9b\u6807\u8bc6\u7b26\u5728\u5bf9\u5e94\u7684\u5bb9\u5668\u4e2d\u5fc5\u987b\u662f\u552f\u4e00\u7684\u3002\u4e00\u4e2aBean\u901a\u5e38\u53ea\u6709\u4e00\u4e2a\u6807\u8bc6\u7b26\u3002\u7136\u800c\uff0c\u5982\u679c\u5b83\u9700\u8981\u591a\u4e2a\u6807\u8bc6\u7b26\uff0c\u90a3\u4e48\u989d\u5916\u7684\u6807\u8bc6\u7b26\u4f1a\u88ab\u8ba4\u4e3a\u662f\u522b\u540d\u3002</p> <p>\u5728\u57fa\u4e8eXML\u7684\u5143\u6570\u636e\u914d\u7f6e\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528id\uff0cname\u5c5e\u6027\uff0c\u6216\u8005\u540c\u65f6\u4f7f\u7528\uff0c\u6765\u6307\u5b9aBean\u7684\u6807\u8bc6\u7b26\u3002id\u5c5e\u6027\u53ef\u4ee5\u8ba9\u4f60\u7cbe\u786e\u7684\u6307\u5b9a\u4e00\u4e2aBean\u3002\u4f20\u7edf\u4e0a\uff0c\u8fd9\u4e9b\u540d\u79f0\u53ef\u4ee5\u662f\u5b57\u6bcd\u6570\u5b57\uff08'myBean'\u3001'someService'\u7b49\uff09\uff0c\u4f46\u4e5f\u53ef\u4ee5\u5305\u542b\u7279\u6b8a\u5b57\u7b26\u3002\u5982\u679c\u4f60\u60f3\u4e3aBean\u5f15\u5165\u5176\u4ed6\u522b\u540d\uff0c\u4e5f\u53ef\u4ee5\u5728name\u4e2d\u6307\u5b9a\uff0c\u7528\u9017\u53f7\uff0c\u5206\u53f7\u6216\u7a7a\u683c\u5206\u9694\u3002\u4f5c\u4e3a\u5386\u53f2\u6027\u7684\u8bf4\u660e\uff0c\u5728Spring 3.1\u4e4b\u524d\u7684\u7248\u672c\u4e2d\uff0cid\u5c5e\u6027\u88ab\u5b9a\u4e49\u4e3axsd:ID\u7c7b\u578b\uff0c\u5b83\u9650\u5236\u4e86\u53ef\u80fd\u7684\u5b57\u7b26\u3002\u4ece3.1\u5f00\u59cb\uff0c\u5b83\u88ab\u5b9a\u4e49\u4e3axsd:string\u7c7b\u578b\u3002\u8bf7\u6ce8\u610f\uff0cbean id \u552f\u4e00\u6027\u4ecd\u7136\u7531\u5bb9\u5668\u5f3a\u5236\u6267\u884c\uff0c\u5c3d\u7ba1\u4e0d\u518d\u7531 XML \u89e3\u6790\u5668\u6267\u884c\u3002</p> <p>\u60a8\u4e0d\u9700\u8981\u4e3aBean\u63d0\u4f9bname\u6216id\uff0c\u5982\u679c\u4f60\u4e0d\u663e\u793a\u7684\u63d0\u4f9bname\u6216id\uff0c\u5bb9\u5668\u5c31\u4f1a\u4e3a\u8be5Bean\u751f\u6210\u4e00\u4e2a\u552f\u4e00\u7684name\u3002\u4f46\u662f\uff0c\u5982\u679c\u4f60\u60f3\u901a\u8fc7\u4f7f\u7528ref\u5143\u7d20\u6765\u7528name\u5f15\u7528\u8be5Bean\uff0c\u60a8\u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2aname\u3002\u4e0d\u63d0\u4f9b\u540d\u79f0\u7684\u52a8\u673a\u4e0e\u4f7f\u7528\u5185\u90e8Bean\u548c\u81ea\u52a8\u6ce8\u5165\u5408\u4f5c\u8005\u6709\u5173\u3002</p> <p>\u5728\u547d\u540dbean\u65f6\u60ef\u4f8b\u4f7f\u7528\u6807\u51c6\u7684Java\u60ef\u4f8b\u6765\u547d\u540d\u5b9e\u4f8b\u5b57\u6bb5\u540d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cbean\u540d\u79f0\u4ee5\u5c0f\u5199\u5b57\u6bcd\u5f00\u5934\uff0c\u9a7c\u5cf0\u8868\u793a\u3002\u5982accountManager\u3001accountService\u3001userDao\u3001loginController\u7b49\u3002</p> <p>\u7edf\u4e00\u547d\u540dbean\u53ef\u4ee5\u8ba9\u4f60\u7684\u914d\u7f6e\u66f4\u5bb9\u6613\u9605\u8bfb\u548c\u7406\u89e3\u3002\u6b64\u5916\uff0c\u5982\u679c\u4f60\u4f7f\u7528Spring AOP\uff0c\u5f53\u4f60\u5bf9\u4e00\u7ec4\u540d\u5b57\u76f8\u5173\u7684bean\u5e94\u7528\u5efa\u8bae\u65f6\uff0c\u5b83\u6709\u5f88\u5927\u7684\u5e2e\u52a9\u3002</p> <p>\u901a\u8fc7classpath\u4e2d\u7684\u7ec4\u4ef6\u626b\u63cf\uff0cSpring\u4e3a\u672a\u547d\u540d\u7684\u7ec4\u4ef6\u751f\u6210bean\u540d\u79f0\uff0c\u9075\u5faa\u524d\u9762\u63cf\u8ff0\u7684\u89c4\u5219\uff1a\u57fa\u672c\u4e0a\uff0c\u53d6\u7b80\u5355\u7684\u7c7b\u540d\uff0c\u5e76\u5c06\u5176\u9996\u5b57\u6bcd\u53d8\u6210\u5c0f\u5199\u3002\u7136\u800c\uff0c\u5728\u7279\u6b8a\u60c5\u51b5\u4e0b\uff0c\u5f53\u6709\u591a\u4e2a\u5b57\u7b26\uff0c\u5e76\u4e14\u7b2c\u4e00\u4e2a\u548c\u7b2c\u4e8c\u4e2a\u5b57\u7b26\u90fd\u662f\u5927\u5199\u65f6\uff0c\u539f\u59cb\u7684\u683c\u5f0f\u4f1a\u88ab\u4fdd\u7559\u3002\u8fd9\u4e9b\u89c4\u5219\u4e0ejava.beans.Introspector.decapitalize\uff08Spring\u5728\u8fd9\u91cc\u4f7f\u7528\uff09\u5b9a\u4e49\u7684\u89c4\u5219\u76f8\u540c\u3002</p>"},{"location":"java/spring/spring/IocContainer/#beanbean","title":"\u5728Bean\u5b9a\u4e49\u4e4b\u5916\u4e3aBean\u53d6\u522b\u540d","text":"<p>In a bean definition itself, you can supply more than one name for the bean, by using a combination of up to one name specified by the id attribute and any number of other names in the name attribute. These names can be equivalent aliases to the same bean and are useful for some situations, such as letting each component in an application refer to a common dependency by using a bean name that is specific to that component itself.</p> <p>Specifying all aliases where the bean is actually defined is not always adequate, however. It is sometimes desirable to introduce an alias for a bean that is defined elsewhere. This is commonly the case in large systems where configuration is split amongst each subsystem, with each subsystem having its own set of object definitions. In XML-based configuration metadata, you can use the  element to accomplish this. The following example shows how to do so:</p> <p>\u5728Bean\u5b9a\u4e49\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4e3aBean\u63d0\u4f9b\u4e00\u4e2a\u4ee5\u4e0a\u7684\u540d\u79f0\uff0c\u4f7f\u7528\u7531id\u5c5e\u6027\u6307\u5b9a\u7684\u6700\u591a\u4e00\u4e2a\u540d\u79f0\u548c\u4f7f\u7528name\u5c5e\u6027\u6307\u5b9a\u4efb\u610f\u6570\u91cf\u7684\u5176\u4ed6\u540d\u79f0\u3002\u8fd9\u4e9b\u540d\u79f0\u53ef\u4ee5\u662f\u540c\u4e00\u4e2aBean\u7684\u7b49\u4ef7\u522b\u540d\uff0c\u5bf9\u4e8e\u67d0\u4e9b\u60c5\u51b5\u6765\u8bf4\u662f\u5f88\u6709\u7528\u7684\uff0c\u6bd4\u5982\u8ba9\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u4f7f\u7528\u4e00\u4e2a\u7279\u5b9a\u4e8e\u8be5\u7ec4\u4ef6\u672c\u8eab\u7684Bean\u540d\u79f0\u6765\u5f15\u7528\u4e00\u4e2a\u5171\u540c\u7684\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u7136\u800c\uff0c\u5728\u5b9e\u9645\u5b9a\u4e49Bean\u7684\u5730\u65b9\u6307\u5b9a\u6240\u6709\u522b\u540d\u5e76\u4e0d\u603b\u662f\u8db3\u591f\u7684\u3002\u6709\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4e3a\u5728\u5176\u4ed6\u5730\u65b9\u5b9a\u4e49\u7684Bean\u5f15\u5165\u4e00\u4e2a\u522b\u540d\u3002\u8fd9\u79cd\u60c5\u51b5\u5728\u5927\u578b\u7cfb\u7edf\u4e2d\u5f88\u5e38\u89c1\uff0c\u56e0\u4e3a\u5728\u8fd9\u4e9b\u7cfb\u7edf\u4e2d\uff0c\u914d\u7f6e\u88ab\u5206\u5272\u5728\u6bcf\u4e2a\u5b50\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u5b50\u7cfb\u7edf\u90fd\u6709\u81ea\u5df1\u7684\u5bf9\u8c61\u5b9a\u4e49\u96c6\u3002\u5728\u57fa\u4e8eXML\u7684\u914d\u7f6e\u5143\u6570\u636e\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5143\u7d20\u6765\u5b9e\u73b0\u8fd9\u4e00\u76ee\u7684\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\u3002</p> <pre><code>&lt;alias name=\"fromName\" alias=\"toName\"/&gt;\n</code></pre> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u540d\u4e3afromName\u7684bean\uff08\u5728\u540c\u4e00\u4e2a\u5bb9\u5668\u4e2d\uff09\u5728\u4f7f\u7528\u8fd9\u4e2a\u522b\u540d\u5b9a\u4e49\u4e4b\u540e\uff0c\u4e5f\u53ef\u4ee5\u88ab\u79f0\u4e3atoName\u3002</p> <p>\u4f8b\u5982\uff0c\u5b50\u7cfb\u7edf A \u7684\u914d\u7f6e\u5143\u6570\u636e\u53ef\u4ee5\u7528 <code>subsystemA-dataSource</code> \u7684\u540d\u79f0\u6765\u5f15\u7528\u4e00\u4e2a DataSource\u3002\u5b50\u7cfb\u7edfB\u7684\u914d\u7f6e\u5143\u6570\u636e\u53ef\u4ee5\u7528<code>subsystemB-dataSource</code>\u7684\u540d\u79f0\u6765\u5f15\u7528DataSource\u3002\u5f53\u7ec4\u6210\u4f7f\u7528\u8fd9\u4e24\u4e2a\u5b50\u7cfb\u7edf\u7684\u4e3b\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u4e3b\u5e94\u7528\u7a0b\u5e8f\u4ee5<code>myApp-dataSource</code>\u7684\u540d\u79f0\u6765\u5f15\u7528DataSource\u3002\u8981\u8ba9\u8fd9\u4e09\u4e2a\u540d\u79f0\u90fd\u5f15\u7528\u540c\u4e00\u4e2a\u5bf9\u8c61\uff0c\u53ef\u4ee5\u5728\u914d\u7f6e\u5143\u6570\u636e\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u522b\u540d\u5b9a\u4e49\u3002</p> <pre><code>&lt;alias name=\"myApp-dataSource\" alias=\"subsystemA-dataSource\"/&gt;\n&lt;alias name=\"myApp-dataSource\" alias=\"subsystemB-dataSource\"/&gt;\n</code></pre> <p>\u73b0\u5728\u6bcf\u4e2a\u5b50\u7cfb\u7edf\u548c\u4e3b\u7cfb\u7edf\u90fd\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a\u552f\u4e00\u7684name\u5f15\u7528dataSource\uff0c\u5e76\u4e14\u4e0d\u4e0e\u5176\u4ed6\u5b9a\u4e49\u53d1\u751f\u51b2\u7a81\uff0c\u4f46\u5f15\u7528\u7684\u662f\u540c\u4e00\u4e2adataSource\u3002</p> <p>\u4f7f\u7528\u6ce8\u89e3\u4e5f\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2aBean\u7684\u522b\u540d\u3002</p>"},{"location":"java/spring/spring/IocContainer/#132-bean","title":"1.3.2 \u5b9e\u4f8b\u5316Bean","text":"<p>A bean definition is essentially a recipe for creating one or more objects. The container looks at the recipe for a named bean when asked and uses the configuration metadata encapsulated by that bean definition to create (or acquire) an actual object. </p> <p>Bean definition \u672c\u8d28\u4e0a\u662f\u521b\u5efa\u4e00\u4e2a\u6216\u591a\u4e2a\u5bf9\u8c61\u7684\u914d\u65b9\uff08\u98df\u8c31\uff09\u3002\u5bb9\u5668\u5728\u88ab\u8bf7\u6c42\u65f6\u67e5\u770bBean\u7684\u914d\u65b9\uff0c\u5e76\u4f7f\u7528\u8be5Bean\u5b9a\u4e49\u5c01\u88c5\u7684\u914d\u7f6e\u5143\u6570\u636e\u6765\u521b\u5efa\uff08\u6216\u83b7\u53d6\uff09\u4e00\u4e2a\u5b9e\u9645\u7684\u5bf9\u8c61\u3002</p> <p>\u5982\u679c\u60a8\u4f7f\u7528\u57fa\u4e8e XML \u7684\u914d\u7f6e\u5143\u6570\u636e\uff0c\u60a8\u53ef\u4ee5\u5728 <code>&lt;bean/&gt;</code> \u5143\u7d20\u7684 class \u5c5e\u6027\u4e2d\u6307\u5b9a\u8981\u5b9e\u4f8b\u5316\u7684\u5bf9\u8c61\u7684\u7c7b\u578b\uff08\u6216\u7c7b\uff09\u3002\u8fd9\u4e2a\u7c7b\u5c5e\u6027\uff08\u5728\u5185\u90e8\uff0c\u5b83\u662fBeanDefinition\u5b9e\u4f8b\u4e0a\u7684\u4e00\u4e2aClass\u5c5e\u6027\uff09\u901a\u5e38\u662f\u5f3a\u5236\u6027\u7684\u3002\uff08\u5173\u4e8e\u4f8b\u5916\u60c5\u51b5\uff0c\u8bf7\u53c2\u89c1Instantiation by Using an Instance Factory Method and Bean Definition Inheritance.\uff09\u3002\u60a8\u53ef\u4ee5\u7528\u4e24\u79cd\u65b9\u5f0f\u4e4b\u4e00\u6765\u4f7f\u7528Class\u5c5e\u6027\u3002</p> <ul> <li>\u901a\u5e38\uff0c\u5728\u5bb9\u5668\u672c\u8eab\u901a\u8fc7\u53cd\u5c04\u8c03\u7528\u5176\u6784\u9020\u51fd\u6570\u5730\u76f4\u63a5\u521b\u5efabean\u7684\u60c5\u51b5\u4e0b\uff0c\u6307\u5b9a\u8981\u6784\u9020\u7684bean\u7684class\uff0c\u6709\u70b9\u76f8\u5f53\u4e8e\u4f7f\u7528new\u64cd\u4f5c\u7b26\u7684Java\u4ee3\u7801\u3002</li> <li>\u5728\u5bb9\u5668\u8c03\u7528\u7c7b\u7684\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u6765\u521b\u5efabean\u7684\u60c5\u51b5\u4e0b\uff0c\u8981\u6307\u5b9a\u5305\u542b\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u7684\u5b9e\u9645\u7c7b\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0d\u592a\u5e38\u89c1\u3002\u4ece\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u7684\u8c03\u7528\u4e2d\u8fd4\u56de\u7684\u5bf9\u8c61\u7c7b\u578b\u53ef\u80fd\u662f\u540c\u4e00\u4e2a\u7c7b\uff0c\u4e5f\u53ef\u80fd\u5b8c\u5168\u662f\u53e6\u4e00\u4e2a\u7c7b\u3002</li> </ul>"},{"location":"java/spring/spring/IocContainer/#bean","title":"\u901a\u8fc7\u6784\u9020\u5668\u6765\u5b9e\u4f8b\u5316Bean","text":"<p>When you create a bean by the constructor approach, all normal classes are usable by and compatible with Spring. That is, the class being developed does not need to implement any specific interfaces or to be coded in a specific fashion. Simply specifying the bean class should suffice. However, depending on what type of IoC you use for that specific bean, you may need a default (empty) constructor.</p> <p>The Spring IoC container can manage virtually any class you want it to manage. It is not limited to managing true JavaBeans. Most Spring users prefer actual JavaBeans with only a default (no-argument) constructor and appropriate setters and getters modeled after the properties in the container. You can also have more exotic non-bean-style classes in your container. If, for example, you need to use a legacy connection pool that absolutely does not adhere to the JavaBean specification, Spring can manage it as well.</p> <p>\u5f53\u4f60\u901a\u8fc7\u6784\u9020\u51fd\u6570\u7684\u65b9\u6cd5\u521b\u5efa\u4e00\u4e2abean\u65f6\uff0c\u6240\u6709\u7684\u666e\u901a\u7c7b\u90fd\u53ef\u4ee5\u88abSpring\u4f7f\u7528\uff0c\u5e76\u4e14\u4e0eSpring\u517c\u5bb9\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u88ab\u5f00\u53d1\u7684\u7c7b\u4e0d\u9700\u8981\u5b9e\u73b0\u4efb\u4f55\u7279\u5b9a\u7684\u63a5\u53e3\uff0c\u4e5f\u4e0d\u9700\u8981\u4ee5\u7279\u5b9a\u7684\u65b9\u5f0f\u8fdb\u884c\u7f16\u7801\u3002\u7b80\u5355\u5730\u6307\u5b9abean\u7c7b\u5c31\u5e94\u8be5\u8db3\u591f\u4e86\u3002\u7136\u800c\uff0c\u6839\u636e\u60a8\u4e3a\u8be5\u7279\u5b9aBean\u4f7f\u7528\u7684IoC\u7c7b\u578b\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u4e00\u4e2a\u9ed8\u8ba4\uff08\u7a7a\uff09\u6784\u9020\u51fd\u6570\u3002</p> <p>Spring IoC\u5bb9\u5668\u51e0\u4e4e\u53ef\u4ee5\u7ba1\u7406\u60a8\u5e0c\u671b\u5b83\u7ba1\u7406\u7684\u4efb\u4f55\u7c7b\u3002\u5b83\u4e0d\u9650\u4e8e\u7ba1\u7406\u771f\u6b63\u7684JavaBeans\u3002\u5927\u591a\u6570Spring\u7528\u6237\u66f4\u559c\u6b22\u5b9e\u9645\u7684JavaBeans\uff0c\u53ea\u9700\u8981\u4e00\u4e2a\u9ed8\u8ba4\u7684\uff08\u65e0\u53c2\uff09\u6784\u9020\u51fd\u6570\u548c\u9002\u5f53\u7684setters \u548cgetters \uff0c\u4ee5\u5bb9\u5668\u4e2d\u7684\u5c5e\u6027\u4e3a\u6a21\u578b\u3002\u4f60\u4e5f\u53ef\u4ee5\u5728\u4f60\u7684\u5bb9\u5668\u4e2d\u62e5\u6709\u66f4\u591a\u5947\u7279\u7684\u975ebean\u98ce\u683c\u7684\u7c7b\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u7edd\u5bf9\u4e0d\u9075\u5b88JavaBean\u89c4\u8303\u7684\u4f20\u7edf\u8fde\u63a5\u6c60\uff0cSpring\u4e5f\u53ef\u4ee5\u7ba1\u7406\u5b83\u3002</p> <pre><code>&lt;bean id=\"exampleBean\" class=\"examples.ExampleBean\"/&gt;\n\n&lt;bean name=\"anotherExample\" class=\"examples.ExampleBeanTwo\"/&gt;\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#bean_1","title":"\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u6765\u5b9e\u4f8b\u5316Bean","text":"<p>\u5f53\u5b9a\u4e49\u4e00\u4e2a\u4f7f\u7528\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u521b\u5efa\u7684Bean\u65f6\uff0c\u4f7f\u7528class\u5c5e\u6027\u6765\u6307\u5b9a\u5305\u542b\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u7684\u7c7b\uff0c\u5e76\u4f7f\u7528\u540d\u4e3afactory-method\u7684\u5c5e\u6027\u6765\u6307\u5b9a\u5de5\u5382\u65b9\u6cd5\u672c\u8eab\u7684\u540d\u79f0\u3002\u4f60\u5e94\u8be5\u80fd\u591f\u8c03\u7528\u8fd9\u4e2a\u65b9\u6cd5\uff08\u6709\u53ef\u9009\u7684\u53c2\u6570\uff0c\u5982\u540e\u9762\u6240\u8ff0\uff09\u5e76\u8fd4\u56de\u4e00\u4e2a\u6d3b\u7684\u5bf9\u8c61\uff0c\u968f\u540e\u8fd9\u4e2a\u5bf9\u8c61\u88ab\u5f53\u4f5c\u662f\u901a\u8fc7\u6784\u9020\u51fd\u6570\u521b\u5efa\u7684\u3002\u8fd9\u79cdbean\u5b9a\u4e49\u7684\u4e00\u4e2a\u7528\u9014\u662f\u5728\u9057\u7559\u4ee3\u7801\u4e2d\u8c03\u7528\u9759\u6001\u5de5\u5382\u3002</p> <p>\u4e0b\u9762\u7684Bean\u5b9a\u4e49\u6307\u5b9a\u901a\u8fc7\u8c03\u7528\u5de5\u5382\u65b9\u6cd5\u6765\u521b\u5efaBean\u3002\u8be5\u5b9a\u4e49\u6ca1\u6709\u6307\u5b9a\u8fd4\u56de\u5bf9\u8c61\u7684\u7c7b\u578b\uff08\u7c7b\uff09\uff0c\u53ea\u6307\u5b9a\u4e86\u5305\u542b\u5de5\u5382\u65b9\u6cd5\u7684\u7c7b\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0ccreateInstance()\u65b9\u6cd5\u5fc5\u987b\u662f\u4e00\u4e2a\u9759\u6001\u65b9\u6cd5\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u6307\u5b9a\u5de5\u5382\u65b9\u6cd5\u3002</p> <pre><code>&lt;bean id=\"clientService\"\n    class=\"examples.ClientService\"\n    factory-method=\"createInstance\"/&gt;\n\n\npublic class ClientService {\n    private static ClientService clientService = new ClientService();\n    private ClientService() {}\n\n    public static ClientService createInstance() {\n        return clientService;\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#bean_2","title":"\u5b9e\u4f8b\u5de5\u5382\u65b9\u6cd5\u521b\u5efaBean","text":"<p>\u7c7b\u4f3c\u4e8e\u901a\u8fc7\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u8fdb\u884c\u5b9e\u4f8b\u5316\uff0c\u4f7f\u7528\u5b9e\u4f8b\u5de5\u5382\u65b9\u6cd5\u8fdb\u884c\u5b9e\u4f8b\u5316\u4f1a\u4ece\u5bb9\u5668\u4e2d\u8c03\u7528\u73b0\u6709bean\u7684\u975e\u9759\u6001\u65b9\u6cd5\u6765\u521b\u5efa\u65b0bean\u3002 \u8981\u4f7f\u7528\u6b64\u673a\u5236\uff0c\u8bf7\u5c06class\u5c5e\u6027\u4fdd\u7559\u4e3a\u7a7a\uff0c\u5e76\u5728factory-bean\u5c5e\u6027\u4e2d\uff0c\u5728\u5f53\u524d\uff08\u6216\u7236\u6216\u7956\u5148\uff09\u5bb9\u5668\u4e2d\u6307\u5b9a\u5305\u542b\u8981\u521b\u5efa\u8be5\u5bf9\u8c61\u7684\u5b9e\u4f8b\u65b9\u6cd5\u7684bean\u7684\u540d\u79f0\u3002 \u4f7f\u7528factory-method\u5c5e\u6027\u8bbe\u7f6e\u5de5\u5382\u65b9\u6cd5\u672c\u8eab\u7684\u540d\u79f0\u3002 \u4ee5\u4e0b\u793a\u4f8b\u663e\u793a\u4e86\u5982\u4f55\u914d\u7f6e\u6b64\u7c7bBean\uff1a</p> <pre><code>&lt;bean id=\"serviceLocator\" class=\"examples.DefaultServiceLocator\"&gt;\n    &lt;!-- inject any dependencies required by this locator bean --&gt;\n&lt;/bean&gt;\n\n&lt;bean id=\"clientService\"\n    factory-bean=\"serviceLocator\"\n    factory-method=\"createClientServiceInstance\"/&gt;\n\n&lt;bean id=\"accountService\"\n    factory-bean=\"serviceLocator\"\n    factory-method=\"createAccountServiceInstance\"/&gt;\n</code></pre> <pre><code>public class DefaultServiceLocator {\n\n    private static ClientService clientService = new ClientServiceImpl();\n\n    private static AccountService accountService = new AccountServiceImpl();\n\n    public ClientService createClientServiceInstance() {\n        return clientService;\n    }\n\n    public AccountService createAccountServiceInstance() {\n        return accountService;\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#bean_3","title":"\u786e\u5b9aBean\u7684\u8fd0\u884c\u65f6\u7c7b\u578b","text":"<p>The runtime type of a specific bean is non-trivial to determine. A specified class in the bean metadata definition is just an initial class reference, potentially combined with a declared factory method or being a <code>FactoryBean</code> class which may lead to a different runtime type of the bean, or not being set at all in case of an instance-level factory method (which is resolved via the specified <code>factory-bean</code> name instead). Additionally, AOP proxying may wrap a bean instance with an interface-based proxy with limited exposure of the target bean\u2019s actual type (just its implemented interfaces).</p> <p>The recommended way to find out about the actual runtime type of a particular bean is a <code>BeanFactory.getType</code> call for the specified bean name. This takes all of the above cases into account and returns the type of object that a <code>BeanFactory.getBean</code> call is going to return for the same bean name.</p> <p>\u786e\u5b9a\u7279\u5b9abean\u7684\u8fd0\u884c\u65f6\u7c7b\u578b\u5e76\u975e\u6613\u4e8b\u3002 Bean\u5143\u6570\u636e\u5b9a\u4e49\u4e2d\u7684\u6307\u5b9a\u7c7b\u53ea\u662f\u521d\u59cb\u7c7b\u5f15\u7528\uff0c\u53ef\u80fd\u4e0e\u58f0\u660e\u7684\u5de5\u5382\u65b9\u6cd5\u7ed3\u5408\u4f7f\u7528\uff0c\u6216\u8005\u662fFactoryBean\u7c7b\uff0c\u8fd9\u53ef\u80fd\u5bfc\u81f4Bean\u7684\u8fd0\u884c\u65f6\u7c7b\u578b\u4e0d\u540c\uff0c\u6216\u8005\u5728\u5b9e\u4f8b\u7684\u60c5\u51b5\u4e0b\u5b8c\u5168\u4e0d\u8fdb\u884c\u8bbe\u7f6e \u7ea7\u5de5\u5382\u65b9\u6cd5\uff08\u901a\u8fc7\u6307\u5b9a\u7684factory-bean\u540d\u79f0\u89e3\u6790\uff09\u3002 \u6b64\u5916\uff0cAOP\u4ee3\u7406\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8e\u63a5\u53e3\u7684\u4ee3\u7406\u5305\u88c5bean\u5b9e\u4f8b\uff0c\u800c\u76ee\u6807Bean\u7684\u5b9e\u9645\u7c7b\u578b\uff08\u4ec5\u662f\u5176\u5b9e\u73b0\u7684\u63a5\u53e3\uff09\u7684\u66b4\u9732\u7a0b\u5ea6\u6709\u9650\u3002</p> <p>\u627e\u51fa\u7279\u5b9abean\u7684\u5b9e\u9645\u8fd0\u884c\u65f6\u7c7b\u578b\u7684\u63a8\u8350\u65b9\u6cd5\u662f\u5bf9\u6307\u5b9abean\u540d\u79f0\u7684BeanFactory.getType\u8c03\u7528\u3002 \u8fd9\u8003\u8651\u4e86\u4e0a\u8ff0\u6240\u6709\u60c5\u51b5\uff0c\u5e76\u8fd4\u56de\u4e86\u9488\u5bf9\u76f8\u540cbean\u540d\u79f0\u7684BeanFactory.getBean\u8c03\u7528\u5c06\u8fd4\u56de\u7684\u5bf9\u8c61\u7684\u7c7b\u578b\u3002</p>"},{"location":"java/spring/spring/IocContainer/#bean_4","title":"\u9644\u5f55\uff1aBean \u7684\u751f\u547d\u5468\u671f","text":"<p>Spring\u7edf\u4e00\u7ba1\u7406Bean\u7684\u751f\u547d\u5468\u671f</p> <ol> <li>Bean\u7684\u5b9e\u4f8b\u5316\u4e0e\u5c5e\u6027\u6ce8\u5165</li> </ol> <p>\u5728\u7b2c\u4e00\u6b21\u8c03\u7528getBean()\u65f6\u751f\u6210Bean\u7684\u5b9e\u4f8b\uff0c\u901a\u5e38\u901a\u8fc7\u53cd\u5c04\u6216\u8005CGLIB\u52a8\u6001\u5b57\u8282\u7801\u6765\u751f\u6210Bean\u5b9e\u4f8b\u6216\u5b50\u7c7b\u3002\u4f46\u662f\u5e76\u4e0d\u662f\u76f4\u63a5\u8fd4\u56de\u6784\u9020\u5b8c\u6210\u7684\u5bf9\u8c61\u5b9e\u4f8b\uff0c\u800c\u662f\u8fdb\u884c\u5305\u88f9\u8fd4\u56de\u76f8\u5e94\u7684BeanWrapper\u5b9e\u4f8b\uff0c\u8fd9\u6837\u7684\u597d\u5904\u662f\u53ef\u4ee5\u5728\u63a5\u4e0b\u6765\u975e\u5e38\u65b9\u4fbf\u7684\u8bbe\u7f6e\u5bf9\u8c61\u7684\u5c5e\u6027\uff08\u4e0d\u7136\u5982\u679c\u76f4\u63a5\u8fd4\u56de\u5b9e\u4f8b\u5bf9\u8c61\uff0c\u90a3\u4e48\u4f60\u8981\u901a\u8fc7\u53cd\u5c04\u7684API\u624d\u80fd\u53bb\u589e\u52a0\u5bf9\u8c61\u7684\u5c5e\u6027\uff0c\u5f88\u9ebb\u70e6\uff09\uff0c\u800c\u4e14BeanWrapper\u7ee7\u627f\u4e86PropertyAccessor\u63a5\u53e3\u53ef\u4ee5\u65b9\u4fbf\u7684\u83b7\u53d6\u5bf9\u8c61\u5c5e\u6027\uff0c\u4e5f\u7ee7\u627f\u4e86PropertyEditorRegister\u548cTypeConverter\u63a5\u53e3\uff0c\u53ef\u4ee5\u65b9\u4fbf\u8f6c\u6362\u5c5e\u6027\u7c7b\u578b\u3002</p> <ol> <li> <p>\u68c0\u67e5\u8bbe\u7f6eAware\u63a5\u53e3</p> </li> <li> <p>BeanPostprocessor\u7684before\u548cafter\u65b9\u6cd5,\u548c\u4e2d\u95f4\u7684InitializingBean\u548cinit-method\u65b9\u6cd5</p> </li> <li> <p>\u68c0\u67e5Singleton\u7684Bean\u5b9e\u4f8b\uff0c\u662f\u5426\u5b9e\u73b0\u4e86DisposableBean\u63a5\u53e3\uff0c\u6ce8\u518c\u5bf9\u8c61\u9500\u6bc1\u65f6\u7684\u56de\u8c03\u3002\u4e00\u822c\u662f\u5728Spring\u5bb9\u5668\u5173\u95ed\u7684\u65f6\u5019\u8c03\u7528Bean\u7684\u9500\u6bc1\u65b9\u6cd5\uff0c\u4f46\u662f\u597d\u50cf\u8981\u624b\u52a8\u8c03\u7528applicationcontext.destroySingleton()\u624d\u884c\u3002</p> </li> </ol> <p>\u4e0b\u9762\u662f\u6309\u65b9\u6cd5\u6267\u884c\u7684\u524d\u540e\u987a\u5e8f\u6392\u5217</p> <ul> <li> <p>BeanDefinitionRegistryPostProcessor</p> <p>\u7ee7\u627fBeanFactoryPostProcessor\uff0c\u5728\u8fd0\u884cBeanFactoryPostProcessor\u4e4b\u524d\u5141\u8bb8\u66f4\u591a\u7684bean definitions\u6ce8\u518c\u3002\u7279\u522b\u7684\uff0c\u8fd9\u4e2a\u7c7b\u53ef\u4ee5\u6ce8\u518c\u66f4\u591a\u7684bean definitions\uff0c\u751a\u81f3\u5305\u62ecBeanFactoryPostProcessor\u7684\u5b9e\u4f8b</p> <p>\u5982Apollo\u91ccDefaultConfigPropertySourcesProcessorHelper\u5c31\u5229\u7528BeanDefinitionRegistryPostProcessor\uff0c\u5411\u5bb9\u5668\u4e2d\u6ce8\u518c\u4e86\u591a\u4e2a\u7528\u4e8eProcessor\u7684Bean\u3002</p> </li> <li> <p>BeanFactoryPostProcessor.postProcessBeanFactory()</p> <p>\u7528\u6765\u5728\u6240\u6709\u7684bean definitions\u52a0\u8f7d\u540e\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u5b9e\u4f8b\u5316bean\u4e4b\u524d\u8c03\u7528\u672c\u65b9\u6cd5 \u53ef\u4ee5\u4fee\u6539bean\u7684\u5b9a\u4e49\uff0c\u5982\u662f\u5426\u662f\u5355\u4f8b\uff0c\u662f\u5426lazy init\uff0cDependsOn\uff0cFactoryBeanName\u7b49\u7b49\u7b49\u7b49\uff0c\u4e00\u822c\u7528\u6765\u4fee\u6539\u5c5e\u6027\u503c\uff0c\u4e00\u4e2a\u5178\u578b\u7684\u5b9e\u73b0\u662fPropertyResourceConfigurer\uff0c\u7528\u6765\u4ece\u914d\u7f6e\u6587\u4ef6\u91cc\u52a0\u8f7d\u5c5e\u6027\u653e\u8fdbbean\u91cc\uff0c\u6216\u8005\u66f4\u6362${...}placeHolder</p> <p>\u5982Apollo\u91ccPropertySourcesProcessor\u5229\u7528BeanFactoryPostProcessor\uff0c\u5c06config\u5305\u88c5\u6210ConfigPropertySource\u6dfb\u52a0\u5230Spring\u4e2d\u3002</p> </li> <li> <p>bean\u7684\u6784\u9020\u65b9\u6cd5</p> </li> <li> <p>BeanPostProcessor.postProcessBeforeInitialization()</p> <p>\u5728bean\u8fdb\u884c\u521d\u59cb\u5316\u65b9\u6cd5\uff08\u5982InitializingBean.afterPropertiesSet\u6216\u8005\u81ea\u5b9a\u4e49\u7684init\u65b9\u6cd5@PostConstruct\uff09\u7684\u56de\u8c03\u4e4b\u524d\u8c03\u7528 \u8c03\u7528\u6b64\u65b9\u6cd5\u65f6\uff0cbean\u7684\u5c5e\u6027\u503c\u5df2\u7ecf\u8bbe\u7f6e\u597d \u53ef\u4ee5\u8fd4\u56de\u4e00\u4e2a\u5305\u88c5\u7c7b</p> </li> <li> <p>@PostConstruct</p> <p>\u7528\u6765\u6807\u6ce8\u5728bean\u7684\u65b9\u6cd5\u4e0a\uff0c\u5728\u4f9d\u8d56\u6ce8\u5165\u540e\uff0c\u653e\u5165spring\u5bb9\u5668\u524d\u6267\u884c\u4e00\u4e9binit\u903b\u8f91\uff08init\u65b9\u6cd5\u4e2d\u53ef\u4ee5\u4f7f\u7528\u4f9d\u8d56\u5c5e\u6027\uff09\u3002\u4e00\u4e2abean\u4e2d\u53ea\u80fd\u6709\u4e00\u4e2a@PostConstruct \u7136\u540e\u6ce8\u610f\uff0c\u8fd9\u662fjava\u89c4\u5b9a\u7684\u6ce8\u89e3\uff01\uff01 \u5982\u679c\u5728\u62e6\u622a\u5668\u4e2d,\uff08\u6ca1\u89c1\u8fc7\u8fd9\u4e2a\u7528\u6cd5\uff0c\u4e0d\u592a\u61c2\uff09 \u5fc5\u987b\u6709InvocationContext\u65b9\u6cd5\u53c2\u6570\uff0c\u53ef\u4ee5\u6709Object\u8fd4\u56de\u503c \u5982\u679c\u4e0d\u662f\u5728\u62e6\u622a\u5668\u7c7b\u4e2d\uff1a \u4e0d\u80fd\u6709\u8fd4\u56de\u503c\u548c\u65b9\u6cd5\u53c2\u6570 \u6807\u6ce8\u7684\u65b9\u6cd5\u53ef\u4ee5\u662fpublic, protected,package private or private \u53ef\u4ee5\u662ffinal\u7684 \u4e0d\u80fd\u629b\u51fa\u8fd0\u884c\u65f6\u5f02\u5e38\uff0c\u4f1a\u5bfc\u81f4\u5bb9\u5668\u542f\u52a8\u5931\u8d25</p> </li> <li> <p>InitializingBean.afterPropertiesSet()</p> <p>\u7528\u6765BeanFactory\u5c06bean\u7684\u6240\u6709\u5c5e\u6027\u90fd\u8bbe\u7f6e\u540e\uff0c\u6267\u884c\u4e00\u4e9binit\u903b\u8f91\u6216\u8005\u53ea\u662fcheck\u5c5e\u6027\u662f\u5426\u6b63\u786e\u548c\u7f3a\u5931\u3002</p> </li> <li> <p>BeanPostProcessor.postProcessAfterInitialization()</p> <p>\u5728bean\u8fdb\u884c\u521d\u59cb\u5316\u65b9\u6cd5\uff08\u5982InitializingBean.afterPropertiesSet\u6216\u8005\u81ea\u5b9a\u4e49\u7684init\u65b9\u6cd5@PostConstruct\uff09\u7684\u56de\u8c03\u4e4b\u540e\u8c03\u7528 \u8c03\u7528\u6b64\u65b9\u6cd5\u65f6\uff0cbean\u7684\u5c5e\u6027\u503c\u5df2\u7ecf\u8bbe\u7f6e\u597d \u53ef\u4ee5\u8fd4\u56de\u4e00\u4e2a\u5305\u88c5\u7c7b \u53ef\u80fd\u88ab\u591a\u6b21\u8c03\u7528</p> </li> <li> <p>SmartInitializingSingleton</p> <p>\u8fd9\u4e2a\u63a5\u53e3\u53ef\u4ee5\u88ab\u4e00\u4e2a\u5355\u4f8b\u7684bean\u5b9e\u73b0\uff0c\u5728BeanFactory\u5b9e\u4f8b\u5316\u6240\u6709\u5355\u4f8bbean\u4e4b\u540e\u6267\u884c\u3002 \u4e00\u822c\u7528\u6765\u6267\u884c\u4e00\u4e9binit\u903b\u8f91\uff0c\u5728\u60f3\u8981\u6025\u5207\u83b7\u53d6\u5176\u4ed6bean\u65f6\u53ef\u4ee5\u7528\u6765\u66ff\u6362InitializingBean.afterPropertiesSet()\u7684\u65b9\u6848</p> </li> <li> <p>SmartLifecycle.start()</p> <p>Lifecycle\u63a5\u53e3\u7684\u6269\u5c55\uff0c\u7528\u6765\u5b9e\u73b0\u60f3\u5728\u5bb9\u5668\u542f\u52a8\u5237\u65b0\uff0c\u6216\u8005shutdown\u65f6\u6267\u884c\u4e00\u4e9b\u903b\u8f91\u3002 isAutoStartup()\u7528\u6765\u8868\u793a\u5728\u5bb9\u5668\u5237\u65b0\u65f6\u8fd9\u4e2abean\u662f\u5426\u542f\u52a8\uff0c\u5426\u5219\u53ea\u6709\u5bb9\u5668start\u65f6\u91cd\u65b0\u521b\u5efa stop(Runnable)\u7528\u4e8e\u9700\u8981\u5f02\u6b65\u7684\u5173\u95ed\u903b\u8f91\uff0c\u5fc5\u987b\u8981\u8c03\u7528callback.run() Phased\u7528\u4e8e\u63a7\u5236\u591a\u4e2abean\u7684\u542f\u52a8\u987a\u5e8f\uff0cvalue\u8f83\u5c0f\u7684\u4f1a\u5148\u542f\u52a8\uff0cshutdown\u65f6\u4f1a\u540e\u5173\u95ed\u3002 \u5982ComponentB\u4f9d\u8d56componentA\u5148\u542f\u52a8\uff0c\u5219componentA.phase()\u5e94\u8be5\u8fd4\u56de\u4e00\u4e2a\u8f83\u5c0f\u7684\u503c\uff0c\u5173\u95ed\u65f6B\u4f1a\u5148\u5173\u95ed\u3002 \u5982\u679c\u660e\u786e\u6307\u5b9adepends-on\uff0c\u4ee5depends-on\u4e3a\u51c6\u3002 \u4efb\u4f55\u6ca1\u6709\u5b9e\u73b0SmartLifecycle\u7684bean\u7684phase\u4f1a\u662f0\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u5982\u679cSmartLifecycle Bean\u7684phase\u8fd4\u56de\u8d1f\u6570\uff0c\u5c06\u4f18\u5148\u4e8e\u6240\u6709\u7684\u5bb9\u5668bean\u542f\u52a8\uff0c\u6b63\u6570\u53cd\u4e4b\u3002 SmartLifecycle\u7684DEFAULT_PHASE = Integer.MAX_VALUE;</p> </li> </ul>"},{"location":"java/spring/spring/IocContainer/#16-bean","title":"1.6 \u81ea\u5b9a\u4e49Bean\u7684\u6027\u8d28","text":""},{"location":"java/spring/spring/IocContainer/#162-applicationcontextaware-beannameaware","title":"1.6.2  <code>ApplicationContextAware</code> \u548c<code>BeanNameAware</code>","text":"<p>\u5f53ApplicationContext\u521b\u5efa\u4e00\u4e2a\u5b9e\u73b0org.springframework.context.ApplicationContextAware\u63a5\u53e3\u7684\u5bf9\u8c61\u5b9e\u4f8b\u65f6\uff0c\u8be5\u5b9e\u4f8b\u4f1a\u88ab\u63d0\u4f9b\u4e00\u4e2a\u5bf9\u8be5ApplicationContext\u7684\u5f15\u7528\u3002 <code>ApplicationContextAware</code> \u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>public interface ApplicationContextAware {\n\n    void setApplicationContext(ApplicationContext applicationContext) throws BeansException;\n}\n</code></pre> <p>\u56e0\u6b64\uff0cBean\u53ef\u4ee5\u83b7\u53d6<code>ApplicationContext</code> \uff0c\u6216\u8005\u662f\u5b50\u7c7b<code>ConfigurableApplicationContext</code>\uff08\u4ed6\u66b4\u9732\u4e86\u989d\u5916\u7684\u529f\u80fd\uff09\uff0c\u8fdb\u884c\u7f16\u7a0b\u64cd\u4f5c\u3002\u4e00\u4e2a\u7528\u9014\u662f\u68c0\u7d22\u5176\u4ed6Bean\u3002\u6709\u65f6\u8fd9\u4e9b\u529f\u80fd\u662f\u6709\u7528\u7684\uff0c\u7136\u800c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u5c3d\u91cf\u907f\u514d\u4f7f\u7528\u5b83\uff0c\u56e0\u4e3a\u5b83\u5c06\u4ee3\u7801\u8026\u5408\u5230Spring\uff0c\u800c\u4e14\u4e5f\u4e0d\u9075\u5b88\u53cd\u8f6c\u63a7\u5236\u7684\u98ce\u683c\uff0c\u5e94\u8be5\u662f\u4f9d\u8d56\u4f5c\u4e3a\u5c5e\u6027\u63d0\u4f9b\u7ed9Bean\u3002<code>ApplicationContext</code>\u7684\u5176\u4ed6\u65b9\u6cd5\u63d0\u4f9b\u4e86\u5bf9\u6587\u4ef6\u8d44\u6e90\u7684\u8bbf\u95ee\uff0c\u53d1\u5e03event\u548c\u8bbf\u95eeMessageSource\u3002\u8fd9\u4e9b\u9644\u52a0\u529f\u80fd\u4ecb\u7ecd\u8be6\u89c1Additional Capabilities of the <code>ApplicationContext</code>\u3002</p> <p>\u81ea\u52a8\u6ce8\u5165\u662f\u83b7\u53d6<code>ApplicationContext</code>\u7684\u53e6\u4e00\u79cd\u9009\u62e9\u3002\u4f20\u7edf\u7684\u6784\u9020\u548c\u6309\u7c7b\u578b\u6ce8\u5165\u53ef\u4ee5\u63d0\u4f9b\u7684<code>ApplicationContext</code>\u7684\u4f9d\u8d56\u3002\u4e3a\u4e86\u83b7\u5f97\u66f4\u591a\u7684\u7075\u6d3b\u6027\uff0c\u5305\u542b\u81ea\u52a8\u6ce8\u5165\u5b57\u6bb5\u548c\u591a\u4e2a\u53c2\u6570\u7684\u65b9\u6cd5\u7684\u80fd\u529b\uff0c\u8bf7\u4f7f\u7528\u57fa\u4e8e\u6ce8\u89e3\u7684\u81ea\u52a8\u6ce8\u5165\u7279\u6027\u3002\u5982\u679c\u60a8\u8fd9\u6837\u505a\uff0c<code>ApplicationContext</code>\u4f1a\u81ea\u52a8\u88c5\u914d\u5230\u5b57\u6bb5\uff0c\u6784\u9020\u53c2\u6570\u6216\u8005\u65b9\u6cd5\u4e2d\u3002</p> <p>\u4e3e\u4f8b\uff1a</p> <pre><code>@Component\n@Slf4j\npublic class SpringUtil implements ApplicationContextAware {\n\n    private static ApplicationContext context;\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        if(context == null){\n            context = applicationContext;\n        }\n    }\n\n    public static ApplicationContext getApplicationContext(){\n        return context;\n    }\n\n    public static &lt;T&gt; T getBean(String name) {\n        if (context == null){\n            throw new IllegalStateException(\"applicaitonContext un inject\");\n        }\n        try {\n            return (T)context.getBean(name);\n        } catch (BeansException e) {\n            log.error(\" get Bean error\",e);\n        }\n        return null;\n    }\n\n    public static &lt;T&gt; T getBeanByClass(Class className){\n        if (context == null){\n            throw new IllegalStateException(\"applicaitonContext un inject\");\n        }\n        try {\n            return (T)context.getBean(className);\n        } catch (BeansException e) {\n            log.error(\"get Bean by className error\",e);\n        }\n        return null;\n    }\n    /**\n    * @description  \u53d1\u5e03event\n    */\n    public static void publishEvent(ApplicationEvent event){\n        getApplicationContext().publishEvent(event);\n    }\n\n}\n</code></pre> <p>\u5f53<code>ApplicationContext</code> \u521b\u5efa\u4e00\u4e2a\u5b9e\u73b0<code>org.springframework.beans.factory.BeanNameAware</code> \u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\u65f6\uff0c\u8be5\u7c7b\u4f1a\u63d0\u4f9b\u4e00\u4e2aname\u5b9a\u4e49\u5173\u8054\u7684\u5bf9\u8c61\uff0c\u4e0b\u9762\u662f<code>BeanNameAware</code> \u7684\u5b9a\u4e49</p> <pre><code>public interface BeanNameAware {\n\n    void setBeanName(String name) throws BeansException;\n}\n</code></pre> <p>The callback is invoked after population of normal bean properties but before an initialization callback such as <code>InitializingBean</code>, <code>afterPropertiesSet</code>, or a custom init-method.</p> <p>\u8fd9\u4e2a\u63a5\u53e3\u7684\u56de\u8c03\u5728bean\u5c5e\u6027\u751f\u6210\u4e4b\u540e\uff0c\u4f46\u662f\u5728\u521d\u59cb\u5316\u65b9\u6cd5\uff08 <code>InitializingBean</code>.<code>afterPropertiesSet</code>, \u6216\u8005\u81ea\u5b9a\u4e49\u7684init-method\uff09\u56de\u8c03\u4e4b\u524d\u3002</p>"},{"location":"java/spring/spring/IocContainer/#163-aware","title":"1.6.3 \u5176\u4ed6Aware\u63a5\u53e3","text":"<p>\u9664\u4e86\u4e4b\u524d\u8ba8\u8bba\u7684 <code>ApplicationContextAware</code> \u548c<code>BeanNameAware</code> \uff0cSpring\u8fd8\u63d0\u4f9b\u4e86\u5f88\u591a\u5176\u4ed6Aware\u56de\u8c03\u63a5\u53e3\uff0c\u8ba9Bean\u5411\u5bb9\u5668\u8868\u660e\u4ed6\u4eec\u9700\u8981\u67d0\u4e2a\u57fa\u7840\u4f9d\u8d56\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\uff0cname\u8868\u793a\u4f9d\u8d56\u7c7b\u578b\uff0c\u4e0b\u9762\u5c55\u793a\u4e00\u4e9b\u6700\u91cd\u8981\u7684Aware\u63a5\u53e3\uff1a</p> Name Injected Dependency\u4f1a\u6ce8\u5165\u7684\u4f9d\u8d56 Explained in\u2026 <code>ApplicationContextAware</code> \u6ce8\u5165<code>ApplicationContext</code>\uff0c\u6700\u5e38\u7528\u548c\u6700\u5168\u9762\u7684 <code>ApplicationContextAware</code> and <code>BeanNameAware</code> <code>ApplicationEventPublisherAware</code> \u6ce8\u5165<code>ApplicationEventPublisher</code>\u7528\u4e8eevent\u53d1\u5e03 Additional Capabilities of the <code>ApplicationContext</code> <code>MessageSourceAware</code> \u6ce8\u5165\u7528\u4e8e\u914d\u7f6e\u56fd\u9645\u5316\u7684<code>MessageSource</code>\u3002Configured strategy for resolving messages (with support for parametrization and internationalization). Additional Capabilities of the <code>ApplicationContext</code> <code>ResourceLoaderAware</code> \u83b7\u53d6Resource\u3002Configured loader for low-level access to resources. Resources <p>\u4e0a\u9762\u662fapplicationContext\u7279\u6709\u7684aware\u63a5\u53e3\uff0c\u4e5f\u4f1a\u66f4\u53ef\u80fd\u7528\u5230\u3002</p> Name Injected Dependency Explained in\u2026 <code>BeanClassLoaderAware</code> Class loader used to load the bean classes. Instantiating Beans <code>BeanFactoryAware</code> Declaring <code>BeanFactory</code>. <code>ApplicationContextAware</code> and <code>BeanNameAware</code> <code>BeanNameAware</code> Name of the declaring bean. <code>ApplicationContextAware</code> and <code>BeanNameAware</code> <code>LoadTimeWeaverAware</code> Defined weaver for processing class definition at load time. Load-time Weaving with AspectJ in the Spring Framework <code>NotificationPublisherAware</code> Spring JMX notification publisher. Notifications <code>ServletConfigAware</code> Current <code>ServletConfig</code> the container runs in. Valid only in a web-aware Spring <code>ApplicationContext</code>. Spring MVC <code>ServletContextAware</code> Current <code>ServletContext</code> the container runs in. Valid only in a web-aware Spring <code>ApplicationContext</code>. Spring MVC <p>\u8bf7\u518d\u6b21\u6ce8\u610f\uff0c\u4f7f\u7528\u8fd9\u4e9b\u63a5\u53e3\u4f1a\u5c06\u60a8\u7684\u4ee3\u7801\u548cSpring API\u8026\u5408\uff0c\u5e76\u4e14\u8fdd\u53cdIOC\u98ce\u683c\u3002\u56e0\u6b64\uff0c\u5efa\u8bae\u5c06\u4ed6\u4eec\u7528\u4e8e\u9700\u8981\u5bf9\u5bb9\u5668\u8fdb\u884c\u7f16\u7a0b\u8bbf\u95ee\u7684\u57fa\u7840Bean\u3002</p>"},{"location":"java/spring/spring/IocContainer/#18","title":"1.8 \u5bb9\u5668\u6269\u5c55\u70b9","text":"<p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u5e94\u7528\u5f00\u53d1\u8005\u4e0d\u9700\u8981\u5b9e\u73b0ApplicationContext\u3002\u76f8\u53cd\uff0c\u53ef\u4ee5\u901a\u8fc7\u63d2\u5165\u7279\u6b8a\u96c6\u6210\u63a5\u53e3\u7684\u5b9e\u73b0\u6765\u6269\u5c55Spring IoC\u5bb9\u5668\u3002\u63a5\u4e0b\u6765\u7684\u51e0\u8282\u5c06\u4ecb\u7ecd\u8fd9\u4e9b\u96c6\u6210\u63a5\u53e3\u3002</p>"},{"location":"java/spring/spring/IocContainer/#181-beanpostprocessorbean","title":"1.8.1 \u4f7f\u7528<code>BeanPostProcessor</code>\u81ea\u5b9a\u4e49Bean","text":"<p><code>BeanPostProcessor</code>\u63a5\u53e3\u5b9a\u4e49\u4e86\u56de\u8c03\u65b9\u6cd5\uff0c\u4f60\u53ef\u4ee5\u636e\u6b64\u6765\u63d0\u4f9b\u81ea\u5df1\u7684\uff08\u6216\u8005\u8986\u76d6\u5bb9\u5668\u7684\uff09\u5b9e\u4f8b\u5316\u903b\u8f91\uff0c\u4f9d\u8d56\u89e3\u6790\u7b49\u3002\u5982\u679c\u4f60\u60f3\u8981\u5728Spring\u5bb9\u5668\u5b8c\u6210\u5b9e\u4f8b\u5316\u3001\u914d\u7f6e\u548c\u521d\u59cb\u5316Bean\u4e4b\u540e\u5b9e\u73b0\u4e00\u4e9b\u81ea\u5b9a\u4e49\u903b\u8f91\uff0c\u4f60\u53ef\u4ee5\u63d2\u5165\u4e00\u4e2a\u6216\u591a\u4e2a\u81ea\u5b9a\u4e49\u7684 <code>BeanPostProcessor</code>\u5b9e\u73b0\u3002</p> <p>\u5982Apollo\u6e90\u7801\u91cc\uff0c\u5b9e\u73b0\u4e86BeanPostProcessor\u63a5\u53e3\uff0c\u89e3\u6790\u6bcf\u4e2aBean\u4e2d@Value\u7684\u5b57\u6bb5\u4e3aSpringValue\u5bf9\u8c61\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u66f4\u65b0\u540e\u53cd\u5c04\u66f4\u65b0\u5176\u503c\u3002</p> <p>\u60a8\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a <code>BeanPostProcessor</code>\u5b9e\u73b0\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6eOrder\u5c5e\u6027\u6765\u63a7\u5236\u8fd9\u4e9b\u5b9e\u73b0\u7684\u6267\u884c\u987a\u5e8f\u3002\u53ea\u6709\u5f53 <code>BeanPostProcessor</code>\u5b9e\u73b0\u4e86Order\u63a5\u53e3\uff0c\u624d\u53ef\u4ee5\u8bbe\u7f6e\u8fd9\u4e2a\u5c5e\u6027\u3002\u5982\u679c\u4f60\u5199\u4e86\u81ea\u5df1\u7684 <code>BeanPostProcessor</code>\uff0c\u5e94\u8be5\u8003\u8651\u5b9e\u73b0Order\u63a5\u53e3\u3002</p> <p><code>BeanPostProcessor</code> instances operate on bean (or object) instances. That is, the Spring IoC container instantiates a bean instance and then <code>BeanPostProcessor</code> instances do their work.</p> <p>To change the actual bean definition (that is, the blueprint that defines the bean), you instead need to use a <code>BeanFactoryPostProcessor</code>, as described in Customizing Configuration Metadata with a <code>BeanFactoryPostProcessor</code>.</p> <p><code>BeanPostProcessor</code> \u64cd\u4f5c\u4e00\u4e2abean\u7684\u5b9e\u4f8b\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cSpring IOC\u5bb9\u5668\u662f\u5148\u5b9e\u4f8b\u5316\u4e00\u4e2aBean\uff0c\u7136\u540e<code>BeanPostProcessor</code> \u624d\u4f1a\u8fdb\u884c\u4ed6\u4eec\u7684\u5de5\u4f5c\u3002</p> <p><code>BeanPostProcessor</code> \u5b9e\u4f8b\u7684\u4f5c\u7528\u4e8e\u662f\u5bb9\u5668\u7ea7\u522b\u7684\u3002\u8fd9\u53ea\u6709\u4f7f\u7528\u5bb9\u5668\u5c42\u7ea7\u7ed3\u6784\u6709\u5173\u3002\u5982\u679c\u4f60\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2aBeanPostProcessor\uff0c\u5b83\u53ea\u5bf9\u8be5\u5bb9\u5668\u4e2d\u7684bean\u8fdb\u884c\u540e\u5904\u7406\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u5b9a\u4e49\u7684 bean \u4e0d\u4f1a\u88ab\u53e6\u4e00\u4e2a\u5bb9\u5668\u4e2d\u5b9a\u4e49\u7684 BeanPostProcessor \u540e\u5904\u7406\uff0c\u5373\u4f7f\u8fd9\u4e24\u4e2a\u5bb9\u5668\u662f\u540c\u4e00\u5c42\u6b21\u7ed3\u6784\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u8981\u66f4\u6539\u5b9e\u9645\u7684 bean \u5b9a\u4e49\uff08\u5373\u5b9a\u4e49 bean \u7684\u84dd\u56fe\uff09\uff0c\u5219\u9700\u8981\u4f7f\u7528 BeanFactoryPostProcessor\u3002</p> <p>The <code>org.springframework.beans.factory.config.BeanPostProcessor</code> interface consists of exactly two callback methods. When such a class is registered as a post-processor with the container, for each bean instance that is created by the container, the post-processor gets a callback from the container both before container initialization methods (such as <code>InitializingBean.afterPropertiesSet()</code> or any declared <code>init</code> method) are called, and after any bean initialization callbacks. The post-processor can take any action with the bean instance, including ignoring the callback completely. A bean post-processor typically checks for callback interfaces, or it may wrap a bean with a proxy. Some Spring AOP infrastructure classes are implemented as bean post-processors in order to provide proxy-wrapping logic.</p> <p><code>org.springframework.beans.factory.config.BeanPostProcessor</code>\u63a5\u53e3\u6b63\u597d\u7531\u4e24\u4e2a\u56de\u8c03\u65b9\u6cd5\u7ec4\u6210\u3002\u5f53\u8fd9\u6837\u7684\u7c7b\u88ab\u5bb9\u5668\u6ce8\u518c\u4e3a\u540e\u5904\u7406\u5668\u65f6\uff0c\u5bf9\u4e8e\u5bb9\u5668\u521b\u5efa\u7684\u6bcf\u4e00\u4e2a bean \u5b9e\u4f8b\uff0c\u540e\u5904\u7406\u5668\u90fd\u4f1a\u5728\u5bb9\u5668\u521d\u59cb\u5316\u65b9\u6cd5\uff08\u5982 <code>InitializingBean.afterPropertiesSet()</code>\u6216\u4efb\u4f55\u58f0\u660e\u7684 init \u65b9\u6cd5\uff09\u88ab\u8c03\u7528\u4e4b\u524d\uff0c\u4ee5\u53ca\u5728\u4efb\u4f55 bean \u521d\u59cb\u5316\u56de\u8c03\u4e4b\u540e\uff0c\u4ece\u5bb9\u5668\u83b7\u5f97\u4e00\u4e2a\u56de\u8c03\u3002\u540e\u5904\u7406\u5668\u53ef\u4ee5\u5bf9bean\u5b9e\u4f8b\u91c7\u53d6\u4efb\u4f55\u64cd\u4f5c\uff0c\u5305\u62ec\u5b8c\u5168\u5ffd\u7565\u56de\u8c03\u3002bean\u540e\u5904\u7406\u5668\u901a\u5e38\u4f1a\u68c0\u67e5\u56de\u8c03\u63a5\u53e3\uff0c\u6216\u8005\u5b83\u53ef\u80fd\u4f1a\u7528\u4ee3\u7406\u7c7b\u5305\u88c5\u4e00\u4e2abean\u3002\u4e00\u4e9bSpring AOP\u57fa\u7840\u67b6\u6784\u7c7b\u5c31\u662f\u4f5c\u4e3abean\u540e\u5904\u7406\u5668\u7684\u5b9e\u73b0\uff0c\u4ee5\u63d0\u4f9b\u4ee3\u7406\u5c01\u88c5\u903b\u8f91\u3002\u4e5f\u5c31\u662fSpring AOP\u57fa\u4e8e\u6b64\u5b9e\u73b0\u7684\uff1f\uff01</p> <p>ApplicationContext \u4f1a\u81ea\u52a8\u68c0\u6d4b\u914d\u7f6e\u5143\u6570\u636e\u4e2d\u5b9a\u4e49\u7684\u5b9e\u73b0 BeanPostProcessor \u63a5\u53e3\u7684\u4efb\u4f55 Bean\u3002ApplicationContext \u5c06\u8fd9\u4e9b Bean \u6ce8\u518c\u4e3a\u540e\u5904\u7406\u5668\uff0c\u4ee5\u4fbf\u5b83\u4eec\u53ef\u4ee5\u5728\u4ee5\u540e\u521b\u5efa Bean \u65f6\u88ab\u8c03\u7528\u3002Bean \u540e\u5904\u7406\u5668\u53ef\u4ee5\u50cf\u5176\u4ed6 Bean \u4e00\u6837\u90e8\u7f72\u5728\u5bb9\u5668\u4e2d\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u914d\u7f6e\u7c7b\u4e0a\u4f7f\u7528@Bean\u5de5\u5382\u65b9\u6cd5\u58f0\u660eBeanPostProcessor\u65f6\uff0c\u5de5\u5382\u65b9\u6cd5\u7684\u8fd4\u56de\u7c7b\u578b\u5e94\u8be5\u662f\u5b9e\u73b0\u7c7b\u672c\u8eab\uff0c\u6216\u8005\u81f3\u5c11\u662f<code>org.springframework.beans.factory.config.BeanPostProcessor</code>\u63a5\u53e3\uff0c\u660e\u786e\u6307\u51fa\u8be5Bean\u7684\u540e\u5904\u7406\u6027\u8d28\u3002\u5426\u5219\uff0cApplicationContext\u5728\u5b8c\u5168\u521b\u5efa\u5b83\u4e4b\u524d\uff0c\u65e0\u6cd5\u6309\u7c7b\u578b\u81ea\u52a8\u68c0\u6d4b\u5b83\u3002\u7531\u4e8eBeanPostProcessor\u9700\u8981\u5c3d\u65e9\u5b9e\u4f8b\u5316\uff0c\u624d\u80fd\u5e94\u7528\u4e8e\u4e0a\u4e0b\u6587\u4e2d\u5176\u4ed6Bean\u7684\u521d\u59cb\u5316\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65e9\u671f\u7684\u7c7b\u578b\u68c0\u6d4b\u975e\u5e38\u5173\u952e\u3002</p> <p><code>BeanPostProcessor</code> instances and AOP auto-proxying</p> <p>Classes that implement the <code>BeanPostProcessor</code> interface are special and are treated differently by the container. All <code>BeanPostProcessor</code> instances and beans that they directly reference are instantiated on startup, as part of the special startup phase of the <code>ApplicationContext</code>. Next, all <code>BeanPostProcessor</code> instances are registered in a sorted fashion and applied to all further beans in the container. Because AOP auto-proxying is implemented as a <code>BeanPostProcessor</code> itself, neither <code>BeanPostProcessor</code> instances nor the beans they directly reference are eligible for auto-proxying and, thus, do not have aspects woven into them.</p> <p>For any such bean, you should see an informational log message: <code>Bean someBean is not eligible for getting processed by all BeanPostProcessor interfaces (for example: not eligible for auto-proxying)</code>.</p> <p>If you have beans wired into your <code>BeanPostProcessor</code> by using autowiring or <code>@Resource</code> (which may fall back to autowiring), Spring might access unexpected beans when searching for type-matching dependency candidates and, therefore, make them ineligible for auto-proxying or other kinds of bean post-processing. For example, if you have a dependency annotated with <code>@Resource</code> where the field or setter name does not directly correspond to the declared name of a bean and no name attribute is used, Spring accesses other beans for matching them by type.</p> <p>\u5b9e\u73b0BeanPostProcessor\u63a5\u53e3\u7684\u7c7b\u662f\u7279\u6b8a\u7684\uff0c\u88ab\u5bb9\u5668\u533a\u522b\u5bf9\u5f85\u3002\u6240\u6709BeanPostProcessor\u5b9e\u4f8b\u548c\u5b83\u4eec\u76f4\u63a5\u5f15\u7528\u7684bean\u90fd\u5728\u542f\u52a8\u65f6\u88ab\u5b9e\u4f8b\u5316\uff0c\u4f5c\u4e3aApplicationContext\u7684\u7279\u6b8a\u542f\u52a8\u9636\u6bb5\u7684\u4e00\u90e8\u5206\u3002\u63a5\u4e0b\u6765\uff0c\u6240\u6709BeanPostProcessor\u5b9e\u4f8b\u90fd\u4f1a\u4ee5\u6392\u5e8f\u7684\u65b9\u5f0f\u6ce8\u518c\uff0c\u5e76\u5e94\u7528\u5230\u5bb9\u5668\u4e2d\u6240\u6709\u8fdb\u4e00\u6b65\u7684bean\u3002\u7531\u4e8eAOP\u81ea\u52a8\u4ee3\u7406\u662f\u4f5c\u4e3aBeanPostProcessor\u672c\u8eab\u6765\u5b9e\u73b0\u7684\uff0c\u6240\u4ee5BeanPostProcessor\u5b9e\u4f8b\u548c\u5b83\u4eec\u76f4\u63a5\u5f15\u7528\u7684bean\u90fd\u6ca1\u6709\u8d44\u683c\u8fdb\u884c\u81ea\u52a8\u4ee3\u7406\uff0c\u56e0\u6b64\uff0c\u5b83\u4eec\u6ca1\u6709\u5207\u9762\u7ec7\u5165\u3002</p> <p>\u5bf9\u4e8e\u4efb\u4f55\u8fd9\u6837\u7684bean\uff0c\u4f60\u5e94\u8be5\u770b\u5230\u4e00\u4e2a\u4fe1\u606f\u65e5\u5fd7\u6d88\u606f\uff1a<code></code>Bean someBean is not eligible for getting processed by all BeanPostProcessor interfaces (for example: not eligible for auto-proxying)`</p> <p>\u5982\u679c\u60a8\u901a\u8fc7\u4f7f\u7528autowiring\u6216@Resource\uff08\u53ef\u80fd\u4f1a\u56de\u9000\u5230autowiring\uff09\u5c06bean\u6ce8\u5165\u5230BeanPostProcessor\u4e2d\uff0cSpring\u5728\u6309\u7c7b\u578b\u641c\u7d22\u5339\u914d\u7684\u4f9d\u8d56\u5019\u9009\u8005\u65f6\u53ef\u80fd\u4f1a\u8bbf\u95ee\u610f\u5916\u7684bean\uff0c\u56e0\u6b64\uff0c\u5bfc\u81f4\u5b83\u4eec\u4e0d\u7b26\u5408\u81ea\u52a8\u4ee3\u7406\u6216\u5176\u4ed6\u7c7b\u578b\u7684bean\u540e\u5904\u7406\u7684\u6761\u4ef6\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u7528@Resource\u6ce8\u89e3\u7684\u4f9d\u8d56\uff0c\u5176\u4e2d\u7684\u5b57\u6bb5\u5e76\u4e0d\u76f4\u63a5\u5bf9\u5e94\u4e8eBean\u7684\u58f0\u660e\u540d\u79f0\uff0c\u4e5f\u6ca1\u6709\u4f7f\u7528\u540d\u79f0\u5c5e\u6027\uff0c\u90a3\u4e48Spring\u5c31\u4f1a\u8bbf\u95ee\u5176\u4ed6Bean\u6765\u6309\u7c7b\u578b\u5339\u914d\u5b83\u4eec\u3002</p> <p>\u81ea\u5b9a\u4e49\u4f8b\u5b50\uff1a</p> <pre><code>import org.springframework.beans.factory.config.BeanPostProcessor;\n\npublic class InstantiationTracingBeanPostProcessor implements BeanPostProcessor {\n\n    // simply return the instantiated bean as-is\n    public Object postProcessBeforeInitialization(Object bean, String beanName) {\n        return bean; // \u6211\u4eec\u53ef\u4ee5\u6f5c\u5728\u7684\u8fd4\u56de\u4efb\u4f55\u5bf9\u8c61\n    }\n\n    public Object postProcessAfterInitialization(Object bean, String beanName) {\n        System.out.println(\"Bean '\" + beanName + \"' created : \" + bean.toString());\n        return bean;\n    }\n}\n</code></pre> <p>\u4f7f\u7528\u56de\u8c03\u63a5\u53e3\u6216\u6ce8\u89e3\u4e0e\u81ea\u5b9a\u4e49BeanPostProcessor\u5b9e\u73b0\u76f8\u7ed3\u5408\uff0c\u662f\u6269\u5c55Spring IoC\u5bb9\u5668\u7684\u4e00\u79cd\u5e38\u89c1\u624b\u6bb5\u3002\u4e00\u4e2a\u4f8b\u5b50\u662f Spring \u7684 RequiredAnnotationBeanPostProcessor--\u4e00\u4e2a\u968f Spring \u53d1\u884c\u7248\u63d0\u4f9b\u7684 BeanPostProcessor \u5b9e\u73b0\uff0c\u5b83\u53ef\u4ee5\u786e\u4fdd\u6807\u6709\uff08\u4efb\u610f\uff09\u6ce8\u89e3\u7684 Bean \u4e0a\u7684 JavaBean \u5c5e\u6027\u5b9e\u9645\u4e0a\u88ab\uff08\u914d\u7f6e\u4e3a\uff09\u4f9d\u8d56\u6ce8\u5165\u4e00\u4e2a\u503c\u3002</p> <p>\u50cf\u6ce8\u89e3\u7684\u5904\u7406\u548cAOP\u4ee3\u7406\u90fd\u662f\u901a\u8fc7BeanPostProcessor\u6765\u5b9e\u73b0\u7684\uff01\uff01\u5373\u53ef\u4ee5\u627e\u51fa\u6dfb\u52a0\u67d0\u4e2a\u6ce8\u89e3\u548c\u5b9e\u73b0\u67d0\u4e2a\u63a5\u53e3\u7684\u6240\u6709\u5b9e\u73b0\u7c7b\uff0c\u8fdb\u884c\u5904\u7406\u8bbe\u7f6e\u5c5e\u6027\u7b49\u3002</p> <p>\u5982@Async\uff0c\u5373\u5728\u5b9e\u73b0BeanPostProcessor\u7684\u5b9e\u73b0\u7c7b\u91cc\uff0c\u68c0\u67e5\u5982\u679c\u6dfb\u52a0@Async\uff0c\u5c31\u521b\u5efa\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\u3002</p> <p>\u8fd8\u6709\u5176\u4ed6\u7684\u9690\u542b\u7684\u6ce8\u89e3\u5904\u7406\u5668</p> <p><code>AutowiredAnnotationBeanPostProcessor</code>,<code>CommonAnnotationBeanPostProcessor</code>, <code>PersistenceAnnotationBeanPostProcessor</code>, \u548c\u524d\u9762\u63d0\u5230\u7684RequiredAnnotationBeanPostProcessor`\u3002</p>"},{"location":"java/spring/spring/IocContainer/#182-beanfactorypostprocessor","title":"1.8.2  <code>BeanFactoryPostProcessor</code>\u81ea\u5b9a\u4e49\u914d\u7f6e\u5143\u6570\u636e","text":"<p>\u4e0b\u4e00\u4e2a\u6269\u5c55\u70b9\u662f<code>org.springframework.beans.factory.config.BeanFactoryPostProcessor</code>\u3002\u8fd9\u4e2a\u63a5\u53e3\u7684\u8bed\u4e49\u4e0e<code>BeanPostProcessor</code>\u7c7b\u4f3c\uff0c\u4f46\u662f\u6709\u4e00\u4e2a\u91cd\u5927\u7684\u533a\u522b\u3002<code>BeanFactoryPostProcessor</code>\u53ef\u4ee5\u64cd\u4f5cBean\u7684\u914d\u7f6e\u5143\u6570\u636e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cSpring IOC\u5bb9\u5668\u5141\u8bb8<code>BeanFactoryPostProcessor</code>\u8bfb\u53d6\u914d\u7f6e\u5143\u6570\u636e\uff0c\u7136\u540e\u5728\u5bb9\u5668\u5b9e\u4f8b\u5316\u5176\u4ed6Bean\u4e4b\u524d\u6539\u53d8\u5b83\u3002</p> <p>\u4f60\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2aBeanFactoryPostProcessor\u5b9e\u4f8b\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6eorder\u5c5e\u6027\u6765\u63a7\u5236\u8fd9\u4e9bBeanFactoryPostProcessor\u5b9e\u4f8b\u7684\u8fd0\u884c\u987a\u5e8f\u3002\u4f46\u662f\uff0c\u53ea\u6709\u5f53BeanFactoryPostProcessor\u5b9e\u73b0\u4e86Ordered\u63a5\u53e3\u65f6\uff0c\u4f60\u624d\u80fd\u8bbe\u7f6e\u8fd9\u4e2a\u5c5e\u6027\u3002\u5982\u679c\u4f60\u5199\u4e86\u81ea\u5df1\u7684BeanFactoryPostProcessor\uff0c\u4f60\u4e5f\u5e94\u8be5\u8003\u8651\u5b9e\u73b0Ordered\u63a5\u53e3\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u6539\u53d8\u5b9e\u9645\u7684bean\u5b9e\u4f8b\uff08\u5373\u4ece\u914d\u7f6e\u5143\u6570\u636e\u4e2d\u521b\u5efa\u7684\u5bf9\u8c61\uff09\uff0c\u90a3\u4e48\u4f60\u9700\u8981\u4f7f\u7528BeanPostProcessor\uff08\u5728\u524d\u9762\u7684\u4f7f\u7528BeanPostProcessor\u81ea\u5b9a\u4e49bean\u4e2d\u63cf\u8ff0\uff09\u3002\u867d\u7136\u6280\u672f\u4e0a\u53ef\u4ee5\u5728BeanFactoryPostProcessor\u4e2d\u4f7f\u7528bean\u5b9e\u4f8b\uff08\u4f8b\u5982\u4f7f\u7528BeanFactory.getBean()\uff09\uff0c\u4f46\u8fd9\u6837\u505a\u4f1a\u5bfc\u81f4\u8fc7\u65e9\u7684bean\u5b9e\u4f8b\u5316\uff0c\u8fdd\u53cd\u4e86\u6807\u51c6\u7684\u5bb9\u5668\u751f\u547d\u5468\u671f\u3002\u8fd9\u53ef\u80fd\u4f1a\u5f15\u8d77\u8d1f\u9762\u7684\u526f\u4f5c\u7528\uff0c\u6bd4\u5982\u7ed5\u8fc7bean\u540e\u5904\u7406\u3002</p> <p>\u53e6\u5916\uff0cBeanFactoryPostProcessor\u5b9e\u4f8b\u7684\u4f5c\u7528\u57df\u662f\u6bcf\u4e2a\u5bb9\u5668\u3002\u8fd9\u53ea\u6709\u5728\u4f60\u4f7f\u7528\u5bb9\u5668\u5c42\u6b21\u7ed3\u6784\u65f6\u624d\u6709\u610f\u4e49\u3002\u5982\u679c\u4f60\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2aBeanFactoryPostProcessor\uff0c\u90a3\u4e48\u5b83\u53ea\u5e94\u7528\u4e8e\u8be5\u5bb9\u5668\u4e2d\u7684bean\u5b9a\u4e49\u3002\u4e00\u4e2a\u5bb9\u5668\u4e2d\u7684 Bean \u5b9a\u4e49\u4e0d\u4f1a\u88ab\u53e6\u4e00\u4e2a\u5bb9\u5668\u4e2d\u7684 BeanFactoryPostProcessor \u5b9e\u4f8b\u8fdb\u884c\u540e\u5904\u7406\uff0c\u5373\u4f7f\u8fd9\u4e24\u4e2a\u5bb9\u5668\u662f\u540c\u4e00\u5c42\u6b21\u7ed3\u6784\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u5f53\u5728ApplicationContext\u5185\u58f0\u660e\u4e00\u4e2abean\u5de5\u5382\u540e\u5904\u7406\u5668\u65f6\uff0c\u5b83\u5c31\u4f1a\u81ea\u52a8\u8fd0\u884c\uff0c\u4ee5\u4fbf\u5bf9\u5b9a\u4e49\u5bb9\u5668\u7684\u914d\u7f6e\u5143\u6570\u636e\u5e94\u7528\u66f4\u6539\u3002Spring\u5305\u542b\u4e86\u8bb8\u591a\u9884\u5b9a\u4e49\u7684bean\u5de5\u5382\u540e\u5904\u7406\u5668\uff0c\u5982<code>PropertyOverrideConfigurer</code>\u548c<code>PropertySourcesPlaceholderConfigurer</code>\u3002\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684BeanFactoryPostProcessor--\u4f8b\u5982\uff0c\u6ce8\u518c\u81ea\u5b9a\u4e49\u5c5e\u6027\u7f16\u8f91\u5668\u3002</p> <p>ApplicationContext \u4f1a\u81ea\u52a8\u68c0\u6d4b\u90e8\u7f72\u5230\u5b83\u7684\u4efb\u4f55\u5b9e\u73b0 BeanFactoryPostProcessor \u63a5\u53e3\u7684 Bean\u3002\u5b83\u5728\u9002\u5f53\u7684\u65f6\u5019\u5c06\u8fd9\u4e9bbean\u7528\u4f5cbean\u5de5\u5382\u540e\u5904\u7406\u5668\u3002\u4f60\u53ef\u4ee5\u50cf\u90e8\u7f72\u5176\u4ed6bean\u4e00\u6837\u90e8\u7f72\u8fd9\u4e9b\u540e\u5904\u7406\u5668bean\u3002</p> <p>\u4e0eBeanPostProcessors\u4e00\u6837\uff0c\u4f60\u901a\u5e38\u4e0d\u5e0c\u671b\u5c06BeanFactoryPostProcessors\u914d\u7f6e\u4e3a\u61d2\u60f0\u521d\u59cb\u5316\u3002\u5982\u679c\u6ca1\u6709\u5176\u4ed6 bean \u5f15\u7528 Bean(Factory)PostProcessor\uff0c\u90a3\u4e48\u8fd9\u4e2a\u540e\u5904\u7406\u5668\u5c06\u4e0d\u4f1a\u88ab\u5b9e\u4f8b\u5316\u3002\u56e0\u6b64\uff0c\u5c06\u5b83\u6807\u8bb0\u4e3a\u61d2\u60f0\u521d\u59cb\u5316\u5c06\u88ab\u5ffd\u7565\uff0c\u5373\u4f7f\u4f60\u5728 <code>&lt;beans /&gt;</code> \u5143\u7d20\u7684\u58f0\u660e\u4e2d\u5c06 default-lazy-init \u5c5e\u6027\u8bbe\u7f6e\u4e3a true\uff0cBean(Factory)PostProcessor \u4e5f\u4f1a\u88ab\u6025\u5207\u5730\u5b9e\u4f8b\u5316</p>"},{"location":"java/spring/spring/IocContainer/#propertysourcesplaceholderconfigurer","title":"PropertySourcesPlaceholderConfigurer","text":"<p>\u901a\u5e38\u6211\u4eec\u4e0d\u60f3\u5c06\u7c7b\u4f3c\u4e8e\u5bc6\u7801\u7b49\u91cd\u8981\u7684\u914d\u7f6e\u4fe1\u606f\u6df7\u6742\u5230XML\u4e2d\uff0c\u4ee5\u514d\u90e8\u7f72\u6216\u7ef4\u62a4\u671f\u95f4\u6539\u52a8\u590d\u6742\u7684\u914d\u7f6e\u6587\u4ef6\u51fa\u73b0\u95ee\u9898\u3002\u6240\u4ee5\u4e00\u822c\u4f1a\u5c06\u5982\u6570\u636e\u5e93\u8fde\u63a5\u7b49\u91cd\u8981\u7684\u4fe1\u606f\u5355\u72ec\u914d\u7f6e\u5230properties\u6587\u4ef6\u4e2d\uff0c<code>PropertySourcesPlaceholderConfigurer</code>\u5141\u8bb8\u6211\u4eec\u6765\u66ff\u6362\u914d\u7f6e\u4fe1\u606f\u91cc\u7684\u5360\u4f4d\u7b26\uff08PlaceHolder\uff09\u3002</p> <p>\u57fa\u672c\u673a\u5236\u5c31\u662f\uff0c\u5f53BeanFactory\u5728\u7b2c\u4e00\u9636\u6bb5\u52a0\u8f7d\u5b8c\u6210\u6240\u6709\u914d\u7f6e\u4fe1\u606f\uff0c\u5176\u4e2d\u4fdd\u5b58\u7684\u5bf9\u8c61\u5c5e\u6027\u4fe1\u606f\u8fd8\u662f\u4ee5\u5360\u4f4d\u7b26\u5f62\u5f0f\u5b58\u5728\uff0c\u5f53<code>PropertySourcesPlaceholderConfigurer</code>\u4f5c\u4e3a<code>BeanPostProcessors</code>\u5e94\u7528\u65f6\uff0c\u5b83\u4f1a\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u4fe1\u606f\u6765\u66ff\u6362BeanDefinition\u4e2d\u5360\u4f4d\u7b26\u8868\u793a\u7684\u5c5e\u6027\u503c\u3002\u53e6\u5916<code>PropertySourcesPlaceholderConfigurer</code>\u8fd8\u4f1a\u4eceSystem\u7c7b\u4e2d\u67e5\u627e\u5c5e\u6027\uff0c\u5e76\u53ef\u63a7\u5236\u662f\u5426\u8fdb\u884c\u8986\u76d6\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528 PropertySourcesPlaceholderConfigurer \u901a\u8fc7\u4f7f\u7528\u6807\u51c6\u7684 Java \u5c5e\u6027\u683c\u5f0f\uff0c\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u6587\u4ef6\u4e2d\u4ece bean \u5b9a\u4e49\u4e2d\u5916\u90e8\u5316\u5c5e\u6027\u503c\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u4f7f\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u7684\u4eba\u80fd\u591f\u81ea\u5b9a\u4e49\u7279\u5b9a\u73af\u5883\u7684\u5c5e\u6027\uff08\u5982\u6570\u636e\u5e93 URL \u548c\u5bc6\u7801\uff09\uff0c\u800c\u65e0\u9700\u4fee\u6539\u5bb9\u5668\u7684\u4e3b XML \u5b9a\u4e49\u6587\u4ef6\u6216\u6587\u4ef6\u7684\u590d\u6742\u6027\u6216\u98ce\u9669\u3002</p>"},{"location":"java/spring/spring/IocContainer/#propertyoverrideconfigurer","title":"PropertyOverrideConfigurer","text":"<p>The PropertyOverrideConfigurer, another bean factory post-processor, resembles the PropertySourcesPlaceholderConfigurer, but unlike the latter, the original definitions can have default values or no values at all for bean properties. If an overriding Properties file does not have an entry for a certain bean property, the default context definition is used.</p> <p>Note that the bean definition is not aware of being overridden, so it is not immediately obvious from the XML definition file that the override configurer is being used. In case of multiple PropertyOverrideConfigurer instances that define different values for the same bean property, the last one wins, due to the overriding mechanism.</p> <p><code>PropertyOverrideConfigurer</code>\u662f\u53e6\u4e00\u4e2a<code>BeanPostProcessors</code>\uff0c\u5b83\u7c7b\u4f3c\u4e8ePropertySourcesPlaceholderConfigurer\uff0c\u4f46\u4e0e\u540e\u8005\u4e0d\u540c\u7684\u662f\uff0cBean\u5c5e\u6027\u7684\u539f\u59cb\u5b9a\u4e49\u53ef\u4ee5\u6709\u9ed8\u8ba4\u503c\u6216\u5b8c\u5168\u6ca1\u6709\u503c\u3002\u5982\u679c\u8986\u76d6\u7684Properties\u6587\u4ef6\u4e2d\u6ca1\u6709\u67d0\u4e2abean\u5c5e\u6027\u7684\u6761\u76ee\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\u5b9a\u4e49\u3002</p> <p>https://developer.aliyun.com/article/459770</p> <p>\u5982\u679c\u8bf4<code>PropertySourcesPlaceholderConfigurer</code>\u505a\u7684\u8fd9\u4e9b\u662f\u660e\u4e8b\u7684\u8bdd\uff0c\u90a3\u4e48<code>PropertyOverrideConfigurer</code>\u5c31\u6709\u70b9\u795e\u4e0d\u77e5\u9b3c\u4e0d\u89c9\uff0c\u5b83\u662f\u76f4\u63a5\u76f8\u5e94\u7684\u6587\u4ef6\u4e2d\u8986\u76d6bean\u7684\u5c5e\u6027\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cbean\u5b9a\u4e49\u5e76\u4e0d\u77e5\u9053\u88ab\u8986\u76d6\uff0c\u6240\u4ee5\u4eceXML\u5b9a\u4e49\u6587\u4ef6\u4e2d\u5e76\u4e0d\u80fd\u7acb\u5373\u770b\u51fa\u6b63\u5728\u4f7f\u7528\u8986\u76d6\u914d\u7f6e\u5668\u3002\u5982\u679c\u591a\u4e2a<code>PropertyOverrideConfigurer</code>\u5b9e\u4f8b\u4e3a\u540c\u4e00\u4e2aBean\u5c5e\u6027\u5b9a\u4e49\u4e86\u4e0d\u540c\u7684\u503c\uff0c\u7531\u4e8e\u8986\u76d6\u673a\u5236\u7684\u5b58\u5728\uff0c\u6700\u540e\u4e00\u4e2a\u83b7\u80dc\u3002</p> <p>\u4ed6\u4eec\u7236\u7c7bPropertyResourceConfigurer\u63d0\u4f9b\u4e86\u4e00\u4e2aconverPropertyValue\u7684\u65b9\u6cd5\uff0c\u5141\u8bb8\u5bf9\u914d\u7f6e\u9879\u8fdb\u884c\u8f6c\u6362\uff0c\u5982\u5bf9\u52a0\u5bc6\u540e\u7684\u5b57\u7b26\u4e32\u8fdb\u884c\u89e3\u5bc6\u540e\u518d\u8986\u76d6\u5230\u76f8\u5e94\u7684Bean\u5b9a\u4e49\u4e2d\u3002</p>"},{"location":"java/spring/spring/IocContainer/#183-factorybean","title":"1.8.3 \u5229\u7528FactoryBean\u81ea\u5b9a\u4e49\u5b9e\u4f8b\u903b\u8f91","text":"<p>\u4f60\u53ef\u4ee5\u4e3a\u672c\u8eab\u5c31\u662ffactories\u7684\u5bf9\u8c61\u5b9e\u73b0<code>org.springframework.beans.factory.FactoryBean</code>\u63a5\u53e3\u3002</p> <p>FactoryBean\u63a5\u53e3\u662fSpring IoC\u5bb9\u5668\u5b9e\u4f8b\u5316\u903b\u8f91\u7684\u4e00\u4e2a\u53ef\u63d2\u62d4\u70b9\u3002\u5982\u679c\u4f60\u6709\u590d\u6742\u7684\u521d\u59cb\u5316\u4ee3\u7801\uff0c\u76f8\u5bf9\u4e8e\uff08\u6f5c\u5728\u7684\uff09\u5570\u55e6\u7684XML\u91cf\uff0c\u6700\u597d\u7528Java\u6765\u8868\u8fbe\uff0c\u4f60\u53ef\u4ee5\u521b\u5efa\u81ea\u5df1\u7684FactoryBean\uff0c\u5728\u8fd9\u4e2a\u7c7b\u91cc\u9762\u5199\u590d\u6742\u7684\u521d\u59cb\u5316\uff0c\u7136\u540e\u628a\u4f60\u81ea\u5b9a\u4e49\u7684FactoryBean\u63d2\u5165\u5230\u5bb9\u5668\u4e2d\u3002</p> <p>FactoryBean\u63a5\u53e3\u63d0\u4f9b\u4e86\u4e09\u4e2a\u65b9\u6cd5\u3002</p> <ul> <li> <p><code>Object getObject()</code>\u3002\u8fd4\u56de\u8fd9\u4e2a\u5de5\u5382\u521b\u5efa\u7684\u5bf9\u8c61\u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u8fd9\u4e2a\u5b9e\u4f8b\u53ef\u80fd\u662f\u5171\u4eab\u7684\uff0c\u8fd9\u53d6\u51b3\u4e8e\u8fd9\u4e2a\u5de5\u5382\u8fd4\u56de\u7684\u662f\u5355\u4f8b\u8fd8\u662f\u539f\u578b\u3002</p> </li> <li> <p><code>boolean isSingleton()</code>\uff1a\u5982\u679c\u8fd9\u4e2a\u5de5\u5382Bean\u8fd4\u56de\u5355\u4f8b\u5219\u8fd4\u56detrue\u3002\u5426\u5219\u8fd4\u56defalse\u3002</p> </li> <li> <p>Class getObjectType()\u3002\u8fd4\u56degetObject()\u65b9\u6cd5\u8fd4\u56de\u7684\u5bf9\u8c61\u7c7b\u578b\uff0c\u5982\u679c\u4e8b\u5148\u4e0d\u77e5\u9053\u7c7b\u578b\uff0c\u5219\u8fd4\u56denull\u3002</p> </li> </ul> <p>\u5728Spring\u6846\u67b6\u4e2d\uff0cFactoryBean\u7684\u6982\u5ff5\u548c\u63a5\u53e3\u5728\u5f88\u591a\u5730\u65b9\u88ab\u4f7f\u7528\u3002Spring\u672c\u8eab\u5c31\u670950\u591a\u4e2aFactoryBean\u63a5\u53e3\u7684\u5b9e\u73b0\u3002</p> <p>\u5f53\u4f60\u9700\u8981\u5411\u5bb9\u5668\u7d22\u53d6\u4e00\u4e2a\u5b9e\u9645\u7684FactoryBean\u5b9e\u4f8b\u672c\u8eab\u800c\u4e0d\u662f\u5b83\u6240\u4ea7\u751f\u7684bean\u65f6\uff0c\u5728\u8c03\u7528ApplicationContext\u7684getBean()\u65b9\u6cd5\u65f6\uff0c\u7528\u5b89\u57f9\u7b26\u53f7(&amp;)\u5c06bean\u7684id\u653e\u5728\u524d\u9762\u3002\u56e0\u6b64\uff0c\u5bf9\u4e8e\u4e00\u4e2aid\u4e3amyBean\u7684\u7ed9\u5b9aFactoryBean\uff0c\u5728\u5bb9\u5668\u4e0a\u8c03\u7528getBean(\"myBean\")\u4f1a\u8fd4\u56deFactoryBean\u7684\u4ea7\u7269\uff0c\u800c\u8c03\u7528getBean(\"&amp;myBean\")\u5219\u4f1a\u8fd4\u56deFactoryBean\u5b9e\u4f8b\u672c\u8eab\u3002</p> <p>\u7531BeanFactory\u4e2d\u4f7f\u7528\u7684\u5bf9\u8c61\u5b9e\u73b0\u7684\u63a5\u53e3\uff0c\u8fd9\u4e9b\u5bf9\u8c61\u672c\u8eab\u5c31\u662f\u5355\u4e2a\u5bf9\u8c61\u7684\u5de5\u5382\u3002 \u5982\u679cbean\u5b9e\u73b0\u6b64\u63a5\u53e3\uff0c\u5219\u5b83\u5c06\u7528\u4f5c\u5bf9\u8c61\u516c\u5f00\u7684\u5de5\u5382\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u7528\u4f5c\u5c06\u81ea\u8eab\u516c\u5f00\u7684bean\u5b9e\u4f8b\u3002 \u6ce8\u610f\uff1a\u5b9e\u73b0\u6b64\u63a5\u53e3\u7684bean\u4e0d\u80fd\u7528\u4f5c\u666e\u901abean\u3002 FactoryBean\u662f\u7528bean\u6837\u5f0f\u5b9a\u4e49\u7684\uff0c\u4f46\u662f\u4e3abean\u5f15\u7528\u516c\u5f00\u7684\u5bf9\u8c61\uff08 getObject() \uff09\u59cb\u7ec8\u662f\u5b83\u521b\u5efa\u7684\u5bf9\u8c61\u3002 FactoryBeans\u53ef\u4ee5\u652f\u6301\u5355\u4f8b\u548c\u539f\u578b\uff0c\u5e76\u4e14\u53ef\u4ee5\u6309\u9700\u5ef6\u8fdf\u521b\u5efa\u5bf9\u8c61\uff0c\u4e5f\u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u6025\u4e8e\u521b\u5efa\u5bf9\u8c61\u3002 SmartFactoryBean\u63a5\u53e3\u5141\u8bb8\u516c\u5f00\u66f4\u7ec6\u7c92\u5ea6\u7684\u884c\u4e3a\u5143\u6570\u636e\u3002 \u6b64\u63a5\u53e3\u5728\u6846\u67b6\u672c\u8eab\u4e2d\u88ab\u5927\u91cf\u4f7f\u7528\uff0c\u4f8b\u5982\u7528\u4e8eAOP <code>org.springframework.aop.framework.ProxyFactoryBean</code>\u6216<code>org.springframework.jndi.JndiObjectFactoryBean</code> \u3002 \u5b83\u4e5f\u53ef\u4ee5\u7528\u4e8e\u81ea\u5b9a\u4e49\u7ec4\u4ef6\u3002 \u4f46\u662f\uff0c\u8fd9\u4ec5\u5728\u57fa\u7840\u7ed3\u6784\u4ee3\u7801\u4e2d\u5f88\u5e38\u89c1\u3002 FactoryBean\u662f\u7a0b\u5e8f\u6027\u5408\u540c\u3002 \u5b9e\u73b0\u4e0d\u5e94\u4f9d\u8d56\u4e8e\u6ce8\u89e3\u9a71\u52a8\u7684\u6ce8\u5165\u6216\u5176\u4ed6\u53cd\u5c04\u529f\u80fd\u3002 getObjectType() getObject()\u8c03\u7528\u53ef\u80fd\u4f1a\u5728\u5f15\u5bfc\u8fc7\u7a0b\u7684\u65e9\u671f\u5230\u8fbe\uff0c\u751a\u81f3\u5728\u4efb\u4f55\u540e\u5904\u7406\u5668\u8bbe\u7f6e\u4e4b\u524d\u3002 \u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u4ed6bean\uff0c\u8bf7\u5b9e\u73b0BeanFactoryAware\u5e76\u4ee5\u7f16\u7a0b\u65b9\u5f0f\u83b7\u53d6\u5b83\u4eec\u3002 \u5bb9\u5668\u4ec5\u8d1f\u8d23\u7ba1\u7406FactoryBean\u5b9e\u4f8b\u7684\u751f\u547d\u5468\u671f\uff0c\u800c\u4e0d\u8d1f\u8d23\u7ba1\u7406FactoryBean\u521b\u5efa\u7684\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f\u3002 \u56e0\u6b64\uff0c\u4e0d\u4f1a\u81ea\u52a8\u8c03\u7528\u66b4\u9732\u7684bean\u5bf9\u8c61\u4e0a\u7684destroy\u65b9\u6cd5\uff08\u4f8b\u5982java.io.Closeable.close() \u3002\u76f8\u53cd\uff0cFactoryBean\u5e94\u8be5\u5b9e\u73b0DisposableBean\u5e76\u5c06\u4efb\u4f55\u6b64\u7c7bclose\u8c03\u7528\u59d4\u6258\u7ed9\u57fa\u7840\u5bf9\u8c61\u3002 \u6700\u540e\uff0cFactoryBean\u5bf9\u8c61\u53c2\u4e0e\u5305\u542bBeanFactory\u7684Bean\u521b\u5efa\u540c\u6b65\u3002 \u9664\u4e86\u51fa\u4e8eFactoryBean\u81ea\u8eab\uff08\u6216\u7c7b\u4f3c\u65b9\u5f0f\uff09\u5185\u90e8\u7684\u5ef6\u8fdf\u521d\u59cb\u5316\u7684\u76ee\u7684\u4e4b\u5916\uff0c\u901a\u5e38\u4e0d\u9700\u8981\u5185\u90e8\u540c\u6b65\u3002</p> <p>\u66f4\u591a\u5173\u4e8eFactoryBean\u7684\u4f7f\u7528\u6709\u5f88\u591a\u535a\u5ba2\u53ef\u4ee5\u53c2\u8003\uff0chttps://blog.csdn.net/jisuanji12306/article/details/86557711\u3002\u7b80\u5355\u7406\u89e3\u53ef\u4ee5\u7ed3\u5408BeanDefinition\u6279\u91cf\u751f\u6210Bean\uff0c\u7136\u540e\u63d0\u4f9b\u7ed9\u5f00\u53d1\u8005\u6ce8\u5165\u4f7f\u7528\u3002</p> <p>\u4f7f\u7528\u53c2\u8003<code>org.springframework.scheduling.quartz.CronTriggerFactoryBean</code>\u7b49</p>"},{"location":"java/spring/spring/IocContainer/#19","title":"1.9 \u57fa\u4e8e\u6ce8\u89e3\u7684\u5bb9\u5668\u914d\u7f6e","text":"<p>\u5bb9\u5668\u914d\u7f6e\uff0c\u57fa\u4e8e\u6ce8\u89e3\u6bd4\u57fa\u4e8eXML\u66f4\u597d\u5417\uff1f</p> <p>\u57fa\u4e8e\u6ce8\u89e3\u7684\u914d\u7f6e\u7684\u5f15\u5165\u63d0\u51fa\u4e86\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff1a\u8fd9\u79cd\u65b9\u6cd5\u662f\u5426\u6bd4XML \"\u66f4\u597d\"\u3002\u7b80\u77ed\u7684\u56de\u7b54\u662f \"\u770b\u60c5\u51b5\"\u3002\u957f\u7684\u7b54\u6848\u662f\uff0c\u6bcf\u4e00\u79cd\u65b9\u6cd5\u90fd\u6709\u5b83\u7684\u4f18\u70b9\u548c\u7f3a\u70b9\uff0c\u800c\u4e14\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u8981\u7531\u5f00\u53d1\u4eba\u5458\u51b3\u5b9a\u54ea\u79cd\u7b56\u7565\u66f4\u9002\u5408\u4ed6\u4eec\u3002\u7531\u4e8e\u5b83\u4eec\u7684\u5b9a\u4e49\u65b9\u5f0f\uff0c\u6ce8\u89e3\u5728\u5176\u58f0\u660e\u4e2d\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u4e0a\u4e0b\u6587\uff0c\u5bfc\u81f4\u914d\u7f6e\u66f4\u77ed\u3001\u66f4\u7b80\u6d01\u3002\u7136\u800c\uff0cXML\u64c5\u957f\u5728\u4e0d\u63a5\u89e6\u7ec4\u4ef6\u7684\u6e90\u4ee3\u7801\u6216\u91cd\u65b0\u7f16\u8bd1\u5b83\u4eec\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u7ec7\u5165\u3002\u4e00\u4e9b\u5f00\u53d1\u4eba\u5458\u559c\u6b22\u8ba9\u5e03\u7ebf\u63a5\u8fd1\u6e90\u7801\uff0c\u800c\u53e6\u4e00\u4e9b\u4eba\u5219\u8ba4\u4e3a\uff0c\u6ce8\u89e3\u7c7b\u4e0d\u518d\u662fPOJO\uff0c\u800c\u4e14\uff0c\u914d\u7f6e\u53d8\u5f97\u5206\u6563\uff0c\u66f4\u96be\u63a7\u5236\u3002</p> <p>\u65e0\u8bba\u5982\u4f55\u9009\u62e9\uff0cSpring\u90fd\u53ef\u4ee5\u5bb9\u7eb3\u8fd9\u4e24\u79cd\u98ce\u683c\uff0c\u751a\u81f3\u5c06\u5b83\u4eec\u6df7\u5408\u5728\u4e00\u8d77\u3002\u503c\u5f97\u6307\u51fa\u7684\u662f\uff0c\u901a\u8fc7\u5176JavaConfig\u9009\u9879\uff0cSpring\u53ef\u4ee5\u8ba9\u6ce8\u89e3\u4ee5\u4e00\u79cd\u975e\u4fb5\u5165\u5f0f\u7684\u65b9\u5f0f\u4f7f\u7528\uff0c\u800c\u4e0d\u4f1a\u89e6\u53ca\u76ee\u6807\u7ec4\u4ef6\u7684\u6e90\u4ee3\u7801</p> <p>\u57fa\u4e8e\u6ce8\u89e3\u7684\u914d\u7f6e\u63d0\u4f9b\u4e86\u57fa\u4e8eXML\u914d\u7f6e\u7684\u66ff\u4ee3\u65b9\u6848\uff0c\u5b83\u4f9d\u8d56\u4e8e\u5b57\u8282\u7801\u5143\u6570\u636e\u6765\u5e03\u7ebf\u7ec4\u4ef6\uff0c\u800c\u4e0d\u662f\u901a\u8fc7\u89d2\u62ec\u53f7\u58f0\u660e\u3002\u5f00\u53d1\u8005\u4e0d\u4f7f\u7528XML\u6765\u63cf\u8ff0bean\u5e03\u7ebf\uff0c\u800c\u662f\u901a\u8fc7\u5728\u76f8\u5173\u7684\u7c7b\u3001\u65b9\u6cd5\u6216\u5b57\u6bb5\u58f0\u660e\u4e0a\u4f7f\u7528\u6ce8\u89e3\uff0c\u5c06\u914d\u7f6e\u79fb\u5230\u7ec4\u4ef6\u7c7b\u672c\u8eab\u3002\u5982\u4f8b\u4e2d\u63d0\u5230\u7684\u3002\u6240\u9700\u7684AnnotationBeanPostProcessor\u4e2d\uff0c\u4f7f\u7528BeanPostProcessor\u4e0e\u6ce8\u89e3\u76f8\u7ed3\u5408\u662f\u6269\u5c55Spring IoC\u5bb9\u5668\u7684\u5e38\u7528\u624b\u6bb5\u3002\u4f8b\u5982\uff0cSpring 2.0\u5f15\u5165\u4e86\u4f7f\u7528@Required\u6ce8\u89e3\u5f3a\u5236\u6267\u884c\u6240\u9700\u5c5e\u6027\u7684\u53ef\u80fd\u6027\u3002Spring 2.5\u4f7f\u5f97\u9075\u5faa\u540c\u6837\u7684\u901a\u7528\u65b9\u6cd5\u6765\u9a71\u52a8Spring\u7684\u4f9d\u8d56\u6ce8\u5165\u6210\u4e3a\u53ef\u80fd\u3002\u672c\u8d28\u4e0a\uff0c@Autowired\u6ce8\u89e3\u63d0\u4f9b\u4e86\u4e0e Autowiring Collaborators \u4e2d\u63cf\u8ff0\u7684\u76f8\u540c\u7684\u529f\u80fd\uff0c\u4f46\u5177\u6709\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u548c\u66f4\u5e7f\u6cdb\u7684\u9002\u7528\u6027\u3002Spring 2.5\u8fd8\u589e\u52a0\u4e86\u5bf9JSR-250\u6ce8\u89e3\u7684\u652f\u6301\uff0c\u5982@PostConstruct\u548c@PreDestroy\u3002Spring 3.0\u589e\u52a0\u4e86\u5bf9JSR-330\uff08Java\u4f9d\u8d56\u6ce8\u5165\uff09\u6ce8\u89e3\u7684\u652f\u6301\uff0c\u8fd9\u4e9b\u6ce8\u89e3\u5305\u542b\u5728javax.inject\u5305\u4e2d\uff0c\u5982@Inject\u548c@Named\u3002\u5173\u4e8e\u8fd9\u4e9b\u6ce8\u89e3\u7684\u7ec6\u8282\u53ef\u4ee5\u5728\u76f8\u5173\u7ae0\u8282\u4e2d\u627e\u5230\u3002</p> <p>\u6ce8\u89e3\u6ce8\u5165\u662f\u5728XML\u6ce8\u5165\u4e4b\u524d\u6267\u884c\u7684\u3002\u56e0\u6b64\uff0cXML\u914d\u7f6e\u4f1a\u8986\u76d6\u6ce8\u89e3\u6ce8\u5165\u7684\u5c5e\u6027\u3002</p>"},{"location":"java/spring/spring/IocContainer/#112-java-based","title":"1.12 Java-based \u5bb9\u5668\u914d\u7f6e","text":"<p>\u8fd9\u8282\u4ecb\u7ecd\u5982\u4f55\u5728Java\u4ee3\u7801\u4e2d\u901a\u8fc7\u6ce8\u89e3\u7684\u65b9\u5f0f\u914d\u7f6eSpring\u5bb9\u5668\uff0c\u5b83\u5305\u62ec\uff1a</p> <ul> <li>\u57fa\u672c\u6982\u5ff5: <code>@Bean</code> and <code>@Configuration</code></li> <li>\u901a\u8fc7<code>AnnotationConfigApplicationContext\u5b9e\u4f8b\u5316spring\u5bb9\u5668</code></li> <li>\u4f7f\u7528 <code>@Bean</code> Annotation</li> <li>\u4f7f\u7528<code>@Configuration</code> annotation</li> <li>Composing Java-based Configurations</li> <li>Bean Definition Profiles</li> <li><code>PropertySource</code> Abstraction</li> <li>\u4f7f\u7528 <code>@PropertySource</code></li> <li>Placeholder Resolution in Statements</li> </ul>"},{"location":"java/spring/spring/IocContainer/#1121-bean-configuration","title":"1.12.1 \u57fa\u7840\u6982\u5ff5\uff1a<code>@Bean</code> \u548c <code>@Configuration</code>","text":"<p>Spring\u65b0\u7684Java-configuration\u7684\u6838\u5fc3\u6784\u4ef6\u662f<code>@Configuration</code>\u6ce8\u89e3\u7684\u7c7b\u548c<code>@Bean</code>\u6ce8\u89e3\u7684\u65b9\u6cd5</p> <p>@Bean\u6ce8\u89e3\u7528\u4e8e\u8868\u793a\u4e00\u4e2a\u65b9\u6cd5\u5b9e\u4f8b\u5316\u3001\u914d\u7f6e\u548c\u521d\u59cb\u5316\u4e00\u4e2a\u65b0\u7684\u5bf9\u8c61\uff0c\u4ee5\u4fbfSpring Ioc\u5bb9\u5668\u7ba1\u7406\u3002@Bean\u6ce8\u89e3\u7684\u4f5c\u7528\u4e0eXML\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684<code>&lt;bean/&gt;</code>\u5143\u7d20\u4f5c\u7528\u76f8\u540c\u3002\u60a8\u53ef\u4ee5\u5728\u4efb\u4f55Spring @Component\u4e2d\u4f7f\u7528@Bean\u6ce8\u89e3\u7684\u65b9\u6cd5\u3002\u7136\u800c\uff0c\u5b83\u4eec\u6700\u5e38\u88ab\u7528\u4e8e@Configuration beans\u3002</p> <p>@Configuration\u6ce8\u89e3\u7684\u7c7b\u8868\u660e\u5b83\u7684\u4e3b\u8981\u76ee\u7684\u662f\u4f5c\u4e3abean\u5b9a\u4e49\u7684\u6765\u6e90\u3002\u6b64\u5916\uff0c@Configuration\u7c7b\u8fd8\u5141\u8bb8\u901a\u8fc7\u8c03\u7528\u540c\u4e00\u7c7b\u4e2d\u7684\u5176\u4ed6@Bean\u65b9\u6cd5\u6765\u5b9a\u4e49bean\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u6700\u7b80\u5355\u7684@Configuration\u7c7b\u7684\u5185\u5bb9\u5982\u4e0b:</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public MyService myService() {\n        return new MyServiceImpl();\n    }\n}\n</code></pre> <p>\u5b8c\u6574\u7684@Configuration\u4e0e \"\u7cbe\u7b80 \"\u7684@Bean\u6a21\u5f0f\uff1f</p> <p>\u5f53@Bean\u65b9\u6cd5\u88ab\u58f0\u660e\u5728\u6ca1\u6709\u6ce8\u89e3@Configuration\u7684\u7c7b\u4e2d\u65f6\uff0c\u5b83\u4eec\u88ab\u79f0\u4e3a\u4ee5 \"\u7cbe\u7b80 \"\u6a21\u5f0f\u5904\u7406\u3002\u5728@Component\u751a\u81f3\u5728\u4e00\u4e2a\u666e\u901a\u7684\u7c7b\u4e2d\u58f0\u660e\u7684Bean\u65b9\u6cd5\u88ab\u8ba4\u4e3a\u662f \"\u7cbe\u7b80 \"\u7684\uff0c\u5305\u542b\u7c7b\u7684\u4e3b\u8981\u76ee\u7684\u4e0d\u540c\uff0c@Bean\u65b9\u6cd5\u5728\u90a3\u91cc\u662f\u4e00\u79cd\u5956\u52b1\u3002\u4f8b\u5982\uff0c\u670d\u52a1\u7ec4\u4ef6\u53ef\u80fd\u4f1a\u901a\u8fc7\u5728\u6bcf\u4e2a\u9002\u7528\u7684\u7ec4\u4ef6\u7c7b\u4e0a\u989d\u5916\u7684@Bean\u65b9\u6cd5\u5411\u5bb9\u5668\u66b4\u9732\u7ba1\u7406\u89c6\u56fe\u3002\u5728\u8fd9\u6837\u7684\u573a\u666f\u4e0b\uff0c@Bean\u65b9\u6cd5\u662f\u4e00\u79cd\u901a\u7528\u7684\u5de5\u5382\u65b9\u6cd5\u673a\u5236\u3002</p> <p>\u4e0e\u5b8c\u6574\u7684@Configuration\u4e0d\u540c\uff0c\u7cbe\u7b80\u7684@Bean\u65b9\u6cd5\u4e0d\u80fd\u58f0\u660ebean\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u76f8\u53cd\uff0c\u5b83\u4eec\u662f\u5728\u5b83\u4eec\u6240\u5305\u542b\u7684\u7ec4\u4ef6\u7684\u5185\u90e8\u72b6\u6001\u4e0a\u8fdb\u884c\u64cd\u4f5c\uff0c\u5e76\u4e14\u53ef\u4ee5\u9009\u62e9\u5728\u5b83\u4eec\u53ef\u80fd\u58f0\u660e\u7684\u53c2\u6570\u4e0a\u8fdb\u884c\u64cd\u4f5c\u3002\u56e0\u6b64\uff0c\u8fd9\u6837\u7684@Bean\u65b9\u6cd5\u4e0d\u5e94\u8be5\u8c03\u7528\u5176\u4ed6@Bean\u65b9\u6cd5\u3002\u6bcf\u4e2a\u8fd9\u6837\u7684\u65b9\u6cd5\u4ece\u5b57\u9762\u4e0a\u770b\u53ea\u662f\u4e00\u4e2a\u7279\u5b9abean\u5f15\u7528\u7684\u5de5\u5382\u65b9\u6cd5\uff0c\u6ca1\u6709\u4efb\u4f55\u7279\u6b8a\u7684\u8fd0\u884c\u65f6\u8bed\u4e49\u3002\u8fd9\u91cc\u7684\u79ef\u6781\u526f\u4f5c\u7528\u662f\uff0c\u65e0\u9700\u5728\u8fd0\u884c\u65f6\u5e94\u7528CGLIB\u5b50\u7c7b\uff0c\u56e0\u6b64\u5728\u7c7b\u8bbe\u8ba1\u65b9\u9762\u6ca1\u6709\u9650\u5236\uff08\u5373\u5305\u542b\u7684\u7c7b\u53ef\u4ee5\u662ffinal\u7b49\uff09\u3002</p> <p>\u5728\u5e38\u89c1\u7684\u573a\u666f\u4e2d\uff0c@Bean\u65b9\u6cd5\u8981\u5728@Configuration\u7c7b\u4e2d\u58f0\u660e\uff0c\u786e\u4fdd\u59cb\u7ec8\u4f7f\u7528 \"\u5b8c\u6574 \"\u6a21\u5f0f\uff0c\u56e0\u6b64\u8de8\u65b9\u6cd5\u5f15\u7528\u4f1a\u88ab\u91cd\u5b9a\u5411\u5230\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u4e2d\u3002\u8fd9\u6837\u53ef\u4ee5\u9632\u6b62\u540c\u4e00\u4e2a@Bean\u65b9\u6cd5\u901a\u8fc7\u5e38\u89c4\u7684Java\u8c03\u7528\u88ab\u610f\u5916\u8c03\u7528\uff0c\u8fd9\u6709\u52a9\u4e8e\u51cf\u5c11\u5728 \"\u7cbe\u7b80 \"\u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\u96be\u4ee5\u8ffd\u8e2a\u7684\u7ec6\u5faebug\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1122-annotationconfigapplicationcontextspring","title":"1.12.2 \u901a\u8fc7AnnotationConfigApplicationContext\u5b9e\u4f8b\u5316spring\u5bb9\u5668","text":"<p>\u4e0b\u9762\u7684\u7ae0\u8282\u8bb0\u5f55\u4e86Spring\u5728Spring 3.0\u4e2d\u5f15\u5165\u7684<code>AnnotationConfigApplicationContext</code>\u3002\u8fd9\u4e2a\u591a\u529f\u80fd\u7684<code>ApplicationContext</code>\u5b9e\u73b0\u4e0d\u4ec5\u80fd\u63a5\u53d7@Configuration\u7c7b\u4f5c\u4e3a\u8f93\u5165\uff0c\u8fd8\u80fd\u63a5\u53d7\u666e\u901a\u7684<code>@Component</code>\u7c7b\u548c\u7528JSR-330\u5143\u6570\u636e\u6ce8\u91ca\u7684\u7c7b\u3002</p> <p>\u5f53<code>@Configuration</code>\u7c7b\u88ab\u63d0\u4f9b\u4e3a\u8f93\u5165\u65f6\uff0c<code>@Configuration</code>\u7c7b\u672c\u8eab\u88ab\u6ce8\u518c\u4e3abean\u5b9a\u4e49\uff0c\u5e76\u4e14\u8be5\u7c7b\u4e2d\u6240\u6709\u58f0\u660e\u7684<code>@Bean</code>\u65b9\u6cd5\u4e5f\u88ab\u6ce8\u518c\u4e3abean\u5b9a\u4e49\u3002</p> <p>\u5f53\u63d0\u4f9b<code>@Component</code>\u548cJSR-330\u7c7b\u65f6\uff0c\u5b83\u4eec\u88ab\u6ce8\u518c\u4e3abean\u5b9a\u4e49\uff0c\u5e76\u4e14\u5047\u5b9a\u5728\u8fd9\u4e9b\u7c7b\u4e2d\u5fc5\u8981\u65f6\u4f7f\u7528\u4e86DI\u5143\u6570\u636e\uff0c\u5982@Autowired\u6216@Inject\u3002</p> <p>\u7b80\u5355\u7684\u5b9e\u4f8b\u5316</p> <p>\u4e0e\u5b9e\u4f8b\u5316ClassPathXmlApplicationContext\u65f6\u4f7f\u7528Spring XML\u6587\u4ef6\u4f5c\u4e3a\u8f93\u5165\u4e00\u6837\uff0c\u60a8\u53ef\u4ee5\u5728\u5b9e\u4f8b\u5316AnnotationConfigApplicationContext\u65f6\u4f7f\u7528@Configuration\u7c7b\u4f5c\u4e3a\u8f93\u5165\u3002\u8fd9\u5c31\u5141\u8bb8\u5b8c\u5168\u4e0d\u4f7f\u7528XML\u7684Spring\u5bb9\u5668\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>public static void main(String[] args) {\n    ApplicationContext ctx = new AnnotationConfigApplicationContext(AppConfig.class);\n    MyService myService = ctx.getBean(MyService.class);\n    myService.doStuff();\n}\n</code></pre> <p>\u5982\u524d\u6240\u8ff0\uff0cAnnotationConfigApplicationContext\u5e76\u4e0d\u9650\u4e8e\u53ea\u4e0e@Configuration\u7c7b\u4e00\u8d77\u5de5\u4f5c\u3002\u4efb\u4f55@Component\u6216JSR-330\u6ce8\u89e3\u7c7b\u90fd\u53ef\u4ee5\u4f5c\u4e3a\u8f93\u5165\u63d0\u4f9b\u7ed9\u6784\u9020\u51fd\u6570\uff0c\u5982\u4e0b\u4f8b\u6240\u793a:</p> <pre><code>public static void main(String[] args) {\n    ApplicationContext ctx = new AnnotationConfigApplicationContext(MyServiceImpl.class, Dependency1.class, Dependency2.class);\n    MyService myService = ctx.getBean(MyService.class);\n    myService.doStuff();\n}\n</code></pre> <p>\u4f7f\u7528<code>register(Class&lt;?&gt;\u2026)</code>\u7f16\u7a0b\u6784\u5efa\u5bb9\u5668</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528\u65e0\u53c2\u6570\u6784\u9020\u51fd\u6570\u5b9e\u4f8b\u5316\u4e00\u4e2aAnnotationConfigApplicationContext\uff0c\u7136\u540e\u4f7f\u7528register()\u65b9\u6cd5\u914d\u7f6e\u5b83\u3002\u5f53\u4ee5\u7f16\u7a0b\u65b9\u5f0f\u6784\u5efaAnnotationConfigApplicationContext\u65f6\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7279\u522b\u6709\u7528\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>public static void main(String[] args) {\n    AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();\n    ctx.register(AppConfig.class, OtherConfig.class);\n    ctx.register(AdditionalConfig.class);\n    ctx.refresh();\n    MyService myService = ctx.getBean(MyService.class);\n    myService.doStuff();\n}\n</code></pre> <p><code>scan(String\u2026)</code>\u5f00\u542f\u5305\u626b\u63cf</p> <pre><code>@Configuration\n@ComponentScan(basePackages = \"com.acme\") \npublic class AppConfig  {\n    ...\n}\n</code></pre> <p>\u5728\u524d\u9762\u7684\u793a\u4f8b\u4e2d\uff0c<code>com.acme</code>\u5305\u88ab\u626b\u63cf\u4ee5\u67e5\u627e\u4efb\u4f55<code>@Component-annotated</code>\u7c7b\uff0c\u8fd9\u4e9b\u7c7b\u88ab\u6ce8\u518c\u4e3a\u5bb9\u5668\u4e2d\u7684Spring bean\u5b9a\u4e49\u3002<code>AnnotationConfigApplicationContext</code>\u516c\u5f00\u4e86<code>scan(String...)</code>\u65b9\u6cd5\uff0c\u4ee5\u5141\u8bb8\u540c\u6837\u7684\u7ec4\u4ef6\u626b\u63cf\u529f\u80fd\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>public static void main(String[] args) {\n    AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();\n    ctx.scan(\"com.acme\");\n    ctx.refresh();\n    MyService myService = ctx.getBean(MyService.class);\n}\n</code></pre> <p>\u8bf7\u8bb0\u4f4f\uff0c<code>@Configuration</code>\u7c7b\u662f\u7528<code>@Component</code>\u8fdb\u884c\u5143\u6ce8\u89e3\u7684\uff0c\u6240\u4ee5\u5b83\u4eec\u662f\u7ec4\u4ef6\u626b\u63cf\u7684\u5019\u9009\u5bf9\u8c61\u3002\u5728\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5047\u8bbeAppConfig\u662f\u5728<code>com.acme</code>\u5305\uff08\u6216\u4e0b\u9762\u7684\u4efb\u4f55\u5305\uff09\u4e2d\u58f0\u660e\u7684\uff0c\u90a3\u4e48\u5728\u8c03\u7528scan()\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5b83\u5c31\u4f1a\u88ab\u9009\u4e2d\u3002\u4e00\u65e6\u5237\u65b0()\uff0c\u5b83\u7684\u6240\u6709@Bean\u65b9\u6cd5\u90fd\u4f1a\u88ab\u5904\u7406\u5e76\u5728\u5bb9\u5668\u4e2d\u6ce8\u518c\u4e3abean\u5b9a\u4e49\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1123-bean","title":"1.12.3 @Bean\u7684\u4f7f\u7528","text":"<p>@Bean\u662f\u4e2a\u65b9\u6cd5\u7ea7\u522b\u7684\u6ce8\u89e3\uff0c\u548cXML\u4e2d\u7684 <code>&lt;bean/&gt;</code> \u76f8\u540c\u4f5c\u7528\u3002\u8fd9\u4e2a\u6ce8\u89e3\u4e5f\u652f\u6301 * init-method * destroy-method * autowiring *\u5c5e\u6027\u3002</p>"},{"location":"java/spring/spring/IocContainer/#declaring-a-bean","title":"Declaring a Bean","text":"<p>\u58f0\u660e\u4e00\u4e2aBean\uff0c\u53ef\u4ee5\u5728\u65b9\u6cd5\u4e0a\u4f7f\u7528@Bean\u6ce8\u89e3\uff0c\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u5c31\u662fBean\u7684\u7c7b\u578b\u3002\u9ed8\u8ba4\u7684\uff0cBean \u7684name\u5c31\u662f\u65b9\u6cd5\u540d\uff01\u5982\uff1a</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public TransferServiceImpl transferService() {\n        return new TransferServiceImpl();\n    }\n}\n</code></pre> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u58f0\u660e\u8fd4\u56de\u63a5\u53e3</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public TransferService transferService() {\n        return new TransferServiceImpl();\n    }\n}\n</code></pre> <p>\u7c7b\u4f3c\u4e8e</p> <pre><code>&lt;beans&gt;\n    &lt;bean id=\"transferService\" class=\"com.acme.TransferServiceImpl\"/&gt;\n&lt;/beans&gt;\n</code></pre> <p>Both declarations make a bean named <code>transferService</code> available in the <code>ApplicationContext</code>, bound to an object instance of type <code>TransferServiceImpl</code>, \u5982\u4e0b:</p> <pre><code>transferService -&gt; com.acme.TransferServiceImpl\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#bean_5","title":"Bean\u7684\u4f9d\u8d56","text":"<p>\u4e00\u4e2aBean\u6ce8\u89e3\u7684\u65b9\u6cd5\u53ef\u4ee5\u6709\u4efb\u610f\u6570\u91cf\u7684\u53c2\u6570\uff0c\u8fd9\u4e9b\u53c2\u6570\u63cf\u8ff0\u4e86\u6784\u5efa\u8be5Bean\u6240\u9700\u7684\u4f9d\u8d56\u3002\u4f8b\u5982\u5982\u679c\u6211\u4eec\u7684TransferService\u9700\u8981\u4e00\u4e2aAccountRepository\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u65b9\u6cd5\u53c2\u6570\u6765\u5177\u4f53\u5316\u8fd9\u4e2a\u4f9d\u8d56\u5173\u7cfb\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public TransferService transferService(AccountRepository accountRepository) {\n        return new TransferServiceImpl(accountRepository);\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u7684\u89e3\u51b3\u673a\u5236\u548c\u57fa\u4e8e\u6784\u9020\u7684\u4f9d\u8d56\u5dee\u4e0d\u591a\u3002</p>"},{"location":"java/spring/spring/IocContainer/#_1","title":"\u63a5\u53d7\u751f\u547d\u5468\u671f\u7684\u56de\u8c03","text":"<p>\u4efb\u4f55\u4f7f\u7528 @Bean \u6ce8\u89e3\u5b9a\u4e49\u7684\u7c7b\u90fd\u652f\u6301\u5e38\u89c1\u7684\u751f\u547d\u5468\u671f\u56de\u8c03\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f7f\u7528 JSR-250 \u4e2d\u7684 <code>@PostConstruct</code> \u548c <code>@PreDestroy</code> \u6ce8\u89e3\u3002\u66f4\u591a\u7ec6\u8282\u8bf7\u53c2\u89c1 JSR-250 annotations\u3002</p> <p>\u5e38\u89c4\u7684Spring\u751f\u547d\u5468\u671f\u56de\u8c03\u4e5f\u662f\u5b8c\u5168\u652f\u6301\u7684\u3002\u5982\u679c\u4e00\u4e2abean\u5b9e\u73b0\u4e86<code>InitializingBean</code>, <code>DisposableBean</code>\u6216<code>Lifecycle</code>\uff0c\u5b83\u4eec\u5404\u81ea\u7684\u65b9\u6cd5\u5c31\u4f1a\u88ab\u5bb9\u5668\u8c03\u7528\u3002</p> <p>\u6807\u51c6\u7684<code>*Aware</code>\u63a5\u53e3\u96c6\uff08\u5982BeanFactoryAware\u3001BeanNameAware\u3001MessageSourceAware\u3001ApplicationContextAware\u7b49\uff09\u4e5f\u662f\u5b8c\u5168\u652f\u6301\u7684\u3002</p> <p>@Bean\u6ce8\u89e3\u652f\u6301\u6307\u5b9a\u4efb\u610f\u7684\u521d\u59cb\u5316\u548c\u9500\u6bc1\u7684\u56de\u8c03\u65b9\u6cd5\uff0c\u5c31\u50cfSpring XML\u5728bean\u5143\u7d20\u4e0a\u7684init-method\u548cdestroy-method\u5c5e\u6027\u4e00\u6837\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>public class BeanOne {\n\n    public void init() {\n        // initialization logic\n    }\n}\n\npublic class BeanTwo {\n\n    public void cleanup() {\n        // destruction logic\n    }\n}\n\n@Configuration\npublic class AppConfig {\n\n    @Bean(initMethod = \"init\")\n    public BeanOne beanOne() {\n        return new BeanOne();\n    }\n\n    @Bean(destroyMethod = \"cleanup\")\n    public BeanTwo beanTwo() {\n        return new BeanTwo();\n    }\n}\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7528 Java \u914d\u7f6e\u7684\u5177\u6709\u516c\u5171<code>close</code>\u6216<code>shutdown</code>\u65b9\u6cd5\u7684 bean \u4f1a\u81ea\u52a8\u5730\u88ab\u5f81\u96c6\u4e00\u4e2a\u9500\u6bc1\u56de\u8c03\u3002\u5982\u679c\u60a8\u6709\u4e00\u4e2a\u516c\u5171\u7684\u5173\u95ed\u6216\u5173\u95ed\u65b9\u6cd5\uff0c\u5e76\u4e14\u60a8\u4e0d\u5e0c\u671b\u5b83\u5728\u5bb9\u5668\u5173\u95ed\u65f6\u88ab\u8c03\u7528\uff0c\u60a8\u53ef\u4ee5\u5c06@Bean(destroyMethod=\"\")\u6dfb\u52a0\u5230\u60a8\u7684bean\u5b9a\u4e49\u4e2d\u4ee5\u7981\u7528\u9ed8\u8ba4\uff08\u63a8\u65ad\uff09\u6a21\u5f0f\u3002</p> <pre><code>@Bean(destroyMethod=\"\")\npublic DataSource dataSource() throws NamingException {\n    return (DataSource) jndiTemplate.lookup(\"MyDS\");\n}\n</code></pre> <p>\u76f4\u63a5\u5728code\u4e2d\u8c03\u7528<code>init()</code>\u4e5f\u662f\u53ef\u4ee5\u7684</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public BeanOne beanOne() {\n        BeanOne beanOne = new BeanOne();\n        beanOne.init();\n        return beanOne;\n    }\n\n    // ...\n}\n</code></pre> <p>\u5f53\u4f60\u76f4\u63a5\u901a\u8fc7Java\u4ee3\u7801\u5de5\u4f5c\u65f6\uff0c\u4f60\u53ef\u4ee5\u5bf9\u4f60\u7684\u5bf9\u8c61\u505a\u4efb\u4f55\u4f60\u559c\u6b22\u7684\u4e8b\u60c5\uff0c\u800c\u4e0d\u662f\u603b\u662f\u9700\u8981\u4f9d\u8d56\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u3002</p>"},{"location":"java/spring/spring/IocContainer/#beanscope","title":"\u6307\u5b9aBean\u7684scope","text":"<p>Bean\u7684\u9ed8\u8ba4scope\u662f <code>singleton</code>,\u4f46\u662f\u53ef\u4ee5\u4f7f\u7528 <code>@Scope</code> \u6307\u5b9a</p> <pre><code>@Configuration\npublic class MyConfiguration {\n\n    @Bean\n    @Scope(\"prototype\")\n    public Encryptor encryptor() {\n        // ...\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#bean_6","title":"\u81ea\u5b9a\u4e49Bean\u7684\u540d\u79f0","text":"<p>\u4f7f\u7528name\u5c5e\u6027\u53ef\u4ee5\u6307\u5b9aBean\u7684\u540d\u79f0\uff0c\u9ed8\u8ba4Bean\u7684\u540d\u79f0\u662f\u65b9\u6cd5\u540d\u3002</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean(name = \"myThing\")\n    public Thing thing() {\n        return new Thing();\n    }\n}\n</code></pre> <pre><code>@Configuration\npublic class AppConfig {\n\n    // \u53ef\u4ee5\u6307\u5b9a\u591a\u4e2a\u522b\u540d Aliasing\n    @Bean({\"dataSource\", \"subsystemA-dataSource\", \"subsystemB-dataSource\"})\n    public DataSource dataSource() {\n        // instantiate, configure and return DataSource bean...\n    }\n}\n</code></pre> <pre><code>@Configuration\npublic class AppConfig {\n\n    // \u5bf9Bean\u8fdb\u884c\u63cf\u8ff0\uff0c\u5728\u4e00\u4e9b\u5982JMX\u8fde\u63a5\u65f6\u53ef\u4ee5\u63d0\u4f9b\u66f4\u591a\u4fe1\u606f\n    @Bean\n    @Description(\"Provides a basic example of a bean\")\n    public Thing thing() {\n        return new Thing();\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#1124-configuration","title":"1.12.4  <code>@Configuration</code>\u6ce8\u89e3\u7684\u4f7f\u7528","text":"<p><code>@Configuration</code> is a class-level annotation indicating that an object is a source of bean definitions. <code>@Configuration</code> classes declare beans through public <code>@Bean</code> annotated methods. Calls to <code>@Bean</code> methods on <code>@Configuration</code> classes can also be used to define inter-bean dependencies. See Basic Concepts: <code>@Bean</code> and <code>@Configuration</code> for a general introduction.</p> <p>@Configuration\u662f\u7c7b\u7ea7\u522b\u7684\u6ce8\u89e3\uff0c\u8868\u793a\u8be5\u662fBean\u5b9a\u4e49\u7684\u6e90\u3002<code>@Configuration</code>\u7c7b\u5185\u90e8\u901a\u8fc7@Bean\u6ce8\u89e3\u7684public\u65b9\u6cd5\u6765\u58f0\u660eBean\uff0c<code>@Configuration</code>\u7c7b\u4e2d\u7684@Bean\u65b9\u6cd5\u4e5f\u53ef\u4ee5\u7528\u6765\u58f0\u660eBean\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u3002</p>"},{"location":"java/spring/spring/IocContainer/#bean_7","title":"Bean\u4e4b\u95f4\u7684\u4f9d\u8d56\u8868\u8fbe","text":"<p>\u5f53Bean\u4f9d\u8d56\u53e6\u4e00\u4e2aBean\u65f6\uff0c\u53ea\u9700\u8981\u7b80\u5355\u7684\u8c03\u7528\u53e6\u4e00\u4e2aBean\u65b9\u6cd5\u5373\u53ef\uff0c\u4e3e\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public BeanOne beanOne() {\n        // \u901a\u8fc7beanTwo()\u6ce8\u5165BeanTwo\n        return new BeanOne(beanTwo());\n    }\n\n    @Bean\n    public BeanTwo beanTwo() {\n        return new BeanTwo();\n    }\n}\n</code></pre> <p>\u8fd9\u79cd\u901a\u8fc7\u65b9\u6cd5\u6765\u58f0\u660e\u4f9d\u8d56Bean\u7684\u65b9\u5f0f\u53ea\u80fd\u5728@Configuration\u7684\u7c7b\u4e2d\u4f7f\u7528\uff0c\u4e0d\u80fd\u7528\u4e8e@Component\u6ce8\u89e3\u7684\u7c7b\u4e2d\u3002</p>"},{"location":"java/spring/spring/IocContainer/#lookup-method-injection","title":"Lookup Method Injection","text":"<p>\u5982\u524d\u6240\u8ff0\uff0c\u67e5\u627e\u65b9\u6cd5\u6ce8\u5165\u662f\u4e00\u4e2a\u9ad8\u7ea7\u529f\u80fd\uff0c\u4f60\u5e94\u8be5\u5f88\u5c11\u4f7f\u7528\u3002\u5728\u5355\u4f8bBean\u4f9d\u8d56\u539f\u578bBean\u7684\u60c5\u51b5\u4e0b\uff0c\u5b83\u5f88\u6709\u7528\u3002\u4f7f\u7528Java\u8fdb\u884c\u8fd9\u79cd\u7c7b\u578b\u7684\u914d\u7f6e\uff0c\u4e3a\u5b9e\u73b0\u8fd9\u79cd\u6a21\u5f0f\u63d0\u4f9b\u4e86\u4e00\u79cd\u81ea\u7136\u7684\u624b\u6bb5\u3002\u4e0b\u9762\u4e3e\u4f8b\uff1a</p> <pre><code>public abstract class CommandManager {\n    public Object process(Object commandState) {\n        // \u83b7\u53d6\u4e00\u4e2a\u5408\u9002\u7684Command\u5b9e\u4f8b\n        Command command = createCommand();\n        // set the state on the (hopefully brand new) Command instance\n        command.setState(commandState);\n        return command.execute();\n    }\n\n    // \u4f46\u662f\u8c01\u6765\u5b9e\u73b0\u8fd9\u4e2a\u65b9\u6cd5\u5462\uff1f\n    protected abstract Command createCommand();\n}\n</code></pre> <p>By using Java configuration, you can create a subclass of <code>CommandManager</code> where the abstract <code>createCommand()</code> method is overridden in such a way that it looks up a new (prototype) command object. The following example shows how to do so:</p> <p>\u901a\u8fc7\u4f7f\u7528Java\u914d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u521b\u5efaCommandManager\u7684\u5b50\u7c7b\uff0c\u5176\u4e2d\u62bd\u8c61\u7684createCommand()\u65b9\u6cd5\u88ab\u91cd\u8f7d\uff0c\u4ee5\u4f7f\u5176\u67e5\u627e\u4e00\u4e2a\u65b0\u7684\uff08\u539f\u578b\uff09\u547d\u4ee4\u5bf9\u8c61\u3002</p> <pre><code>@Bean\n@Scope(\"prototype\")\npublic AsyncCommand asyncCommand() {\n    AsyncCommand command = new AsyncCommand();\n    // inject dependencies here as required\n    return command;\n}\n\n@Bean\npublic CommandManager commandManager() {\n    // return new anonymous implementation of CommandManager with createCommand()\n    // overridden to return a new prototype Command object\n    return new CommandManager() {\n        protected Command createCommand() {\n            return asyncCommand();\n        }\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#java-based","title":"\u8fdb\u4e00\u6b65\u63a2\u7a76Java-based\u7684\u914d\u7f6e\u5de5\u4f5c\u539f\u7406","text":"<p>\u8003\u8651\u4e0b\u9762\u4e00\u79cd\u573a\u666f\uff0c\u4e00\u4e2a@Bean\u65b9\u6cd5\u88ab\u8c03\u7528\u4e86\u4e24\u6b21\uff1a</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean\n    public ClientService clientService1() {\n        ClientServiceImpl clientService = new ClientServiceImpl();\n        clientService.setClientDao(clientDao());\n        return clientService;\n    }\n\n    @Bean\n    public ClientService clientService2() {\n        ClientServiceImpl clientService = new ClientServiceImpl();\n        clientService.setClientDao(clientDao());\n        return clientService;\n    }\n\n    @Bean\n    public ClientDao clientDao() {\n        return new ClientDaoImpl();\n    }\n}\n</code></pre> <p>ClientDao()\u5df2\u7ecf\u5728clientService1()\u548cclientService2()\u4e2d\u88ab\u8c03\u7528\u8fc7\u4e00\u6b21\u3002\u7531\u4e8e\u8be5\u65b9\u6cd5\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 ClientDaoImpl \u5b9e\u4f8b\u5e76\u5c06\u5176\u8fd4\u56de\uff0c\u60a8\u901a\u5e38\u4f1a\u671f\u671b\u6709\u4e24\u4e2a\u5b9e\u4f8b\uff08\u6bcf\u4e2a\u670d\u52a1\u4e00\u4e2a\uff09\u3002\u8fd9\u80af\u5b9a\u6709\u95ee\u9898\uff0c\u5728Spring\u4e2d\uff0c\u5b9e\u4f8b\u5316\u7684Bean\u9ed8\u8ba4\u662f\u5355\u4f8b\u7684\u3002\u8fd9\u5c31\u662f\u795e\u5947\u7684\u5730\u65b9\uff0c\u6240\u6709\u7684@Configuration\u7c7b\u5728\u542f\u52a8\u65f6\u90fd\u4f1a\u88abCGLIB\u5b9e\u73b0\u5b50\u7c7b\u3002\u5728\u5b50\u7c7b\u4e2d\uff0c\u91cd\u5199\u7684\u65b9\u6cd5\u9996\u5148\u4f1a\u68c0\u67e5\u5bb9\u5668\u4e2d\u662f\u5426\u6709\u7f13\u5b58\u7684Bean\uff0c\u6ca1\u6709\u624d\u4f1a\u53bb\u8c03\u7528\u7236\u65b9\u6cd5\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5b9e\u4f8b\u3002</p> <p>There are a few restrictions due to the fact that CGLIB dynamically adds features at startup-time. In particular, configuration classes must not be final. However, as of 4.3, any constructors are allowed on configuration classes, including the use of <code>@Autowired</code> or a single non-default constructor declaration for default injection.</p> <p>If you prefer to avoid any CGLIB-imposed limitations, consider declaring your <code>@Bean</code> methods on non-<code>@Configuration</code> classes (for example, on plain <code>@Component</code> classes instead). Cross-method calls between <code>@Bean</code> methods are not then intercepted, so you have to exclusively rely on dependency injection at the constructor or method level there.</p> <p>\u8fd9\u91cc\u6709\u4e00\u4e9b\u9650\u5236\uff0c\u56e0\u4e3aCGLIB\u662f\u5728\u8fd0\u884c\u65f6\u52a8\u6001\u7684\u6dfb\u52a0\u529f\u80fd\uff0c\u6240\u4ee5\u914d\u7f6e\u7c7b\u4e0d\u80fdfinal\u3002\u7136\u800c\u4eceSpring4.3\u5f00\u59cb\uff0c\u914d\u7f6e\u7c7b\u4e2d\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u6784\u9020\u65b9\u6cd5\uff0c\u5305\u62ec\u4f7f\u7528<code>@Autowired</code>\u6216\u8005\u975e\u9ed8\u8ba4\u7684\u6784\u9020\u6765\u8fdb\u884c\u9ed8\u8ba4\u6ce8\u5165\u3002</p> <p>\u5982\u679c\u4f60\u66f4\u503e\u5411\u4e8e\u907f\u514dCGLIB\u65bd\u52a0\u7684\u9650\u5236\uff0c\u4f60\u53ef\u4ee5\u5728\u975e<code>@Configuration</code>\u6ce8\u89e3\u7684\u7c7b\u4e2d\u4f7f\u7528@Bean\uff08\u5982\u4f7f\u7528@Component\u4ee3\u7406)\uff0c\u8fd9\u6837\uff0c@Bean\u65b9\u6cd5\u4e4b\u95f4\u7684\u4ea4\u53c9\u8c03\u7528\u5c31\u4e0d\u4f1a\u88ab\u62e6\u622a\uff0c\u4f60\u53ef\u4ee5\u5b8c\u5168\u4f9d\u8d56\u6784\u9020\u6216\u65b9\u6cd5\u7ea7\u522b\u7684\u6ce8\u5165\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1125-java-based","title":"1.12.5 Java-based\u914d\u7f6e\u7684\u7ec4\u5408\u4f7f\u7528","text":"<p>Spring\u2019s Java-based configuration\u5141\u8bb8\u4f60\u7ec4\u5408\u6ce8\u89e3\uff0c\u51cf\u5c11\u914d\u7f6e\u7684\u590d\u6742\u6027\u3002</p>"},{"location":"java/spring/spring/IocContainer/#import","title":"\u4f7f\u7528@Import\u6ce8\u89e3","text":"<p>\u8fd9\u4e2a\u6ce8\u89e3\u5141\u8bb8\u4f60\u4ece\u5176\u4ed6\u914d\u7f6e\u7c7b\u52a0\u8f7d@Bean\u5b9a\u4e49\uff0c\u5982\uff1a</p> <pre><code>@Configuration\npublic class ConfigA {\n\n    @Bean\n    public A a() {\n        return new A();\n    }\n}\n\n@Configuration\n@Import(ConfigA.class)\npublic class ConfigB {\n\n    @Bean\n    public B b() {\n        return new B();\n    }\n}\n</code></pre> <p>\u73b0\u5728\uff0c\u4f60\u4e0d\u9700\u8981\u5728\u5b9e\u4f8b\u5316\u5bb9\u5668\u7684\u65f6\u5019\u540c\u65f6\u6307\u5b9a <code>ConfigA.class</code> \u548c<code>ConfigB.class</code> \uff0c\u53ea\u9700\u8981\u660e\u786e\u7684\u6307\u5b9aConfigB\u5373\u53ef\uff0c</p> <pre><code>public static void main(String[] args) {\n    ApplicationContext ctx = new AnnotationConfigApplicationContext(ConfigB.class);\n\n    // now both beans A and B will be available...\n    A a = ctx.getBean(A.class);\n    B b = ctx.getBean(B.class);\n}\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u7b80\u5316\u4e86\u5bb9\u5668\u5b9e\u4f8b\u5316\uff0c\u4f60\u53ea\u9700\u8981\u5904\u7406\u4e00\u4e2a\u914d\u7f6e\u7c7b\uff0c\u800c\u4e0d\u662f\u8bb0\u4f4f\u6240\u6709\u7684\u914d\u7f6e\u7c7b\u3002</p> <p>\u4eceSpring4.2\uff0c@Import\u4e5f\u652f\u6301\u5bfc\u5165\u4e00\u4e2a\u666e\u901a\u7684Bean\uff0c\u7c7b\u4f3c<code>AnnotationConfigApplicationContext.register</code>\u65b9\u6cd5\uff0c\u8fd9\u5728\u4f60\u60f3\u907f\u514dcomponent scanning\uff0c\u53ea\u9700\u8981\u5f88\u5c11\u7684\u914d\u7f6e\u7c7b\u6765\u660e\u786e\u5b9a\u4e49\u4f60\u6240\u6709\u7684Components\u3002</p> <p>\u5728\u5bfc\u5165\u7684@Bean\u5b9a\u4e49\u4e0a\u6ce8\u5165\u4f9d\u8d56\u5173\u7cfb</p> <p>The preceding example works but is simplistic. In most practical scenarios, beans have dependencies on one another across configuration classes. When using XML, this is not an issue, because no compiler is involved, and you can declare <code>ref=\"someBean\"</code> and trust Spring to work it out during container initialization. When using <code>@Configuration</code> classes, the Java compiler places constraints on the configuration model, in that references to other beans must be valid Java syntax.</p> <p>Fortunately, solving this problem is simple. As we already discussed, a <code>@Bean</code> method can have an arbitrary number of parameters that describe the bean dependencies. Consider the following more real-world scenario with several <code>@Configuration</code> classes, each depending on beans declared in the others:</p> <p>\u524d\u9762\u7684\u4f8b\u5b50\u662f\u53ef\u884c\u7684\uff0c\u4f46\u5f88\u7b80\u5355\u3002\u5728\u5927\u591a\u6570\u5b9e\u9645\u573a\u666f\u4e2d\uff0cbean\u5728\u4e0d\u540c\u7684\u914d\u7f6e\u7c7b\u4e2d\u90fd\u6709\u76f8\u4e92\u4f9d\u8d56\u5173\u7cfb\u3002\u5f53\u4f7f\u7528XML\u65f6\uff0c\u8fd9\u4e0d\u662f\u95ee\u9898\uff0c\u56e0\u4e3a\u4e0d\u6d89\u53ca\u7f16\u8bd1\u5668\uff0c\u4f60\u53ef\u4ee5\u58f0\u660e<code>ref=\"someBean\"</code>\uff0c\u5e76\u76f8\u4fe1Spring\u4f1a\u5728\u5bb9\u5668\u521d\u59cb\u5316\u671f\u95f4\u89e3\u51b3\u5b83\u3002\u5f53\u4f7f\u7528<code>@Configuration</code>\u7c7b\u65f6\uff0cJava\u7f16\u8bd1\u5668\u4f1a\u5bf9\u914d\u7f6e\u6a21\u578b\u8fdb\u884c\u7ea6\u675f\uff0c\u5373\u5bf9\u5176\u4ed6bean\u7684\u5f15\u7528\u5fc5\u987b\u662f\u6709\u6548\u7684Java\u8bed\u6cd5\u3002</p> <p>\u5e78\u8fd0\u7684\u662f\uff0c\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5f88\u7b80\u5355\u3002\u6b63\u5982\u6211\u4eec\u5df2\u7ecf\u8ba8\u8bba\u8fc7\u7684\uff0c\u4e00\u4e2a<code>@Bean</code>\u65b9\u6cd5\u53ef\u4ee5\u6709\u4efb\u610f\u6570\u91cf\u7684\u53c2\u6570\u6765\u63cf\u8ff0bean\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u8003\u8651\u4ee5\u4e0b\u66f4\u771f\u5b9e\u7684\u573a\u666f\uff0c\u6709\u51e0\u4e2a<code>@Configuration</code>\u7c7b\uff0c\u6bcf\u4e2a\u7c7b\u90fd\u4f9d\u8d56\u4e8e\u5176\u4ed6\u7c7b\u4e2d\u58f0\u660e\u7684bean\u3002</p> <pre><code>@Configuration\npublic class ServiceConfig {\n\n    @Bean\n    public TransferService transferService(AccountRepository accountRepository) {\n        return new TransferServiceImpl(accountRepository);\n    }\n}\n\n@Configuration\npublic class RepositoryConfig {\n\n    @Bean\n    public AccountRepository accountRepository(DataSource dataSource) {\n        return new JdbcAccountRepository(dataSource);\n    }\n}\n\n@Configuration\n@Import({ServiceConfig.class, RepositoryConfig.class})\npublic class SystemTestConfig {\n\n    @Bean\n    public DataSource dataSource() {\n        // return new DataSource\n    }\n}\n\npublic static void main(String[] args) {\n    ApplicationContext ctx = new AnnotationConfigApplicationContext(SystemTestConfig.class);\n    // everything wires up across configuration classes...\n    TransferService transferService = ctx.getBean(TransferService.class);\n    transferService.transfer(100.00, \"A123\", \"C456\");\n}\n</code></pre> <p>\u8fd8\u6709\u53e6\u4e00\u79cd\u65b9\u6cd5\u53ef\u4ee5\u8fbe\u5230\u540c\u6837\u7684\u6548\u679c\u3002\u8bf7\u8bb0\u4f4f\uff0c@Configuration\u7c7b\u6700\u7ec8\u53ea\u662f\u5bb9\u5668\u4e2d\u7684\u53e6\u4e00\u4e2aBean\u3002\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u53ef\u4ee5\u50cf\u5176\u4ed6bean\u4e00\u6837\u5229\u7528@Autowired\u548c@Value\u6ce8\u5165\u4ee5\u53ca\u5176\u4ed6\u529f\u80fd\u3002</p> <p>\u786e\u4fdd\u4f60\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u6ce8\u5165\u7684\u4f9d\u8d56\u5173\u7cfb\u53ea\u662f\u6700\u7b80\u5355\u7684\u90a3\u79cd\u3002\u5728\u4e0a\u4e0b\u6587\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c@Configuration\u7c7b\u7684\u5904\u7406\u65f6\u95f4\u76f8\u5f53\u65e9\uff0c\u5f3a\u8feb\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u6ce8\u5165\u4f9d\u8d56\u5173\u7cfb\u53ef\u80fd\u4f1a\u5bfc\u81f4\u610f\u5916\u7684\u65e9\u671f\u521d\u59cb\u5316\u3002\u53ea\u8981\u6709\u53ef\u80fd\uff0c\u5c31\u50cf\u524d\u9762\u7684\u4f8b\u5b50\u4e00\u6837\uff0c\u91c7\u7528\u57fa\u4e8e\u53c2\u6570\u7684\u6ce8\u5165\u65b9\u5f0f\u3002</p> <p>\u53e6\u5916\uff0c\u5bf9\u4e8e\u901a\u8fc7@Bean\u5b9a\u4e49\u7684BeanPostProcessor\u548cBeanFactoryPostProcessor\u8981\u7279\u522b\u5c0f\u5fc3\u3002\u8fd9\u4e9b\u901a\u5e38\u5e94\u8be5\u88ab\u58f0\u660e\u4e3a\u9759\u6001\u7684@Bean\u65b9\u6cd5\uff0c\u800c\u4e0d\u662f\u89e6\u53d1\u5176\u5305\u542b\u914d\u7f6e\u7c7b\u7684\u5b9e\u4f8b\u5316\u3002\u5426\u5219\uff0c@Autowired\u548c@Value\u53ef\u80fd\u5bf9\u914d\u7f6e\u7c7b\u672c\u8eab\u4e0d\u8d77\u4f5c\u7528\uff0c\u56e0\u4e3a\u5b83\u6709\u53ef\u80fd\u6bd4AutowiredAnnotationBeanPostProcessor\u66f4\u65e9\u5730\u521b\u5efa\u5b83\u4f5c\u4e3abean\u5b9e\u4f8b\u3002</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u5c06\u4e00\u4e2aBean\u81ea\u52a8\u6ce8\u5165\u5230\u53e6\u4e00\u4e2aBean\uff1a</p> <pre><code>@Configuration\npublic class ServiceConfig {\n\n    @Autowired\n    private AccountRepository accountRepository;\n\n    @Bean\n    public TransferService transferService() {\n        return new TransferServiceImpl(accountRepository);\n    }\n}\n\n@Configuration\npublic class RepositoryConfig {\n\n    private final DataSource dataSource;\n\n    public RepositoryConfig(DataSource dataSource) {\n        this.dataSource = dataSource;\n    }\n\n    @Bean\n    public AccountRepository accountRepository() {\n        return new JdbcAccountRepository(dataSource);\n    }\n}\n\n@Configuration\n@Import({ServiceConfig.class, RepositoryConfig.class})\npublic class SystemTestConfig {\n\n    @Bean\n    public DataSource dataSource() {\n        // return new DataSource\n    }\n}\n\npublic static void main(String[] args) {\n    ApplicationContext ctx = new AnnotationConfigApplicationContext(SystemTestConfig.class);\n    // everything wires up across configuration classes...\n    TransferService transferService = ctx.getBean(TransferService.class);\n    transferService.transfer(100.00, \"A123\", \"C456\");\n}\n</code></pre> <p>Constructor injection in <code>@Configuration</code> classes is only supported as of Spring Framework 4.3. Note also that there is no need to specify <code>@Autowired</code> if the target bean defines only one constructor.</p> <p>\u5728@Configuration\u7c7b\u4e2d\u7684\u6784\u9020\u51fd\u6570\u6ce8\u5165\u53ea\u5728Spring Framework 4.3\u4e2d\u652f\u6301\u3002\u8fd8\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u76ee\u6807Bean\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6784\u9020\u51fd\u6570\uff0c\u5c31\u4e0d\u9700\u8981\u6307\u5b9a@Autowired\u3002</p> <p>\u5b8c\u5168\u5408\u683c\u7684beans \uff0c\u65b9\u4fbf\u5bfc\u822a</p> <p>\u5728\u524d\u9762\u7684\u65b9\u6848\u4e2d\uff0c\u4f7f\u7528@Autowired\u6548\u679c\u5f88\u597d\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86\u6240\u9700\u7684\u6a21\u5757\u5316\uff0c\u4f46\u662f\u786e\u5b9a\u81ea\u52a8\u751f\u6210\u7684bean\u5b9a\u4e49\u5230\u5e95\u662f\u5728\u54ea\u91cc\u58f0\u660e\u7684\uff0c\u8fd8\u662f\u6709\u4e9b\u6a21\u7cca\u3002\u4f8b\u5982\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u8d1f\u8d23<code>ServiceConfig</code>\u7684\u5f00\u53d1\u4eba\u5458\uff0c\u4f60\u600e\u4e48\u77e5\u9053<code>@Autowired AccountRepository</code> bean\u5230\u5e95\u662f\u5728\u54ea\u91cc\u58f0\u660e\u7684\uff1f\u5728\u4ee3\u7801\u4e2d\u5e76\u6ca1\u6709\u660e\u786e\uff0c\u8fd9\u53ef\u80fd\u5c31\u597d\u529e\u4e86\u3002\u8bf7\u8bb0\u4f4f\uff0cSpring Tools for Eclipse\u63d0\u4f9b\u7684\u5de5\u5177\u53ef\u4ee5\u5448\u73b0\u51fa\u663e\u793a\u6240\u6709\u4e1c\u897f\u5982\u4f55\u8fde\u63a5\u7684\u56fe\u8868\uff0c\u8fd9\u53ef\u80fd\u662f\u4f60\u6240\u9700\u8981\u7684\u5168\u90e8\u3002\u6b64\u5916\uff0c\u4f60\u7684Java IDE\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u627e\u5230AccountRepository\u7c7b\u578b\u7684\u6240\u6709\u58f0\u660e\u548c\u4f7f\u7528\uff0c\u5e76\u8fc5\u901f\u5411\u4f60\u5c55\u793a\u8fd4\u56de\u8be5\u7c7b\u578b\u7684@Bean\u65b9\u6cd5\u7684\u4f4d\u7f6e\u3002</p> <p>\u5728\u4e0d\u80fd\u63a5\u53d7\u8fd9\u79cd\u6a21\u68f1\u4e24\u53ef\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u60a8\u5e0c\u671b\u5728\u60a8\u7684IDE\u5185\u4ece\u4e00\u4e2a@Configuration\u7c7b\u76f4\u63a5\u5bfc\u822a\u5230\u53e6\u4e00\u4e2a@Configuration\u7c7b\uff0c\u8bf7\u8003\u8651\u5bf9\u914d\u7f6e\u7c7b\u672c\u8eab\u8fdb\u884c\u81ea\u52a8\u5e03\u7ebf\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>@Configuration\npublic class ServiceConfig {\n\n    @Autowired\n    private RepositoryConfig repositoryConfig;\n\n    @Bean\n    public TransferService transferService() {\n        // navigate 'through' the config class to the @Bean method!\n        return new TransferServiceImpl(repositoryConfig.accountRepository());\n    }\n}\n</code></pre> <p>\u5728\u524d\u9762\u7684\u60c5\u51b5\u4e0b\uff0cAccountRepository\u7684\u5b9a\u4e49\u662f\u5b8c\u5168\u660e\u786e\u7684\u3002\u7136\u800c\uff0cServiceConfig\u73b0\u5728\u4e0eRepositoryConfig\u7d27\u5bc6\u8026\u5408\u3002\u8fd9\u5c31\u662f\u6743\u8861\u3002\u901a\u8fc7\u4f7f\u7528\u57fa\u4e8e\u63a5\u53e3\u6216\u57fa\u4e8e\u62bd\u8c61\u7c7b\u7684@Configuration\u7c7b\uff0c\u53ef\u4ee5\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u7f13\u89e3\u8fd9\u79cd\u7d27\u8026\u5408\u3002\u8003\u8651\u4e0b\u9762\u7684\u4f8b\u5b50:</p> <pre><code>@Configuration\npublic class ServiceConfig {\n\n    @Autowired\n    private RepositoryConfig repositoryConfig;\n\n    @Bean\n    public TransferService transferService() {\n        return new TransferServiceImpl(repositoryConfig.accountRepository());\n    }\n}\n\n@Configuration\npublic interface RepositoryConfig {\n\n    @Bean\n    AccountRepository accountRepository();\n}\n\n@Configuration\npublic class DefaultRepositoryConfig implements RepositoryConfig {\n\n    @Bean\n    public AccountRepository accountRepository() {\n        return new JdbcAccountRepository(...);\n    }\n}\n\n@Configuration\n@Import({ServiceConfig.class, DefaultRepositoryConfig.class})  // import the concrete config!\npublic class SystemTestConfig {\n\n    @Bean\n    public DataSource dataSource() {\n        // return DataSource\n    }\n\n}\n\npublic static void main(String[] args) {\n    ApplicationContext ctx = new AnnotationConfigApplicationContext(SystemTestConfig.class);\n    TransferService transferService = ctx.getBean(TransferService.class);\n    transferService.transfer(100.00, \"A123\", \"C456\");\n}\n</code></pre> <p>\u73b0\u5728ServiceConfig\u4e0e\u5177\u4f53\u7684DefaultRepositoryConfig\u677e\u6563\u8026\u5408\uff0c\u5185\u7f6e\u7684IDE\u5de5\u5177\u4ecd\u7136\u6709\u7528\u3002\u4f60\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u5f97\u5230RepositoryConfig\u5b9e\u73b0\u7684\u7c7b\u578b\u5c42\u6b21\u7ed3\u6784\u3002\u8fd9\u6837\u4e00\u6765\uff0c\u5bfc\u822a@Configuration\u7c7b\u548c\u5b83\u4eec\u7684\u4f9d\u8d56\u5173\u7cfb\u5c31\u53d8\u5f97\u548c\u901a\u5e38\u5bfc\u822a\u57fa\u4e8e\u63a5\u53e3\u7684\u4ee3\u7801\u7684\u8fc7\u7a0b\u6ca1\u6709\u4ec0\u4e48\u4e0d\u540c\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u5f71\u54cd\u67d0\u4e9bbean\u7684\u542f\u52a8\u521b\u5efa\u987a\u5e8f\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u5176\u4e2d\u7684\u4e00\u4e9bbean\u58f0\u660e\u4e3a@Lazy\uff08\u7528\u4e8e\u5728\u9996\u6b21\u8bbf\u95ee\u65f6\u521b\u5efa\uff0c\u800c\u4e0d\u662f\u5728\u542f\u52a8\u65f6\u521b\u5efa\uff09\uff0c\u6216\u8005\u58f0\u660e\u4e3a@DependsOn\u67d0\u4e9b\u5176\u4ed6bean\uff08\u786e\u4fdd\u7279\u5b9a\u7684\u5176\u4ed6bean\u5728\u5f53\u524dbean\u4e4b\u524d\u521b\u5efa\uff0c\u8d85\u51fa\u540e\u8005\u7684\u76f4\u63a5\u4f9d\u8d56\u5173\u7cfb\u610f\u5473\u7740\u4ec0\u4e48\uff09\u3002</p>"},{"location":"java/spring/spring/IocContainer/#configurationbean","title":"\u6709\u6761\u4ef6\u5730\u5305\u542b@Configuration\u7c7b\u6216@Bean\u65b9\u6cd5","text":"<p>\u57fa\u4e8e\u4e00\u4e9b\u4efb\u610f\u7684\u7cfb\u7edf\u72b6\u6001\uff0c\u6709\u6761\u4ef6\u5730\u542f\u7528\u6216\u7981\u7528\u4e00\u4e2a\u5b8c\u6574\u7684@Configuration\u7c7b\uff0c\u751a\u81f3\u662f\u5355\u4e2a\u7684@Bean\u65b9\u6cd5\uff0c\u901a\u5e38\u662f\u5f88\u6709\u7528\u7684\u3002\u4e00\u4e2a\u5e38\u89c1\u7684\u4f8b\u5b50\u662f\u4f7f\u7528@Profile\u6ce8\u89e3\u4ec5\u5728Spring\u73af\u5883\u4e2d\u542f\u7528\u4e86\u7279\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u65f6\u624d\u6fc0\u6d3bbean\uff08\u8be6\u89c1 Bean Definition Profiles\uff09\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c@Profile \u6ce8\u89e3\u662f\u901a\u8fc7\u4f7f\u7528\u540d\u4e3a <code>@Conditional</code> \u8fd9\u4e2a\u66f4\u7075\u6d3b\u7684\u6ce8\u89e3\u6765\u5b9e\u73b0\u7684\u3002@Conditional\u6ce8\u89e3\u6307\u793a\u4e86\u5728\u6ce8\u518c@Bean\u4e4b\u524d\u5e94\u8be5\u53c2\u8003\u7684\u7279\u5b9a<code>org.springframework.context.annotation.Condition</code>\u5b9e\u73b0\u3002</p> <p>Condition\u63a5\u53e3\u7684\u5b9e\u73b0\u63d0\u4f9b\u4e86\u4e00\u4e2amatch(...)\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u8fd4\u56detrue\u6216false\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u5217\u8868\u663e\u793a\u4e86\u5b9e\u9645\u7528\u4e8e@Profile\u7684Condition\u5b9e\u73b0:</p> <pre><code>@Override\npublic boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {\n    // Read the @Profile annotation attributes\n    MultiValueMap&lt;String, Object&gt; attrs = metadata.getAllAnnotationAttributes(Profile.class.getName());\n    if (attrs != null) {\n        for (Object value : attrs.get(\"value\")) {\n            if (context.getEnvironment().acceptsProfiles(((String[]) value))) {\n                return true;\n            }\n        }\n        return false;\n    }\n    return true;\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#combining-java-and-xml-configuration","title":"Combining Java and XML Configuration","text":"<p>\u5728 @Configuration \u7c7b\u662f\u914d\u7f6e\u5bb9\u5668\u7684\u4e3b\u8981\u673a\u5236\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u4ecd\u7136\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u81f3\u5c11\u4e00\u4e9b XML\u3002\u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 @ImportResource \u5e76\u53ea\u5b9a\u4e49\u60a8\u9700\u8981\u7684 XML\u3002\u8fd9\u6837\u505a\u5b9e\u73b0\u4e86\u4e00\u79cd \"\u4ee5Java\u4e3a\u4e2d\u5fc3 \"\u7684\u914d\u7f6e\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u5e76\u5c06XML\u4fdd\u6301\u5728\u6700\u4f4e\u9650\u5ea6\u3002</p>"},{"location":"java/spring/spring/IocContainer/#113-environment","title":"1.13  Environment \u7684\u62bd\u8c61","text":"<p>The <code>Environment</code> interface is an abstraction integrated in the container that models two key aspects of the application environment: profiles and properties.</p> <p>A profile is a named, logical group of bean definitions to be registered with the container only if the given profile is active. Beans may be assigned to a profile whether defined in XML or with annotations. The role of the <code>Environment</code> object with relation to profiles is in determining which profiles (if any) are currently active, and which profiles (if any) should be active by default.</p> <p>Properties  play an important role in almost all applications and may originate from a variety of sources: properties files, JVM system properties, system environment variables, JNDI, servlet context parameters, ad-hoc <code>Properties</code> objects, <code>Map</code> objects, and so on. The role of the <code>Environment</code> object with relation to properties is to provide the user with a convenient service interface for configuring property sources and resolving properties from them.</p> <p><code>Environment</code>\u662f\u96c6\u6210\u5728\u5bb9\u5668\u4e2d\u7684\u4e00\u4e2a\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5efa\u6a21\u4e86\u5e94\u7528\u7a0b\u5e8f\u7684\u4e24\u4e2a\u5173\u952e\u65b9\u9762\uff1a profiles and properties.</p> <p>profile\u662f\u4e00\u4e2a\u547d\u540d\u7684\uff0c\u903b\u8f91\u7684Bean\u5b9a\u4e49\u7ec4\u3002\u53ea\u6709\u5728\u7ed9\u5b9a\u7684profile\u6fc0\u6d3b\u65f6\u624d\u4f1a\u6ce8\u518c\u5230\u5bb9\u5668\u3002\u4e0d\u7ba1\u662f\u5728XML\u5b9a\u4e49\u8fd8\u662f\u7528\u6ce8\u89e3\uff0cbean\u90fd\u53ef\u4ee5\u88ab\u5206\u914d\u7ed9profile\u3002<code>Environment</code>\u548c\u5173\u8054\u7684Profiles\u7684\u4f5c\u7528\u5c31\u662f\u786e\u5b9a\u54ea\u4e9bProfiles\uff08\u5982\u679c\u6709\u7684\u8bdd\uff09\u662f\u6fc0\u6d3b\u7684\uff0c\u54ea\u4e9b\u662f\u5728\u9ed8\u8ba4\u65f6\u6fc0\u6d3b\u7684\u3002</p> <p>Properties \u5728\u51e0\u4e4e\u6240\u6709\u7684\u5e94\u7528\u4e2d\u90fd\u626e\u6f14\u7740\u91cd\u8981\u7684\u89d2\u8272\uff0c\u53ef\u80fd\u6765\u81ea\uff1aproperties files\uff0c JVM system properties\u7cfb\u7edf\u5c5e\u6027\uff0csystem environment variables\u73af\u5883\u53d8\u91cf\uff0cJNDI\uff0c servlet \u4e0a\u4e0b\u6587\u53c2\u6570\uff0c\u7279\u5b9a\u7684\u5c5e\u6027\u5bf9\u8c61\uff0cmap\u5bf9\u8c61\u7b49\u7b49\u3002<code>Environment</code> \u548c\u5173\u8054\u5c5e\u6027\uff0c\u5176\u4f5c\u7528\u662f\u4e3a\u7528\u6237\u63d0\u4f9b\u4e00\u4e2a\u65b9\u4fbf\u7684\u63a5\u53e3\uff0c\u7528\u4e8e\u914d\u7f6e\u5c5e\u6027\u6765\u6e90\u548c\u4ece\u4e2d\u89e3\u6790\u5c5e\u6027\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1131-beanprofiles","title":"1.13.1 Bean\u5b9a\u4e49\u7684Profiles","text":"<p>Bean\u5b9a\u4e49profiles \u5728\u6838\u5fc3\u5bb9\u5668\u4e2d\u63d0\u4f9b\u4e86\u4e00\u79cd\u673a\u5236\uff0c\u5141\u8bb8\u5728\u4e0d\u540c\u73af\u5883\u4e2d\u6ce8\u518c\u4e0d\u540c\u7684Bean\u3002\"environment\"\u8fd9\u4e2a\u8bcd\uff0c\u5bf9\u4e0d\u540c\u7684\u7528\u6237\u6765\u8bf4\u53ef\u80fd\u610f\u5473\u7740\u4e0d\u540c\u7684\u4e1c\u897f\uff0c\u8fd9\u4e2a\u529f\u80fd\u53ef\u4ee5\u5e2e\u52a9\u5b9e\u73b0\u8bb8\u591a\u573a\u666f\uff0c\u5305\u62ec\uff1a</p> <p>\u5728\u5f00\u53d1\u4e2d\u4ece\u5185\u5b58\u4e2d\u7684\u6570\u636e\u6e90\u5de5\u4f5c\uff0c\u800c\u5728QA\u6216\u751f\u4ea7\u4e2d\u5219\u4eceJNDI\u4e2d\u67e5\u627e\u76f8\u540c\u7684\u6570\u636e\u6e90\u3002</p> <p>\u4ec5\u5728\u5c06\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u6027\u80fd\u73af\u5883\u4e2d\u65f6\u624d\u6ce8\u518c\u76d1\u63a7\u57fa\u7840\u8bbe\u65bd\u3002</p> <p>\u4e3a\u5ba2\u6237A\u548c\u5ba2\u6237B\u7684\u90e8\u7f72\u6ce8\u518c\u81ea\u5b9a\u4e49\u7684Bean\u5b9e\u73b0\u3002</p> <p>\u8003\u8651\u5b9e\u9645\u5e94\u7528\u4e2d\u7684\u7b2c\u4e00\u4e2a\u7528\u4f8b\uff0c\u5b83\u9700\u8981\u4e00\u4e2a\u6570\u636e\u6e90\u3002\u5728\u6d4b\u8bd5\u73af\u5883\u4e2d\uff0c\u914d\u7f6e\u53ef\u80fd\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u60c5\u51b5\uff1a</p> <pre><code>@Bean\npublic DataSource dataSource() {\n    return new EmbeddedDatabaseBuilder()\n        .setType(EmbeddedDatabaseType.HSQL)\n        .addScript(\"my-schema.sql\")\n        .addScript(\"my-test-data.sql\")\n        .build();\n}\n</code></pre> <p>\u73b0\u5728\u8003\u8651\u5982\u4f55\u5c06\u6b64\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230QA\u6216\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5047\u8bbe\u5e94\u7528\u7a0b\u5e8f\u7684\u6570\u636e\u6e90\u5728\u751f\u4ea7\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\u7684JNDI\u76ee\u5f55\u4e2d\u6ce8\u518c\u3002\u6211\u4eec\u7684dataSource bean\u73b0\u5728\u770b\u8d77\u6765\u50cf\u4e0b\u9762\u7684\u5217\u8868\u3002</p> <pre><code>@Bean(destroyMethod=\"\")\npublic DataSource dataSource() throws Exception {\n    Context ctx = new InitialContext();\n    return (DataSource) ctx.lookup(\"java:comp/env/jdbc/datasource\");\n}\n</code></pre> <p>\u95ee\u9898\u662f\u5982\u4f55\u6839\u636e\u5f53\u524d\u73af\u5883\u5728\u4f7f\u7528\u8fd9\u4e24\u79cd\u53d8\u5316\u4e4b\u95f4\u8fdb\u884c\u5207\u6362\u3002\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0cSpring\u7684\u7528\u6237\u5df2\u7ecf\u8bbe\u8ba1\u4e86\u8bb8\u591a\u65b9\u6cd5\u6765\u5b8c\u6210\u8fd9\u4e2a\u4efb\u52a1\uff0c\u901a\u5e38\u4f9d\u8d56\u4e8e\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u548c\u5305\u542b${placeholder}\u6807\u8bb0\u7684XML \u8bed\u53e5\u7684\u7ec4\u5408\uff0c\u8fd9\u4e9b\u6807\u8bb0\u6839\u636e\u73af\u5883\u53d8\u91cf\u7684\u503c\u89e3\u6790\u5230\u6b63\u786e\u7684\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u3002Bean\u5b9a\u4e49profiles\u662f\u6838\u5fc3\u5bb9\u5668\u7684\u7279\u6027\uff0c\u5b83\u4e3a\u8fd9\u4e2a\u95ee\u9898\u63d0\u4f9b\u4e86\u4e00\u4e2a\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5c06\u524d\u9762\u73af\u5883\u7279\u5b9a\u7684bean\u5b9a\u4e49\u793a\u4f8b\u4e2d\u6240\u793a\u7684\u7528\u4f8b\u8fdb\u884c\u6cdb\u5316\uff0c\u6211\u4eec\u6700\u7ec8\u9700\u8981\u5728\u67d0\u4e9b\u73af\u5883\u4e2d\u6ce8\u518c\u67d0\u4e9bbean\u5b9a\u4e49\uff0c\u800c\u5728\u5176\u4ed6\u73af\u5883\u4e2d\u5219\u4e0d\u9700\u8981\u3002\u4f60\u53ef\u4ee5\u8bf4\uff0c\u4f60\u60f3\u5728\u60c5\u51b5A\u4e2d\u6ce8\u518c\u67d0\u4e2aBean\u5b9a\u4e49\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u5728\u60c5\u51b5B\u4e2d\u6ce8\u518c\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u9996\u5148\u66f4\u65b0\u6211\u4eec\u7684\u914d\u7f6e\u6765\u53cd\u6620\u8fd9\u4e2a\u9700\u6c42\u3002</p> <p>\u4f7f\u7528@Profile</p> <p>\u901a\u8fc7@Profile\u6ce8\u89e3\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u5f53\u4e00\u4e2a\u6216\u591a\u4e2a\u6307\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u6fc0\u6d3b\u65f6\uff0c\u4e00\u4e2acomponent \u624d\u6709\u8d44\u683c\u8fdb\u884c\u6ce8\u518c\u3002\u4f7f\u7528\u6211\u4eec\u524d\u9762\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u53ef\u4ee5\u91cd\u5199dataSource\u914d\u7f6e\u5982\u4e0b\u3002</p> <pre><code>@Configuration\n@Profile(\"development\")\npublic class StandaloneDataConfig {\n\n    @Bean\n    public DataSource dataSource() {\n        return new EmbeddedDatabaseBuilder()\n            .setType(EmbeddedDatabaseType.HSQL)\n            .addScript(\"classpath:com/bank/config/sql/schema.sql\")\n            .addScript(\"classpath:com/bank/config/sql/test-data.sql\")\n            .build();\n    }\n}\n</code></pre> <pre><code>@Configuration\n@Profile(\"production\")\npublic class JndiDataConfig {\n\n    @Bean(destroyMethod=\"\")\n    public DataSource dataSource() throws Exception {\n        Context ctx = new InitialContext();\n        return (DataSource) ctx.lookup(\"java:comp/env/jdbc/datasource\");\n    }\n}\n</code></pre> <p>profile string\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u7b80\u5355\u7684profile \u540d\u79f0\uff08\u4f8b\u5982<code>production</code>\uff09\u6216profile \u8868\u8fbe\u5f0f\u3002profile \u8868\u8fbe\u5f0f\u5141\u8bb8\u8868\u8fbe\u66f4\u590d\u6742\u7684\u914d\u7f6e\u6587\u4ef6\u903b\u8f91\uff08\u4f8b\u5982\uff0cproduction &amp; us-east\uff09\u3002\u914d\u7f6e\u6587\u4ef6\u8868\u8fbe\u5f0f\u4e2d\u652f\u6301\u4ee5\u4e0b\u8fd0\u7b97\u7b26: <code>! &amp; |</code>\u975e \u4e0e \u6216\u7684\u903b\u8f91\u6982\u5ff5\u3002</p> <p>\u4f60\u4e0d\u80fd\u5728\u6ca1\u6709\u62ec\u53f7\u65f6\u6df7\u5408\u4f7f\u7528 <code>&amp;</code> and <code>|</code> operators . \u4f8b\u5982 <code>production &amp; us-east | eu-central</code> \u4e0d\u662f\u4e00\u4e2a\u5408\u6cd5\u7684\u8868\u8fbe\u5f0f. It must be expressed as <code>production &amp; (us-east | eu-central)</code>.</p> <p>\u5982\u679c\u4e00\u4e2a@Configuration\u7c7b\u88ab\u6807\u8bb0\u4e3a@Profile\uff0c\u90a3\u4e48\u4e0e\u8be5\u7c7b\u76f8\u5173\u7684\u6240\u6709@Bean\u65b9\u6cd5\u548c@Import\u6ce8\u89e3\u90fd\u4f1a\u88ab\u7ed5\u8fc7\uff0c\u9664\u975e\u4e00\u4e2a\u6216\u591a\u4e2a\u6307\u5b9a\u7684profile\u662f\u6d3b\u52a8\u7684\u3002\u5982\u679c\u4e00\u4e2a@Component\u6216@Configuration\u7c7b\u88ab\u6807\u8bb0\u4e3a@Profile({\"p1\", \"p2\"})\uff0c\u90a3\u4e48\u9664\u975e\u914d\u7f6e\u6587\u4ef6'p1'\u6216'p2'\u88ab\u6fc0\u6d3b\uff0c\u5426\u5219\u8be5\u7c7b\u4e0d\u4f1a\u88ab\u6ce8\u518c\u6216\u5904\u7406\u3002\u5982\u679c\u7ed9\u5b9a\u7684profile\u524d\u7f00\u6709NOT\u64cd\u4f5c\u7b26(!)\uff0c\u5219\u53ea\u6709\u5728profile\u672a\u6fc0\u6d3b\u7684\u60c5\u51b5\u4e0b\u624d\u4f1a\u6ce8\u518c\u88ab\u6ce8\u89e3\u7684\u5143\u7d20\u3002\u4f8b\u5982\uff0c\u7ed9\u5b9a@Profile({\"p1\", \"!p2\"})\uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6'p1'\u5df2\u6fc0\u6d3b\u6216\u914d\u7f6e\u6587\u4ef6'p2'\u672a\u6fc0\u6d3b\uff0c\u5219\u6ce8\u518c\u5c06\u53d1\u751f\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528@profile\u4f5c\u4e3a\u5143\u6ce8\u89e3\u6765\u81ea\u5b9a\u4e49\u81ea\u5df1\u7684\u6ce8\u89e3\uff1a</p> <pre><code>@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Profile(\"production\")\npublic @interface Production {\n}\n</code></pre> <p>@Profile\u4e5f\u53ef\u4ee5\u5728\u65b9\u6cd5\u5c42\u58f0\u660e\uff0c\u53ea\u5305\u542b\u4e00\u4e2a\u914d\u7f6e\u7c7b\u7684\u7279\u5b9abean\uff08\u4f8b\u5982\uff0c\u5bf9\u4e8e\u7279\u5b9abean\u7684\u66ff\u4ee3\u53d8\u4f53\uff09\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>@Configuration\npublic class AppConfig {\n\n    @Bean(\"dataSource\")\n    @Profile(\"development\") // development\u88ab\u6fc0\u6d3b\u65f6\u624d\u4f1a\u6ce8\u518c\n    public DataSource standaloneDataSource() {\n        return new EmbeddedDatabaseBuilder()\n            .setType(EmbeddedDatabaseType.HSQL)\n            .addScript(\"classpath:com/bank/config/sql/schema.sql\")\n            .addScript(\"classpath:com/bank/config/sql/test-data.sql\")\n            .build();\n    }\n\n    @Bean(\"dataSource\")\n    @Profile(\"production\") // production\u88ab\u6fc0\u6d3b\u65f6\u624d\u4f1a\u6ce8\u518c\n    public DataSource jndiDataSource() throws Exception {\n        Context ctx = new InitialContext();\n        return (DataSource) ctx.lookup(\"java:comp/env/jdbc/datasource\");\n    }\n}\n</code></pre> <p>\u5728@Bean\u65b9\u6cd5\u4e0a\u4f7f\u7528@Profile\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5\u3002\u5728\u540c\u4e00Java\u65b9\u6cd5\u540d\u7684\u91cd\u8f7d@Bean\u65b9\u6cd5\u7684\u60c5\u51b5\u4e0b\uff08\u7c7b\u4f3c\u4e8e\u6784\u9020\u51fd\u6570\u91cd\u8f7d\uff09\uff0c\u9700\u8981\u5728\u6240\u6709\u91cd\u8f7d\u65b9\u6cd5\u4e0a\u4e00\u81f4\u5730\u58f0\u660e\u4e00\u4e2a@Profile\u6761\u4ef6\u3002\u5982\u679c\u6761\u4ef6\u4e0d\u4e00\u81f4\uff0c\u53ea\u6709\u91cd\u8f7d\u65b9\u6cd5\u4e2d\u7b2c\u4e00\u4e2a\u58f0\u660e\u7684\u6761\u4ef6\u624d\u91cd\u8981\u3002\u56e0\u6b64\uff0c@Profile\u4e0d\u80fd\u7528\u6765\u9009\u62e9\u4e00\u4e2a\u5177\u6709\u7279\u5b9a\u53c2\u6570\u7b7e\u540d\u7684\u91cd\u8f7d\u65b9\u6cd5\u800c\u4e0d\u662f\u53e6\u4e00\u4e2a\u3002\u5728\u521b\u5efa\u65f6\uff0c\u540c\u4e00bean\u7684\u6240\u6709\u5de5\u5382\u65b9\u6cd5\u4e4b\u95f4\u7684\u89e3\u6790\u9075\u5faaSpring\u7684\u6784\u9020\u51fd\u6570\u89e3\u6790\u7b97\u6cd5\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u5b9a\u4e49\u5177\u6709\u4e0d\u540c\u914d\u7f6e\u6587\u4ef6\u6761\u4ef6\u7684\u5907\u9009Bean\uff0c\u8bf7\u4f7f\u7528\u4e0d\u540c\u7684Java\u65b9\u6cd5\u540d\uff0c\u901a\u8fc7\u4f7f\u7528@Bean\u540d\u5c5e\u6027\u6307\u5411\u540c\u4e00\u4e2aBean\u540d\uff0c\u5982\u524d\u4f8b\u6240\u793a\u3002\u5982\u679c\u53c2\u6570\u7b7e\u540d\u90fd\u662f\u76f8\u540c\u7684\uff08\u4f8b\u5982\uff0c\u6240\u6709\u7684\u53d8\u4f53\u90fd\u6709\u65e0\u53c2\u6570\u7684\u5de5\u5382\u65b9\u6cd5\uff09\uff0c\u8fd9\u662f\u9996\u5148\u5728\u4e00\u4e2a\u6709\u6548\u7684Java\u7c7b\u4e2d\u8868\u793a\u8fd9\u79cd\u5b89\u6392\u7684\u552f\u4e00\u65b9\u6cd5\uff08\u56e0\u4e3a\u53ea\u80fd\u6709\u4e00\u4e2a\u7279\u5b9a\u540d\u79f0\u548c\u53c2\u6570\u7b7e\u540d\u7684\u65b9\u6cd5\uff09\u3002</p> <p>\u6fc0\u6d3bProfile</p> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u66f4\u65b0\u4e86\u914d\u7f6e\uff0c\u6211\u4eec\u4ecd\u7136\u9700\u8981\u6307\u793aSpring\u54ea\u4e2a\u914d\u7f6e\u6587\u4ef6\u662f\u6d3b\u52a8\u7684\u3002\u5982\u679c\u6211\u4eec\u73b0\u5728\u542f\u52a8\u6211\u4eec\u7684\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e00\u4e2aNoSuchBeanDefinitionException\u629b\u51fa\uff0c\u56e0\u4e3a\u5bb9\u5668\u627e\u4e0d\u5230\u540d\u4e3adataSource\u7684Spring bean\u3002</p> <p>\u6fc0\u6d3bprofile\u53ef\u4ee5\u901a\u8fc7\u591a\u79cd\u65b9\u5f0f\u8fdb\u884c\uff0c\u4f46\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\u662f\u901a\u8fc7ApplicationContext\u5bf9Environment API\u8fdb\u884c\u7f16\u7a0b\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\u3002</p> <pre><code>AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();\nctx.getEnvironment().setActiveProfiles(\"development\");\nctx.register(SomeConfig.class, StandaloneDataConfig.class, JndiDataConfig.class);\nctx.refresh();\n</code></pre> <p>\u6b64\u5916\uff0c\u4f60\u8fd8\u53ef\u4ee5\u901a\u8fc7spring.profile.active\u5c5e\u6027\u6765\u58f0\u660e\u6fc0\u6d3bprofile\uff0c\u5b83\u53ef\u4ee5\u901a\u8fc7\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u3001JVM\u7cfb\u7edf\u5c5e\u6027\u3001web.xml\u4e2d\u7684servlet\u4e0a\u4e0b\u6587\u53c2\u6570\uff0c\u751a\u81f3\u4f5c\u4e3aJNDI\u4e2d\u7684\u4e00\u4e2a\u6761\u76ee\u6765\u6307\u5b9a\uff08see <code>PropertySource</code> Abstraction\uff09\u3002\u5728\u96c6\u6210\u6d4b\u8bd5\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528spring-test\u6a21\u5757\u4e2d\u7684@ActiveProfiles\u6ce8\u89e3\u6765\u58f0\u660e\u6d3b\u52a8\u914d\u7f6e\u6587\u4ef6\uff08see context configuration with environment profiles\uff09\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u914d\u7f6e\u6587\u4ef6\u4e0d\u662f\u4e00\u4e2a \"\u975e\u6b64\u5373\u5f7c \"\u7684\u547d\u9898\u3002\u4f60\u53ef\u4ee5\u540c\u65f6\u6fc0\u6d3b\u591a\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002\u5728\u7f16\u7a0b\u4e0a\uff0c\u60a8\u53ef\u4ee5\u4e3a setActiveProfiles() \u65b9\u6cd5\u63d0\u4f9b\u591a\u4e2a profiles \u540d\u79f0\uff0c\u8be5\u65b9\u6cd5\u63a5\u53d7\u6570\u7ec4 String... varargs\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u53ef\u4ee5\u6fc0\u6d3b\u591a\u4e2aprofiles <code>ctx.getEnvironment().setActiveProfiles(\"profile1\", \"profile2\");</code></p> <p>\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u901a\u8fc7\u9017\u53f7\u5206\u9694\uff0c<code>-Dspring.profiles.active=\"profile1,profile2\"</code></p> <p>Default Profile</p> <p>default profile\u8868\u793a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u542f\u7528\uff1a</p> <pre><code>@Configuration\n@Profile(\"default\")\npublic class DefaultDataConfig {\n\n    @Bean\n    public DataSource dataSource() {\n        return new EmbeddedDatabaseBuilder()\n            .setType(EmbeddedDatabaseType.HSQL)\n            .addScript(\"classpath:com/bank/config/sql/schema.sql\")\n            .build();\n    }\n}\n</code></pre> <p>\u5982\u679c\u6ca1\u6709profile\u88ab\u6fc0\u6d3b\uff0c\u5c31\u4f1a\u521b\u5efa\u8fd9\u4e2adataSource\u3002\u4f60\u53ef\u4ee5\u628a\u5b83\u770b\u4f5c\u662f\u4e3a\u4e00\u4e2a\u6216\u591a\u4e2abean\u63d0\u4f9b\u9ed8\u8ba4\u5b9a\u4e49\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u5982\u679c\u542f\u7528\u4e86\u4efb\u4f55\u914d\u7f6e\u6587\u4ef6\uff0c\u5219\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e0d\u9002\u7528\u3002</p> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u73af\u5883\u4e2d\u7684setDefaultProfiles()\u6216\u58f0\u660e\u6027\u5730\u4f7f\u7528spring.profile.default\u5c5e\u6027\u6765\u66f4\u6539\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u7684\u540d\u79f0\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1132-propertysource","title":"1.13.2 <code>PropertySource</code>\u7684\u62bd\u8c61","text":"<p>Spring\u7684 Environment\u5728\u53ef\u914d\u7f6e\u7684\u5c5e\u6027\u6e90\u5c42\u6b21\u4e0a\u63d0\u4f9b\u641c\u7d22\u64cd\u4f5c</p> <pre><code>ApplicationContext ctx = new GenericApplicationContext();\nEnvironment env = ctx.getEnvironment();\nboolean containsMyProperty = env.containsProperty(\"my-property\");\nSystem.out.println(\"Does my environment contain the 'my-property' property? \" + containsMyProperty);\n</code></pre> <p>\u5728\u8fd9\u6bb5\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u770b\u5230\u4e86\u8be2\u95eeSpring\u662f\u5426\u4e3a\u5f53\u524d\u73af\u5883\u5b9a\u4e49\u4e86my-property\u5c5e\u6027\u7684\u9ad8\u7ea7\u65b9\u6cd5\u3002\u4e3a\u4e86\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\uff0cEnvironment\u5bf9\u8c61\u5728\u4e00\u7ec4PropertySource\u5bf9\u8c61\u4e0a\u6267\u884c\u641c\u7d22\u3002PropertySource\u662f\u5bf9\u4efb\u4f55\u6765\u6e90 key-value \u952e\u503c\u5bf9\u7684\u7b80\u5355\u62bd\u8c61\uff0cSpring\u7684StandardEnvironment\u914d\u7f6e\u4e86\u4e24\u4e2aPropertySource\u5bf9\u8c61--\u4e00\u4e2a\u4ee3\u8868JVM\u7cfb\u7edf\u5c5e\u6027\u96c6\uff08System.getProperties()\uff09\uff0c\u4e00\u4e2a\u4ee3\u8868\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u96c6\uff08System.getenv()\uff09\u3002</p> <p>\u8fd9\u4e9b\u9ed8\u8ba4\u5c5e\u6027\u6e90\u5b58\u5728\u4e8eStandardEnvironment\u4e2d\uff0c\u7528\u4e8e\u72ec\u7acb\u7684\u5e94\u7528\u7a0b\u5e8f\u3002StandardServletEnvironment\u88ab\u586b\u5145\u4e86\u989d\u5916\u7684\u9ed8\u8ba4\u5c5e\u6027\u6e90\uff0c\u5305\u62ecservlet config\u548cservlet\u4e0a\u4e0b\u6587\u53c2\u6570\u3002\u5b83\u53ef\u4ee5\u9009\u62e9\u542f\u7528\u4e00\u4e2aJndiPropertySource\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u5f53\u4f60\u4f7f\u7528StandardEnvironment\u65f6\uff0c\u5982\u679c\u8fd0\u884c\u65f6\u5b58\u5728my-property\u7cfb\u7edf\u5c5e\u6027\u6216my-property\u73af\u5883\u53d8\u91cf\uff0c\u5219\u8c03\u7528env.containsProperty(\"my-property\")\u8fd4\u56detrue\u3002</p> <p>The search performed is hierarchical. By default, system properties have precedence over environment variables. So, if the <code>my-property</code> property happens to be set in both places during a call to <code>env.getProperty(\"my-property\")</code>, the system property value \u201cwins\u201d and is returned. Note that property values are not merged but rather completely overridden by a preceding entry.</p> <p>For a common <code>StandardServletEnvironment</code>, the full hierarchy is as follows, with the highest-precedence entries at the top:</p> <p>\u6267\u884c\u7684\u641c\u7d22\u662f\u5206\u5c42\u7684\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7cfb\u7edf\u5c5e\u6027\u4f18\u5148\u4e8e\u73af\u5883\u53d8\u91cf\u3002\u56e0\u6b64\uff0c\u5982\u679c\u5728\u8c03\u7528env.getProperty(\"my-property\")\u7684\u8fc7\u7a0b\u4e2d\uff0cmy-property\u5c5e\u6027\u6070\u597d\u5728\u4e24\u4e2a\u5730\u65b9\u90fd\u88ab\u8bbe\u7f6e\u4e86\uff0c\u90a3\u4e48\u7cfb\u7edf\u5c5e\u6027\u503c\u5c31\u4f1a \"\u83b7\u80dc \"\u5e76\u88ab\u8fd4\u56de\u3002\u8bf7\u6ce8\u610f\uff0c\u5c5e\u6027\u503c\u4e0d\u4f1a\u88ab\u5408\u5e76\uff0c\u800c\u662f\u88ab\u524d\u9762\u7684\u6761\u76ee\u5b8c\u5168\u8986\u76d6\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u666e\u901a\u7684StandardServletEnvironment\uff0c\u5b8c\u6574\u7684\u5c42\u6b21\u7ed3\u6784\u5982\u4e0b\uff0c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u6761\u76ee\u5728\u9876\u90e8:</p> <ol> <li>ServletConfig \u53c2\u6570(if applicable\u2009\u2014\u2009\u4f8b\u5982<code>DispatcherServlet</code> \u7684\u4e0a\u4e0b\u6587)</li> <li>ServletContext \u53c2\u6570(web.xml context-param entries)</li> <li>JNDI environment variables (<code>java:comp/env/</code> entries)</li> <li>JVM system properties\u7cfb\u7edf\u5c5e\u6027 (<code>-D</code> command-line arguments)</li> <li>JVM system environment (\u64cd\u4f5c\u7cfb\u7edf\u73af\u5883\u53d8\u91cfoperating system environment variables)</li> </ol> <p>\u6700\u91cd\u8981\u7684\u662f\uff0c\u6574\u4e2a\u673a\u5236\u662f\u53ef\u914d\u7f6e\u7684\u3002\u5047\u5982\u4f60\u6709\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u5c5e\u6027\u6e90\uff0c\u4f60\u60f3\u628a\u5b83\u96c6\u6210\u5230\u8fd9\u4e2a\u641c\u7d22\u4e2d\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u8bf7\u5b9e\u73b0\u5e76\u5b9e\u4f8b\u5316\u60a8\u81ea\u5df1\u7684<code>PropertySource</code>\uff0c\u5e76\u5c06\u5176\u6dfb\u52a0\u5230\u5f53\u524d<code>Environment</code>\u7684<code>PropertySources</code>\u96c6\u5408\u4e2d\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>ConfigurableApplicationContext ctx = new GenericApplicationContext();\nMutablePropertySources sources = ctx.getEnvironment().getPropertySources();\nsources.addFirst(new MyPropertySource());\n</code></pre> <pre><code>public class ApolloEncryptApplicationContextInitializer implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {\n    public ApolloEncryptApplicationContextInitializer() {\n    }\n    // \u4f1a\u8ba9bootstrap.yml\u914d\u7f6e\u6587\u4ef6\u5931\u6548\uff0c\u56e0\u4e3a\u6539\u53d8\u4e86bootstrap.yml\u5728application\u542f\u52a8\u4e4b\u524d\u5c31\u52a0\u8f7d\u7684\u9ed8\u8ba4\u914d\u7f6e\n    public void initialize(ConfigurableApplicationContext applicationContext) {\n        ConfigurableEnvironment environment = applicationContext.getEnvironment();\n        Properties properties = new Properties();\n        properties.setProperty(\"jasypt.encryptor.password\", \"aaaa\");\n        PropertiesPropertySource propertiesPropertySource = new PropertiesPropertySource(\"applicationConfig\", properties);\n        MutablePropertySources mutablePropertySources = environment.getPropertySources();\n        mutablePropertySources.addFirst(propertiesPropertySource);\n    }\n}\n</code></pre> <p>\u5728\u524d\u9762\u7684\u4ee3\u7801\u4e2d\uff0cMyPropertySource\u5728\u641c\u7d22\u4e2d\u4ee5\u6700\u9ad8\u4f18\u5148\u7ea7\u88ab\u6dfb\u52a0\u3002\u5982\u679c\u5b83\u5305\u542b\u4e00\u4e2amy-property\u5c5e\u6027\uff0c\u5219\u68c0\u6d4b\u5e76\u8fd4\u56de\u8be5\u5c5e\u6027\uff0c\u800c\u4e0d\u662f\u4efb\u4f55\u5176\u4ed6PropertySource\u4e2d\u7684\u4efb\u4f55my-property\u5c5e\u6027\u3002MutablePropertySources API\u66b4\u9732\u4e86\u8bb8\u591a\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u5141\u8bb8\u5bf9\u5c5e\u6027\u6e90\u96c6\u5408\u8fdb\u884c\u7cbe\u786e\u7684\u64cd\u4f5c\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1133-propertysource","title":"1.13.3 @PropertySource\u7684\u4f7f\u7528","text":"<p><code>@PropertySource</code>\u6ce8\u89e3\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b9\u4fbf\u7684\u58f0\u660e\u5f0f\u673a\u5236\uff0c\u7528\u4e8e\u5411Spring\u7684Environment\u4e2d\u6dfb\u52a0\u4e00\u4e2aPropertySource\u3002</p> <p>\u7ed9\u5b9a\u4e00\u4e2a\u540d\u4e3aapp.properties\u7684\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u952e\u503c\u5bf9<code>testbean.name=myTestBean</code>\uff0c\u4e0b\u9762\u7684@Configuration\u7c7b\u4f7f\u7528\u4e86@PropertySource\uff0c\u8fd9\u6837\u8c03\u7528testBean.getName()\u5c31\u4f1a\u8fd4\u56demyTestBean\u3002</p> <pre><code>@Configuration\n@PropertySource(\"classpath:/com/myco/app.properties\")\npublic class AppConfig {\n\n    @Autowired\n    Environment env;\n\n    @Bean\n    public TestBean testBean() {\n        TestBean testBean = new TestBean();\n        testBean.setName(env.getProperty(\"testbean.name\"));\n        return testBean;\n    }\n}\n</code></pre> <p>\u4efb\u4f55\u5b58\u5728\u4e8e@PropertySource\u8d44\u6e90\u4f4d\u7f6e\u4e2d\u7684${...}\u5360\u4f4d\u7b26\u90fd\u4f1a\u88ab\u89e3\u6790\u4e3a\u5df2\u7ecf\u6ce8\u518c\u5230environment\u7684\u5c5e\u6027\u6e90\u96c6\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>@Configuration\n@PropertySource(\"classpath:/com/${my.placeholder:default/path}/app.properties\")\npublic class AppConfig {\n\n    @Autowired\n    Environment env;\n\n    @Bean\n    public TestBean testBean() {\n        TestBean testBean = new TestBean();\n        testBean.setName(env.getProperty(\"testbean.name\"));\n        return testBean;\n    }\n}\n</code></pre> <p>\u5047\u8bbemy.placeholder\u5b58\u5728\u4e8e\u5df2\u7ecf\u6ce8\u518c\u7684\u67d0\u4e2a\u5c5e\u6027\u6e90\u4e2d\uff08\u4f8b\u5982\u7cfb\u7edf\u5c5e\u6027\u6216\u73af\u5883\u53d8\u91cf\uff09\uff0c\u5219placeholder\u4f1a\u88ab\u89e3\u6790\u4e3a\u76f8\u5e94\u7684\u503c\u3002\u5982\u679c\u6ca1\u6709\uff0c\u5219\u4f7f\u7528default/path\u4f5c\u4e3a\u9ed8\u8ba4\u503c\u3002\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u9ed8\u8ba4\u503c\uff0c\u4e14\u65e0\u6cd5\u89e3\u6790\u5c5e\u6027\uff0c\u5219\u4f1a\u629b\u51faIllegalArgumentException\u3002</p> <p>\u6839\u636eJava 8\u60ef\u4f8b\uff0c@PropertySource\u6ce8\u89e3\u662f\u53ef\u4ee5\u91cd\u590d\u7684\u3002\u4f46\u662f\uff0c\u6240\u6709\u8fd9\u6837\u7684@PropertySource\u6ce8\u89e3\u90fd\u9700\u8981\u5728\u540c\u4e00\u5c42\u6b21\u4e0a\u58f0\u660e\uff0c\u53ef\u4ee5\u76f4\u63a5\u5728\u914d\u7f6e\u7c7b\u4e0a\u58f0\u660e\uff0c\u4e5f\u53ef\u4ee5\u5728\u540c\u4e00\u4e2a\u81ea\u5b9a\u4e49\u6ce8\u89e3\u4e2d\u4f5c\u4e3a\u5143\u6ce8\u89e3\u58f0\u660e\u3002\u4e0d\u63a8\u8350\u6df7\u5408\u4f7f\u7528\u76f4\u63a5\u6ce8\u89e3\u548c\u5143\u6ce8\u89e3\uff0c\u56e0\u4e3a\u76f4\u63a5\u6ce8\u89e3\u6709\u6548\u5730\u8986\u76d6\u4e86\u5143\u6ce8\u89e3\u3002\u5982\uff1a</p> <pre><code>@Getter\n@Setter\n@Component\n@ConfigurationProperties(\"data.redis\")\n@PropertySource(value = \"classpath:data/read/test.properties\", ignoreResourceNotFound = true) \n@PropertySource(value = \"file://${CONFIG_HOME}/data/redis/test.properties\", ignoreResourceNotFound = true)\npublic class DataProperties {\n\n    private UserProps user;\n\n    private Device connect;\n    private String oauthJwtSecret;\n\n    private List&lt;Device&gt; devices;\n\n    @Getter\n    @Setter\n    public static class UserProps {\n        private String email;\n        private String countryCode;\n        private String password;\n    }\n\n    @Getter\n    @Setter\n    public static class Device {\n        private String uuid;\n        private String pid;\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#1134","title":"1.13.4 \u58f0\u660e\u4e2d\u7684\u5360\u4f4d\u7b26\u89e3\u6790","text":"<p>\u5386\u53f2\u4e0a\uff0c\u5143\u7d20\u4e2d\u5360\u4f4d\u7b26\u7684\u503c\u53ea\u80fd\u9488\u5bf9JVM\u7cfb\u7edf\u5c5e\u6027\u6216\u73af\u5883\u53d8\u91cf\u8fdb\u884c\u89e3\u6790\u3002\u73b0\u5728\u4e0d\u518d\u662f\u8fd9\u79cd\u60c5\u51b5\u4e86\u3002\u56e0\u4e3a<code>Environment</code> \u62bd\u8c61\u96c6\u6210\u5728\u6574\u4e2a\u5bb9\u5668\u4e2d\uff0c\u6240\u4ee5\u5f88\u5bb9\u6613\u901a\u8fc7\u5b83\u6765\u89e3\u6790\u5360\u4f4d\u7b26\u3002\u8fd9\u610f\u5473\u7740\u60a8\u53ef\u4ee5\u4ee5\u4efb\u4f55\u559c\u6b22\u7684\u65b9\u5f0f\u914d\u7f6e\u89e3\u6790\u8fc7\u7a0b\u3002\u60a8\u53ef\u4ee5\u6539\u53d8\u7cfb\u7edf\u5c5e\u6027\u548c\u73af\u5883\u53d8\u91cf\u641c\u7d22\u7684\u4f18\u5148\u7ea7\uff0c\u6216\u8005\u5b8c\u5168\u5220\u9664\u5b83\u4eec\u3002\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u60c5\u51b5\u5c06\u81ea\u5df1\u7684\u5c5e\u6027\u6e90\u6dfb\u52a0\u5230\u7ec4\u5408\u4e2d\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u4e0d\u7ba1\u81ea\u5b9a\u4e49\u5c5e\u6027\u662f\u5728\u54ea\u91cc\u5b9a\u4e49\u7684\uff0c\u53ea\u8981\u5728Environment\u4e2d\u53ef\u7528\uff0c\u4e0b\u9762\u7684\u8bed\u53e5\u5c31\u53ef\u4ee5\u7528\uff1a</p> <pre><code>&lt;beans&gt;\n    &lt;import resource=\"com/bank/service/${customer}-config.xml\"/&gt;\n&lt;/beans&gt;\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#_2","title":"\u9644\u5f55","text":"<p>\u73af\u5883\u53d8\u91cfsystem environment variables\u662f\u548c\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\uff0cWindows\u548cLinux\u662f\u4e0d\u540c\u7684\u8bed\u6cd5</p> <p>\u73af\u5883\u53d8\u91cf\u7684\u83b7\u53d6\u901a\u8fc7<code>System.getenv()</code>\uff0c\u4e0d\u63d0\u4f9b\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u7684\u65b9\u6cd5\u3002</p> <p>\u73af\u5883\u53d8\u91cf\u4ea7\u751f\u66f4\u591a\u7684\u5168\u5c40\u6548\u5e94\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u4ec5\u5bf9Java\u5b50\u8fdb\u7a0b\u53ef\u89c1\uff0c\u800c\u4e14\u5bf9\u4e8e\u5b9a\u4e49\u5b83\u4eec\u7684\u8fdb\u7a0b\u7684\u6240\u6709\u5b50\u8fdb\u7a0b\u90fd\u662f\u53ef\u89c1\u7684\u3002\u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u5b83\u4eec\u7684\u8bed\u4e49\u6709\u7ec6\u5fae\u7684\u5dee\u522b\uff0c\u6bd4\u5982\uff0c\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u3002\u56e0\u6b64\u73af\u5883\u53d8\u91cf\u66f4\u53ef\u80fd\u6709\u610f\u6599\u4e0d\u5230\u7684\u526f\u4f5c\u7528\u3002\u7a0b\u5e8f\u4e2d\u5c3d\u53ef\u80fd\u4f7f\u7528\u7cfb\u7edf\u5c5e\u6027\u3002\u73af\u5883\u53d8\u91cf\u5e94\u8be5\u5728\u9700\u8981\u5168\u5c40\u6548\u5e94\u7684\u65f6\u5019\u4f7f\u7528\uff0c\u6216\u8005\u5728\u5916\u90e8\u7cfb\u7edf\u63a5\u53e3\u8981\u6c42\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u65f6\u4f7f\u7528\uff08\u6bd4\u5982 PATH\uff09</p> <p>\u800c\u7cfb\u7edf\u5c5e\u6027 JVM system properties \u662f\u5c5e\u4e8eJVM\u7684\uff0c</p> <ul> <li>\u7cfb\u7edf\u5c5e\u6027\u7684\u8bbe\u7f6e: \u901a\u8fc7JVM\u53c2\u6570: <code>-D\u5c5e\u6027\u540d=\u503c</code> \u6216\u8005\u5728\u4ee3\u7801\u4e2d\u901a\u8fc7<code>Sytem.setProperty(String key, String value)</code>\u6765\u8bbe\u7f6e.</li> <li>\u7cfb\u7edf\u5c5e\u6027\u7684\u83b7\u53d6: \u5728Java\u4e2d\u901a\u8fc7<code>System.getProperty(String key)</code>\u83b7\u53d6\u5c5e\u6027\u503c.</li> </ul> <pre><code>@Configuration\n// @ConditionalOnExpression(\"!'pro'.equals(environment['env'])\")\npublic class SwaggerEnableConfig implements EnvironmentAware {\n\n    @Override\n    public void setEnvironment(Environment environment) {\n        // \u83b7\u53d6\u73af\u5883\u53d8\u91cf\n        Map&lt;String, String&gt; env = System.getenv();\n\n        // \u83b7\u53d6\u7cfb\u7edf\u5c5e\u6027\n        Properties properties = System.getProperties();\n\n        System.out.println(properties);\n    }\n}\n</code></pre> <p>\u73af\u5883\u53d8\u91cf\u548c\u7cfb\u7edf\u5c5e\u6027\u7684\u533a\u522b</p> <p></p>"},{"location":"java/spring/spring/IocContainer/#114-loadtimeweaver","title":"1.14 \u6ce8\u518c<code>LoadTimeWeaver</code>","text":"<p>LoadTimeWeaver\u88abSpring\u7528\u4e8e\u5728\u7c7b\u88ab\u52a0\u8f7d\u5230Java\u865a\u62df\u673a\uff08JVM\uff09\u4e2d\u65f6\u8fdb\u884c\u52a8\u6001\u8f6c\u6362\u3002</p> <p>\u5f00\u542f\u52a0\u8f7d\u65f6\u7ec7\u5165(load-time weaving)\uff0c\u9700\u8981\u5f00\u542f\u914d\u7f6e\uff1a</p> <pre><code>@Configuration\n@EnableLoadTimeWeaving\npublic class AppConfig {\n}\n</code></pre> <p>\u4e00\u65e6\u4e3aApplicationContext\u914d\u7f6e\uff0c\u8be5ApplicationContext\u4e2d\u7684\u4efb\u4f55bean\u90fd\u53ef\u4ee5\u5b9e\u73b0<code>LoadTimeWeaverAware</code>\uff0c\u4ece\u800c\u63a5\u6536\u5bf9\u52a0\u8f7d\u65f6\u7ec7\u5165\u5b9e\u4f8b\u7684\u5f15\u7528\u3002\u5728\u7ed3\u5408Spring\u7684JPA\u652f\u6301\u65f6\uff0c\u8fd9\u4e00\u70b9\u7279\u522b\u6709\u7528\uff0c\u56e0\u4e3a\u5728JPA\u7c7b\u8f6c\u6362\u4e2d\u53ef\u80fd\u9700\u8981\u52a0\u8f7d\u65f6\u7ec7\u5165\u3002\u66f4\u591a\u7ec6\u8282\u8bf7\u67e5\u9605 <code>LocalContainerEntityManagerFactoryBean</code>\u548c Load-time Weaving with AspectJ in the Spring Framework.</p>"},{"location":"java/spring/spring/IocContainer/#115-applicationcontext","title":"1.15 ApplicationContext\u7684\u5176\u4ed6\u80fd\u529b","text":"<p>\u6b63\u5982\u5728\u7ae0\u8282\u4ecb\u7ecd\u4e2d\u6240\u8ba8\u8bba\u7684\u90a3\u6837\uff0c<code>org.springframework.beans.factory</code>\u5305\u63d0\u4f9b\u4e86\u7ba1\u7406\u548c\u64cd\u4f5cBean\u7684\u57fa\u672c\u529f\u80fd\uff0c\u5305\u62ec\u4ee5\u7f16\u7a0b\u7684\u65b9\u5f0f\u3002<code>org.springframework.context</code>\u5305\u589e\u52a0\u4e86ApplicationContext\u63a5\u53e3\uff0c\u5b83\u7ee7\u627fBeanFactory\u63a5\u53e3\uff0c\u53e6\u5916\u7ee7\u627f\u4e86\u5176\u4ed6\u63a5\u53e3\u4ee5\u66f4\u52a0\u9762\u5411\u5e94\u7528\u6846\u67b6\u7684\u65b9\u5f0f\u63d0\u4f9b\u989d\u5916\u7684\u529f\u80fd\u3002\u5f88\u591a\u4eba\u5728\u4f7f\u7528ApplicationContext\u65f6\uff0c\u5b8c\u5168\u91c7\u7528\u58f0\u660e\u5f0f\u7684\u65b9\u5f0f\uff0c\u751a\u81f3\u4e0d\u4ee5\u7f16\u7a0b\u7684\u65b9\u5f0f\u521b\u5efa\u5b83\uff0c\u800c\u662f\u4f9d\u9760ContextLoader\u7b49\u652f\u6301\u7c7b\u6765\u81ea\u52a8\u5b9e\u4f8b\u5316ApplicationContext\uff0c\u4f5c\u4e3aJava EE Web\u5e94\u7528\u6b63\u5e38\u542f\u52a8\u8fc7\u7a0b\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u4e3a\u4e86\u4ee5\u66f4\u52a0\u9762\u5411\u6846\u67b6\u7684\u98ce\u683c\u589e\u5f3a <code>BeanFactory</code> \u63a5\u53e3\u7684\u529f\u80fd,  context \u5305\u8fd8\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u529f\u80fd\uff1a</p> <ul> <li>\u901a\u8fc7 <code>MessageSource</code> \u63a5\u53e3\uff0c\u8bbf\u95eei18n\u98ce\u683c\u7684\u6d88\u606f</li> <li>\u901a\u8fc7 <code>ResourceLoader</code> \u63a5\u53e3\uff0c\u8bbf\u95eeresource\uff0c\u5982URL\u548cfile</li> <li>\u901a\u8fc7 <code>ApplicationEventPublisher</code> \u63a5\u53e3\uff0c\u5411<code>ApplicationListener</code>\u7684\u5b9e\u73b0\u4e8b\u4ef6\u53d1\u5e03</li> <li>\u901a\u8fc7<code>HierarchicalBeanFactory</code>\u63a5\u53e3\uff0c\u52a0\u8f7d\u591a\u4e2a\uff08\u5206\u5c42\uff09\u4e0a\u4e0b\u6587\uff0c\u8ba9\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u90fd\u96c6\u4e2d\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u5c42\u4e0a\uff0c\u5982\u5e94\u7528\u7a0b\u5e8f\u7684web\u5c42\u3002</li> </ul> <p></p>"},{"location":"java/spring/spring/IocContainer/#1151-messagesource","title":"1.15.1 \u4f7f\u7528MessageSource\u5b9e\u73b0\u56fd\u9645\u5316","text":"<p>ApplicationContext\u63a5\u53e3\u7ee7\u627f\u4e86\u540d\u4e3aMessageSource\u7684\u63a5\u53e3\uff0c\u56e0\u6b64\uff0c\u5b83\u63d0\u4f9b\u4e86\u56fd\u9645\u5316\uff08\"i18n\"\uff09\u529f\u80fd\u3002Spring\u8fd8\u63d0\u4f9b\u4e86HierarchicalMessageSource\u63a5\u53e3\uff0c\u5b83\u53ef\u4ee5\u5bf9\u6d88\u606f\u8fdb\u884c\u5206\u7ea7\u89e3\u6790\u3002\u8fd9\u4e9b\u63a5\u53e3\u5171\u540c\u63d0\u4f9b\u4e86Spring\u5b9e\u73b0\u6d88\u606f\u89e3\u6790\u7684\u57fa\u7840\u3002\u8fd9\u4e9b\u63a5\u53e3\u4e0a\u5b9a\u4e49\u7684\u65b9\u6cd5\u5305\u62ec\uff1a</p> <ul> <li> <p><code>String getMessage(String code, Object[] args, String default, Locale loc)</code>\uff1a\u7528\u4e8e\u4eceMessageSource\u4e2d\u68c0\u7d22\u6d88\u606f\u7684\u57fa\u672c\u65b9\u6cd5\u3002\u5f53\u6ca1\u6709\u627e\u5230\u6307\u5b9alocale\u7684\u6d88\u606f\u65f6\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u6d88\u606f\u3002\u4efb\u4f55\u4f20\u9012\u8fdb\u6765\u7684\u53c2\u6570\u90fd\u4f1a\u6210\u4e3a\u66ff\u6362\u503c\uff0c\u4f7f\u7528\u6807\u51c6\u5e93\u63d0\u4f9b\u7684MessageFormat\u529f\u80fd\u3002</p> </li> <li> <p><code>String getMessage(String code, Object[] args, Locale loc)</code>:\u57fa\u672c\u4e0a\u4e0e\u524d\u4e00\u4e2a\u65b9\u6cd5\u76f8\u540c\uff0c\u4f46\u6709\u4e00\u70b9\u4e0d\u540c\u3002\u4e0d\u80fd\u6307\u5b9a\u9ed8\u8ba4\u6d88\u606f\u3002\u5982\u679c\u627e\u4e0d\u5230\u6d88\u606f\uff0c\u5c06\u629b\u51faNoSuchMessageException\u3002</p> </li> <li> <p><code>String getMessage(MessageSourceResolvable resolvable, Locale locale)</code>\uff1a\u524d\u9762\u65b9\u6cd5\u4e2d\u4f7f\u7528\u7684\u6240\u6709\u5c5e\u6027\u90fd\u88ab\u5c01\u88c5\u5728\u4e00\u4e2a\u540d\u4e3aMessageSourceResolvable\u7684\u7c7b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u7528\u8fd9\u4e2a\u65b9\u6cd5\u6765\u4f7f\u7528\u5b83\u3002</p> </li> </ul> <p>\u5f53\u52a0\u8f7dApplicationContext\u65f6\uff0c\u5b83\u4f1a\u81ea\u52a8\u641c\u7d22\u4e0a\u4e0b\u6587\u4e2d\u5b9a\u4e49\u7684MessageSource Bean\u3002\u8fd9\u4e2aBean\u7684\u540d\u5b57\u5fc5\u987b\u662fmessageSource\u3002\u5982\u679c\u627e\u5230\u4e86\u8fd9\u6837\u4e00\u4e2abean\uff0c\u6240\u6709\u5bf9\u524d\u9762\u65b9\u6cd5\u7684\u8c03\u7528\u90fd\u4f1a\u59d4\u6258\u7ed9\u8fd9\u4e2amessage source\u3002\u5982\u679c\u6ca1\u6709\u627e\u5230message source\uff0cApplicationContext \u8bd5\u56fe\u627e\u5230\u4e00\u4e2a\u5305\u542b\u76f8\u540c\u540d\u79f0\u7684 bean \u7684\u7236\u7c7b\u3002\u5982\u679c\u627e\u5230\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u8be5bean\u4f5c\u4e3amessage source\u3002\u5982\u679cApplicationContext\u627e\u4e0d\u5230\u4efb\u4f55message source\uff0c\u4e3a\u4e86\u80fd\u591f\u63a5\u53d7\u5bf9\u4e0a\u9762\u5b9a\u4e49\u7684\u65b9\u6cd5\u7684\u8c03\u7528\uff0c\u5c31\u4f1a\u5b9e\u4f8b\u5316\u4e00\u4e2a\u7a7a\u7684DelegatingMessageSource\u3002</p> <p>Spring\u63d0\u4f9b\u4e86\u4e24\u4e2aMessageSource\u5b9e\u73b0\uff0c\u5373<code>ResourceBundleMessageSource</code>\u548c<code>StaticMessageSource</code>\u3002\u4e24\u8005\u90fd\u5b9e\u73b0\u4e86HierarchicalMessageSource\uff0c\u4ee5\u4fbf\u8fdb\u884c\u5d4c\u5957\u6d88\u606f\u4f20\u9012\u3002StaticMessageSource\u5f88\u5c11\u4f7f\u7528\uff0c\u4e00\u822c\u4e0d\u7528\u4e8e\u751f\u4ea7\u73af\u5883\uff0c\u4f46\u63d0\u4f9b\u4e86\u5411\u6d88\u606f\u6e90\u6dfb\u52a0\u6d88\u606f\u7684\u7a0b\u5e8f\u5316\u65b9\u6cd5\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86ResourceBundleMessageSource:</p> <pre><code>&lt;beans&gt;\n    &lt;bean id=\"messageSource\"\n            class=\"org.springframework.context.support.ResourceBundleMessageSource\"&gt;\n        &lt;property name=\"basenames\"&gt;\n            &lt;list&gt;\n                &lt;value&gt;format&lt;/value&gt;\n                &lt;value&gt;exceptions&lt;/value&gt;\n                &lt;value&gt;windows&lt;/value&gt;\n            &lt;/list&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;\n</code></pre> <p>\u672c\u4f8b\u5047\u8bbe\u5728classpath\u4e2d\u5b9a\u4e49\u4e86\u4e09\u4e2aresource bundles\u8d44\u6e90\u5305\uff0c\u5206\u522b\u4e3aformat,exceptions\u548cwindows\u3002\u4efb\u4f55\u89e3\u6790\u6d88\u606f\u7684\u8bf7\u6c42\u90fd\u662f\u4ee5JDK\u6807\u51c6\u7684\u65b9\u5f0f\u901a\u8fc7ResourceBundle\u5bf9\u8c61\u89e3\u6790\u6d88\u606f\u6765\u5904\u7406\u7684\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u5047\u8bbe\u4e0a\u8ff0\u4e24\u4e2a\u8d44\u6e90\u6346\u7ed1\u6587\u4ef6\u7684\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code># in format.properties\n message=Alligators rock!\n</code></pre> <pre><code># in exceptions.properties\nargument.required=The {0} argument is required.\n</code></pre> <p>\u4e0b\u4e00\u4e2a\u4f8b\u5b50\u663e\u793a\u4e86\u4e00\u4e2a\u8fd0\u884cMessageSource\u529f\u80fd\u7684\u7a0b\u5e8f\u3002\u8bf7\u8bb0\u4f4f\uff0c\u6240\u6709\u7684ApplicationContext\u5b9e\u73b0\u4e5f\u662fMessageSource\u5b9e\u73b0\uff0c\u56e0\u6b64\u53ef\u4ee5\u8f6c\u4e3aMessageSource\u63a5\u53e3\uff1a</p> <pre><code>public static void main(String[] args) {\n    MessageSource resources = new ClassPathXmlApplicationContext(\"beans.xml\");\n    String message = resources.getMessage(\"message\", null, \"Default\", Locale.ENGLISH);\n    System.out.println(message);\n}\n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u7684\u8f93\u51fa\u4e3a<code>Alligators rock!</code></p> <p>\u603b\u7ed3\u4e00\u4e0b\uff0cMessageSource\u5b9a\u4e49\u5728\u4e00\u4e2a\u540d\u4e3abeans.xml\u7684\u6587\u4ef6\u4e2d\uff0c\u5b83\u5b58\u5728\u4e8eclasspath\u7684\u6839\u76ee\u5f55\u4e0b\u3002messageSource bean\u5b9a\u4e49\u901a\u8fc7\u5b83\u7684basenames\u5c5e\u6027\u6765\u5f15\u7528\u4e00\u4e9b\u8d44\u6e90\u6346\u7ed1\u3002\u5217\u8868\u4e2d\u4f20\u9012\u7ed9basenames\u5c5e\u6027\u7684\u4e09\u4e2a\u6587\u4ef6\u4f5c\u4e3a\u6587\u4ef6\u5b58\u5728\u4e8e\u4f60\u7684classpath\u7684\u6839\u8def\u5f84\uff0c\u5206\u522b\u79f0\u4e3aformat.properties\u3001exceptions.properties\u548cwindows.properties\u3002</p> <p>\u4e0b\u4e00\u4e2a\u4f8b\u5b50\u663e\u793a\u4e86\u4f20\u9012\u7ed9\u6d88\u606f\u67e5\u627e\u7684\u53c2\u6570\u3002\u8fd9\u4e9b\u53c2\u6570\u88ab\u8f6c\u6362\u4e3aString\u5bf9\u8c61\uff0c\u5e76\u63d2\u5165\u5230\u67e5\u627e\u6d88\u606f\u7684\u5360\u4f4d\u7b26\u4e2d\uff1a</p> <pre><code>public class Example {\n\n    private MessageSource messages;\n\n    public void setMessages(MessageSource messages) {\n        this.messages = messages;\n    }\n\n    public void execute() {\n        String message = this.messages.getMessage(\"argument.required\",\n            new Object [] {\"userDao\"}, \"Required\", Locale.ENGLISH);\n        System.out.println(message);\n    }\n}\n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u8f93\u51fa\u4e3a\uff1a</p> <pre><code>The userDao argument is required.\n</code></pre> <p>\u5173\u4e8e\u56fd\u9645\u5316\uff08\"i18n\"\uff09\uff0cSpring\u7684\u5404\u79cdMessageSource\u5b9e\u73b0\u9075\u5faa\u4e0e\u6807\u51c6JDK <code>ResourceBundle</code>\u76f8\u540c\u7684locale\u89e3\u6790\u548c\u56de\u9000\u89c4\u5219\u3002\u7b80\u800c\u8a00\u4e4b\uff0c\u7ee7\u7eed\u524d\u9762\u5b9a\u4e49\u7684messageSource\u793a\u4f8b\uff0c\u5982\u679c\u4f60\u60f3\u89e3\u51b3\u9488\u5bf9\u82f1\u56fd\uff08en-GB\uff09\u672c\u5730\u5316\u7684\u6d88\u606f\uff0c\u4f60\u5c06\u521b\u5efa\u5206\u522b\u79f0\u4e3aformat_en_GB.properties\u3001exceptions_en_GB.properties\u548cwindows_en_GB.properties\u7684\u6587\u4ef6\u3002</p> <p>\u6309\u7167\u89c4\u5b9aproperties\u6587\u4ef6\u91cc\u7684\u5185\u5bb9\u6309\u7167ISO-8859-1\u7f16\u7801\u7684\uff0c\u6240\u4ee5\u51fa\u73b0\u4e71\u7801\u662f\u6b63\u5e38\u7684\uff01</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0clocale\u89e3\u6790\u662f\u7531\u5e94\u7528\u7a0b\u5e8f\u7684\u5468\u56f4\u73af\u5883\u7ba1\u7406\u7684\u3002\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c(\u82f1\u56fd)\u6d88\u606f\u6240\u9488\u5bf9\u7684locale\u662f\u624b\u52a8\u6307\u5b9a\u7684\u3002</p> <pre><code># in exceptions_en_GB.properties\nargument.required=Ebagum lad, the ''{0}'' argument is required, I say, required.\n</code></pre> <pre><code>public static void main(final String[] args) {\n    MessageSource resources = new ClassPathXmlApplicationContext(\"beans.xml\");\n    String message = resources.getMessage(\"argument.required\",\n        new Object [] {\"userDao\"}, \"Required\", Locale.UK);\n    System.out.println(message);\n}\n</code></pre> <p>\u8f93\u51fa\u4e3a\uff1a</p> <pre><code>Ebagum lad, the 'userDao' argument is required, I say, required.\n</code></pre> <p>\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>MessageSourceAware</code>\u63a5\u53e3\u6765\u83b7\u53d6\u5bf9\u4efb\u4f55\u5df2\u5b9a\u4e49\u7684MessageSource\u7684\u5f15\u7528\u3002\u4efb\u4f55\u5728\u5b9e\u73b0MessageSourceAware\u63a5\u53e3\u7684ApplicationContext\u4e2d\u5b9a\u4e49\u7684Bean\u90fd\u4f1a\u5728\u521b\u5efa\u548c\u914d\u7f6eBean\u65f6\u88ab\u6ce8\u5165\u5e94\u7528\u4e0a\u4e0b\u6587\u7684MessageSource\u3002</p> <p>\u4f5c\u4e3a<code>ResourceBundleMessageSource</code>\u7684\u66ff\u4ee3\uff0cSpring\u63d0\u4f9b\u4e86\u4e00\u4e2a<code>ReloadableResourceBundleMessageSource</code>\u7c7b\u3002\u8fd9\u4e2a\u53d8\u4f53\u652f\u6301\u76f8\u540c\u7684\u6346\u7ed1\u6587\u4ef6\u683c\u5f0f\uff0c\u4f46\u6bd4\u57fa\u4e8e\u6807\u51c6JDK\u7684<code>ResourceBundleMessageSource</code>\u5b9e\u73b0\u66f4\u52a0\u7075\u6d3b\u3002\u7279\u522b\u662f\uff0c\u5b83\u5141\u8bb8\u4ece\u4efb\u4f55Spring\u8d44\u6e90\u4f4d\u7f6e\u8bfb\u53d6\u6587\u4ef6\uff08\u4e0d\u4ec5\u4ec5\u662f\u4ececlasspath\uff09\uff0c\u5e76\u652f\u6301\u6346\u7ed1\u5c5e\u6027\u6587\u4ef6\u7684\u70ed\u91cd\u8f7d\uff08\u540c\u65f6\u6709\u6548\u5730\u7f13\u5b58\u5b83\u4eec\uff09\u3002\u8be6\u60c5\u8bf7\u53c2\u89c1 <code>ReloadableResourceBundleMessageSource</code> \u3002</p>"},{"location":"java/spring/spring/IocContainer/#1152-events","title":"1.15.2 \u6807\u51c6\u548c\u81ea\u5b9a\u4e49\u7684Events","text":"<p>ApplicationContext\u4e2d\u7684event\u5904\u7406\u662f\u901a\u8fc7ApplicationEvent\u7c7b\u548cApplicationListener\u63a5\u53e3\u63d0\u4f9b\u7684\u3002\u5982\u679c\u5c06\u5b9e\u73b0ApplicationListener\u63a5\u53e3\u7684Bean\u90e8\u7f72\u5230\u4e0a\u4e0b\u6587\u4e2d\uff0c\u6bcf\u6b21ApplicationEvent\u88ab\u53d1\u5e03\u5230ApplicationContext\u65f6\uff0c\u8be5Bean\u90fd\u4f1a\u5f97\u5230\u901a\u77e5\u3002\u672c\u8d28\u4e0a\uff0c\u8fd9\u5c31\u662f\u6807\u51c6\u7684Observer\u89c2\u5bdf\u8005\u8bbe\u8ba1\u6a21\u5f0f\u3002</p> <p>\u4eceSpring 4.2\u5f00\u59cb\uff0cevent\u57fa\u7840\u67b6\u6784\u5f97\u5230\u4e86\u663e\u8457\u7684\u6539\u8fdb\uff0c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u6ce8\u89e3\u7684\u6a21\u578b\uff0c\u4ee5\u53ca\u53d1\u5e03\u4efb\u4f55\u4efb\u610f\u4e8b\u4ef6\u7684\u80fd\u529b\uff08\u5373\u4e0d\u4e00\u5b9a\u4eceApplicationEvent\u6269\u5c55\u7684\u5bf9\u8c61\uff09\u3002\u5f53\u8fd9\u6837\u7684object\u88ab\u53d1\u5e03\u65f6\uff0c\u6211\u4eec\u4f1a\u5c06\u5176\u5305\u88f9\u5728\u4e00\u4e2aevent\u4e2d\u3002</p> <p>\u4e0b\u9762\u5c55\u793aSpring\u63d0\u4f9b\u7684\u51e0\u4e2aEvent\uff1a</p> Event Explanation <code>ContextRefreshedEvent</code> \u5728 <code>ApplicationContext</code> is initialized or refreshed (for example, by using the <code>refresh()</code> method on the <code>ConfigurableApplicationContext</code> interface)\u53d1\u5e03. Here, \u201cinitialized\u201d means that all beans are loaded, post-processor beans are detected and activated, singletons are pre-instantiated, and the <code>ApplicationContext</code> object is ready for use. As long as the context has not been closed, a refresh can be triggered multiple times, provided that the chosen <code>ApplicationContext</code> actually supports such \u201chot\u201d refreshes. For example, <code>XmlWebApplicationContext</code> supports hot refreshes, but <code>GenericApplicationContext</code> does not. <code>ContextStartedEvent</code> Published when the <code>ApplicationContext</code> is started by using the <code>start()</code> method on the <code>ConfigurableApplicationContext</code> interface. Here, \u201cstarted\u201d means that all <code>Lifecycle</code> beans receive an explicit start signal. Typically, this signal is used to restart beans after an explicit stop, but it may also be used to start components that have not been configured for autostart (for example, components that have not already started on initialization).\u5f53\u4f7f\u7528ConfigurableApplicationContext\u63a5\u53e3\u4e0a\u7684start()\u65b9\u6cd5\u542f\u52a8ApplicationContext\u65f6\u53d1\u5e03\u3002\u5728\u8fd9\u91cc\uff0c\"started \"\u610f\u5473\u7740\u6240\u6709\u7684Lifecycle Bean\u90fd\u6536\u5230\u4e00\u4e2a\u663e\u5f0f\u7684\u542f\u52a8\u4fe1\u53f7\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e2a\u4fe1\u53f7\u7528\u4e8e\u5728\u663e\u5f0f\u505c\u6b62\u540e\u91cd\u65b0\u542f\u52a8bean\uff0c\u4f46\u5b83\u4e5f\u53ef\u4ee5\u7528\u4e8e\u542f\u52a8\u6ca1\u6709\u88ab\u914d\u7f6e\u4e3a\u81ea\u52a8\u542f\u52a8\u7684\u7ec4\u4ef6\uff08\u4f8b\u5982\uff0c\u5728\u521d\u59cb\u5316\u65f6\u5c1a\u672a\u542f\u52a8\u7684\u7ec4\u4ef6\uff09\u3002 <code>ContextStoppedEvent</code> Published when the <code>ApplicationContext</code> is stopped by using the <code>stop()</code> method on the <code>ConfigurableApplicationContext</code> interface. Here, \u201cstopped\u201d means that all <code>Lifecycle</code> beans receive an explicit stop signal. A stopped context may be restarted through a <code>start()</code> call. <code>ContextClosedEvent</code> Published when the <code>ApplicationContext</code> is being closed by using the <code>close()</code> method on the <code>ConfigurableApplicationContext</code> interface or via a JVM shutdown hook. Here, \"closed\" means that all singleton beans will be destroyed. Once the context is closed, it reaches its end of life and cannot be refreshed or restarted.\u5f53 \"ApplicationContext \"\u901a\u8fc7\u4f7f\u7528 \"ConfigurableApplicationContext \"\u63a5\u53e3\u4e0a\u7684 \"close() \"\u65b9\u6cd5\u6216\u901a\u8fc7JVM\u5173\u95ed\u94a9\u5b50\u5173\u95ed\u65f6\u53d1\u5e03\u3002\u5728\u8fd9\u91cc\uff0c\"\u5173\u95ed \"\u610f\u5473\u7740\u6240\u6709\u7684\u5355\u4f8bBean\u5c06\u88ab\u9500\u6bc1\u3002\u4e00\u65e6\u4e0a\u4e0b\u6587\u88ab\u5173\u95ed\uff0c\u5b83\u7684\u751f\u547d\u5c31\u7ed3\u675f\u4e86\uff0c\u4e0d\u80fd\u88ab\u5237\u65b0\u6216\u91cd\u65b0\u542f\u52a8\u3002 <code>RequestHandledEvent</code> A web-specific event telling all beans that an HTTP request has been serviced. This event is published after the request is complete. This event is only applicable to web applications that use Spring\u2019s <code>DispatcherServlet</code>.\u4e00\u4e2aWeb\u7279\u6709\u7684\u4e8b\u4ef6\uff0c\u544a\u8bc9\u6240\u6709Bean\u4e00\u4e2aHTTP\u8bf7\u6c42\u5df2\u7ecf\u88ab\u670d\u52a1\u3002\u8be5\u4e8b\u4ef6\u4f1a\u5728\u8bf7\u6c42\u5b8c\u6210\u540e\u53d1\u5e03\u3002\u8be5\u4e8b\u4ef6\u4ec5\u9002\u7528\u4e8e\u4f7f\u7528Spring\u7684 \"DispatcherServlet \"\u7684Web\u5e94\u7528\u7a0b\u5e8f\u3002 <code>ServletRequestHandledEvent</code> A subclass of <code>RequestHandledEvent</code> that adds Servlet-specific context information. \u589e\u52a0\u4e86servlet\u7279\u6709\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f <p>\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u548c\u53d1\u5e03\u81ea\u5b9a\u4e49\u7684event\uff0c</p> <pre><code>public class BlockedListEvent extends ApplicationEvent {\n\n    private final String address;\n    private final String content;\n\n    public BlockedListEvent(Object source, String address, String content) {\n        super(source);\n        this.address = address;\n        this.content = content;\n    }\n\n    // accessor and other methods...\n}\n</code></pre> <p>\u8981\u53d1\u5e03\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684ApplicationEvent\uff0c\u8bf7\u5728ApplicationEventPublisher\u4e0a\u8c03\u7528publishEvent()\u65b9\u6cd5\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u5b9e\u73b0ApplicationEventPublisherAware\u7684\u7c7b\u5e76\u5c06\u5176\u6ce8\u518c\u4e3aSpring bean\u6765\u5b9e\u73b0\u3002</p> <pre><code>public class EmailService implements ApplicationEventPublisherAware {\n\n    private List&lt;String&gt; blockedList;\n    private ApplicationEventPublisher publisher;\n\n    public void setBlockedList(List&lt;String&gt; blockedList) {\n        this.blockedList = blockedList;\n    }\n\n    public void setApplicationEventPublisher(ApplicationEventPublisher publisher) {\n        this.publisher = publisher;\n    }\n\n    public void sendEmail(String address, String content) {\n        if (blockedList.contains(address)) {\n            publisher.publishEvent(new BlockedListEvent(this, address, content));\n            return;\n        }\n        // send email...\n    }\n}\n</code></pre> <pre><code>public class BlockedListNotifier implements ApplicationListener&lt;BlockedListEvent&gt; {\n\n    private String notificationAddress;\n\n    public void setNotificationAddress(String notificationAddress) {\n        this.notificationAddress = notificationAddress;\n    }\n\n    public void onApplicationEvent(BlockedListEvent event) {\n        // notify appropriate parties via notificationAddress...\n    }\n}\n</code></pre> <p>\u4f46\u6ce8\u610f\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e8b\u4ef6\u76d1\u542c\u5668\u540c\u6b65\u63a5\u6536\u4e8b\u4ef6\u3002\u8fd9\u610f\u5473\u7740publishEvent()\u65b9\u6cd5\u4f1a\u963b\u585e\uff0c\u76f4\u5230\u6240\u6709\u7684\u76d1\u542c\u5668\u5904\u7406\u5b8c\u4e8b\u4ef6\u3002\u8fd9\u79cd\u540c\u6b65\u548c\u5355\u7ebf\u7a0b\u65b9\u6cd5\u7684\u4e00\u4e2a\u4f18\u70b9\u662f\uff0c\u5f53\u76d1\u542c\u5668\u63a5\u6536\u5230\u4e00\u4e2a\u4e8b\u4ef6\u65f6\uff0c\u5982\u679c\u6709\u4e8b\u52a1\u4e0a\u4e0b\u6587\u53ef\u7528\uff0c\u5b83\u5c31\u4f1a\u5728\u53d1\u5e03\u8005\u7684\u4e8b\u52a1\u4e0a\u4e0b\u6587\u4e2d\u64cd\u4f5c\u3002</p> <p>spring\u7684\u4e8b\u4ef6\u673a\u5236\u662f\u4e3a\u540c\u4e00\u5e94\u7528\u4e0a\u4e0b\u6587\u4e2dSpring Bean\u4e4b\u95f4\u7684\u7b80\u5355\u901a\u4fe1\u800c\u8bbe\u8ba1\u7684\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u66f4\u590d\u6742\u7684\u4f01\u4e1a\u96c6\u6210\u9700\u6c42\uff0c\u5355\u72ec\u7ef4\u62a4\u7684Spring Integration\u9879\u76ee\u4e3a\u6784\u5efa\u8f7b\u91cf\u7ea7\u7684\u3001\u9762\u5411\u6a21\u5f0f\u7684\u3001\u4e8b\u4ef6\u9a71\u52a8\u7684\u67b6\u6784\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u652f\u6301\uff0c\u8fd9\u4e9b\u67b6\u6784\u5efa\u7acb\u5728\u8457\u540d\u7684Spring\u7f16\u7a0b\u6a21\u578b\u4e4b\u4e0a\u3002</p> <p>\u57fa\u4e8e\u6ce8\u89e3\u7684Event Listeners</p> <p>\u5728spring4.2\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7<code>@EventListener</code>\u6ce8\u89e3\u5728Bean\u7684\u4efb\u610fpublic\u65b9\u6cd5\u4e0a\u6765\u6ce8\u518c\u4e00\u4e2a\u4e8b\u4ef6\u76d1\u542c\u5668\u3002</p> <pre><code>public class BlockedListNotifier {\n\n    private String notificationAddress;\n\n    public void setNotificationAddress(String notificationAddress) {\n        this.notificationAddress = notificationAddress;\n    }\n\n    @EventListener\n    public void processBlockedListEvent(BlockedListEvent event) {\n        // notify appropriate parties via notificationAddress...\n    }\n}\n</code></pre> <p>\u65b9\u6cd5\u7b7e\u540d\u518d\u6b21\u58f0\u660e\u5b83\u6240\u76d1\u542c\u7684\u4e8b\u4ef6\u7c7b\u578b\uff0c\u4f46\u662f\uff0c\u8fd9\u6b21\u7528\u4e86\u4e00\u4e2a\u7075\u6d3b\u7684\u540d\u5b57\uff0c\u800c\u4e14\u6ca1\u6709\u5b9e\u73b0\u7279\u5b9a\u7684\u76d1\u542c\u63a5\u53e3\u3002\u53ea\u8981\u5b9e\u9645\u7684\u4e8b\u4ef6\u7c7b\u578b\u5728\u5176\u5b9e\u73b0\u5c42\u6b21\u4e2d\u80fd\u89e3\u6790\u4e3a\u4f60\u7684\u901a\u7528\u53c2\u6570\uff0c\u4e8b\u4ef6\u7c7b\u578b\u4e5f\u53ef\u4ee5\u901a\u8fc7\u901a\u7528\u6765\u7f29\u5c0f\u3002</p> <p>\u5982\u679c\u60a8\u7684\u65b9\u6cd5\u5e94\u8be5\u76d1\u542c\u591a\u4e2a\u4e8b\u4ef6\uff0c\u6216\u8005\u60a8\u60f3\u5728\u5b9a\u4e49\u65b9\u6cd5\u65f6\u4e0d\u4f7f\u7528\u4efb\u4f55\u53c2\u6570\uff0c\u4e5f\u53ef\u4ee5\u5728\u6ce8\u89e3\u672c\u8eab\u6307\u5b9a\u4e8b\u4ef6\u7c7b\u578b\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\u3002</p> <pre><code>@EventListener({ContextStartedEvent.class, ContextRefreshedEvent.class})\npublic void handleContextStart() {\n    // ...\n}\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528SpEL\u8868\u8fbe\u5f0f\u6765\u6dfb\u52a0\u989d\u5916\u7684\u8fc7\u6ee4\uff0c\u4e0b\u9762\u7684\u793a\u4f8b\u663e\u793a\u4e86\u5982\u4f55\u91cd\u5199\u6211\u4eec\u7684\u901a\u77e5\u5668\uff0c\u4f7f\u5176\u4ec5\u5728\u4e8b\u4ef6\u7684\u5185\u5bb9\u5c5e\u6027\u7b49\u4e8emy-event\u65f6\u624d\u88ab\u8c03\u7528\u3002</p> <pre><code>@EventListener(condition = \"#blEvent.content == 'my-event'\")\npublic void processBlockedListEvent(BlockedListEvent blockedListEvent) {\n    // notify appropriate parties via notificationAddress...\n}\n</code></pre> <p>\u6bcf\u4e2aSpEL\u8868\u8fbe\u5f0f\u90fd\u662f\u9488\u5bf9\u4e00\u4e2a\u4e13\u7528\u4e0a\u4e0b\u6587\u8fdb\u884c\u8bc4\u4f30\u7684\u3002\u4e0b\u8868\u5217\u51fa\u4e86\u4e0a\u4e0b\u6587\u53ef\u7528\u7684\u9879\u76ee\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u5c06\u5b83\u4eec\u7528\u4e8e\u6761\u4ef6\u4e8b\u4ef6\u5904\u7406\u3002</p> Name Location Description Example Event root object The actual <code>ApplicationEvent</code>. <code>#root.event</code> or <code>event</code> Arguments array root object The arguments (as an object array) used to invoke the method. <code>#root.args</code> or <code>args</code>; <code>args[0]</code> to access the first argument, etc. Argument name evaluation context The name of any of the method arguments. If, for some reason, the names are not available (for example, because there is no debug information in the compiled byte code), individual arguments are also available using the <code>#a&lt;#arg&gt;</code> syntax where <code>&lt;#arg&gt;</code> stands for the argument index (starting from 0). <code>#blEvent</code> or <code>#a0</code> (you can also use <code>#p0</code> or <code>#p&lt;#arg&gt;</code> parameter notation as an alias) <p>\u5982\u679c\u4f60\u9700\u8981\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\u4f5c\u4e3a\u5904\u7406\u53e6\u4e00\u4e2a\u4e8b\u4ef6\u7684\u7ed3\u679c\uff0c\u4f60\u53ef\u4ee5\u6539\u53d8\u65b9\u6cd5\u7b7e\u540d\u6765\u8fd4\u56de\u5e94\u8be5\u53d1\u5e03\u7684\u4e8b\u4ef6\uff0c\u5982\u4e0b\u4f8b\u6240\u793a:</p> <pre><code>@EventListener\npublic ListUpdateEvent handleBlockedListEvent(BlockedListEvent event) {\n    // notify appropriate parties via notificationAddress and\n    // then publish a ListUpdateEvent...\n}\n</code></pre> <p>\u8fd9\u4e2a\u7279\u6027\u5728\u5f02\u6b65\u76d1\u542c\u65f6\u4e0d\u652f\u6301</p> <p>\u8fd9\u4e2a\u65b0\u65b9\u6cd5\u4e3a\u4e0a\u9762\u65b9\u6cd5\u5904\u7406\u7684\u6bcf\u4e2aBlockedListEvent\u53d1\u5e03\u4e00\u4e2a\u65b0\u7684ListUpdateEvent\u3002\u5982\u679c\u4f60\u9700\u8981\u53d1\u5e03\u591a\u4e2a\u4e8b\u4ef6\uff0c\u4f60\u53ef\u4ee5\u8fd4\u56de\u4e00\u4e2a\u4e8b\u4ef6\u96c6\u5408\u6765\u4ee3\u66ff\u3002</p> <p>\u5728\u4f7f\u7528\u5f02\u6b65\u4e8b\u4ef6\u65f6\u8981\u6ce8\u610f\u4ee5\u4e0b\u9650\u5236\u3002</p> <ul> <li> <p>\u5982\u679c\u5f02\u6b65\u4e8b\u4ef6\u76d1\u542c\u5668\u629b\u51fa\u4e86\u4e00\u4e2aException\uff0c\u5b83\u4e0d\u4f1a\u4f20\u64ad\u7ed9\u8c03\u7528\u8005\uff0c\u8bf7\u53c2\u89c1AsyncUncaughtExceptionHandler\u4e86\u89e3\u66f4\u591a\u7ec6\u8282\u3002\u66f4\u591a\u7ec6\u8282\u8bf7\u53c2\u89c1AsyncUncaughtExceptionHandler\u3002</p> </li> <li> <p>\u5f02\u6b65\u4e8b\u4ef6\u76d1\u542c\u5668\u65b9\u6cd5\u4e0d\u80fd\u901a\u8fc7\u8fd4\u56de\u4e00\u4e2a\u503c\u6765\u53d1\u5e03\u540e\u7eed\u4e8b\u4ef6\u3002\u5982\u679c\u4f60\u9700\u8981\u53d1\u5e03\u53e6\u4e00\u4e2a\u4e8b\u4ef6\u4f5c\u4e3a\u5904\u7406\u7ed3\u679c\uff0c\u6ce8\u5165\u4e00\u4e2aApplicationEventPublisher\u6765\u624b\u52a8\u53d1\u5e03\u4e8b\u4ef6\u3002</p> </li> </ul>"},{"location":"java/spring/spring/IocContainer/#_3","title":"\u5f02\u6b65\u7684\u76d1\u542c","text":"<p>\u5982\u679c\u4f60\u60f3\u5f02\u6b65\u5730\u5904\u7406\u4e8b\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528@Async</p> <pre><code>@EventListener\n@Async\npublic void processBlockedListEvent(BlockedListEvent event) {\n    // BlockedListEvent is processed in a separate thread\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#_4","title":"\u6709\u5e8f\u7684\u76d1\u542c","text":"<p>\u5982\u679c\u4f60\u60f3\u5728\u53e6\u4e00\u4e2a\u76d1\u542c\u5668\u4e4b\u524d\u5148\u76d1\u542c\u5230\u4e8b\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528@Order</p> <pre><code>@EventListener\n@Order(42)\npublic void processBlockedListEvent(BlockedListEvent event) {\n    // notify appropriate parties via notificationAddress...\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#event","title":"\u6cdb\u578bevent","text":"<p>You can also use generics to further define the structure of your event. Consider using an <code>EntityCreatedEvent&lt;T&gt;</code> where <code>T</code> is the type of the actual entity that got created. For example, you can create the following listener definition to receive only <code>EntityCreatedEvent</code> for a <code>Person</code>:</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6cdb\u578b\u6765\u8fdb\u4e00\u6b65\u5b9a\u4e49\u4f60\u7684\u4e8b\u4ef6\u7ed3\u6784\u3002\u8003\u8651\u4f7f\u7528EntityCreatedEvent\uff0c\u5176\u4e2dT\u662f\u5b9e\u9645\u521b\u5efa\u7684\u5b9e\u4f53\u7684\u7c7b\u578b\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u521b\u5efa\u4ee5\u4e0b\u76d1\u542c\u5668\u5b9a\u4e49\uff0c\u4ee5\u4fbf\u53ea\u63a5\u6536Person\u7684EntityCreatedEvent\u3002 <pre><code>@EventListener\npublic void onPersonCreated(EntityCreatedEvent&lt;Person&gt; event) {\n    // ...\n}\n</code></pre> <p>Due to type erasure, this works only if the event that is fired resolves the generic parameters on which the event listener filters (that is, something like <code>class PersonCreatedEvent extends EntityCreatedEvent&lt;Person&gt; { \u2026 }</code>).</p> <p>In certain circumstances, this may become quite tedious if all events follow the same structure (as should be the case for the event in the preceding example). In such a case, you can implement <code>ResolvableTypeProvider</code> to guide the framework beyond what the runtime environment provides. The following event shows how to do so:</p> <p>\u7531\u4e8e\u6cdb\u578b\u64e6\u9664\uff0c\u53ea\u6709\u5f53\u88ab\u89e6\u53d1\u7684\u4e8b\u4ef6\u89e3\u6790\u4e86\u4e8b\u4ef6\u76d1\u542c\u5668\u8fc7\u6ee4\u7684\u901a\u7528\u53c2\u6570\u65f6\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u624d\u4f1a\u8d77\u4f5c\u7528\uff08\u4e5f\u5c31\u662f\u8bf4\uff0c\u7c7b\u4f3c\u4e8eclass PersonCreatedEvent extends EntityCreatedEvent { ... }\uff09\u3002 <p>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6240\u6709\u7684\u4e8b\u4ef6\u90fd\u9075\u5faa\u76f8\u540c\u7684\u7ed3\u6784\uff0c\u8fd9\u53ef\u80fd\u4f1a\u53d8\u5f97\u76f8\u5f53\u4e4f\u5473\uff08\u5c31\u50cf\u524d\u9762\u4f8b\u5b50\u4e2d\u7684\u4e8b\u4ef6\u4e00\u6837\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u5b9e\u73b0ResolvableTypeProvider\u6765\u5f15\u5bfc\u6846\u67b6\u8d85\u8d8a\u8fd0\u884c\u65f6\u73af\u5883\u63d0\u4f9b\u7684\u5185\u5bb9\u3002\u4e0b\u9762\u7684\u4e8b\u4ef6\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\u3002</p> <pre><code>public class EntityCreatedEvent&lt;T&gt; extends ApplicationEvent implements ResolvableTypeProvider {\n\n    public EntityCreatedEvent(T entity) {\n        super(entity);\n    }\n\n    @Override\n    public ResolvableType getResolvableType() {\n        return ResolvableType.forClassWithGenerics(getClass(), ResolvableType.forInstance(getSource()));\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/IocContainer/#1153-low-level-resources","title":"1.15.3 \u65b9\u4fbf\u5730\u83b7\u53d6Low-level Resources","text":"<p>\u4e3a\u4e86\u6700\u4f73\u7684\u4f7f\u7528\u548c\u7406\u89e3\u5e94\u7528\u4e0a\u4e0b\u6587\uff0c\u60a8\u5e94\u8be5\u719f\u6089Spring\u7684 <code>Resource</code> \u62bd\u8c61\uff0c\u5982Resources\u4e2d\u6240\u8ff0\u3002</p> <p>\u4e00\u4e2a\u5e94\u7528\u4e0a\u4e0b\u6587\u5c31\u662f\u4e00\u4e2aResourceLoader\uff0c\u5b83\u53ef\u4ee5\u7528\u6765\u52a0\u8f7dResource\u5bf9\u8c61\u3002Resource\u672c\u8d28\u4e0a\u662fJDK java.net.URL\u7c7b\u7684\u4e00\u4e2a\u529f\u80fd\u66f4\u4e30\u5bcc\u7684\u7248\u672c\u3002\u4e8b\u5b9e\u4e0a\uff0cResource\u7684\u5b9e\u73b0\u5728\u9002\u5f53\u7684\u5730\u65b9\u5305\u88f9\u4e86java.net.URL\u7684\u5b9e\u4f8b\u3002Resource\u53ef\u4ee5\u4ee5\u900f\u660e\u7684\u65b9\u5f0f\u4ece\u51e0\u4e4e\u4efb\u4f55\u4f4d\u7f6e\u83b7\u53d6\u4f4e\u7ea7\u8d44\u6e90\uff0c\u5305\u62ec\u4ececlasspath\u3001\u6587\u4ef6\u7cfb\u7edf\u4f4d\u7f6e\u3001\u4efb\u4f55\u53ef\u4ee5\u7528\u6807\u51c6URL\u63cf\u8ff0\u7684\u5730\u65b9\u4ee5\u53ca\u5176\u4ed6\u4e00\u4e9b\u53d8\u5316\u3002\u5982\u679c\u8d44\u6e90\u4f4d\u7f6e\u5b57\u7b26\u4e32\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8def\u5f84\uff0c\u6ca1\u6709\u4efb\u4f55\u7279\u6b8a\u7684\u524d\u7f00\uff0c\u90a3\u4e48\u8fd9\u4e9b\u8d44\u6e90\u7684\u6765\u6e90\u662f\u7279\u5b9a\u7684\uff0c\u9002\u5408\u4e8e\u5b9e\u9645\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u7c7b\u578b\u3002</p> <p>\u4f60\u53ef\u4ee5\u914d\u7f6e\u4e00\u4e2a\u90e8\u7f72\u5230\u5e94\u7528\u4e0a\u4e0b\u6587\u4e2d\u7684Bean\u6765\u5b9e\u73b0\u7279\u6b8a\u7684\u56de\u8c03\u63a5\u53e3ResourceLoaderAware\uff0c\u4ee5\u5728\u521d\u59cb\u5316\u65f6\u81ea\u52a8\u56de\u8c03\u5e94\u7528\u4e0a\u4e0b\u6587\u672c\u8eab\u4f20\u9012\u7684ResourceLoader\u3002\u4f60\u4e5f\u53ef\u4ee5\u66b4\u9732 <code>Resource</code>\u7c7b\u578b\u7684\u5c5e\u6027\uff0c\u7528\u4e8e\u8bbf\u95ee\u9759\u6001\u8d44\u6e90\u3002\u5b83\u4eec\u50cf\u5176\u4ed6\u5c5e\u6027\u4e00\u6837\u88ab\u6ce8\u5165\u5176\u4e2d\u3002\u60a8\u53ef\u4ee5\u5c06\u8fd9\u4e9bResource\u5c5e\u6027\u6307\u5b9a\u4e3a\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u8def\u5f84\uff0c\u5e76\u5728Bean\u90e8\u7f72\u65f6\u4f9d\u9760\u81ea\u52a8\u4ece\u8fd9\u4e9b\u6587\u672c\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5b9e\u9645\u7684Resource\u5bf9\u8c61\u3002</p> <p>\u63d0\u4f9b\u7ed9ApplicationContext\u6784\u9020\u51fd\u6570\u7684\u4f4d\u7f6e\u8def\u5f84\u6216\u8def\u5f84\u5b9e\u9645\u4e0a\u662f\u8d44\u6e90\u5b57\u7b26\u4e32\uff0c\u4ee5\u7b80\u5355\u7684\u5f62\u5f0f\uff0c\u6839\u636e\u5177\u4f53\u7684\u4e0a\u4e0b\u6587\u5b9e\u73b0\u8fdb\u884c\u9002\u5f53\u5904\u7406\u3002\u4f8b\u5982ClassPathXmlApplicationContext\u5c06\u4e00\u4e2a\u7b80\u5355\u7684\u4f4d\u7f6e\u8def\u5f84\u89c6\u4e3aclasspath\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5e26\u6709\u7279\u6b8a\u524d\u7f00\u7684\u4f4d\u7f6e\u8def\u5f84\uff08\u8d44\u6e90\u5b57\u7b26\u4e32\uff09\u6765\u5f3a\u5236\u52a0\u8f7d\u6765\u81eaclasspath\u6216URL\u7684\u5b9a\u4e49\uff0c\u800c\u4e0d\u7ba1\u5b9e\u9645\u7684\u4e0a\u4e0b\u6587\u7c7b\u578b\u5982\u4f55\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1154","title":"1.15.4 \u8ddf\u8e2a\u5e94\u7528\u542f\u52a8","text":"<p>ApplicationContext\u7ba1\u7406Spring\u5e94\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u5468\u671f\uff0c\u5e76\u56f4\u7ed5\u7ec4\u4ef6\u63d0\u4f9b\u4e30\u5bcc\u7684\u7f16\u7a0b\u6a21\u578b\u3002\u56e0\u6b64\uff0c\u590d\u6742\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u6709\u540c\u6837\u590d\u6742\u7684\u7ec4\u4ef6\u56fe\u548c\u542f\u52a8\u9636\u6bb5\u3002</p> <p>\u901a\u8fc7\u7279\u5b9a\u7684\u6307\u6807\u6765\u8ddf\u8e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u542f\u52a8\u6b65\u9aa4\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4e86\u89e3\u5728\u542f\u52a8\u9636\u6bb5\u7684\u65f6\u95f4\u82b1\u8d39\u5728\u54ea\u91cc\uff0c\u4f46\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u79cd\u65b9\u6cd5\u6765\u66f4\u597d\u5730\u7406\u89e3\u6574\u4e2a\u4e0a\u4e0b\u6587\u751f\u547d\u5468\u671f\u3002</p> <p>AbstractApplicationContext(\u53ca\u5176\u5b50\u7c7b)\u7684\u5de5\u5177\u662fApplicationStartup\uff0c\u5b83\u6536\u96c6\u5404\u79cd\u542f\u52a8\u9636\u6bb5\u7684StartupStep\u6570\u636e\u3002</p> <p>\u5e94\u7528\u4e0a\u4e0b\u6587\u751f\u547d\u5468\u671f\uff08\u57fa\u7840\u5305\u626b\u63cf\uff0c\u914d\u7f6e\u7c7b\u7ba1\u7406\uff09\u3002</p> <p>beans\u751f\u547d\u5468\u671f\uff08\u5b9e\u4f8b\u5316\u3001\u667a\u80fd\u521d\u59cb\u5316\u3001\u540e\u5904\u7406\uff09\u3002</p> <p>\u5e94\u7528events \u5904\u7406</p> <pre><code>// create a startup step and start recording\nStartupStep scanPackages = this.getApplicationStartup().start(\"spring.context.base-packages.scan\");\n// \u5728\u5f53\u524d\u9636\u6bb5\u6dfb\u52a0\u6807\u8bb0\nscanPackages.tag(\"packages\", () -&gt; Arrays.toString(basePackages));\n// \u6267\u884c\u6211\u4eec\u8981\u6d4b\u91cf\u7684\u5b9e\u9645\u6b65\u9aa4\nthis.scanner.scan(basePackages);\n// end the current step\nscanPackages.end();\n</code></pre> <p>\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0a\u4e0b\u6587\u5df2\u7ecf\u6709\u4e86\u591a\u4e2a\u6b65\u9aa4\u7684\u5de5\u5177\u3002\u4e00\u65e6\u88ab\u8bb0\u5f55\u4e0b\u6765\uff0c\u8fd9\u4e9b\u542f\u52a8\u6b65\u9aa4\u5c31\u53ef\u4ee5\u901a\u8fc7\u7279\u5b9a\u7684\u5de5\u5177\u8fdb\u884c\u6536\u96c6\u3001\u663e\u793a\u548c\u5206\u6790\u3002\u5bf9\u4e8e\u73b0\u6709\u542f\u52a8\u6b65\u9aa4\u7684\u5b8c\u6574\u5217\u8868\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u4e13\u95e8\u7684\u9644\u5f55\u90e8\u5206\u3002</p> <p>\u9ed8\u8ba4\u7684ApplicationStartup\u5b9e\u73b0\u662f\u4e00\u4e2a\u65e0\u64cd\u4f5c\u7684\u53d8\u91cf\uff0c\u4ee5\u6700\u5c0f\u7684\u5f00\u9500\u3002\u8fd9\u610f\u5473\u7740\u5728\u5e94\u7528\u7a0b\u5e8f\u542f\u52a8\u671f\u95f4\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u6536\u96c6\u4efb\u4f55\u6307\u6807\u3002Spring Framework\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528Java Flight Recorder\u8ddf\u8e2a\u542f\u52a8\u6b65\u9aa4\u7684\u5b9e\u73b0\u3002FlightRecorderApplicationStartup\u3002\u8981\u4f7f\u7528\u8fd9\u4e2a\u53d8\u91cf\uff0c\u60a8\u5fc5\u987b\u5728\u521b\u5efaApplicationContext\u540e\u7acb\u5373\u4e3a\u5176\u914d\u7f6e\u4e00\u4e2a\u5b9e\u4f8b\u3002</p> <p>\u5982\u679c\u5f00\u53d1\u8005\u8981\u63d0\u4f9b\u81ea\u5df1\u7684AbstractApplicationContext\u5b50\u7c7b\uff0c\u6216\u8005\u5e0c\u671b\u6536\u96c6\u66f4\u7cbe\u786e\u7684\u6570\u636e\uff0c\u4ed6\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528ApplicationStartup\u57fa\u7840\u67b6\u6784\u3002</p> <p>ApplicationStartup\u7684\u76ee\u7684\u662f\u53ea\u5728\u5e94\u7528\u7a0b\u5e8f\u542f\u52a8\u671f\u95f4\u548c\u6838\u5fc3\u5bb9\u5668\u4e2d\u4f7f\u7528\uff1b\u8fd9\u7edd\u4e0d\u662fJava\u5256\u6790\u5668\u6216\u6307\u6807\u5e93\uff08\u5982Micrometer\uff09\u7684\u66ff\u4ee3\u54c1\u3002 \u8981\u5f00\u59cb\u6536\u96c6\u81ea\u5b9a\u4e49\u7684StartupStep\uff0c\u7ec4\u4ef6\u53ef\u4ee5\u76f4\u63a5\u4ece\u5e94\u7528\u4e0a\u4e0b\u6587\u4e2d\u83b7\u53d6ApplicationStartup\u5b9e\u4f8b\uff0c\u4f7f\u5176\u7ec4\u4ef6\u5b9e\u73b0ApplicationStartupAware\uff0c\u6216\u8005\u5728\u4efb\u4f55\u6ce8\u5165\u70b9\u4e0a\u8be2\u95eeApplicationStartup\u7c7b\u578b\u3002</p> <p>\u5f00\u53d1\u4eba\u5458\u5728\u521b\u5efa\u81ea\u5b9a\u4e49\u542f\u52a8\u6b65\u9aa4\u65f6\uff0c\u4e0d\u5e94\u4f7f\u7528 \"spring.*\"\u547d\u540d\u7a7a\u95f4\u3002\u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u662f\u4e3aSpring\u5185\u90e8\u4f7f\u7528\u800c\u4fdd\u7559\u7684\uff0c\u53ef\u80fd\u4f1a\u53d1\u751f\u53d8\u5316\u3002</p>"},{"location":"java/spring/spring/IocContainer/#116-beanfactory","title":"1.16 \u5173\u4e8e<code>BeanFactory</code>","text":"<p>The <code>BeanFactory</code> API provides the underlying basis for Spring\u2019s IoC functionality. Its specific contracts are mostly used in integration with other parts of Spring and related third-party frameworks, and its <code>DefaultListableBeanFactory</code> implementation is a key delegate within the higher-level <code>GenericApplicationContext</code> container.</p> <p><code>BeanFactory</code> and related interfaces (such as <code>BeanFactoryAware</code>, <code>InitializingBean</code>, <code>DisposableBean</code>) are important integration points for other framework components. By not requiring any annotations or even reflection, they allow for very efficient interaction between the container and its components. Application-level beans may use the same callback interfaces but typically prefer declarative dependency injection instead, either through annotations or through programmatic configuration.</p> <p>Note that the core <code>BeanFactory</code> API level and its <code>DefaultListableBeanFactory</code> implementation do not make assumptions about the configuration format or any component annotations to be used. All of these flavors come in through extensions (such as <code>XmlBeanDefinitionReader</code> and <code>AutowiredAnnotationBeanPostProcessor</code>) and operate on shared <code>BeanDefinition</code> objects as a core metadata representation. This is the essence of what makes Spring\u2019s container so flexible and extensible.</p> <p>BeanFactory API\u4e3aSpringIOC\u529f\u80fd\u63d0\u4f9b\u4e86\u5e95\u5c42\u57fa\u7840\u3002\u5b83\u5177\u4f53\u89c4\u5b9a\u4e3b\u8981\u7528\u4e8eSpring\u5176\u4ed6\u90e8\u5206\u548c\u7b2c\u4e09\u65b9\u6846\u67b6\u7684\u96c6\u6210\uff0c\u5176DefaultListableBeanFactory\u5b9e\u73b0\u662f\u4e0a\u5c42GenericApplicationContext\u5bb9\u5668\u7684\u5173\u952e\u4ee3\u7406\u3002</p> <p>BeanFactory\u548c\u76f8\u5173\u63a5\u53e3\uff08\u5982BeanFactoryAware\u3001InitializingBean\u3001DisposableBean\uff09\u662f\u5176\u4ed6\u6846\u67b6\u7ec4\u4ef6\u7684\u91cd\u8981\u96c6\u6210\u70b9\u3002\u901a\u8fc7\u4e0d\u9700\u8981\u4efb\u4f55\u6ce8\u89e3\u751a\u81f3\u53cd\u5c04\uff0c\u4ed6\u4eec\u5141\u8bb8\u5bb9\u5668\u548c\u5176\u4ed6\u7ec4\u4ef6\u4e4b\u95f4\u8fdb\u884c\u975e\u5e38\u9ad8\u6548\u7684\u4ea4\u4e92\u3002\u5e94\u7528\u7ea7\u7684Bean\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u56de\u8c03\u63a5\u53e3\uff0c\u4f46\u901a\u5e38\u66f4\u503e\u5411\u4e8e\u901a\u8fc7\u6ce8\u89e3\u6216\u4ee3\u7801\u6765\u58f0\u660e\u6ce8\u5165\u4f9d\u8d56\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u6838\u5fc3BeanFactory API\u5c42\u53ca\u5176\u5b9e\u73b0DefaultListableBeanFactory\u5e76\u6ca1\u6709\u5bf9\u914d\u7f6e\u683c\u5f0f\u6216\u4efb\u4f55\u8981\u4f7f\u7528\u7684\u7ec4\u4ef6\u6ce8\u89e3\u505a\u51fa\u5047\u8bbe\u3002\u6240\u6709\u8fd9\u4e9b\u683c\u5f0f\u90fd\u662f\u901a\u8fc7\u6269\u5c55\uff08\u5982XmlBeanDefinitionReader\u548cAutowiredAnnotationBeanPostProcessor\uff09\u8fdb\u6765\u7684\uff0c\u5e76\u5728\u5171\u4eab\u7684BeanDefinition\u5bf9\u8c61\u4e0a\u64cd\u4f5c\uff0c\u4f5c\u4e3a\u6838\u5fc3\u5143\u6570\u636e\u8868\u793a\u3002\u8fd9\u5c31\u662fSpring\u7684\u5bb9\u5668\u5982\u6b64\u7075\u6d3b\u548c\u53ef\u6269\u5c55\u7684\u672c\u8d28\u3002</p>"},{"location":"java/spring/spring/IocContainer/#1161-beanfactory-applicationcontext","title":"1.16.1  <code>BeanFactory</code> \u8fd8\u662f<code>ApplicationContext</code>?","text":"<p>\u4e0b\u9762\u4ecb\u7ecdBeanFactory\u548cApplicationContext\u5bb9\u5668\u7ea7\u522b\u4e4b\u95f4\u7684\u5dee\u5f02\u4ee5\u53ca\u5bf9\u5f15\u5bfc\u7684\u5f71\u54cd\u3002</p> <p>\u4f60\u5e94\u8be5\u4f7f\u7528ApplicationContext\uff0c\u9664\u975e\u4f60\u6709\u5f88\u597d\u7684\u7406\u7531\u4e0d\u8fd9\u6837\u505a\uff0cGenericApplicationContext\u53ca\u5176\u5b50\u7c7bAnnotationConfigApplicationContext\u662f\u81ea\u5b9a\u4e49\u5f15\u5bfc\u7684\u5e38\u7528\u5b9e\u73b0\u3002\u8fd9\u4e9b\u662fSpring\u6838\u5fc3\u5bb9\u5668\u7684\u4e3b\u8981\u5165\u53e3\u70b9\uff0c\u7528\u4e8e\u6240\u6709\u5e38\u89c1\u7684\u76ee\u7684\uff1a\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\u3001\u89e6\u53d1classpath\u626b\u63cf\u3001\u7f16\u7a0b\u6ce8\u518cbean\u5b9a\u4e49\u548c\u6ce8\u89e3\u7c7b\uff0c\u4ee5\u53ca\uff08\u4ece5.0\u5f00\u59cb\uff09\u6ce8\u518c\u529f\u80fdbean\u5b9a\u4e49\u3002</p> <p>\u56e0\u4e3aApplicationContext\u5305\u542b\u4e86BeanFactory\u7684\u6240\u6709\u529f\u80fd\uff0c\u6240\u4ee5\u4e00\u822c\u63a8\u8350\u4f7f\u7528ApplicationContext\uff0c\u800c\u4e0d\u662f\u666e\u901a\u7684BeanFactory\uff0c\u9664\u975e\u662f\u9700\u8981\u5b8c\u5168\u63a7\u5236Bean\u5904\u7406\u7684\u573a\u666f\u3002\u5728ApplicationContext\u4e2d\uff08\u5982GenericApplicationContext\u5b9e\u73b0\uff09\uff0c\u6709\u51e0\u79cdBean\u662f\u901a\u8fc7\u60ef\u4f8b\uff08\u5373\u901a\u8fc7Bean\u540d\u79f0\u6216Bean\u7c7b\u578b--\u7279\u522b\u662f\u540e\u5904\u7406\u5668\uff09\u6765\u68c0\u6d4b\u7684\uff0c\u800c\u666e\u901a\u7684DefaultListableBeanFactory\u5bf9\u4efb\u4f55\u7279\u6b8a\u7684Bean\u90fd\u662f\u4e0d\u53ef\u77e5\u7684\u3002</p> <p>\u5bf9\u4e8e\u5bb9\u5668\u7684\u8bb8\u591a\u6269\u5c55\u529f\u80fd\uff0c\u5982\u6ce8\u89e3\u5904\u7406\u548cAOP\u4ee3\u7406\uff0cBeanPostProcessor\u6269\u5c55\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\u3002\u5982\u679c\u4f60\u53ea\u4f7f\u7528\u4e00\u4e2a\u666e\u901a\u7684DefaultListableBeanFactory\uff0c\u50cf\u540e\u5904\u7406\u5668\u9ed8\u8ba4\u4e0d\u4f1a\u88ab\u68c0\u6d4b\u548c\u6fc0\u6d3b\u3002\u8fd9\u79cd\u60c5\u51b5\u53ef\u80fd\u4f1a\u8ba9\u4eba\u611f\u5230\u56f0\u60d1\uff0c\u56e0\u4e3a\u5b9e\u9645\u4e0a\u4f60\u7684bean\u914d\u7f6e\u6ca1\u6709\u4efb\u4f55\u95ee\u9898\u3002\u76f8\u53cd\uff0c\u5728\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\uff0c\u5bb9\u5668\u9700\u8981\u901a\u8fc7\u989d\u5916\u7684\u8bbe\u7f6e\u8fdb\u884c\u5b8c\u5168\u7684\u5f15\u5bfc\u3002</p> <p>\u4e0b\u9762\u8868\u683c\u5c55\u793a <code>BeanFactory</code> \u548c <code>ApplicationContext</code> \u63d0\u4f9b\u7684\u529f\u80fd\u5217\u8868\uff1a</p> Feature <code>BeanFactory</code> <code>ApplicationContext</code> Bean instantiation/wiring Yes Yes Integrated lifecycle management No Yes Automatic <code>BeanPostProcessor</code> registration No Yes Automatic <code>BeanFactoryPostProcessor</code> registration No Yes Convenient <code>MessageSource</code> access (for internalization) No Yes Built-in <code>ApplicationEvent</code> publication mechanism No Yes <p>\u4e00\u4e2aAnnotationConfigApplicationContext\u5df2\u7ecf\u6ce8\u518c\u4e86\u6240\u6709\u5e38\u89c1\u7684\u6ce8\u89e3post-processors\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u6ce8\u89e3\uff08\u5982@EnableTransactionManagement\uff09\u5f15\u5165\u989d\u5916\u7684\u5904\u7406\u5668\u3002\u5728Spring\u57fa\u4e8e\u6ce8\u89e3\u7684\u914d\u7f6e\u6a21\u578b\u7684\u62bd\u8c61\u5c42\u6b21\u4e0a\uff0cbean\u540e\u5904\u7406\u5668\u7684\u6982\u5ff5\u53d8\u6210\u4e86\u4e00\u4e2a\u5355\u7eaf\u7684\u5185\u90e8\u5bb9\u5668\u7ec6\u8282\u3002</p>"},{"location":"java/spring/spring/Null-safetyAndLogging/","title":"7. Null-safety","text":"<p>\u867d\u7136java\u4e0d\u5141\u8bb8\u4f7f\u7528\u5b83\u7684\u7c7b\u578b\u7cfb\u7edf\u6765\u8868\u8fbenull-safety\uff0c\u4f46\u662fspring\u6846\u67b6\u73b0\u5728\u5728org.springframework.lang\u5305\u4e0b\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u6ce8\u89e3\uff0c\u6765\u5141\u8bb8\u4f60\u58f0\u660eAPIs\u548c\u5b57\u6bb5\u7684null-safety\u3002</p> <ul> <li><code>@Nullable</code>: Annotation to indicate that a specific parameter, return value, or field can be <code>null</code>. \u8868\u793a\u53c2\u6570\uff0c\u8fd4\u56de\u503c\uff0c\u5b57\u6bb5\u53ef\u4ee5\u4e3anull\u7684\u6ce8\u89e3</li> <li><code>@NonNull</code>: Annotation to indicate that a specific parameter, return value, or field cannot be <code>null</code> (not needed on parameters / return values and fields where <code>@NonNullApi</code> and <code>@NonNullFields</code> apply, respectively).\u8fd9\u4e2a\u6ce8\u89e3\u8868\u793a\u6307\u5b9a\u7684\u53c2\u6570\uff0c\u8fd4\u56de\u503c\uff0c\u5b57\u6bb5\u4e0d\u80fd\u4e3anull\uff08\u4e0d\u9700\u8981\u5728\u53c2\u6570/\u8fd4\u56de\u503c\u548c\u5b57\u6bb5\u4e0a\u5206\u522b\u7684\u4f7f\u7528<code>@NonNullApi</code>\u548c<code>@NonNullFields</code></li> <li><code>@NonNullApi</code>: Annotation at the package level that declares non-null as the default semantics for parameters and return values.\u7528\u5728\u5305\u7ea7\u522b\u7684\u6ce8\u89e3\uff0c\u9ed8\u8ba4\u58f0\u660e\u53c2\u6570\u548c\u8fd4\u56de\u503c\u4e0d\u80fd\u4e3a\u7a7a</li> <li><code>@NonNullFields</code>: Annotation at the package level that declares non-null as the default semantics for fields.\u7528\u5728\u5305\u7ea7\u522b\u7684\u6ce8\u89e3\uff0c\u58f0\u660e\u53c2\u6570\u9ed8\u8ba4\u4e0d\u80fd\u4e3a\u7a7a</li> </ul> <p>spring\u6846\u67b6\u672c\u8eab\u4f7f\u7528\u4e86\u8fd9\u4e9b\u6ce8\u89e3\uff0c\u4f46\u662f\u4ed6\u4eec\u53ef\u4ee5\u5728\u4efb\u4f55\u57fa\u4e8espring\u7684java\u9879\u76ee\u4e2d\u4f7f\u7528\uff0c\u6765\u58f0\u660enull-safety\u7684APIs,\u548c\u53ef\u9009\u7684null-safe\u5b57\u6bb5\u3002\u6cdb\u578b\uff0cvarargs\u548c\u6570\u7ec4\u8fd8\u4e0d\u652f\u6301\uff0c\u4f46\u5e94\u8be5\u5f88\u5feb\u4f1a\u5728\u672a\u6765\u7248\u672c\u4e2d\u652f\u6301\uff0c\u6700\u65b0\u4fe1\u606f\u67e5\u770bSPR-15942\u3002\u5c06\u6765\u7684\u7248\u672c\u4e2d\uff0c\u4f1a\u505a\u4e00\u4e9b\u5fae\u8c03\uff0c\u65b9\u6cd5\u4f53\u4e2d\u7684\u7c7b\u578bnull-safe\u4e0d\u5728\u672c\u6b21\u7248\u672c\u529f\u80fd\u4e2d\u3002</p> <p>\u5176\u4ed6\u5e38\u89c1\u7684\u5e93\u5982reacter\u548cspring Data\u4e5f\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u7a7a\u5b89\u5168\u58f0\u660e\uff0c\u4e3aspring\u5f00\u53d1\u8005\u63d0\u4f9b\u4e86\u4e00\u81f4\u7684\u6574\u4f53\u4f53\u9a8c\u3002</p> <p>\u9664\u4e86\u4e3aspring\u9879\u76ee\u63d0\u4f9b\u660e\u786e\u7684\u58f0\u660e\u5916\uff0c\u8fd9\u4e9b\u6ce8\u89e3\u8fd8\u53ef\u4ee5\u88abIDE\u5f00\u53d1\u5de5\u5177\u7528\u6765\u63d0\u4f9b\u4e0enull-safety\u76f8\u5173\u7684\u8b66\u544a\uff0c\u907f\u514d\u5728\u8fd0\u884c\u65f6\u51fa\u73b0NullPointerException\u3002</p> <p>Spring annotations are meta-annotated with JSR 305 annotations (a dormant but wide-spread JSR). JSR-305 meta-annotations let tooling vendors like IDEA or Kotlin provide null-safety support in a generic way, without having to hard-code support for Spring annotations.</p> <p>It is not necessary nor recommended to add a JSR-305 dependency to the project classpath to take advantage of Spring null-safe API. Only projects such as Spring-based libraries that use null-safety annotations in their codebase should add <code>com.google.code.findbugs:jsr305:3.0.2</code> with <code>compileOnly</code> Gradle configuration or Maven <code>provided</code> scope to avoid compile warnings.</p> <p>spring\u6ce8\u89e3\u4f7f\u7528\u4e86 JSR 305  \u7684\u5143\u6ce8\u89e3\uff08\u4e00\u4e2a\u6682\u505c\u4f46\u662f\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684JSR\uff09\u3002JSR-305 \u5143\u6ce8\u89e3\u8ba9IDEA\u7b49\u4ee5\u901a\u7528\u65b9\u5f0f\u63d0\u4f9bnull-safety\u652f\u6301\uff0c\u65e0\u9700\u4e3aspring\u6ce8\u89e3\u786c\u7f16\u7801\u3002\u4e5f\u5c31\u662f\u4e0b\u9762\u4ee3\u7801\u5757\u4e2d\u7684@Nonnull(when = When.MAYBE)</p> <pre><code>/**\n * A common Spring annotation to declare that annotated elements can be {@code null} under\n * some circumstance.\n *\n * &lt;p&gt;Leverages JSR-305 meta-annotations to indicate nullability in Java to common\n * tools with JSR-305 support and used by Kotlin to infer nullability of Spring API.\n *\n * &lt;p&gt;Should be used at parameter, return value, and field level. Methods override should\n * repeat parent {@code @Nullable} annotations unless they behave differently.\n *\n * &lt;p&gt;Can be used in association with {@code @NonNullApi} or {@code @NonNullFields} to\n * override the default non-nullable semantic to nullable.\n *\n * @author Sebastien Deleuze\n * @author Juergen Hoeller\n * @since 5.0\n * @see NonNullApi\n * @see NonNullFields\n * @see NonNull\n */\n@Target({ElementType.METHOD, ElementType.PARAMETER, ElementType.FIELD})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Nonnull(when = When.MAYBE)\n@TypeQualifierNickname\npublic @interface Nullable {\n}\n</code></pre> <p>\u4e0d\u9700\u8981\u4e5f\u4e0d\u5efa\u8bae\u5728\u9879\u76ee\u4e2d\u589e\u52a0JSR-305\u7684\u4f9d\u8d56\uff0c\u4ee5\u5229\u7528spring\u7684null-safe API\u3002\u53ea\u6709\u57fa\u4e8espring\u7684\u9879\u76ee\u5728\u4ee3\u7801\u91cc\u4f7f\u7528null-safety\u6ce8\u89e3\uff0c\u624d\u5e94\u8be5\u6dfb\u52a0<code>com.google.code.findbugs:jsr305:3.0.2</code>\uff0c\u5e76\u4e14\u914d\u7f6e<code>compileOnly</code>\u4e3a<code>provided</code>\u6765\u907f\u514d\u7f16\u8bd1\u8b66\u544a\u3002</p>"},{"location":"java/spring/spring/Null-safetyAndLogging/#8-data-buffers","title":"8. Data Buffers","text":"<p>Java NIO provides <code>ByteBuffer</code> but many libraries build their own byte buffer API on top, especially for network operations where reusing buffers and/or using direct buffers is beneficial for performance. For example Netty has the <code>ByteBuf</code> hierarchy, Undertow uses XNIO, Jetty uses pooled byte buffers with a callback to be released, and so on. The <code>spring-core</code> module provides a set of abstractions to work with various byte buffer APIs as follows:</p> <p>\u867d\u7136Java NIO\u63d0\u4f9b\u4e86ByteBuffer\uff0c\u4f46\u8bb8\u591a\u6846\u67b6\u4e5f\u6784\u5efa\u4e86\u4ed6\u4eec\u81ea\u5df1\u7684byte buffer\u9876\u5c42API\uff0c\u7279\u522b\u5bf9\u4e8e\u7f51\u7edc\u64cd\u4f5c\uff0c\u4f1a\u91cd\u7528buffers\u6216\u8005\u76f4\u63a5\u4f7f\u7528buffer\u5bf9\u6027\u80fd\u5e2e\u52a9\u5f88\u5927\u3002\u4f8b\u5982Netty\u7684ByteBuf\u7b49\u7ea7\uff0cUndertow\u4f7f\u7528XNIO\uff0cJetty\u4f7f\u7528\u6c60\u5316\u7684\u5e26\u6709\u56de\u8c03\u7684byte buffers\u7b49\u7b49\u3002Spring-core\u6a21\u5757\u63d0\u4f9b\u4e86\u62bd\u8c61\u7684byte bufferAPIs\uff0c\u5982\u4e0b\uff1a</p> <ul> <li><code>DataBufferFactory</code> \u521b\u5efadata buffer.</li> <li><code>DataBuffer</code> represents a byte buffer, which may be pooled.</li> <li><code>DataBufferUtils</code>  \u63d0\u4f9b\u4e86data buffers\u4e00\u4e9b\u5b9e\u7528\u7684\u65b9\u6cd5.</li> <li>Codecs decode or encode streams data buffer streams into higher level objects.</li> </ul>"},{"location":"java/spring/spring/Null-safetyAndLogging/#9-logging","title":"9. Logging","text":"<p>\u5c06Log4j 2.X\u6216\u8005Logback\u6dfb\u52a0\u5230classpath\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u989d\u5916\u914d\u7f6e\uff0cSpring\u6846\u67b6\u4f1a\u81ea\u52a8\u9002\u914d\u4f60\u7684\u9009\u62e9\u3002\u66f4\u591a\u4fe1\u606f\u67e5\u770bSpring Boot Logging Reference Documentation.</p> <pre><code>public class MyBean {\n    private final Log log = LogFactory.getLog(getClass());\n    // ...\n}\n</code></pre>"},{"location":"java/spring/spring/Null-safetyAndLogging/#10","title":"10. \u9644\u5f55","text":"<p>\u4e0b\u9762\u5c55\u793a\u6838\u5fc3\u5bb9\u5668\u7684\u5df2\u5b58\u5728\u7684StartupSteps\uff0c</p> <p>\u6bcf\u4e2astartup\u6b65\u9aa4\u7684\u540d\u5b57\u548c\u8be6\u7ec6\u4fe1\u606f\u5e76\u4e0d\u662f\u786e\u5b9a\u7684\u5408\u7ea6\uff0c\u4f1a\u968f\u7740\u5177\u4f53\u7684\u5b9e\u73b0\u800c\u53d1\u751f\u6539\u53d8\u3002</p> <p>\u6838\u5fc3\u5bb9\u5668\u4e2d\u7684\u5e94\u7528\u542f\u52a8\u9636\u6bb5\u5b9a\u4e49\uff1a</p> Name Description Tags <code>spring.beans.instantiate</code> Instantiation of a bean and its dependencies. <code>beanName</code> the name of the bean, <code>beanType</code> the type required at the injection point. <code>spring.beans.smart-initialize</code> Initialization of <code>SmartInitializingSingleton</code> beans. <code>beanName</code> the name of the bean. <code>spring.context.annotated-bean-reader.create</code> Creation of the <code>AnnotatedBeanDefinitionReader</code>. <code>spring.context.base-packages.scan</code> Scanning of base packages. <code>packages</code> array of base packages for scanning. <code>spring.context.beans.post-process</code> Beans post-processing phase. <code>spring.context.bean-factory.post-process</code> \u8c03\u7528\u5b9e\u73b0\u4e86 <code>BeanFactoryPostProcessor</code> \u7684beans. <code>postProcessor</code> the current post-processor. <code>spring.context.beandef-registry.post-process</code> \u8c03\u7528\u5b9e\u73b0\u4e86<code>BeanDefinitionRegistryPostProcessor</code>\u63a5\u53e3\u7684 beans. <code>postProcessor</code> the current post-processor. <code>spring.context.component-classes.register</code> Registration of component classes through <code>AnnotationConfigApplicationContext#register</code>. <code>classes</code> array of given classes for registration. <code>spring.context.config-classes.enhance</code> Enhancement of configuration classes with CGLIB proxies. <code>classCount</code> count of enhanced classes. <code>spring.context.config-classes.parse</code> Configuration classes parsing phase with the <code>ConfigurationClassPostProcessor</code>. <code>classCount</code> count of processed classes. <code>spring.context.refresh</code> Application context refresh phase.\u5e94\u7528\u5237\u65b0\u9636\u6bb5 <code>spring.event.invoke-listener</code> Invocation of event listeners, if done in the main thread.\u8c03\u7528\u4e8b\u4ef6\u76d1\u542c\u5668\uff0c\u5982\u679c\u5728\u4e3b\u7ebf\u7a0b\u4e2d\u5b8c\u6210 <code>event</code> the current application event, <code>eventType</code> its type and <code>listener</code> the listener processing this event."},{"location":"java/spring/spring/Overview/","title":"Overview","text":"<p>https://docs.spring.io/spring-framework/docs/current/reference/html/</p>"},{"location":"java/spring/spring/Overview/#spring-framework-documentation","title":"Spring Framework Documentation","text":"Overview history, design philosophy, feedback, getting started. Core IoC Container, Events, Resources, i18n, Validation, Data Binding, Type Conversion, SpEL, AOP. Testing Mock Objects, TestContext Framework, Spring MVC Test, WebTestClient. Data Access Transactions, DAO Support, JDBC, R2DBC, O/R Mapping, XML Marshalling. Web Servlet Spring MVC, WebSocket, SockJS, STOMP Messaging. Web Reactive Spring WebFlux, WebClient, WebSocket, RSocket. Integration Remoting, JMS, JCA, JMX, Email, Tasks, Scheduling, Caching. Languages Kotlin, Groovy, Dynamic Languages. Appendix Spring properties. Wiki What\u2019s New, Upgrade Notes, Supported Versions, and other cross-version information. <p>Spring makes it easy to create Java enterprise applications. It provides everything you need to embrace the Java language in an enterprise environment, with support for Groovy and Kotlin as alternative languages on the JVM, and with the flexibility to create many kinds of architectures depending on an application\u2019s needs. As of Spring Framework 5.1, Spring requires JDK 8+ (Java SE 8+) and provides out-of-the-box support for JDK 11 LTS. Java SE 8 update 60 is suggested as the minimum patch release for Java 8, but it is generally recommended to use a recent patch release.</p> <p>Spring supports a wide range of application scenarios. In a large enterprise, applications often exist for a long time and have to run on a JDK and application server whose upgrade cycle is beyond developer control. Others may run as a single jar with the server embedded, possibly in a cloud environment. Yet others may be standalone applications (such as batch or integration workloads) that do not need a server.</p> <p>Spring is open source. It has a large and active community that provides continuous feedback based on a diverse range of real-world use cases. This has helped Spring to successfully evolve over a very long time.</p> <p>spring\u8ba9\u5f00\u53d1\u4f01\u4e1a\u5e94\u7528\u53d8\u5f97\u66f4\u7b80\u5355\u3002\u4ed6\u63d0\u4f9b\u4e86\u5728\u4f01\u4e1a\u73af\u5883\u4e2d\u62e5\u62b1java\u8bed\u8a00\u6240\u9700\u7684\u4e00\u5207\uff0c\u652f\u6301Groovy\u548cKotlin\u4f5c\u4e3aJVM\u4e0a\u7684\u66ff\u4ee3\u8bed\u8a00\uff0c\u5e76\u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u7684\u9700\u6c42\u7075\u6d3b\u5730\u521b\u5efa\u591a\u79cd\u67b6\u6784\u3002\u4eceSpring Framework 5.1\u5f00\u59cb\uff0cSpring\u9700\u8981JDK 8+\uff08Java SE 8+\uff09\uff0c\u5e76\u63d0\u4f9b\u5bf9JDK 11 LTS\u7684\u5f00\u7bb1\u652f\u6301\u3002\u5efa\u8bae\u5c06Java SE 8\u66f4\u65b060\u4f5c\u4e3aJava 8\u7684\u6700\u5c0f\u8865\u4e01\u7248\u672c\uff0c\u4f46\u4e00\u822c\u5efa\u8bae\u4f7f\u7528\u6700\u8fd1\u7684\u8865\u4e01\u7248\u672c\u3002</p> <p>spring\u652f\u6301\u5e7f\u6cdb\u7684\u5e94\u7528\u573a\u666f\u3002\u5728\u5927\u578b\u4f01\u4e1a\u5e94\u7528\u4e2d\uff0c\u5e94\u7528\u7a0b\u5e8f\u7ecf\u5e38\u5b58\u5728\u5f88\u957f\u65f6\u95f4\uff0c\u800c\u4e14\u5fc5\u987b\u8fd0\u884c\u5728JDK\u548c\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\u4e0a\uff0c\u5176\u5347\u7ea7\u5468\u671f\u8d85\u51fa\u4e86\u5f00\u53d1\u4eba\u5458\u7684\u63a7\u5236\u8303\u56f4\u3002\u5176\u4ed6\u7684\u5e94\u7528\u53ef\u80fd\u8fd0\u884c\u4ee5\u5d4c\u5165\u670d\u52a1\u5668\u7684\u5f62\u5f0f\uff0c\u4ee5\u5355\u4e2ajar\u8fd0\u884c\uff0c\u4f8b\u5982\u4e91\u670d\u52a1\u5668\u4e0a\u3002\u4e5f\u6709\u4e00\u4e9b\u53ef\u80fd\u662f\u72ec\u7acb\u7684\u5e94\u7528\uff08\u5982\u6279\u5904\u7406\u6216\u8005\u96c6\u6210\u5de5\u4f5c\u8d1f\u8f7d\uff09\uff0c\u4e0d\u9700\u8981\u670d\u52a1\u5668\u3002</p> <p>spring \u662f\u5f00\u6e90\u7684\u3002\u5b83\u62e5\u6709\u5e9e\u5927\u800c\u5e7f\u6cdb\u7684\u793e\u533a\uff0c\u6839\u636e\u5404\u79cd\u4e0d\u540c\u7684\u5b9e\u9645\u7528\u4f8b\u63d0\u4f9b\u6301\u7eed\u53cd\u9988\u3002\u8fd9\u5e2e\u52a9spring\u80fd\u5728\u5f88\u957f\u4e00\u6bb5\u65f6\u95f4\u5185\u4fdd\u6301\u6210\u529f\u3002</p>"},{"location":"java/spring/spring/Overview/#1-what-we-mean-by-spring","title":"1. What We Mean by \"Spring\"","text":"<p>'spring'\u5728\u4e0d\u540c\u7684\u8bed\u5883\u4e0b\u6709\u4e0d\u540c\u7684\u542b\u4e49\u3002\u5b83\u53ef\u4ee5\u7528\u6765\u6307spring\u6846\u67b6\u9879\u76ee\u672c\u8eab\uff0c\u8fd9\u662f\u6700\u5f00\u59cb\u7684\u65f6\u5019\u3002\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u5176\u4ed6\u7684spring\u9879\u76ee\u4e5f\u5efa\u7acb\u5728spring\u6846\u67b6\u4e4b\u4e0a\u3002\u5927\u591a\u6570\u60c5\u51b5\uff0c\u5f53\u4eba\u4eec\u8bf4\u201cspring\u201d\u65f6\uff0c\u610f\u5473\u7740\u6574\u4e2aspring\u9879\u76ee\u5bb6\u65cf\u3002\u672c\u6587\u6863\u5173\u6ce8\u7684\u662fspring\u6846\u67b6\u672c\u8eab\u3002</p> <p>spring\u6846\u67b6\u5206\u4e3a\u591a\u4e2a\u6a21\u5757\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u9700\u8981\u7684\u6a21\u5757\u3002\u6700\u91cd\u8981\u7684\u662f\u6838\u5fc3\u5bb9\u5668\uff0c\u5305\u542b\u914d\u7f6e\u6a21\u5757\u548c\u4f9d\u8d56\u6ce8\u5165\u3002\u9664\u6b64\u4e4b\u5916\uff0cspring\u6846\u67b6\u8fd8\u4e3a\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u57fa\u7840\u6027\u7684\u652f\u6301\uff0c\u5305\u62ec\u6d88\u606f\u4f20\u9012\uff0c\u4e8b\u52a1\u548c\u6301\u4e45\u5316\uff0c\u4ee5\u53caweb\u670d\u52a1\u3002\u4e5f\u8fd8\u5305\u62ec\u57fa\u4e8eservlet\u7684spring mvc\u6846\u67b6\uff0c\u4ee5\u53caSpring WebFlux\u7684reactive web\u6846\u67b6\u3002</p> <p>\u5173\u4e8e\u6a21\u5757\u7684\u8bf4\u660e\uff1a\u7b80\u5355\u8bf4\u5c31\u662fjar\u652f\u6301JDK9\u3002</p>"},{"location":"java/spring/spring/Overview/#2-history-of-spring-and-the-spring-framework","title":"2. History of Spring and the Spring Framework","text":"<p>spring\u8bde\u751f\u4e8e2003\u5e74\uff0c\u662f\u4e3a\u4e86\u5e94\u5bf9\u65e9\u671f\u590d\u6742\u7684J2EE\u89c4\u8303\u3002\u867d\u7136\u6709\u4e9b\u4eba\u8ba4\u4e3ajava EE\u548cspring\u662f\u7ade\u4e89\u5173\u7cfb\uff0c\u4f46\u4e8b\u5b9e\u4e0a\uff0cspring\u662f\u5bf9java EE\u7684\u8865\u5145\u3002spring\u7f16\u7a0b\u5e76\u4e0d\u5305\u542bjava EE\u5e73\u53f0\u89c4\u8303\uff1b\u76f8\u53cdspring\u96c6\u6210\u4e86java EE\u4e2d\u7684\u4e2a\u522b\u89c4\u8303\uff1a</p> <ul> <li>Servlet API (JSR 340)</li> <li>WebSocket API (JSR 356)</li> <li>Concurrency Utilities (JSR 236)</li> <li>JSON Binding API (JSR 367)</li> <li>Bean Validation (JSR 303)</li> <li>JPA (JSR 338)</li> <li>JMS (JSR 914)</li> <li>as well as JTA/JCA setups for transaction coordination, if necessary.</li> </ul> <p>spring\u6846\u67b6\u8fd8\u652f\u6301\u4f9d\u8d56\u6ce8\u5165 (JSR 330)\u548c\u901a\u7528\u6ce8\u89e3(JSR 250) \u89c4\u8303\u3002\u5f00\u53d1\u8005\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u8fd9\u4e9bjava EE\u89c4\u8303\u6765\u4ee3\u66ffspring\u6846\u67b6\u63d0\u4f9b\u7684\u3002</p> <p>\u4eceSpring Framework 5.0\u5f00\u59cb\uff0cSpring\u81f3\u5c11\u9700\u8981Java EE 7\u7ea7\u522b\uff08\u5982Servlet 3.1+\u3001JPA 2.1+\uff09--\u540c\u65f6\u5728\u8fd0\u884c\u65f6\u9047\u5230Java EE 8\u7ea7\u522b\uff08\u5982Servlet 4.0\u3001JSON Binding API\uff09\u7684\u8f83\u65b0API\u65f6\uff0c\u63d0\u4f9b\u5f00\u7bb1\u5373\u7528\u7684\u96c6\u6210\u3002\u8fd9\u4f7f\u5f97Spring\u4e0eTomcat 8\u548c9\u3001WebSphere 9\u548cJBoss EAP 7\u7b49\u5b8c\u5168\u517c\u5bb9\u3002</p> <p>\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0cJava EE\u5728\u5e94\u7528\u7a0b\u5e8f\u5f00\u53d1\u4e2d\u7684\u4f5c\u7528\u4e5f\u5728\u4e0d\u65ad\u53d1\u5c55\u3002\u5728Java EE\u548cSpring\u7684\u65e9\u671f\uff0c\u5e94\u7528\u7a0b\u5e8f\u7684\u521b\u5efa\u662f\u4e3a\u4e86\u90e8\u7f72\u5230\u5e94\u7528\u670d\u52a1\u5668\u4e0a\u3002\u4eca\u5929\uff0c\u5728Spring Boot\u7684\u5e2e\u52a9\u4e0b\uff0c\u5e94\u7528\u7a0b\u5e8f\u662f\u4ee5\u5f00\u53d1\u548c\u4e91\u53cb\u597d\u7684\u65b9\u5f0f\u521b\u5efa\u7684\uff0c\u5d4c\u5165\u4e86Servlet\u5bb9\u5668\uff0c\u6539\u53d8\u8d77\u6765\u4e5f\u5f88\u7b80\u5355\u3002\u4eceSpring Framework 5\u5f00\u59cb\uff0cWebFlux\u5e94\u7528\u751a\u81f3\u4e0d\u76f4\u63a5\u4f7f\u7528Servlet API\uff0c\u53ef\u4ee5\u5728\u975eServlet\u5bb9\u5668\u7684\u670d\u52a1\u5668\uff08\u5982Netty\uff09\u4e0a\u8fd0\u884c\u3002</p> <p>Spring\u4e0d\u65ad\u521b\u65b0\uff0c\u4e0d\u65ad\u53d1\u5c55\u3002\u5728Spring\u6846\u67b6\u4e4b\u5916\uff0c\u8fd8\u6709\u5176\u4ed6\u9879\u76ee\uff0c\u5982Spring Boot\u3001Spring Security\u3001Spring Data\u3001Spring Cloud\u3001Spring Batch\u7b49\u3002\u9700\u8981\u8bb0\u4f4f\u7684\u662f\uff0c\u6bcf\u4e2a\u9879\u76ee\u90fd\u6709\u81ea\u5df1\u7684\u6e90\u4ee3\u7801\u5e93\u3001\u95ee\u9898\u8ddf\u8e2a\u5668\u548c\u53d1\u5e03\u8282\u594f\u3002\u8bf7\u53c2\u9605spring.io/projects\u4e86\u89e3Spring\u9879\u76ee\u7684\u5b8c\u6574\u5217\u8868\u3002</p>"},{"location":"java/spring/spring/Overview/#3-design-philosophy","title":"3. Design Philosophy \u8bbe\u8ba1\u54f2\u5b66","text":"<p>\u5f53\u4f60\u4e86\u89e3\u4e00\u4e2a\u6846\u67b6\u65f6\uff0c\u4e0d\u4ec5\u8981\u77e5\u9053\u4ed6\u80fd\u505a\u4ec0\u4e48\uff0c\u8fd8\u8981\u77e5\u9053\u5b83\u9075\u5faa\u4ec0\u4e48\u539f\u5219\u3002\u4ee5\u4e0b\u662fspring\u7684\u6307\u5bfc\u539f\u5219\uff1a</p> <ul> <li>\u5728\u6bcf\u4e2a\u5c42\u9762\u63d0\u4f9b\u9009\u62e9\u3002spring\u8ba9\u4f60\u5c3d\u53ef\u80fd\u5730\u63a8\u8fdf\u8bbe\u8ba1\u51b3\u7b56\u7684\u65f6\u95f4\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u505a\u914d\u7f6e\u6765\u5207\u6362\u6301\u4e45\u5316\u4f9d\u8d56\uff0c\u800c\u65e0\u9700\u6539\u53d8\u4ee3\u7801\u3002\u5bf9\u4e8e\u5176\u4ed6\u57fa\u7840\u6846\u67b6\u548c\u7b2c\u4e09\u65b9\u7684\u96c6\u6210\u4e5f\u662f\u5982\u6b64\u3002</li> <li>\u9002\u5e94\u4e0d\u540c\u7684\u89c2\u70b9\u3002spring\u62e5\u62b1\u7075\u6d3b\u6027\uff0c\u4e0d\u4f1a\u53bb\u51b3\u5b9a\u4e8b\u60c5\u5e94\u8be5\u5982\u4f55\u505a\u3002\u5b83\u4ee5\u4e0d\u540c\u7684\u89c6\u89d2\u63d0\u4f9b\u5e7f\u6cdb\u7684\u5e94\u7528\u9700\u6c42</li> <li>\u4fdd\u6301\u5f3a\u5927\u7684\u5411\u540e\u517c\u5bb9\u6027\u3002Spring\u7684\u8fdb\u5316\u7ecf\u8fc7\u7cbe\u5fc3\u7ba1\u7406\uff0c\u8feb\u4f7f\u4e0d\u540c\u7248\u672c\u4e4b\u95f4\u5f88\u5c11\u6709\u4e2d\u65ad\u6027\u7684\u53d8\u5316\u3002Spring\u652f\u6301\u4e00\u7cfb\u5217\u7cbe\u5fc3\u9009\u62e9\u7684JDK\u7248\u672c\u548c\u7b2c\u4e09\u65b9\u5e93\uff0c\u4ee5\u65b9\u4fbf\u7ef4\u62a4\u4f9d\u8d56Spring\u7684\u5e94\u7528\u7a0b\u5e8f\u548c\u5e93\u3002</li> <li>\u5173\u5fc3API\u8bbe\u8ba1\u3002Spring\u56e2\u961f\u82b1\u4e86\u5927\u91cf\u7684\u5fc3\u601d\u548c\u65f6\u95f4\u6765\u5236\u4f5c\u76f4\u89c2\u7684API\uff0c\u5e76\u5728\u8bb8\u591a\u7248\u672c\u548c\u8bb8\u591a\u5e74\u5185\u4fdd\u6301\u4e0d\u53d8\u3002</li> <li>\u8bbe\u7f6e\u9ad8\u8d28\u91cf\u7684\u4ee3\u7801\u6807\u51c6\u3002spring\u5f3a\u8c03\u6709\u610f\u4e49\u7684\u3001\u6700\u65b0\u7684\u548c\u6807\u51c6\u7684Javadoc\u3002\u5b83\u662f\u6781\u5c11\u6570\u53ef\u4ee5\u5ba3\u79f0\u4ee3\u7801\u7ed3\u6784\u5e72\u51c0\uff0c\u5305\u4e4b\u95f4\u6ca1\u6709\u5faa\u73af\u4f9d\u8d56\u7684\u9879\u76ee\u4e4b\u4e00\u3002</li> </ul>"},{"location":"java/spring/spring/Overview/#4getting-started","title":"4.Getting Started","text":"<p>\u5982\u679c\u60a8\u521a\u521a\u5f00\u59cb\u4f7f\u7528Spring\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u901a\u8fc7Spring Boot\u6765\u5f00\u59cb\u4f7f\u7528Spring\u6846\u67b6\u3002Spring Boot\u63d0\u4f9b\u4e86\u4e00\u79cd\u5feb\u901f\uff08\u53ef\u9009\u5730\uff09\u7684\u65b9\u6cd5\u6765\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8eSpring\u7684\u751f\u4ea7\u5c31\u7eea\u7684\u5e94\u7528\u7a0b\u5e8f\u3002\u5b83\u57fa\u4e8eSpring\u6846\u67b6\uff0c\u504f\u91cd\u4e8e\u7ea6\u5b9a\u800c\u975e\u914d\u7f6e\uff0c\u65e8\u5728\u8ba9\u60a8\u5c3d\u5feb\u542f\u52a8\u5e76\u8fd0\u884c\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528start.spring.io\u6765\u751f\u6210\u4e00\u4e2a\u57fa\u672c\u7684\u9879\u76ee\uff0c\u6216\u8005\u9075\u5faa \"\"Getting Started\" guides \"\u6307\u5357\uff0c\u6bd4\u5982 \"[Getting Started Building a RESTful Web Service](https://spring.io/guides/gs/rest-service/)\"\u3002\u9664\u4e86\u66f4\u5bb9\u6613\u6d88\u5316\u4e4b\u5916\uff0c\u8fd9\u4e9b\u6307\u5357\u8fd8\u975e\u5e38\u6ce8\u91cd\u4efb\u52a1\uff0c\u800c\u4e14\u5927\u591a\u6570\u6307\u5357\u90fd\u662f\u57fa\u4e8eSpring Boot\u7684\u3002\u5b83\u4eec\u8fd8\u6db5\u76d6\u4e86Spring\u7ec4\u5408\u4e2d\u7684\u5176\u4ed6\u9879\u76ee\uff0c\u5728\u89e3\u51b3\u67d0\u4e2a\u95ee\u9898\u65f6\uff0c\u4f60\u53ef\u80fd\u8981\u8003\u8651\u8fd9\u4e9b\u9879\u76ee\u3002</p>"},{"location":"java/spring/spring/Resource/","title":"Resource","text":"<p>\u672c\u7ae0\u4ecb\u7ecd\u4e86Spring\u5982\u4f55\u5904\u7406Resource \u4ee5\u53ca\u5982\u4f55\u5728Spring\u4e2d\u4f7f\u7528Resource \uff0c\u5305\u62ec\u4ee5\u4e0b\u4e3b\u9898\uff1a </p> <ul> <li>Introduction</li> <li>The Resource Interface</li> <li>Built-in Resource Implementations</li> <li>The <code>ResourceLoader</code></li> <li>The <code>ResourceLoaderAware</code> interface</li> <li>Resources as Dependencies</li> <li>Application Contexts and Resource Paths</li> </ul> <p></p>"},{"location":"java/spring/spring/Resource/#21","title":"2.1 \u4ecb\u7ecd","text":"<p>\u4e0d\u5e78\u7684\u662f\uff0cJava\u7684\u6807\u51c6java.net.URL\u7c7b\u548c\u5404\u79cdURL\u524d\u7f00\u7684\u6807\u51c6Handler\uff0c\u5bf9\u4e8e\u6240\u6709\u8bbf\u95ee\u4f4e\u7ea7\u8d44\u6e90\u7684\u6765\u8bf4\u8fd8\u4e0d\u591f\u5145\u5206\u3002\u4f8b\u5982\uff0c\u6ca1\u6709\u6807\u51c6\u5316\u7684URL\u5b9e\u73b0\u53ef\u4ee5\u7528\u6765\u8bbf\u95ee\u9700\u8981\u4ececlasspath\u6216\u76f8\u5bf9\u4e8eServletContext\u83b7\u53d6\u7684\u8d44\u6e90\u3002\u867d\u7136\u53ef\u4ee5\u4e3a\u4e13\u95e8\u7684URL\u524d\u7f00\u6ce8\u518c\u65b0\u7684Handler\uff08\u7c7b\u4f3c\u4e8ehttp:\u7b49\u524d\u7f00\u7684\u73b0\u6709\u5904\u7406\u7a0b\u5e8f\uff09\uff0c\u4f46\u8fd9\u901a\u5e38\u662f\u76f8\u5f53\u590d\u6742\u7684\uff0cURL\u63a5\u53e3\u4ecd\u7136\u7f3a\u4e4f\u4e00\u4e9b\u7406\u60f3\u7684\u529f\u80fd\uff0c\u4f8b\u5982\u68c0\u67e5\u88ab\u6307\u5411\u7684\u8d44\u6e90\u662f\u5426\u5b58\u5728\u7684\u65b9\u6cd5\u3002</p>"},{"location":"java/spring/spring/Resource/#22-resource","title":"2.2 Resource\u63a5\u53e3","text":"<p>Spring\u7684Resource\u63a5\u53e3\u65e8\u5728\u6210\u4e3a\u4e00\u4e2a\u80fd\u529b\u66f4\u5f3a\u7684\u63a5\u53e3\uff0c\u7528\u4e8e\u62bd\u8c61\u5bf9\u4f4e\u7ea7\u8d44\u6e90\u7684\u8bbf\u95ee\u3002\u4e0b\u9762\u7684\u5217\u8868\u663e\u793a\u4e86Resource\u63a5\u53e3\u7684\u5b9a\u4e49\uff1a</p> <pre><code>public interface Resource extends InputStreamSource {\n\n    boolean exists();\n\n    boolean isOpen();\n\n    URL getURL() throws IOException;\n\n    File getFile() throws IOException;\n\n    Resource createRelative(String relativePath) throws IOException;\n\n    String getFilename();\n\n    String getDescription();\n}\n</code></pre> <p>\u5982\u4e0a\uff0cResource\u63a5\u53e3\u7ee7\u627f\u4e86InputStreamSource\u63a5\u53e3\uff1a</p> <pre><code>public interface InputStreamSource {\n\n    InputStream getInputStream() throws IOException;\n}\n</code></pre> <p>Resource\u63a5\u53e3\u6700\u91cd\u8981\u7684\u51e0\u4e2a\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <ul> <li><code>getInputStream()</code>: Locates and opens the resource, returning an <code>InputStream</code> for reading from the resource. It is expected that each invocation returns a fresh <code>InputStream</code>. It is the responsibility of the caller to close the stream.\u5b9a\u4f4d\u5e76\u6253\u5f00\u8d44\u6e90\uff0c\u8fd4\u56de\u4e00\u4e2a\u7528\u4e8e\u8bfb\u53d6\u8d44\u6e90\u7684InputStream\u3002\u9884\u8ba1\u6bcf\u6b21\u8c03\u7528\u90fd\u4f1a\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684InputStream\u3002\u5173\u95ed\u8f93\u5165\u6d41\u662f\u8c03\u7528\u8005\u7684\u8d23\u4efb\u3002</li> <li><code>exists()</code>: \u8fd4\u56de\u4e00\u4e2a\u5e03\u5c14\u503c\u8868\u793a\u8d44\u6e90\u662f\u5426\u5b58\u5728\uff0c\u4ee5\u7269\u7406\u5f62\u5f0f in physical form.</li> <li><code>isOpen()</code>: Returns a <code>boolean</code> indicating whether this resource represents a handle with an open stream. If <code>true</code>, the <code>InputStream</code> cannot be read multiple times and must be read once only and then closed to avoid resource leaks. Returns <code>false</code> for all usual resource implementations, with the exception of <code>InputStreamResource</code>.\u8fd4\u56de\u4e00\u4e2a\u5e03\u5c14\u503c\uff0c\u8868\u793a\u8be5\u8d44\u6e90\u662f\u5426\u4ee3\u8868\u4e00\u4e2a\u5177\u6709\u5f00\u653e\u6d41\u7684\u53e5\u67c4\u3002\u5982\u679c\u4e3a\u771f\uff0c\u5219\u4e0d\u80fd\u591a\u6b21\u8bfb\u53d6InputStream\uff0c\u5fc5\u987b\u53ea\u8bfb\u53d6\u4e00\u6b21\uff0c\u7136\u540e\u5173\u95ed\uff0c\u4ee5\u907f\u514d\u8d44\u6e90\u6cc4\u6f0f\u3002\u9664\u4e86InputStreamResource\u4e4b\u5916\uff0c\u6240\u6709\u901a\u5e38\u7684\u8d44\u6e90\u5b9e\u73b0\u90fd\u8fd4\u56defalse\u3002</li> <li><code>getDescription()</code>: Returns a description for this resource, to be used for error output when working with the resource. This is often the fully qualified file name or the actual URL of the resource.\u8fd4\u56de\u6b64\u8d44\u6e90\u7684\u63cf\u8ff0\uff0c\u7528\u4e8e\u5904\u7406\u8d44\u6e90\u65f6\u7684\u9519\u8bef\u8f93\u51fa\u3002\u8fd9\u901a\u5e38\u662f\u5b8c\u5168\u9650\u5b9a\u7684\u6587\u4ef6\u540d\u6216\u8d44\u6e90\u7684\u5b9e\u9645URL\u3002</li> </ul> <p>Other methods let you obtain an actual <code>URL</code> or <code>File</code> object representing the resource (if the underlying implementation is compatible and supports that functionality).</p> <p>\u5176\u4ed6\u65b9\u6cd5\u53ef\u4ee5\u8ba9\u4f60\u83b7\u5f97\u4e00\u4e2a\u5b9e\u9645\u7684URL\u6216\u4ee3\u8868\u8d44\u6e90\u7684File\u5bf9\u8c61\uff08\u5982\u679c\u5e95\u5c42\u5b9e\u73b0\u517c\u5bb9\u5e76\u652f\u6301\u8be5\u529f\u80fd\uff09\u3002</p> <p>Spring itself uses the <code>Resource</code> abstraction extensively, as an argument type in many method signatures when a resource is needed. Other methods in some Spring APIs (such as the constructors to various <code>ApplicationContext</code> implementations) take a <code>String</code> which in unadorned or simple form is used to create a <code>Resource</code> appropriate to that context implementation or, via special prefixes on the <code>String</code> path, let the caller specify that a specific <code>Resource</code> implementation must be created and used.</p> <p>While the <code>Resource</code> interface is used a lot with Spring and by Spring, it is actually very useful to use as a general utility class by itself in your own code, for access to resources, even when your code does not know or care about any other parts of Spring. While this couples your code to Spring, it really only couples it to this small set of utility classes, which serve as a more capable replacement for <code>URL</code> and can be considered equivalent to any other library you would use for this purpose.</p> <p>The <code>Resource</code> abstraction does not replace functionality. It wraps it where possible. For example, a <code>UrlResource</code> wraps a URL and uses the wrapped <code>URL</code> to do its work.</p> <p>\u67d0\u4e9bresource\u7684\u5b9e\u73b0\u7c7b\u4e5f\u5b9e\u73b0\u4e86 <code>WritableResource</code> \u63a5\u53e3\uff0c\u53ef\u4ee5\u652f\u6301\u5199\u5165\u3002</p> <p>Spring\u672c\u8eab\u5e7f\u6cdb\u5730\u4f7f\u7528\u4e86Resource\u62bd\u8c61\uff0c\u5f53\u9700\u8981\u8d44\u6e90\u65f6\uff0c\u5b83\u53ef\u4ee5\u4f5c\u4e3a\u8bb8\u591a\u65b9\u6cd5\u7b7e\u540d\u4e2d\u7684\u53c2\u6570\u7c7b\u578b\u3002\u5728\u4e00\u4e9bSpring API\u4e2d\u7684\u5176\u4ed6\u65b9\u6cd5\uff08\u6bd4\u5982\u5404\u79cdApplicationContext\u5b9e\u73b0\u7684\u6784\u9020\u51fd\u6570\uff09\u4f1a\u53d6\u4e00\u4e2aString\uff0c\u8fd9\u4e2aString\u4ee5\u4e0d\u52a0\u4fee\u9970\u6216\u7b80\u5355\u7684\u5f62\u5f0f\u88ab\u7528\u6765\u521b\u5efa\u4e00\u4e2a\u9002\u5408\u8be5\u4e0a\u4e0b\u6587\u5b9e\u73b0\u7684Resource\uff0c\u6216\u8005\u901a\u8fc7String\u8def\u5f84\u4e0a\u7684\u7279\u6b8a\u524d\u7f00\uff0c\u8ba9\u8c03\u7528\u8005\u6307\u5b9a\u5fc5\u987b\u521b\u5efa\u548c\u4f7f\u7528\u4e00\u4e2a\u7279\u5b9a\u7684Resource\u5b9e\u73b0\u3002</p> <p>\u867d\u7136Resource\u63a5\u53e3\u5728Spring\u4e2d\u4f7f\u7528\u5f97\u5f88\u591a\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u5728\u4f60\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\uff0c\u5b83\u672c\u8eab\u4f5c\u4e3a\u4e00\u4e2a\u901a\u7528\u7684\u5b9e\u7528\u7c7b\u6765\u4f7f\u7528\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u7528\u4e8e\u8bbf\u95ee\u8d44\u6e90\uff0c\u5373\u4f7f\u4f60\u7684\u4ee3\u7801\u4e0d\u77e5\u9053\u6216\u4e0d\u5173\u5fc3Spring\u7684\u4efb\u4f55\u5176\u4ed6\u90e8\u5206\u3002\u867d\u7136\u8fd9\u5c06\u4f60\u7684\u4ee3\u7801\u4e0eSpring\u8026\u5408\uff0c\u4f46\u5b83\u5b9e\u9645\u4e0a\u53ea\u662f\u5c06\u5b83\u4e0e\u8fd9\u4e00\u5c0f\u5957\u5b9e\u7528\u7c7b\u8026\u5408\uff0c\u5b83\u4f5c\u4e3aURL\u7684\u4e00\u4e2a\u66f4\u6709\u80fd\u529b\u7684\u66ff\u4ee3\u54c1\uff0c\u53ef\u4ee5\u88ab\u8ba4\u4e3a\u7b49\u540c\u4e8e\u4f60\u4e3a\u6b64\u76ee\u7684\u800c\u4f7f\u7528\u7684\u4efb\u4f55\u5176\u4ed6\u5e93\u3002</p> <p><code>Resource</code> \u62bd\u8c61\u5e76\u4e0d\u53d6\u4ee3\u529f\u80fd\u3002\u5b83\u5c3d\u53ef\u80fd\u5730\u5305\u88c5\u4e86\u5b83\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a<code>UrlResource</code> \u5305\u88c5\u4e86\u4e00\u4e2aURL\uff0c\u5e76\u4f7f\u7528\u88ab\u5305\u88c5\u7684URL\u6765\u5b8c\u6210\u5b83\u7684\u5de5\u4f5c\u3002</p>"},{"location":"java/spring/spring/Resource/#23-resource","title":"2.3 \u5185\u7f6e\u7684Resource\u5b9e\u73b0","text":"<p>spring\u5305\u542b\u4ee5\u4e0bResource\u5b9e\u73b0\uff1a\u8fd9\u91cc\u5176\u5b9e\u4e5f\u662f\u7b56\u7565\u6a21\u5f0f\u7684\u4f53\u73b0\uff01ApplicationContext \u662f\u7b56\u7565\u6a21\u5f0f\u4e2d\u7684\u51b3\u7b56\u8005</p> <ul> <li><code>UrlResource</code></li> <li><code>ClassPathResource</code></li> <li><code>FileSystemResource</code></li> <li><code>ServletContextResource</code></li> <li><code>InputStreamResource</code></li> <li><code>ByteArrayResource</code></li> </ul>"},{"location":"java/spring/spring/Resource/#231-urlresource","title":"2.3.1 <code>UrlResource</code>","text":"<p><code>UrlResource</code> wraps a <code>java.net.URL</code> and can be used to access any object that is normally accessible with a URL, such as files, an HTTP target, an FTP target, and others. All URLs have a standardized <code>String</code> representation, such that appropriate standardized prefixes are used to indicate one URL type from another. This includes <code>file:</code> for accessing filesystem paths, <code>http:</code> for accessing resources through the HTTP protocol, <code>ftp:</code> for accessing resources through FTP, and others.</p> <p>UrlResource\u5305\u88c5\u4e86\u4e00\u4e2ajava.net.URL\uff0c\u53ef\u4ee5\u7528\u6765\u8bbf\u95ee\u4efb\u4f55\u901a\u5e38\u53ef\u4ee5\u7528URL\u8bbf\u95ee\u7684\u5bf9\u8c61\uff0c\u5982files, HTTP target, FTP target\u7b49\u3002\u6240\u6709\u7684URL\u90fd\u6709\u4e00\u4e2a\u6807\u51c6\u5316\u7684String\u8868\u793a\u6cd5\uff0c\u6bd4\u5982\u7528\u9002\u5f53\u7684\u6807\u51c6\u5316\u524d\u7f00\u6765\u8868\u793a\u4e00\u79cdURL\u7c7b\u578b\uff0c\u5305\u62ec<code>file\uff1a</code>\u7528\u4e8e\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u8def\u5f84\uff0c<code>http\uff1a</code>\u7528\u4e8e\u901a\u8fc7HTTP\u534f\u8bae\u8bbf\u95ee\u8d44\u6e90\uff0c<code>ftp\uff1a</code>\u7528\u4e8e\u901a\u8fc7FTP\u8bbf\u95ee\u8d44\u6e90\u7b49\u3002</p> <p>A <code>UrlResource</code> is created by Java code by explicitly using the <code>UrlResource</code> constructor but is often created implicitly when you call an API method that takes a <code>String</code> argument meant to represent a path. For the latter case, a JavaBeans <code>PropertyEditor</code> ultimately decides which type of <code>Resource</code> to create. If the path string contains well-known (to it, that is) prefix (such as <code>classpath:</code>), it creates an appropriate specialized <code>Resource</code> for that prefix. However, if it does not recognize the prefix, it assume the string is a standard URL string and creates a <code>UrlResource</code>.</p> <p>UrlResource\u662f\u901a\u8fc7Java\u4ee3\u7801\u663e\u5f0f\u4f7f\u7528UrlResource\u6784\u9020\u51fd\u6570\u521b\u5efa\u7684\uff0c\u4f46\u901a\u5e38\u5728\u8c03\u7528API\u65b9\u6cd5\u65f6\u9690\u5f0f\u521b\u5efa\uff0c\u8be5\u65b9\u6cd5\u4f7f\u7528\u4e00\u4e2a\u4ee3\u8868\u8def\u5f84\u7684String\u53c2\u6570\u3002\u5bf9\u4e8e\u540e\u4e00\u79cd\u60c5\u51b5\uff0cJavaBeans <code>PropertyEditor</code>\u6700\u7ec8\u51b3\u5b9a\u521b\u5efa\u54ea\u79cd\u7c7b\u578b\u7684Resource\u3002\u5982\u679c\u8def\u5f84\u5b57\u7b26\u4e32\u5305\u542b\u4f17\u6240\u5468\u77e5\u7684\uff08\u5bf9\u5b83\u6765\u8bf4\uff0c\u5c31\u662f\uff09\u524d\u7f00\uff08\u5982<code>classpath:</code>\uff09\uff0c\u5b83\u5c31\u4f1a\u4e3a\u8be5\u524d\u7f00\u521b\u5efa\u4e00\u4e2a\u9002\u5f53\u7684\u4e13\u7528\u8d44\u6e90\u3002\u4f46\u662f\uff0c\u5982\u679c\u5b83\u4e0d\u8bc6\u522b\u524d\u7f00\uff0c\u5b83\u5c31\u4f1a\u8ba4\u4e3a\u8be5\u5b57\u7b26\u4e32\u662f\u6807\u51c6\u7684URL\u5b57\u7b26\u4e32\uff0c\u5e76\u521b\u5efa\u4e00\u4e2aUrlResource\u3002</p>"},{"location":"java/spring/spring/Resource/#232-classpathresource","title":"2.3.2 <code>ClassPathResource</code>","text":"<p>This class represents a resource that should be obtained from the classpath. It uses either the thread context class loader, a given class loader, or a given class for loading resources.</p> <p>This <code>Resource</code> implementation supports resolution as <code>java.io.File</code> if the class path resource resides in the file system but not for classpath resources that reside in a jar and have not been expanded (by the servlet engine or whatever the environment is) to the filesystem. To address this, the various <code>Resource</code> implementations always support resolution as a <code>java.net.URL</code>.</p> <p>A <code>ClassPathResource</code> is created by Java code by explicitly using the <code>ClassPathResource</code> constructor but is often created implicitly when you call an API method that takes a <code>String</code> argument meant to represent a path. For the latter case, a JavaBeans <code>PropertyEditor</code> recognizes the special prefix, <code>classpath:</code>, on the string path and creates a <code>ClassPathResource</code> in that case.</p> <p>\u8fd9\u4e2a\u7c7b\u4ee3\u8868\u4e86\u4e00\u4e2a\u5e94\u8be5\u4ececlasspath\u4e2d\u83b7\u53d6\u7684\u8d44\u6e90\u3002\u5b83\u4f7f\u7528\u7ebf\u7a0b\u4e0a\u4e0b\u6587\u7c7b\u52a0\u8f7d\u5668\uff0c\u4e00\u4e2a\u7ed9\u5b9a\u7c7b\u52a0\u8f7d\u5668\u6216\u7ed9\u5b9a\u7c7b\u6765\u52a0\u8f7d\u8d44\u6e90\u3002</p> <p>\u5982\u679c\u8fd9\u4e2aclass path resource\u9a7b\u7559\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u8be5Resource\u5b9e\u73b0\u652f\u6301\u89e3\u6790\u4e3ajava.io.File\uff0c\u4f46\u5bf9\u4e8e\u9a7b\u7559\u5728jar\u4e2d\u4e14\u6ca1\u6709\uff08\u88abservlet\u5f15\u64ce\u6216\u4efb\u4f55\u73af\u5883\uff09\u6269\u5c55\u5230\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684classpath\u8d44\u6e90\u5219\u4e0d\u652f\u6301\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5404\u79cd\u8d44\u6e90\u5b9e\u73b0\u603b\u662f\u652f\u6301\u89e3\u6790\u4e3a<code>java.net.URL</code>\u3002</p> <p>\u4e00\u4e2a<code>ClassPathResource</code>\u662f\u901a\u8fc7Java\u4ee3\u7801\u663e\u5f0f\u4f7f\u7528<code>ClassPathResource</code>\u6784\u9020\u51fd\u6570\u6765\u521b\u5efa\u7684\uff0c\u4f46\u662f\u5f53\u4f60\u8c03\u7528\u4e00\u4e2aAPI\u65b9\u6cd5\u65f6\uff0c\u901a\u5e38\u662f\u9690\u5f0f\u521b\u5efa\u7684\uff0c\u8be5\u65b9\u6cd5\u4f7f\u7528\u4e00\u4e2aString\u53c2\u6570\u6765\u8868\u793a\u4e00\u4e2a\u8def\u5f84\u3002\u5bf9\u4e8e\u540e\u4e00\u79cd\u60c5\u51b5\uff0cJavaBeans PropertyEditor\u4f1a\u8bc6\u522b\u5b57\u7b26\u4e32\u8def\u5f84\u4e0a\u7684\u7279\u6b8a\u524d\u7f00<code>classpath:</code>\uff0c\u5e76\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u521b\u5efa\u4e00\u4e2a<code>ClassPathResource</code>\u3002</p> <p>\u76f8\u5bf9\u4e8e\u5176\u4ed6\u7684 Resource \u5b9e\u73b0\u7c7b\uff0c\u5176\u4e3b\u8981\u4f18\u52bf\u662f\u65b9\u4fbf\u8bbf\u95ee\u7c7b\u52a0\u8f7d\u8def\u5f84\u91cc\u7684\u8d44\u6e90\uff0c\u5c24\u5176\u5bf9\u4e8e Web \u5e94\u7528\uff0cClassPathResource \u53ef\u81ea\u52a8\u641c\u7d22\u4f4d\u4e8e WEB-INF/classes \u4e0b\u7684\u8d44\u6e90\u6587\u4ef6\uff0c\u65e0\u987b\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u8bbf\u95ee\u3002</p>"},{"location":"java/spring/spring/Resource/#233-filesystemresource","title":"2.3.3 <code>FileSystemResource</code>","text":"<p>\u8fd9\u4e2aResource\u5b9e\u73b0\u7528\u6765\u5904\u7406<code>java.io.File</code> \u548c<code>java.nio.file.Path</code> \uff0c\u652f\u6301\u4ee5File\u548cURL\u7684\u5f62\u5f0f\u89e3\u6790\u3002</p>"},{"location":"java/spring/spring/Resource/#234-servletcontextresource","title":"2.3.4 <code>ServletContextResource</code>","text":"<p>This is a <code>Resource</code> implementation for <code>ServletContext</code> resources that interprets relative paths within the relevant web application\u2019s root directory.</p> <p>It always supports stream access and URL access but allows <code>java.io.File</code> access only when the web application archive is expanded and the resource is physically on the filesystem. Whether or not it is expanded and on the filesystem or accessed directly from the JAR or somewhere else like a database (which is conceivable) is actually dependent on the Servlet container.</p> <p>\u8fd9\u662f\u4e00\u4e2aServletContext\u8d44\u6e90\u7684<code>Resource</code> \u5b9e\u73b0\uff0c\u5b83\u53ef\u4ee5\u89e3\u91caWeb\u5e94\u7528\u7a0b\u5e8f\u6839\u76ee\u5f55\u5185\u7684\u76f8\u5bf9\u8def\u5f84\u3002</p> <p>\u5b83\u59cb\u7ec8\u652f\u6301\u6d41\u8bbf\u95ee\u548c URL \u8bbf\u95ee\uff0c\u4f46\u53ea\u6709\u5f53 Web \u5e94\u7528\u7a0b\u5e8f\u5b58\u6863\u88ab\u5c55\u5f00\u4e14\u8d44\u6e90\u5b9e\u9645\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u65f6\uff0c\u624d\u5141\u8bb8 java.io.File \u8bbf\u95ee\u3002\u662f\u5426\u5c55\u5f00\uff0c\u5728\u6587\u4ef6\u7cfb\u7edf\u4e0a\u8fd8\u662f\u76f4\u63a5\u4eceJAR\u6216\u5176\u4ed6\u5730\u65b9\uff08\u5982\u6570\u636e\u5e93\uff09\u8bbf\u95ee\uff08\u8fd9\u662f\u53ef\u4ee5\u60f3\u8c61\u7684\uff09\uff0c\u5b9e\u9645\u4e0a\u53d6\u51b3\u4e8eServlet\u5bb9\u5668\u3002</p>"},{"location":"java/spring/spring/Resource/#235-inputstreamresource","title":"2.3.5 <code>InputStreamResource</code>","text":"<p>An <code>InputStreamResource</code> is a <code>Resource</code> implementation for a given <code>InputStream</code>. It should be used only if no specific <code>Resource</code> implementation is applicable. In particular, prefer <code>ByteArrayResource</code> or any of the file-based <code>Resource</code> implementations where possible.</p> <p>In contrast to other <code>Resource</code> implementations, this is a descriptor for an already-opened resource. Therefore, it returns <code>true</code> from <code>isOpen()</code>. Do not use it if you need to keep the resource descriptor somewhere or if you need to read a stream multiple times.</p> <p>InputStreamResource\u662f\u7ed9\u5b9a\u8f93\u5165\u6d41\u7684\u8d44\u6e90\u5b9e\u73b0\u3002\u53ea\u6709\u5728\u6ca1\u6709\u7279\u5b9a\u7684Resource\u5b9e\u73b0\u9002\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u624d\u5e94\u8be5\u4f7f\u7528\u5b83\u3002\u7279\u522b\u662f\uff0c\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u4f18\u5148\u9009\u62e9ByteArrayResource\u6216\u4efb\u4f55\u57fa\u4e8e\u6587\u4ef6\u7684Resource\u5b9e\u73b0\u3002</p> <p>\u4e0e\u5176\u4ed6\u8d44\u6e90\u5b9e\u73b0\u4e0d\u540c\uff0c\u8fd9\u662f\u4e00\u4e2a\u5df2\u7ecf\u6253\u5f00\u7684\u8d44\u6e90\u7684\u63cf\u8ff0\u7b26\u3002\u56e0\u6b64\uff0c\u5b83\u4eceisOpen()\u8fd4\u56detrue\u3002\u5982\u679c\u60a8\u9700\u8981\u5c06\u8d44\u6e90\u63cf\u8ff0\u7b26\u4fdd\u5b58\u5728\u67d0\u4e2a\u5730\u65b9\uff0c\u6216\u8005\u60a8\u9700\u8981\u591a\u6b21\u8bfb\u53d6\u4e00\u4e2a\u6d41\uff0c\u8bf7\u4e0d\u8981\u4f7f\u7528\u5b83\u3002</p>"},{"location":"java/spring/spring/Resource/#236-bytearrayresource","title":"2.3.6 <code>ByteArrayResource</code>","text":"<p>This is a <code>Resource</code> implementation for a given byte array. It creates a <code>ByteArrayInputStream</code> for the given byte array.</p> <p>It is useful for loading content from any given byte array without having to resort to a single-use <code>InputStreamResource</code>.</p> <p>\u8fd9\u662f\u4e00\u4e2a\u9488\u5bf9\u7ed9\u5b9a\u5b57\u8282\u6570\u7ec4\u7684\u8d44\u6e90\u5b9e\u73b0\u3002\u5b83\u4e3a\u7ed9\u5b9a\u7684\u5b57\u8282\u6570\u7ec4\u521b\u5efa\u4e00\u4e2aByteArrayInputStream\u3002</p> <p>\u5b83\u5bf9\u4e8e\u4ece\u4efb\u4f55\u7ed9\u5b9a\u7684\u5b57\u8282\u6570\u7ec4\u4e2d\u52a0\u8f7d\u5185\u5bb9\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u800c\u4e0d\u9700\u8981\u6c42\u52a9\u4e8e\u4e00\u4e2a\u5355\u4e00\u4f7f\u7528\u7684InputStreamResource\u3002</p> <pre><code>@Service\npublic class ResourceHandler {\n    @Autowired\n    private ApplicationContext applicationContext;\n\n    @Value(\"classpath:/application.properties\")\n    private Resource diResource;\n\n    @PostConstruct\n    public void testGetResource(){\n        // ApplicationContext\u5b9e\u73b0\u4e86ResourceLoader\u63a5\u53e3,\u6240\u4ee5\u4e0b\u9762\u53ef\u4ee5getResource()\n\n        // \u53ef\u4ee5\u76f4\u63a5\u6ce8\u5165Resource\n        System.out.println(diResource.getDescription());\n\n        // \u4ece\u672c\u5730File System\u83b7\u53d6\n        Resource resource = applicationContext.getResource(\"file:///E:/code/github/doc-for-spring/pages/spring/Overview.md\");\n\n        // \u4ececlasspath\u83b7\u53d6\n         Resource classpathResource = applicationContext.getResource(\"classpath:/application.properties\");\n\n        // \u4ece\u7f51\u7edc\u83b7\u53d6http\n        Resource httpResource = applicationContext.getResource(\"https://docs.spring.io/spring-framework/docs/current/reference/html/images/container-magic.png\");\n        try {\n            System.out.println(resource.contentLength());\n        } catch (IOException e) {\n\n        }\n    }\n\n}\n</code></pre>"},{"location":"java/spring/spring/Resource/#24-resourceloader","title":"2.4 <code>ResourceLoader</code>","text":"<p>ResourceLoader\u63a5\u53e3\u65e8\u5728\u8fd4\u56de\uff08\u5373\u52a0\u8f7d\uff09\u8d44\u6e90\u5b9e\u4f8b\u7684\u5bf9\u8c61\u3002\u4e0b\u9762\u7684\u5217\u8868\u663e\u793a\u4e86ResourceLoader\u63a5\u53e3\u5b9a\u4e49:</p> <pre><code>public interface ResourceLoader {\n\n    Resource getResource(String location);\n}\n</code></pre> <p>\u6240\u6709\u7684application contexts\u90fd\u5b9e\u73b0\u4e86ResourceLoader\u63a5\u53e3\uff0c\u56e0\u6b64\u6240\u6709\u7684application contexts\u90fd\u53ef\u4ee5\u7528\u6765\u83b7\u53d6Resource\u5b9e\u4f8b\u3002</p> <p>When you call <code>getResource()</code> on a specific application context, and the location path specified doesn\u2019t have a specific prefix, you get back a <code>Resource</code> type that is appropriate to that particular application context. For example, assume the following snippet of code was run against a <code>ClassPathXmlApplicationContext</code> instance:</p> <p>\u5f53\u60a8\u5728\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u4e0a\u8c03\u7528getResource()\uff0c\u5e76\u4e14\u6307\u5b9a\u7684\u4f4d\u7f6e\u8def\u5f84\u6ca1\u6709\u7279\u5b9a\u7684\u524d\u7f00\u65f6\uff0c\u60a8\u4f1a\u5f97\u5230\u4e00\u4e2a\u9002\u5408\u8be5\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u7684\u8d44\u6e90\u7c7b\u578b\u3002\u4f8b\u5982\uff0c\u5047\u8bbe\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\u662f\u9488\u5bf9ClassPathXmlApplicationContext\u5b9e\u4f8b\u8fd0\u884c\u7684:</p> <pre><code>Resource template = ctx.getResource(\"some/resource/path/myTemplate.txt\");\n</code></pre> <p>\u9488\u5bf9\u4e00\u4e2a<code>ClassPathXmlApplicationContext</code>\uff0c\u8be5\u4ee3\u7801\u8fd4\u56de\u4e00\u4e2a<code>ClassPathResource</code>.\u5982\u679c\u9488\u5bf9\u4e00\u4e2a<code>FileSystemXmlApplicationContext</code>\u5b9e\u4f8b\u8fd0\u884c\u540c\u6837\u7684\u65b9\u6cd5\uff0c\u5b83\u5c06\u8fd4\u56de\u4e00\u4e2a<code>FileSystemResource</code>\u3002\u5bf9\u4e8e<code>WebApplicationContext</code>\uff0c\u5b83\u5c06\u8fd4\u56de\u4e00\u4e2a<code>ServletContextResource</code>\u3002\u5b83\u540c\u6837\u4f1a\u4e3a\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u8fd4\u56de\u9002\u5f53\u7684\u5bf9\u8c61\u3002</p> <p>\u56e0\u6b64\uff0c\u4f60\u53ef\u4ee5\u4ee5\u9002\u5408\u7279\u5b9a\u5e94\u7528\u4e0a\u4e0b\u6587\u7684\u65b9\u5f0f\u6765\u52a0\u8f7d\u8d44\u6e90\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u7279\u6b8a\u7684classpath:\u524d\u7f00\u6765\u5f3a\u5236\u4f7f\u7528ClassPathResource\uff0c\u4e0d\u7ba1\u5e94\u7528\u4e0a\u4e0b\u6587\u7c7b\u578b\u5982\u4f55\uff0c\u5982\u4e0b\u4f8b\u6240\u793a:</p> <pre><code>Resource template = ctx.getResource(\"file:///some/resource/path/myTemplate.txt\");\n</code></pre> <p>\u540c\u6837\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u4efb\u4f55\u6807\u51c6\u7684java.net.URL\u524d\u7f00\u6765\u5f3a\u5236\u4f7f\u7528UrlResource\u3002\u4e0b\u9762\u4e00\u5bf9\u4f8b\u5b50\u4f7f\u7528\u4e86\u6587\u4ef6\u548chttp\u524d\u7f00:</p> <pre><code>Resource template = ctx.getResource(\"file:///some/resource/path/myTemplate.txt\");\n</code></pre> <pre><code>Resource template = ctx.getResource(\"https://myhost.com/resource/path/myTemplate.txt\");\n</code></pre> <p>\u4e0b\u8868\u603b\u7ed3\u4e86\u5c06String\u5bf9\u8c61\u8f6c\u6362\u4e3aResource\u5bf9\u8c61\u7684\u7b56\u7565:</p> Prefix Example Explanation classpath: <code>classpath:com/myapp/config.xml</code> \u4ece classpath\u52a0\u8f7d file: <code>file:///data/config.xml</code> \u4ece\u6587\u4ef6\u7cfb\u7edf\u52a0\u8f7dLoaded as a <code>URL</code>. See also <code>FileSystemResource</code> Caveats. http: <code>https://myserver/logo.png</code> Loaded as a <code>URL</code>. (none) <code>/data/config.xml</code> \u4f9d\u8d56\u4e8e\u5e95\u5c42\u7684 <code>ApplicationContext</code>."},{"location":"java/spring/spring/Resource/#25resourcepatternresolver","title":"2.5<code>ResourcePatternResolver</code>\u63a5\u53e3","text":"<p><code>ResourcePatternResolver</code>\u63a5\u53e3\u662fResourceLoader\u63a5\u53e3\u7684\u6269\u5c55\uff0c\u5b9a\u4e49\u7b56\u7565\uff0c\u7528\u6765\u89e3\u6790location pattern\u4e3aResource\u5bf9\u8c61\u3002</p> <pre><code>public interface ResourcePatternResolver extends ResourceLoader {\n\n    String CLASSPATH_ALL_URL_PREFIX = \"classpath*:\";\n\n    Resource[] getResources(String locationPattern) throws IOException;\n}\n</code></pre> <p>\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\uff0c\u8fd9\u4e2a\u63a5\u53e3\u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7279\u6b8a\u7684<code>classpath*\uff1a</code>\u8d44\u6e90\u524d\u7f00\uff0c\u7528\u4e8e\u6240\u6709\u6765\u81ea\u7c7b\u8def\u5f84\u7684\u5339\u914d\u8d44\u6e90\u3002\u6ce8\u610f\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8d44\u6e90\u4f4d\u7f6e\u5e94\u8be5\u662f\u4e00\u4e2a\u6ca1\u6709\u5360\u4f4d\u7b26\u7684\u8def\u5f84--\u4f8b\u5982<code>classpath*:/config/beans.xml</code>\u3002JAR\u6587\u4ef6\u6216\u7c7b\u8def\u5f84\u4e2d\u7684\u4e0d\u540c\u76ee\u5f55\u53ef\u4ee5\u5305\u542b\u5177\u6709\u76f8\u540c\u8def\u5f84\u548c\u76f8\u540c\u540d\u79f0\u7684\u591a\u4e2a\u6587\u4ef6\u3002\u5173\u4e8eclasspath*:\u8d44\u6e90\u524d\u7f00\u7684\u901a\u914d\u7b26\u652f\u6301\u7684\u8fdb\u4e00\u6b65\u8be6\u60c5\uff0c\u8bf7\u53c2\u89c1\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u6784\u9020\u5668\u8d44\u6e90\u8def\u5f84\u4e2d\u7684\u901a\u914d\u7b26\u53ca\u5176\u5206\u8282\u3002</p> <p>\u53ef\u4ee5\u68c0\u67e5\u4f20\u5165\u7684 ResourceLoader\uff08\u4f8b\u5982\uff0c\u901a\u8fc7 ResourceLoaderAware \u8bed\u4e49\u63d0\u4f9b\u7684\uff09\u662f\u5426\u4e5f\u5b9e\u73b0\u4e86\u8fd9\u4e2a\u6269\u5c55\u63a5\u53e3\u3002</p> <p>PathMatchingResourcePatternResolver\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u5b9e\u73b0\uff0c\u53ef\u5728ApplicationContext\u4e4b\u5916\u4f7f\u7528\uff0c\u4e5f\u53ef\u7531ResourceArrayPropertyEditor\u7528\u4e8e\u586b\u5145Resource[]bean\u5c5e\u6027\u3002PathMatchingResourcePatternResolver\u80fd\u591f\u5c06\u4e00\u4e2a\u6307\u5b9a\u7684\u8d44\u6e90\u4f4d\u7f6e\u8def\u5f84\u89e3\u6790\u4e3a\u4e00\u4e2a\u6216\u591a\u4e2a\u5339\u914d\u7684\u8d44\u6e90\u5bf9\u8c61\u3002\u6e90\u8def\u5f84\u53ef\u4ee5\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8def\u5f84\uff0c\u5b83\u4e0e\u76ee\u6807\u8d44\u6e90\u6709\u4e00\u5bf9\u4e00\u7684\u6620\u5c04\uff0c\u6216\u8005\u53ef\u4ee5\u5305\u542b\u7279\u6b8a\u7684classpath*: \u524d\u7f00\u548c/\u6216\u5185\u90e8Ant\u98ce\u683c\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff08\u4f7f\u7528Spring\u7684org.springframework.util.AntPathMatcher\u5de5\u5177\u5339\u914d\uff09\u3002\u540e\u8005\u90fd\u662f\u6709\u6548\u7684\u901a\u914d\u7b26\u3002</p> <p>\u4efb\u4f55\u6807\u51c6ApplicationContext\u4e2d\u7684<code>ResourceLoader</code>\u5b9e\u9645\u4e0a\u662fPathMatchingResourcePatternResolver\u7684\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u5b83\u5b9e\u73b0\u4e86ResourcePatternResolver\u63a5\u53e3\u3002ApplicationContext\u5b9e\u4f8b\u672c\u8eab\u4e5f\u662f\u5982\u6b64\uff0c\u5b83\u4e5f\u5b9e\u73b0\u4e86ResourcePatternResolver\u63a5\u53e3\u5e76\u59d4\u6258\u7ed9\u9ed8\u8ba4\u7684PathMatchingResourcePatternResolver\u3002</p>"},{"location":"java/spring/spring/Resource/#26-resourceloaderaware","title":"2.6 <code>ResourceLoaderAware</code> \u63a5\u53e3","text":"<p>ResourceLoaderAware\u63a5\u53e3\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u56de\u8c03\u63a5\u53e3\uff0c\u5b83\u6807\u8bc6\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u671f\u671b\u83b7\u5f97ResourceLoader\u5f15\u7528\u3002</p> <pre><code>public interface ResourceLoaderAware {\n\n    void setResourceLoader(ResourceLoader resourceLoader);\n}\n</code></pre> <p>\u5f53\u4e00\u4e2a\u7c7b\u5b9e\u73b0\u4e86ResourceLoaderAware\u5e76\u88ab\u90e8\u7f72\u5230\u5e94\u7528\u4e0a\u4e0b\u6587\u4e2d\uff08\u4f5c\u4e3aSpring\u7ba1\u7406\u7684Bean\uff09\uff0c\u5b83\u5c06\u88ab\u5e94\u7528\u4e0a\u4e0b\u6587\u8bc6\u522b\u4e3aResourceLoaderAware\u3002\u7136\u540eapplication context\u8c03\u7528setResourceLoader(ResourceLoader)\uff0c\u63d0\u4f9b\u81ea\u5df1\u4f5c\u4e3a\u53c2\u6570\uff08\u8bb0\u4f4f\uff0cSpring\u4e2d\u7684\u6240\u6709\u5e94\u7528\u4e0a\u4e0b\u6587\u90fd\u5b9e\u73b0\u4e86ResourceLoader\u63a5\u53e3\uff09\u3002</p> <p>Since an <code>ApplicationContext</code> is a <code>ResourceLoader</code>, the bean could also implement the <code>ApplicationContextAware</code> interface and use the supplied application context directly to load resources. However, in general, it is better to use the specialized <code>ResourceLoader</code> interface if that is all you need. The code would be coupled only to the resource loading interface (which can be considered a utility interface) and not to the whole Spring <code>ApplicationContext</code> interface.</p> <p>\u7531\u4e8eApplicationContext\u662f\u4e00\u4e2a<code>ResourceLoader</code>\uff0c\u6240\u4ee5\u4f60\u81ea\u5b9a\u4e49\u7684Bean\u4e5f\u53ef\u4ee5\u5b9e\u73b0ApplicationContextAware\u63a5\u53e3\uff0c\u76f4\u63a5\u4f7f\u7528\u63d0\u4f9b\u7684\u5e94\u7528\u4e0a\u4e0b\u6587\u6765\u52a0\u8f7d\u8d44\u6e90\u3002\u4f46\u662f\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u53ea\u9700\u8981\u8fd9\u4e2a\u63a5\u53e3\uff0c\u6700\u597d\u4f7f\u7528\u4e13\u95e8\u7684ResourceLoader\u63a5\u53e3\u3002\u4ee3\u7801\u5c06\u53ea\u8026\u5408\u5230\u8d44\u6e90\u52a0\u8f7d\u63a5\u53e3\uff08\u53ef\u4ee5\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5b9e\u7528\u63a5\u53e3\uff09\uff0c\u800c\u4e0d\u662f\u6574\u4e2aSpring ApplicationContext\u63a5\u53e3\u3002</p> <p>In application components, you may also rely upon autowiring of the <code>ResourceLoader</code> as an alternative to implementing the <code>ResourceLoaderAware</code> interface. The \u201ctraditional\u201d <code>constructor</code> and <code>byType</code> autowiring modes (as described in Autowiring Collaborators) are capable of providing a <code>ResourceLoader</code> for either a constructor argument or a setter method parameter, respectively. For more flexibility (including the ability to autowire fields and multiple parameter methods), consider using the annotation-based autowiring features. In that case, the <code>ResourceLoader</code> is autowired into a field, constructor argument, or method parameter that expects the <code>ResourceLoader</code> type as long as the field, constructor, or method in question carries the <code>@Autowired</code> annotation. For more information, see Using <code>@Autowired</code>.</p> <p>\u5728\u5e94\u7528\u7a0b\u5e8f\u7ec4\u4ef6\u4e2d\uff0c\u60a8\u4e5f\u53ef\u4ee5\u4f9d\u8d56 ResourceLoader \u7684\u81ea\u52a8\u6ce8\u5165\u6765\u66ff\u4ee3\u5b9e\u73b0 ResourceLoaderAware \u63a5\u53e3\u3002\u4f20\u7edf\u7684 \"\u6784\u9020\u51fd\u6570\u548cbyType\u81ea\u52a8\u914d\u7ebf\u6a21\u5f0f\uff08\u5982Autowiring Collaborators\u4e2d\u6240\u8ff0\uff09\u80fd\u591f\u5206\u522b\u4e3a\u6784\u9020\u51fd\u6570\u53c2\u6570\u6216setter\u65b9\u6cd5\u53c2\u6570\u63d0\u4f9bResourceLoader\u3002\u4e3a\u4e86\u83b7\u5f97\u66f4\u591a\u7684\u7075\u6d3b\u6027\uff08\u5305\u62ec\u81ea\u52a8\u88c5\u914d\u5b57\u6bb5\u548c\u591a\u4e2a\u53c2\u6570\u65b9\u6cd5\u7684\u80fd\u529b\uff09\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u57fa\u4e8e\u6ce8\u89e3\u7684\u81ea\u52a8\u88c5\u914d\u529f\u80fd\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ea\u8981\u76f8\u5173\u7684\u5b57\u6bb5\u3001\u6784\u9020\u51fd\u6570\u6216\u65b9\u6cd5\u643a\u5e26<code>@Autowired</code>\u6ce8\u89e3\uff0c\u8d44<code>ResourceLoader</code>\u5c31\u4f1a\u81ea\u52a8\u88c5\u914d\u5230\u671f\u671b<code>ResourceLoader</code>\u7c7b\u578b\u7684\u5b57\u6bb5\u3001\u6784\u9020\u51fd\u6570\u53c2\u6570\u6216\u65b9\u6cd5\u53c2\u6570\u4e2d\u3002\u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1 Using <code>@Autowired</code>\u3002</p>"},{"location":"java/spring/spring/Resource/#27-resources","title":"2.7 Resources \u4f5c\u4e3a\u4f9d\u8d56\u6ce8\u5165","text":"<p>If the bean itself is going to determine and supply the resource path through some sort of dynamic process, it probably makes sense for the bean to use the ResourceLoader interface to load resources. For example, consider the loading of a template of some sort, where the specific resource that is needed depends on the role of the user. If the resources are static, it makes sense to eliminate the use of the ResourceLoader interface completely, have the bean expose the Resource properties it needs, and expect them to be injected into it.</p> <p>\u5982\u679cbean\u672c\u8eab\u8981\u901a\u8fc7\u67d0\u79cd\u52a8\u6001\u8fc7\u7a0b\u6765\u786e\u5b9a\u548c\u63d0\u4f9b\u8d44\u6e90\u8def\u5f84\uff0c\u90a3\u4e48bean\u4f7f\u7528ResourceLoader\u63a5\u53e3\u6765\u52a0\u8f7d\u8d44\u6e90\u53ef\u80fd\u662f\u6709\u610f\u4e49\u7684\u3002\u4f8b\u5982\uff0c\u8003\u8651\u52a0\u8f7d\u67d0\u79cd\u6a21\u677f\uff0c\u5176\u4e2d\u9700\u8981\u7684\u5177\u4f53\u8d44\u6e90\u53d6\u51b3\u4e8e\u7528\u6237\u7684\u89d2\u8272\u3002\u5982\u679c\u8d44\u6e90\u662f\u9759\u6001\u7684\uff0c\u90a3\u4e48\u5b8c\u5168\u53d6\u6d88\u4f7f\u7528ResourceLoader\u63a5\u53e3\u662f\u6709\u610f\u4e49\u7684\uff0c\u8ba9Bean\u66b4\u9732\u5b83\u9700\u8981\u7684Resource\u5c5e\u6027\uff0c\u5e76\u671f\u671b\u5b83\u4eec\u88ab\u6ce8\u5165\u8fdb\u6765\u3002</p> <p>What makes it trivial to then inject these properties is that all application contexts register and use a special JavaBeans <code>PropertyEditor</code>, which can convert <code>String</code> paths to <code>Resource</code> objects. So, if <code>myBean</code> has a template property of type <code>Resource</code>, it can be configured with a simple string for that resource, as the following example shows:</p> <p>\u7136\u540e\u6ce8\u5165\u8fd9\u4e9b\u5c5e\u6027\uff0c\u6240\u6709\u7684\u5e94\u7528\u90fd\u6ce8\u518c\u5e76\u4f7f\u7528\u4e00\u4e2a\u7279\u6b8a\u7684JavaBeans <code>PropertyEditor</code>\uff0c\u5b83\u53ef\u4ee5\u5c06String\u8def\u5f84\u8f6c\u6362\u4e3a<code>Resource</code>\u5bf9\u8c61\u3002\u56e0\u6b64\uff0c\u5982\u679c<code>ResourceHandler</code>\u6709\u4e00\u4e2a\u7c7b\u578b\u4e3a<code>Resource</code>\u7684diResource\u5c5e\u6027\uff0c\u5c31\u53ef\u4ee5\u4e3a\u8be5\u8d44\u6e90\u914d\u7f6e\u4e00\u4e2a\u7b80\u5355\u7684\u5b57\u7b26\u4e32\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>@Service\npublic class ResourceHandler {\n\n    @Value(\"/application.properties\")\n    private Resource diResource;\n}\n</code></pre> <p>\u8bf7\u6ce8\u610f\uff0c\u8d44\u6e90\u8def\u5f84\u6ca1\u6709\u524d\u7f00\u3002\u56e0\u6b64\uff0c\u7531\u4e8e\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u672c\u8eab\u5c06\u88ab\u7528\u4f5cResourceLoader\uff0c\u8d44\u6e90\u672c\u8eab\u662f\u901a\u8fc7ClassPathResource\u3001FileSystemResource\u6216ServletContextResource\u52a0\u8f7d\u7684\uff0c\u8fd9\u53d6\u51b3\u4e8e\u4e0a\u4e0b\u6587\u7684\u786e\u5207\u7c7b\u578b\u3002</p> <p>\u5982\u679c\u60a8\u9700\u8981\u5f3a\u5236\u4f7f\u7528\u7279\u5b9a\u7684Resource\u7c7b\u578b\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u524d\u7f00\u3002\u4e0b\u9762\u7684\u4e24\u4e2a\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u5f3a\u5236\u4f7f\u7528ClassPathResource\u548cUrlResource\uff08\u540e\u8005\u7528\u4e8e\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u6587\u4ef6\uff09:</p> <pre><code>@Service\npublic class ResourceHandler {\n\n    @Value(\"classpath:/application.properties\")\n    private Resource diResource;\n\n    @Value(\"file:///some/resource/path/myTemplate.txt\")\n    private Resource fileResource;\n}\n</code></pre>"},{"location":"java/spring/spring/Resource/#28-application-contexts-and-resource-paths","title":"2.8 Application Contexts and Resource Paths","text":"<p>\u672c\u8282\u4ecb\u7ecd\u4e86\u5982\u4f55\u4f7f\u7528\u8d44\u6e90\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\uff0c\u5305\u62ec\u4e0eXML\u914d\u5408\u7684\u5feb\u6377\u952e\u3001\u5982\u4f55\u4f7f\u7528\u901a\u914d\u7b26\u7b49\u7ec6\u8282\u3002</p>"},{"location":"java/spring/spring/Resource/#281-application-contexts","title":"2.8.1 \u6784\u9020Application Contexts","text":"<p>\u5e94\u7528\u4e0a\u4e0b\u6587\u6784\u9020\u51fd\u6570\uff08\u9488\u5bf9\u7279\u5b9a\u7684\u5e94\u7528\u4e0a\u4e0b\u6587\u7c7b\u578b\uff09\u4e00\u822c\u91c7\u7528\u4e00\u4e2a\u5b57\u7b26\u4e32\u6216\u5b57\u7b26\u4e32\u6570\u7ec4\u4f5c\u4e3a\u8d44\u6e90\u7684\u4f4d\u7f6e\u8def\u5f84\uff0c\u4f8b\u5982\u6784\u6210\u4e0a\u4e0b\u6587\u5b9a\u4e49\u7684XML\u6587\u4ef6\u3002</p> <p>\u5f53\u8fd9\u6837\u7684\u4f4d\u7f6e\u8def\u5f84\u6ca1\u6709\u524d\u7f00\u65f6\uff0c\u4ece\u8be5\u8def\u5f84\u6784\u5efa\u5e76\u7528\u4e8e\u52a0\u8f7dbean\u5b9a\u4e49\u7684\u7279\u5b9a\u8d44\u6e90\u7c7b\u578b\u53d6\u51b3\u4e8e\u5e76\u9002\u5408\u7279\u5b9a\u7684\u5e94\u7528\u4e0a\u4e0b\u6587\u3002\u4f8b\u5982\uff0c\u8003\u8651\u4e0b\u9762\u7684\u4f8b\u5b50\uff0c\u5b83\u521b\u5efa\u4e86\u4e00\u4e2aClassPathXmlApplicationContext\u3002</p> <pre><code>ApplicationContext ctx = new ClassPathXmlApplicationContext(\"conf/appContext.xml\");\n</code></pre> <p>\u56e0\u4e3a\u4f7f\u7528\u4e86ClassPathResource\uff0c\u6240\u4ee5Bean\u5b9a\u4e49\u662f\u4ececlasspath\u52a0\u8f7d\u7684\u3002\u7136\u800c\uff0c\u8003\u8651\u4e0b\u9762\u7684\u4f8b\u5b50\uff0c\u5b83\u521b\u5efa\u4e86\u4e00\u4e2aFileSystemXmlApplicationContext\u3002</p> <pre><code>ApplicationContext ctx =\n    new FileSystemXmlApplicationContext(\"conf/appContext.xml\");\n</code></pre> <p>\u73b0\u5728\uff0cbean\u5b9a\u4e49\u4ece\u6587\u4ef6\u7cfb\u7edf\u52a0\u8f7d\uff08\u5728\u672c\u4f8b\u4e2d\uff0c\u76f8\u5bf9\u4e8e\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\uff09\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u5728\u4f4d\u7f6e\u8def\u5f84\u4e0a\u4f7f\u7528\u7279\u6b8a\u7684 classpath \u524d\u7f00\u6216\u6807\u51c6 URL \u524d\u7f00\u4f1a\u8986\u76d6\u4e3a\u52a0\u8f7d\u5b9a\u4e49\u800c\u521b\u5efa\u7684\u8d44\u6e90\u7684\u9ed8\u8ba4\u7c7b\u578b\u3002\u8003\u8651\u4ee5\u4e0b\u793a\u4f8b:</p> <pre><code>ApplicationContext ctx =\n    new FileSystemXmlApplicationContext(\"classpath:conf/appContext.xml\");\n</code></pre> <p>\u4f7f\u7528FileSystemXmlApplicationContext\u4ececlasspath\u52a0\u8f7dbean\u5b9a\u4e49\u3002\u7136\u800c\uff0c\u5b83\u4ecd\u7136\u662f\u4e00\u4e2aFileSystemXmlApplicationContext\u3002\u5982\u679c\u5b83\u968f\u540e\u88ab\u7528\u4f5c\u8d44\u6e90\u52a0\u8f7d\u5668\uff0c\u4efb\u4f55\u672a\u56fa\u5b9a\u7684\u8def\u5f84\u4ecd\u7136\u88ab\u89c6\u4e3a\u6587\u4ef6\u7cfb\u7edf\u8def\u5f84\u3002</p> <p>\u6784\u9020<code>ClassPathXmlApplicationContext</code>\u5b9e\u4f8b\u7684\u5feb\u6377\u65b9\u5f0f</p> <p>ClassPathXmlApplicationContext \u66b4\u9732\u4e86\u8bb8\u591a\u6784\u9020\u51fd\u6570\u4ee5\u65b9\u4fbf\u5b9e\u4f8b\u5316\u3002\u57fa\u672c\u7684\u601d\u8def\u662f\uff0c\u4f60\u53ef\u4ee5\u53ea\u63d0\u4f9b\u4e00\u4e2a\u5b57\u7b26\u4e32\u6570\u7ec4\uff0c\u5176\u4e2d\u53ea\u5305\u542bXML\u6587\u4ef6\u672c\u8eab\u7684\u6587\u4ef6\u540d\uff08\u4e0d\u5305\u542b\u524d\u5bfc\u8def\u5f84\u4fe1\u606f\uff09\uff0c\u5e76\u63d0\u4f9b\u4e00\u4e2aClass.\u8fd9\u4e2a<code>ClassPathXmlApplicationContext</code>\u4f1a\u4ece\u6240\u63d0\u4f9b\u7684\u7c7b\u4e2d\u83b7\u53d6\u8def\u5f84\u4fe1\u606f\u3002\u7136\u540eClassPathXmlApplicationContext\u4ece\u63d0\u4f9b\u7684\u7c7b\u4e2d\u83b7\u53d6\u8def\u5f84\u4fe1\u606f\u3002</p> <p>\u8003\u8651\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\uff1a</p> <pre><code>com/\n  foo/\n    services.xml\n    daos.xml\n    MessengerService.class\n</code></pre> <p>\u4ee5\u4e0b\u793a\u4f8b\u663e\u793a\u5982\u4f55\u5b9e\u4f8b\u5316\u7531\u5728\u540d\u4e3aservice.xml\u548cdaos.xml\uff08\u4f4d\u4e8e\u7c7b\u8def\u5f84\u4e2d\uff09\u7684\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684bean\u7ec4\u6210\u7684ClassPathXmlApplicationContext\u5b9e\u4f8b\uff1a</p> <pre><code>ApplicationContext ctx = new ClassPathXmlApplicationContext(\n    new String[] {\"services.xml\", \"daos.xml\"}, MessengerService.class);\n</code></pre>"},{"location":"java/spring/spring/Resource/#282-application-context","title":"2.8.2  Application Context \u6784\u9020\u51fd\u6570\u4e2d\u8d44\u6e90\u8def\u5f84\u7684\u901a\u914d\u7b26","text":"<p>The resource paths in application context constructor values may be simple paths (as shown earlier), each of which has a one-to-one mapping to a target <code>Resource</code> or, alternately, may contain the special \"classpath*:\" prefix or internal Ant-style regular expressions (matched by using Spring\u2019s <code>PathMatcher</code> utility). Both of the latter are effectively wildcards.</p> <p>One use for this mechanism is when you need to do component-style application assembly. All components can 'publish' context definition fragments to a well-known location path, and, when the final application context is created using the same path prefixed with <code>classpath*:</code>, all component fragments are automatically picked up.</p> <p>Note that this wildcarding is specific to the use of resource paths in application context constructors (or when you use the <code>PathMatcher</code> utility class hierarchy directly) and is resolved at construction time. It has nothing to do with the <code>Resource</code> type itself. You cannot use the <code>classpath*:</code> prefix to construct an actual <code>Resource</code>, as a resource points to just one resource at a time.</p> <p>\u5e94\u7528\u4e0a\u4e0b\u6587\u6784\u9020\u51fd\u6570\u4e2d\u7684\u8d44\u6e90\u8def\u5f84\u53ef\u4ee5\u662f\u7b80\u5355\u7684\u8def\u5f84\uff08\u5982\u524d\u6240\u8ff0\uff09\uff0c\u6bcf\u4e2a\u8def\u5f84\u90fd\u6709\u4e00\u4e2a\u5230\u76ee\u6807<code>Resource</code>\u7684\u4e00\u5bf9\u4e00\u6620\u5c04\uff0c\u6216\u8005\u4e5f\u53ef\u4ee5\u5305\u542b\u7279\u6b8a\u7684 \"classpath*: \"\u524d\u7f00\u6216\u5185\u90e8Ant\u98ce\u683c\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff08\u901a\u8fc7\u4f7f\u7528Spring\u7684<code>PathMatcher</code>\u5339\u914d\uff09,\u4e24\u8005\u90fd\u662f\u6709\u6548\u7684\u901a\u914d\u7b26\u3002</p> <p>\u8fd9\u79cd\u673a\u5236\u7684\u4e00\u4e2a\u7528\u9014\u662f\u5f53\u4f60\u9700\u8981\u505acomponent-style\u7684application\u7ec4\u88c5\u65f6\u3002\u6240\u6709\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u5c06\u5e94\u7528\u5b9a\u4e49\u4ee3\u7801 \"\u53d1\u5e03 \"\u5230\u4e00\u4e2a\u4f17\u6240\u5468\u77e5\u7684\u8def\u5f84\u4f4d\u7f6e\u4e0a\uff0c\u8fd9\u6837\uff0c\u5f53\u6700\u7ec8\u7684\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u4ee5<code>classpath*:</code>\u4e3a\u524d\u7f00\u7684\u76f8\u540c\u8def\u5f84\u521b\u5efa\u4e0a\u4e0b\u6587\u65f6\uff0c\u6240\u6709\u7ec4\u4ef6\u7247\u6bb5\u90fd\u4f1a\u88ab\u81ea\u52a8\u62fe\u53d6\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u8fd9\u79cd\u901a\u914d\u662f\u7279\u5b9a\u4e8e\u5728\u5e94\u7528\u4e0a\u4e0b\u6587\u6784\u9020\u51fd\u6570\u4e2d\u4f7f\u7528\u8d44\u6e90\u8def\u5f84\u7684\u60c5\u51b5\uff08\u6216\u8005\u76f4\u63a5\u4f7f\u7528PathMatcher\u5b9e\u7528\u7c7b\u5c42\u6b21\u7ed3\u6784\u65f6\uff09\uff0c\u5e76\u5728\u6784\u9020\u65f6\u89e3\u51b3\u3002\u5b83\u4e0e\u8d44\u6e90\u7c7b\u578b\u672c\u8eab\u65e0\u5173\u3002\u60a8\u4e0d\u80fd\u4f7f\u7528<code>classpath*:</code>\u524d\u7f00\u6765\u6784\u9020\u4e00\u4e2a\u5b9e\u9645\u7684Resource\uff0c\u56e0\u4e3a\u4e00\u4e2a\u8d44\u6e90\u4e00\u6b21\u53ea\u6307\u5411\u4e00\u4e2a\u8d44\u6e90\u3002</p> <p><code>ResourcePatternResolver</code>\u5728\u7ee7\u627f<code>ResourceLoader</code>\u7684\u57fa\u7840\u4e0a\uff0c\u53c8\u5f15\u5165\u4e86<code>Resource[] getResources(String)</code>\u7684\u65b9\u6cd5\u5b9a\u4e49\uff0c\u4ee5\u652f\u6301\u6839\u636e\u8def\u5f84\u5339\u914d\u6a21\u5f0f\u8fd4\u56de\u591a\u4e2aResource\u7684\u529f\u80fd\u3002\u540c\u65f6\u5f15\u5165\u4e86\u4e00\u79cd\u7684\u65b0\u7684\u534f\u8bae\u524d\u7f00<code>classpath*:</code></p> <p>PathMatchingResourcePatternResolver\u662f<code>ResourcePatternResolver</code>\u7684\u5b9e\u73b0\uff0c</p>"},{"location":"java/spring/spring/Resource/#ant-style-patterns","title":"Ant-style Patterns","text":"<p>Path locations\u53ef\u4ee5\u5305\u542bAnt-style\u98ce\u683c\uff1a</p> <pre><code>/WEB-INF/*-context.xml\ncom/mycompany/**/applicationContext.xml\nfile:C:/some/path/*-context.xml\nclasspath:com/mycompany/**/applicationContext.xml\n</code></pre> <p>When the path location contains an Ant-style pattern, the resolver follows a more complex procedure to try to resolve the wildcard. It produces a <code>Resource</code> for the path up to the last non-wildcard segment and obtains a URL from it. If this URL is not a <code>jar:</code> URL or container-specific variant (such as <code>zip:</code> in WebLogic, <code>wsjar</code> in WebSphere, and so on), a <code>java.io.File</code> is obtained from it and used to resolve the wildcard by traversing the filesystem. In the case of a jar URL, the resolver either gets a <code>java.net.JarURLConnection</code> from it or manually parses the jar URL and then traverses the contents of the jar file to resolve the wildcards.</p> <p>\u5f53\u8def\u5f84\u4f4d\u7f6e\u5305\u542bAnt-style\u6a21\u5f0f\u65f6\uff0c\u89e3\u6790\u5668\u4f1a\u9075\u5faa\u4e00\u4e2a\u66f4\u590d\u6742\u7684\u7a0b\u5e8f\u6765\u5c1d\u8bd5\u89e3\u6790\u901a\u914d\u7b26\u3002\u5b83\u4e3a\u8def\u5f84\u751f\u6210\u4e00\u4e2a<code>Resource</code> \uff0c\u76f4\u5230\u6700\u540e\u4e00\u4e2a\u975e\u901a\u914d\u7b26\u6bb5\uff0c\u5e76\u4ece\u4e2d\u83b7\u53d6\u4e00\u4e2a URL\u3002\u5982\u679c\u8fd9\u4e2a URL \u4e0d\u662f <code>jar:</code> URL \u6216\u5bb9\u5668\u7279\u5b9a\u7684\u53d8\u4f53\uff08\u5982 WebLogic \u4e2d\u7684 zip:\u3001WebSphere \u4e2d\u7684 wsjar \u7b49\uff09\uff0c\u5219\u4ece\u4e2d\u83b7\u53d6\u4e00\u4e2a <code>java.io.File</code>\uff0c\u5e76\u901a\u8fc7\u904d\u5386\u6587\u4ef6\u7cfb\u7edf\u6765\u89e3\u6790\u901a\u914d\u7b26\u3002\u5728jar URL\u7684\u60c5\u51b5\u4e0b\uff0c\u89e3\u6790\u5668\u8981\u4e48\u4ece\u4e2d\u83b7\u53d6\u4e00\u4e2ajava.net.JarURLConnection\uff0c\u8981\u4e48\u624b\u52a8\u89e3\u6790jar URL\uff0c\u7136\u540e\u904d\u5386jar\u6587\u4ef6\u7684\u5185\u5bb9\u6765\u89e3\u6790\u901a\u914d\u7b26\u3002</p>"},{"location":"java/spring/spring/Resource/#_1","title":"\u53ef\u79fb\u690d\u6027\u7684\u542b\u4e49","text":"<p>If the specified path is already a file URL (either implicitly because the base <code>ResourceLoader</code> is a filesystem one or explicitly), wildcarding is guaranteed to work in a completely portable fashion.</p> <p>If the specified path is a classpath location, the resolver must obtain the last non-wildcard path segment URL by making a <code>Classloader.getResource()</code> call. Since this is just a node of the path (not the file at the end), it is actually undefined (in the <code>ClassLoader</code> javadoc) exactly what sort of a URL is returned in this case. In practice, it is always a <code>java.io.File</code> representing the directory (where the classpath resource resolves to a filesystem location) or a jar URL of some sort (where the classpath resource resolves to a jar location). Still, there is a portability concern on this operation.</p> <p>If a jar URL is obtained for the last non-wildcard segment, the resolver must be able to get a <code>java.net.JarURLConnection</code> from it or manually parse the jar URL, to be able to walk the contents of the jar and resolve the wildcard. This does work in most environments but fails in others, and we strongly recommend that the wildcard resolution of resources coming from jars be thoroughly tested in your specific environment before you rely on it.</p> <p>\u5982\u679c\u6307\u5b9a\u7684\u8def\u5f84\u5df2\u7ecf\u662f\u4e00\u4e2a\u6587\u4ef6 URL\uff08\u56e0\u4e3a\u57fa\u7840 ResourceLoader \u662f\u6587\u4ef6\u7cfb\u7edf\u7684 URL\uff0c\u6240\u4ee5\u9690\u5f0f\u5730\u6216\u663e\u5f0f\u5730\uff09\uff0c\u5219\u4fdd\u8bc1\u4ee5\u5b8c\u5168\u53ef\u79fb\u690d\u7684\u65b9\u5f0f\u8fdb\u884c\u901a\u914d\u3002</p> <p>\u5982\u679c\u6307\u5b9a\u7684\u8def\u5f84\u662f\u4e00\u4e2aclasspath\u4f4d\u7f6e\uff0c\u89e3\u6790\u5668\u5fc5\u987b\u901a\u8fc7\u8c03\u7528Classloader.getResource()\u6765\u83b7\u53d6\u6700\u540e\u4e00\u4e2a\u975e\u901a\u914d\u7684\u8def\u5f84\u6bb5URL\u3002\u7531\u4e8e\u8fd9\u53ea\u662f\u8def\u5f84\u7684\u4e00\u4e2a\u8282\u70b9\uff08\u800c\u4e0d\u662f\u6700\u540e\u7684\u6587\u4ef6\uff09\uff0c\u6240\u4ee5\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7a76\u7adf\u8fd4\u56de\u4ec0\u4e48\u6837\u7684URL\uff0c\u5b9e\u9645\u4e0a\u662f\u6ca1\u6709\u5b9a\u4e49\u7684\uff08\u5728ClassLoader javadoc\u4e2d\uff09\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u5b83\u603b\u662f\u4e00\u4e2a\u4ee3\u8868\u76ee\u5f55\u7684java.io.File(classpath\u8d44\u6e90\u89e3\u6790\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u4f4d\u7f6e)\u6216\u67d0\u79cd\u7c7b\u578b\u7684jar URL(classpath\u8d44\u6e90\u89e3\u6790\u5230jar\u7684\u4f4d\u7f6e)\u3002\u4e0d\u8fc7\uff0c\u5728\u8fd9\u4e2a\u64cd\u4f5c\u4e0a\u8fd8\u662f\u6709\u4e00\u4e2a\u53ef\u79fb\u690d\u6027\u7684\u95ee\u9898\u3002</p> <p>\u5982\u679c\u83b7\u5f97\u4e86\u6700\u540e\u4e00\u4e2a\u975e\u901a\u914d\u7b26\u6bb5\u7684 jar URL\uff0c\u89e3\u6790\u8005\u5fc5\u987b\u80fd\u591f\u4ece\u4e2d\u83b7\u5f97 java.net.JarURLConnection \u6216\u624b\u52a8\u89e3\u6790 jar URL\uff0c\u624d\u80fd\u8d70\u5230 jar \u7684\u5185\u5bb9\u5e76\u89e3\u6790\u901a\u914d\u7b26\u3002\u8fd9\u5728\u5927\u591a\u6570\u73af\u5883\u4e2d\u786e\u5b9e\u53ef\u884c\uff0c\u4f46\u5728\u5176\u4ed6\u73af\u5883\u4e2d\u5374\u4f1a\u5931\u8d25\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u5728\u4f9d\u8d56\u6765\u81eajar\u7684\u8d44\u6e90\u7684\u901a\u914d\u7b26\u89e3\u6790\u4e4b\u524d\uff0c\u5148\u5728\u7279\u5b9a\u73af\u5883\u4e2d\u8fdb\u884c\u5f7b\u5e95\u6d4b\u8bd5\u3002</p>"},{"location":"java/spring/spring/Resource/#classpath","title":"<code>classpath*:</code> \u524d\u7f00","text":"<p>\u5f53\u901a\u8fc7\u57fa\u4e8eXML\u6784\u9020\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u65f6</p> <pre><code>ApplicationContext ctx =\n    new ClassPathXmlApplicationContext(\"classpath*:conf/appContext.xml\");\n</code></pre> <p>\u8fd9\u4e2a\u7279\u6b8a\u7684\u524d\u7f00\u6307\u5b9a\u5fc5\u987b\u83b7\u5f97\u6240\u6709\u4e0e\u7ed9\u5b9a\u540d\u79f0\u76f8\u5339\u914d\u7684classpath\u8d44\u6e90\uff08\u5728\u5185\u90e8\uff0c\u8fd9\u57fa\u672c\u4e0a\u662f\u901a\u8fc7\u8c03\u7528ClassLoader.getResources(...)\u6765\u5b9e\u73b0\u7684\uff09\uff0c\u7136\u540e\u5408\u5e76\u6210\u6700\u7ec8\u7684\u5e94\u7528\u4e0a\u4e0b\u6587\u5b9a\u4e49\u3002</p> <p>The wildcard classpath relies on the <code>getResources()</code> method of the underlying classloader. As most application servers nowadays supply their own classloader implementation, the behavior might differ, especially when dealing with jar files. A simple test to check if <code>classpath*</code> works is to use the classloader to load a file from within a jar on the classpath: <code>getClass().getClassLoader().getResources(\"&lt;someFileInsideTheJar&gt;\")</code>. Try this test with files that have the same name but are placed inside two different locations. In case an inappropriate result is returned, check the application server documentation for settings that might affect the classloader behavior.</p> <p>\u901a\u914d\u7b26classpath\u4f9d\u8d56\u4e8e\u5e95\u5c42classloader\u7684getResources()\u65b9\u6cd5\u3002\u7531\u4e8e\u73b0\u5728\u5927\u591a\u6570\u5e94\u7528\u670d\u52a1\u5668\u90fd\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684classloader\u5b9e\u73b0\uff0c\u56e0\u6b64\u884c\u4e3a\u53ef\u80fd\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u7279\u522b\u662f\u5728\u5904\u7406jar\u6587\u4ef6\u65f6\u3002\u68c0\u67e5classpath*\u662f\u5426\u5de5\u4f5c\u7684\u4e00\u4e2a\u7b80\u5355\u6d4b\u8bd5\u662f\u4f7f\u7528classloader\u4ececlasspath\u4e0a\u7684jar\u4e2d\u52a0\u8f7d\u4e00\u4e2a\u6587\u4ef6\uff1a<code>getClass().getClassLoader().getResources(\"&lt;someFileInsideTheJar&gt;\")</code>\u3002\u7528\u540d\u79f0\u76f8\u540c\u4f46\u653e\u5728\u4e24\u4e2a\u4e0d\u540c\u4f4d\u7f6e\u5185\u7684\u6587\u4ef6\u6765\u5c1d\u8bd5\u8fd9\u4e2a\u6d4b\u8bd5\u3002\u5982\u679c\u8fd4\u56de\u7684\u7ed3\u679c\u4e0d\u5408\u9002\uff0c\u8bf7\u68c0\u67e5\u5e94\u7528\u670d\u52a1\u5668\u6587\u6863\u4e2d\u53ef\u80fd\u5f71\u54cdclassloader\u884c\u4e3a\u7684\u8bbe\u7f6e\u3002</p> <p>You can also combine the <code>classpath*:</code> prefix with a <code>PathMatcher</code> pattern in the rest of the location path (for example, <code>classpath*:META-INF/*-beans.xml</code>). In this case, the resolution strategy is fairly simple: A <code>ClassLoader.getResources()</code> call is used on the last non-wildcard path segment to get all the matching resources in the class loader hierarchy and then, off each resource, the same <code>PathMatcher</code> resolution strategy described earlier is used for the wildcard subpath.</p> <p>\u4f60\u4e5f\u53ef\u4ee5\u5c06<code>classpath*:</code>\u524d\u7f00\u4e0e\u4f4d\u7f6e\u8def\u5f84\u5176\u4f59\u90e8\u5206\u7684PathMatcher\u6a21\u5f0f\u7ed3\u5408\u8d77\u6765\uff08\u4f8b\u5982\uff0c<code>classpath*:META-INF/*-beans.xml</code>\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u89e3\u6790\u7b56\u7565\u76f8\u5f53\u7b80\u5355\u3002\u5728\u6700\u540e\u4e00\u4e2a\u975e\u901a\u914d\u7b26\u8def\u5f84\u6bb5\u4e0a\u4f7f\u7528ClassLoader.getResources()\u8c03\u7528\uff0c\u4ee5\u83b7\u53d6\u7c7b\u52a0\u8f7d\u5668\u5c42\u6b21\u7ed3\u6784\u4e2d\u6240\u6709\u5339\u914d\u7684\u8d44\u6e90\uff0c\u7136\u540e\uff0c\u5728\u6bcf\u4e2a\u8d44\u6e90\u4e4b\u5916\uff0c\u5bf9\u901a\u914d\u7b26\u5b50\u8def\u5f84\u4f7f\u7528\u524d\u9762\u63cf\u8ff0\u7684\u76f8\u540cPathMatcher\u89e3\u6790\u7b56\u7565\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4Spring \u5c06\u4f1a\u641c\u7d22\u7c7b\u52a0\u8f7d\u8def\u5f84\u4e0b\u6240\u6709\u6ee1\u8db3\u8be5\u89c4\u5219\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u5982\u679c\u4e0d\u662f\u91c7\u7528 classpath*: \u524d\u7f00\uff0c\u800c\u662f\u6539\u4e3a\u4f7f\u7528 classpath: \u524d\u7f00\uff0cSpring \u53ea\u52a0\u8f7d\u7b2c\u4e00\u4efd\u7b26\u5408\u6761\u4ef6\u7684 XML \u6587\u4ef6\uff0c\u4f8b\u5982\u5982\u4e0b\u4ee3\u7801\uff1a</p>"},{"location":"java/spring/spring/Resource/#_2","title":"\u5173\u4e8e\u901a\u914d\u7b26\u5176\u4ed6\u6ce8\u610f\u70b9","text":"<p>\u8bf7\u6ce8\u610f\uff0cclasspath:\u4e0eAnt-style\u6a21\u5f0f\u7ed3\u5408\u4f7f\u7528\u65f6\uff0c\u53ea\u6709\u5728\u6a21\u5f0f\u542f\u52a8\u524d\u81f3\u5c11\u6709\u4e00\u4e2a\u6839\u76ee\u5f55\u65f6\u624d\u4f1a\u53ef\u9760\u5730\u5de5\u4f5c\uff0c\u9664\u975e\u5b9e\u9645\u7684\u76ee\u6807\u6587\u4ef6\u4f4d\u4e8e\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002\u8fd9\u610f\u5473\u7740\uff0cclasspath:*.xml\u8fd9\u6837\u7684\u6a21\u5f0f\u53ef\u80fd\u4e0d\u4f1a\u4ecejar\u6587\u4ef6\u7684\u6839\u76ee\u5f55\u4e2d\u68c0\u7d22\u6587\u4ef6\uff0c\u800c\u53ea\u80fd\u4ece\u6269\u5c55\u76ee\u5f55\u7684\u6839\u76ee\u5f55\u4e2d\u68c0\u7d22\u3002</p> <p>Spring\u68c0\u7d22classpath\u6761\u76ee\u7684\u80fd\u529b\u6e90\u4e8eJDK\u7684ClassLoader.getResources()\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u53ea\u8fd4\u56de\u7a7a\u5b57\u7b26\u4e32\u7684\u6587\u4ef6\u7cfb\u7edf\u4f4d\u7f6e\uff08\u8868\u793a\u8981\u641c\u7d22\u7684\u6f5c\u5728\u6839\uff09\u3002Spring\u4e5f\u4f1a\u8bc4\u4f30URLClassLoader\u8fd0\u884c\u65f6\u914d\u7f6e\u548cjar\u6587\u4ef6\u4e2d\u7684java.class.path\u6e05\u5355\uff0c\u4f46\u8fd9\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u5bfc\u81f4\u53ef\u79fb\u690d\u884c\u4e3a\u3002</p> <p>\u5bf9classpath\u5305\u7684\u626b\u63cf\u9700\u8981\u5728classpath\u4e2d\u5b58\u5728\u76f8\u5e94\u7684\u76ee\u5f55\u9879\u3002\u5f53\u4f60\u4f7f\u7528Ant\u6784\u5efaJAR\u65f6\uff0c\u4e0d\u8981\u6fc0\u6d3bJAR\u4efb\u52a1\u7684\u4ec5\u6587\u4ef6\u5f00\u5173\u3002\u53e6\u5916\uff0c\u6839\u636e\u67d0\u4e9b\u73af\u5883\u4e2d\u7684\u5b89\u5168\u7b56\u7565\uff0cclasspath\u76ee\u5f55\u53ef\u80fd\u4e0d\u4f1a\u88ab\u66b4\u9732--\u4f8b\u5982\uff0cJDK 1.7.0_45\u53ca\u66f4\u9ad8\u7248\u672c\u4e0a\u7684\u72ec\u7acb\u5e94\u7528\u7a0b\u5e8f\uff08\u9700\u8981\u5728\u60a8\u7684\u6e05\u5355\u4e2d\u8bbe\u7f6e'Trusted-Library'\u3002\u53c2\u89c1https://stackoverflow.com/questions/19394570/java-jre-7u45-breaks-classloader-getresources\uff09\u3002)</p> <p>\u5728JDK 9\u7684\u6a21\u5757\u8def\u5f84(Jigsaw)\u4e0a\uff0cSpring\u7684classpath\u626b\u63cf\u4e00\u822c\u90fd\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002\u8fd9\u91cc\u4e5f\u5f3a\u70c8\u5efa\u8bae\u628a\u8d44\u6e90\u653e\u5230\u4e00\u4e2a\u4e13\u95e8\u7684\u76ee\u5f55\u4e2d\uff0c\u907f\u514d\u4e86\u524d\u9762\u63d0\u5230\u7684\u641c\u7d22jar\u6587\u4ef6\u6839\u7ea7\u7684\u53ef\u79fb\u690d\u6027\u95ee\u9898\u3002</p> <p>Ant\u6a21\u5f0f\u4e0eclasspath\uff1a\u5982\u679c\u8981\u641c\u7d22\u7684\u6839\u5305\u5728\u591a\u4e2a\u7c7b\u8def\u5f84\u4f4d\u7f6e\u90fd\u6709\uff0c\u5219\u4e0d\u80fd\u4fdd\u8bc1\u627e\u5230\u5339\u914d\u7684\u8d44\u6e90\u3002\u8003\u8651\u4ee5\u4e0b\u8d44\u6e90\u4f4d\u7f6e\u7684\u4f8b\u5b50\u3002</p> <pre><code>com/mycompany/package1/service-context.xml\n</code></pre> <p>\u73b0\u5728\u8003\u8651\u4e00\u4e2aAnt\u7684\u8def\u5f84\uff0c\u6709\u4eba\u53ef\u80fd\u4f1a\u7528\u5b83\u6765\u5bfb\u627e\u8fd9\u4e2a\u6587\u4ef6\u3002</p> <pre><code>classpath:com/mycompany/**/service-context.xml\n</code></pre> <p>\u8fd9\u6837\u7684\u8d44\u6e90\u53ef\u80fd\u53ea\u5b58\u5728\u4e8e\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u4f46\u5f53\u4f7f\u7528\u524d\u9762\u7684\u4f8b\u5b50\u8fd9\u6837\u7684\u8def\u5f84\u8bd5\u56fe\u89e3\u6790\u5b83\u65f6\uff0c\u89e3\u6790\u5668\u4f1a\u6839\u636e<code>getResource(\"com/mycompany\");</code>\u8fd4\u56de\u7684\uff08\u7b2c\u4e00\u4e2a\uff09URL\u5de5\u4f5c\u3002\u5982\u679c\u8be5\u57fa\u7840\u5305\u8282\u70b9\u5b58\u5728\u4e8e\u591a\u4e2a classloader \u4f4d\u7f6e\uff0c\u5219\u5b9e\u9645\u7684\u7ec8\u7aef\u8d44\u6e90\u53ef\u80fd\u4e0d\u5728\u90a3\u91cc\u3002\u56e0\u6b64\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u5e94\u8be5\u66f4\u503e\u5411\u4e8e\u4f7f\u7528classpath*:\uff0c\u7528\u540c\u6837\u7684Ant\u98ce\u683c\u6a21\u5f0f\uff0c\u5b83\u641c\u7d22\u6240\u6709\u5305\u542b\u6839\u5305\u7684\u7c7b\u8def\u5f84\u4f4d\u7f6e\u3002</p>"},{"location":"java/spring/spring/Resource/#283-filesystemresource","title":"2.8.3 <code>FileSystemResource</code> \u6ce8\u610f\u4e8b\u9879","text":"<p>A <code>FileSystemResource</code> that is not attached to a <code>FileSystemApplicationContext</code> (that is, when a <code>FileSystemApplicationContext</code> is not the actual <code>ResourceLoader</code>) treats absolute and relative paths as you would expect. Relative paths are relative to the current working directory, while absolute paths are relative to the root of the filesystem.</p> <p>\u672a\u9644\u52a0\u5230FileSystemApplicationContext\u7684FileSystemResource\uff08\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53FileSystemApplicationContext\u4e0d\u662f\u5b9e\u9645\u7684ResourceLoader\u65f6\uff09\u4f1a\u50cf\u4f60\u671f\u671b\u7684\u90a3\u6837\u5904\u7406\u7edd\u5bf9\u8def\u5f84\u548c\u76f8\u5bf9\u8def\u5f84\u3002\u76f8\u5bf9\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u7684\uff0c\u800c\u7edd\u5bf9\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6839\u3002</p> <p>For backwards compatibility (historical) reasons however, this changes when the <code>FileSystemApplicationContext</code> is the <code>ResourceLoader</code>. The <code>FileSystemApplicationContext</code> forces all attached <code>FileSystemResource</code> instances to treat all location paths as relative, whether they start with a leading slash or not. In practice, this means the following examples are equivalent:</p> <p>\u7136\u800c\uff0c\u51fa\u4e8e\u5411\u540e\u517c\u5bb9\u6027\uff08\u5386\u53f2\uff09\u7684\u539f\u56e0\uff0c\u5f53FileSystemApplicationContext\u662fResourceLoader\u65f6\uff0c\u8fd9\u79cd\u60c5\u51b5\u4f1a\u6539\u53d8\u3002FileSystemApplicationContext\u5f3a\u5236\u6240\u6709\u9644\u52a0\u7684FileSystemResource\u5b9e\u4f8b\u5c06\u6240\u6709\u4f4d\u7f6e\u8def\u5f84\u89c6\u4e3a\u76f8\u5bf9\u8def\u5f84\uff0c\u65e0\u8bba\u5b83\u4eec\u662f\u5426\u4ee5\u524d\u5bfc\u659c\u7ebf\u5f00\u59cb\u3002\u5728\u5b9e\u8df5\u4e2d\uff0c\u8fd9\u610f\u5473\u7740\u4e0b\u9762\u7684\u4f8b\u5b50\u662f\u7b49\u4ef7\u7684:</p> <pre><code>ApplicationContext ctx =\n    new FileSystemXmlApplicationContext(\"conf/context.xml\");\n</code></pre> <pre><code>ApplicationContext ctx =\n    new FileSystemXmlApplicationContext(\"/conf/context.xml\");\n</code></pre> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u4e5f\u662f\u7b49\u4ef7\u7684\uff08\u5c3d\u7ba1\u5b83\u4eec\u662f\u4e0d\u540c\u7684\uff0c\u56e0\u4e3a\u4e00\u79cd\u60c5\u51b5\u662f\u76f8\u5bf9\u8def\u5f84\uff0c\u53e6\u4e00\u79cd\u60c5\u51b5\u662f\u7edd\u5bf9\u8def\u5f84\uff09\u3002</p> <pre><code>FileSystemXmlApplicationContext ctx = ...;\nctx.getResource(\"some/resource/path/myTemplate.txt\");\n</code></pre> <pre><code>FileSystemXmlApplicationContext ctx = ...;\nctx.getResource(\"/some/resource/path/myTemplate.txt\");\n</code></pre> <p>In practice, if you need true absolute filesystem paths, you should avoid using absolute paths with <code>FileSystemResource</code> or <code>FileSystemXmlApplicationContext</code> and force the use of a <code>UrlResource</code> by using the <code>file:</code> URL prefix. The following examples show how to do so:</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u5982\u679c\u9700\u8981\u771f\u6b63\u7684\u7edd\u5bf9\u6587\u4ef6\u7cfb\u7edf\u8def\u5f84\uff0c\u5e94\u8be5\u907f\u514d\u4f7f\u7528FileSystemResource\u6216FileSystemXmlApplicationContext\u7684\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u5e94\u8be5\u901a\u8fc7\u4f7f\u7528<code>file:</code>\u7684URL\u524d\u7f00\u5f3a\u5236\u4f7f\u7528<code>UrlResource</code>\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>// \u4e0d\u7ba1ApplicationContext\u7684\u5b9e\u9645\u7c7b\u578b, the Resource will always be UrlResource\nctx.getResource(\"file:///some/resource/path/myTemplate.txt\");\n</code></pre> <pre><code>// force this FileSystemXmlApplicationContext to load its definition via a UrlResource\nApplicationContext ctx =\n    new FileSystemXmlApplicationContext(\"file:///conf/context.xml\");\n</code></pre>"},{"location":"java/spring/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/","title":"Spring\u662f\u5982\u4f55\u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u7684\uff1f","text":"<ul> <li>Spring\u53ef\u4ee5\u89e3\u51b3\u6784\u9020\u51fd\u6570\u7684\u5faa\u73af\u4f9d\u8d56\u5417\uff1f</li> </ul> <p>\u76f4\u63a5\u662f\u62a5\u9519\u7684\uff0c\u4f46\u662f\u4f7f\u7528@lazy\u53ef\u4ee5\u89e3\u51b3\u3002\u662f\u901a\u8fc7cglib\u521b\u5efa\u4e00\u4e2a\u7a7a\u5bf9\u8c61\u7528\u4e8e\u4f9d\u8d56\u3002</p> <ul> <li>\u539f\u578bscoope\u7684bean\u4e4b\u95f4\u7684\u5faa\u73af\u4f9d\u8d56\u53ef\u4ee5\u89e3\u51b3\u5417\uff1f</li> </ul> <p>\u4e0d\u80fd\uff01\u539f\u578b\u7684bean\u662f\u5728\u9700\u8981\u7684\u65f6\u5019\u518d\u521b\u5efa\uff0c\u4e5f\u5c31\u662fSpring\u5e76\u6ca1\u6709\u8fdb\u884c\u7ba1\u7406\uff0c\u653e\u8fdb\u7f13\u5b58\uff0c\u6240\u4ee5\u65e0\u6cd5\u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u95ee\u9898\uff01\uff01</p>"},{"location":"java/spring/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/#_1","title":"\u4e09\u7ea7\u7f13\u5b58","text":"<p>@Autowired\u65b9\u5f0f\u6ce8\u5165\u5c5e\u6027\u65f6\uff0c\u901a\u8fc7\u4e09\u7ea7\u7f13\u5b58\u89e3\u51b3\u3002</p> <ul> <li> <p>\u5355\u4f8b\u6c60</p> </li> <li> <p>\u4e8c\u7ea7\u7f13\u5b58\uff1a\u5b58\u653enew\u51fa\u6765\u7684\u4e0d\u5b8c\u6574\u5bf9\u8c61\uff0c\u8fd9\u6837\u5f53\u5355\u4f8b\u6c60\u4e2dA\u627e\u4e0d\u5230\u4f9d\u8d56\u7684\u5c5e\u6027B\u65f6\uff0c\u5c31\u53ef\u4ee5\u5148\u4ece\u4e8c\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\u4e0d\u5b8c\u6574\u5bf9\u8c61B\uff0c\u5b8c\u6210A\u5bf9\u8c61\u521b\u5efa\u3002\u540e\u7eedB\u53ef\u4ee5\u76f4\u63a5\u4ece\u5355\u4f8b\u6c60\u4e2d\u83b7\u53d6\u5b8c\u6574\u7684\u5bf9\u8c61A\u3002</p> </li> </ul> <p>\u5982\u679c\u5f15\u7528\u7684\u5bf9\u8c61\u914d\u7f6e\u4e86AOP\u9700\u8981\u751f\u6210\u4ee3\u7406\u5bf9\u8c61\u65f6\uff0c\u4e8c\u7ea7\u7f13\u5b58\u5c31\u4e0d\u591f\u7528\u4e86\u3002</p> <p>\u4e8c\u7ea7\u7f13\u5b58\u53ef\u4ee5\u907f\u514d\u91cd\u590d\u521b\u5efa\u67d0\u5bf9\u8c61\u7684\u52a8\u6001\u4ee3\u7406\u3002\u5982A\u548cB\u76f8\u4e92\u4f9d\u8d56\uff0cA\u548cC\u76f8\u4e92\u4f9d\u8d56\uff0c\u6240\u4ee5\u628aA\u653e\u8fdb\u4e8c\u7ea7\u7f13\u5b58\uff0c\u5c31\u53ef\u4ee5\u907f\u514dC\u4e5f\u53bb\u521b\u5efa\u91cd\u590d\u7684A\u52a8\u6001\u5bf9\u8c61\u3002</p> <ul> <li>\u4e09\u7ea7\u7f13\u5b58\uff1a\u5b58\u653e\u6240\u6709\u5bf9\u8c61\u7684\u4ee3\u7406\u914d\u7f6e\u4fe1\u606f\uff0c\u5728\u53d1\u73b0\u6709\u5faa\u73af\u4f9d\u8d56\u65f6\uff0c\u5c06\u8fd9\u4e2a\u5bf9\u8c61\u7684\u52a8\u6001\u914d\u7f6e\u4fe1\u606f\u53d6\u51fa\u6765\uff0c\u63d0\u524d\u751f\u6210\u52a8\u6001\u4ee3\u7406proxy\u3002\u5b58\u7684\u662f\u51fd\u6570\u63a5\u53e3\uff0c\u5e76\u4e0d\u662f\u76f4\u63a5\u8c03\u7528\u3002</li> </ul> <p></p> <p>\u6574\u4e2a\u6838\u5fc3\u4ee3\u7801\u5c31\u5728DefaultSingletonBeanRegistry\uff1a</p> <pre><code>/** \u4e00\u7ea7\u7f13\u5b58 Cache of singleton objects: bean name to bean instance. */\nprivate final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);\n\n/** \u4e8c\u7ea7\u7f13\u5b58 Cache of early singleton objects: bean name to bean instance. */\nprivate final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16);\n\n/** \u4e09\u7ea7\u7f13\u5b58 Cache of singleton factories: bean name to ObjectFactory. */\nprivate final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16);\n\nprotected Object getSingleton(String beanName, boolean allowEarlyReference) {\n    // Quick check for existing instance without full singleton lock\n    Object singletonObject = this.singletonObjects.get(beanName);\n    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {\n        singletonObject = this.earlySingletonObjects.get(beanName);\n        if (singletonObject == null &amp;&amp; allowEarlyReference) {\n            synchronized (this.singletonObjects) {\n                // Consistent creation of early reference within full singleton lock\n                singletonObject = this.singletonObjects.get(beanName);\n                if (singletonObject == null) {\n                    singletonObject = this.earlySingletonObjects.get(beanName);\n                    if (singletonObject == null) {\n                        ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);\n                        if (singletonFactory != null) {\n                            singletonObject = singletonFactory.getObject();\n                            // \u6dfb\u52a0\u5230\u4e8c\u7ea7\u7f13\u5b58\uff0c\u4ece\u4e09\u7ea7\u7f13\u5b58\u5220\u9664\n                            this.earlySingletonObjects.put(beanName, singletonObject);\n                            this.singletonFactories.remove(beanName);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    return singletonObject;\n}\n</code></pre>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/","title":"Validation DataBinding Type Conversion","text":"<p>There are pros and cons for considering validation as business logic, and Spring offers a design for validation (and data binding) that does not exclude either one of them. Specifically, validation should not be tied to the web tier and should be easy to localize, and it should be possible to plug in any available validator. Considering these concerns, Spring provides a <code>Validator</code> contract that is both basic and eminently usable in every layer of an application.</p> <p>Data binding is useful for letting user input be dynamically bound to the domain model of an application (or whatever objects you use to process user input). Spring provides the aptly named <code>DataBinder</code> to do exactly that. The <code>Validator</code> and the <code>DataBinder</code> make up the <code>validation</code> package, which is primarily used in but not limited to the web layer.</p> <p>\u5c06\u6570\u636e\u6821\u9a8c\u89c6\u4e3a\u4e1a\u52a1\u903b\u8f91\u662f\u6709\u5229\u6709\u5f0a\u7684\uff0cspring\u63d0\u4f9b\u7684\u6570\u636e\u6821\u9a8c\u548c\u6570\u636e\u7ed1\u5b9a\u8bbe\u8ba1\uff0c\u4e0d\u6392\u65a5\u5176\u4e2d\u4efb\u4f55\u4e00\u79cd\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6821\u9a8c\u4e0d\u5e94\u8be5\u7ed1\u5b9a\u5230web\u5c42\uff0c\u5e94\u8be5\u6613\u4e8e\u672c\u5730\u5316\uff0c\u800c\u4e14\u5e94\u8be5\u63d2\u5165\u4efb\u4f55\u53ef\u7528\u7684\u9a8c\u8bc1\u5668\u3002\u8003\u8651\u5230\u8fd9\u4e9b\u95ee\u9898\uff0cspring\u63d0\u4f9b\u4e86Validator\u89c4\u8303\uff0c\u5c5e\u4e8e\u57fa\u7840\u89c4\u8303\uff0c\u53ef\u4ee5\u5728\u5e94\u7528\u7684\u4efb\u4f55\u4e00\u5c42\u4f7f\u7528\u3002</p> <p>\u6570\u636e\u7ed1\u5b9a\u5bf9\u4e8e\u8ba9\u7528\u6237\u7684\u8f93\u5165\u52a8\u6001\u7ed1\u5b9a\u5230\u5e94\u7528\u7684domain\u4e2d\u975e\u5e38\u6709\u7528\u3002spring\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6070\u5982\u5176\u5206\u7684\u540d\u5b57DataBinder\u6765\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\u3002Validator\u548cDataBinder\u7ec4\u6210\u4e86validation\u5305\uff0c\u5b83\u4e3b\u8981\u7528\u4e8e\u4f46\u662f\u4e0d\u9650\u4e8eweb\u5c42\u3002</p> <p>The <code>BeanWrapper</code> is a fundamental concept in the Spring Framework and is used in a lot of places. However, you probably do not need to use the <code>BeanWrapper</code> directly. Because this is reference documentation, however, we felt that some explanation might be in order. We explain the <code>BeanWrapper</code> in this chapter, since, if you are going to use it at all, you are most likely do so when trying to bind data to objects.</p> <p>Spring\u2019s <code>DataBinder</code> and the lower-level <code>BeanWrapper</code> both use <code>PropertyEditorSupport</code> implementations to parse and format property values. The <code>PropertyEditor</code> and <code>PropertyEditorSupport</code> types are part of the JavaBeans specification and are also explained in this chapter. Spring 3 introduced a <code>core.convert</code> package that provides a general type conversion facility, as well as a higher-level \u201cformat\u201d package for formatting UI field values. You can use these packages as simpler alternatives to <code>PropertyEditorSupport</code> implementations. They are also discussed in this chapter.</p> <p>BeanWrapper\u5c5e\u4e8espring\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u5728\u5f88\u591a\u5730\u65b9\u90fd\u4f1a\u7528\u5230\u3002\u7136\u800c,\u4f60\u53ef\u80fd\u4e0d\u9700\u8981\u76f4\u63a5\u4f7f\u7528BeanWrapper\u3002\u7136\u800c\u7531\u4e8e\u8fd9\u662f\u53c2\u8003\u6587\u6863\uff0c\u6211\u4eec\u8ba4\u4e3a\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u89e3\u91ca\u3002\u6211\u4eec\u5728\u8fd9\u4e00\u7ae0\u4ecb\u7ecdBeanWrapper\uff0c\u56e0\u4e3a\u5982\u679c\u4f60\u60f3\u8981\u4f7f\u7528\u5b83\uff0c\u4f60\u53ef\u80fd\u662f\u5728\u5c1d\u8bd5\u5c06\u6570\u636e\u7ed1\u5b9a\u5230\u5bf9\u8c61\u3002</p> <p>spring\u7684DataBinder\u548c\u5e95\u5c42\u7684BeanWrapper\u90fd\u4f7f\u7528<code>java.beans.PropertyEditorSupport</code>\u5b9e\u73b0\u6765\u89e3\u6790\u548c\u683c\u5f0f\u5316\u5c5e\u6027\u503c\u3002<code>PropertyEditor</code> \u548c<code>PropertyEditorSupport</code> \u90fd\u662fjavaBean\u89c4\u8303\u7684\u4e00\u90e8\u5206\uff0c\u672c\u7ae0\u8282\u4f1a\u8fdb\u884c\u4ecb\u7ecd\u3002spring 3 \u5f15\u5165\u4e86<code>core.convert</code>\u5305\u63d0\u4f9b\u4e86\u4e00\u4e2a\u901a\u7528\u7684\u7c7b\u578b\u8f6c\u6362\u5de5\u5177\uff0c\u548c\u9876\u5c42\u7684\u201cformat\"\u5305\u7528\u4e8e\u683c\u5f0f\u5316UI\u5b57\u6bb5\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u5305\u4f5c\u4e3a<code>PropertyEditorSupport</code> \u7684\u7b80\u5355\u66ff\u4ee3\u54c1\uff0c\u672c\u7ae0\u4e5f\u4f1a\u8fdb\u884c\u4ecb\u7ecd\u3002</p> <p>Spring supports Java Bean Validation through setup infrastructure and an adaptor to Spring\u2019s own <code>Validator</code> contract. Applications can enable Bean Validation once globally, as described in Java Bean Validation, and use it exclusively for all validation needs. In the web layer, applications can further register controller-local Spring <code>Validator</code> instances per <code>DataBinder</code>, as described in Configuring a <code>DataBinder</code>, which can be useful for plugging in custom validation logic.</p> <p>Spring\u901a\u8fc7\u8bbe\u7f6e\u57fa\u7840\u67b6\u6784\u548cspring\u81ea\u5df1\u7684<code>Validator</code> \u9002\u914d\u5668\u6765\u652f\u6301java\u7684Bean Validation \u3002\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u50cfJava Bean Validation\u63cf\u8ff0\u7684\u4e00\u6837\uff0c\u5728\u5168\u5c40\u8303\u56f4\u5185\u4e00\u6b21\u542f\u7528Bean Validation\uff0c\u7528\u4e8e\u6240\u6709\u7684validation\u9700\u6c42\u3002\u5728web\u5c42\uff0c\u5e94\u7528\u53ef\u4ee5\u66f4\u8fdb\u4e00\u6b65\u4e3a\u6bcf\u4e2aDataBinder\u6ce8\u518c\u672c\u5730controller\u7684Validator\uff0c\u8fd9\u5bf9\u4e8e\u63d2\u5165\u81ea\u5b9a\u4e49\u7684\u6821\u9a8c\u903b\u8f91\u5f88\u6709\u7528\u3002</p>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#31-springvalidator","title":"3.1 \u4f7f\u7528spring\u7684\u6821\u9a8cValidator\u63a5\u53e3","text":""},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#37-java-bean-validation","title":"3.7 Java Bean Validation","text":"<p>spring\u6846\u67b6\u63d0\u4f9b\u4e86\u5bf9 Java Bean Validation\u7684\u652f\u6301\u3002</p>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#371-bean-validation","title":"3.7.1 Bean Validation\u603b\u89c8","text":"<p>Bean Validation\u4e3ajava\u5e94\u7528\u63d0\u4f9b\u4e86\u4e00\u79cd\u901a\u8fc7\u7ea6\u675f\u58f0\u660e\u548c\u5143\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u7684\u901a\u7528\u65b9\u5f0f\u3002\u8981\u4f7f\u7528\u5b83\uff0c\u53ef\u4ee5\u4f7f\u7528\u5728model\u5b57\u6bb5\u4e0a\u6ce8\u89e3\uff0c\u7136\u540e\u8fd0\u884c\u65f6\u5f3a\u5236\u6267\u884c\u3002\u5df2\u7ecf\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5185\u7f6e\u7ea6\u675f\uff0c\u4e5f\u53ef\u4ee5\u5b9a\u4e49\u81ea\u5df1\u7684\u7ea6\u675f\u3002</p> <p>Bean Validation\u5141\u8bb8\u58f0\u660e\u7ea6\u675f</p> <pre><code>public class PersonForm {\n\n    @NotNull\n    @Size(max=64)\n    private String name;\n\n    @Min(0)\n    private int age;\n}\n</code></pre> <p>Bean Validation validator\u4f1a\u57fa\u4e8e\u58f0\u660e\u7684\u6ce8\u89e3\u7ea6\u675f\u6821\u9a8c\u8fd9\u4e2a\u7c7b\u7684\u5b9e\u4f8b. \u66f4\u591a\u4fe1\u606f\u67e5\u770b Bean Validation \u548cHibernate Validator \u6587\u6863\u3002Bean Validation\u662f\u7528\u4e8e\u6570\u636e\u6821\u9a8c\u7684\u4e00\u5957\u89c4\u8303\uff0c \u800cHibernate Validator\u662f\u6b64\u89c4\u8303\u7684\u53c2\u8003\u5b9e\u73b0\u4e14\u5bf9\u5176\u8fdb\u884c\u4e86\u6269\u5c55\u3002</p> <p>\u5982\u679c\u60f3\u8981\u5982\u4f55\u628abean validation provider\u6ce8\u518c\u4e3aspring bean\uff0c\u7ee7\u7eed\u5f80\u4e0b\u9605\u8bfb\u3002 </p>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#372-bean-validation-provider","title":"3.7.2 \u914d\u7f6eBean Validation Provider","text":"<p>spring\u4e3aBean Validation API \u63d0\u4f9b\u4e86\u5168\u9762\u7684\u652f\u6301\uff0c\u5305\u62ec\u5c06Bean Validation Provider\u6ce8\u518c\u4e3aspring bean\u3002\u8fd9\u5141\u8bb8\u4f60\u53ef\u4ee5\u5728\u9700\u8981\u6821\u9a8c\u7684\u5730\u65b9\u6ce8\u5165<code>javax.validation.ValidatorFactory</code> \u6216\u8005<code>javax.validation.Validator</code>\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528LocalValidatorFactoryBean\u914d\u7f6e\u9ed8\u8ba4\u7684validator\u4e3aspring bean\uff0c\u5982\uff1a</p> <pre><code>import org.springframework.validation.beanvalidation.LocalValidatorFactoryBean;\n\n@Configuration\npublic class AppConfig {\n\n    @Bean\n    public LocalValidatorFactoryBean validator() {\n        return new LocalValidatorFactoryBean();\n    }\n}\n</code></pre> <p>\u524d\u9762\u4f8b\u5b50\u4e2d\u57fa\u672c\u914d\u7f6e\u662f\u4f7f\u7528\u9ed8\u8ba4\u7684\u5f15\u5bfc\u673a\u5236\u89e6\u53d1bean\u7684\u9a8c\u8bc1\u521d\u59cb\u5316\u3002\u50cfHibernate validator\u8fd9\u6837\u7684Bean Validation provider\uff0c\u5e0c\u671b\u5728classpath\u4e2d\u88ab\u81ea\u52a8\u68c0\u6d4b\u5230\u3002</p> <p><code>LocalValidatorFactoryBean</code> \u540c\u65f6\u5b9e\u73b0\u4e86 <code>javax.validation.ValidatorFactory</code> \u548c<code>javax.validation.Validator</code>, \u4e5f\u5b9e\u73b0\u4e86 Spring\u7684 <code>org.springframework.validation.Validator</code>\u3002\u4f60\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u63a5\u53e3\u7684\u5f15\u7528\u6ce8\u5165\u5230\u9700\u8981\u8c03\u7528\u9a8c\u8bc1\u903b\u8f91\u7684bean\u4e2d\u3002</p> <p>\u5982\u679c\u4f60\u66f4\u613f\u610f\u4f7f\u7528Validator\u7684API\uff0c\u53ef\u4ee5\u76f4\u63a5\u6ce8\u5165java\u6216spring\u7684Validator\u4f7f\u7528\u3002</p> <pre><code>import javax.validation.Validator;\n\n@Service\npublic class MyService {\n\n    @Autowired\n    private Validator validator;\n}\n</code></pre> <pre><code>import org.springframework.validation.Validator;\n\n@Service\npublic class MyService {\n\n    @Autowired\n    private Validator validator;\n}\n</code></pre>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#_1","title":"\u914d\u7f6e\u81ea\u5b9a\u4e49\u7684\u9a8c\u8bc1","text":"<p>\u6bcf\u4e2abean validation\u9a8c\u8bc1\u5305\u542b\u4e24\u90e8\u5206\uff1a</p> <ul> <li><code>@Constraint</code> \u6ce8\u89e3\uff0c\u7528\u6765\u58f0\u660e\u7ea6\u675f\u548c\u53ef\u914d\u7f6e\u7684\u5c5e\u6027</li> <li><code>javax.validation.ConstraintValidator</code> \u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\uff0c\u5177\u4f53\u7684\u9a8c\u8bc1\u884c\u4e3a\u3002</li> </ul> <p>To associate a declaration with an implementation, each <code>@Constraint</code> annotation references a corresponding <code>ConstraintValidator</code> implementation class. At runtime, a <code>ConstraintValidatorFactory</code> instantiates the referenced implementation when the constraint annotation is encountered in your domain model.</p> <p>By default, the <code>LocalValidatorFactoryBean</code> configures a <code>SpringConstraintValidatorFactory</code> that uses Spring to create <code>ConstraintValidator</code> instances. This lets your custom <code>ConstraintValidators</code> benefit from dependency injection like any other Spring bean.</p> <p>\u4e3a\u4e86\u5c06\u58f0\u660e\u548c\u5b9e\u73b0\u5173\u8054\u8d77\u6765\uff0c\u6bcf\u4e2a@Constraint\u6ce8\u89e3\u90fd\u4f1a\u5f15\u7528\u4e00\u4e2a\u5bf9\u5e94\u7684<code>ConstraintValidator</code> \u5b9e\u73b0\u7c7b\u3002\u5728\u8fd0\u884c\u65f6\uff0c\u5f53\u5728model\u5bf9\u8c61\u4e2d\u9047\u5230\u4f60\u5b9a\u4e49\u7684\u7ea6\u675f\u6ce8\u89e3\u65f6\uff0c<code>ConstraintValidatorFactory</code> \u5c31\u4f1a\u5b9e\u4f8b\u5316\u8fd9\u4e2avalidator\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c <code>LocalValidatorFactoryBean</code> \u914d\u7f6e\u4e86 <code>SpringConstraintValidatorFactory</code> \uff0c\u4f7f\u7528Spring\u6765\u521b\u5efa<code>ConstraintValidator</code>\u5b9e\u4f8b\u3002\u8fd9\u5141\u8bb8\u4f60\u81ea\u5b9a\u4e49\u7684<code>ConstraintValidators</code>\u50cf\u5176\u4ed6spring bean\u4e00\u6837\u53ef\u4ee5\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\u3002</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684@Constraint\u6ce8\u89e3\uff0c\u5b83\u5305\u542b\u4e00\u4e2a\u76f8\u5173\u7684ConstraintValidator\u5b9e\u73b0\uff0c\u5b83\u53ef\u4ee5\u4f7f\u7528Spring\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\u3002</p> <pre><code>@Target({ElementType.METHOD, ElementType.FIELD})\n@Retention(RetentionPolicy.RUNTIME)\n@Constraint(validatedBy=MyConstraintValidator.class) // \u5f15\u7528\u5177\u4f53\u7684\u9a8c\u8bc1\u5b9e\u73b0\npublic @interface MyConstraint {\n}\n\n\nimport javax.validation.ConstraintValidator;\npublic class MyConstraintValidator implements ConstraintValidator {\n\n    @Autowired; // \u53ef\u4ee5\u6ce8\u5165\u5176\u4ed6spring bean\uff0c\u8fdb\u884c\u4e1a\u52a1\u903b\u8f91\u65b9\u9762\u7684\u9a8c\u8bc1\n    private Foo aDependency;\n\n    // ...\n}\n</code></pre> <p>\u4e0b\u9762\u5217\u4e3e\u4e24\u4e2a\u5f00\u53d1\u4e2d\u4f7f\u7528\u7684\u6848\u4f8b\uff1a</p> <p>\u7279\u6b8a\u5b57\u7b26\u7684\u6821\u9a8c\uff1a</p> <pre><code>/**\n * \u7279\u6b8a\u5b57\u7b26\u6ce8\u89e3\n *\n */\n@Target({ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE, ElementType.PARAMETER, ElementType.TYPE_USE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Constraint(validatedBy = {SpecialCharacterCustomerValidator.class})\npublic @interface SpecialCharacter {\n\n    /**\n     * \u9ed8\u8ba4\u63d0\u793a\u4e3a input.string.special.charactor\uff0c \u4e2d\u6587\u53ef\u5b9a\u4f4d\u4e3a\u201c\u53c2\u6570\u4e2d\u5305\u542b\u4e86\u7279\u6b8a\u5b57\u7b26\u201d\n     */\n    String message() default \"input.string.special.character\";\n\n    Class&lt;?&gt;[] groups() default {};\n\n    Class&lt;? extends Payload&gt;[] payload() default {};\n\n    String pattern() default \"[\\\\\\\\/:*?\\\"&lt;|'&gt;]\";\n}\n\n\n/**\n * \u7279\u6b8a\u5b57\u7b26\u6821\u9a8c\n *\n */\npublic class SpecialCharacterCustomerValidator implements ConstraintValidator&lt;SpecialCharacter, String&gt; {\n    private String pattern = \"\";\n\n    @Override\n    public void initialize(SpecialCharacter constraintAnnotation) {\n        pattern = constraintAnnotation.pattern();\n    }\n\n\n    /**\n     * @param value\n     * @param context\n     * @return true \u4e0d\u542b\u7279\u6b8a\u5b57\u7b26  false \u542b\u7279\u6b8a\u5b57\u7b26\n     */\n    @Override\n    public boolean isValid(String value, ConstraintValidatorContext context) {\n        boolean result = true;\n        if (StringUtils.isNotEmpty(value)) {\n            Pattern p = Pattern.compile(pattern);\n            Matcher m = p.matcher(value);\n            result = !m.find();\n        }\n        return result;\n    }\n}\n</code></pre> <p>\u679a\u4e3e\u7c7b\u7684\u6821\u9a8c\uff1a</p> <pre><code>import com.jun.sail.sailvalidate.validater.EnumCheckValidator;\n\nimport javax.validation.Constraint;\nimport javax.validation.Payload;\nimport java.lang.annotation.ElementType;\nimport java.lang.annotation.Retention;\nimport java.lang.annotation.RetentionPolicy;\nimport java.lang.annotation.Target;\n\n@Target({ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Constraint(validatedBy = EnumCheckValidator.class)\npublic @interface EnumCheck {\n\n        /**\n         * \u662f\u5426\u5fc5\u586b \u9ed8\u8ba4\u662f\u5fc5\u586b\u7684\n         */\n        boolean required() default true;\n\n        /**\n         * \u9a8c\u8bc1\u5931\u8d25\u7684\u6d88\u606f\n         */\n        String message() default \"\u679a\u4e3e\u9a8c\u8bc1\u5931\u8d25\";\n\n        /**\n         * \u5206\u7ec4\u7684\u5185\u5bb9\n         */\n        Class&lt;?&gt;[] groups() default {};\n\n        /**\n         * \u9519\u8bef\u9a8c\u8bc1\u7684\u7ea7\u522b\n         */\n        Class&lt;? extends Payload&gt;[] payload() default {};\n\n        /**\n         * \u679a\u4e3e\u7684Class\n         */\n        Class&lt;? extends Enum&lt;?&gt;&gt; enumClass();\n\n        /**\n         * \u679a\u4e3e\u4e2d\u7684\u9a8c\u8bc1\u65b9\u6cd5\uff0c\u4e5f\u5c31\u662f\u679a\u4e3e\u7c7b\u4e2d\u5fc5\u987b\u5b58\u5728validation()\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u81ea\u5b9a\u4e49\n         */\n        String enumMethod() default \"validation\";\n}\n\n\n/**\n * \u81ea\u5b9a\u4e49\u7684\u679a\u4e3e\u9a8c\u8bc1\u5668\uff0c\n *\n */\npublic class EnumCheckValidator implements ConstraintValidator&lt;EnumCheck, Object&gt; {\n\n    private static final Logger logger = LoggerFactory.getLogger(EnumCheckValidator.class);\n\n    private EnumCheck enumCheck;\n\n    @Override\n    public void initialize(EnumCheck enumCheck) {\n        this.enumCheck =enumCheck;\n    }\n\n    @Override\n    public boolean isValid(Object value, ConstraintValidatorContext constraintValidatorContext) {\n        // \u6ce8\u89e3\u8868\u660e\u4e3a\u5fc5\u9009\u9879 \u5219\u4e0d\u5141\u8bb8\u4e3a\u7a7a\uff0c\u5426\u5219\u53ef\u4ee5\u4e3a\u7a7a\n        if (value == null) {\n            return !this.enumCheck.required();\n        }\n\n        Boolean result = Boolean.FALSE;\n        Class&lt;?&gt; valueClass = value.getClass();\n        try {\n            //\u901a\u8fc7\u53cd\u5c04\u6267\u884c\u679a\u4e3e\u7c7b\u4e2d\u7684\u6821\u9a8c\u65b9\u6cd5\n            Method method = this.enumCheck.enumClass().getMethod(this.enumCheck.enumMethod(), valueClass);\n            result = (Boolean)method.invoke(null, value);\n            if(result == null){\n                return false;\n            }\n        } catch (Exception e) {\n            logger.error(\"custom EnumCheckValidator error\", e);\n        }\n        return result;\n    }\n}\n</code></pre>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#spring-driven-method-validation","title":"Spring-driven Method Validation","text":"<p>You can integrate the method validation feature supported by Bean Validation 1.1 (and, as a custom extension, also by Hibernate Validator 4.3) into a Spring context through a <code>MethodValidationPostProcessor</code> bean definition:</p> <p>\u60a8\u53ef\u4ee5\u901a\u8fc7MethodValidationPostProcessor Bean\u5b9a\u4e49\u5c06Bean Validation 1.1\u652f\u6301\u7684\u65b9\u6cd5\u9a8c\u8bc1\u529f\u80fd\u96c6\u6210\u5230Spring\u4e0a\u4e0b\u6587\u4e2d\uff08\u4f5c\u4e3a\u81ea\u5b9a\u4e49\u6269\u5c55\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7Hibernate Validator 4.3\uff09\u3002</p> <pre><code>import org.springframework.validation.beanvalidation.MethodValidationPostProcessor;\n\n@Configuration\npublic class AppConfig {\n\n    @Bean\n    public MethodValidationPostProcessor validationPostProcessor() {\n        return new MethodValidationPostProcessor();\n    }\n}\n</code></pre> <p>To be eligible for Spring-driven method validation, all target classes need to be annotated with Spring\u2019s <code>@Validated</code> annotation, which can optionally also declare the validation groups to use. See <code>MethodValidationPostProcessor</code> for setup details with the Hibernate Validator and Bean Validation 1.1 providers.</p> <p>Method validation relies on AOP Proxies around the target classes, either JDK dynamic proxies for methods on interfaces or CGLIB proxies. There are certain limitations with the use of proxies, some of which are described in Understanding AOP Proxies. In addition remember to always use methods and accessors on proxied classes; direct field access will not work.</p> <p>\u4e3a\u4e86\u7b26\u5408Spring\u9a71\u52a8\u7684\u65b9\u6cd5\u9a8c\u8bc1\u7684\u6761\u4ef6\uff0c\u6240\u6709\u7684\u76ee\u6807\u7c7b\u90fd\u9700\u8981\u7528Spring\u7684@Validated\u6ce8\u89e3\uff0c\u5b83\u8fd8\u53ef\u4ee5\u9009\u62e9\u6027\u5730\u58f0\u660e\u8981\u4f7f\u7528\u7684\u9a8c\u8bc1\u7ec4\u3002\u8bf7\u53c2\u9605<code>MethodValidationPostProcessor</code>\uff0c\u4e86\u89e3\u4e0eHibernate Validator\u548cBean Validation 1.1 providers\u7684\u8bbe\u7f6e\u7ec6\u8282\u3002 \u65b9\u6cd5\u9a8c\u8bc1\u4f9d\u8d56\u4e8e\u76ee\u6807\u7c7b\u7684AOP\u4ee3\u7406\uff0c\u53ef\u4ee5\u662f\u63a5\u53e3\u4e2d\u65b9\u6cd5\u7684JDK\u52a8\u6001\u4ee3\u7406\uff0c\u4e5f\u53ef\u4ee5\u662fCGLIB\u4ee3\u7406\u3002\u4f7f\u7528\u4ee3\u7406\u6709\u4e00\u5b9a\u7684\u9650\u5236\uff0c\u5176\u4e2d\u4e00\u4e9b\u9650\u5236\u5728\u7406\u89e3AOP\u4ee3\u7406\u4e2d\u6709\u6240\u63cf\u8ff0\u3002\u53e6\u5916\u8bb0\u5f97\u4e00\u5b9a\u8981\u4f7f\u7528\u4ee3\u7406\u7c7b\u7684\u65b9\u6cd5\u548c\u8bbf\u95ee\u5668\uff0c\u76f4\u63a5\u8bbf\u95ee\u5b57\u6bb5\u662f\u4e0d\u884c\u7684\u3002</p>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#_2","title":"\u5176\u4ed6\u914d\u7f6e\u9009\u9879","text":"<p>The default <code>LocalValidatorFactoryBean</code> configuration suffices for most cases. There are a number of configuration options for various Bean Validation constructs, from message interpolation to traversal resolution. See the <code>LocalValidatorFactoryBean</code> javadoc for more information on these options.</p> <p>\u9ed8\u8ba4\u7684 \"LocalValidatorFactoryBean \"\u914d\u7f6e\u8db3\u4ee5\u6ee1\u8db3\u5927\u591a\u6570\u60c5\u51b5\uff0c\u66f4\u591a\u914d\u7f6e\u4fe1\u606f\u67e5\u770b <code>LocalValidatorFactoryBean</code> \u3002</p>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#373-databinder","title":"3.7.3 \u914d\u7f6e<code>DataBinder</code>","text":"<p>\u4eceSpring 3 \u5f00\u59cb\uff0c\u53ef\u4ee5\u4e3a<code>DataBinder</code>\u914d\u7f6eValidator\u3002\u914d\u7f6e\u540e\uff0c\u5c31\u53ef\u4ee5\u8c03\u7528 <code>binder.validate()</code>.\u8fdb\u884c\u6821\u9a8c\u3002\u4efb\u4f55\u6821\u9a8c\u9519\u8befErrors\u4f1a\u81ea\u52a8\u6dfb\u52a0\u5230BindingResult\u3002</p> <p>\u4e0b\u9762\u5c55\u793a\u5982\u4f55\u4f7f\u7528<code>DataBinder</code>\u7f16\u7a0b\u5728\u7ed1\u5b9a\u76ee\u6807\u5bf9\u8c61\u540e\u8fdb\u884c\u6821\u9a8c\u903b\u8f91</p> <pre><code>Foo target = new Foo();\nDataBinder binder = new DataBinder(target);\nbinder.setValidator(new FooValidator());\n\n// bind to the target object\nbinder.bind(propertyValues);\n\n// validate the target object\nbinder.validate();\n\n// get BindingResult that includes any validation errors\nBindingResult results = binder.getBindingResult();\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4e3a<code>DataBinder</code>\u914d\u7f6e\u591a\u4e2a <code>Validator</code> \u5b9e\u4f8b\uff0c\u901a\u8fc7 <code>dataBinder.addValidators</code> and <code>dataBinder.replaceValidators</code>\u3002This is useful when combining globally configured bean validation with a Spring <code>Validator</code> configured locally on a DataBinder instance. See Spring MVC Validation Configuration.</p>"},{"location":"java/spring/spring/Validation-DataBinding-Type-Conversion/#374-spring-mvc-3-validation","title":"3.7.4 spring-mvc 3 Validation","text":"<p>See Validation in the Spring MVC chapter.</p>"},{"location":"java/spring/spring/spring-AOP/","title":"spring AOP","text":"<p>Aspect-oriented Programming (AOP) \u662f\u9762\u5411\u5bf9\u8c61Object-oriented Programming (OOP) \u7684\u8865\u5145\uff0c\u5b83\u63d0\u4f9b\u4e86\u53e6\u4e00\u79cd\u601d\u8003\u7a0b\u5e8f\u7ed3\u6784\u7684\u65b9\u5f0f\u3002\u5728OOP\u4e2d\uff0c\u6a21\u5757\u5316\u7684\u5173\u952e\u662fclass\uff0c\u5728AOP\u4e2d\u6a21\u5757\u5316\u7684\u5355\u4f4d\u662fAspect\u5207\u9762\u3002\u5207\u9762\u53ef\u4ee5\u8de8\u8d8a\u591a\u79cd\u7c7b\u578b\u548c\u5bf9\u8c61\uff08\u5982\u4e8b\u52a1\u7ba1\u7406\uff09\u3002</p> <p>spring\u7684\u5173\u952e\u7ec4\u4ef6\u662fAOP\u3002\u867d\u7136IOC\u5bb9\u5668\u4e0d\u4f9d\u8d56AOP\uff08\u8fd9\u610f\u5473\u7740\u4f60\u5982\u679c\u4e0d\u60f3\u4f7f\u7528AOP,\u53ef\u4ee5\u53bb\u9664\uff09\uff0c\u4f46AOP\u5bf9IOC\u505a\u4e86\u8865\u5145\uff0c\u63d0\u4f9b\u4e86\u975e\u5e38\u6709\u529b\u7684\u4e2d\u95f4\u89e3\u51b3\u65b9\u6848\u3002</p> <p>spring\u63d0\u4f9b\u4e86\u57fa\u4e8eXML\u548c@Aspect J\u7684\u65b9\u5f0f\u6765\u81ea\u5b9a\u4e49\u5207\u9762\uff0c\u4ecd\u7136\u4f7f\u7528AOP\u8fdb\u884c\u7ec7\u5165\u3002</p> <p>spring AOP\u5728spring\u6846\u67b6\u4e2d\u7528\u6765\uff1a</p> <ul> <li>\u63d0\u4f9b\u58f0\u660e\u5f0f\u7684\u4f01\u4e1a\u670d\u52a1\uff0c\u6700\u5178\u578b\u7684\u83ab\u8fc7\u4e8e\u58f0\u660e\u5f0f\u4e8b\u52a1</li> <li>\u8ba9\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5207\u9762\uff0c\u5229\u7528AOP\u5b8c\u5584OOP\u7f16\u7a0b</li> </ul>"},{"location":"java/spring/spring/spring-AOP/#51-aop","title":"5.1 AOP\u6982\u5ff5","text":"<p>\u6211\u4eec\u5148\u6765\u5b9a\u4e49AOP\u7684\u4e00\u4e9b\u6982\u5ff5\u548c\u672f\u8bed\u3002\u8fd9\u4e9b\u672f\u8bed\u4e0d\u662fspring\u7279\u6709\u7684\u3002\u4e0d\u5e78\u7684\u662f\uff0cAOP\u672f\u8bed\u4e0d\u662f\u7279\u522b\u76f4\u89c2\uff0c\u7136\u800c\u5982\u679cspring\u4f7f\u7528\u81ea\u5df1\u7684\u672f\u8bed\u4f1a\u66f4\u52a0\u4ee4\u4eba\u56f0\u60d1\u3002</p> <ul> <li>Aspect: A modularization of a concern that cuts across multiple classes. Transaction management is a good example of a crosscutting concern in enterprise Java applications. In Spring AOP, aspects are implemented by using regular classes (the schema-based approach) or regular classes annotated with the <code>@Aspect</code> annotation (the @AspectJ style).</li> <li>Join point: A point during the execution of a program, such as the execution of a method or the handling of an exception. In Spring AOP, a join point always represents a method execution.</li> <li>Advice: Action taken by an aspect at a particular join point. Different types of advice include \u201caround\u201d, \u201cbefore\u201d and \u201cafter\u201d advice. (Advice types are discussed later.) Many AOP frameworks, including Spring, model an advice as an interceptor and maintain a chain of interceptors around the join point.</li> <li>Pointcut: A predicate that matches join points. Advice is associated with a pointcut expression and runs at any join point matched by the pointcut (for example, the execution of a method with a certain name). The concept of join points as matched by pointcut expressions is central to AOP, and Spring uses the AspectJ pointcut expression language by default.</li> <li>Introduction: Declaring additional methods or fields on behalf of a type. Spring AOP lets you introduce new interfaces (and a corresponding implementation) to any advised object. For example, you could use an introduction to make a bean implement an <code>IsModified</code> interface, to simplify caching. (An introduction is known as an inter-type declaration in the AspectJ community.)</li> <li>Target object: An object being advised by one or more aspects. Also referred to as the \u201cadvised object\u201d. Since Spring AOP is implemented by using runtime proxies, this object is always a proxied object.</li> <li>AOP proxy: An object created by the AOP framework in order to implement the aspect contracts (advise method executions and so on). In the Spring Framework, an AOP proxy is a JDK dynamic proxy or a CGLIB proxy.</li> <li>Weaving: linking aspects with other application types or objects to create an advised object. This can be done at compile time (using the AspectJ compiler, for example), load time, or at runtime. Spring AOP, like other pure Java AOP frameworks, performs weaving at runtime.</li> </ul> <ul> <li>Aspect : \u6a2a\u8de8\u591a\u4e2a\u7c7b\u7684\u5207\u9762\u3002\u4e8b\u52a1\u7ba1\u7406\u662f\u6700\u597d\u7684\u4f8b\u5b50\u3002\u5728spring AOP\u4e2d\uff0caspect\u53ef\u4ee5\u901a\u8fc7xml\u6216\u8005@Aspect\u7684\u5f62\u5f0f\u6307\u5b9a\u4e00\u4e9b\u7279\u5b9a\u7684\u7c7b\u3002</li> <li>Join point\uff1a\u7a0b\u5e8f\u6267\u884c\u7684\u4e00\u4e2a\u70b9\uff0c\u4f8b\u5982\u4e00\u4e2a\u65b9\u6cd5\u7684\u6267\u884c\u6216\u8005\u4e00\u4e2a\u5f02\u5e38\u7684\u6355\u83b7\u3002\u5728spring AOP\u4e2d\uff0cjoin point\u4e00\u822c\u8868\u793a\u4e00\u4e2a\u65b9\u6cd5\u7684\u6267\u884c\u3002</li> <li>Advice: \u5728\u7279\u5b9a\u8fde\u63a5\u70b9\u6267\u884c\u7684\u52a8\u4f5c\u3002\u6709\u591a\u79cd\u4e0d\u540c\u7684\u5efa\u8bae\uff0c\u5982around\uff0cbefore\uff0cafter(\u7a0d\u540e\u8ba8\u8bbaadvice)\u3002\u8bb8\u591aAOP\u6846\u67b6\uff0c\u5305\u62ecspring\uff0c\u5c06\u5efa\u8bae\u5efa\u6a21\u4e3a\u4e00\u4e2a\u62e6\u622a\u5668\uff0c\u5e76\u56f4\u7ed5joint point\u4fdd\u7559\u4e00\u4e2a\u62e6\u622a\u5668\u94fe\u3002</li> <li>Pointcut: \u8868\u793a\u5339\u914d\u6240\u6709Join point\u7684\u65ad\u8a00\u3002advice\u603b\u662f\u5173\u8054pointcut\u8868\u8fbe\u5f0f\uff0c\u5e76\u4e14\u5728\u6240\u6709\u5339\u914d\u5230\u7684joint point\u5904\u6267\u884c\uff08\u4f8b\u5982\u6267\u884c\u540d\u5b57\u65b9\u6cd5\u7684\u6267\u884c\uff09\u3002\u88abpointcut\u5339\u914d\u5230\u7684joint points\u662fAOP\u7684\u6838\u5fc3\u6982\u5ff5\uff0cspring\u9ed8\u8ba4\u4f7f\u7528Aspect J\u7684pointcut\u8bed\u6cd5\u8868\u8fbe\u5f0f</li> <li>Introduction: \u5728\u7c7b\u578b\u751f\u547d\u4e00\u4e2a\u9644\u52a0\u7684\u65b9\u6cd5\u6216\u8005\u5b57\u6bb5\u3002spring AOP\u5141\u8bb8\u4f60\u5411\u4efb\u4f55\u88ab\u4ee3\u7406\u7684\u5bf9\u8c61\u5f15\u5165\u4e00\u4e2a\u65b0\u7684\u63a5\u53e3\uff08\u548c\u5bf9\u5e94\u7684\u5b9e\u73b0\uff09\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u7528Introduction\u5b9e\u73b0\u4e00\u4e2a\u5b9e\u73b0IsModifued\u63a5\u53e3\u7684bean\uff0c\u6765\u7b80\u5316\u7f13\u5b58\u3002\uff08\u5728Aspect J\u793e\u533a\uff0cIntroduction\u88ab\u79f0\u4e3ainter-type\u58f0\u660e\uff09</li> <li>Target object: \u88ab\u4e00\u4e2a\u6216\u591a\u4e2a\u5207\u9762\u4ee3\u7406\u7684\u5bf9\u8c61\u3002\u4e5f\u88ab\u79f0\u4e3aadvised object\u3002\u56e0\u4e3aspring AOP\u662f\u901a\u8fc7\u8fd0\u884c\u65f6\u4ee3\u7406\u6765\u5b9e\u73b0\u7684\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5bf9\u8c61\u603b\u662f\u4e00\u4e2a\u88ab\u4ee3\u7406\u7684\u5bf9\u8c61\u3002</li> <li>AOP proxy\uff1a\u88abAOP\u6846\u67b6\u751f\u6210\u7684\u5bf9\u8c61\uff0c\u5728spring\u4e2d\uff0cAOP proxy\u662f\u4e00\u4e2aJDK\u52a8\u6001\u4ee3\u7406\u6216\u8005CGLIB\u4ee3\u7406</li> <li>Weaving\u7ec7\u5165: \u8fde\u63a5aspects\u548c\u5176\u4ed6\u5e94\u7528\u6216\u8005\u88ab\u521b\u5efa\u7684\u5bf9\u8c61\u3002\u8fd9\u4e2a\u53ef\u4ee5\u5728\u7f16\u8bd1\u65f6\uff08\u4f8b\u5982Aspect J\u7f16\u8bd1\u5668\uff09\uff0c\u52a0\u8f7d\u65f6\uff0c\u6216\u8005\u8fd0\u884c\u65f6\u3002spring AOP\u662f\u5728\u8fd0\u884c\u65f6\u8fdb\u884c\u7ec7\u5165\u3002</li> </ul> <p>Spring AOP \u5305\u542b\u4ee5\u4e0b\u7c7b\u578b\u7684Advice:</p> <ul> <li>Before advice: Advice that runs before a join point but that does not have the ability to prevent execution flow proceeding to the join point (unless it throws an exception).</li> <li>After returning advice: Advice to be run after a join point completes normally (for example, if a method returns without throwing an exception).</li> <li>After throwing advice: Advice to be run if a method exits by throwing an exception.</li> <li>After (finally) advice: Advice to be run regardless of the means by which a join point exits (normal or exceptional return).</li> <li>Around advice: Advice that surrounds a join point such as a method invocation. This is the most powerful kind of advice. Around advice can perform custom behavior before and after the method invocation. It is also responsible for choosing whether to proceed to the join point or to shortcut the advised method execution by returning its own return value or throwing an exception.</li> </ul> <p>around advice\u662f\u6700\u901a\u7528\u7684\u4e00\u79cd\u5efa\u8bae\u3002\u7531\u4e8espring AOP\u548cAspect J\u4e00\u6837\uff0c\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684advice\u7c7b\u578b\uff0c\u6211\u4eec\u5efa\u8bae\u5c3d\u91cf\u4f7f\u7528\u6700\u5c0f\u6743\u9650\u7684advice\u7c7b\u578b\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u53ea\u9700\u8981\u901a\u8fc7\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u6765\u66f4\u65b0\u7f13\u5b58\uff0c\u4f60\u6700\u597d\u4f7f\u7528after returning advice\u800c\u4e0d\u662faround advice\uff0c\u5c3d\u7ba1around advice\u4e5f\u53ef\u4ee5\u5b8c\u6210\u540c\u6837\u7684\u4e8b\u60c5\u3002\u4f7f\u7528\u7279\u522b\u6307\u5b9a\u7684advice\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u66f4\u7b80\u5355\u7684\u7f16\u7a0b\u6a21\u578b\uff0c\u51fa\u9519\u7684\u673a\u4f1a\u66f4\u5c0f\u3002\u4f8b\u5982\uff0c\u4f60\u4e0d\u9700\u8981\u5728around advice\u4e2d\u8c03\u7528<code>proceed()</code>\u65b9\u6cd5\uff0c\u56e0\u6b64\u4f60\u4e0d\u80fd\u4e0d\u8c03\u7528\u5b83\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#52-spring-aop","title":"5.2 spring AOP\u7684\u80fd\u529b\u548c\u76ee\u6807","text":"<p>spring AOP\u662f\u7eafjava\u5b9e\u73b0\u7684\uff0c\u4e0d\u9700\u8981\u7279\u522b\u7684\u7f16\u8bd1\u8fc7\u7a0b\u3002spring AOP\u4e0d\u9700\u8981\u63a7\u5236\u7c7b\u7684\u52a0\u8f7d\uff0c\u56e0\u6b64\u7279\u522b\u9002\u7528\u4e8eservlet\u5bb9\u5668\u6216\u5e94\u7528\u670d\u52a1\u3002</p> <p>spring AOP\u76ee\u524d\u53ea\u652f\u6301\u65b9\u6cd5\u7ea7\u522b\uff08\u5efa\u8bae\u5728spring bean\u4e2d\u7684\u65b9\u6cd5\uff09\u3002\u5b57\u6bb5\u7684\u62e6\u622a\u6ca1\u6709\u5b9e\u73b0\uff0c\u5c3d\u7ba1\u53ef\u4ee5\u5b9e\u73b0\u3002\u5982\u679c\u4f60\u9700\u8981\u5b57\u6bb5\u7684advice\u548c\u66f4\u65b0joint points\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528AspectJ\u3002</p> <p>spring\u5b9e\u73b0AOP\u7684\u65b9\u5f0f\u4e0d\u540c\u4e8e\u5176\u4ed6\u5927\u591a\u6570AOP\u6846\u67b6\u3002\u5176\u76ee\u7684\u4e0d\u662f\u63d0\u4f9b\u6700\u5b8c\u6574\u7684AOP\u5b9e\u73b0\uff08\u5c3d\u7ba1spring AOP\u633a\u5f3a\u7684\uff09,\u800c\u662f\u4e3a\u4e86\u63d0\u4f9bAOP\u548cIOC\u5bb9\u5668\u4e4b\u95f4\u7684\u7d27\u5bc6\u7ed3\u5408\uff0c\u4ee5\u89e3\u51b3\u4f01\u4e1a\u5f00\u53d1\u4e2d\u7684\u5e38\u89c1\u95ee\u9898\u3002</p> <p>\u56e0\u6b64\uff0cspring AOP\u529f\u80fd\u901a\u5e38\u548cIOC\u5bb9\u5668\u7ed3\u5408\u4f7f\u7528\u3002\u901a\u8fc7\u4f7f\u7528\u666e\u901a\u7684bean\u5b9a\u4e49\u8bed\u6cd5(\u5c3d\u7ba1\u5141\u8bb8\u5f3a\u5927\u7684\u81ea\u52a8\u4ee3\u7406)\u6765\u914d\u7f6eAspectJ\uff0c\u8fd9\u662f\u4e0e\u5176\u4ed6AOP\u6846\u67b6\u7684\u5173\u952e\u533a\u522b\u3002\u4f60\u4e0d\u80fd\u4f7f\u7528spring AOP\u8f7b\u677e\u6216\u9ad8\u6548\u7684\u9488\u5bf9\u975e\u5e38\u7ec6\u7c92\u5ea6\u7684\u5bf9\u8c61\uff08\u5982\u5e38\u89c1\u7684DTO\u5bf9\u8c61\uff09\u5b9e\u73b0advice\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0bASpectJ\u662f\u6700\u597d\u7684\u9009\u62e9\u3002\u7136\u800c\uff0c\u6211\u4eec\u7684\u7ecf\u9a8c\u662f\uff0cspring AOP\u9488\u5bf9\u4f01\u4e1a\u5f00\u53d1\u7684\u5927\u591a\u6570\u95ee\u9898\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>spring AOP\u4ece\u6765\u6ca1\u6709\u52aa\u529b\u548cAspectJ\u7ade\u4e89\uff0c\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u5168\u9762\u7684AOP\u89e3\u51b3\u65b9\u6848\u3002\u6211\u4eec\u76f8\u4fe1spring AOP\u7684\u57fa\u4e8e\u4ee3\u7406\u7684\u6846\u67b6\u548c\u5b8c\u6574\u7684AOP\u6846\u67b6\uff08\u5982AspectJ)\u90fd\u662f\u6709\u4ef7\u503c\u7684\u3002\u4ed6\u4eec\u662f\u4e92\u8865\u7684\uff0c\u800c\u4e0d\u662f\u7ade\u4e89\u7684\u3002spring\u5c06AOP\u548cIOC\u5bb9\u5668\uff0cAspectJ\u8fdb\u884c\u4e86\u65e0\u7f1d\u96c6\u6210\uff0c\u53ef\u4ee5\u5728spring\u5e94\u7528\u4e2d\u5b9e\u73b0AOP\u7684\u6240\u6709\u529f\u80fd\uff0c\u8fd9\u79cd\u96c6\u6210\u4e0d\u4f1a\u5f71\u54cdspring AOP\u6216\u8005\u5176\u4ed6AOP\u6846\u67b6\u3002spring AOP\u4ecd\u7136\u5411\u540e\u517c\u5bb9\u3002</p> <p>\u9759\u6001AOP\u548c\u52a8\u6001AOP</p> <p>\u9759\u6001AOP\u901a\u8fc7\u7279\u5b9a\u7684\u7f16\u8bd1\u5668\u5c06Aspect\u7f16\u8bd1\u7ec7\u5165\u5230\u7cfb\u7edf\u7c7b\u4e2d\uff0c\u4e5f\u5c31\u662f\u5728\u7f16\u8bd1\u65f6\u671f\uff0c\u5c31\u4ee5\u5b57\u8282\u7801\u7684\u5f62\u5f0f\u7ec7\u5165\u5230\u76ee\u6807java\u7c7b\u4e2d\uff0c\u7ec7\u5165\u540e\u7684\u7c7b\u5c31\u662f\u666e\u901aJava\u7c7b\uff0c\u865a\u62df\u673a\u53ef\u4ee5\u50cf\u901a\u5e38\u4e00\u6837\u52a0\u8f7d\u8fd0\u884c\uff0c\u76f8\u6bd4\u8f83\u4e8e\u4e0b\u9762\u7684\u52a8\u6001\u4ee3\u7406\u4e0d\u4f1a\u6709\u4efb\u4f55\u7684\u6027\u80fd\u635f\u5931\u3002\u7f3a\u70b9\u5c31\u662f\u4e0d\u591f\u7075\u6d3b\uff0c\u5982\u679c\u8981\u6539\u53d8join point\uff0c\u9700\u8981\u91cd\u65b0\u4ee3\u7801\u7f16\u8bd1\u3002</p> <p>\u52a8\u6001AOP\u4e0d\u662f\u9884\u5148\u7f16\u8bd1\u5230\u76ee\u6807\u7c7b\u4e2d\uff0c\u7ec7\u5165\u8fc7\u7a0b\u5728\u7cfb\u7edf\u8fd0\u884c\u4e4b\u540e\uff0c\u4e5f\u5c31\u662f\u5728\u7c7b\u52a0\u8f7d\u6216\u8005\u8fd0\u884c\u65f6\u8fdb\u884c\u7ec7\u5165\u3002\u8fd9\u6837\u53ef\u4ee5\u6bd4\u8f83\u65b9\u4fbf\u66f4\u6539\u5207\u5165\u70b9\u548c\u7ec7\u5165\u903b\u8f91\uff0c\u7f3a\u70b9\u5c31\u662f\u5b58\u5728\u6027\u80fd\u635f\u5931\uff0c\u4f46\u968f\u7740\u53cd\u5c04\u548c\u5b57\u8282\u7801\u64cd\u4f5c\u6280\u672f\u7684\u53d1\u5c55\uff0c\u8fd9\u79cd\u6027\u80fd\u635f\u5931\u5b8c\u5168\u53ef\u4ee5\u63a5\u53d7\u3002</p> <p>Spring AOP\u548cAspectJ\u7684\u533a\u522b\uff1f</p> <p>AspectJ\u662f\u975e\u5e38\u5f3a\u5927\u7684AOP\u6846\u67b6\uff0c\u96b6\u5c5e\u4e8eEclipse\u57fa\u91d1\u4f1a\uff0c\u5b98\u7f51\u5730\u5740\u662f<code>http://www.eclipse.org/aspectj/</code>\u3002\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u96c6\u6210\u5230\u5176\u4ed6\u6846\u67b6\u4e2d\u3002\u5b83\u652f\u6301\u7f16\u8bd1\u65f6\u7ec7\u5982\uff0c\u7f16\u8bd1\u540e\u7ec7\u5982\uff08\u4f46\u662f\u9700\u8981\u4f7f\u7528ajc\u7f16\u8f91\u5668\uff09\uff0c\u52a0\u8f7d\u65f6\u7ec7\u5982\u3002\u6ce8\u610f\u5b83\u662f\u7ec7\u5165\uff0c\u5b83\u662f\u5c06\u5207\u9762\u4ee3\u7801\u5d4c\u5165\u5230\u88ab\u4ee3\u7406\u7684\u4e1a\u52a1\u7c7b\uff0c\u8fd9\u662f\u548cspring\u91cd\u8981\u7684\u533a\u522b\u3002</p> <p>AspectJ\u652f\u6301\u5b57\u6bb5\uff0c\u65b9\u6cd5\uff0c\u6784\u9020\u51fd\u6570\u7b49\u7b49\u7684\u7ec7\u5165\uff0c\u800cspring\u4ec5\u652f\u6301\u65b9\u6cd5\u7684\u7ec7\u5165\u3002</p> <p>\u5e38\u7528\u7684\u8fd9\u4e9b\u6ce8\u89e3\u5c31\u662faspectJ\u4e2d\u7684:</p> <p></p> <p>spring AOP\u4e5f\u662f\u4e00\u4e2aAOP\u6846\u67b6\uff0c\u5b83\u662f\u57fa\u4e8e\u52a8\u6001\u4ee3\u7406\u7684\uff0c\u6709\u57fa\u4e8eJDK\u548c\u57fa\u4e8ecgLib\u4e24\u79cd\u65b9\u5f0f\uff0c\u5b83\u9700\u8981\u4f9d\u8d56spring\u5bb9\u5668\u6765\u7ba1\u7406\uff0c\u901a\u8fc7\u4ee3\u7406\u7c7b\u6765\u4f5c\u7528\u3002\u57fa\u672c\u6ee1\u8db3\u5f00\u53d1\u4e2d80%\u7684\u9700\u8981\uff0c\u4f46\u6027\u80fd\u4e0d\u5982Aspect J\u3002</p> <p>spring\u4e5f\u96c6\u6210\u4e86Aspect J\uff0c\u5982\u4e0a\u56fe\u4e2d\u7684\u7528\u6cd5\u3002\u4f46\u662f\u6ce8\u610fspring\u8fd8\u662f\u901a\u8fc7\u4ee3\u7406\u7c7b\u7684\u65b9\u5f0f\uff0c\u6240\u4ee5\u4e5f\u9020\u6210\u540c\u7c7b\u4e2d\u8c03\u7528AOP\u5931\u6548\u7684\u95ee\u9898\u3002</p> <p>spring AOP\u548cAspectJ\u7684\u533a\u522b</p> <p>AspectJ\u7684\u65b9\u6cd5</p>"},{"location":"java/spring/spring/spring-AOP/#53-aop","title":"5.3 AOP \u4ee3\u7406","text":"<p>spring AOP\u9ed8\u8ba4\u4f7f\u7528JDK\u52a8\u6001\u4ee3\u7406\u3002\u8fd9\u7528\u4e8e\u63a5\u53e3\u7684\u4ee3\u7406</p> <p>spring AOP\u4e5f\u53ef\u4ee5\u4f7f\u7528CGLIB\u4ee3\u7406\uff0c\u8fd9\u7528\u4e8e\u6ca1\u6709\u63a5\u53e3\u7684\u4ee3\u7406\u7c7b\u3002\u9ed8\u8ba4\u7684\uff0c\u5982\u679c\u4e00\u4e2a\u4e1a\u52a1\u5bf9\u8c61\u6ca1\u6709\u5b9e\u73b0\u63a5\u53e3\u5c31\u4f7f\u7528CGLIB\u4ee3\u7406\u3002\u5982\u679c\u4e00\u4e2a\u7c7b\u5b9e\u73b0\u4e86\u591a\u4e2a\u63a5\u53e3\uff0c\u53ef\u4ee5\u5f3a\u5236\u4f7f\u7528CGLIB\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\uff08\u5e0c\u671b\u662f\u7f55\u89c1\u7684\uff09\u3002</p> <p>\u638c\u63e1spring AOP\u662f\u57fa\u4e8e\u4ee3\u7406\u7684\u975e\u5e38\u91cd\u8981\u3002\u66f4\u591a\u7ec6\u8282\u53c2\u8003 Understanding AOP Proxies\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#54-aspectj-support","title":"5.4 @AspectJ support","text":"<p>@AspectJ\u6307\u7684\u662f\u901a\u8fc7\u6ce8\u89e3\u6765\u58f0\u660e\u5207\u9762\u7684java\u98ce\u683c\u3002@AspectJ\u662f\u7531AspectJ\u9879\u76ee\u5f15\u5165\u7684\uff0c\u4f5c\u4e3aAspectJ 5\u7684\u4e00\u90e8\u5206\uff0cspring\u7ee7\u627f\u4e86\u76f8\u540c\u7684\u6ce8\u89e3\uff0c\u4f7f\u7528AspectJ\u7684\u4f9d\u8d56\u652f\u6301\u8fdb\u884cpointcut\u7684\u89e3\u6790\u548c\u5339\u914d\u3002\u4f46\u662fAOP\u4ecd\u7136\u662f\u7eaf\u7684spring AOP\uff0c\u5bf9AspectJ\u7684 compiler or weaver\u6ca1\u6709\u4efb\u4f55\u4f9d\u8d56\u3002</p> <p>\u4f7f\u7528AspectJ\u7684compiler or weaver\u53ef\u4ee5\u4f7f\u7528\u5176\u5b8c\u6574\u7684\u529f\u80fd\uff0c\u67e5\u770b5.10\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#541-aspectj","title":"5.4.1. \u5f00\u542f@AspectJ\u652f\u6301","text":"<p>\u8981\u5728spring\u4e2d\u4f7f\u7528@AspectJ\uff0c\u4f60\u9700\u8981\u5f00\u542fspring\u7684\u652f\u6301\u6765\u914d\u7f6e\u57fa\u4e8e@AspectJ\u548c\u81ea\u52a8\u4ee3\u7406\u7684spring AOP\u3002\u6240\u8c13\u81ea\u52a8\u4ee3\u7406\uff0c\u6307\u7684\u662f\u5982\u679cspring\u786e\u5b9a\u4e00\u4e2abean\u88ab\u4e00\u4e2a\u6216\u591a\u4e2aaspects\u5207\u9762\uff0c\u5b83\u4f1a\u81ea\u52a8\u4e3a\u8be5bean\u751f\u6210\u4e00\u4e2a\u4ee3\u7406\u7c7b\u6765\u62e6\u622a\u65b9\u6cd5\u8c03\u7528\uff0c\u786e\u4fdd\u5728\u8fd0\u884c\u65f6\u88abadvice\u4ee3\u7406\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7xml\u6216\u8005java\u914d\u7f6e\u7684\u65b9\u5f0f\u6765\u542f\u7528@AspectJ\u7684\u652f\u6301\u3002\u4e0d\u7ba1\u54ea\u79cd\uff0c\u4f60\u90fd\u9700\u8981\u786e\u4fddAspectJ\u7684aspectjweaver.jar\u4f9d\u8d56\u5728\u4f60\u7684classpath\u4e2d\u3002</p> <p>\u5982\u4f55\u5f00\u542f@AspectJ\u652f\u6301\u3002\uff08spring -boot-starter-aop\u96c6\u6210\u4e86\u8fd9\u4e2a\uff09</p> <pre><code>@Configuration\n@EnableAspectJAutoProxy\npublic class AppConfig {\n\n}\n</code></pre>"},{"location":"java/spring/spring/spring-AOP/#542","title":"5.4.2 \u58f0\u660e\u5207\u9762","text":"<p>\u4e0a\u9762\u5f00\u542f@Aspectj\u652f\u6301\u540e\uff0c\u4f60\u5e94\u7528\u4e0a\u4e0b\u6587\u4e2d\u4efb\u4f55\u88ab@Aspect\u6ce8\u89e3\u7684bean\u90fd\u4f1a\u88abspring\u63a2\u6d4b\u5230\uff0c\u7528\u6765\u914d\u7f6espring AOP\u3002\u5982\u4e0b\u4ee3\u7801\u6240\u793a\uff1a</p> <pre><code>import org.aspectj.lang.annotation.Aspect;\n\n@Aspect\npublic class NotVeryUsefulAspect {\n\n}\n</code></pre> <p>\u88ab@Aspect\u6807\u6ce8\u7684\u7c7b\uff0c\u548c\u5176\u4ed6\u7c7b\u4e00\u6837\u53ef\u4ee5\u62e5\u6709\u65b9\u6cd5\u548c\u5b57\u6bb5\u3002\u5b83\u4e5f\u53ef\u4ee5\u5305\u542bpointcut\uff0cadvice\u548cintroduction(inter-type)\u7684\u58f0\u660e\u3002</p> <p>Autodetecting aspects through component scanning</p> <p>You can register aspect classes as regular beans in your Spring XML configuration or autodetect them through classpath scanning\u2009\u2014\u2009the same as any other Spring-managed bean. However, note that the <code>@Aspect</code> annotation is not sufficient for autodetection in the classpath. For that purpose, you need to add a separate <code>@Component</code> annotation (or, alternatively, a custom stereotype annotation that qualifies, as per the rules of Spring\u2019s component scanner).</p> <p>\u6ce8\u610f\u8fd9\u4e2abean\u53ea\u88ab@Aspect\u6ce8\u89e3\u8fd8\u4e0d\u8db3\u4ee5\u88abspring\u63a2\u6d4b\u5230\uff0c\u8fd8\u9700\u8981\u6dfb\u52a0@Component\u6ce8\u89e3</p> <p>\u5728spring AOP\u4e2d\uff0caspects\u5207\u9762\u4e0d\u80fd\u518d\u88ab\u5176\u4ed6\u5207\u9762\u4ee3\u7406\u3002\u6807\u6ce8\u4e86@Aspect\u7684\u7c7b\u4e0d\u4f1a\u88ab\u81ea\u52a8\u4ee3\u7406\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#543-pointcut","title":"5.4.3. \u58f0\u660ePointcut","text":"<p>pointcuts\u51b3\u5b9a\u54ea\u4e9b\u662f\u5173\u5fc3\u7684join points\uff0c\u56e0\u6b64\u5141\u8bb8\u6211\u4eec\u63a7\u5236\u4f55\u65f6advice\u6267\u884c\u3002spring AOP\u53ea\u652f\u6301bean\u7684\u65b9\u6cd5\u7ea7\u522b\u7684join points\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u770b\u4f5cpointcut\u662f\u7528\u6765\u5339\u914dspring beans\u7684\u65b9\u6cd5\u3002\u4e00\u4e2apointcut\u58f0\u660e\u6709\u4e24\u90e8\u5206\uff1a\u4e00\u4e2a\u5305\u542bname\u548c\u4efb\u4f55\u53c2\u6570\u7684\u65b9\u6cd5\u7b7e\u540d\uff0c\u548c\u7528\u6765\u7cbe\u786e\u51b3\u5b9a\u54ea\u4e9b\u65b9\u6cd5\u6267\u884c\u8981\u88ab\u4ee3\u7406\u7684pointcut \u8868\u8fbe\u5f0f\u3002\u5728AOP\u7684@AspectJ\u6ce8\u89e3\u98ce\u683c\uff0cpointcut\u7b7e\u540d\u662f\u7531\u4e00\u4e2a\u666e\u901a\u65b9\u6cd5\u63d0\u4f9b\uff08\u8fd9\u4e2a\u65b9\u6cd5\u5fc5\u987b\u8fd4\u56de\u5fc5\u987b\u662fvoid\uff09\uff0c\u800cpointcut\u8868\u8fbe\u5f0f\u4f7f\u7528@pointcut\u6ce8\u89e3\u3002</p> <p>\u4e0b\u9762\u7528\u4e00\u4e2a\u4f8b\u5b50\u6765\u8bf4\u660epoint  signature \u548cpoint signature \u7684\u533a\u522b\uff1a</p> <pre><code>@Pointcut(\"execution(* transfer(..))\") // the pointcut expression\nprivate void anyOldTransfer() {} // the pointcut signature\n</code></pre> <p>\u4e0a\u9762@Pointcut\u6ce8\u89e3\u4e2d\u7684pointcut\u8868\u8fbe\u5f0f\u5c5e\u4e8e@AspectJ 5\u7684\u8bed\u6cd5\uff0c\u66f4\u5177\u4f53\u7684\u53ef\u4ee5\u770b AspectJ Programming Guide\uff0c AspectJ 5 Developer\u2019s Notebook\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#supported-pointcut-designators","title":"Supported Pointcut Designators","text":"<p>Spring AOP supports the following AspectJ pointcut designators (PCD) for use in pointcut expressions:</p> <ul> <li><code>execution</code>: For matching method execution join points. This is the primary pointcut designator to use when working with Spring AOP.</li> <li><code>within</code>: Limits matching to join points within certain types (the execution of a method declared within a matching type when using Spring AOP).</li> <li><code>this</code>: Limits matching to join points (the execution of methods when using Spring AOP) where the bean reference (Spring AOP proxy) is an instance of the given type.</li> <li><code>target</code>: Limits matching to join points (the execution of methods when using Spring AOP) where the target object (application object being proxied) is an instance of the given type.</li> <li><code>args</code>: Limits matching to join points (the execution of methods when using Spring AOP) where the arguments are instances of the given types.</li> <li><code>@target</code>: Limits matching to join points (the execution of methods when using Spring AOP) where the class of the executing object has an annotation of the given type.</li> <li><code>@args</code>: Limits matching to join points (the execution of methods when using Spring AOP) where the runtime type of the actual arguments passed have annotations of the given types.</li> <li><code>@within</code>: Limits matching to join points within types that have the given annotation (the execution of methods declared in types with the given annotation when using Spring AOP).</li> <li><code>@annotation</code>: Limits matching to join points where the subject of the join point (the method being run in Spring AOP) has the given annotation.</li> </ul> <p>spring AOP\u7684pointcut\u8868\u8fbe\u5f0f\u652f\u6301\u4e00\u4e0bpointcut\u8bed\u6cd5\uff1a</p> <ul> <li> <p><code>execution</code>\u7528\u6765\u5339\u914d\u6307\u5b9a\u65b9\u6cd5\u7b7e\u540d\u7684\u65b9\u6cd5\u7684joint point\u3002\u56e0\u4e3aspring AOP\u53ea\u652f\u6301\u65b9\u6cd5\u7ea7\u522b\u7684aspect\uff0c\u8fd9\u4e2a\u662f\u6700\u5e38\u7528\u7684\u3002</p> </li> <li> <p><code>within</code> \u5339\u914d\u5177\u6709\u7279\u5b9a\u7c7b\u578b\u7684join points\u3002\u4e5f\u5c31\u662f\u6307\u5b9a\u7c7b\u58f0\u660e\u7684\u6240\u6709\u65b9\u6cd5\u3002@Pointcut(\"within(common.job.BaseJob+)</p> </li> <li> <p><code>this</code> AOP\u4ee3\u7406\u7c7b\u662f\u7ed9\u5b9a\u7c7b\u578b\u7684\u5b9e\u4f8b</p> </li> <li> <p>target \u88ab\u4ee3\u7406\u7684\u5bf9\u8c61\u662f\u7ed9\u5b9a\u7c7b\u578b\u7684\u5b9e\u4f8b</p> </li> <li> <p>args\uff1a\u65b9\u6cd5\u53c2\u6570\u662f\u7ed9\u5b9a\u7c7b\u578b\u7684\u5b9e\u4f8b</p> </li> <li> <p><code>@target</code>\u88ab\u4ee3\u7406\u7684\u5bf9\u8c61\u5fc5\u987b\u6709\u7ed9\u5b9a\u7c7b\u578b\u7684\u6ce8\u89e3</p> </li> <li> <p><code>@args</code> \u8fd0\u884c\u65f6\u53c2\u6570\u5fc5\u987b\u6709\u7ed9\u5b9a\u7684\u6ce8\u89e3</p> </li> <li> <p><code>@within</code>\u6709\u6307\u5b9a\u6ce8\u89e3\u7684\u7c7b\u4e2d\u7684\u65b9\u6cd5</p> </li> <li> <p><code>@annotation</code> \u6307\u5b9a\u7684\u8fd0\u884c\u4e2d\u7684\u65b9\u6cd5\u5fc5\u987b\u6709\u7ed9\u5b9a\u7684\u6ce8\u89e3\uff0c\u6bd4\u5982@Transaction\u5c31\u5e94\u8be5\u4f7f\u7528\u7684\u8fd9\u4e2a</p> </li> </ul> <p>\u6ce8\u610f\uff1a@\u5f00\u5934\u7684\u8868\u8fbe\u5f0f\u90fd\u53ea\u63a5\u53d7\u6ce8\u89e3\u7c7b\u578b\u7684\u53c2\u6570\u3002</p> <p>Other pointcut types</p> <p>The full AspectJ pointcut language supports additional pointcut designators that are not supported in Spring: <code>call</code>, <code>get</code>, <code>set</code>, <code>preinitialization</code>, <code>staticinitialization</code>, <code>initialization</code>, <code>handler</code>, <code>adviceexecution</code>, <code>withincode</code>, <code>cflow</code>, <code>cflowbelow</code>, <code>if</code>, <code>@this</code>, and <code>@withincode</code>. Use of these pointcut designators in pointcut expressions interpreted by Spring AOP results in an <code>IllegalArgumentException</code> being thrown.</p> <p>The set of pointcut designators supported by Spring AOP may be extended in future releases to support more of the AspectJ pointcut designators.</p> <p>AspectJ\u6709\u4e00\u4e9b\u5176\u4ed6\u7c7b\u578b\u7684pointcuts\u8bed\u6cd5\uff0cspring AOP\u5e76\u4e0d\u652f\u6301\uff0c\u4f1a\u629b\u51fa<code>IllegalArgumentException</code> \u5f02\u5e38\u3002\u5c06\u6765\u53ef\u80fd\u4f1a\u589e\u52a0\u652f\u6301\u7684\u7c7b\u578b\u3002</p> <p>\u7531\u4e8espring AOP\u652f\u6301\u65b9\u6cd5\u7ea7\u522b\u7684join points\uff0c\u524d\u9762\u5173\u4e8epointcut\u7684\u8ba8\u8bba\u90fd\u6bd4AspectJ\u7f16\u7a0b\u6307\u5357\u4e2d\u7684\u5b9a\u4e49\u8981\u72ed\u5c0f\u3002\u6b64\u5916\uff0cAspectJ\u81ea\u8eab\u662f\u57fa\u4e8etype-based\uff0c\u6240\u4ee5\u5728join point \u7684\u6267\u884c\u65f6\uff0cthis\u548ctarget\u90fd\u6307\u7684\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\u3002spring AOP\u662f\u57fa\u4e8e\u4ee3\u7406\u7684\uff0c\u533a\u5206\u4e86\u4ee3\u7406\u5bf9\u8c61\uff08this\uff09\uff0c\u88ab\u4ee3\u7406\u7684\u5bf9\u8c61\uff08target\uff09\u3002</p> <p>\u7531\u4e8espring AOP\u662f\u57fa\u4e8e\u4ee3\u7406\u7684\u7279\u6027\uff0c\u76ee\u6807\u5bf9\u8c61\u5185\u7684\u8c03\u7528\u662f\u4e0d\u4f1a\u88ab\u62e6\u622a\u7684\u3002\u5bf9\u4e8eJDK\u52a8\u6001\u4ee3\u7406\uff0c\u53ea\u6709public\u65b9\u6cd5\u624d\u4f1a\u88ab\u62e6\u622a\uff0c\u5bf9\u4e8eCGLIB\uff0cpublic\u548cprotect\u65b9\u6cd5\u4f1a\u88ab\u62e6\u622a\uff08\u751a\u81f3package-visible\uff09\u3002\u7136\u800c\u60f3\u8981\u88ab\u62e6\u622a\u4ee3\u7406\u7684\u65b9\u6cd5\u6700\u597d\u90fd\u8bbe\u8ba1\u6210public\u7684\u3002</p> <p>\u5982\u679c\u4f60\u7684\u62e6\u622a\u9700\u6c42\u5305\u542b\u76ee\u6807\u7c7b\u7684\u65b9\u6cd5\u8c03\u7528\u751a\u81f3\u6784\u9020\u51fd\u6570\uff0c\u8bf7\u8003\u8651\u4f7f\u7528\u539f\u751f\u7684AspectJ\uff0c\u800c\u4e0d\u662f\u57fa\u4e8e\u4ee3\u7406\u7684spring AOP\u3002</p> <p>spring AOP\u4e5f\u652f\u6301PCD named bean\u3002\u5141\u8bb8\u4f60\u5b9a\u4e49point\u65f6,\u4f7f\u7528bean\u7684name\u6216\u8005\u901a\u914d\u7b26\u3002</p> <p><code>idOrNameOfBean</code> \u662fbean\u7684name\uff0c\u901a\u914d\u7b26\u9650\u5236\u652f\u6301*\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u7684bean\u547d\u540d\u662f\u6709\u89c4\u5f8b\u7684\uff0c\u4f60\u53ef\u7528PCD\u8868\u8fbe\u5f0f\u6765\u6311\u9009\u4ed6\u4eec\u3002\u4e5f\u53ef\u4ee5\u4f7f\u7528 &amp;&amp; || \uff01\u7b49\u3002</p> <p>bean PCD\u53ea\u5728spring AOP\u4e2d\u652f\u6301\uff0cAspectJ\u4e2d\u5e76\u6ca1\u6709\u3002\u4ed6\u662fspring AOP\u7279\u6709\u7684\u6269\u5c55\uff0c\u6240\u4ee5\u4f60\u4e0d\u80fd\u5728@Aspect\u6a21\u578b\u4e2d\u4f7f\u7528\u3002</p> <p>PCD\u662f\u57fa\u4e8e\u5b9e\u4f8b\u800c\u4e0d\u662f\u4ec5\u4ec5\u57fa\u4e8e\u7c7b\u7684\u3002\u57fa\u4e8e\u5b9e\u4f8b\u7684pointcut\u8bbe\u8ba1\u662f\u57fa\u4e8e\u4ee3\u7406\u7684spring AOP\u7279\u6709\u7684\uff0c\u5b83\u548cspring \u5de5\u5382\u7ed3\u5408\u662f\u81ea\u7136\u800c\u76f4\u89c2\u7684\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#pointcut","title":"\u7ec4\u5408Pointcut\u8868\u8fbe\u5f0f","text":"<p>\u4f60\u53ef\u4ee5\u4f7f\u7528&amp;&amp; || \uff01\u6765\u7ec4\u5408pointcut\u8868\u8fbe\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u65b9\u6cd5name\u6765\u5f15\u7528pointcut\u3002\u6765\u770b\u51e0\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>@Pointcut(\"execution(public * *(..))\") // \u8868\u793a\u4efb\u4f55public\u4fee\u9970\u7684\u65b9\u6cd5 \nprivate void anyPublicOperation() {} \n\n@Pointcut(\"within(com.xyz.myapp.trading..*)\") //\u8868\u793atrading\u5305\u4e0b\u7684\u65b9\u6cd5\nprivate void inTrading() {} \n\n@Pointcut(\"anyPublicOperation() &amp;&amp; inTrading()\") // \u8868\u793atrading\u5305\u4e0b public\u4fee\u9970\u7684\u65b9\u6cd5\nprivate void tradingOperation() {}\n</code></pre> <p>\u5982\u4e0a\uff0c\u901a\u8fc7\u4e00\u4e9b\u8f83\u5c0f\u7684\u547d\u540d\u7ec4\u4ef6\u6765\u6784\u5efa\u590d\u6742\u7684pointcuts\u662f\u4e00\u79cd\u6bd4\u8f83\u597d\u7684\u505a\u6cd5\u3002\u5f53\u901a\u8fc7name\u6765\u5f15\u7528pointcuts\u65f6\uff0c\u65b9\u6cd5\u7684\u53ef\u89c1\u6027\u662f\u6ca1\u6709\u5173\u7cfb\u7684\uff0cpublic\uff0cprotected\uff0cprivate\u7b49\u90fd\u4e0d\u4f1a\u5f71\u54cdpointcut\u7684\u5339\u914d\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#pointcut_1","title":"\u5171\u4eab\u516c\u5171\u7684pointcut\u5b9a\u4e49","text":"<p>Sharing Common Pointcut Definitions</p> <p>\u5728\u4f01\u4e1a\u5f00\u53d1\u4e2d\uff0c\u5f00\u53d1\u8005\u7ecf\u5e38\u5e0c\u671b\u5f15\u7528\u5e94\u7528\u7684\u6a21\u5757\u548c\u7279\u5b9a\u7684\u64cd\u4f5c\u4e2d\u7684\u5207\u9762\u3002\u6211\u4eec\u5efa\u8bae\u5b9a\u4e49\u4e00\u4e2a\u516c\u5171\u7684pointcuts\uff0c\u6765\u4fdd\u5b58\u5e38\u89c1\u7684pointcuts\u3002\u4e3e\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>package com.xyz.myapp;\n\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Pointcut;\n\n@Aspect\npublic class CommonPointcuts {\n\n    /**\n     * A join point is in the web layer if the method is defined\n     * in a type in the com.xyz.myapp.web package or any sub-package\n     * under that.\n     * web\u5305\u53ca\u5b50\u5305\u4e0b\u7684\u6240\u6709\u65b9\u6cd5\n     */\n    @Pointcut(\"within(com.xyz.myapp.web..*)\")\n    public void inWebLayer() {}\n\n    /**\n     * A join point is in the service layer if the method is defined\n     * in a type in the com.xyz.myapp.service package or any sub-package\n     * under that.\n     * service\u5305\u53ca\u5b50\u5305\u4e0b\u7684\u6240\u6709\u65b9\u6cd5\n     */\n    @Pointcut(\"within(com.xyz.myapp.service..*)\")\n    public void inServiceLayer() {}\n\n    /**\n     * A join point is in the data access layer if the method is defined\n     * in a type in the com.xyz.myapp.dao package or any sub-package\n     * under that.\n     */\n    @Pointcut(\"within(com.xyz.myapp.dao..*)\")\n    public void inDataAccessLayer() {}\n\n    /**\n     * A business service is the execution of any method defined on a service\n     * interface. This definition assumes that interfaces are placed in the\n     * \"service\" package, and that implementation types are in sub-packages.\n     *\n     * If you group service interfaces by functional area (for example,\n     * in packages com.xyz.myapp.abc.service and com.xyz.myapp.def.service) then\n     * the pointcut expression \"execution(* com.xyz.myapp..service.*.*(..))\"\n     * could be used instead.\n     *\n     * Alternatively, you can write the expression using the 'bean'\n     * PCD, like so \"bean(*Service)\". (This assumes that you have\n     * named your Spring service beans in a consistent fashion.)\n     * \u4e0d\u540c\u8def\u5f84\u4e0b\u7684service\u5305\u4e0b\u7684\u65b9\u6cd5\n     */\n    @Pointcut(\"execution(* com.xyz.myapp..service.*.*(..))\")\n    public void businessService() {}\n\n    /**\n     * A data access operation is the execution of any method defined on a\n     * dao interface. This definition assumes that interfaces are placed in the\n     * \"dao\" package, and that implementation types are in sub-packages.\n     * \u5b9a\u4e49\u5728dao\u63a5\u53e3\u7684\u4efb\u610f\u65b9\u6cd5\uff0c\u6ce8\u610f\u548cwithin\u7684\u533a\u522b\n     */\n    @Pointcut(\"execution(* com.xyz.myapp.dao.*.*(..))\")\n    public void dataAccessOperation() {}\n\n}\n</code></pre> <p>\u4f60\u53ef\u4ee5\u5728\u5176\u4ed6\u5730\u65b9\u4f7f\u7528\u65b9\u6cd5\u7684\u5168\u8def\u5f84\u6765\u5f15\u7528\u8fd9\u4e2apointcuts\uff0c</p> <pre><code>pointcut=\"com.xyz.myapp.CommonPointcuts.businessService()\"\n</code></pre>"},{"location":"java/spring/spring/spring-AOP/#_1","title":"\u4e3e\u4f8b","text":"<p>\u5f88\u591a\u4eba\u90fd\u559c\u6b22\u7528execution\u8bed\u6cd5\uff0c\u5b83\u7684\u8868\u8fbe\u5f0f\u8bed\u6cd5\u662f\uff1a</p> <pre><code>execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern)\n                throws-pattern?)\n</code></pre> <p>\u9664\u4e86ret-type-pattern\uff0cname-pattern\u548cparam-pattern\uff0c\u5176\u4ed6\u90e8\u5206\u90fd\u662f\u53ef\u9009\u7684\u3002returning type pattern\u51b3\u5b9a\u54ea\u4e9b\u8fd4\u56de\u7c7b\u578b\u7684\u65b9\u6cd5\u88ab\u5339\u914d\u5230\uff0c*\u662f\u6700\u5e38\u7528\u7684\u5339\u914d\u7b26\uff0c\u5b83\u5339\u914d\u4efb\u4f55\u7c7b\u578b\u7684\u8fd4\u56de\u503c\uff0c\u5b8c\u5168\u9650\u5b9a\u7684\u7c7b\u578b\u540d\u53ea\u6709\u5728\u65b9\u6cd5\u8fd4\u56de\u7ed9\u5b9a\u7c7b\u578b\u65f6\u624d\u4f1a\u5339\u914d\u3002name pattern\u5bf9\u5e94\u7684\u662f\u65b9\u6cd5\u7684\u540d\u79f0\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528*\u6765\u4f5c\u4e3a\u5339\u914d\u7684\u5168\u90e8\u6216\u90e8\u5206\uff0c\u5982\u679c\u4f60\u6307\u5b9a\u4e86\u4e00\u4e2a\u58f0\u660e\u7684\u6a21\u5f0f\uff0c\u9700\u8981\u5305\u542b.\u6765\u8fde\u63a5\u3002</p> <p>parameters pattern\u7a0d\u5fae\u590d\u6742\u4e00\u4e9b\uff0c</p> <p>() \u5339\u914d\u6ca1\u6709\u53c2\u6570\u7684\u65b9\u6cd5\uff0c</p> <p>(..)\u5339\u914d\u4efb\u4f55\u6570\u91cf\uff080\u4e2a\u6216\u591a\u4e2a\uff09\u7684\u53c2\u6570,</p> <p>(*)\u5339\u914d\u62e5\u6709\u4e00\u4e2a\u4efb\u610f\u7c7b\u578b\u7684\u53c2\u6570\u65b9\u6cd5</p> <p>(*,String)\u5339\u914d\u6709\u4e24\u4e2a\u53c2\u6570\u7684\u65b9\u6cd5\uff0c\u7b2c\u4e00\u4e2a\u53ef\u4ee5\u662f\u4efb\u610f\u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u5fc5\u987b\u662fstring\u7c7b\u578b\u3002</p> <p>\u4e0b\u9762\u4e3e\u4e00\u4e9b\u4f8b\u5b50\uff1a</p> <pre><code> execution(public * *(..)) //\u4efb\u610fpublic\u4fee\u9970\u7684\u65b9\u6cd5\n\n execution(* set*(..))  // \u4efb\u610fset\u5f00\u5934\u7684\u65b9\u6cd5\n\n execution(* com.xyz.service.AccountService.*(..)) // \u4efb\u610f\u5b9a\u4e49\u5728AccountService\u63a5\u53e3\u4e2d\u7684\u65b9\u6cd5\n\n execution(* com.xyz.service.*.*(..)) // \u4efb\u610fservice\u5305\u4e0b\u7684\u65b9\u6cd5\n\n execution(* com.xyz.service..*.*(..)) // \u4efb\u610fservice\u5305\u53ca\u5176\u5b50\u5305\u4e0b\u7684\u65b9\u6cd5\n\n within(com.xyz.service.*) // Any join point (method execution only in Spring AOP) within the service package:\n\n within(com.xyz.service..*) // within the service package or one of its sub-packages:\n\n this(com.xyz.service.AccountService) // Any join point (method execution only in Spring AOP) where the proxy implements the AccountService interface:\n\n  target(com.xyz.service.AccountService) //  target object implements the AccountService interface\n\n args(java.io.Serializable) // Any join point (method execution only in Spring AOP) that takes a single parameter and where the argument passed at runtime is Serializable:\n \u6ce8\u610f\u5b83\u548cexecution(* *(java.io.Serializable))\u7684\u4e0d\u540c\uff0c\u540e\u8005\u662f\u6307\u65b9\u6cd5\u7b7e\u540d\u4e2d\u7684\u53c2\u6570 \uff0c\u524d\u8005\u662f\u8fd0\u884c\u65f6\n\n @target(org.springframework.transaction.annotation.Transactional) // Any join point (method execution only in Spring AOP) where the target object has a @Transactional annotation\n\n @args(com.xyz.security.Classified) //  which takes a single parameter, and where the runtime type of the argument passed has the @Classified annotation:\n\n  bean(tradeService) // \u540d\u5b57\u4e3atradeService\u7684bean\n\n  bean(*Service) // service\u5f00\u5934\u7684bean\n</code></pre>"},{"location":"java/spring/spring/spring-AOP/#writing-good-pointcuts","title":"Writing Good Pointcuts","text":"<p>\u5728\u7f16\u8bd1\u8fc7\u7a0b\u4e2d\uff0cAspectJ\u4f1a\u5904\u7406\u70b9\u5207\uff0c\u4ee5\u4f18\u5316\u5339\u914d\u6027\u80fd\u3002\u68c0\u67e5\u4ee3\u7801\u5e76\u786e\u5b9a\u6bcf\u4e2a\u8fde\u63a5\u70b9\u662f\u5426\u4e0e\u7ed9\u5b9a\u7684\u70b9\u5207\u5339\u914d\uff08\u9759\u6001\u6216\u52a8\u6001\uff09\u662f\u4e00\u4e2a\u4ee3\u4ef7\u9ad8\u6602\u7684\u8fc7\u7a0b\u3002(\u52a8\u6001\u5339\u914d\u610f\u5473\u7740\u4e0d\u80fd\u4ece\u9759\u6001\u5206\u6790\u4e2d\u5b8c\u5168\u786e\u5b9a\u5339\u914d\uff0c\u5f53\u4ee3\u7801\u8fd0\u884c\u65f6\uff0c\u8981\u5728\u4ee3\u7801\u4e2d\u653e\u7f6e\u4e00\u4e2a\u6d4b\u8bd5\u6765\u786e\u5b9a\u662f\u5426\u6709\u5b9e\u9645\u5339\u914d)\u3002\u5728\u7b2c\u4e00\u6b21\u9047\u5230\u4e00\u4e2apointcut\u58f0\u660e\u65f6\uff0cAspectJ\u4f1a\u628a\u5b83\u6539\u5199\u6210\u4e00\u4e2a\u6700\u4f73\u7684\u5f62\u5f0f\u6765\u8fdb\u884c\u5339\u914d\u8fc7\u7a0b\u3002\u8fd9\u610f\u5473\u7740\u4ec0\u4e48\u5462\uff1f\u57fa\u672c\u4e0a\uff0c\u70b9\u5207\u662f\u4ee5DNF\uff08Disjunctive Normal Form\uff09\u91cd\u5199\u7684\uff0c\u5e76\u4e14\u70b9\u5207\u7684\u7ec4\u4ef6\u4f1a\u88ab\u6392\u5e8f\uff0c\u8fd9\u6837\u90a3\u4e9b\u8bc4\u4f30\u6210\u672c\u8f83\u4f4e\u7684\u7ec4\u4ef6\u4f1a\u88ab\u9996\u5148\u68c0\u67e5\u3002\u8fd9\u610f\u5473\u7740\u60a8\u4e0d\u5fc5\u62c5\u5fc3\u4e86\u89e3\u5404\u79cd\u70b9\u5207\u4ee3\u53f7\u7684\u6027\u80fd\uff0c\u53ef\u4ee5\u5728\u70b9\u5207\u58f0\u660e\u4e2d\u4ee5\u4efb\u4f55\u987a\u5e8f\u63d0\u4f9b\u5b83\u4eec\u3002</p> <p>\u7136\u800c\uff0cAspectJ\u53ea\u80fd\u5de5\u4f5c\u5728\u88ab\u544a\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u4f18\u5316\u5339\u914d\u7684\u6027\u80fd\uff0c\u4f60\u5e94\u8be5\u601d\u8003\u8981\u5b9e\u73b0\u7684\u76ee\u7684\uff0c\u5e76\u5728\u5b9a\u4e49\u4e2d\u5c3d\u53ef\u80fd\u7684\u7f29\u5c0f\u5339\u914d\u7684\u641c\u7d22\u7684\u8303\u56f4\u3002\u4e0a\u8ff0\u7684\u5339\u914d\u8bed\u6cd5\u53ef\u4ee5\u5206\u4e3a\u4e09\u7c7b\uff1a</p> <p>\u4e00\u4e2a\u5199\u5f97\u597d\u7684pointcut\u5e94\u8be5\u81f3\u5c11\u5305\u62ec\u524d\u4e24\u79cd\u7c7b\u578b\uff08kinded\u548cscoping\uff09\u3002\u4f60\u53ef\u4ee5\u5305\u62ec\u57fa\u4e8eContextual \u5339\u914d\uff0c\u6216\u8005\u5c06\u8be5\u4e0a\u4e0b\u6587\u7ed1\u5b9a\u5230advice\u4e2d\u4f7f\u7528\u3002\u53ea\u63d0\u4f9b\u4e00\u4e2akinded\u4ee3\u53f7\u6216\u53ea\u63d0\u4f9b\u4e00\u4e2a contextual \u4ee3\u53f7\u662f\u53ef\u884c\u7684\uff0c\u4f46\u7531\u4e8e\u989d\u5916\u7684\u5904\u7406\u548c\u5206\u6790\uff0c\u53ef\u80fd\u4f1a\u5f71\u54cd\u7ec7\u9020\u6027\u80fd\uff08\u6240\u7528\u65f6\u95f4\u548c\u5185\u5b58\uff09\u3002Scoping\u4ee3\u53f7\u7684\u5339\u914d\u901f\u5ea6\u975e\u5e38\u5feb\uff0c\u4f7f\u7528\u5b83\u4eec\u7684\u7528\u6cd5\u610f\u5473\u7740AspectJ\u53ef\u4ee5\u975e\u5e38\u5feb\u901f\u5730\u5254\u9664\u4e0d\u5e94\u8be5\u8fdb\u4e00\u6b65\u5904\u7406\u7684\u8fde\u63a5\u70b9\u7ec4\u3002\u5982\u679c\u53ef\u80fd\u7684\u8bdd\uff0c\u4e00\u4e2a\u597d\u7684\u70b9\u5207\u5e94\u8be5\u603b\u662f\u5305\u542b\u4e00\u4e2a\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#544-advice","title":"5.4.4 \u58f0\u660e Advice","text":"<p>advice\u548cpointcut\u8868\u8fbe\u5f0f\u5173\u8054\uff0c\u5728\u65b9\u6cd5before\uff0cafter\uff0caround\u6267\u884c\u3002pointcut\u8868\u8fbe\u5f0f\u53ef\u4ee5\u662f\u53e6\u4e00\u4e2apointcut\u7684\u540d\u5b57\u5f15\u7528\uff0c\u4e5f\u53ef\u4ee5\u662fpointcut\u8868\u8fbe\u5f0f\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#before-advice","title":"Before Advice","text":"<p>\u4f7f\u7528@Before\u6ce8\u89e3</p> <pre><code>import org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Before;\n\n@Aspect\npublic class BeforeExample {\n\n    @Before(\"com.xyz.myapp.CommonPointcuts.dataAccessOperation()\") // \u5f15\u7528\u516c\u5171\u5305\u91cc\u7684pointcut\u65b9\u6cd5\n    public void doAccessCheck() {\n        // ...\n    }\n}\n\n\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Before;\n\n@Aspect\npublic class BeforeExample {\n\n    // \u76f4\u63a5\u4f7f\u7528pointcut\u8868\u8fbe\u5f0f\n    @Before(\"execution(* com.xyz.myapp.dao.*.*(..))\")\n    public void doAccessCheck() {\n        // ...\n    }\n\n}\n</code></pre>"},{"location":"java/spring/spring/spring-AOP/#after-returning-advice","title":"After Returning Advice","text":"<p>\u7528\u4e8e\u65b9\u6cd5\u6267\u884c\u6b63\u5e38\u8fd4\u56de\u65f6\uff0c\u4f7f\u7528@AfterReturning\u6ce8\u89e3\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728\u540c\u4e00\u4e2a\u7c7b\u91cc\u58f0\u660e\u591a\u4e2aadvice\u3002</p> <p>\u6709\u65f6\uff0c\u4f60\u60f3\u5728\u65b9\u6cd5\u91cc\u83b7\u53d6\u5b9e\u9645\u7684\u8fd4\u56de\u503c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u7684\u65b9\u5f0f\uff1a</p> <pre><code>import org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.AfterReturning;\n\n@Aspect\npublic class AfterReturningExample {\n\n    @AfterReturning(\n        pointcut=\"com.xyz.myapp.CommonPointcuts.dataAccessOperation()\",\n        returning=\"retVal\")\n    public void doAccessCheck(Object retVal) {\n        // ...\n    }\n\n}\n</code></pre> <p>\u6ce8\u89e3\u91cc\u7684returning\u5c5e\u6027\u5fc5\u987b\u548c\u65b9\u6cd5\u53c2\u6570\u4e25\u683c\u5bf9\u5e94\u3002\u5f53\u4e00\u4e2a\u65b9\u6cd5\u6267\u884c\u8fd4\u56de\u65f6\uff0c\u8fd4\u56de\u503c\u4f1a\u7ecf\u8fc7\u8fd9\u4e2aadvice\u65b9\u6cd5\u3002returning\u5c5e\u6027\u8fd8\u4f1a\u9650\u5236\u53ea\u6709\u65b9\u6cd5\u8fd4\u56de\u5bf9\u5e94\u8fd4\u56de\u503c\u7684\u5339\u914d\uff08\u8fd9\u91ccObject\u4f1a\u5339\u914d\u6240\u6709\u8fd4\u56de\u7c7b\u578b\u503c\uff09</p> <p>\u8bf7\u6ce8\u610f\uff0c\u5728\u6267\u884cadvice\u540e\uff0c\u4e0d\u53ef\u80fd\u8fd4\u56de\u4e00\u4e2a\u5b8c\u5168\u4e0d\u540c\u7684\u5f15\u7528\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#after-throwing-advice","title":"After Throwing Advice","text":"<p>\u901a\u5e38\u4f60\u5e0c\u671b\u53ea\u6709\u629b\u51fa\u6307\u5b9a\u5f02\u5e38\u65f6\u624d\u6267\u884cadvice\uff0c\u6216\u8005\u4f60\u60f3\u8981\u5728\u65b9\u6cd5\u91cc\u83b7\u53d6\u5f02\u5e38\u4fe1\u606f\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528<code>throwing</code> \u5c5e\u6027\u6765\u4e25\u683c\u5339\u914d\uff0c\u548c\u5bf9\u5e94\u65b9\u6cd5\u53c2\u6570\u3002\u4e3e\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>import org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.AfterThrowing;\n\n@Aspect\npublic class AfterThrowingExample {\n\n    @AfterThrowing(\n        pointcut=\"com.xyz.myapp.CommonPointcuts.dataAccessOperation()\",\n        throwing=\"ex\")\n    public void doRecoveryActions(DataAccessException ex) {\n        // ...\n    }\n\n}\n</code></pre> <p>throwing\u5c5e\u6027\u7684\u540d\u5b57\u5fc5\u987b\u548c\u65b9\u6cd5\u53c2\u6570\u540d\u4e25\u683c\u5bf9\u5e94\u3002\u5f53\u4e00\u4e2a\u65b9\u6cd5\u6267\u884c\u629b\u51fa\u5f02\u5e38\u65f6\uff0c\u5f02\u5e38\u4fe1\u606f\u4f1a\u7ecf\u8fc7\u8fd9\u4e2aadvice\uff0c\u5e76\u4f20\u7ed9\u65b9\u6cd5\u53c2\u6570\uff0c\u5e76\u4e14\u53ea\u6709\u629b\u51fa\u7684\u5f02\u5e38\u662f\u53c2\u6570\u58f0\u660e\u7684\u5f02\u5e38\u65f6\u624d\u4f1a\u8c03\u7528advice\uff08\u8fd9\u91cc\u662fDataAccessException\u5f02\u5e38\uff09</p>"},{"location":"java/spring/spring/spring-AOP/#after-finally-advice","title":"After (Finally) Advice","text":"<p>After (finally) advice\u5728\u65b9\u6cd5\u6267\u884c\u63a8\u51fa\u65f6\u8c03\u7528\uff0c\u4f7f\u7528@After\u6ce8\u89e3\uff0c\u5bf9\u5e94\u65b9\u6cd5\u6b63\u5e38\u7ed3\u675f\u6216\u629b\u51fa\u5f02\u5e38\u7684\u60c5\u51b5\u3002\u5178\u578b\u7684\u7528\u6cd5\u53ef\u4ee5\u7528\u6765\u91ca\u653e\u8d44\u6e90\u7b49\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#around-advice","title":"Around Advice","text":"<p>\u6700\u540e\u4e00\u79cdadvice\u7c7b\u578b\u662faround\u3002Around advice\u53ef\u4ee5\u5728\u65b9\u6cd5\u6267\u884c\u524d\u540e\u8c03\u7528\uff0c\u51b3\u5b9a\u4f55\u65f6\uff0c\u600e\u4e48\u751a\u81f3\u65b9\u6cd5\u5b9e\u9645\u662f\u5426\u6267\u884c\u3002Around advice \u7ecf\u5e38\u7528\u6765\u5982\u679c\u4f60\u60f3\u5728\u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7ba1\u7406\u65f6\uff0c\u5728\u65b9\u6cd5\u6267\u884c\u524d\u540e\u5171\u4eab\u4e00\u4e2a\u72b6\u6001\uff08\u5982\u5f00\u542f\u548c\u7ed3\u675f\u4e00\u4e2a\u8ba1\u65f6\u5668\uff0c\u7edf\u8ba1\u65b9\u6cd5\u6267\u884c\u65f6\u957f\uff09\u3002\u6ce8\u610f\u5982\u679c\u5176\u4ed6advice\u80fd\u6ee1\u8db3\u9700\u6c42\u65f6\uff0c\u8bf7\u4e0d\u8981\u4f7f\u7528around advice\u3002</p> <p>\u65b9\u6cd5\u91cc\u4f7f\u7528ProceedingJoinPoint \u7684proceed\u65b9\u6cd5\u8c03\u7528\u76ee\u6807\u7c7b\u7684\u65b9\u6cd5\u3002\u53ef\u4ee5\u62ff\u5230\u8fd4\u56de\u503c\u3002</p> <p>around advice\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\uff0c\u5c31\u662f\u8c03\u7528\u8005\u8c03\u7528\u65b9\u6cd5\u770b\u5230\u7684\u8fd4\u56de\u503c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2a\u7f13\u5b58\u529f\u80fd\u7684\u5207\u9762\uff0c\u5982\u679c\u7f13\u5b58\u6709\u5c31\u8fd4\u56de\u7f13\u5b58\u503c\uff0c\u6ca1\u6709\u5c31\u8c03\u7528proceed\u65b9\u6cd5\u3002\u6ce8\u610f\uff0cproceed\u65b9\u6cd5\u53ef\u4ee5\u88ab\u8c03\u7528\u4e00\u6b21\uff0c\u8bb8\u591a\u6b21\uff0c\u6216\u8005\u96f6\u6b21\uff0c\u8fd9\u4e9b\u90fd\u662f\u5408\u6cd5\u7684\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#advice-parameters","title":"Advice Parameters","text":"<p>spring\u63d0\u4f9b\u4e86\u5b8c\u5168\u7c7b\u578b\u5316\u7684advice\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u5728\u65b9\u6cd5\u7b7e\u540d\u4e2d\u58f0\u660e\u4f60\u9700\u8981\u7684\u53c2\u6570\uff08\u5c31\u548c\u4e4b\u524d\u5728eturning \u548cthrowing\u7684advice\u4e2d\u770b\u5230\u7684\u4e00\u6837\uff09\uff0c\u800c\u4e0d\u662f\u4e00\u76f4\u4f7f\u7528Object[]\u5de5\u4f5c\u3002\u6211\u4eec\u5c06\u5728\u672c\u8282\u540e\u9762\u770b\u5230\u5982\u4f55\u4f7f\u53c2\u6570\u548c\u5176\u4ed6\u4e0a\u4e0b\u6587\u503c\u53ef\u7528\u4e8e\u5efa\u8bae\u4f53\u3002\u9996\u5148\uff0c\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u7f16\u5199\u901a\u7528\u7684\u5efa\u8bae\uff0c\u53ef\u4ee5\u627e\u51fa\u8be5\u5efa\u8bae\u5f53\u524d\u6240\u5efa\u8bae\u7684\u65b9\u6cd5\u7684\u60c5\u51b5\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#access-to-the-current-joinpoint","title":"Access to the Current <code>JoinPoint</code>","text":"<p>\u4efb\u4f55advice\u65b9\u6cd5\u90fd\u53ef\u4ee5\u628aJoinPoint\u4f5c\u4e3a\u65b9\u6cd5\u7b7e\u540d\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\uff08\u6ce8\u610faround advice\u7684ProceedingJoinPoint\u5c5e\u4e8eJoinPoint\u7684\u5b50\u7c7b\uff09\uff0cJoinPoint\u63d0\u4f9b\u4e86\u4e00\u4e0b\u5e38\u89c1\u7684API\u65b9\u6cd5\uff1a</p> <ul> <li><code>getArgs()</code>: Returns the method arguments.</li> <li><code>getThis()</code>: Returns the proxy object.</li> <li><code>getTarget()</code>: Returns the target object.</li> <li><code>getSignature()</code>: Returns a description of the method that is being advised.</li> <li><code>toString()</code>: Prints a useful description of the method being advised.</li> </ul>"},{"location":"java/spring/spring/spring-AOP/#advicepassing-parameters-to-advice","title":"\u83b7\u53d6advice\u7684\u53c2\u6570Passing Parameters to Advice","text":"<p>We have already seen how to bind the returned value or exception value (using after returning and after throwing advice). To make argument values available to the advice body, you can use the binding form of <code>args</code>. If you use a parameter name in place of a type name in an args expression, the value of the corresponding argument is passed as the parameter value when the advice is invoked. An example should make this clearer. Suppose you want to advise the execution of DAO operations that take an <code>Account</code> object as the first parameter, and you need access to the account in the advice body. You could write the following:</p> <p>\u6211\u4eec\u524d\u9762\u5df2\u7ecf\u77e5\u9053\u5982\u4f55\u7ed1\u5b9a\u8fd4\u56de\u503c\u548c\u5f02\u5e38\u4fe1\u606f\uff08\u5728\u4f7f\u7528after returning\u548cafter throwing\u7684 advice\uff09\u3002\u60f3\u8981\u5728\u65b9\u6cd5\u91cc\u4f7f\u7528\u8fd9\u4e9b\u53c2\u6570\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528args\u8868\u5355\u3002\u5982\u679c\u5728args\u8868\u8fbe\u5f0f\u4f7f\u7528\u65b9\u6cd5\u53c2\u6570\u540d\uff0c\u90a3\u4e48\u5f53\u6267\u884cadvice\u65f6\uff0c\u76f8\u5e94\u53c2\u6570\u7684\u503c\u4f1a\u4f20\u9012\u7ed9\u65b9\u6cd5\u53c2\u6570\u3002\u4e0b\u9762\u4e3e\u4e2a\u4f8b\u5b50\u4f1a\u8bf4\u7684\u66f4\u6e05\u695a\u4e9b\uff0c\u5047\u5982\u4f60\u60f3\u62e6\u622adao\u5c42\u65b9\u6cd5\u7b2c\u4e00\u4e2a\u53c2\u6570\u662fAccount\u5bf9\u8c61\u7684\u65b9\u6cd5\uff0c\u5e76\u5728\u65b9\u6cd5\u4f53\u91cc\u83b7\u53d6\u8fd9\u4e2aAccount\u5bf9\u8c61\uff0c\u53ef\u4ee5\u8fd9\u6837\u5199\uff1a</p> <pre><code>@Before(\"com.xyz.myapp.CommonPointcuts.dataAccessOperation() &amp;&amp; args(account,..)\")\npublic void validateAccount(Account account) {\n    // ...\n}\n</code></pre> <p>The <code>args(account,..)</code> part of the pointcut expression serves two purposes. First, it restricts matching to only those method executions where the method takes at least one parameter, and the argument passed to that parameter is an instance of <code>Account</code>. Second, it makes the actual <code>Account</code> object available to the advice through the <code>account</code> parameter.</p> <p>pointcut\u8868\u8fbe\u5f0f\u91cc\u7684<code>args(account,..)</code>\u6709\u4e24\u4e2a\u76ee\u7684\u3002\u7b2c\u4e00\uff0c\u5b83\u4e25\u683c\u9650\u5236\u4e86\u53ea\u6709\u65b9\u6cd5\u6709\u4e00\u4e2a\u53c2\u6570\u662fAccount\u5b9e\u4f8b\u65f6\u624d\u4f1a\u5339\u914d\uff0c\u7b2c\u4e8c\uff0c\u53ef\u4ee5\u5728advice\u65b9\u6cd5\u4f53\u91cc\u901a\u8fc7account\u53c2\u6570\u83b7\u53d6Account\u5bf9\u8c61\u3002</p> <p>\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff0c\u901a\u8fc7\u5f15\u7528\u53e6\u4e00\u4e2apointcut\u65b9\u6cd5\u540d\uff0c\u4e3e\u4f8b\uff1a</p> <pre><code>@Pointcut(\"com.xyz.myapp.CommonPointcuts.dataAccessOperation() &amp;&amp; args(account,..)\")\nprivate void accountDataAccessOperation(Account account) {}\n\n@Before(\"accountDataAccessOperation(account)\")\npublic void validateAccount(Account account) {\n    // ...\n}\n</code></pre> <p>The proxy object ( <code>this</code>), target object ( <code>target</code>), and annotations ( <code>@within</code>, <code>@target</code>, <code>@annotation</code>, and <code>@args</code>) can all be bound in a similar fashion. The next two examples show how to match the execution of methods annotated with an <code>@Auditable</code> annotation and extract the audit code:</p> <p>\u4ee3\u7406\u5bf9\u8c61\uff08this\uff09\uff0c\u76ee\u6807\u5bf9\u8c61\uff08target\uff09,\u548c\u6ce8\u89e3\uff08@within<code>,</code>@target<code>,</code>@annotation<code>, and</code>@args\uff09\u90fd\u53ef\u4ee5\u901a\u8fc7\u76f8\u540c\u7684\u98ce\u683c\u7ed1\u5b9a\u3002\u4e0b\u9762\u4e24\u4e2a\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u83b7\u53d6\u65b9\u6cd5\u4e0a\u7684\u6ce8\u89e3\u4e2d\u7684\u4fe1\u606f</p> <pre><code>@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.METHOD)\npublic @interface Auditable {\n    AuditCode value();\n}\n\n@Before(\"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)\")\npublic void audit(Auditable auditable) {\n    AuditCode code = auditable.value();\n    // ...\n}\n</code></pre>"},{"location":"java/spring/spring/spring-AOP/#advice-parameters-and-generics","title":"Advice Parameters and Generics\u6cdb\u578b","text":"<p>spring AOP\u53ef\u4ee5\u5904\u7406\u7c7b\u548c\u65b9\u6cd5\u4e2d\u7684\u6cdb\u578b\uff0c</p> <pre><code>public interface Sample&lt;T&gt; {\n    void sampleGenericMethod(T param);\n    void sampleGenericCollectionMethod(Collection&lt;T&gt; param);\n}\n</code></pre> <p>You can restrict interception of method types to certain parameter types by typing the advice parameter to the parameter type for which you want to intercept the method:</p> <pre><code>@Before(\"execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)\")\npublic void beforeSampleMethod(MyType param) {\n    // Advice implementation\n}\n\n// \u4f46\u662f\u5bf9\u96c6\u5408\u6cdb\u578b\u662f\u65e0\u6548\u7684\uff0c\u4e0b\u9762\u8fd9\u4e2a\u662f\u4e0d\u884c\u7684\n@Before(\"execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)\")\npublic void beforeSampleMethod(Collection&lt;MyType&gt; param) {\n    // Advice implementation\n}\n</code></pre> <p>To make this work, we would have to inspect every element of the collection, which is not reasonable, as we also cannot decide how to treat <code>null</code> values in general. To achieve something similar to this, you have to type the parameter to <code>Collection&lt;?&gt;</code> and manually check the type of the elements.</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u96c6\u5408\u6cdb\u578b\uff0cspring\u5fc5\u987b\u68c0\u67e5\u96c6\u5408\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\uff0c\u8fd9\u662f\u4e0d\u5408\u7406\u7684\uff0c\u800c\u4e14\u4e5f\u4e0d\u77e5\u9053\u5982\u4f55\u5904\u7406null\u7684\u60c5\u51b5\u3002\u5982\u679c\u8981\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u7684\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528Collection&lt;?&gt;\uff0c\u7136\u540e\u624b\u52a8\u68c0\u67e5\u6bcf\u4e2a\u5143\u7d20\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#determining-argument-names","title":"Determining Argument Names","text":"<p>The parameter binding in advice invocations relies on matching names used in pointcut expressions to declared parameter names in advice and pointcut method signatures. Parameter names are not available through Java reflection, so Spring AOP uses the following strategy to determine parameter names:</p> <p>advice\u4e2d\u8c03\u7528\u7684\u53c2\u6570\u7ed1\u5b9a\u4f9d\u8d56\u4e8epointcut\u8868\u8fbe\u5f0f\u4e2d\u4f7f\u7528\u7684\u53c2\u6570\u540d\u79f0\u548c pointcut\u65b9\u6cd5\u7b7e\u540d\u548cadvice\u91cc\u7684\u53c2\u6570\u540d\u5b57\u5339\u914d\u3002\u53c2\u6570\u540d\u5b57\u4e0d\u80fd\u901a\u8fc7Java\u53cd\u5c04\u83b7\u53d6\uff0c\u6240\u4ee5spring AOP\u63d0\u4f9b\u4e86\u4e00\u4e0b\u4e0b\u7b56\u7565\u6765\u51b3\u5b9a\u53c2\u6570\u540d\u5b57\uff1a</p> <ul> <li>If the parameter names have been explicitly specified by the user, the specified parameter names are used. Both the advice and the pointcut annotations have an optional <code>argNames</code> attribute that you can use to specify the argument names of the annotated method. These argument names are available at runtime. The following example shows how to use the <code>argNames</code> attribute:</li> </ul> <pre><code>@Before(value=\"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)\",\n        argNames=\"bean,auditable\")\npublic void audit(Object bean, Auditable auditable) {\n    AuditCode code = auditable.value();\n    // ... use code and bean\n}\n</code></pre> <p>If the first parameter is of the <code>JoinPoint</code>, <code>ProceedingJoinPoint</code>, or <code>JoinPoint.StaticPart</code> type, you can leave out the name of the parameter from the value of the <code>argNames</code> attribute. For example, if you modify the preceding advice to receive the join point object, the <code>argNames</code> attribute need not include it:</p> <pre><code>@Before(value=\"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)\",\n        argNames=\"bean,auditable\")\npublic void audit(JoinPoint jp, Object bean, Auditable auditable) {\n    AuditCode code = auditable.value();\n    // ... use code, bean, and jp\n}\n</code></pre> <p>The special treatment given to the first parameter of the <code>JoinPoint</code>, <code>ProceedingJoinPoint</code>, and <code>JoinPoint.StaticPart</code> types is particularly convenient for advice instances that do not collect any other join point context. In such situations, you may omit the <code>argNames</code> attribute. For example, the following advice need not declare the <code>argNames</code> attribute:</p> <pre><code>@Before(\"com.xyz.lib.Pointcuts.anyPublicMethod()\")\npublic void audit(JoinPoint jp) {\n    // ... use jp\n}\n</code></pre> <ul> <li>Using the <code>'argNames'</code> attribute is a little clumsy, so if the <code>'argNames'</code> attribute has not been specified, Spring AOP looks at the debug information for the class and tries to determine the parameter names from the local variable table. This information is present as long as the classes have been compiled with debug information ( <code>'-g:vars'</code> at a minimum). The consequences of compiling with this flag on are: (1) your code is slightly easier to understand (reverse engineer), (2) the class file sizes are very slightly bigger (typically inconsequential), (3) the optimization to remove unused local variables is not applied by your compiler. In other words, you should encounter no difficulties by building with this flag on.</li> </ul> <p>If an @AspectJ aspect has been compiled by the AspectJ compiler (ajc) even without the debug information, you need not add the <code>argNames</code> attribute, as the compiler retain the needed information.</p> <ul> <li> <p>If the code has been compiled without the necessary debug information, Spring AOP tries to deduce the pairing of binding variables to parameters (for example, if only one variable is bound in the pointcut expression, and the advice method takes only one parameter, the pairing is obvious). If the binding of variables is ambiguous given the available information, an <code>AmbiguousBindingException</code> is thrown.</p> </li> <li> <p>If all of the above strategies fail, an <code>IllegalArgumentException</code> is thrown.</p> </li> </ul>"},{"location":"java/spring/spring/spring-AOP/#proceeding-with-arguments","title":"Proceeding with Arguments","text":"<p>We remarked earlier that we would describe how to write a <code>proceed</code> call with arguments that works consistently across Spring AOP and AspectJ. The solution is to ensure that the advice signature binds each of the method parameters in order. The following example shows how to do so:</p> <p>In many cases, you do this binding anyway (as in the preceding example).</p> <p>\u89e3\u51b3\u65b9\u6cd5\u662f\u786e\u4fddadvice\u7684\u7b7e\u540d\u6309\u987a\u5e8f\u7ed1\u5b9a\u6bcf\u4e2a\u65b9\u6cd5\u53c2\u6570</p> <pre><code>@Around(\"execution(List&lt;Account&gt; find*(..)) &amp;&amp; \" +\n        \"com.xyz.myapp.CommonPointcuts.inDataAccessLayer() &amp;&amp; \" +\n        \"args(accountHolderNamePattern)\")\npublic Object preProcessQueryPattern(ProceedingJoinPoint pjp,\n        String accountHolderNamePattern) throws Throwable {\n    String newPattern = preProcess(accountHolderNamePattern);\n    return pjp.proceed(new Object[] {newPattern});\n}\n</code></pre>"},{"location":"java/spring/spring/spring-AOP/#advice","title":"advice\u7684\u987a\u5e8f","text":"<p>Advice Ordering</p> <p>\u5f53\u591a\u4e2aadvice\u90fd\u60f3\u5728\u540c\u4e00\u4e2ajoin point\u8fd0\u884c\u65f6\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1fspring AOP\u9075\u5faaAspectJ\u7684\u4f18\u5148\u7ea7\u6765\u51b3\u5b9aadvice\u7684\u6267\u884c\u987a\u5e8f\u3002\u4f18\u5148\u7ea7\u9ad8\u7684advice\u5728\u8fdb\u5165\u65b9\u6cd5\u65f6\u5148\u8fd0\u884c\uff08\u4e5f\u5c31\u662f\u7ed9\u5b9a\u4e24\u4e2abefore advice\uff0c\u4f18\u5148\u7ea7\u9ad8\u7684\u5148\u6267\u884c\uff09\u3002\u5728join point\u7684On the way out\uff0c\u9ad8\u4f18\u5148\u7ea7\u7684advice\u540e\u8fd0\u884c\uff0c\uff08\u6240\u4ee5\u7ed9\u5b9a\u4e24\u4e2aafter advice\uff0c\u9ad8\u4f18\u5148\u7ea7\u7684\u540e\u8fd0\u884c\uff09\u3002</p> <p>\u5f53\u4e24\u4e2aAspectJ\u7684advice\u90fd\u9700\u8981\u8fd0\u884c\u5728\u76f8\u540c\u7684join point\u65f6\uff0c\u9664\u975e\u4f60\u7279\u522b\u6307\u5b9a\uff0c\u5426\u5219\u6267\u884c\u987a\u5e8f\u662f\u672a\u5b9a\u4e49\u7684\u3002\u4f60\u53ef\u4ee5\u6307\u5b9a\u4f18\u5148\u7ea7\u6765\u63a7\u5236\u6267\u884c\u987a\u5e8f\uff0c\u53ef\u4ee5\u901a\u8fc7@Order\u6ce8\u89e3\u6765\u6267\u884c\u3002order\u503c\u8f83\u4f4e\u7684aspect\u62e5\u6709\u8f83\u9ad8\u7684\u4f18\u5148\u7ea7\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#55-schema-based-aop-support","title":"5.5 Schema-based AOP Support","text":"<p>\u57fa\u4e8eXML\u58f0\u660eAOP\uff0c\u7531\u4e8e\u4e0d\u5e38\u7528\uff0c\u8fd9\u91cc\u7565\u53bb\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#56-aop","title":"5.6 \u9009\u62e9\u5982\u4f55\u4f7f\u7528AOP\uff1f","text":"<p>\u4e00\u65e6\u4f60\u51b3\u5b9a\u597d\u4f7f\u7528\u5207\u9762\u6765\u5b9e\u73b0\u4f60\u7684\u9700\u6c42\uff0c\u63a5\u7740\u5c31\u662f\u51b3\u5b9a\u4f7f\u7528Spring AOP\u8fd8\u662fAspectJ\uff0c\u4f7f\u7528@Aspect\u6ce8\u89e3\u65b9\u5f0f\u8fd8\u662fxml\u65b9\u5f0f\u3002\u8fd9\u53d6\u51b3\u4e8e\u5e94\u7528\u9700\u6c42\uff0c\u5f00\u53d1\u5de5\u5177\u548c\u56e2\u961f\u5bf9AOP\u7684\u719f\u6089\u7a0b\u5ea6\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#561-spring-aopfull-aspectj","title":"5.6.1 Spring AOP\u8fd8\u662fFull AspectJ","text":"<p>Use the simplest thing that can work. Spring AOP is simpler than using full AspectJ, as there is no requirement to introduce the AspectJ compiler / weaver into your development and build processes. If you only need to advise the execution of operations on Spring beans, Spring AOP is the right choice. If you need to advise objects not managed by the Spring container (such as domain objects, typically), you need to use AspectJ. You also need to use AspectJ if you wish to advise join points other than simple method executions (for example, field get or set join points and so on).</p> <p>When you use AspectJ, you have the choice of the AspectJ language syntax (also known as the \u201ccode style\u201d) or the @AspectJ annotation style. Clearly, if you do not use Java 5+, the choice has been made for you: Use the code style. If aspects play a large role in your design, and you are able to use the AspectJ Development Tools (AJDT) plugin for Eclipse, the AspectJ language syntax is the preferred option. It is cleaner and simpler because the language was purposefully designed for writing aspects. If you do not use Eclipse or have only a few aspects that do not play a major role in your application, you may want to consider using the @AspectJ style, sticking with regular Java compilation in your IDE, and adding an aspect weaving phase to your build script.</p> <p>\u5c3d\u91cf\u4f7f\u7528\u7b80\u5355\u7684\u65b9\u5f0f\u3002Spring AOP\u6bd4\u4f7f\u7528Full AspectJ\u66f4\u7b80\u5355\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\u5c06AspectJ\u7f16\u8bd1/weaver\u5f15\u5165\u4f60\u7684\u5f00\u53d1\u548c\u6784\u5efa\u8fc7\u7a0b\u3002\u5982\u679c\u4f60\u53ea\u9700\u8981\u9488\u5bf9Spring\u7684bean\u8fdb\u884cadvice\uff0cSpring AOP\u662f\u6b63\u786e\u7684\u9009\u62e9\u3002\u5982\u679c\u4f60\u60f3\u8981advice\u7684\u5bf9\u8c61\u6ca1\u6709\u88abSpring\u5bb9\u5668\u7ba1\u7406\uff08\u5982domain\u5bf9\u8c61\uff0cDTO\u7b49\uff09\uff0c\u4f60\u9700\u8981\u4f7f\u7528aspectJ\u3002\u5982\u679c\u4f60\u60f3\u57fa\u4e8e\u5b57\u6bb5\u6216\u8005\u8bbe\u7f6ejoin point\u7b49\u8fdb\u884cadvice\uff0c\u4e5f\u9700\u8981\u4f7f\u7528aspectJ\u3002</p> <p>\u5f53\u4f60\u4f7f\u7528AspectJ\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9AspectJ\u8bed\u6cd5\uff08\u7f16\u7a0b\u65b9\u5f0f\uff09\uff0c\u6216\u8005\u6ce8\u89e3\u98ce\u683c\u3002\u5982\u679caspect\u5728\u4f60\u7684\u8bbe\u8ba1\u4e2d\u8d77\u7740\u5f88\u5927\u7684\u4f5c\u7528\uff0c\u5e76\u4e14\u4f60\u80fd\u591f\u4f7f\u7528Eclipse\u7684AspectJ\u5f00\u53d1\u5de5\u5177(AJDT)\u63d2\u4ef6\uff0cAspectJ\u8bed\u8a00\u8bed\u6cd5\u662f\u9996\u9009\u3002\u5b83\u66f4\u5e72\u51c0\u3001\u66f4\u7b80\u5355\uff0c\u56e0\u4e3a\u8be5\u8bed\u8a00\u662f\u4e13\u95e8\u4e3a\u7f16\u5199aspect\u800c\u8bbe\u8ba1\u7684\u3002\u5982\u679c\u4f60\u4e0d\u4f7f\u7528Eclipse\uff0c\u6216\u8005\u53ea\u6709\u5c11\u6570\u51e0\u4e2a\u5728\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4e0d\u8d77\u4e3b\u8981\u4f5c\u7528\u7684\u65b9\u9762\uff0c\u4f60\u53ef\u80fd\u8981\u8003\u8651\u4f7f\u7528@AspectJ\u98ce\u683c\uff0c\u5728\u4f60\u7684IDE\u4e2d\u575a\u6301\u4f7f\u7528\u5e38\u89c4\u7684Java\u7f16\u8bd1\uff0c\u5e76\u5728\u4f60\u7684\u6784\u5efa\u811a\u672c\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u65b9\u9762\u7f16\u7ec7\u9636\u6bb5\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#562-aspectxml","title":"5.6.2 @Aspect\u6ce8\u89e3\u8fd8\u662fXML","text":"<p>\u80af\u5b9a\u6ce8\u89e3\u66f4\u65b9\u4fbf\u4e86\uff0c\u652f\u6301\u66f4\u4e30\u5bcc\u70b9\uff0c\u53ef\u4ee5\u7ec4\u5408pointcut\u3002\u8fd9\u91cc\u4e5f\u7565\u53bb\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#57-mixing-aspect-types","title":"5.7. Mixing Aspect Types","text":"<p>\u5728\u540c\u4e00\u4e2a\u914d\u7f6e\u4e2d\uff0c\u6df7\u5408\u4f7f\u7528\u81ea\u52a8\u4ee3\u7406\u652f\u6301\u3001xml\u5b9a\u4e49\u7684@AspectJ\u98ce\u683c\u7684\u5207\u9762\uff0c\u5176\u4ed6\u98ce\u683c\u7684\u4ee3\u7406\u548c\u62e6\u622a\uff0c\u8fd9\u4e9b\u90fd\u662f\u53ef\u4ee5\u7684\u3002\u6240\u6709\u8fd9\u4e9b\u90fd\u901a\u8fc7\u76f8\u540c\u7684\u5e95\u5c42\u652f\u6301\uff0c\u53ef\u4ee5\u6beb\u65e0\u56f0\u96be\u7684\u5171\u5b58\u3002</p>"},{"location":"java/spring/spring/spring-AOP/#58","title":"5.8 \u4ee3\u7406\u673a\u5236","text":"<p>Spring AOP uses either JDK dynamic proxies or CGLIB to create the proxy for a given target object. JDK dynamic proxies are built into the JDK, whereas CGLIB is a common open-source class definition library (repackaged into <code>spring-core</code>).</p> <p>If the target object to be proxied implements at least one interface, a JDK dynamic proxy is used. All of the interfaces implemented by the target type are proxied. If the target object does not implement any interfaces, a CGLIB proxy is created.</p> <p>Spring AOP\u4e0d\u4ec5\u4f7f\u7528JDK\u52a8\u6001\u4ee3\u7406\uff0c\u4e5f\u4f7f\u7528CGLIB\u6765\u4e3a\u76ee\u6807\u5bf9\u8c61\u521b\u9020\u4ee3\u7406\u3002JDK\u52a8\u6001\u4ee3\u7406\u6784\u5efa\u4e8eJDK\uff0cCGLIB\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u7c7b\u5b9a\u4e49\u5305\u3002</p> <p>\u5982\u679c\u76ee\u6807\u5bf9\u8c61\u5b9e\u73b0\u4e86\u81f3\u5c11\u4e00\u4e2a\u63a5\u53e3\uff0c\u5c31\u4f1a\u4f7f\u7528JDK\u52a8\u6001\u4ee3\u7406\u3002\u76ee\u6807\u7c7b\u5b9e\u73b0\u7684\u6240\u6709\u63a5\u53e3\u90fd\u4f1a\u88ab\u4ee3\u7406\u3002\u5982\u679c\u76ee\u6807\u7c7b\u6ca1\u6709\u5b9e\u73b0\u4efb\u4f55\u63a5\u53e3\uff0c\u5c31\u4f1a\u521b\u5efa\u4e00\u4e2aCGLIB\u4ee3\u7406\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u5f3a\u5236\u4f7f\u7528CGLIB\u4ee3\u7406\uff08\u4f8b\u5982\uff0c\u4ee3\u7406\u76ee\u6807\u7c7b\u7684\u6bcf\u4e2a\u65b9\u6cd5\uff0c\u800c\u4e0d\u4ec5\u662f\u5b9e\u73b0\u63a5\u53e3\u7684\u65b9\u6cd5\uff09\uff0c\u8fd9\u53ef\u4ee5\u505a\u5230\u3002\u4f46\u662f\u4f60\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u95ee\u9898\uff1a</p> <ul> <li>\u4f7f\u7528CGLIB\uff0cfinal\u65b9\u6cd5\u4e0d\u80fd\u88ab\u4ee3\u7406\uff0c\u56e0\u4e3a\u4ed6\u4eec\u4e0d\u80fd\u88ab\u8fd0\u884c\u65f6\u751f\u6210\u7684\u5b50\u7c7b\u91cd\u5199\u3002</li> <li>\u4eceSpring4.0\u5f00\u59cb\uff0c\u88ab\u4ee3\u7406\u7684\u5bf9\u8c61\u4e0d\u518d\u88ab\u8c03\u7528\u4e24\u6b21\uff0c\u56e0\u4e3aCGLIB\u4ee3\u7406\u7684\u5b9e\u4f8b\u662f\u901a\u8fc7Objenesis\u751f\u6210\u7684\u3002\u53ea\u6709\u5f53JVM\u4e0d\u5141\u8bb8\u7ed5\u8fc7\u6784\u9020\u51fd\u6570\u65f6\uff0c\u4f60\u624d\u4f1a\u770b\u5230Spring AOP\u7684\u4e24\u6b21\u8c03\u7528\u548cdebug\u65e5\u5fd7\u3002</li> </ul> <p>\u60f3\u8981\u5f3a\u5236\u4f7f\u7528CGLIB\u4ee3\u7406\uff0c\u8bbe\u7f6e<code>&lt;aop:config&gt;</code>\u7684<code>proxy-target-class</code>\u5c5e\u6027\u4e3atrue\uff0c\u5982\uff1a</p> <pre><code>&lt;aop:config proxy-target-class=\"true\"&gt;\n    &lt;!-- other beans defined here... --&gt;\n&lt;/aop:config&gt;\n</code></pre> <p>\u5f53\u4f7f\u7528@AspectJ\u81ea\u52a8\u4ee3\u7406\u65f6\uff0c\u53ef\u4ee5\u8bbe\u7f6e<code>&lt;aop:aspectj-autoproxy&gt;</code>\u7684\u5c5e\u6027<code>proxy-target-class</code>\u4e3atrue\uff0c\u5982</p> <pre><code>&lt;aop:aspectj-autoproxy proxy-target-class=\"true\"/&gt;\n</code></pre> <p>Multiple <code>&lt;aop:config/&gt;</code> sections are collapsed into a single unified auto-proxy creator at runtime, which applies the strongest proxy settings that any of the <code>&lt;aop:config/&gt;</code> sections (typically from different XML bean definition files) specified. This also applies to the <code>&lt;tx:annotation-driven/&gt;</code> and <code>&lt;aop:aspectj-autoproxy/&gt;</code> elements.</p> <p>To be clear, using <code>proxy-target-class=\"true\"</code> on <code>&lt;tx:annotation-driven/&gt;</code>, <code>&lt;aop:aspectj-autoproxy/&gt;</code>, or <code>&lt;aop:config/&gt;</code> elements forces the use of CGLIB proxies for all three of them.</p>"},{"location":"java/spring/spring/spring-AOP/#581-aop","title":"5.8.1 \u7406\u89e3AOP\u4ee3\u7406","text":"<p>\u5c31\u662f\u81ea\u6211\u8c03\u7528\u4e0d\u4f1a\u751f\u6548\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002\u7565\u53bb</p>"},{"location":"java/spring/spring/spring-AOP/#59-aspectj","title":"5.9 \u4ee3\u7801\u521b\u5efa@AspectJ\u4ee3\u7406","text":"<p>In addition to declaring aspects in your configuration by using either <code>&lt;aop:config&gt;</code> or <code>&lt;aop:aspectj-autoproxy&gt;</code>, it is also possible to programmatically create proxies that advise target objects. For the full details of Spring\u2019s AOP API, see the next chapter. Here, we want to focus on the ability to automatically create proxies by using @AspectJ aspects.</p> <p>You can use the <code>org.springframework.aop.aspectj.annotation.AspectJProxyFactory</code> class to create a proxy for a target object that is advised by one or more @AspectJ aspects. The basic usage for this class is very simple, as the following example shows:</p> <p>\u9664\u4e86\u4f7f\u7528<code>&lt;aop:config&gt;</code> or <code>&lt;aop:aspectj-autoproxy&gt;</code>\u6765\u58f0\u660e\u5207\u9762\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4ee3\u7801\u6765\u521b\u5efa\u4ee3\u7406\uff0cadvice\u76ee\u6807\u7c7b\u3002\u5173\u4e8espring API\u7684\u66f4\u591a\u7ec6\u8282\uff0c\u8bf7\u67e5\u770b\u4e0b\u4e00\u8282\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u53ea\u5173\u5fc3\u4f7f\u7528@AspectJ\u81ea\u52a8\u521b\u5efa\u4ee3\u7406\u7c7b\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528<code>org.springframework.aop.aspectj.annotation.AspectJProxyFactory</code>\u4e3a\u76ee\u6807\u5bf9\u8c61\u521b\u5efa\u4e00\u4e2a\u6216\u591a\u4e2a\u4ee3\u7406\uff0c\u8fd9\u4e2a\u7c7b\u7684\u57fa\u672c\u4f7f\u7528\u975e\u5e38\u7b80\u5355\uff0c\u5982\u4e0b\uff1a</p> <pre><code>// create a factory that can generate a proxy for the given target object\nAspectJProxyFactory factory = new AspectJProxyFactory(targetObject);\n\n// add an aspect, the class must be an @AspectJ aspect\n// you can call this as many times as you need with different aspects\nfactory.addAspect(SecurityManager.class);\n\n// you can also add existing aspect instances, the type of the object supplied must be an @AspectJ aspect\nfactory.addAspect(usageTracker);\n\n// now get the proxy object...\nMyInterfaceType proxy = factory.getProxy();\n</code></pre> <p>\u66f4\u591a\u7ec6\u8282\u67e5\u770b javadoc \u3002</p>"},{"location":"java/spring/spring/spring-AOP/#6-spring-aop-apis","title":"6. Spring AOP APIs","text":"<p>\u4e0a\u4e00\u4e2a\u7ae0\u8282\u4ecb\u7ecd\u4e86spring\u5bf9@AspectJ\u548c\u57fa\u4e8exml\u7684AOP\u652f\u6301\u3002\u5728\u672c\u7ae0\u8282\uff0c\u6211\u4eec\u8ba8\u8bba\u5e95\u5c42\u7684spring  AOP\u7684APIs\uff0c\u5bf9\u4e8e\u666e\u901a\u7684\u5e94\u7528\u6765\u8bf4\uff0c\u6211\u4eec\u5efa\u8bae\u4f7f\u7528\u4e0a\u4e00\u7ae0\u8282\u4ecb\u7ecd\u7684\u57fa\u4e8eAspectJ\u7684spring AOP\u3002</p>"},{"location":"java/spring/spring/spring-core/","title":"Spring core","text":"<p>This part of the reference documentation covers all the technologies that are absolutely integral to the Spring Framework.</p> <p>Foremost amongst these is the Spring Framework\u2019s Inversion of Control (IoC) container. A thorough treatment of the Spring Framework\u2019s IoC container is closely followed by comprehensive coverage of Spring\u2019s Aspect-Oriented Programming (AOP) technologies. The Spring Framework has its own AOP framework, which is conceptually easy to understand and which successfully addresses the 80% sweet spot of AOP requirements in Java enterprise programming.</p> <p>Coverage of Spring\u2019s integration with AspectJ (currently the richest\u2009\u2014\u2009in terms of features\u2009\u2014\u2009and certainly most mature AOP implementation in the Java enterprise space) is also provided.</p> <p>\u672c\u7bc7\u53c2\u8003\u6587\u6863\u6db5\u76d6\u4e86spring\u6846\u67b6\u6240\u6709\u7edd\u5bf9\u5fc5\u8981\u7684\u6280\u672f\u3002</p> <p>Spring\u6846\u67b6\u4e2d\u6700\u91cd\u8981\u7684\u662fInversion of Control (IoC) container\u3002spring\u662f\u9762\u5411\u65b9\u6cd5\u7684AOP\u6846\u67b6\uff0c\u5b83\u5f88\u5bb9\u6613\u7406\u89e3\uff0c\u5e76\u4e14\u8986\u76d6\u4e86\u4f01\u4e1a\u5f00\u53d1\u4e2d80%\u7684\u573a\u666f\uff0c\u540c\u65f6\u8fd8\u8986\u76d6\u4e86Spring\u4e0eAspectJ\uff08\u76ee\u524dJava\u4f01\u4e1a\u9886\u57df\u6700\u4e30\u5bcc--\u529f\u80fd\u6700\u4e30\u5bcc--\u5f53\u7136\u4e5f\u662f\u6700\u6210\u719f\u7684AOP\u5b9e\u73b0\uff09\u7684\u96c6\u6210\u3002</p> <p>\u672c\u6587\u6e90\u81ea\u5b98\u65b9\u6587\u6863Spring-Core\u3002</p>"},{"location":"java/spring/spring-boot/GettingStarted/","title":"1. Spring boot\u4ecb\u7ecd","text":"<p>Spring Boot\u5e2e\u52a9\u60a8\u521b\u5efa\u53ef\u4ee5\u7acb\u5373\u8fd0\u884c\uff0c\u72ec\u7acb\u7684\u3001\u57fa\u4e8eSpring\u7684\u751f\u4ea7\u7ea7\u5e94\u7528\u7a0b\u5e8f\u3002\u6211\u4eec\u5bf9Spring\u5e73\u53f0\u548c\u7b2c\u4e09\u65b9\u5e93\u6709\u81ea\u5df1\u7684\u770b\u6cd5\uff0c\u8fd9\u6837\u60a8\u5c31\u53ef\u4ee5\u4ee5\u6700\u5c11\u7684\u9ebb\u70e6\u4e0a\u624b\u3002\u5927\u591a\u6570Spring Boot\u5e94\u7528\u7a0b\u5e8f\u53ea\u9700\u8981\u5f88\u5c11\u7684Spring\u914d\u7f6e\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528Spring Boot\u6765\u521b\u5efaJava\u5e94\u7528\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528<code>java -jar</code>\u6216\u66f4\u4f20\u7edf\u7684war\u5305\u6765\u542f\u52a8\u3002\u6211\u4eec\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u8fd0\u884c \"spring\u811a\u672c \"\u7684\u547d\u4ee4\u884c\u5de5\u5177\u3002</p> <p>\u6211\u4eec\u7684\u4e3b\u8981\u76ee\u6807\u662f</p> <ul> <li> <p>\u4e3a\u6240\u6709\u7684Spring\u5f00\u53d1\u63d0\u4f9b\u66f4\u5feb\u3001\u66f4\u5e7f\u6cdb\u7684\u5165\u95e8\u4f53\u9a8c\u3002</p> </li> <li> <p>\u5f00\u7bb1\u5373\u7528\uff0c\u4f46\u5f53\u9700\u6c42\u4e0e\u9ed8\u8ba4\u503c\u76f8\u5de6\u65f6\uff0c\u6211\u4eec\u4f1a\u8fc5\u901f\u9000\u51fa\u3002</p> </li> <li> <p>\u63d0\u4f9b\u4e00\u7cfb\u5217\u5927\u7c7b\u9879\u76ee\u5e38\u89c1\u7684\u975e\u529f\u80fd\u7279\u6027\uff08\u5982\u5d4c\u5165\u5f0f\u670d\u52a1\u5668\u3001\u5b89\u5168\u3001\u5ea6\u91cf\u3001\u5065\u5eb7\u68c0\u67e5\u548c\u5916\u90e8\u5316\u914d\u7f6e\uff09\u3002</p> </li> <li> <p>\u5b8c\u5168\u4e0d\u9700\u8981\u751f\u6210\u4ee3\u7801\uff0c\u4e0d\u9700\u8981XML\u914d\u7f6e\u3002</p> </li> </ul> <p><code>spring-boot-starter-parent</code>\u662f\u4e00\u4e2a\u7279\u6b8a\u7684starter\uff0c\u63d0\u4f9b\u4e86\u6709\u7528\u7684maven\u9ed8\u8ba4\u914d\u7f6e\uff0c\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5e38\u89c1\u4f9d\u8d56\u7684\u7248\u672c\u7ba1\u7406\uff0c\u4f7f\u5f97\u4f60\u53ef\u4ee5\u5728\u6dfb\u52a0\u4e00\u4e9b\u4f9d\u8d56\u65f6\u7701\u7565\u7248\u672c\u58f0\u660e\u3002</p> <p>Auto-configuration\u662f\u4e3a\u4e86\u4e0e \"Starters \"\u5f88\u597d\u5730\u914d\u5408\uff0c\u4f46\u8fd9\u4e24\u4e2a\u6982\u5ff5\u5e76\u4e0d\u76f4\u63a5\u6302\u94a9\u3002\u4f60\u53ef\u4ee5\u81ea\u7531\u9009\u62e9 starters \u4ee5\u5916\u7684 jar \u4f9d\u8d56\u3002Spring Boot\u4ecd\u7136\u4f1a\u5c3d\u529b\u81ea\u52a8\u914d\u7f6e\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>spring-boot-maven-plugin\u63d2\u4ef6\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u91cd\u65b0\u6253\u5305jar\uff0c\u6253\u5305\u4e3a\u53ef\u6267\u884cjar\u53c8\u79f0\u4e3afat jars\uff0c\u5b83\u5305\u542b\u4e86\u4f60\u7684\u4ee3\u7801\u548c\u4ee3\u7801\u8fd0\u884c\u6240\u9700\u7684\u5176\u4ed6\u4f9d\u8d56jar\u3002</p>"},{"location":"java/spring/spring-boot/GettingStarted/#2","title":"2. \u7cfb\u7edf\u8981\u6c42","text":"<p>Maven    3.3+</p> <p>Gradle     6</p> <p>Tomcat9.0    4.0 </p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/","title":"UsingSpringBoot","text":"<p>\u672c\u8282\u5c06\u66f4\u8be6\u7ec6\u5730\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528Spring Boot\u3002\u5b83\u6db5\u76d6\u4e86\u8bf8\u5982\u6784\u5efa\u7cfb\u7edf\u3001\u81ea\u52a8\u914d\u7f6e\u4ee5\u53ca\u5982\u4f55\u8fd0\u884c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u7b49\u4e3b\u9898\u3002\u6211\u4eec\u8fd8\u4ecb\u7ecd\u4e86\u4e00\u4e9bSpring Boot\u7684\u6700\u4f73\u5b9e\u8df5\u3002\u867d\u7136Spring Boot\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u7684\u5730\u65b9\uff08\u5b83\u53ea\u662f\u53e6\u4e00\u4e2a\u60a8\u53ef\u4ee5\u4f9d\u8d56\u7684\u5e93\uff09\uff0c\u4f46\u6709\u4e00\u4e9b\u5efa\u8bae\uff0c\u5982\u679c\u9075\u5faa\u4f1a\u8ba9\u60a8\u7684\u5f00\u53d1\u8fc7\u7a0b\u53d8\u5f97\u66f4\u5bb9\u6613\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#1-build-systems","title":"1. Build Systems","text":""},{"location":"java/spring/spring-boot/UsingSpringBoot/#11","title":"1.1 \u4f9d\u8d56\u7ba1\u7406","text":"<p>Spring Boot \u7684\u6bcf\u4e2a\u7248\u672c\u90fd\u63d0\u4f9b\u4e86\u5b83\u6240\u652f\u6301\u7684\u4f9d\u8d56\u9879\u7684\u7cbe\u9009\u5217\u8868\u3002\u5b9e\u9645\u4e0a\uff0c\u60a8\u4e0d\u9700\u8981\u5728\u6784\u5efa\u914d\u7f6e\u4e2d\u4e3a\u8fd9\u4e9b\u4f9d\u8d56\u9879\u63d0\u4f9b\u7248\u672c\uff0c\u56e0\u4e3aSpring Boot\u4e3a\u60a8\u7ba1\u7406\u8fd9\u4e9b\u4f9d\u8d56\u9879\u3002\u5f53\u60a8\u5347\u7ea7Spring Boot\u672c\u8eab\u65f6\uff0c\u8fd9\u4e9b\u4f9d\u8d56\u9879\u4e5f\u4f1a\u4ee5\u4e00\u81f4\u7684\u65b9\u5f0f\u5347\u7ea7\u3002</p> <p>\u5982\u679c\u60a8\u9700\u8981\u7684\u8bdd\uff0c\u60a8\u4ecd\u7136\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u7248\u672c\u5e76\u8986\u76d6Spring Boot\u7684\u5efa\u8bae\u3002</p> <p>Spring Boot\u7684\u6bcf\u4e2a\u7248\u672c\u90fd\u4e0eSpring\u6846\u67b6\u7684\u57fa\u7840\u7248\u672c\u76f8\u5173\u8054\u3002\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u60a8\u4e0d\u8981\u6307\u5b9a\u5176\u7248\u672c\u3002</p> <p>\u7b56\u5212\u5217\u8868\u5305\u542b\u60a8\u53ef\u4ee5\u4e0eSpring Boot\u4e00\u8d77\u4f7f\u7528\u7684\u6240\u6709Spring\u6a21\u5757\uff0c\u4ee5\u53ca\u7b2c\u4e09\u65b9\u5e93\u7684\u7cbe\u7b80\u5217\u8868\u3002\u8be5\u5217\u8868\u4ee5\u6807\u51c6\u7269\u6599\u6e05\u5355\uff08spring-boot-dependencies\uff09\u7684\u5f62\u5f0f\u63d0\u4f9b\uff0c\u53ef\u7528\u4e8e Maven \u548c Gradle\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#12-maven","title":"1.2 Maven","text":"<p>\u4e0b\u9762\u7684\u6587\u6863\u8be6\u7ec6\u4ecb\u7ecd\u4e86\u5982\u4f55\u5728Spring Boot\u4e2d\u4f7f\u7528Maven </p> <p>https://docs.spring.io/spring-boot/docs/2.4.1/maven-plugin/reference/htmlsingle/</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#15-starters","title":"1.5 Starters","text":"<p>Starters\u662f\u4e00\u7ec4\u65b9\u4fbf\u7684\u4f9d\u8d56\u5173\u7cfb\u63cf\u8ff0\uff0c\u60a8\u53ef\u4ee5\u5c06\u5176\u5305\u542b\u5728\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u3002\u60a8\u53ef\u4ee5\u83b7\u5f97\u4e00\u7ad9\u5f0f\u670d\u52a1\uff0c\u4ee5\u83b7\u5f97\u60a8\u6240\u9700\u8981\u7684\u6240\u6709Spring\u548c\u76f8\u5173\u6280\u672f\uff0c\u800c\u65e0\u9700\u5728\u793a\u4f8b\u4ee3\u7801\u4e2d\u5bfb\u627e\u548c\u590d\u5236\u7c98\u8d34\u5927\u91cf\u7684\u4f9d\u8d56\u5173\u7cfb\u63cf\u8ff0\u7b26\u3002\u4f8b\u5982\u5982\u679c\u60a8\u60f3\u5f00\u59cb\u4f7f\u7528Spring\u548cJPA\u8fdb\u884c\u6570\u636e\u5e93\u8bbf\u95ee\uff0c\u8bf7\u5728\u60a8\u7684\u9879\u76ee\u4e2d\u5305\u542bspring-boot-starter-data-jpa\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u542f\u52a8\u7a0b\u5e8f\u5305\u542b\u4e86\u5f88\u591a\u4f60\u9700\u8981\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u8fd9\u4e9b\u4f9d\u8d56\u5173\u7cfb\u53ef\u4ee5\u8ba9\u9879\u76ee\u5feb\u901f\u542f\u52a8\u548c\u8fd0\u884c\uff0c\u5e76\u4e14\u6709\u4e00\u5957\u4e00\u81f4\u7684\u3001\u53d7\u652f\u6301\u7684\u7ba1\u7406\u7684\u8f6c\u4e49\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u5173\u4e8e\u81ea\u5b9a\u4e49starter\u7684\u547d\u540d</p> <p>\u6240\u6709\u5b98\u65b9\u542f\u52a8\u7a0b\u5e8f\u90fd\u9075\u5faa\u7c7b\u4f3c\u7684\u547d\u540d\u6a21\u5f0f\uff1b<code>spring-boot-starter-*</code>\uff0c\u5176\u4e2d*\u662f\u4e00\u79cd\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u7c7b\u578b\u3002\u8fd9\u79cd\u547d\u540d\u7ed3\u6784\u662f\u4e3a\u4e86\u5728\u4f60\u9700\u8981\u5bfb\u627e\u542f\u52a8\u7a0b\u5e8f\u65f6\u63d0\u4f9b\u5e2e\u52a9\u3002\u8bb8\u591aIDE\u4e2d\u7684Maven\u96c6\u6210\u53ef\u4ee5\u8ba9\u4f60\u901a\u8fc7\u540d\u79f0\u641c\u7d22\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u6b63\u5982\u5728 \"\u521b\u5efa\u60a8\u81ea\u5df1\u7684\u542f\u52a8\u5668 \"\u4e00\u8282\u4e2d\u6240\u89e3\u91ca\u7684\u90a3\u6837\uff0c\u7b2c\u4e09\u65b9\u542f\u52a8\u5668\u4e0d\u5e94\u8be5\u4ee5spring-boot\u5f00\u5934\uff0c\u56e0\u4e3a\u5b83\u662f\u4e3a\u5b98\u65b9\u7684Spring Boot\u6784\u4ef6\u4fdd\u7559\u7684\u3002\u76f8\u53cd\uff0c\u7b2c\u4e09\u65b9\u542f\u52a8\u7a0b\u5e8f\u901a\u5e38\u4ee5\u9879\u76ee\u540d\u79f0\u5f00\u5934\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u540d\u4e3a<code>thirdpartyproject</code>\u7684\u7b2c\u4e09\u65b9\u542f\u52a8\u9879\u76ee\u901a\u5e38\u4f1a\u88ab\u547d\u540d\u4e3a<code>thirdpartyproject-spring-boot-starter</code>\u3002</p> Name Description <code>spring-boot-starter</code> Core starter, including auto-configuration support, logging and YAML <code>spring-boot-starter-activemq</code> Starter for JMS messaging using Apache ActiveMQ <code>spring-boot-starter-amqp</code> Starter for using Spring AMQP and Rabbit MQ <code>spring-boot-starter-aop</code> Starter for aspect-oriented programming with Spring AOP and AspectJ <code>spring-boot-starter-cache</code> Starter for using Spring Framework\u2019s caching support <code>spring-boot-starter-data-cassandra</code> Starter for using Cassandra distributed database and Spring Data Cassandra <code>spring-boot-starter-data-cassandra-reactive</code> Starter for using Cassandra distributed database and Spring Data Cassandra Reactive <code>spring-boot-starter-data-couchbase</code> Starter for using Couchbase document-oriented database and Spring Data Couchbase <code>spring-boot-starter-data-elasticsearch</code> Starter for using Elasticsearch search and analytics engine and Spring Data Elasticsearch <code>spring-boot-starter-data-jdbc</code> Starter for using Spring Data JDBC <code>spring-boot-starter-data-jpa</code> Starter for using Spring Data JPA with Hibernate <code>spring-boot-starter-data-mongodb</code> Starter for using MongoDB document-oriented database and Spring Data MongoDB <code>spring-boot-starter-data-r2dbc</code> Starter for using Spring Data R2DBC <code>spring-boot-starter-data-redis</code> Starter for using Redis key-value data store with Spring Data Redis and the Lettuce client <code>spring-boot-starter-data-redis-reactive</code> Starter for using Redis key-value data store with Spring Data Redis reactive and the Lettuce client <code>spring-boot-starter-data-rest</code> Starter for exposing Spring Data repositories over REST using Spring Data REST <code>spring-boot-starter-data-solr</code> Starter for using the Apache Solr search platform with Spring Data Solr <code>spring-boot-starter-freemarker</code> Starter for building MVC web applications using FreeMarker views <code>spring-boot-starter-jdbc</code> Starter for using JDBC with the HikariCP connection pool <code>spring-boot-starter-json</code> Starter for reading and writing json <code>spring-boot-starter-jta-bitronix</code> Starter for JTA transactions using Bitronix. Deprecated since 2.3.0 <code>spring-boot-starter-mail</code> Starter for using Java Mail and Spring Framework\u2019s email sending support <code>spring-boot-starter-mustache</code> Starter for building web applications using Mustache views <code>spring-boot-starter-oauth2-client</code> Starter for using Spring Security\u2019s OAuth2/OpenID Connect client features <code>spring-boot-starter-oauth2-resource-server</code> Starter for using Spring Security\u2019s OAuth2 resource server features <code>spring-boot-starter-quartz</code> Starter for using the Quartz scheduler <code>spring-boot-starter-security</code> Starter for using Spring Security <code>spring-boot-starter-test</code> Starter for testing Spring Boot applications with libraries including JUnit Jupiter, Hamcrest and Mockito <code>spring-boot-starter-thymeleaf</code> Starter for building MVC web applications using Thymeleaf views <code>spring-boot-starter-validation</code> Starter for using Java Bean Validation with Hibernate Validator <code>spring-boot-starter-web</code> Starter for building web, including RESTful, applications using Spring MVC. Uses Tomcat as the default embedded container <code>spring-boot-starter-webflux</code> Starter for building WebFlux applications using Spring Framework\u2019s Reactive Web support <code>spring-boot-starter-websocket</code> Starter for building WebSocket applications using Spring Framework\u2019s WebSocket support Name Description <code>spring-boot-starter-jetty</code> Starter for using Jetty as the embedded servlet container. An alternative to <code>spring-boot-starter-tomcat</code> <code>spring-boot-starter-log4j2</code> Starter for using Log4j2 for logging. An alternative to <code>spring-boot-starter-logging</code> <code>spring-boot-starter-logging</code> Starter for logging using Logback. Default logging starter <code>spring-boot-starter-reactor-netty</code> Starter for using Reactor Netty as the embedded reactive HTTP server. <code>spring-boot-starter-tomcat</code> Starter for using Tomcat as the embedded servlet container. Default servlet container starter used by <code>spring-boot-starter-web</code> <code>spring-boot-starter-undertow</code> Starter for using Undertow as the embedded servlet container. An alternative to <code>spring-boot-starter-tomcat</code>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#2","title":"2. \u7ec4\u7ec7\u4f60\u7684\u4ee3\u7801","text":"<p>spring\u4e0d\u8981\u6c42\u4efb\u4f55\u7279\u6b8a\u7684\u4ee3\u7801\u76ee\u5f55\u7ed3\u6784\uff0c\u4f46\u662f\u6709\u4e00\u4e9b\u6700\u4f73\u5b9e\u8df5\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#21-default-package","title":"2.1 default package","text":"<p>\u5f53\u4e00\u4e2a\u7c7b\u6ca1\u6709\u5305\u542b\u5305\u58f0\u660e\u65f6\uff0c\u5b83\u88ab\u8ba4\u4e3a\u662f\u5728 \"\u9ed8\u8ba4\u5305 \"\u4e2d\u3002\u4e00\u822c\u4e0d\u9f13\u52b1\u4f7f\u7528 \"\u9ed8\u8ba4\u5305\"\uff0c\u5e94\u8be5\u907f\u514d\u4f7f\u7528\u3002\u5bf9\u4e8e\u4f7f\u7528@ComponentScan\u3001@ConfigurationPropertiesScan\u3001@EntityScan\u6216@SpringBootApplication\u6ce8\u89e3\u7684Spring Boot\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5b83\u53ef\u80fd\u4f1a\u5f15\u8d77\u7279\u522b\u7684\u95ee\u9898\uff0c\u56e0\u4e3a\u6bcf\u4e2ajar\u4e2d\u7684\u6bcf\u4e2a\u7c7b\u90fd\u4f1a\u88ab\u8bfb\u53d6\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#22-main","title":"2.2 \u5b9a\u4f4d\u5e94\u7528main\u4e3b\u7c7b","text":"<p>We generally recommend that you locate your main application class in a root package above other classes. The <code>@SpringBootApplication</code> annotation is often placed on your main class, and it implicitly defines a base \u201csearch package\u201d for certain items. For example, if you are writing a JPA application, the package of the <code>@SpringBootApplication</code> annotated class is used to search for <code>@Entity</code> items. Using a root package also allows component scan to apply only on your project.</p> <p>If you don\u2019t want to use <code>@SpringBootApplication</code>, the <code>@EnableAutoConfiguration</code> and <code>@ComponentScan</code> annotations that it imports defines that behaviour so you can also use those instead.</p> <p>\u6211\u4eec\u4e00\u822c\u5efa\u8bae\u4f60\u5c06\u4e3b\u5e94\u7528\u7c7b\u653e\u5728\u4e00\u4e2a\u9ad8\u4e8e\u5176\u4ed6\u7c7b\u7684root\u5305\u4e2d\u3002@SpringBootApplication\u6ce8\u89e3\u901a\u5e38\u653e\u5728\u4f60\u7684\u4e3b\u7c7b\u4e0a\uff0c\u5b83\u9690\u542b\u5730\u5b9a\u4e49\u4e86\u67d0\u4e9b\u9879\u7684\u57fa\u7840 \"\u641c\u7d22\u5305\"\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u6b63\u5728\u7f16\u5199\u4e00\u4e2aJPA\u5e94\u7528\u7a0b\u5e8f\uff0c@SpringBootApplication\u6ce8\u89e3\u7c7b\u7684\u5305\u5c31\u4f1a\u88ab\u7528\u6765\u641c\u7d22@Entity\u9879\u3002\u4f7f\u7528\u6839\u5305\u8fd8\u53ef\u4ee5\u8ba9\u7ec4\u4ef6\u626b\u63cf\u53ea\u5e94\u7528\u5728\u4f60\u7684\u9879\u76ee\u4e0a\u3002</p> <p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528<code>@SpringBootApplication</code>\uff0c\u5b83\u5bfc\u5165\u7684<code>@EnableAutoConfiguration</code>\u548c<code>@ComponentScan</code>\u6ce8\u89e3\u5b9a\u4e49\u4e86\u8fd9\u79cd\u884c\u4e3a\uff0c\u6240\u4ee5\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6765\u4ee3\u66ff\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u5178\u578b\u7684\u4ee3\u7801\u5e03\u5c40\uff1a</p> <pre><code>com\n +- example\n     +- myapplication\n         +- Application.java\n         |\n         +- customer\n         |   +- Customer.java\n         |   +- CustomerController.java\n         |   +- CustomerService.java\n         |   +- CustomerRepository.java\n         |\n         +- order\n             +- Order.java\n             +- OrderController.java\n             +- OrderService.java\n             +- OrderRepository.java\n</code></pre>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#3","title":"3. \u914d\u7f6e\u7c7b","text":"<p>Spring Boot\u503e\u5411\u4e8e\u4f7f\u7528\u57fa\u4e8eJava\u7684\u914d\u7f6e\u3002\u5c3d\u7ba1\u53ef\u4ee5\u4f7f\u7528SpringApplication\u4e0eXML\u6e90\uff0c\u4f46\u6211\u4eec\u901a\u5e38\u5efa\u8bae\u4f60\u7684\u4e3b\u8981\u6e90\u662f\u4e00\u4e2a@Configuration\u7c7b\u3002\u901a\u5e38\uff0c\u5b9a\u4e49\u4e3b\u65b9\u6cd5\u7684\u7c7b\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u5019\u9009\u4eba\uff0c\u4f5c\u4e3a\u4e3b\u8981\u7684@Configuration\u3002</p> <p>\u4e92\u8054\u7f51\u4e0a\u5df2\u7ecf\u53d1\u5e03\u4e86\u8bb8\u591a\u4f7f\u7528XML\u914d\u7f6e\u7684Spring\u914d\u7f6e\u793a\u4f8b\u3002\u5982\u679c\u53ef\u80fd\u7684\u8bdd\uff0c\u603b\u662f\u5c3d\u91cf\u4f7f\u7528\u7b49\u4ef7\u7684\u57fa\u4e8eJava\u7684\u914d\u7f6e\u3002\u641c\u7d22Enable*\u6ce8\u89e3\u53ef\u4ee5\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u8d77\u70b9\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#31","title":"3.1 \u5bfc\u5165\u989d\u5916\u914d\u7f6e\u7c7b","text":"<p>\u4f60\u4e0d\u9700\u8981\u628a\u6240\u6709\u7684@Configuration\u653e\u5230\u4e00\u4e2a\u7c7b\u4e2d\u3002\u53ef\u4ee5\u4f7f\u7528@Import\u6ce8\u89e3\u6765\u5bfc\u5165\u989d\u5916\u7684\u914d\u7f6e\u7c7b\u3002\u53e6\u5916\uff0c\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528@ComponentScan\u6765\u81ea\u52a8\u62fe\u53d6\u6240\u6709Spring\u7ec4\u4ef6\uff0c\u5305\u62ec@Configuration\u7c7b\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#32-xml","title":"3.2 \u5bfc\u5165XML\u914d\u7f6e","text":"<p>\u5982\u679c\u4f60\u5fc5\u987b\u4f7f\u7528\u57fa\u4e8eXML\u7684\u914d\u7f6e\uff0c\u6211\u4eec\u5efa\u8bae\u4f60\u8fd8\u662f\u4ece\u4e00\u4e2a@Configuration\u7c7b\u5f00\u59cb\u3002\u7136\u540e\u4f60\u53ef\u4ee5\u4f7f\u7528@ImportResource\u6ce8\u89e3\u6765\u52a0\u8f7dXML\u914d\u7f6e\u6587\u4ef6\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#4","title":"4. \u81ea\u52a8\u914d\u7f6e","text":"<p>Spring Boot \u81ea\u52a8\u914d\u7f6e\u8bd5\u56fe\u6839\u636e\u60a8\u6dfb\u52a0\u7684 jar \u4f9d\u8d56\u5173\u7cfb\u81ea\u52a8\u914d\u7f6e\u60a8\u7684 Spring \u5e94\u7528\u7a0b\u5e8f\u3002\u4f8b\u5982\uff0c\u5982\u679cHSQLDB\u5728\u60a8\u7684classpath\u4e0a\uff0c\u5e76\u4e14\u60a8\u6ca1\u6709\u624b\u52a8\u914d\u7f6e\u4efb\u4f55\u6570\u636e\u5e93\u8fde\u63a5Bean\uff0c\u90a3\u4e48Spring Boot\u4f1a\u81ea\u52a8\u914d\u7f6e\u5185\u5b58\u6570\u636e\u5e93\u3002</p> <p>\u60a8\u9700\u8981\u901a\u8fc7\u5411\u60a8\u7684\u4e00\u4e2a@Configuration\u7c7b\u6dfb\u52a0@EnableAutoConfiguration\u6216@SpringBootApplication\u6ce8\u89e3\u6765\u9009\u62e9\u52a0\u5165\u81ea\u52a8\u914d\u7f6e\u3002</p> <p>\u60a8\u5e94\u8be5\u53ea\u6dfb\u52a0\u4e00\u4e2a@SpringBootApplication\u6216@EnableAutoConfiguration\u6ce8\u89e3\u3002\u6211\u4eec\u901a\u5e38\u5efa\u8bae\u60a8\u53ea\u5c06\u5176\u4e2d\u4e00\u4e2a\u6216\u53e6\u4e00\u4e2a\u6dfb\u52a0\u5230\u60a8\u7684\u4e3b @Configuration \u7c7b\u4e2d\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#41","title":"4.1 \u66ff\u6362\u81ea\u52a8\u914d\u7f6e","text":"<p>\u81ea\u52a8\u914d\u7f6e\u662f\u975e\u4fb5\u5165\u6027\u7684\u3002\u5728\u4efb\u4f55\u65f6\u5019\uff0c\u4f60\u90fd\u53ef\u4ee5\u5f00\u59cb\u5b9a\u4e49\u81ea\u5df1\u7684\u914d\u7f6e\u6765\u66ff\u6362\u81ea\u52a8\u914d\u7f6e\u7684\u7279\u5b9a\u90e8\u5206\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u6dfb\u52a0\u4e86\u81ea\u5df1\u7684DataSource bean\uff0c\u9ed8\u8ba4\u7684\u5d4c\u5165\u5f0f\u6570\u636e\u5e93\u652f\u6301\u5c31\u4f1a\u9000\u7f29\u3002</p> <p>\u5982\u679c\u4f60\u9700\u8981\u627e\u51fa\u5f53\u524d\u6b63\u5728\u5e94\u7528\u7684\u81ea\u52a8\u914d\u7f6e\uff0c\u4ee5\u53ca\u4e3a\u4ec0\u4e48\uff0c\u8bf7\u4f7f\u7528<code>--debug</code>\u5f00\u5173\u542f\u52a8\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u4e3a\u9009\u5b9a\u7684\u6838\u5fc3\u8bb0\u5f55\u5668\u542f\u7528\u8c03\u8bd5\u65e5\u5fd7\uff0c\u5e76\u5c06\u6761\u4ef6\u62a5\u544a\u8bb0\u5f55\u5230\u63a7\u5236\u53f0\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#42","title":"4.2 \u7981\u7528\u81ea\u52a8\u914d\u7f6e","text":"<p>\u5982\u679c\u4f60\u53d1\u73b0\u4f60\u4e0d\u60f3\u8981\u7684\u7279\u5b9a\u81ea\u52a8\u914d\u7f6e\u7c7b\u88ab\u5e94\u7528\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528@SpringBootApplication\u7684exclude\u5c5e\u6027\u6765\u7981\u7528\u5b83\u4eec\uff0c\u5982\u4e0b\u4f8b\u6240\u793a:</p> <pre><code>import org.springframework.boot.autoconfigure.*;\nimport org.springframework.boot.autoconfigure.jdbc.*;\n\n@SpringBootApplication(exclude={DataSourceAutoConfiguration.class})\npublic class MyApplication {\n}\n</code></pre> <p>\u5982\u679c\u8be5\u7c7b\u4e0d\u5728classpath\u4e0a\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6ce8\u89e3\u7684<code>excludeName</code>\u5c5e\u6027\u5e76\u6307\u5b9a\u5b8c\u5168\u9650\u5b9a\u7684\u540d\u79f0\u3002\u5982\u679c\u60a8\u559c\u6b22\u4f7f\u7528 <code>@EnableAutoConfiguration</code> \u800c\u4e0d\u662f <code>@SpringBootApplication</code>\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>exclude</code> \u548c <code>excludeName</code>\u3002\u6700\u540e\uff0c\u60a8\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528<code>spring.autoconfigure.exclude</code>\u5c5e\u6027\u6765\u63a7\u5236\u8981\u6392\u9664\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\u7684\u5217\u8868\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#5-spring-bean","title":"5. spring Bean\u548c\u4f9d\u8d56\u6ce8\u5165","text":"<p>\u60a8\u53ef\u4ee5\u81ea\u7531\u4f7f\u7528\u4efb\u4f55\u6807\u51c6\u7684Spring\u6846\u67b6\u6280\u672f\u6765\u5b9a\u4e49\u60a8\u7684Bean\u53ca\u5176\u6ce8\u5165\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u6211\u4eec\u7ecf\u5e38\u53d1\u73b0\uff0c\u4f7f\u7528@ComponentScan\uff08\u67e5\u627e\u60a8\u7684bean\uff09\u548c\u4f7f\u7528@Autowired\uff08\u8fdb\u884c\u6784\u9020\u51fd\u6570\u6ce8\u5165\uff09\u6548\u679c\u4e0d\u9519\u3002</p> <p>\u5982\u679c\u60a8\u6309\u7167\u4e0a\u9762\u7684\u5efa\u8bae\u6765\u7ec4\u7ec7\u60a8\u7684\u4ee3\u7801\uff08\u5c06\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u7c7b\u5b9a\u4f4d\u5728\u4e00\u4e2a root package\u4e2d\uff09\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6ca1\u6709\u4efb\u4f55\u53c2\u6570\u7684<code>@ComponentScan</code>\u3002\u60a8\u7684\u6240\u6709\u5e94\u7528\u7ec4\u4ef6\uff08@Component\u3001@Service\u3001@Repository\u3001@Controller\u7b49\uff09\u90fd\u4f1a\u81ea\u52a8\u6ce8\u518c\u4e3aSpring Beans\u3002</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u4e00\u4e2a@Service Bean\uff0c\u5b83\u4f7f\u7528\u6784\u9020\u51fd\u6570\u6ce8\u5165\u6765\u83b7\u53d6\u4e00\u4e2a\u6240\u9700\u7684RiskAssessor Bean\u3002</p> <pre><code>@Service\npublic class DatabaseAccountService implements AccountService {\n\n    private final RiskAssessor riskAssessor;\n\n    @Autowired\n    public DatabaseAccountService(RiskAssessor riskAssessor) {\n        this.riskAssessor = riskAssessor;\n    }\n\n    // ...\n\n}\n</code></pre> <p>\u5982\u679cBean\u53ea\u6709\u4e00\u4e2a\u6784\u9020\u5668\uff0c\u53ef\u4ee5\u7701\u7565<code>@Autowired</code>\uff1a</p> <pre><code>@Service\npublic class DatabaseAccountService implements AccountService {\n\n    private final RiskAssessor riskAssessor;\n\n    public DatabaseAccountService(RiskAssessor riskAssessor) {\n        this.riskAssessor = riskAssessor;\n    }\n\n    // ...\n}\n</code></pre> <p>\u8bf7\u6ce8\u610f\uff0c\u4f7f\u7528\u6784\u9020\u51fd\u6570\u6ce8\u5165\u65f6\u8ba9 riskAssessor \u5b57\u6bb5\u88ab\u6807\u8bb0\u4e3a <code>final</code>\uff0c\u8868\u660e\u5b83\u4e0d\u80fd\u88ab\u968f\u540e\u66f4\u6539\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#6-springbootapplication","title":"6. \u4f7f\u7528@SpringBootApplication","text":"<p>@SpringBootApplication\u6709\u4e09\u4e2a\u7279\u6027\uff1a</p> <ul> <li><code>@EnableAutoConfiguration</code>: \u5f00\u542f\u81ea\u52a8\u914d\u7f6e Spring Boot\u2019s auto-configuration mechanism</li> <li><code>@ComponentScan</code>: enable <code>@Component</code> scan on the package where the application is located </li> <li><code>@Configuration</code>: \u5141\u8bb8\u6ce8\u518c\u5176\u4ed6\u7684Bean</li> </ul> <pre><code>@SpringBootApplication // same as @Configuration @EnableAutoConfiguration @ComponentScan\npublic class Application {\n\n    public static void main(String[] args) {\n        SpringApplication.run(Application.class, args);\n    }\n\n}\n</code></pre>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#8-developer-tools","title":"8. Developer Tools","text":"<pre><code>&lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;\n        &lt;optional&gt;true&lt;/optional&gt;\n    &lt;/dependency&gt;\n&lt;/dependencies&gt;\n</code></pre> <p>\u5f53\u8fd0\u884c\u4e00\u4e2a\u5b8c\u5168\u6253\u5305\u7684\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u5f00\u53d1\u8005\u5de5\u5177\u4f1a\u88ab\u81ea\u52a8\u7981\u7528\u3002\u5982\u679c\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u4ecejava -jar\u542f\u52a8\u7684\uff0c\u6216\u8005\u662f\u4ece\u4e00\u4e2a\u7279\u6b8a\u7684classloader\u542f\u52a8\u7684\uff0c\u90a3\u4e48\u5b83\u88ab\u8ba4\u4e3a\u662f\u4e00\u4e2a \"\u751f\u4ea7\u5e94\u7528\u7a0b\u5e8f\"\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528spring.devtools.restart.enabled\u7cfb\u7edf\u5c5e\u6027\u6765\u63a7\u5236\u8fd9\u79cd\u884c\u4e3a\u3002\u8981\u542f\u7528devtools\uff0c\u65e0\u8bba\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u7531\u54ea\u4e2aclassloader\u542f\u52a8\u7684\uff0c\u90fd\u8981\u8bbe\u7f6e-Dspring.devtools.restart.enabled=true\u7cfb\u7edf\u5c5e\u6027\u3002\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5982\u679c\u8fd0\u884c devtools \u6709\u5b89\u5168\u98ce\u9669\uff0c\u5219\u4e0d\u80fd\u8fd9\u6837\u505a\u3002\u8981\u7981\u7528 devtools\uff0c\u8bf7\u6392\u9664\u8be5\u4f9d\u8d56\u5173\u7cfb\u6216\u8bbe\u7f6e -Dspring.devtools.restart.enabled=false \u7cfb\u7edf\u5c5e\u6027</p> <p>\u5728 Maven \u4e2d\u5c06\u4f9d\u8d56\u6807\u8bb0\u4e3a\u53ef\u9009\uff0c\u53ef\u4ee5\u9632\u6b62 devtools \u88ab\u987a\u4fbf\u5e94\u7528\u5230\u4f7f\u7528\u4f60\u7684\u9879\u76ee\u7684\u5176\u4ed6\u6a21\u5757\u4e2d\u3002</p> <p>Spring Boot\u63d0\u4f9b\u7684\u91cd\u542f\u6280\u672f\u901a\u8fc7\u4f7f\u7528\u4e24\u4e2aclassloader\u5de5\u4f5c\u3002\u4e0d\u6539\u53d8\u7684\u7c7b\uff08\u4f8b\u5982\uff0c\u6765\u81ea\u7b2c\u4e09\u65b9 jars \u7684\u7c7b\uff09\u88ab\u52a0\u8f7d\u5230\u57fa\u7840\u7c7b\u52a0\u8f7d\u5668\u4e2d\u3002\u60a8\u6b63\u5728\u5f00\u53d1\u7684\u7c7b\u88ab\u52a0\u8f7d\u5230\u91cd\u542f\u7c7b\u52a0\u8f7d\u5668\u4e2d\u3002\u5f53\u5e94\u7528\u7a0b\u5e8f\u91cd\u542f\u65f6\uff0c\u91cd\u542f\u7c7b\u52a0\u8f7d\u5668\u4f1a\u88ab\u6254\u6389\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7c7b\u52a0\u8f7d\u5668\u3002\u8fd9\u79cd\u65b9\u6cd5\u610f\u5473\u7740\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u542f\u901a\u5e38\u6bd4 \"\u51b7\u542f\u52a8 \"\u5feb\u5f97\u591a\uff0c\u56e0\u4e3a\u57fa\u7840\u7c7b\u52a0\u8f7d\u5668\u5df2\u7ecf\u53ef\u7528\u5e76\u88ab\u586b\u5145\u3002</p>"},{"location":"java/spring/spring-boot/UsingSpringBoot/#10-what-to-read-next","title":"10. What to Read Next","text":"<p>\u60a8\u73b0\u5728\u5e94\u8be5\u4e86\u89e3\u5982\u4f55\u4f7f\u7528Spring Boot\u548c\u4e00\u4e9b\u60a8\u5e94\u8be5\u9075\u5faa\u7684\u6700\u4f73\u5b9e\u8df5\u3002\u73b0\u5728\u60a8\u53ef\u4ee5\u7ee7\u7eed\u6df1\u5165\u4e86\u89e3Spring Boot\u7684\u5177\u4f53\u529f\u80fd\uff0c\u6216\u8005\u60a8\u53ef\u4ee5\u8df3\u5230\u524d\u9762\uff0c\u9605\u8bfbSpring Boot\u7684 \"\u751f\u4ea7\u51c6\u5907 \"\u65b9\u9762\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/","title":"3.  Profiles","text":"<p>Spring Profiles\u63d0\u4f9b\u4e86\u4e00\u79cd\u9694\u79bb\u5e94\u7528\u7a0b\u5e8f\u914d\u7f6e\u90e8\u5206\u7684\u65b9\u6cd5\uff0c\u4f7f\u5176\u4ec5\u5728\u7279\u5b9a\u73af\u5883\u4e2d\u53ef\u7528\u3002\u4efb\u4f55@Component\u3001@Configuration\u6216@ConfigurationProperties\u90fd\u53ef\u4ee5\u7528@Profile\u6765\u6807\u8bb0\uff0c\u4ee5\u9650\u5236\u5b83\u88ab\u52a0\u8f7d\u7684\u65f6\u95f4\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>@Configuration(proxyBeanMethods = false)\n@Profile(\"production\")\npublic class ProductionConfiguration {\n\n    // ...\n\n}\n</code></pre> <p>\u5982\u679c@ConfigurationProperties Bean\u662f\u901a\u8fc7@EnableConfigurationProperties\u800c\u4e0d\u662f\u81ea\u52a8\u626b\u63cf\u6ce8\u518c\u7684\uff0c\u5219\u9700\u8981\u5728\u5177\u6709@EnableConfigurationProperties\u6ce8\u89e3\u7684@Configuration\u7c7b\u4e0a\u6307\u5b9a@Profile\u6ce8\u89e3\u3002\u5728\u626b\u63cf@ConfigurationProperties\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5728@ConfigurationProperties\u7c7b\u672c\u8eab\u4e0a\u6307\u5b9a@Profile\u3002</p> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528spring.profile.active\u73af\u5883\u5c5e\u6027\u6765\u6307\u5b9a\u54ea\u4e9b\u914d\u7f6e\u6587\u4ef6\u662f\u6fc0\u6d3b\u7684\u3002\u4f60\u53ef\u4ee5\u7528\u672c\u7ae0\u524d\u9762\u63cf\u8ff0\u7684\u4efb\u4f55\u4e00\u79cd\u65b9\u5f0f\u6765\u6307\u5b9a\u8be5\u5c5e\u6027\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u5c06\u5176\u5305\u542b\u5728\u60a8\u7684application.properties\u4e2d\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>spring.profiles.active=dev,hsqldb\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5728\u547d\u4ee4\u884c\u4e2d\u6dfb\u52a0<code>--spring.profiles.active=dev,hsqldb</code></p>"},{"location":"java/spring/spring-boot/spring-boot-features/#31-profiles","title":"3.1 \u589e\u52a0\u6fc0\u6d3b\u7684Profiles","text":"<p>The spring.profiles.active property follows the same ordering rules as other properties: The highest PropertySource wins. This means that you can specify active profiles in application.properties and then replace them by using the command line switch.</p> <p>Sometimes, it is useful to have properties that add to the active profiles rather than replace them. The SpringApplication entry point has a Java API for setting additional profiles (that is, on top of those activated by the spring.profiles.active property). See the setAdditionalProfiles() method in SpringApplication. Profile groups, which are described in the next section can also be used to add active profiles if a given profile is active.</p> <p><code>spring.profile.active</code>\u5c5e\u6027\u4e0e\u5176\u4ed6\u5c5e\u6027\u9075\u5faa\u76f8\u540c\u7684\u6392\u5e8f\u89c4\u5219\u3002\u6700\u9ad8\u7684PropertySource\u83b7\u80dc\u3002\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u5728application.properties\u4e2d\u6307\u5b9a\u6d3b\u52a8\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u5728\u547d\u4ee4\u884c\u91cc\u66ff\u6362\u5b83\u4eec\u3002</p> <p>\u6709\u65f6\uff0c\u6dfb\u52a0\u5c5e\u6027\u5230\u6fc0\u6d3b\u7684\u914d\u7f6e\u6587\u4ef6\u800c\u4e0d\u662f\u66ff\u6362\u5b83\u4eec\u662f\u6709\u7528\u7684\u3002SpringApplication\u5165\u53e3\u70b9\u6709\u4e00\u4e2aJava API\u7528\u4e8e\u8bbe\u7f6e\u989d\u5916\u7684\u914d\u7f6e\u6587\u4ef6\uff08\u5373\u5728\u90a3\u4e9b\u7531spring.profile.active\u5c5e\u6027\u6fc0\u6d3b\u7684\u914d\u7f6e\u6587\u4ef6\u4e4b\u4e0a\uff09\u3002\u53c2\u89c1SpringApplication\u4e2d\u7684<code>setAdditionalProfiles()</code>\u65b9\u6cd5\u3002\u5982\u679c\u4e00\u4e2a\u7ed9\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u6d3b\u8dc3\u7684\uff0c\u90a3\u4e48\u4e0b\u4e00\u8282\u4e2d\u63cf\u8ff0\u7684Profile groups\u4e5f\u53ef\u4ee5\u7528\u6765\u6dfb\u52a0\u6d3b\u8dc3\u7684\u914d\u7f6e\u6587\u4ef6\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#32-profile","title":"3.2 Profile \u7ec4","text":"<p>\u6709\u65f6\uff0c\u60a8\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5b9a\u4e49\u548c\u4f7f\u7528\u7684\u914d\u7f6e\u6587\u4ef6\u8fc7\u4e8e\u7ec6\u5316\uff0c\u4f7f\u7528\u8d77\u6765\u4f1a\u53d8\u5f97\u5f88\u9ebb\u70e6\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u4f1a\u6709 proddb \u548c prodmq\u7684profiles \uff0c\u7528\u4e8e\u72ec\u7acb\u542f\u7528\u6570\u636e\u5e93\u548c\u6d88\u606f\u529f\u80fd\u3002</p> <p>\u4e3a\u4e86\u5e2e\u52a9\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cSpring Boot\u5141\u8bb8\u60a8\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\u7ec4\u3002\u914d\u7f6e\u6587\u4ef6\u7ec4\u5141\u8bb8\u60a8\u4e3a\u76f8\u5173\u7684\u914d\u7f6e\u6587\u4ef6\u7ec4\u5b9a\u4e49\u4e00\u4e2a\u903b\u8f91\u540d\u79f0\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7531 proddb \u548c prodmq \u914d\u7f6e\u6587\u4ef6\u7ec4\u6210\u7684\u751f\u4ea7\u7ec4:</p> <pre><code>spring.profiles.group.production[0]=proddb\nspring.profiles.group.production[1]=prodmq\n</code></pre> <p>\u73b0\u5728\u53ef\u4ee5\u4f7f\u7528<code>--spring.profile.active=production</code>\u542f\u52a8\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e00\u6b21\u6027\u6fc0\u6d3bproduction\u3001proddb\u548cprodmq\u914d\u7f6e\u6587\u4ef6\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#33-profiles","title":"3.3 \u7f16\u7a0b\u8bbe\u7f6eProfiles","text":"<p>\u60a8\u53ef\u4ee5\u5728\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u524d\u8c03\u7528SpringApplication.setAdditionalProfiles(...)\u6765\u7f16\u7a0b\u8bbe\u7f6e\u6d3b\u52a8\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528Spring\u7684ConfigurableEnvironment\u63a5\u53e3\u6765\u6fc0\u6d3b\u914d\u7f6e\u6587\u4ef6\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#34-profile-specific","title":"3.4 Profile-specific \u914d\u7f6e\u6587\u4ef6","text":"<p>Profile-specific variants of both application.properties (or application.yml) and files referenced through @ConfigurationProperties are considered as files and loaded. See \"Profile Specific Files\" for details.</p> <p>application.properties\uff08\u6216application.yml\uff09\u548c\u901a\u8fc7<code>@ConfigurationProperties</code>\u5f15\u7528\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u90fd\u88ab\u89c6\u4e3afiles\u5e76\u88ab\u52a0\u8f7d\u3002\u8be6\u60c5\u8bf7\u53c2\u89c1 \"\u914d\u7f6e\u6587\u4ef6\u7279\u5b9a\u6587\u4ef6\"\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#4-logging","title":"4. logging","text":"<p>Spring Boot\u5bf9\u6240\u6709\u5185\u90e8\u65e5\u5fd7\u8bb0\u5f55\u4f7f\u7528 Commons Logging \uff0c\u4f46\u5f00\u653e\u5e95\u5c42\u65e5\u5fd7\u5b9e\u73b0\u3002\u4e3a Java Util Logging\u3001Log4J2 \u548c Logback \u63d0\u4f9b\u4e86\u9ed8\u8ba4\u914d\u7f6e\u3002\u5728\u6bcf\u79cd\u60c5\u51b5\u4e0b\uff0c\u65e5\u5fd7\u8bb0\u5f55\u5668\u90fd\u88ab\u9884\u5148\u914d\u7f6e\u4e3a\u4f7f\u7528\u63a7\u5236\u53f0\u8f93\u51fa\uff0c\u4e5f\u53ef\u9009\u62e9\u6587\u4ef6\u8f93\u51fa\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u60a8\u4f7f\u7528 \"Starters\"\uff0c\u5c06\u4f7f\u7528Logback\u3002\u8fd8\u5305\u62ec\u9002\u5f53\u7684Logback\u8def\u7531\uff0c\u4ee5\u786e\u4fdd\u4f7f\u7528Java Util Logging\u3001Commons Logging\u3001Log4J\u6216SLF4J\u7684\u4f9d\u8d56\u5e93\u90fd\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002</p> <p>Java\u6709\u5f88\u591a\u53ef\u7528\u7684\u65e5\u5fd7\u6846\u67b6\u3002\u5982\u679c\u4e0a\u9762\u7684\u5217\u8868\u770b\u8d77\u6765\u5f88\u6df7\u4e71\uff0c\u4e0d\u8981\u62c5\u5fc3\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u4f60\u4e0d\u9700\u8981\u6539\u53d8\u4f60\u7684\u65e5\u5fd7\u4f9d\u8d56\u5173\u7cfb\uff0cSpring Boot\u7684\u9ed8\u8ba4\u503c\u4e5f\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002 \u5f53\u60a8\u5c06\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230 servlet \u5bb9\u5668\u6216\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\u65f6\uff0c\u901a\u8fc7 Java Util Logging API \u6267\u884c\u7684\u65e5\u5fd7\u4e0d\u4f1a\u88ab\u8def\u7531\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u4e2d\u3002\u8fd9\u5c31\u9632\u6b62\u4e86\u7531\u5bb9\u5668\u6216\u5df2\u90e8\u7f72\u5230\u5bb9\u5668\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u65e5\u5fd7\u8bb0\u5f55\u51fa\u73b0\u5728\u60a8\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u4e2d\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#41","title":"4.1 \u65e5\u5fd7\u683c\u5f0f","text":"<p>springboot\u9ed8\u8ba4\u7684\u65e5\u5fd7\u8f93\u51fa\u5982\u4e0b\u56fe\uff1a</p> <pre><code>2019-03-05 10:57:51.112  INFO 45469 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/7.0.52\n2019-03-05 10:57:51.253  INFO 45469 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext\n2019-03-05 10:57:51.253  INFO 45469 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1358 ms\n2019-03-05 10:57:51.698  INFO 45469 --- [ost-startStop-1] o.s.b.c.e.ServletRegistrationBean        : Mapping servlet: 'dispatcherServlet' to [/]\n2019-03-05 10:57:51.702  INFO 45469 --- [ost-startStop-1] o.s.b.c.embedded.FilterRegistrationBean  : Mapping filter: 'hiddenHttpMethodFilter' to: [/*]\n</code></pre> <p>\u6309\u7167\u4ee5\u4e0b\u8f93\u51fa</p> <ul> <li>Date and Time\uff1a\u6beb\u79d2\u7ea7\u522b\u6392\u5e8f</li> <li>Log level\uff1a<code>ERROR</code>, <code>WARN</code>, <code>INFO</code>, <code>DEBUG</code>, \u6216\u8005 <code>TRACE</code></li> <li>\u8fdb\u7a0bID</li> <li><code>--</code> \u5206\u9694\u7b26\uff0c\u6765\u533a\u5206\u5b9e\u9645\u7684\u65e5\u5fd7\u8f93\u51fa</li> <li>\u7ebf\u7a0b\u540d\u79f0\uff0c\u4f7f\u7528\u4e2d\u62ec\u53f7\u62ec\u8d77</li> <li>Logger name:\u901a\u5e38\u662fsource class\u540d\u79f0\uff0c\u4e00\u822c\u4f1a\u7f29\u5199</li> <li>\u5b9e\u9645\u7684\u65e5\u5fd7\u4fe1\u606f</li> </ul>"},{"location":"java/spring/spring-boot/spring-boot-features/#42-console","title":"4.2 Console \u8f93\u51fa","text":"<p>\u9ed8\u8ba4\u7684\u65e5\u5fd7\u914d\u7f6e\u5728\u6d88\u606f\u5199\u5165\u65f6\u5c06\u5176\u56de\u4f20\u5230\u63a7\u5236\u53f0\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cERROR\u7ea7\u522b\u3001WARN\u7ea7\u522b\u548cINFO\u7ea7\u522b\u7684\u6d88\u606f\u4f1a\u88ab\u8bb0\u5f55\u4e0b\u6765\u3002\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528--debug\u6807\u5fd7\u542f\u52a8\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u6765\u542f\u7528 \"\u8c03\u8bd5 \"\u6a21\u5f0f\uff1a</p> <pre><code>$ java -jar myapp.jar --debug\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5728<code>application.properties</code>\u6587\u4ef6\u91ccdebug=true\u5f00\u542f</p> <p>\u5f53\u542f\u7528\u8c03\u8bd5\u6a21\u5f0f\u65f6\uff0c\u6838\u5fc3\u65e5\u5fd7\u5668\uff08\u5d4c\u5165\u5f0f\u5bb9\u5668\u3001Hibernate\u548cSpring Boot\uff09\u88ab\u914d\u7f6e\u4e3a\u8f93\u51fa\u66f4\u591a\u4fe1\u606f\u3002\u542f\u7528\u8c03\u8bd5\u6a21\u5f0f\u4e0d\u4f1a\u5c06\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u914d\u7f6e\u4e3a\u8bb0\u5f55\u6240\u6709\u5177\u6709DEBUG\u7ea7\u522b\u7684\u6d88\u606f\u3002</p> <p>\u6216\u8005\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528--trace\u6807\u5fd7\uff08\u6216\u5728application.properties\u4e2d<code>trace=true</code>\uff09\u6765\u542f\u7528 \"\u8ddf\u8e2a \"\u6a21\u5f0f\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u4f7f\u9009\u5b9a\u7684\u6838\u5fc3\u65e5\u5fd7\u8bb0\u5f55\u5668\uff08\u5d4c\u5165\u5f0f\u5bb9\u5668\u3001Hibernate\u6a21\u5f0f\u751f\u6210\u548c\u6574\u4e2aSpring\u7ec4\u5408\uff09\u8fdb\u884ctrace logging\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#421","title":"4.2.1\u5f69\u8272\u8f93\u51fa","text":"<p>\u5982\u679c\u4f60\u7684\u7ec8\u7aef\u652f\u6301ANSI\uff0c\u5219\u4f1a\u4f7f\u7528\u5f69\u8272\u8f93\u51fa\u6765\u5e2e\u52a9\u9605\u8bfb\u3002\u4f60\u53ef\u4ee5\u5c06<code>spring.output.ansi.enabled</code>\u8bbe\u7f6e\u4e3a\u4e00\u4e2asupported value\u5982always\u6765\u8986\u76d6\u81ea\u52a8\u68c0\u6d4b\u3002</p> <p>\u989c\u8272\u7f16\u7801\u662f\u901a\u8fc7\u4f7f\u7528<code>%clr</code>\u8f6c\u6362\u5b57\u6765\u914d\u7f6e\u7684\u3002\u5728\u5176\u6700\u7b80\u5355\u7684\u5f62\u5f0f\u4e2d\uff0c\u8f6c\u6362\u5668\u6839\u636e\u65e5\u5fd7\u7ea7\u522b\u5bf9\u8f93\u51fa\u8fdb\u884c\u7740\u8272\uff0c\u5982\u4e0b\u4f8b\u6240\u793a:<code>%clr(%5p)</code></p> Level Color <code>FATAL</code> Red <code>ERROR</code> Red <code>WARN</code> Yellow <code>INFO</code> Green <code>DEBUG</code> Green <code>TRACE</code> Green <p>\u53e6\u5916\uff0c\u60a8\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e3a\u8f6c\u6362\u63d0\u4f9b\u4e00\u4e2a\u9009\u9879\u6765\u6307\u5b9a\u5e94\u8be5\u4f7f\u7528\u7684\u989c\u8272\u6216\u6837\u5f0f\u3002\u4f8b\u5982\uff0c\u8981\u4f7f\u6587\u672c\u4e3a\u9ec4\u8272\uff0c\u8bf7\u4f7f\u7528\u4ee5\u4e0b\u8bbe\u7f6e:<code>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){yellow}</code>,\u652f\u6301\u4ee5\u4e0b\u989c\u8272\u548c\u683c\u5f0f\uff1a</p> <ul> <li><code>blue</code></li> <li><code>cyan</code></li> <li><code>faint</code></li> <li><code>green</code></li> <li><code>magenta</code></li> <li><code>red</code></li> <li><code>yellow</code></li> </ul>"},{"location":"java/spring/spring-boot/spring-boot-features/#43","title":"4.3 \u6587\u4ef6\u8f93\u51fa","text":"<p>springboot\u65e5\u5fd7\u9ed8\u8ba4\u53ea\u4f1a\u8f93\u51fa\u5230\u63a7\u5236\u53f0\uff0c\u4e0d\u4f1a\u8bb0\u5f55\u5230\u6587\u4ef6\u3002\u5982\u679c\u60f3\u8f93\u51fa\u5230\u6587\u4ef6\u9700\u8981\u8bbe\u7f6e<code>logging.file.name</code> \u6216<code>logging.file.path</code>\u5c5e\u6027\uff08\u5982application.properties\u6587\u4ef6\uff09</p> <code>logging.file.name</code> <code>logging.file.path</code> Example Description (none) (none) \u53ea\u8f93\u51fa\u5230\u63a7\u5236\u53f0. Specific file (none) <code>my.log</code> \u5199\u5165\u6307\u5b9a\u7684\u65e5\u5fd7\u6587\u4ef6\u3002\u540d\u79f0\u53ef\u4ee5\u662f\u786e\u5207\u7684\u4f4d\u7f6e\uff0c\u4e5f\u53ef\u4ee5\u662f\u5f53\u524d\u76ee\u5f55\u7684\u76f8\u5bf9\u4f4d\u7f6e\u3002 (none) Specific directory <code>/var/log</code> \u5c06 \"spring.log \"\u5199\u5165\u6307\u5b9a\u76ee\u5f55\u3002\u540d\u79f0\u53ef\u4ee5\u662f\u786e\u5207\u7684\u4f4d\u7f6e\uff0c\u4e5f\u53ef\u4ee5\u662f\u76f8\u5bf9\u4e8e\u5f53\u524d\u76ee\u5f55\u7684\u4f4d\u7f6e\u3002 <p>\u65e5\u5fd7\u6587\u4ef6\u8fbe\u5230 10 MB \u65f6\u4f1a\u8f6e\u6362\uff0c\u4e0e\u63a7\u5236\u53f0\u8f93\u51fa\u4e00\u6837\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u8bb0\u5f55 ERROR \u7ea7\u3001WARN \u7ea7\u548c INFO \u7ea7\u6d88\u606f\u3002</p> <p>\u65e5\u5fd7\u5c5e\u6027\u72ec\u7acb\u4e8e\u5b9e\u9645\u7684\u65e5\u5fd7\u5b9e\u73b0\u3002\u56e0\u6b64\uff0cspring Boot \u4e0d\u7ba1\u7406\u7279\u5b9a\u7684\u914d\u7f6e\u952e\uff08\u5982Logback\u7684 Logback.configurationFile \u5c5e\u6027 \uff09\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#44","title":"4.4 \u65e5\u5fd7\u6eda\u52a8","text":"<p>\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662fLogback\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u4f60\u7684application.properties\u6216\u8005application.yaml\u6587\u4ef6\u5bf9\u65e5\u5fd7\u8f6e\u6362\u8bbe\u7f6e\u8fdb\u884c\u5fae\u8c03\u3002\u5bf9\u4e8e\u5176\u4ed6\u65e5\u5fd7\u7cfb\u7edf\uff0c\u4f60\u9700\u8981\u81ea\u5df1\u76f4\u63a5\u914d\u7f6e\u8f6e\u6362\u8bbe\u7f6e\uff08\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u4f7f\u7528Log4J2\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2alog4j.xml\u6587\u4ef6\uff09\u3002</p> <p>\u652f\u6301\u4ee5\u4e0b\u8f6e\u6362\u7b56\u7565\u5c5e\u6027\uff1a</p> Name Description <code>logging.logback.rollingpolicy.file-name-pattern</code> \u7528\u6765\u5f52\u6863\u7684\u6587\u4ef6\u540d\u79f0pattern <code>logging.logback.rollingpolicy.clean-history-on-start</code> \u662f\u5426\u5728\u5e94\u7528\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fdb\u884c\u65e5\u5fd7\u5b58\u6863\u6e05\u7406\uff1f <code>logging.logback.rollingpolicy.max-file-size</code> The maximum size of log file \u5728\u5f52\u6863\u524d <code>logging.logback.rollingpolicy.total-size-cap</code> The maximum amount of size log archives can take before being deleted.\u65e5\u5fd7\u5b58\u6863\u5728\u88ab\u5220\u9664\u524d\u6240\u80fd\u627f\u53d7\u7684\u6700\u5927\u6570\u91cf\u3002 <code>logging.logback.rollingpolicy.max-history</code> \u5f52\u6863\u7684\u5929\u6570 (\u9ed8\u8ba47\u5929)"},{"location":"java/spring/spring-boot/spring-boot-features/#45","title":"4.5 \u65e5\u5fd7\u7ea7\u522b","text":"<p>\u6240\u6709\u652f\u6301\u7684\u65e5\u5fd7\u7cfb\u7edf\u90fd\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528<code>logging.level.&lt;logger-name&gt;=&lt;level&gt;</code>\u5728Spring  Environment\u4e2d\u8bbe\u7f6e\u65e5\u5fd7\u5668\u7ea7\u522b\uff08\u4f8b\u5982\u5728application.properties\u4e2d\uff09\uff0c\u5176\u4e2d\u7ea7\u522b\u53ef\u4ee5\u4e3aTRACE\u3001DEBUG\u3001INFO\u3001WARN\u3001ERROR\u3001FATAL\u6216OFF\u3002\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528logging.level.root\u914d\u7f6eroot\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u663e\u793a\u4e86application.properties\u4e2d\u6f5c\u5728\u7684\u65e5\u5fd7\u8bb0\u5f55\u8bbe\u7f6e\uff1a</p> <pre><code>logging.level.root=warn\nlogging.level.org.springframework.web=debug\nlogging.level.org.hibernate=error\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u6765\u8bbe\u7f6e\u65e5\u5fd7\u7ea7\u522b\u3002\u4f8b\u5982\uff0c<code>LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB=DEBUG</code>\u5c06\u628aorg.springframework.web\u8bbe\u7f6e\u4e3aDEBUG\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u633a\u6709\u7528\u7684\uff0c\u6bd4\u5982\u50cf\u5355\u72ec\u8c03\u8bd5\u8ffd\u8e2a\u67d0\u4e2a\u5305\u4e0b\u7684\u95ee\u9898\uff0c\u5c31\u53ef\u4ee5\u53ea\u5f00\u542f\u67d0\u4e2a\u5305\u7684\u65e5\u5fd7\u7ea7\u522b\u4e3adebug\uff0c\u65b9\u4fbf\u8ffd\u8e2a\u95ee\u9898\uff01</p> <p>\u4ee5\u4e0a\u65b9\u6cd5\u53ea\u9002\u7528\u4e8epackage \u5305\u7ea7\u65e5\u5fd7\u3002\u7531\u4e8e\u677e\u5f1b\u7ed1\u5b9a\u603b\u662f\u5c06\u73af\u5883\u53d8\u91cf\u8f6c\u6362\u4e3a\u5c0f\u5199\uff0c\u6240\u4ee5\u4e0d\u53ef\u80fd\u7528\u8fd9\u79cd\u65b9\u5f0f\u4e3a\u5355\u4e2a\u7c7b\u914d\u7f6e\u65e5\u5fd7\u8bb0\u5f55\u3002\u5982\u679c\u9700\u8981\u4e3a\u4e00\u4e2a\u7c7b\u914d\u7f6e\u65e5\u5fd7\u8bb0\u5f55\uff0c\u53ef\u4ee5\u4f7f\u7528SPRING_APPLICATION_JSON\u53d8\u91cf\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#46","title":"4.6 \u65e5\u5fd7\u7ec4","text":"<p>\u80fd\u591f\u5c06\u76f8\u5173\u7684\u65e5\u5fd7\u8bb0\u5f55\u5668\u5206\u7ec4\u5728\u4e00\u8d77\uff0c\u4ee5\u4fbf\u5728\u540c\u4e00\u65f6\u95f4\u5bf9\u5b83\u4eec\u8fdb\u884c\u914d\u7f6e\uff0c\u8fd9\u901a\u5e38\u5f88\u6709\u7528\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u901a\u5e38\u4f1a\u66f4\u6539\u6240\u6709 Tomcat \u76f8\u5173\u65e5\u5fd7\u7a0b\u5e8f\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u4f46\u60a8\u65e0\u6cd5\u8f7b\u677e\u8bb0\u4f4f\u9876\u7ea7\u5305\u3002</p> <p>\u4e3a\u4e86\u5e2e\u52a9\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cSpring Boot\u5141\u8bb8\u60a8\u5728Spring\u73af\u5883\u4e2d\u5b9a\u4e49\u65e5\u5fd7\u7ec4\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u5c06\u5176\u6dfb\u52a0\u5230\u60a8\u7684 application.properties \u4e2d\u6765\u5b9a\u4e49\u4e00\u4e2a \"Tomcat \"\u7ec4\uff1a</p> <pre><code>logging.group.tomcat=org.apache.catalina,org.apache.coyote,org.apache.tomcat\n</code></pre> <p>\u5b9a\u4e49\u540e\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u4e00\u884c\u6539\u53d8\u7ec4\u4e2d\u6240\u6709\u5305\u7684\u7ea7\u522b\uff1a</p> <pre><code>logging.level.tomcat=trace\n</code></pre> <p>springboot\u5305\u542b\u4ee5\u4e0b\u9884\u5148\u5b9a\u4e49\u597d\u7684\u65e5\u5fd7\u7ec4\uff0c\u5f00\u7bb1\u5373\u7528\uff1a</p> Name Loggers web <code>org.springframework.core.codec</code>, <code>org.springframework.http</code>, <code>org.springframework.web</code>, <code>org.springframework.boot.actuate.endpoint.web</code>, <code>org.springframework.boot.web.servlet.ServletContextInitializerBeans</code> sql <code>org.springframework.jdbc.core</code>, <code>org.hibernate.SQL</code>, <code>org.jooq.tools.LoggerListener</code>"},{"location":"java/spring/spring-boot/spring-boot-features/#47","title":"4.7 \u4f7f\u7528\u65e5\u5fd7\u5173\u95ed\u94a9\u5b50","text":"<p>\u4e3a\u4e86\u91ca\u653e\u65e5\u5fd7\u8d44\u6e90\uff0c\u901a\u5e38\u5728\u5e94\u7528\u7a0b\u5e8f\u7ec8\u6b62\u65f6\u505c\u6b62\u65e5\u5fd7\u7cfb\u7edf\u662f\u4e00\u4e2a\u597d\u4e3b\u610f\u3002\u4e0d\u5e78\u7684\u662f\uff0c\u6ca1\u6709\u4e00\u79cd\u65b9\u6cd5\u53ef\u4ee5\u9002\u7528\u4e8e\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u7c7b\u578b\u3002\u5982\u679c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u5177\u6709\u590d\u6742\u7684\u4e0a\u4e0b\u6587\u5c42\u6b21\u7ed3\u6784\u6216\u4f5c\u4e3awar\u6587\u4ef6\u90e8\u7f72\uff0c\u60a8\u5c06\u9700\u8981\u7814\u7a76\u7531\u5e95\u5c42\u65e5\u5fd7\u7cfb\u7edf\u76f4\u63a5\u63d0\u4f9b\u7684\u9009\u9879\u3002\u4f8b\u5982\uff0cLogback \u63d0\u4f9b\u4e86\u4e0a\u4e0b\u6587\u9009\u62e9\u5668\uff0c\u5141\u8bb8\u5728\u81ea\u5df1\u7684\u4e0a\u4e0b\u6587\u4e2d\u521b\u5efa\u6bcf\u4e2a Logger\u3002</p> <p>\u5bf9\u4e8e\u90e8\u7f72\u5728\u81ea\u5df1JVM\u4e2d\u7684\u7b80\u5355\u7684 \"\u5355jar \"\u5e94\u7528\u7a0b\u5e8f\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528logging.register-shutdown-hook\u5c5e\u6027\u3002\u5c06<code>logging.register-shutdown-hook</code>\u8bbe\u7f6e\u4e3atrue\u5c06\u6ce8\u518c\u4e00\u4e2a\u5173\u673a\u94a9\u5b50\uff0c\u8be5\u94a9\u5b50\u5c06\u5728JVM\u9000\u51fa\u65f6\u89e6\u53d1\u65e5\u5fd7\u7cfb\u7edf\u6e05\u7406\u3002</p> <p>\u60a8\u53ef\u4ee5\u5728application.properties\u6216application.yaml\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u8be5\u5c5e\u6027:</p> <pre><code>logging.register-shutdown-hook=true\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#48","title":"4.8 \u81ea\u5b9a\u4e49\u65e5\u5fd7\u914d\u7f6e","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u5728classpath\u4e0a\u5305\u542b\u9002\u5f53\u7684\u5e93\u6765\u6fc0\u6d3b\u5404\u79cd\u65e5\u5fd7\u7cfb\u7edf\uff0c\u5e76\u53ef\u901a\u8fc7\u5728classpath\u7684\u6839\u76ee\u5f55\u4e0b\u6216\u5728\u4ee5\u4e0bSpring\u73af\u5883\u5c5e\u6027\u6307\u5b9a\u7684\u4f4d\u7f6e\u63d0\u4f9b\u5408\u9002\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8fdb\u4e00\u6b65\u5b9a\u5236\uff1alogging.config\u3002</p> <p>\u60a8\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 o<code>rg.springframework.boot.logging.LoggingSystem</code> system \u5c5e\u6027\u5f3a\u5236 Spring Boot \u4f7f\u7528\u7279\u5b9a\u7684\u65e5\u5fd7\u7cfb\u7edf\u3002\u8be5\u503c\u5e94\u8be5\u662f LoggingSystem \u5b9e\u73b0\u7684\u5b8c\u5168\u9650\u5b9a\u7c7b\u540d\u3002\u60a8\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 none \u7684\u503c\u5b8c\u5168\u7981\u7528 Spring Boot \u7684\u65e5\u5fd7\u914d\u7f6e\u3002</p> <p>\u7531\u4e8e\u65e5\u5fd7\u8bb0\u5f55\u662f\u5728ApplicationContext\u521b\u5efa\u4e4b\u524d\u521d\u59cb\u5316\u7684\uff0c\u6240\u4ee5\u65e0\u6cd5\u901a\u8fc7Spring @Configuration\u6587\u4ef6\u4e2d\u7684@PropertySources\u6765\u63a7\u5236\u65e5\u5fd7\u8bb0\u5f55\u3002\u552f\u4e00\u7684\u65b9\u6cd5\u662f\u901a\u8fc7\u7cfb\u7edf\u5c5e\u6027\u6765\u6539\u53d8\u65e5\u5fd7\u7cfb\u7edf\u6216\u5b8c\u5168\u7981\u7528\u5b83\u3002</p> <p>\u6839\u636e\u4e0d\u540c\u7684\u65e5\u5fd7\u7cfb\u7edf\u5b9e\u73b0\uff0c\u4f1a\u52a0\u8f7d\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b\u8868</p> Logging System Customization Logback <code>logback-spring.xml</code>, <code>logback-spring.groovy</code>, <code>logback.xml</code>, or <code>logback.groovy</code> Log4j2 <code>log4j2-spring.xml</code> or <code>log4j2.xml</code> JDK (Java Util Logging) <code>logging.properties</code> <p>When possible, we recommend that you use the <code>-spring</code> variants for your logging configuration (for example, <code>logback-spring.xml</code> rather than <code>logback.xml</code>). If you use standard configuration locations, Spring cannot completely control log initialization.</p> <p>\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5efa\u8bae\u60a8\u4f7f\u7528-spring\u53d8\u4f53\u6765\u8fdb\u884c\u65e5\u5fd7\u914d\u7f6e\uff08\u4f8b\u5982\uff0clogback-spring.xml\u800c\u4e0d\u662flogback.xml\uff09\u3002\u5982\u679c\u60a8\u4f7f\u7528\u6807\u51c6\u914d\u7f6e\u4f4d\u7f6e\uff0cSpring\u65e0\u6cd5\u5b8c\u5168\u63a7\u5236\u65e5\u5fd7\u521d\u59cb\u5316\u3002</p> <p>\u4e3a\u4e86\u5e2e\u52a9\u5b9a\u5236\uff0c\u4e00\u4e9b\u5176\u4ed6\u5c5e\u6027\u4eceSpring Environment\u8f6c\u79fb\u5230\u7cfb\u7edf\u5c5e\u6027\uff0c\u5982\u4e0b\u8868\u6240\u8ff0:</p> Spring Environment System Property Comments <code>logging.exception-conversion-word</code> <code>LOG_EXCEPTION_CONVERSION_WORD</code> The conversion word used when logging exceptions. <code>logging.file.name</code> <code>LOG_FILE</code> \u5982\u679c\u5b9a\u4e49\u4e86\uff0c\u5219\u5728\u9ed8\u8ba4\u7684\u65e5\u5fd7\u914d\u7f6e\u4e2d\u4f7f\u7528\u3002 <code>logging.file.path</code> <code>LOG_PATH</code> If defined, it is used in the default log configuration. <code>logging.pattern.console</code> <code>CONSOLE_LOG_PATTERN</code> The log pattern to use on the console (stdout). <code>logging.pattern.dateformat</code> <code>LOG_DATEFORMAT_PATTERN</code> Appender pattern for log date format. <code>logging.charset.console</code> <code>CONSOLE_LOG_CHARSET</code> The charset to use for console logging. <code>logging.pattern.file</code> <code>FILE_LOG_PATTERN</code> The log pattern to use in a file (if <code>LOG_FILE</code> is enabled). <code>logging.charset.file</code> <code>FILE_LOG_CHARSET</code> The charset to use for file logging (if <code>LOG_FILE</code> is enabled). <code>logging.pattern.level</code> <code>LOG_LEVEL_PATTERN</code> The format to use when rendering the log level (default <code>%5p</code>). <code>PID</code> <code>PID</code> The current process ID (discovered if possible and when not already defined as an OS environment variable). <p>\u5982\u679c\u4f7f\u7528\u7684\u662flogback\uff0c\u8fd8\u652f\u6301\u4ee5\u4e0b</p> Spring Environment System Property Comments <code>logging.logback.rollingpolicy.file-name-pattern</code> <code>LOGBACK_ROLLINGPOLICY_FILE_NAME_PATTERN</code> Pattern for rolled-over log file names (default <code>${LOG_FILE}.%d{yyyy-MM-dd}.%i.gz</code>). <code>logging.logback.rollingpolicy.clean-history-on-start</code> <code>LOGBACK_ROLLINGPOLICY_CLEAN_HISTORY_ON_START</code> Whether to clean the archive log files on startup. <code>logging.logback.rollingpolicy.max-file-size</code> <code>LOGBACK_ROLLINGPOLICY_MAX_FILE_SIZE</code> Maximum log file size. <code>logging.logback.rollingpolicy.total-size-cap</code> <code>LOGBACK_ROLLINGPOLICY_TOTAL_SIZE_CAP</code> Total size of log backups to be kept. <code>logging.logback.rollingpolicy.max-history</code> <code>LOGBACK_ROLLINGPOLICY_MAX_HISTORY</code> Maximum number of archive log files to keep. <p>\u6240\u6709\u652f\u6301\u7684\u65e5\u5fd7\u7cfb\u7edf\u5728\u89e3\u6790\u5176\u914d\u7f6e\u6587\u4ef6\u65f6\u90fd\u53ef\u4ee5\u53c2\u8003\u7cfb\u7edf\u5c5e\u6027\u3002\u8bf7\u53c2\u9605spring-boot.jar\u4e2d\u7684\u9ed8\u8ba4\u914d\u7f6e\u793a\u4f8b\uff1a</p> <ul> <li>Logback</li> <li>Log4j 2</li> <li>Java Util logging</li> </ul> <p>\u5982\u679c\u60a8\u60f3\u5728\u65e5\u5fd7\u5c5e\u6027\u4e2d\u4f7f\u7528\u5360\u4f4d\u7b26\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 Spring Boot \u7684\u8bed\u6cd5\uff0c\u800c\u4e0d\u662f\u5e95\u5c42\u6846\u67b6\u7684\u8bed\u6cd5\u3002\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u60a8\u4f7f\u7528 Logback\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 : \u4f5c\u4e3a\u5c5e\u6027\u540d\u4e0e\u5176\u9ed8\u8ba4\u503c\u4e4b\u95f4\u7684\u5206\u9694\u7b26\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 <code>:-</code></p> <p>\u60a8\u53ef\u4ee5\u53ea\u901a\u8fc7\u8986\u76d6LOG_LEVEL_PATTERN\uff08\u6216\u4f7f\u7528Logback\u7684logging.pattern.level\uff09\u6765\u5411\u65e5\u5fd7\u884c\u6dfb\u52a0MDC\u548c\u5176\u4ed6\u4e34\u65f6\u5185\u5bb9\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u4f7f\u7528<code>logging.pattern.level=user:%X{user} %5p</code>\uff0c\u90a3\u4e48\u9ed8\u8ba4\u7684\u65e5\u5fd7\u683c\u5f0f\u5c31\u5305\u542b\u4e86 \"user \"\u7684MDC\u6761\u76ee\uff0c\u5982\u679c\u5b83\u5b58\u5728\u7684\u8bdd\uff0c\u5982\u4e0b\u4f8b\u6240\u793a</p> <pre><code>2019-08-30 12:30:04.031 user:someone INFO 22174 --- [  nio-8080-exec-0] demo.Controller\nHandling authenticated request\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#49-logback","title":"4.9 logback\u6269\u5c55","text":"<p>Spring Boot \u5305\u542b\u4e86\u8bb8\u591a\u6709\u52a9\u4e8e\u9ad8\u7ea7\u914d\u7f6e\u7684 Logback \u6269\u5c55\u3002\u60a8\u53ef\u4ee5\u5728\u60a8\u7684 logback-spring.xml \u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u6269\u5c55\u3002</p> <p>\u56e0\u4e3a\u6807\u51c6\u7684logback.xml\u914d\u7f6e\u6587\u4ef6\u52a0\u8f7d\u5f97\u592a\u65e9\uff0c\u6240\u4ee5\u4f60\u4e0d\u80fd\u5728\u5176\u4e2d\u4f7f\u7528\u6269\u5c55\u3002\u4f60\u9700\u8981\u4f7f\u7528logback-spring.xml\u6216\u8005\u5b9a\u4e49\u4e00\u4e2alogging.config\u5c5e\u6027\u3002</p> <p>\u8fd9\u4e9b\u6269\u5c55\u540d\u4e0d\u80fd\u4e0eLogback\u7684\u914d\u7f6e\u626b\u63cf\u4e00\u8d77\u4f7f\u7528\u3002\u5982\u679c\u60a8\u8bd5\u56fe\u8fd9\u6837\u505a\uff0c\u5bf9\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u66f4\u6539\u4f1a\u5bfc\u81f4\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u7684\u9519\u8bef\u8bb0\u5f55\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#492-environment-properties","title":"4.9.2 Environment Properties","text":"<p>\u6807\u7b7e\u8ba9\u60a8\u53ef\u4ee5\u4eceSpring Environment\u4e2d\u516c\u5f00\u5c5e\u6027\uff0c\u4ee5\u4fbf\u5728Logback\u4e2d\u4f7f\u7528\u3002\u5982\u679c\u4f60\u60f3\u5728Logback\u914d\u7f6e\u4e2d\u8bbf\u95eeapplication.property\u6587\u4ef6\u4e2d\u7684\u503c\uff0c\u8fd9\u6837\u505a\u5f88\u6709\u7528\u3002\u8be5\u6807\u7b7e\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e Logback \u7684\u6807\u51c6  \u6807\u7b7e\u7c7b\u4f3c\u3002\u7136\u800c\uff0c\u4f60\u4e0d\u662f\u76f4\u63a5\u6307\u5b9a\u4e00\u4e2a\u503c\uff0c\u800c\u662f\u6307\u5b9a\u5c5e\u6027\u7684\u6765\u6e90\uff08\u6765\u81eaEnvironment\uff09\u3002\u5982\u679c\u4f60\u9700\u8981\u5c06\u5c5e\u6027\u5b58\u50a8\u5728\u672c\u5730\u8303\u56f4\u4ee5\u5916\u7684\u5730\u65b9\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 scope \u5c5e\u6027\u3002\u5982\u679c\u4f60\u9700\u8981\u4e00\u4e2a\u540e\u5907\u503c\uff08\u5728\u73af\u5883\u4e2d\u6ca1\u6709\u8bbe\u7f6e\u5c5e\u6027\u7684\u60c5\u51b5\u4e0b\uff09\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528defaultValue\u5c5e\u6027\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u5728 Logback \u4e2d\u516c\u5f00\u5c5e\u6027\u3002 <pre><code>&lt;springProperty scope=\"context\" name=\"fluentHost\" source=\"myapp.fluentd.host\"\n        defaultValue=\"localhost\"/&gt;\n&lt;appender name=\"FLUENT\" class=\"ch.qos.logback.more.appenders.DataFluentAppender\"&gt;\n    &lt;remoteHost&gt;${fluentHost}&lt;/remoteHost&gt;\n    ...\n&lt;/appender&gt;\n</code></pre> <p>\u4e0b\u9762\u662f\u5b9e\u9645\u53c2\u8003\u6848\u4f8b</p> <pre><code>&lt;define name=\"appId\" class=\"com.zhangmen.arch.logger.component.common.AppIdDefiner\"/&gt;\n\n    &lt;springProperty scope=\"context\" name=\"springAppName\" source=\"spring.application.name\"/&gt;\n\n    &lt;springProperty scope=\"context\" name=\"logSwitch\" source=\"port.http.server\"/&gt;\n\n    &lt;!-- log maxFileSize --&gt;\n    &lt;springProperty scope=\"context\" name=\"MAX_FILE_SIZE\" source=\"spring.logback.max-file-size\" defaultValue=\"100MB\"/&gt;\n\n    &lt;!-- log maxIndex --&gt;\n    &lt;springProperty scope=\"context\" name=\"MAX_INDEX\" source=\"spring.logback.max-index\" defaultValue=\"5\"/&gt;\n\n    &lt;springProperty scope=\"context\" name=\"MASK_FIELDS\" source=\"log.mask.fields\" defaultValue=\"message,input_param,output_param,header_param\"/&gt;\n\n    &lt;springProperty scope=\"context\" name=\"MASK_REGEX_TYPES\" source=\"log.mask.regex.types\" defaultValue=\"mobile\"/&gt;\n\n    &lt;springProperty scope=\"context\" name=\"MASK_REGEX_MATCH_MAX_DEPTH\" source=\"log.mask.regex.match.max.depth\" defaultValue=\"12\"/&gt;\n\n    &lt;springProperty scope=\"context\" name=\"MASK_REGEX_MATCH_MAX_LENGTH\" source=\"log.mask.regex.match.max.length\" defaultValue=\"2048\"/&gt;\n</code></pre> <p>source\u53ef\u4ee5\u6765\u81ea\u914d\u7f6e\u6587\u4ef6\u548c\u7cfb\u7edf\u5c5e\u6027</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#5","title":"5. \u56fd\u9645\u5316","text":"<p>Spring boot\u652f\u6301\u672c\u5730\u5316\u4fe1\u606f\uff0c\u6240\u4ee5\u4f60\u7684\u7a0b\u5e8f\u53ef\u4ee5\u6ee1\u8db3\u4e0d\u540c\u8bed\u8a00\u7684\u7528\u6237\u3002\u9ed8\u8ba4Spring Boot\u4f1a\u5728classpath\u5bfb\u627eresource bundle\u7684messages\u3002</p> <p>\u81ea\u52a8\u914d\u7f6e\u9002\u7528\u4e8e\u5df2\u914d\u7f6e\u7684 resource bundle\u7684\u9ed8\u8ba4\u5c5e\u6027\u6587\u4ef6\u53ef\u7528\u65f6\uff08\u5373\u9ed8\u8ba4\u7684 messages.properties\uff09\u3002\u5982\u679c\u60a8\u7684 resource bundle\u53ea\u5305\u542b\u7279\u5b9a\u8bed\u8a00\u7684\u5c5e\u6027\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u6dfb\u52a0\u9ed8\u8ba4\u7684\u3002\u5982\u679c\u6ca1\u6709\u627e\u5230\u4e0e\u4efb\u4f55\u914d\u7f6e\u7684\u57fa\u7840\u540d\u79f0\u76f8\u5339\u914d\u7684\u5c5e\u6027\u6587\u4ef6\uff0c\u5219\u4e0d\u4f1a\u6709\u81ea\u52a8\u914d\u7f6e\u7684MessageSource\u3002</p> <p>resource bundle\u8d44\u6e90\u5305\u7684basename \u4ee5\u53ca\u5176\u4ed6\u4e00\u4e9b\u5c5e\u6027\u53ef\u4ee5\u4f7f\u7528spring.messages\u547d\u540d\u7a7a\u95f4\u8fdb\u884c\u914d\u7f6e\uff0c\u5982\u4e0b\u4f8b\u6240\u793a:</p> <pre><code>spring.messages.basename=messages,config.i18n.messages\nspring.messages.fallback-to-system-locale=false\n</code></pre> <p><code>spring.messages.basename</code>\u652f\u6301\u4ee5\u9017\u53f7\u5206\u9694\u7684\uff0c\u53ef\u4ee5\u662f\u5305\u9650\u5b9a\u7b26\uff0c\u4e5f\u53ef\u4ee5\u662f\u4ececlasspath\u6839\u76ee\u5f55\u89e3\u6790\u7684\u8d44\u6e90\u3002</p> <p>\u66f4\u591a\u7ec6\u8282\u67e5\u770b <code>MessageSourceProperties</code></p>"},{"location":"java/spring/spring-boot/spring-boot-features/#6-json","title":"6. JSON","text":"<p>spring\u63d0\u4f9b\u4e86\u4e09\u79cdJSON\u5e93\u7684\u96c6\u6210\uff0c\u5305\u62ecGson\uff0cjackson, JSON-B\uff0c</p> <p>Jackson\u662f\u9996\u9009\u548c\u9ed8\u8ba4\u7684\u5e93</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#61-jackson","title":"6.1 Jackson","text":"<p>Jackson \u7684\u81ea\u52a8\u914d\u7f6e\u5df2\u63d0\u4f9b\uff0c\u662f<code>spring-boot-starter-json</code>\u7684\u4e00\u90e8\u5206\u3002\u5f53Jackson \u5728\u7c7b\u8def\u5f84\u65f6\uff0cObjectMapper\u4f1a\u88ab\u81ea\u52a8\u914d\u7f6e\uff0c\u914d\u7f6e\u9879\u53c2\u770b customizing the configuration of the <code>ObjectMapper</code>\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#62-gson","title":"6.2 Gson","text":"<p>Gson\u81ea\u52a8\u914d\u7f6e\u5df2\u63d0\u4f9b\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#63-json-b","title":"6.3  JSON-B","text":"<p>JSON-B\u81ea\u52a8\u914d\u7f6e\u5df2\u63d0\u4f9b\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#8-shutdown","title":"8. \u4f18\u96c5\u7684shutdown\u670d\u52a1","text":"<p>\u6240\u6709\u56db\u79cd\u5d4c\u5165\u5f0fWeb\u670d\u52a1\u5668\uff08Jetty\u3001Reactor Netty\u3001Tomcat\u548cUndertow\uff09\u4ee5\u53ca\u53cd\u5e94\u5f0f\u548c\u57fa\u4e8eServlet\u7684Web\u5e94\u7528\u7a0b\u5e8f\u90fd\u652f\u6301\u4f18\u96c5\u5173\u95ed\u3002\u5b83\u4f5c\u4e3a\u5173\u95ed\u5e94\u7528\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u7684\u4e00\u90e8\u5206\u53d1\u751f\uff0c\u5e76\u5728\u505c\u6b62SmartLifecycle beans\u7684\u6700\u65e9\u9636\u6bb5\u6267\u884c\u3002\u8fd9\u4e2a\u505c\u6b62\u5904\u7406\u4f7f\u7528\u4e86\u4e00\u4e2a\u8d85\u65f6\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5bbd\u9650\u671f\uff0c\u5728\u8fd9\u4e2a\u5bbd\u9650\u671f\u5185\uff0c\u73b0\u6709\u7684\u8bf7\u6c42\u5c06\u88ab\u5141\u8bb8\u5b8c\u6210\uff0c\u4f46\u4e0d\u5141\u8bb8\u6709\u65b0\u7684\u8bf7\u6c42\u3002\u4e0d\u5141\u8bb8\u65b0\u8bf7\u6c42\u7684\u5177\u4f53\u65b9\u5f0f\u6839\u636e\u4f7f\u7528\u7684Web\u670d\u52a1\u5668\u800c\u4e0d\u540c\u3002Jetty\u3001Reactor Netty\u548cTomcat\u5c06\u5728\u7f51\u7edc\u5c42\u505c\u6b62\u63a5\u53d7\u8bf7\u6c42\u3002Undertow\u5c06\u63a5\u53d7\u8bf7\u6c42\uff0c\u4f46\u4f1a\u7acb\u5373\u4ee5\u670d\u52a1\u4e0d\u53ef\u7528\uff08503\uff09\u54cd\u5e94\u3002</p> <p>Graceful shutdown \u8981\u6c42Tomcat \u7248\u672c\u57289.0.33+\u3002</p> <p>\u5f00\u542f\u4f18\u96c5\u7684\u505c\u6b62\u670d\u52a1\uff0c\u9700\u8981\u914d\u7f6e</p> <pre><code>server.shutdown=graceful\n</code></pre> <p>\u914d\u7f6e\u8fc7\u671f\u65f6\u95f4\u5982\uff1a</p> <pre><code>spring.lifecycle.timeout-per-shutdown-phase=20s\n</code></pre> <p>\u6ce8\u610f\uff1aUsing graceful shutdown with your IDE may not work properly if it does not send a proper <code>SIGTERM</code> signal.</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#13-caching","title":"13. Caching","text":"<p>Spring\u6846\u67b6\u63d0\u4f9b\u4e86\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u5730\u6dfb\u52a0\u7f13\u5b58\u7684\u652f\u6301\u3002\u5176\u6838\u5fc3\u662f\u5c06\u7f13\u5b58\u5e94\u7528\u4e8e\u65b9\u6cd5\uff0c\u4ece\u800c\u57fa\u4e8e\u7f13\u5b58\u4e2d\u7684\u53ef\u7528\u4fe1\u606f\u51cf\u5c11\u65b9\u6cd5\u7684\u6267\u884c\u6b21\u6570\u3002\u7f13\u5b58\u903b\u8f91\u662f\u900f\u660e\u7684\uff0c\u5bf9\u8c03\u7528\u8005\u6ca1\u6709\u4efb\u4f55\u5e72\u6270\u3002\u53ea\u8981\u901a\u8fc7@EnableCaching\u6ce8\u89e3\u542f\u7528\u4e86\u7f13\u5b58\uff0cSpring Boot\u5c31\u4f1a\u81ea\u52a8\u914d\u7f6e\u7f13\u5b58\u57fa\u7840\u67b6\u6784\u3002</p> <p>\u66f4\u591a\u7ec6\u8282\u53c2\u89c1Spring\u7684relevant section \u3002</p> <pre><code>import org.springframework.cache.annotation.Cacheable;\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class MathService {\n\n    @Cacheable(\"piDecimals\")\n    public int computePiDecimal(int i) {\n        // ...\n    }\n\n}\n</code></pre> <p>\u8fd9\u4e2a\u4f8b\u5b50\u6f14\u793a\u4e86\u5728\u4e00\u4e2a\u6f5c\u5728\u7684\u8017\u65f6\u64cd\u4f5c\u4e0a\u4f7f\u7528\u7f13\u5b58\u3002\u5728\u8c03\u7528computePiDecimal\u65b9\u6cd5\u4e4b\u524d\uff0c\u62bd\u8c61\u5728piDecimals\u7f13\u5b58\u4e2d\u5bfb\u627e\u4e0ei\u53c2\u6570\u5339\u914d\u7684\u6761\u76ee\u3002\u5982\u679c\u627e\u5230\u4e86\u4e00\u4e2a\u6761\u76ee\uff0c\u7f13\u5b58\u4e2d\u7684\u5185\u5bb9\u4f1a\u7acb\u5373\u8fd4\u56de\u7ed9\u8c03\u7528\u8005\uff0c\u8be5\u65b9\u6cd5\u4e0d\u4f1a\u88ab\u8c03\u7528\u3002\u5426\u5219\uff0c\u8be5\u65b9\u6cd5\u5c06\u88ab\u8c03\u7528\uff0c\u5e76\u5728\u8fd4\u56de\u4e4b\u524d\u66f4\u65b0\u7f13\u5b58\u3002</p> <p>\u60a8\u4e5f\u53ef\u4ee5\u900f\u660e\u5730\u4f7f\u7528\u6807\u51c6\u7684JSR-107\uff08JCache\uff09\u6ce8\u89e3\uff08\u5982@CacheResult\uff09\u3002\u7136\u800c\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u60a8\u4e0d\u8981\u6df7\u5408\u548c\u5339\u914dSpring Cache\u548cJCache\u6ce8\u89e3\u3002</p> <p>\u5982\u679c\u60a8\u6ca1\u6709\u6dfb\u52a0\u4efb\u4f55\u7279\u5b9a\u7684\u7f13\u5b58\u5e93\uff0cSpring Boot \u4f1a\u81ea\u52a8\u914d\u7f6e\u4e00\u4e2a\u57fa\u4e8e\u5185\u5b58\u7684concurrent map\u7684\u7b80\u5355\u63d0\u4f9b\u8005\u3002\u5f53\u9700\u8981\u7f13\u5b58\u65f6\uff08\u5982\u524d\u9762\u4f8b\u5b50\u4e2d\u7684piDecimals\uff09\uff0c\u8be5\u63d0\u4f9b\u8005\u4f1a\u4e3a\u60a8\u521b\u5efa\u7f13\u5b58\u3002\u8fd9\u4e2a\u7b80\u5355\u7684\u63d0\u4f9b\u8005\u5e76\u4e0d\u63a8\u8350\u7528\u4e8e\u751f\u4ea7\u7528\u9014\uff0c\u4f46\u5b83\u5bf9\u4e8e\u5165\u95e8\u548c\u786e\u4fdd\u4f60\u4e86\u89e3\u5176\u529f\u80fd\u662f\u975e\u5e38\u597d\u7684\u3002\u5f53\u60a8\u51b3\u5b9a\u4f7f\u7528\u7f13\u5b58\u63d0\u4f9b\u8005\u65f6\uff0c\u8bf7\u52a1\u5fc5\u9605\u8bfb\u5b83\u7684\u6587\u6863\uff0c\u4ee5\u4e86\u89e3\u5982\u4f55\u914d\u7f6e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u7684\u7f13\u5b58\u3002\u51e0\u4e4e\u6240\u6709\u7684\u63d0\u4f9b\u8005\u90fd\u8981\u6c42\u4f60\u660e\u786e\u914d\u7f6e\u4f60\u4f7f\u7528\u7684\u6bcf\u4e2a\u7f13\u5b58\u3002\u6709\u4e9b\u63d0\u4f9b\u4e86\u4e00\u79cd\u65b9\u6cd5\u6765\u5b9a\u5236\u7531spring.cache.cache-name\u5c5e\u6027\u5b9a\u4e49\u7684\u9ed8\u8ba4\u7f13\u5b58\u3002</p> <p>\u5f53\u7136\u4e5f\u63d0\u4f9b\u4e86\u7f13\u5b58\u7684 update \u6216 evict \u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#131","title":"13.1 \u7f13\u5b58\u63d0\u4f9b\u8005\u7684\u652f\u6301","text":"<p>\u7f13\u5b58\u62bd\u8c61\u5e76\u4e0d\u63d0\u4f9b\u5b9e\u9645\u7684\u5b58\u50a8\uff0c\u800c\u662f\u4f9d\u8d56\u4e8e <code>org.springframework.cache.Cache</code> \u548c <code>org.springframework.cache.CacheManager</code> \u63a5\u53e3\u6240\u5b9e\u73b0\u7684\u62bd\u8c61\u3002</p> <p>\u5982\u679c\u60a8\u6ca1\u6709\u5b9a\u4e49<code>CacheManager</code>\u7c7b\u578b\u7684bean\u6216\u540d\u4e3a<code>cacheResolver</code>\u7684CacheResolver\uff08\u53c2\u89c1 <code>CachingConfigurer</code>\uff09\uff0cSpring Boot\u4f1a\u5c1d\u8bd5\u68c0\u6d4b\u4ee5\u4e0b\u63d0\u4f9b\u8005\uff08\u6309\u6307\u5b9a\u987a\u5e8f\uff09:</p> <ol> <li>Generic</li> <li>JCache (JSR-107) (EhCache 3, Hazelcast, Infinispan, and others)</li> <li>EhCache 2.x</li> <li>Hazelcast</li> <li>Infinispan</li> <li>Couchbase</li> <li>Redis</li> <li>Caffeine</li> <li>Simple</li> </ol> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e<code>spring.cache.type</code>\u5c5e\u6027\u6765\u5f3a\u5236\u4f7f\u7528\u7279\u5b9a\u7684\u7f13\u5b58\u63d0\u4f9b\u8005\u3002\u5982\u679c\u4f60\u9700\u8981\u5728\u7279\u5b9a\u7684\u73af\u5883\u4e2d\uff08\u6bd4\u5982\u6d4b\u8bd5\uff09\u5b8c\u5168\u7981\u6b62\u7f13\u5b58\uff0c\u8bf7\u4f7f\u7528\u8fd9\u4e2a\u5c5e\u6027\u3002</p> <p>\u4f7f\u7528spring-boot-starter-cache, \"starter \"\u4f1a\u5feb\u901f\u6dfb\u52a0\u57fa\u672c\u7684\u7f13\u5b58\u4f9d\u8d56\u3002\u5f15\u5165spring-context-support\u3002\u5982\u679c\u4e0d\u4f7f\u7528starter\u5373\u624b\u52a8\u6dfb\u52a0\u4f9d\u8d56\u5173\u7cfb\uff0c\u4f60\u5fc5\u987b\u5305\u542bspring-context-support\u624d\u80fd\u4f7f\u7528JCache\u3001EhCache 2.x\u6216Caffeine\u652f\u6301\u3002</p> <p>\u5982\u679cCacheManager\u662f\u7531Spring Boot\u81ea\u52a8\u914d\u7f6e\u7684\uff0c\u60a8\u53ef\u4ee5\u5728\u5b83\u5b8c\u5168\u521d\u59cb\u5316\u4e4b\u524d\uff0c\u901a\u8fc7\u5b9e\u73b0<code>CacheManagerCustomizer</code>\u63a5\u53e3\u7684Bean\u6765\u8fdb\u4e00\u6b65\u8c03\u6574\u5b83\u7684\u914d\u7f6e\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u6807\u5fd7\uff0c\u8868\u793anull\u503c\u5e94\u8be5\u88ab\u4f20\u9012\u7ed9\u5e95\u5c42map:</p> <pre><code>@Bean\npublic CacheManagerCustomizer&lt;ConcurrentMapCacheManager&gt; cacheManagerCustomizer() {\n    return new CacheManagerCustomizer&lt;ConcurrentMapCacheManager&gt;() {\n        @Override\n        public void customize(ConcurrentMapCacheManager cacheManager) {\n            cacheManager.setAllowNullValues(false);\n        }\n    };\n}\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u5e0c\u671b\u6709\u4e00\u4e2a\u81ea\u52a8\u914d\u7f6e\u7684 ConcurrentMapCacheManager\u3002\u5982\u679c\u4e0d\u662f\u8fd9\u6837\u7684\u8bdd(\u4f60\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684\u914d\u7f6e\u6216\u8005\u662f\u81ea\u52a8\u914d\u7f6e\u4e86\u5176\u4ed6\u7684\u7f13\u5b58\u63d0\u4f9b\u8005)\uff0c\u5b9a\u5236\u5668\u6839\u672c\u4e0d\u4f1a\u88ab\u8c03\u7528\u3002\u4f60\u53ef\u4ee5\u62e5\u6709\u4efb\u610f\u591a\u7684\u81ea\u5b9a\u4e49\u5668\uff0c\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528@Order\u6216Ordered\u6765\u6307\u5b9a\u987a\u5e8f\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#1311-generic","title":"13.1.1 Generic","text":"<p>\u5982\u679c\u4e0a\u4e0b\u6587\u5b9a\u4e49\u4e86\u81f3\u5c11\u4e00\u4e2a<code>org.springframework.cache.Cache</code> bean\uff0c\u5219\u4f7f\u7528\u901a\u7528\u7f13\u5b58\u3002\u4f1a\u521b\u5efa\u4e00\u4e2a\u5305\u88f9\u8be5\u7c7b\u578b\u6240\u6709bean\u7684CacheManager\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#1317-redis","title":"13.1.7 Redis","text":"<p>If Redis is available and configured, a <code>RedisCacheManager</code> is auto-configured. It is possible to create additional caches on startup by setting the <code>spring.cache.cache-names</code> property and cache defaults can be configured by using <code>spring.cache.redis.*</code> properties. For instance, the following configuration creates <code>cache1</code> and <code>cache2</code> caches with a time to live of 10 minutes:</p> <p>\u5982\u679cRedis\u53ef\u7528\u5e76\u914d\u7f6e\u4e86\uff0c\u5219\u4f1a\u81ea\u52a8\u914d\u7f6eRedisCacheManager\u3002\u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u901a\u8fc7\u8bbe\u7f6e<code>spring.cache.cache-name</code>\u5c5e\u6027\u6765\u521b\u5efa\u989d\u5916\u7684\u7f13\u5b58\uff0c\u7f13\u5b58\u9ed8\u8ba4\u503c\u53ef\u4ee5\u901a\u8fc7<code>spring.cache.redis.*</code>\u5c5e\u6027\u6765\u914d\u7f6e\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u914d\u7f6e\u4f1a\u521b\u5efacache1\u548ccache2\u7f13\u5b58\uff0c\u751f\u5b58\u65f6\u95f4\u4e3a10\u5206\u949f:</p> <pre><code>spring.cache.cache-names=cache1,cache2\nspring.cache.redis.time-to-live=10m\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f1a\u6dfb\u52a0\u4e00\u4e2a\u952e\u524d\u7f00\uff0c\u8fd9\u6837\uff0c\u5373\u4f7f\u4e24\u4e2a\u72ec\u7acb\u7684\u7f13\u5b58\u4f7f\u7528\u76f8\u540c\u7684\u952e\uff0cRedis\u4e5f\u4e0d\u4f1a\u6709\u91cd\u53e0\u7684\u952e\uff0c\u4e0d\u4f1a\u8fd4\u56de\u65e0\u6548\u7684\u503c\u3002\u5982\u679c\u4f60\u521b\u5efa\u4e86\u81ea\u5df1\u7684RedisCacheManager\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u4fdd\u6301\u8fd9\u4e2a\u8bbe\u7f6e\u3002</p> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>RedisCacheConfiguration</code> \u7684@Bean\u6765\u5b8c\u5168\u63a7\u5236\u9ed8\u8ba4\u914d\u7f6e\u3002\u5982\u679c\u4f60\u60f3\u5b9a\u5236\u9ed8\u8ba4\u7684\u5e8f\u5217\u5316\u7b56\u7565\uff0c\u8fd9\u5f88\u6709\u7528\u3002</p> <p>\u5982\u679c\u4f60\u9700\u8981\u63a7\u5236\u66f4\u591a\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u8003\u8651\u6ce8\u518c\u4e00\u4e2a<code>RedisCacheManagerBuilderCustomizer</code> bean\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u663e\u793a\u4e86\u4e00\u4e2a\u81ea\u5b9a\u4e49\u5668\uff0c\u5b83\u4e3acache1\u548ccache2\u914d\u7f6e\u4e86\u4e00\u4e2a\u7279\u5b9a\u7684\u751f\u5b58\u65f6\u95f4\u3002</p> <pre><code>@Bean\npublic RedisCacheManagerBuilderCustomizer myRedisCacheManagerBuilderCustomizer() {\n    return (builder) -&gt; builder\n            .withCacheConfiguration(\"cache1\",                   RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofSeconds(10)))\n            .withCacheConfiguration(\"cache2\",\n              RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(1)));\n\n}\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#1318-caffeine","title":"13.1.8 Caffeine","text":"<p>Caffeine\u662fJava 8\u5bf9Guava\u7f13\u5b58\u7684\u91cd\u5199\uff0c\u53d6\u4ee3\u4e86\u5bf9Guava\u7684\u652f\u6301\u3002\u5982\u679c\u5b58\u5728Caffeine\uff0c\u5219\u4f1a\u81ea\u52a8\u914d\u7f6e\u4e00\u4e2a<code>CaffeineCacheManager</code>\uff08\u7531<code>spring-boot-starter-cache</code> \"Starter \"\u63d0\u4f9b\uff09\u3002\u7f13\u5b58\u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u901a\u8fc7\u8bbe\u7f6e<code>spring.cache.cache-names</code>\u5c5e\u6027\u6765\u521b\u5efa\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u4e4b\u4e00\u6765\u5b9a\u5236\uff08\u6309\u6307\u793a\u987a\u5e8f\uff09:</p> <ol> <li><code>spring.cache.caffeine.spec</code>\u5b9a\u4e49\u7684\u7f13\u5b58</li> <li><code>com.github.benmanes.caffeine.cache.CaffeineSpec</code> bean\u6240\u5b9a\u4e49\u7684</li> <li><code>com.github.benmanes.caffeine.cache.Caffeine</code> bean\u6240\u5b9a\u4e49\u7684</li> </ol> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u914d\u7f6e\u521b\u5efa\u4e86cache1\u548ccache2\u7f13\u5b58\uff0c\u6700\u5927\u5927\u5c0f\u4e3a500\uff0c\u751f\u5b58\u65f6\u95f4\u4e3a10\u5206\u949f\u3002</p> <pre><code>spring.cache.cache-names=cache1,cache2\nspring.cache.caffeine.spec=maximumSize=500,expireAfterAccess=600s\n</code></pre> <p>\u5982\u679c\u5b9a\u4e49\u4e86<code>com.github.benmanes.caffeine.cache.CacheLoader</code> bean\uff0c\u5b83\u5c06\u81ea\u52a8\u5173\u8054\u5230CaffeineCacheManager\u3002\u7531\u4e8eCacheLoader\u5c06\u4e0e\u7f13\u5b58\u7ba1\u7406\u5668\u7ba1\u7406\u7684\u6240\u6709\u7f13\u5b58\u76f8\u5173\u8054\uff0c\u6240\u4ee5\u5b83\u5fc5\u987b\u88ab\u5b9a\u4e49\u4e3aCacheLoader\u3002\u81ea\u52a8\u914d\u7f6e\u4f1a\u5ffd\u7565\u4efb\u4f55\u5176\u4ed6\u901a\u7528\u7c7b\u578b\u3002 <p>\u53c2\u8003\u6587\u7ae0</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#1319-simple","title":"13.1.9 Simple","text":"<p>\u5982\u679c\u627e\u4e0d\u5230\u5176\u4ed6\u7684\u63d0\u4f9b\u8005\uff0c\u5219\u4f7f\u7528ConcurrentHashMap\u4f5c\u4e3a\u7f13\u5b58\u5b58\u50a8\u3002\u5982\u679c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6ca1\u6709\u7f13\u5b58\u5e93\uff0c\u8fd9\u662f\u9ed8\u8ba4\u7684\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7f13\u5b58\u662f\u6839\u636e\u9700\u8981\u521b\u5efa\u7684\uff0c\u4f46\u60a8\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6ecache-name\u5c5e\u6027\u6765\u9650\u5236\u53ef\u7528\u7f13\u5b58\u7684\u5217\u8868\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u53ea\u60f3\u8981cache1\u548ccache2\u7f13\u5b58\uff0c\u5219\u8bbe\u7f6ecache-name\u5c5e\u6027\u5982\u4e0b\u3002</p> <pre><code>spring.cache.cache-names=cache1,cache2\n</code></pre> <p>\u5982\u679c\u60a8\u8fd9\u6837\u505a\uff0c\u5e76\u4e14\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u4e86\u672a\u5217\u51fa\u7684\u7f13\u5b58\uff0c\u90a3\u4e48\u5f53\u9700\u8981\u7f13\u5b58\u65f6\uff0c\u5b83\u4f1a\u5728\u8fd0\u884c\u65f6\u5931\u8d25\uff0c\u4f46\u5728\u542f\u52a8\u65f6\u4e0d\u4f1a\u3002\u8fd9\u4e0e \"\u771f\u6b63\u7684 \"\u7f13\u5b58\u63d0\u4f9b\u8005\u5728\u4f7f\u7528\u672a\u58f0\u660e\u7684\u7f13\u5b58\u65f6\u7684\u884c\u4e3a\u65b9\u5f0f\u7c7b\u4f3c\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#13110-none","title":"13.1.10 None","text":"<p>\u5f53\u4f60\u7684\u914d\u7f6e\u4e2d\u5b58\u5728@EnableCaching\u65f6\uff0c\u4e5f\u5e0c\u671b\u6709\u5408\u9002\u7684\u7f13\u5b58\u914d\u7f6e\u3002\u5982\u679c\u4f60\u9700\u8981\u5728\u67d0\u4e9b\u73af\u5883\u4e2d\u5b8c\u5168\u7981\u6b62\u7f13\u5b58\uff0c\u53ef\u4ee5\u5f3a\u5236\u7f13\u5b58\u7c7b\u578b\u4e3anone\uff0c\u4f7f\u7528\u65e0\u64cd\u4f5c\u7684\u5b9e\u73b0\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>spring.cache.type=none\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#17-validation","title":"17. Validation","text":"<p>The method validation feature supported by Bean Validation 1.1 is automatically enabled as long as a JSR-303 implementation (such as Hibernate validator) is on the classpath. This lets bean methods be annotated with <code>javax.validation</code> constraints on their parameters and/or on their return value. Target classes with such annotated methods need to be annotated with the <code>@Validated</code> annotation at the type level for their methods to be searched for inline constraint annotations.</p> <p>\u53ea\u8981classpath\u4e0a\u6709JSR-303d\u7684\u5b9e\u73b0\uff08\u5982Hibernate validator\uff09\uff0cBean Validation 1.1\u652f\u6301\u7684\u65b9\u6cd5\u9a8c\u8bc1\u529f\u80fd\u5c31\u4f1a\u81ea\u52a8\u542f\u7528\u3002\u8fd9\u4f7f\u5f97bean\u65b9\u6cd5\u53ef\u4ee5\u5728\u5176\u53c2\u6570\u548c/\u6216\u8fd4\u56de\u503c\u4e0a\u4f7f\u7528javax.validation\u7ea6\u675f\u8fdb\u884c\u6ce8\u89e3\u3002\u5177\u6709\u8fd9\u79cd\u6ce8\u89e3\u65b9\u6cd5\u7684\u76ee\u6807\u7c7b\u9700\u8981\u5728\u7c7b\u4e0a\u6dfb\u52a0@Validated\u6ce8\u89e3\uff0c\u4ee5\u4fbf\u641c\u7d22\u5176\u65b9\u6cd5\u7684\u5185\u8054\u7ea6\u675f\u6ce8\u89e3\u3002</p> <p>\u4e0b\u9762\u7684\u4ee3\u7801\u4f1a\u89e6\u53d1\u7b2c\u4e00\u4e2a\u53c2\u6570\u7684\u6821\u9a8c\uff0c\u786e\u4fdd\u5176\u5927\u5c0f\u57288\u523010\u4e4b\u95f4\uff1a</p> <pre><code>@Service\n@Validated\npublic class MyBean {\n\n    public Archive findByCodeAndAuthor(@Size(min = 8, max = 10) String code,\n            Author author) {\n        ...\n    }\n\n}\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#29","title":"29. \u521b\u5efa\u81ea\u5b9a\u4e49\u7684\u81ea\u52a8\u914d\u7f6e","text":"<p>\u5982\u679c\u4f60\u5728\u4e00\u4e2a\u5f00\u53d1\u5171\u4eab\u5e93\u7684\u516c\u53f8\u5de5\u4f5c\uff0c\u6216\u8005\u4f60\u5728\u4e00\u4e2a\u5f00\u6e90\u6216\u5546\u4e1a\u5e93\u4e0a\u5de5\u4f5c\uff0c\u4f60\u53ef\u80fd\u60f3\u5f00\u53d1\u81ea\u5df1\u7684\u81ea\u52a8\u914d\u7f6e\u3002\u81ea\u52a8\u914d\u7f6e\u7c7b\u53ef\u4ee5\u6346\u7ed1\u5728\u5916\u90e8jars\u4e2d\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u88abSpring Boot\u63a5\u6536\u3002</p> <p>\u81ea\u52a8\u914d\u7f6e\u53ef\u4ee5\u5173\u8054\u5230\u4e00\u4e2a \"starter\"\uff0c\u8be5starter\u63d0\u4f9b\u81ea\u52a8\u914d\u7f6e\u4ee3\u7801\u4ee5\u53ca\u60a8\u5c06\u4f7f\u7528\u7684\u4f9d\u8d56\u5e93\u3002\u6211\u4eec\u9996\u5148\u4ecb\u7ecd\u60a8\u9700\u8981\u77e5\u9053\u7684\u6784\u5efa\u60a8\u81ea\u5df1\u7684\u81ea\u52a8\u914d\u7f6e\uff0c\u7136\u540e\u6211\u4eec\u7ee7\u7eed\u4ecb\u7ecd\u521b\u5efa\u81ea\u5b9a\u4e49\u542f\u52a8\u5668\u6240\u9700\u7684\u5178\u578b\u6b65\u9aa4\u3002</p> <p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u53c2\u8003\u793a\u4f8b\uff1ademo project</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#291-auto-configuredbean","title":"29.1 \u7406\u89e3 Auto-configured\u7684Bean","text":"<p>\u5728\u5916\u58f3\u4e0b\uff0c\u81ea\u52a8\u914d\u7f6e\u662f\u901a\u8fc7\u6807\u51c6\u7684<code>@Configuration</code>\u7c7b\u5b9e\u73b0\u7684\u3002\u989d\u5916\u7684@Conditional\u6ce8\u89e3\u7528\u4e8e\u9650\u5236\u81ea\u52a8\u914d\u7f6e\u4f55\u65f6\u5e94\u7528\u3002\u901a\u5e38\uff0c\u81ea\u52a8\u914d\u7f6e\u7c7b\u4f7f\u7528 @ConditionalOnClass \u548c @ConditionalOnMissingBean \u6ce8\u89e3\u3002\u8fd9\u786e\u4fdd\u4e86\u81ea\u52a8\u914d\u7f6e\u53ea\u5728\u627e\u5230\u76f8\u5173\u7684\u7c7b\u5e76\u4e14\u4f60\u6ca1\u6709\u58f0\u660e\u81ea\u5df1\u7684@Configuration\u65f6\u624d\u4f1a\u5e94\u7528\u3002</p> <p>\u4f60\u53ef\u4ee5\u6d4f\u89c8spring-boot-autoconfigure\u7684\u6e90\u4ee3\u7801\u6765\u67e5\u770bSpring\u63d0\u4f9b\u7684@Configuration\u7c7b\uff08\u53c2\u89c1<code>META-INF/spring.factories</code>\u6587\u4ef6\uff09\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#292","title":"29.2 \u67e5\u627e\u81ea\u52a8\u914d\u7f6e\u7684\u5019\u9009\u4eba","text":"<p>springboot\u4f1a\u5728\u53d1\u5e03\u7684jar\u5305\u4e2d\u5bfb\u627e<code>META-INF/spring.factories</code>\u6587\u4ef6\uff0c\u8fd9\u4e2a\u6587\u4ef6\u4f1a\u5217\u51faEnableAutoConfiguration\u8fd9\u4e2akey\u5bf9\u5e94value\uff0c</p> <pre><code>org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\ncom.mycorp.libx.autoconfigure.LibXAutoConfiguration,\\\ncom.mycorp.libx.autoconfigure.LibXWebAutoConfiguration\n</code></pre> <p>\u81ea\u52a8\u914d\u7f6e\u5fc5\u987b\u53ea\u80fd\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u52a0\u8f7d\u3002\u786e\u4fdd\u5b83\u4eec\u88ab\u5b9a\u4e49\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u5305\u7a7a\u95f4\u4e2d\uff0c\u5e76\u4e14\u5b83\u4eec\u7edd\u4e0d\u662f\u7ec4\u4ef6\u626b\u63cf\u7684\u76ee\u6807\u3002\u6b64\u5916\uff0c\u81ea\u52a8\u914d\u7f6e\u7c7b\u4e0d\u5e94\u8be5\u542f\u7528\u7ec4\u4ef6\u626b\u63cf\u6765\u5bfb\u627e\u989d\u5916\u7684\u7ec4\u4ef6\u3002\u5e94\u8be5\u4f7f\u7528\u7279\u5b9a\u7684@Imports\u6765\u4ee3\u66ff\u3002</p> <p>You can use the @AutoConfigureAfter or @AutoConfigureBefore annotations if your configuration needs to be applied in a specific order. For example, if you provide web-specific configuration, your class may need to be applied after WebMvcAutoConfiguration.</p> <p>If you want to order certain auto-configurations that should not have any direct knowledge of each other, you can also use @AutoConfigureOrder. That annotation has the same semantic as the regular @Order annotation but provides a dedicated order for auto-configuration classes.</p> <p>As with standard @Configuration classes, the order in which auto-configuration classes are applied only affects the order in which their beans are defined. The order in which those beans are subsequently created is unaffected and is determined by each bean\u2019s dependencies and any @DependsOn relationships.</p> <p>\u5982\u679c\u60a8\u7684\u914d\u7f6e\u9700\u8981\u4ee5\u7279\u5b9a\u7684\u987a\u5e8f\u5e94\u7528\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>@AutoConfigureAfter</code> \u6216 @AutoConfigureBefore \u6ce8\u89e3\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u63d0\u4f9b\u7279\u5b9a\u4e8e Web \u7684\u914d\u7f6e\uff0c\u60a8\u7684\u7c7b\u53ef\u80fd\u9700\u8981\u5728 WebMvcAutoConfiguration \u4e4b\u540e\u5e94\u7528\u3002</p> <p>\u5982\u679c\u60a8\u60f3\u5bf9\u67d0\u4e9b\u4e0d\u5e94\u8be5\u6709\u4efb\u4f55\u76f4\u63a5\u77e5\u8bc6\u7684\u81ea\u52a8\u914d\u7f6e\u8fdb\u884c\u6392\u5e8f\uff0c\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528@AutoConfigureOrder\u3002\u8be5\u6ce8\u89e3\u4e0e\u5e38\u89c4\u7684 @Order \u6ce8\u89e3\u5177\u6709\u76f8\u540c\u7684\u8bed\u4e49\uff0c\u4f46\u4e3a\u81ea\u52a8\u914d\u7f6e\u7c7b\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e13\u7528\u7684\u987a\u5e8f\u3002</p> <p>\u4e0e\u6807\u51c6\u7684 @Configuration \u7c7b\u4e00\u6837\uff0c\u5e94\u7528\u81ea\u52a8\u914d\u7f6e\u7c7b\u7684\u987a\u5e8f\u53ea\u5f71\u54cd\u5176 bean \u7684\u5b9a\u4e49\u987a\u5e8f\u3002\u8fd9\u4e9bBean\u968f\u540e\u88ab\u521b\u5efa\u7684\u987a\u5e8f\u4e0d\u53d7\u5f71\u54cd\uff0c\u5b83\u7531\u6bcf\u4e2aBean\u7684\u4f9d\u8d56\u5173\u7cfb\u548c\u4efb\u4f55@DependsOn\u5173\u7cfb\u51b3\u5b9a\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#293-condition","title":"29.3 \u6761\u4ef6\u6ce8\u89e3Condition","text":"<p>\u4f60\u51e0\u4e4e\u603b\u662f\u5e0c\u671b\u5728\u4f60\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\u4e2d\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a@Conditional\u6ce8\u89e3\u3002<code>@ConditionalOnMissingBean</code> \u6ce8\u89e3\u662f\u4e00\u4e2a\u5e38\u89c1\u7684\u4f8b\u5b50\uff0c\u7528\u4e8e\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5728\u5bf9\u60a8\u7684\u9ed8\u8ba4\u914d\u7f6e\u4e0d\u6ee1\u610f\u65f6\u8fdb\u884c\u8986\u76d6\u3002</p> <p>Spring Boot\u5305\u542b\u4e86\u8bb8\u591a@Conditional\u6ce8\u89e3\uff0c\u60a8\u53ef\u4ee5\u5728\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\u5e94\u7528\u4e8e@Configuration\u7c7b\u6216\u5355\u4e2a@Bean\u65b9\u6cd5\u6765\u91cd\u7528\u8fd9\u4e9b\u6ce8\u89e3\u3002\u8fd9\u4e9b\u6ce8\u89e3\u5305\u62ec\uff1a</p> <ul> <li>Class Conditions</li> <li>Bean Conditions</li> <li>Property Conditions</li> <li>Resource Conditions</li> <li>Web Application Conditions</li> <li>SpEL Expression Conditions</li> </ul>"},{"location":"java/spring/spring-boot/spring-boot-features/#2931-class","title":"29.3.1 Class \u6761\u4ef6\u6ce8\u89e3","text":"<p>@ConditionalOnClass\u548c@ConditionalOnMissingClass\u6ce8\u89e3\u8ba9@Configuration\u7c7b\u57fa\u4e8e\u7279\u5b9a\u7c7b\u7684\u5b58\u5728\u6216\u7f3a\u5931\u800c\u52a0\u8f7d\u3002\u7531\u4e8e\u6ce8\u89e3\u5143\u6570\u636e\u662f\u901a\u8fc7\u4f7f\u7528 ASM \u6765\u89e3\u6790\u7684\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u4f7f\u7528 value \u5c5e\u6027\u6765\u5f15\u7528\u771f\u6b63\u7684\u7c7b\uff0c\u5373\u4f7f\u8be5\u7c7b\u5b9e\u9645\u4e0a\u53ef\u80fd\u4e0d\u4f1a\u51fa\u73b0\u5728\u6b63\u5728\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f classpath \u4e0a\u3002\u5982\u679c\u4f60\u559c\u6b22\u4f7f\u7528String\u503c\u6765\u6307\u5b9a\u7c7b\u540d\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528name\u5c5e\u6027\u3002</p> <p>\u8fd9\u79cd\u673a\u5236\u5e76\u4e0d\u9002\u7528@Bean\u65b9\u6cd5\uff0c\u901a\u5e38\u8fd4\u56de\u7c7b\u578b\u662f\u6761\u4ef6\u7684\u76ee\u6807\uff1a\u5728\u65b9\u6cd5\u4e0a\u7684\u6761\u4ef6\u5e94\u7528\u4e4b\u524d\uff0cJVM\u5c06\u5df2\u7ecf\u52a0\u8f7d\u4e86\u7c7b\uff0c\u5e76\u53ef\u80fd\u5904\u7406\u65b9\u6cd5\u5f15\u7528\uff0c\u5982\u679c\u7c7b\u4e0d\u5b58\u5728\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u5c06\u5931\u8d25\u3002</p> <p>\u4e3a\u4e86\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u5355\u72ec\u7684@Configuration\u7c7b\u6765\u9694\u79bb\u6761\u4ef6\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a</p> <pre><code>@Configuration(proxyBeanMethods = false)\n// Some conditions\npublic class MyAutoConfiguration {\n\n    // Auto-configured beans\n    @Configuration(proxyBeanMethods = false)\n    @ConditionalOnClass(EmbeddedAcmeService.class)\n    static class EmbeddedConfiguration {\n\n        @Bean\n        @ConditionalOnMissingBean\n        public EmbeddedAcmeService embeddedAcmeService() { ... }\n\n    }\n\n}\n</code></pre> <p>\u5982\u679c\u4f60\u4f7f\u7528@ConditionalOnClass\u6216@ConditionalOnMissingClass\u4f5c\u4e3a\u5143\u6ce8\u89e3\u7684\u4e00\u90e8\u5206\u6765\u7ec4\u6210\u4f60\u81ea\u5df1\u7684\u6ce8\u89e3\uff0c\u4f60\u5fc5\u987b\u4f7f\u7528name\u4f5c\u4e3a\u6307\u4ee3\u7c7b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u662f\u4e0d\u5904\u7406\u7684\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#2932-bean","title":"29.3.2 Bean\u6761\u4ef6\u6ce8\u89e3","text":"<p>@ConditionalOnBean\u548c@ConditionalOnMissingBean\u6ce8\u89e3\u8ba9\u4e00\u4e2abean\u57fa\u4e8e\u7279\u5b9abean\u7684\u5b58\u5728\u6216\u7f3a\u5931\u800c\u88ab\u5305\u542b\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 value \u5c5e\u6027\u6309\u7c7b\u578b\u6307\u5b9a bean\uff0c\u6216\u4f7f\u7528 name \u6309\u540d\u79f0\u6307\u5b9a bean\u3002\u641c\u7d22\u5c5e\u6027\u53ef\u4ee5\u8ba9\u60a8\u9650\u5236\u641c\u7d22bean\u65f6\u5e94\u8003\u8651\u7684ApplicationContext\u5c42\u6b21\u7ed3\u6784\u3002</p> <p>\u5f53\u653e\u5728@Bean\u65b9\u6cd5\u4e0a\u65f6\uff0c\u76ee\u6807\u7c7b\u578b\u9ed8\u8ba4\u4e3a\u8be5\u65b9\u6cd5\u7684\u8fd4\u56de\u7c7b\u578b\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002</p> <pre><code>@Configuration(proxyBeanMethods = false)\npublic class MyAutoConfiguration {\n\n    @Bean\n    @ConditionalOnMissingBean\n    public MyService myService() { ... }\n\n}\n</code></pre> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5982\u679c\u5e94\u7528ApplicationContext\u4e0d\u5305\u542b\u4e00\u4e2aMyService\u7684Bean\uff0c\u5219\u8fd9\u4e2amyService\u8fd9\u4e2aBean\u5c31\u4f1a\u521b\u5efa\u3002</p> <p>\u4f60\u9700\u8981\u6ce8\u610f\u6dfb\u52a0\u7684bean\u5b9a\u4e49\u987a\u5e8f\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u6761\u4ef6\u662f\u57fa\u4e8e\u5230\u76ee\u524d\u4e3a\u6b62\u6240\u5904\u7406\u7684\u5185\u5bb9\u6765\u8bc4\u4f30\u7684\u3002\u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0\uff0c\u6211\u4eec\u5efa\u8bae\u5728\u81ea\u52a8\u914d\u7f6e\u7c7b\u4e0a\u53ea\u4f7f\u7528@ConditionalOnBean\u548c@ConditionalOnMissingBean\u6ce8\u89e3\uff08\u56e0\u4e3a\u8fd9\u4e9b\u6ce8\u89e3\u4fdd\u8bc1\u5728\u4efb\u4f55\u7528\u6237\u5b9a\u4e49\u7684bean\u5b9a\u4e49\u88ab\u6dfb\u52a0\u540e\u52a0\u8f7d\uff09\u3002</p> <p>@ConditionalOnBean\u548c@ConditionalOnMissingBean\u4e0d\u4f1a\u963b\u6b62@Configuration\u7c7b\u7684\u521b\u5efa\u3002\u5728\u7c7b\u4e0a\u4f7f\u7528\u8fd9\u4e9b\u6761\u4ef6\u548c\u7528\u6ce8\u89e3\u6807\u8bb0\u6bcf\u4e2a\u5305\u542b\u7684@Bean\u65b9\u6cd5\u4e4b\u95f4\u7684\u552f\u4e00\u533a\u522b\u662f\uff0c\u5982\u679c\u6761\u4ef6\u4e0d\u5339\u914d\uff0c\u524d\u8005\u4f1a\u963b\u6b62@Configuration\u7c7b\u6ce8\u518c\u4e3abean\u3002</p> <p>\u5728\u58f0\u660e\u4e00\u4e2a@Bean\u65b9\u6cd5\u65f6\uff0c\u5728\u65b9\u6cd5\u7684\u8fd4\u56de\u7c7b\u578b\u4e2d\u63d0\u4f9b\u5c3d\u53ef\u80fd\u591a\u7684\u7c7b\u578b\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u7684Bean\u7684\u5177\u4f53\u7c7b\u5b9e\u73b0\u4e86\u4e00\u4e2a\u63a5\u53e3\uff0c\u90a3\u4e48Bean\u65b9\u6cd5\u7684\u8fd4\u56de\u7c7b\u578b\u5e94\u8be5\u662f\u5177\u4f53\u7c7b\u800c\u4e0d\u662f\u63a5\u53e3\u3002\u5728@Bean\u65b9\u6cd5\u4e2d\u63d0\u4f9b\u5c3d\u53ef\u80fd\u591a\u7684\u7c7b\u578b\u4fe1\u606f\u5728\u4f7f\u7528bean\u6761\u4ef6\u65f6\u5c24\u4e3a\u91cd\u8981\uff0c\u56e0\u4e3a\u5b83\u4eec\u7684\u8bc4\u4f30\u53ea\u80fd\u4f9d\u8d56\u4e8e\u65b9\u6cd5\u7b7e\u540d\u4e2d\u53ef\u7528\u7684\u7c7b\u578b\u4fe1\u606f\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#2933-property","title":"29.3.3 Property \u6761\u4ef6\u6ce8\u89e3","text":"<p>@ConditionalOnProperty\u6ce8\u89e3\u5141\u8bb8\u57fa\u4e8eSpring\u73af\u5883\u5c5e\u6027\u7684\u914d\u7f6e\u88ab\u52a0\u8f7d\u3002\u4f7f\u7528\u524d\u7f00\u548c\u540d\u79f0\u5c5e\u6027\u6765\u6307\u5b9a\u5e94\u68c0\u67e5\u7684\u5c5e\u6027\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4efb\u4f55\u5b58\u5728\u4e14\u4e0d\u7b49\u4e8efalse\u7684\u5c5e\u6027\u90fd\u4f1a\u88ab\u5339\u914d\u3002\u60a8\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528havingValue\u548cmatchIfMissing\u5c5e\u6027\u521b\u5efa\u66f4\u9ad8\u7ea7\u7684\u68c0\u67e5\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#2934-resource","title":"29.3.4 Resource \u6761\u4ef6\u6ce8\u89e3","text":"<p>\u901a\u8fc7@ConditionalOnResource\u6ce8\u89e3\uff0c\u53ef\u4ee5\u53ea\u5728\u5b58\u5728\u7279\u5b9a\u8d44\u6e90\u65f6\u624d\u5305\u542b\u914d\u7f6e\u3002\u53ef\u4ee5\u4f7f\u7528\u901a\u5e38\u7684Spring\u7ea6\u5b9a\u6765\u6307\u5b9a\u8d44\u6e90\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\uff1a<code>file:/home/user/test.dat</code>\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#2935-web","title":"29.3.5 Web\u5e94\u7528\u6761\u4ef6\u6ce8\u89e3","text":"<p><code>@ConditionalOnWebApplication</code>\u548c<code>@ConditionalOnNotWebApplication</code>\u6ce8\u89e3\u5141\u8bb8\u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u662f \"Web\u5e94\u7528\u7a0b\u5e8f \"\u6765\u5305\u542b\u914d\u7f6e\u3002\u57fa\u4e8eservlet\u7684Web\u5e94\u7528\u7a0b\u5e8f\u662f\u4efb\u4f55\u4f7f\u7528Spring WebApplicationContext\u3001\u5b9a\u4e49session\u8303\u56f4\u6216\u5177\u6709<code>ConfigurableWebEnvironment</code>\u3002reactive Web\u5e94\u7528\u662f\u6307\u4efb\u4f55\u4f7f\u7528ReactiveWebApplicationContext\u6216\u62e5\u6709ConfigurableReactiveWebEnvironment\u3002</p> <p>@ConditionalOnWarDeployment \u6ce8\u89e3\u5141\u8bb8\u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u662f\u90e8\u7f72\u5230\u5bb9\u5668\u4e2d\u7684\u4f20\u7edf WAR \u5e94\u7528\u7a0b\u5e8f\u6765\u5305\u542b\u914d\u7f6e\u3002\u5bf9\u4e8e\u4f7f\u7528\u5d4c\u5165\u5f0f\u670d\u52a1\u5668\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u6761\u4ef6\u5c06\u4e0d\u5339\u914d\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#2936-spel","title":"29.3.6 SpEL\u8868\u8fbe\u5f0f","text":"<p>\u57fa\u4e8eSpEL\u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u6765\u52a0\u8f7d\u914d\u7f6e</p>"},{"location":"java/spring/spring-boot/spring-boot-features/#294","title":"29.4 \u6d4b\u8bd5\u4f60\u7684\u81ea\u52a8\u914d\u7f6e","text":"<p>\u4e00\u4e2a\u81ea\u52a8\u914d\u7f6e\u53ef\u80fd\u4f1a\u53d7\u5230\u8bb8\u591a\u56e0\u7d20\u7684\u5f71\u54cd\uff1a\u7528\u6237\u914d\u7f6e\uff08@Bean\u5b9a\u4e49\u548c\u81ea\u5b9a\u4e49\u7684Environment \uff09\uff0c\u6761\u4ef6\u8bc4\u4f30\uff08\u7279\u5b9a\u5e93\u7684\u5b58\u5728\uff09\u7b49\u7b49\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6bcf\u4e2a\u6d4b\u8bd5\u90fd\u5e94\u8be5\u521b\u5efa\u4e00\u4e2a\u5b9a\u4e49\u826f\u597d\u7684ApplicationContext\uff0c\u4ee3\u8868\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u7684\u7ec4\u5408\u3002ApplicationContextRunner\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u65b9\u6cd5\u6765\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u6807\u3002</p> <p><code>ApplicationContextRunner</code>\u901a\u5e38\u88ab\u5b9a\u4e49\u4e3a\u6d4b\u8bd5\u7c7b\u7684\u4e00\u4e2a\u5b57\u6bb5\uff0c\u7528\u6765\u6536\u96c6\u57fa\u7840\u7684\u3001\u5e38\u7528\u7684\u914d\u7f6e\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u786e\u4fdd<code>UserServiceAutoConfiguration</code>\u603b\u662f\u88ab\u8c03\u7528:</p> <pre><code>private final ApplicationContextRunner contextRunner = new ApplicationContextRunner()\n        .withConfiguration(AutoConfigurations.of(UserServiceAutoConfiguration.class));\n</code></pre> <p>\u200b   \u5982\u679c\u5fc5\u987b\u5b9a\u4e49\u591a\u4e2a\u81ea\u52a8\u914d\u7f6e\uff0c\u5219\u65e0\u9700\u5bf9\u5b83\u4eec\u7684\u58f0\u660e\u8fdb\u884c\u6392\u5e8f\uff0c\u56e0\u4e3a\u5b83\u4eec\u7684\u8c03\u7528\u987a\u5e8f\u4e0e\u8fd0\u884c\u5e94\u7528\u7a0b\u5e8f\u65f6\u5b8c\u5168\u76f8\u540c\u3002</p> <p>\u6bcf\u4e2a\u6d4b\u8bd5\u90fd\u53ef\u4ee5\u4f7f\u7528runner \u6765\u4ee3\u8868\u4e00\u4e2a\u7279\u5b9a\u7684\u7528\u4f8b\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u793a\u4f8b\u8c03\u7528\u4e86\u4e00\u4e2a\u7528\u6237\u914d\u7f6e\uff08UserConfiguration\uff09\uff0c\u5e76\u68c0\u67e5\u81ea\u52a8\u914d\u7f6e\u662f\u5426\u6b63\u786e\u56de\u9000\u3002\u8c03\u7528run\u63d0\u4f9b\u4e86\u4e00\u4e2a\u56de\u8c03\u4e0a\u4e0b\u6587\uff0c\u53ef\u4ee5\u548cAssertJ\u4e00\u8d77\u4f7f\u7528\u3002</p> <pre><code>@Test\nvoid defaultServiceBacksOff() {\n    this.contextRunner.withUserConfiguration(UserConfiguration.class).run((context) -&gt; {\n        assertThat(context).hasSingleBean(UserService.class);\n    assertThat(context).getBean(\"myUserService\").isSameAs(context.getBean(UserService.class));\n    });\n}\n\n@Configuration(proxyBeanMethods = false)\nstatic class UserConfiguration {\n\n    @Bean\n    UserService myUserService() {\n        return new UserService(\"mine\");\n    }\n\n}\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#295-springboot","title":"29.5 springboot\u7684\u81ea\u52a8\u914d\u7f6e\u539f\u7406","text":"<ol> <li>\u542f\u52a8\u5165\u53e3main\u65b9\u6cd5\u542f\u52a8\uff0c\u91cc\u9762\u8c03\u7528SpringApplication.\u7684\u9759\u6001run()\uff0c\u6700\u91cd\u8981\u7684\u4e00\u4e2a\u65b9\u6cd5<code>this.refreshContext(context);</code>\uff0c\u5bb9\u5668\u8fd8\u4f1a\u5728\u542f\u52a8\u5404\u4e2a\u9636\u6bb5\u4f1a\u53d1\u5e03\u76f8\u5e94\u7684event\u3002</li> <li>\u5728refreshCcontext()\u65b9\u6cd5\u4e2d\u52a0\u8f7d\u5bf9\u5e94\u7684\u914d\u7f6e\u7c7b\u7b49\uff0c\u6700\u5173\u952e\u7684@SpringBootApplication\u6ce8\u89e3\u5305\u542b\u4e09\u4e2a\u5173\u952e\u7684\u6ce8\u89e3\uff0c\u6700\u91cd\u8981\u7684\u662f@EnableAutoConfiguration</li> </ol> <pre><code>@SpringBootConfiguration\n@EnableAutoConfiguration\n@ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),\n        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })\npublic @interface SpringBootApplication {\n}\n</code></pre> <ol> <li>\u6709\u4e00\u4e2aAutoConfigurationImportSelector\uff0c\u975e\u5e38\u975e\u5e38\u5173\u952e\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u53bb\u52a0\u8f7d\u76f8\u5e94\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b</li> </ol> <pre><code>@AutoConfigurationPackage\n@Import(AutoConfigurationImportSelector.class)\npublic @interface EnableAutoConfiguration {\n}\n</code></pre> <ol> <li>AutoConfigurationImportSelector\u91cc\u5229\u7528\u4e00\u4e2a\u7c7b\u52a0\u8f7d\u5668SpringFactoriesLoader\u53bb\u52a0\u8f7dMETA-INF/spring.factories\u914d\u7f6e\u6587\u4ef6\u4e0b\u6240\u6709\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\uff0c</li> <li>\u81ea\u52a8\u914d\u7f6e\u7c7b\u91cc\u57fa\u672c\u90fd\u6709\u4e00\u4e2aConditionalOnClass\u6ce8\u89e3\uff0c\u4e5f\u5c31\u662f\u53ea\u6709\u5f15\u5165\u76f8\u5e94\u7684\u4f9d\u8d56\uff0c\u624d\u4f1a\u53bb\u52a0\u8f7d\u5f53\u524d\u914d\u7f6e\u7c7b\u3002\u5e76\u4e14\u4f1a\u66ff\u4f60\u751f\u6210\u9ed8\u8ba4\u7684RedisTemplate\uff0c\u5f53\u7136\u7528\u6237\u53ef\u4ee5\u8986\u76d6\u5b83\u3002\u5e76\u4e14\u6ce8\u610fEnableConfigurationProperties\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u6709\u9ed8\u8ba4\u7684\u914d\u7f6e\u9879</li> </ol> <pre><code>@Configuration(proxyBeanMethods  = false) \n@ConditionalOnClass(RedisOperations.class)\n@EnableConfigurationProperties(RedisProperties.class)\n@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })\npublic class RedisAutoConfiguration {\n\n@Bean\n@ConditionalOnMissingBean(name = \"redisTemplate\")\npublic RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)\n        throws UnknownHostException {\n    RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();\n    template.setConnectionFactory(redisConnectionFactory);\n    return template;\n}\n\n@Bean\n@ConditionalOnMissingBean\npublic StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory)\n        throws UnknownHostException {\n    StringRedisTemplate template = new StringRedisTemplate();\n    template.setConnectionFactory(redisConnectionFactory);\n    return template;\n}\n}\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot-features/#starter","title":"\u5b66\u4e60\u5982\u4f55\u7f16\u5199\u81ea\u5df1\u7684starter","text":"<ol> <li>\u9996\u5148\u662f\u7f16\u5199AutoConfiguration\u81ea\u52a8\u914d\u7f6e\u7c7b</li> </ol> <pre><code>@Configuration(proxyBeanMethods = false) // \u6307\u5b9a\u8fd9\u662f\u4e00\u4e2a\u914d\u7f6e\u7c7b\n@ConditionalOnClass(KafkaTemplate.class) // \u5728\u6307\u5b9a\u7c7b\u5b58\u5728\u65f6\u81ea\u52a8\u914d\u7f6e\u7c7b\u751f\u6548\n@EnableConfigurationProperties(KafkaProperties.class) // \u751f\u6548\u76f8\u5173\u7684Properties\uff0c\u65b9\u4fbf\u5f15\u5165\u4f7f\u7528\n@Import({ KafkaAnnotationDrivenConfiguration.class, KafkaStreamsAnnotationDrivenConfiguration.class }) // \u5bfc\u5165\u5176\u4ed6\u914d\u7f6e\u7c7b\npublic class KafkaAutoConfiguration {\n\n  private final KafkaProperties properties;\n\n  public KafkaAutoConfiguration(KafkaProperties properties) {\n    this.properties = properties;\n  }\n\n    @Bean\n    @ConditionalOnMissingBean(KafkaTemplate.class) // \u63d0\u4f9b\u9ed8\u8ba4\u7684\u914d\u7f6e\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u8986\u76d6\n    public KafkaTemplate&lt;?, ?&gt; kafkaTemplate(ProducerFactory&lt;Object, Object&gt; kafkaProducerFactory,\n            ProducerListener&lt;Object, Object&gt; kafkaProducerListener,\n            ObjectProvider&lt;RecordMessageConverter&gt; messageConverter) {\n        KafkaTemplate&lt;Object, Object&gt; kafkaTemplate = new KafkaTemplate&lt;&gt;(kafkaProducerFactory);\n        messageConverter.ifUnique(kafkaTemplate::setMessageConverter);\n        kafkaTemplate.setProducerListener(kafkaProducerListener);\n        kafkaTemplate.setDefaultTopic(this.properties.getTemplate().getDefaultTopic());\n        return kafkaTemplate;\n    }\n\n    @Bean\n    @ConditionalOnProperty(name = \"spring.kafka.producer.transaction-id-prefix\")\n    @ConditionalOnMissingBean\n    public KafkaTransactionManager&lt;?, ?&gt; kafkaTransactionManager(ProducerFactory&lt;?, ?&gt; producerFactory) {\n        return new KafkaTransactionManager&lt;&gt;(producerFactory);\n    }\n\n}\n</code></pre> <ol> <li>\u8981\u80fd\u52a0\u8f7d\u5230\u4e0a\u9762\u6211\u4eec\u7f16\u5199\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\uff0c\u5c06\u4e0a\u9762\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\u7684\u5168\u8def\u5f84\u653e\u5728META-INF/spring.factority\u4e2d\uff0cspringboot\u542f\u52a8\u65f6\u624d\u80fd\u52a0\u8f7d\u5230\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u914d\u7f6e\u7c7b</li> </ol> <pre><code># Auto Configure\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\norg.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\\\norg.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\\\n</code></pre> <ol> <li>starter\u89c4\u8303    starter\u6a21\u5757\u662f\u4e00\u4e2a\u7a7a\u7684jar\u6587\u4ef6\uff0c\u4ec5\u63d0\u4f9b\u8f85\u52a9\u6027\u7684\u4f9d\u8d56\u7ba1\u7406\uff0c\u548c\u4fdd\u62a4\u4f9d\u8d56</li> </ol> <p>\u4e00\u822c\u4e13\u95e8\u5199\u4e00\u4e2a\u81ea\u52a8\u914d\u7f6e\u6a21\u5757\uff0c\u662f\u771f\u6b63\u5b9e\u73b0\u529f\u80fd\u7684\u5730\u65b9\uff0cstarter\u4f9d\u8d56\u8fd9\u4e2a\u3002\u522b\u4eba\u4f7f\u7528\u53ea\u8981\u4f9d\u8d56starter\u5373\u53ef\u3002</p> <ol> <li>\u547d\u4ee4\u89c4\u8303\uff1a    \u5b98\u65b9\u7684starter\u547d\u540d\u90fd\u662fspring-boot-starter-{name}\uff0c\u5982spring-boot-starter-web\uff0cspring-boot-starter-test\u3002    \u81ea\u5b9a\u4e49\u7684starter\u4e00\u822c\u5efa\u8bae{name}-spring-boot-starter\uff0c\u5982mybatis-plus-boot-starter</li> </ol> <p>\u4f7f\u7528\u8005\u53ea\u9700\u8981\u5bfc\u5165starter\u7684\u4f9d\u8d56\uff0c\u7136\u540e\u6dfb\u52a0\u914d\u7f6e\u6587\u4ef6\uff08\u4f1a\u63d0\u4f9b\u9ed8\u8ba4\u503c\uff09\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u6ce8\u5165service\u4f7f\u7528\u4e86</p>"},{"location":"java/spring/spring-boot/spring-boot/","title":"Spring boot","text":"<p>Spring Boot\u4f7f\u60a8\u53ef\u4ee5\u8f7b\u677e\u521b\u5efa\u72ec\u7acb\u7684\u3001\u57fa\u4e8eSpring\u7684\u751f\u4ea7\u7ea7\u5e94\u7528\u7a0b\u5e8f\uff0c\u53ef\u4ee5 \"\u76f4\u63a5\u8fd0\u884c\"\u3002</p> <p>\u6211\u4eec\u4eceSpring\u5e73\u53f0\u548c\u7b2c\u4e09\u65b9\u5e93\u7684\u89d2\u5ea6\u51fa\u53d1\uff0c\u8ba9\u60a8\u4ee5\u6700\u5c0f\u7684\u4ee3\u4ef7\u4e0a\u624b\u3002\u5927\u591a\u6570Spring Boot\u5e94\u7528\u7a0b\u5e8f\u53ea\u9700\u8981\u6700\u5c11\u7684Spring\u914d\u7f6e\u3002</p>"},{"location":"java/spring/spring-boot/spring-boot/#features","title":"Features\uff1a","text":"<ul> <li>\u63d0\u4f9b\u53ef\u9009\u7684starter\u4f9d\u8d56\uff0c\u7b80\u5316\u9879\u76ee\u6784\u5efa</li> <li>\u63d0\u4f9bSpring\u548c\u7b2c\u4e09\u65b9\u5e93\u7684\u9ed8\u8ba4\u81ea\u52a8\u914d\u7f6e\uff0c\u7b80\u5316spring\u5e94\u7528\u7684\u5f00\u53d1</li> <li>\u5185\u7f6etomcat\uff0cjetty\u7b49\u542f\u52a8\u5bb9\u5668\uff0cjar\u5305\u5373\u53ef\u542f\u52a8</li> <li>\u63d0\u4f9b\u751f\u4ea7\u5e38\u7528\u7684\u7279\u6027\uff0c\u50cfmetrics, health checks</li> <li>\u4e0d\u9700\u8981\u4ee3\u7801\u751f\u6210\u548cxml\u914d\u7f6e</li> </ul> <p>\u6587\u6863\u5730\u5740\uff1ahttps://docs.spring.io/spring-boot/docs/current/reference/html/index.html</p> <p></p>"},{"location":"java/spring/spring-boot/spring-boot/#documentation-overview","title":"Documentation Overview","text":""},{"location":"java/spring/spring-boot/spring-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/","title":"Spring boot\u542f\u52a8\u6d41\u7a0b","text":""},{"location":"java/spring/spring-boot/spring-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/#springboot","title":"springboot\u542f\u52a8\u6d41\u7a0b","text":"<ol> <li>main\u65b9\u6cd5\u91cc\u8c03\u7528 <code>SpringApplication.run()</code>\uff0c\u91cc\u9762<code>return new SpringApplication(primarySources).run(args);</code>\u5148\u53bb\u521b\u5efa\u4e86SpringApplication\u5bf9\u8c61\uff0c\u7136\u540e\u8c03\u7528run\u65b9\u6cd5</li> <li>\u521b\u5efaSpringApplication\u5bf9\u8c61\uff1a</li> </ol> <pre><code>public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) {\n        this.resourceLoader = resourceLoader;\n        Assert.notNull(primarySources, \"PrimarySources must not be null\");\n        this.primarySources = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));\n        // \u63a8\u65ad\u5e94\u7528\u7c7b\u578b\uff0c\u662f\u5426\u662f\u5185\u5d4c\u7684servlet\u5bb9\u5668\uff0c\u8fd8\u662f\u4e0d\u5185\u5d4c\u6216\u8005reactive\u5e94\u7528\n        this.webApplicationType = WebApplicationType.deduceFromClasspath();\n        // \u5229\u7528\u7c7b\u52a0\u8f7d\u5668\u4ecespringboot\u548cspring autoconfigure\u9879\u76ee\u7684META-INF/spring.factories\u4e0b\u52a0\u8f7d\u6240\u6709\u7684ApplicationContextInitializer\n        setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));\n        // \u5229\u7528\u7c7b\u52a0\u8f7d\u5668\u4eceMETA-INF/spring.factories\u4e0b\u52a0\u8f7d\u6240\u6709\u7684ApplicationListener\n        setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));\n        // \u627e\u51fa\u542b\u6709main\u65b9\u6cd5\u7684\u4e3b\u914d\u7f6e\u7c7b\n        this.mainApplicationClass = deduceMainApplicationClass();\n    }\n</code></pre> <ol> <li>\u8fd0\u884crun\u65b9\u6cd5</li> </ol> <pre><code>public ConfigurableApplicationContext run(String... args) {\n        StopWatch stopWatch = new StopWatch();\n        stopWatch.start();\n        ConfigurableApplicationContext context = null;\n        Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList&lt;&gt;();\n        configureHeadlessProperty();\n        // \u53bb\u52a0\u8f7d\u6240\u6709\u7684SpringApplicationRunListener\uff0c\u5b9e\u9645\u53ea\u6709\u4e00\u4e2aEventPublishingRunListener\n        SpringApplicationRunListeners listeners = getRunListeners(args);\n        // \u56de\u8c03listeners\u7684starting\n        listeners.starting();\n        try {\n            ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);\n            // \u51c6\u5907\u73af\u5883\uff0cprofiles\uff0cPropertySources\uff0c\u56de\u8c03listeners\n            ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);\n            configureIgnoreBeanInfo(environment);\n\n            Banner printedBanner = printBanner(environment);\n\n            // \u521b\u5efaApplicationContext\u5bb9\u5668\uff0cSERVLET\u6216\u8005REACTIVE\n            context = createApplicationContext();\n            exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,\n                    new Class[] { ConfigurableApplicationContext.class }, context);\n\n            // \u51c6\u5907Context\uff0c\u91cc\u9762\u4fdd\u5b58environment\uff0c\u8c03\u7528ApplicationContextInitializer\uff0c\u56de\u8c03listener\n            prepareContext(context, environment, listeners, applicationArguments, printedBanner);\n\n            // \u91cd\u8981\u7684\u65b9\u6cd5\uff0c\u521d\u59cb\u5316\u5bb9\u5668\uff0c\u53bb\u52a0\u8f7d@configure\uff0c@bean\uff0c\u6ce8\u89e3\u7b49\n            refreshContext(context);\n            afterRefresh(context, applicationArguments);\n            stopWatch.stop();\n            if (this.logStartupInfo) {\n                new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);\n            }\n            // \u56de\u8c03listener\u7684started\n            listeners.started(context);\n            // \u8fd9\u91cc\u662f\u53bb\u56de\u8c03ApplicationRunner\u548cCommandLineRunner\u7684\u65b9\u6cd5\n            callRunners(context, applicationArguments);\n        }\n        catch (Throwable ex) {\n            handleRunFailure(context, ex, exceptionReporters, listeners);\n            throw new IllegalStateException(ex);\n        }\n\n        try {\n            // \u5bb9\u5668\u542f\u52a8\u5b8c\u6210\uff0c\u53d1\u5e03ApplicationReadyEvent\n            listeners.running(context);\n        }\n        catch (Throwable ex) {\n            handleRunFailure(context, ex, exceptionReporters, null);\n            throw new IllegalStateException(ex);\n        }\n        return context;\n    }\n</code></pre>"},{"location":"java/spring/spring-boot/spring-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/#springapplicationrunlistener","title":"\u5bb9\u5668\u542f\u52a8\u8fc7\u7a0b\u76d1\u542cSpringApplicationRunListener","text":"<p>SpringApplicationRunListener\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u4ed6\u7684\u5b9e\u73b0\u7c7b\u662fEventPublishingRunListener\uff0cSpringApplicationRunListeners\u7528\u6765\u5b58\u653e\u6240\u6709\u7684SpringApplicationRunListener\u7684\u96c6\u5408\u3002</p> <p>\u4e3b\u8981\u7528\u6765\u5728\u5bb9\u5668\u542f\u52a8\uff0c\u51c6\u5907\uff0c\u52a0\u8f7d\uff0c\u5f00\u59cb\uff0c\u8fd0\u884c\u7b49\u9636\u6bb5\u53d1\u5e03SpringApplicationEvent\u3002</p> <p></p> <p>\u5e38\u7528\u7684@EventListener(classes = ApplicationReadyEvent.class)\u5c31\u662f\u5728\u76d1\u542c\uff0c\u5bb9\u5668\u542f\u52a8\u5b8c\u6210\u540e\u53d1\u5e03\u7684SpringApplicationEvent\u7684\u5b50\u7c7bApplicationReadyEvent</p> <pre><code>public interface SpringApplicationRunListener {\n\n    /**\n     * Called immediately when the run method has first started. Can be used for very\n     * early initialization.\n     */\n    default void starting() {\n    }\n\n    /**\n     * Called once the environment has been prepared, but before the\n     * {@link ApplicationContext} has been created.\n     */\n    default void environmentPrepared(ConfigurableEnvironment environment) {\n    }\n\n    /**\n     * Called once the {@link ApplicationContext} has been created and prepared, but\n     * before sources have been loaded.\n     */\n    default void contextPrepared(ConfigurableApplicationContext context) {\n    }\n\n    /**\n     * Called once the application context has been loaded but before it has been\n     * refreshed.\n     */\n    default void contextLoaded(ConfigurableApplicationContext context) {\n    }\n\n    /**\n     * The context has been refreshed and the application has started but\n     * CommandLineRunners and ApplicationRunners have not been called.\n     */\n    default void started(ConfigurableApplicationContext context) {\n    }\n\n    /**\n     * Called immediately before the run method finishes, when the application context has\n     * been refreshed and all CommandLineRunners and\n     *  ApplicationRunners have been called.\n     */\n    default void running(ConfigurableApplicationContext context) {\n    }\n\n    /**\n     * Called when a failure occurs when running the application.\n     * @param context the application context or {@code null} if a failure occurred before\n     * the context was created\n     */\n    default void failed(ConfigurableApplicationContext context, Throwable exception) {\n    }\n\n}\n</code></pre> <p>\u5728\u542f\u52a8\u7684main\u65b9\u6cd5\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u5728\u5bb9\u5668\u5f00\u59cb\uff0c\u51c6\u5907\uff0c\u52a0\u8f7d\uff0c\u8fd0\u884c\u7684\u5404\u4e2a\u9636\u6bb5\uff0c\u90fd\u6709\u901a\u8fc7listener\u53bb\u53d1\u5e03\u76f8\u5e94\u72b6\u6001\u7684SpringApplicationEvent</p> <p></p>"},{"location":"java/spring/spring-mvc/spring-mvc/","title":"Spring mvc","text":"<p>https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc</p> <p>w3cSchool spring-mvc\u4e2d\u6587\u6587\u6863</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#webmvcconfigurer","title":"WebMvcConfigurer","text":"<p>@EnableWebMvc\u4f1aimport\u5bfc\u5165DelegatingWebMvcConfiguration\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7ee7\u627f\u4e86WebMvcConfigurationSupport\uff0c\u5e76\u4e14\u6301\u6709WebMvcConfigurerComposite\u5c5e\u6027\uff0c</p> <pre><code>class WebMvcConfigurerComposite implements WebMvcConfigurer {\n\n    // \u6301\u6709\u6240\u6709\u7684WebMvcConfigurer\u5b9e\u73b0\uff0c\u5305\u62ec\u81ea\u5b9a\u4e49\u7684\n    private final List&lt;WebMvcConfigurer&gt; delegates = new ArrayList&lt;&gt;();\n\n\n    public void addWebMvcConfigurers(List&lt;WebMvcConfigurer&gt; configurers) {\n        if (!CollectionUtils.isEmpty(configurers)) {\n            this.delegates.addAll(configurers);\n        }\n    }\n}\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u5b9e\u73b0\u81ea\u5df1\u7684WebMvcConfigurer\uff0c\u53bb\u5b9a\u4e49\u81ea\u5df1\u7684\u914d\u7f6e\u5373\u53ef\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u4e0bWebMvcConfigurer\u63d0\u4f9b\u4e86\u54ea\u4e9b\u914d\u7f6e\u63a5\u53e3\u51fa\u6765\uff1a</p> <pre><code>public interface WebMvcConfigurer {\n\n    /**\n    * \u7528\u6765\u914d\u7f6eHandlerMappings\u65f6\u7684\u659c\u6760\u652f\u6301\uff0c\u540e\u7f00\uff0c\u8def\u5f84\u5339\u914d\u7b49\u7b49\n    **/\n    default void configurePathMatch(PathMatchConfigurer configurer) {\n    }\n    /**\n     * \u914d\u7f6eConvert\u548cFormatter\n     */\n    default void addFormatters(FormatterRegistry registry) {\n    }\n\n    /**\n     * \n     */\n    default void addInterceptors(InterceptorRegistry registry) {\n    }\n\n    /**\n    * \u914d\u7f6eHttpMessageConverter\u7528\u6765\u89e3\u6790request\u548cresponsede body\u7684\u8bfb\u548c\u5199\u3002\n    * \u65b0\u7684List\u4f1a\u8986\u76d6\u9ed8\u8ba4\u7684\uff0c\u5982\u679c\u4e0d\u60f3\u8986\u76d6\u4f7f\u7528\u4e0b\u9762\u7684extendMessageConverters   \n    **/\n    default void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {\n    }\n    default void extendMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {\n    }\n}    \n</code></pre>"},{"location":"java/spring/spring-mvc/spring-mvc/#requestmappinghandleradapter","title":"RequestMappingHandlerAdapter","text":"<p>\u8fd9\u4e2a\u7c7b\u4e3b\u8981\u5b9e\u73b0\u4e86HandlerAdapter\uff0cInitializingBean\u548cOrder\u63a5\u53e3\u3002\u7528\u6765\u670d\u52a1\u652f\u6491@RequestMapping\u4fee\u9970\u7684\u65b9\u6cd5\uff0c</p> <p>\u652f\u6301\u81ea\u5b9a\u4e49\u53c2\u6570\u89e3\u6790\u5668\uff08setCustomArgumentResolvers\uff09\u548c\u8fd4\u56de\u503c\u5904\u7406\u5668\uff08setCustomReturnValueHandlers\uff09\uff0c\u4e5f\u53ef\u4ee5\u91cd\u65b0\u914d\u7f6e\uff0c\u88c5\u9970\u5df2\u6709\u7684\u53c2\u6570\u89e3\u6790\u5668\u548c\u8fd4\u56de\u503c\u5904\u7406\u5668\u3002</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#1-handlermethodargumentresolverhandlermethodreturnvaluehandler","title":"1. \u521d\u59cb\u5316\u6240\u6709\u7684HandlerMethodArgumentResolver\u548cHandlerMethodReturnValueHandler\u3002","text":"<pre><code>@Override\npublic void afterPropertiesSet() {\n    // Do this first, it may add ResponseBody advice beans\n    initControllerAdviceCache();\n\n    if (this.argumentResolvers == null) {\n        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();\n        this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);\n    }\n    if (this.initBinderArgumentResolvers == null) {\n        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();\n        this.initBinderArgumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);\n    }\n    if (this.returnValueHandlers == null) {\n        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();\n        this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);\n    }\n}\n/**\n* Return the list of return value handlers to use including built-in and\n* custom handlers provided via {@link #setReturnValueHandlers}.\n*/\nprivate List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() {\n    List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;&gt;(20);\n\n    // Single-purpose return value types\n    handlers.add(new ModelAndViewMethodReturnValueHandler());\n    handlers.add(new ModelMethodProcessor());\n    handlers.add(new ViewMethodReturnValueHandler());\n    handlers.add(new ResponseBodyEmitterReturnValueHandler(getMessageConverters(),\n                                                           this.reactiveAdapterRegistry, this.taskExecutor, this.contentNegotiationManager));\n    handlers.add(new StreamingResponseBodyReturnValueHandler());\n    handlers.add(new HttpEntityMethodProcessor(getMessageConverters(),\n                                               this.contentNegotiationManager, this.requestResponseBodyAdvice));\n    handlers.add(new HttpHeadersReturnValueHandler());\n    handlers.add(new CallableMethodReturnValueHandler());\n    handlers.add(new DeferredResultMethodReturnValueHandler());\n    handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory));\n\n    // Annotation-based return value types\n    handlers.add(new ModelAttributeMethodProcessor(false));\n    handlers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(),\n                                                        this.contentNegotiationManager, this.requestResponseBodyAdvice));\n\n    // Multi-purpose return value types\n    handlers.add(new ViewNameMethodReturnValueHandler());\n    handlers.add(new MapMethodProcessor());\n\n    // Custom return value types\n    if (getCustomReturnValueHandlers() != null) {\n        handlers.addAll(getCustomReturnValueHandlers());\n    }\n\n    // Catch-all\n    if (!CollectionUtils.isEmpty(getModelAndViewResolvers())) {\n        handlers.add(new ModelAndViewResolverMethodReturnValueHandler(getModelAndViewResolvers()));\n    }\n    else {\n        handlers.add(new ModelAttributeMethodProcessor(true));\n    }\n\n    return handlers;\n}\n/**\n* Return the list of argument resolvers to use including built-in resolvers\n* and custom resolvers provided via {@link #setCustomArgumentResolvers}.\n*/\nprivate List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() {\n    List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;&gt;(30);\n\n    // Annotation-based argument resolution\n    resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false));\n    resolvers.add(new RequestParamMapMethodArgumentResolver());\n    resolvers.add(new PathVariableMethodArgumentResolver());\n    resolvers.add(new PathVariableMapMethodArgumentResolver());\n    resolvers.add(new MatrixVariableMethodArgumentResolver());\n    resolvers.add(new MatrixVariableMapMethodArgumentResolver());\n    resolvers.add(new ServletModelAttributeMethodProcessor(false));\n    resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice));\n    resolvers.add(new RequestPartMethodArgumentResolver(getMessageConverters(), this.requestResponseBodyAdvice));\n    resolvers.add(new RequestHeaderMethodArgumentResolver(getBeanFactory()));\n    resolvers.add(new RequestHeaderMapMethodArgumentResolver());\n    resolvers.add(new ServletCookieValueMethodArgumentResolver(getBeanFactory()));\n    resolvers.add(new ExpressionValueMethodArgumentResolver(getBeanFactory()));\n    resolvers.add(new SessionAttributeMethodArgumentResolver());\n    resolvers.add(new RequestAttributeMethodArgumentResolver());\n\n    // Type-based argument resolution\n    resolvers.add(new ServletRequestMethodArgumentResolver());\n    resolvers.add(new ServletResponseMethodArgumentResolver());\n    resolvers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.requestResponseBodyAdvice));\n    resolvers.add(new RedirectAttributesMethodArgumentResolver());\n    resolvers.add(new ModelMethodProcessor());\n    resolvers.add(new MapMethodProcessor());\n    resolvers.add(new ErrorsMethodArgumentResolver());\n    resolvers.add(new SessionStatusMethodArgumentResolver());\n    resolvers.add(new UriComponentsBuilderMethodArgumentResolver());\n\n    // Custom arguments\n    if (getCustomArgumentResolvers() != null) {\n        resolvers.addAll(getCustomArgumentResolvers());\n    }\n\n    // Catch-all\n    resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), true));\n    resolvers.add(new ServletModelAttributeMethodProcessor(true));\n\n    return resolvers;\n}\n</code></pre>"},{"location":"java/spring/spring-mvc/spring-mvc/#2","title":"2. \u914d\u7f6e\u81ea\u5b9a\u4e49\u7684\u53c2\u6570\u89e3\u6790\u5668\u548c\u8fd4\u56de\u503c\u5904\u7406\u5668","text":"<pre><code>/**\n* Provide resolvers for custom argument types. Custom resolvers are ordered\n* after built-in ones. To override the built-in support for argument\n* resolution use {@link #setArgumentResolvers} instead.\n* \u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684customArgumentResolvers\uff0c\u5b83\u7684\u6267\u884c\u5728\u5185\u7f6e\u7684\u540e\u9762\n*\n**/\npublic void setCustomArgumentResolvers(@Nullable List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers) {\n    this.customArgumentResolvers = argumentResolvers;\n}\n\n/**\n* \u62ff\u5230\u5185\u7f6e\u7684\u53c2\u6570\u89e3\u6790\u5668\u5217\u8868\uff0c\u4ece\u800c\u8fdb\u884c\u88c5\u9970\u52a0\u5f3a\uff0c\u6216\u8986\u76d6\n*/\npublic void setArgumentResolvers(@Nullable List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers) {\n    if (argumentResolvers == null) {\n        this.argumentResolvers = null;\n    }\n    else {\n        this.argumentResolvers = new HandlerMethodArgumentResolverComposite();\n        this.argumentResolvers.addResolvers(argumentResolvers);\n    }\n}\n\n\n/**\n* \u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u8fd4\u56de\u503c\u5904\u7406\u5668\u5217\u8868\n*/\npublic void setCustomReturnValueHandlers(@Nullable List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers) {\n    this.customReturnValueHandlers = returnValueHandlers;\n}\n\n/**\n* \u62ff\u5230\u5185\u7f6e\u7684\u8fd4\u56de\u503c\u5904\u7406\u5668\u5217\u8868\uff0c\u4ece\u800c\u8fdb\u884c\u88c5\u9970\u52a0\u5f3a\uff0c\u6216\u8986\u76d6\n*/\npublic void setReturnValueHandlers(@Nullable List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers) {\n    if (returnValueHandlers == null) {\n        this.returnValueHandlers = null;\n    }\n    else {\n        this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite();\n        this.returnValueHandlers.addHandlers(returnValueHandlers);\n    }\n}\n</code></pre>"},{"location":"java/spring/spring-mvc/spring-mvc/#3-setrequestbodyadvicesetresponsebodyadvice","title":"3. \u8bbe\u7f6esetRequestBodyAdvice\u548csetResponseBodyAdvice","text":"<p>\u7528\u6765\u5728responseBody\u8f6c\u6362\u4e4b\u524d\u7684\u62e6\u622a\u901a\u77e5\u3002\u6bd4\u5982\u6dfb\u52a0\u7edf\u4e00\u7684\u8fd4\u56de\u5bf9\u8c61</p> <pre><code>/**\n* Add one or more {@code RequestBodyAdvice} instances to intercept the\n* request before it is read and converted for {@code @RequestBody} and\n* {@code HttpEntity} method arguments.\n*/\npublic void setRequestBodyAdvice(@Nullable List&lt;RequestBodyAdvice&gt; requestBodyAdvice) {\n    if (requestBodyAdvice != null) {\n        this.requestResponseBodyAdvice.addAll(requestBodyAdvice);\n    }\n}\n\n/**\n* Add one or more {@code ResponseBodyAdvice} instances to intercept the\n* response before {@code @ResponseBody} or {@code ResponseEntity} return\n* values are written to the response body.\n*/\npublic void setResponseBodyAdvice(@Nullable List&lt;ResponseBodyAdvice&lt;?&gt;&gt; responseBodyAdvice) {\n    if (responseBodyAdvice != null) {\n        this.requestResponseBodyAdvice.addAll(responseBodyAdvice);\n    }\n}\n</code></pre>"},{"location":"java/spring/spring-mvc/spring-mvc/#1-filter","title":"1. filter","text":"<p>spring-web\u63d0\u4f9b\u4e86\u51e0\u4e2a\u6709\u7528\u7684filter\uff1a</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#formcontentfilter","title":"FormContentFilter","text":"<p>\u6d4f\u89c8\u5668\u53ea\u80fd\u63d0\u4ea4GET\uff0cPOST\u65b9\u5f0f\u7684\u8bf7\u6c42\uff0c\u975e\u6d4f\u89c8\u5668\u7aef\u53ef\u4ee5\u4f7f\u7528\u5982PUT\uff0cPATCH\uff0cDELETE\u7b49\u65b9\u5f0f\u7684\u8bf7\u6c42\u3002\u4f46\u662f Servlet API \u7684ServletRequest.getParameter*()\u65b9\u6cd5\u53ea\u80fd\u652f\u6301POST HTTP\u3002</p> <p>spring web\u63d0\u4f9b\u4e86FormContentFilter\uff0c\u62e6\u622acontent type\u4e3aapplication/x-www-form-urlencodedPUT,PATCH\uff0cDELETE\u8bf7\u6c42\uff0c\u4ecerequest body\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5c01\u88c5\u8d77\u6765\uff0c\u4f7f\u5f97 Servlet API \u7684ServletRequest.getParameter*()\u65b9\u6cd5\u53ef\u4ee5\u4f7f\u7528\u3002</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#forwarded-headers","title":"Forwarded Headers","text":"<p>\u4e00\u4e2a\u8bf7\u6c42\u7ecf\u8fc7\u4ee3\u7406\u5982\u8d1f\u8f7d\u5747\u8861\u540e\uff0c\u4ed6\u7684host\uff0cpost\u7b49\u53ef\u80fd\u53d1\u751f\u6539\u53d8\uff0c\u8fd9\u65f6\u60f3\u8981\u83b7\u53d6\u6b63\u786e\u7684\u539f\u59cb\u5730\u5740\u5c31\u5341\u5206\u56f0\u96be\u3002</p> <p>\u6240\u4ee5\u5b9a\u4e49\u4e86forward header\u6765\u5b58\u653e\u539f\u59cb\u7684\u8bf7\u6c42\u4fe1\u606f\uff0c\u5982<code>X-Forwarded-Host</code>, <code>X-Forwarded-Port</code>, <code>X-Forwarded-Proto</code>, <code>X-Forwarded-Ssl</code>, and <code>X-Forwarded-Prefix\u3002</code></p> <p>ForwardedHeaderFilter\u53ef\u4ee5\u57fa\u4e8eforward header\u4fee\u6539\u8bf7\u6c42\u7684host\uff0cport\uff0cschema,\u5e76\u4e14\u53bb\u9664\u8fd9\u4e9bheader\u3002\u8fd9\u4e2afilter\u4f1a\u5305\u88c5request\uff0c\u6240\u4ee5\u4ed6\u5fc5\u987b\u5728\u5176\u4ed6filter\u4e4b\u524d\uff0c\u5982RequestContextFilter\u3002</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#shallowetagheaderfilter","title":"ShallowEtagHeaderFilter","text":"<p>\u901a\u8fc7Etag\uff0c\u5982\u679c\u8bf7\u6c42\u7684\u5185\u5bb9\u6ca1\u6709\u53d1\u751f\u6539\u53d8\uff0c\u8fd4\u56de304\u3002</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#corsfilter","title":"CorsFilter","text":"<p>spring mvc\u63d0\u4f9b\u4e86\u7ec6\u7c92\u5ea6 \u7684CORS\u652f\u6301\uff0c\u53ef\u4ee5\u5728controller\u65b9\u6cd5\u4e0a\u6dfb\u52a0\u6ce8\u89e3\u7684\u65b9\u5f0f\u3002</p> <p>\u6ce8\u610f\u5982\u679c\u4f7f\u7528Spring Security\u6846\u67b6\uff0c\u6ce8\u610fCorsFilter\u4fdd\u6301\u5728spring security\u7684filter\u524d\u9762</p> <p>\u53e6\u5916\uff0cspring mvc\u4e2d\u7684\u8fc7\u6ee4\u5668\u57fa\u672c\u90fd\u7ee7\u627f\u81eaOncePerRequestFilter\uff0c\u8fd9\u4e2a\u63a5\u53e3\u597d\u597d\u770b\u770b\u3002\u81ea\u5df1\u5199\u7684filter\u4e5f\u53ef\u4ee5\u7ee7\u627f\u8fd9\u4e2a\u7c7b</p>"},{"location":"java/spring/spring-mvc/spring-mvc/#2-httpmessageconverter","title":"2. HttpMessageConverter","text":"<p>\u8fd9\u7bc7\u6587\u7ae0\u4ecb\u7ecdspringmvc\u4e2d\u7684HttpMessageConverter\uff0c\u5b83\u8d1f\u8d23\u5c06http\u8bf7\u6c42\u4e2d\u8fdb\u884cjava object\u548cjson,xml\u4e4b\u95f4\u7684\u8f6c\u6362\u3002</p> <p>client\u548cserver\u4e4b\u95f4\u7684\u901a\u4fe1\uff1a</p> <p>\u6bcf\u4e2aHttpMessageConverter\u5b9e\u73b0\u7c7b\u90fd\u6709\u652f\u6301\u7684MIME Types\u3002\u5f53\u63a5\u6536\u5230\u4e00\u4e2ahttp\u8bf7\u6c42\u65f6\uff0cspring\u4f1a\u6839\u636erequest header\u91cc\u7684accept\u51b3\u5b9a\u8fd4\u56de\u4ec0\u4e48\u683c\u5f0f\u7684\u5185\u5bb9\u3002\u7136\u540e\u5bfb\u627eMIME Type\u5bf9\u5e94\u7684HttpMessageConverter\uff0c\u5229\u7528\u5b83\u5c06entity\u8fdb\u884c\u8f6c\u6362\u8fd4\u56de\u3002</p> <p>\u5982\u679c\u8bf7\u6c42\u7684body\u91cc\u662fjson\u6570\u636e\uff0cspring\u4f1a\u6839\u636eContent-Type\u7684application/json\uff0c\u6765\u5bfb\u627e\u4e00\u4e2aHttpMessageConverter\u6765\u89e3\u6790request body\u7684json\u53cd\u5e8f\u5217\u5316\u4e3ajava object\u3002</p> <p>\u9ed8\u8ba4\u542f\u7528\u7684HttpMessageConverter\u670910\u4e2a\uff1a</p> <p></p>"},{"location":"java/spring/spring-mvc/spring-mvc/#json","title":"\u4f20\u8f93json","text":"<p>@ResponseBody \u4f1a\u5c06controller\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u5e8f\u5217\u5316\u4e3ajson\u5199\u5165\u5230response\u3002</p> <p>MappingJackson2HttpMessageConverter\u662f\u6211\u4eec\u6700\u5e38\u7528\u7684\uff0c\u4e3b\u8981\u7528\u6765json\u7684\u8f6c\u6362\uff0c\u53ef\u4ee5\u662f\u6307\u5b9a\u7684\u7c7b\u578b\uff0c\u4e5f\u53ef\u4ee5\u662f\u65e0\u7c7b\u578b\u7684\u5982map\u3002\u9ed8\u8ba4\u652f\u6301\u7684MediaType\u662fapplication/json application/*+json with UTF-8\uff0c\u53ef\u4ee5\u8fdb\u884c\u4fee\u6539\u914d\u7f6e\u3002</p> <p>\u5176\u4ed6\u7684MediaType\u7531\u5176\u4ed6\u9ed8\u8ba4\u7684HttpMessageConverter\u8d1f\u8d23\u8f6c\u6362\uff1a</p> <p>*</p> <p>\u4f7f\u7528\u7684json\u8f6c\u6362\u662f\u5229\u7528<code>com.fasterxml.jackson.databind.ObjectMapper</code>\uff0c\u901a\u5e38\u6211\u4eec\u80fd\u505a\u7684\u4e5f\u5c31\u662f\u5b9a\u4e49\u81ea\u5df1\u7684ObjectMapper\uff0c\u6765\u914d\u7f6e\u6211\u4eec\u81ea\u5df1\u7684\u7279\u6b8a\u7684json\u8f6c\u6362\u3002\u6bd4\u5982\u5b9a\u4e49\u81ea\u5df1\u7684JavaTimeModule\u3002spring5.0\u5df2\u7ecf\u652f\u6301LocalDateTime\uff0c\u6240\u6709RequestBody\u91cc\u7684LocalDateTime\u53ef\u4ee5\u6b63\u5e38\u53cd\u5e8f\u5217\u5316\u3002</p> <p>\u6240\u4ee5\uff0cHttpMessageConverter\u4f5c\u7528\u7684\u8303\u56f4\u4e5f\u5c31\u662f@RequestBody\u548c@ResponseBody\u8fd9\u4e24\u4e2a\u9700\u8981json\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u7684\u5730\u65b9??</p>"},{"location":"micro-services/apollo/","title":"Apollo","text":"<p>Apollo\u662f\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684\u5206\u5e03\u5f0f\u914d\u7f6e\u4e2d\u5fc3\u89e3\u51b3\u65b9\u6848\uff0c\u97f5\u8fbe\uff0c\u638c\u95e8\uff0c\u643a\u7a0b\u90fd\u5728\u4f7f\u7528\u3002\u5176\u4ed6\u7684\u89e3\u51b3\u65b9\u6848\u8fd8\u6709Springcloud config , nacos\u7b49\u3002</p> <p>Apollo\u76f8\u6bd4\u4e8e\u5176\u4ed6\u89e3\u51b3\u65b9\u6848\uff0c\u7279\u6709\u7684\u4f18\u70b9\u662f\u652f\u6301\u7070\u5ea6\u53d1\u5e03\uff0c\u6743\u9650\u63a7\u5236\u5b8c\u5584(\u4fee\u6539\u548c\u53d1\u5e03\u6743\u9650\u5206\u79bb)\uff0c\u9002\u5408\u516c\u53f8\u9879\u76ee\u548c\u4eba\u6570\u8f83\u591a\u7684\u60c5\u51b5\u3002</p>"},{"location":"micro-services/apollo/#1","title":"1. \u90e8\u7f72\u4f7f\u7528","text":"<p>\u5b89\u88c5\u542f\u52a8</p> <p>Apollo\u5206\u4e3a\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u3002</p> <p>\u670d\u52a1\u7aef\u53ea\u9700\u8981\u4f9d\u8d56mysql\uff0c\u5bfc\u5165portalDB\u548cConfigDB\u4e24\u4e2a\u6570\u636e\u5e93\u811a\u672c\u3002\u7136\u540e\u5206\u522b\u542f\u52a8configService\uff0cadminService, Portal\u4e09\u4e2a\u670d\u52a1\u3002\u5b89\u88c5\u6307\u5357</p> <p>configView.memberOnly.env\u8bbe\u7f6e\u4e3apro\uff0c\u53ef\u4ee5\u914d\u7f6e\u53ea\u6709\u9879\u76ee\u7ba1\u7406\u5458\u548c\u5177\u6709\u53d1\u5e03\u4fee\u6539\u7684\u4eba\u624d\u80fd\u67e5\u770b\u79c1\u6709\u7684namespace\u3002\u5bf9\u654f\u611f\u914d\u7f6e\u53ef\u4ee5\u8003\u8651\u5f00\u542f\u8bbf\u95ee\u79d8\u94a5\uff0c\u4ece\u800c\u53ea\u6709\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5ba2\u6237\u7aef\u624d\u80fd\u8bbf\u95ee\u654f\u611f\u914d\u7f6e</p> <p>dev,test,uat,prod\u56db\u5957\u73af\u5883\u56e0\u4e3a\u7269\u7406\u73af\u5883\u5206\u9694\uff0c\u6240\u4ee5\u90e8\u7f72\u4e86\u56db\u5957\u3002\u90fd\u8fd8\u662f\u6ce8\u518c\u5230eureka\u4e0a\uff0c\u6bcf\u4e2a\u670d\u52a1\u914d\u7f6e\u6587\u4ef6apollo-env.properties<code>\u91cc\u914d\u7f6e\u4e5f\u90fd\u662ffat.meta=http://fat-apollo-config.com uat.meta=http://uat.apollo-config.com</code>\u7b49\uff0c\u8fd9\u4e2a\u5730\u5740\u4e5f\u5c31\u662fconfig Service\u670d\u52a1\u57df\u540d\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u5230eureka\u7684\u3002</p>"},{"location":"micro-services/apollo/#2","title":"2. \u603b\u4f53\u8bbe\u8ba1","text":"<p>\u914d\u7f6e\u662f\u72ec\u7acb\u5e94\u7528\u7a0b\u5e8f\u7684\u53ea\u8bfb\u53d8\u91cf\uff0c\u4f34\u968f\u5e94\u7528\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\uff0c\u5e94\u8be5\u6709\u591a\u4e2a\u52a0\u8f7d\u65b9\u5f0f\uff0c\u5e76\u9700\u8981\u8fdb\u884c\u6743\u9650\u548c\u4e0d\u540c\u73af\u5883\u96c6\u7fa4\u7684\u7ba1\u7406</p> <p>application \uff1a\u5e94\u7528</p> <p>environment\uff1a \u4e0d\u540c\u7684\u73af\u5883env\uff1a\u5982prod\uff0cuat\uff0cstaging\uff0cdev</p> <p>cluster\uff1a\u4e00\u822c\u7528\u5728\u4e0d\u540c\u6570\u636e\u4e2d\u5fc3\uff0c\u4e00\u4e2aenvironment\u53ef\u4ee5\u5305\u542b\u591a\u4e2acluster</p> <p>namespace\uff1a\u662f\u914d\u7f6e\u9879\u7684\u96c6\u5408\uff0c\u4e5f\u5c31\u662f\u5bf9\u5e94\u4e00\u4e2a\u4e2a\u7684\u914d\u7f6e\u6587\u4ef6\u3002 \u5206\u4e3a\u79c1\u6709\u914d\u7f6e\u548c\u516c\u6709\u914d\u7f6e\uff0c\u5982db-conn\uff0cRedis-conn\u3002\u9ed8\u8ba4\u7684\u540d\u5b57\u662fapplication\u3002</p> <p></p> <p>apollo\u7684\u603b\u4f53\u8bbe\u8ba1\u5982\u4e0b\u56fe\uff1a</p> <p></p> <ul> <li>Config Service\u63d0\u4f9b\u914d\u7f6e\u7684\u8bfb\u53d6\u3001\u63a8\u9001\u7b49\u529f\u80fd\uff0c\u670d\u52a1\u5bf9\u8c61\u662fApollo\u5ba2\u6237\u7aef</li> <li>Admin Service\u63d0\u4f9b\u914d\u7f6e\u7684\u4fee\u6539\u3001\u53d1\u5e03\u7b49\u529f\u80fd\uff0c\u670d\u52a1\u5bf9\u8c61\u662fApollo Portal\uff08\u7ba1\u7406\u754c\u9762\uff09</li> <li>Config Service\u548cAdmin Service\u90fd\u662f\u591a\u5b9e\u4f8b\u3001\u65e0\u72b6\u6001\u90e8\u7f72\uff0c\u6240\u4ee5\u9700\u8981\u5c06\u81ea\u5df1\u6ce8\u518c\u5230Eureka\u4e2d\u5e76\u4fdd\u6301\u5fc3\u8df3</li> <li>\u5728Eureka\u4e4b\u4e0a\u6211\u4eec\u67b6\u4e86\u4e00\u5c42Meta Server\u7528\u4e8e\u5c01\u88c5Eureka\u7684\u670d\u52a1\u53d1\u73b0\u63a5\u53e3\uff0cClient\u901a\u8fc7\u57df\u540d\u8bbf\u95eeMeta Server\u83b7\u53d6Config Service\u670d\u52a1\u5217\u8868\uff08IP+Port\uff09\uff0c\u800c\u540e\u76f4\u63a5\u901a\u8fc7IP+Port\u8bbf\u95ee\u670d\u52a1\uff0c\u540c\u65f6\u5728Client\u4fa7\u4f1a\u505aload balance\u3001\u9519\u8bef\u91cd\u8bd5\u3002Portal\u901a\u8fc7\u57df\u540d\u8bbf\u95eeMeta Server\u83b7\u53d6Admin Service\u670d\u52a1\u5217\u8868\uff08IP+Port\uff09\uff0c\u800c\u540e\u76f4\u63a5\u901a\u8fc7IP+Port\u8bbf\u95ee\u670d\u52a1\uff0c\u540c\u65f6\u5728Portal\u4fa7\u4f1a\u505aload balance\u3001\u9519\u8bef\u91cd\u8bd5\u3002\u4e3a\u4e86\u7b80\u5316\u90e8\u7f72\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u4f1a\u628aConfig Service\u3001Eureka\u548cMeta Server\u4e09\u4e2a\u903b\u8f91\u89d2\u8272\u90e8\u7f72\u5728\u540c\u4e00\u4e2aJVM\u8fdb\u7a0b\u4e2d</li> </ul>"},{"location":"micro-services/apollo/#config-service","title":"Config Service","text":"<ul> <li>\u63d0\u4f9b\u914d\u7f6e\u83b7\u53d6\u63a5\u53e3</li> <li> <p>\u63d0\u4f9b\u914d\u7f6e\u66f4\u65b0\u63a8\u9001\u63a5\u53e3\uff08\u57fa\u4e8eHttp long polling \u957f\u8fde\u63a5\u8f6e\u8be2\uff09</p> </li> <li> <ul> <li>\u670d\u52a1\u7aef\u4f7f\u7528Spring DeferredResult\u5b9e\u73b0\u5f02\u6b65\u5316\uff0c\u4ece\u800c\u5927\u5927\u589e\u52a0\u957f\u8fde\u63a5\u6570\u91cf</li> </ul> </li> <li> <p>\u76ee\u524d\u4f7f\u7528\u7684tomcat embed\u9ed8\u8ba4\u914d\u7f6e\u662f\u6700\u591a10000\u4e2a\u8fde\u63a5\uff08\u53ef\u4ee5\u8c03\u6574\uff09\uff0c\u4f7f\u7528\u4e864C8G\u7684\u865a\u62df\u673a\u5b9e\u6d4b\u53ef\u4ee5\u652f\u649110000\u4e2a\u8fde\u63a5\uff0c\u6240\u4ee5\u6ee1\u8db3\u9700\u6c42\uff08\u4e00\u4e2a\u5e94\u7528\u5b9e\u4f8b\u53ea\u4f1a\u53d1\u8d77\u4e00\u4e2a\u957f\u8fde\u63a5\uff09\u3002</p> </li> <li> <p>\u63a5\u53e3\u670d\u52a1\u5bf9\u8c61\u4e3aApollo\u5ba2\u6237\u7aef</p> </li> </ul>"},{"location":"micro-services/apollo/#admin-service","title":"Admin Service","text":"<ul> <li>\u63d0\u4f9b\u914d\u7f6e\u7ba1\u7406\u63a5\u53e3</li> <li>\u63d0\u4f9b\u914d\u7f6e\u4fee\u6539\u3001\u53d1\u5e03\u7b49\u63a5\u53e3</li> <li>\u63a5\u53e3\u670d\u52a1\u5bf9\u8c61\u4e3aPortal</li> </ul>"},{"location":"micro-services/apollo/#meta-server","title":"Meta Server","text":"<ul> <li>Portal\u901a\u8fc7\u57df\u540d\u8bbf\u95eeMeta Server\u83b7\u53d6Admin Service\u670d\u52a1\u5217\u8868\uff08IP+Port\uff09</li> <li>Client\u901a\u8fc7\u57df\u540d\u8bbf\u95eeMeta Server\u83b7\u53d6Config Service\u670d\u52a1\u5217\u8868\uff08IP+Port\uff09</li> <li>Meta Server\u4eceEureka\u83b7\u53d6Config Service\u548cAdmin Service\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u76f8\u5f53\u4e8e\u662f\u4e00\u4e2aEureka Client</li> <li>\u589e\u8bbe\u4e00\u4e2aMeta Server\u7684\u89d2\u8272\u4e3b\u8981\u662f\u4e3a\u4e86\u5c01\u88c5\u670d\u52a1\u53d1\u73b0\u7684\u7ec6\u8282\uff0c\u5bf9Portal\u548cClient\u800c\u8a00\uff0c\u6c38\u8fdc\u901a\u8fc7\u4e00\u4e2aHttp\u63a5\u53e3\u83b7\u53d6Admin Service\u548cConfig Service\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u800c\u4e0d\u9700\u8981\u5173\u5fc3\u80cc\u540e\u5b9e\u9645\u7684\u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0\u7ec4\u4ef6</li> <li>Meta Server\u53ea\u662f\u4e00\u4e2a\u903b\u8f91\u89d2\u8272\uff0c\u5728\u90e8\u7f72\u65f6\u548cConfig Service\u662f\u5728\u4e00\u4e2aJVM\u8fdb\u7a0b\u4e2d\u7684\uff0c\u6240\u4ee5IP\u3001\u7aef\u53e3\u548cConfig Service\u4e00\u81f4</li> </ul>"},{"location":"micro-services/apollo/#eureka","title":"Eureka","text":"<ul> <li>\u57fa\u4e8eEureka\u548cSpring Cloud Netflix\u63d0\u4f9b\u670d\u52a1\u6ce8\u518c\u548c\u53d1\u73b0</li> <li>Config Service\u548cAdmin Service\u4f1a\u5411Eureka\u6ce8\u518c\u670d\u52a1\uff0c\u5e76\u4fdd\u6301\u5fc3\u8df3</li> <li>\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u76ee\u524dEureka\u5728\u90e8\u7f72\u65f6\u548cConfig Service\u662f\u5728\u4e00\u4e2aJVM\u8fdb\u7a0b\u4e2d\u7684\uff08\u901a\u8fc7Spring Cloud Netflix\uff09</li> </ul>"},{"location":"micro-services/apollo/#portal","title":"Portal","text":"<ul> <li>\u63d0\u4f9bWeb\u754c\u9762\u4f9b\u7528\u6237\u7ba1\u7406\u914d\u7f6e</li> <li>\u901a\u8fc7Meta Server\u83b7\u53d6Admin Service\u670d\u52a1\u5217\u8868\uff08IP+Port\uff09\uff0c\u901a\u8fc7IP+Port\u8bbf\u95ee\u670d\u52a1</li> <li>\u5728Portal\u4fa7\u505aload balance\u3001\u9519\u8bef\u91cd\u8bd5</li> </ul>"},{"location":"micro-services/apollo/#client","title":"Client","text":"<ul> <li>Apollo\u63d0\u4f9b\u7684\u5ba2\u6237\u7aef\u7a0b\u5e8f\uff0c\u4e3a\u5e94\u7528\u63d0\u4f9b\u914d\u7f6e\u83b7\u53d6\u3001\u5b9e\u65f6\u66f4\u65b0\u7b49\u529f\u80fd</li> <li>\u901a\u8fc7Meta Server\u83b7\u53d6Config Service\u670d\u52a1\u5217\u8868\uff08IP+Port\uff09\uff0c\u901a\u8fc7IP+Port\u8bbf\u95ee\u670d\u52a1</li> <li>\u5728Client\u4fa7\u505aload balance\u3001\u9519\u8bef\u91cd\u8bd5</li> </ul> <p>\u6a21\u5757\u5212\u5206\uff1a</p> <p></p>"},{"location":"micro-services/apollo/#_1","title":"\u5176\u4ed6\u8bbe\u8ba1","text":"<p>Audit\u662f\u64cd\u4f5c\u8bb0\u5f55\u7684\u6a21\u578b\uff0c\u53ef\u4ee5\u8fdb\u884c\u64cd\u4f5c\u7684\u5ba1\u8ba1</p> <p></p>"},{"location":"micro-services/apollo/#apollo","title":"apollo\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1","text":"<p>\u5206\u5e03\u5f0f\u914d\u7f6e\u4e2d\u5fc3\u662f\u5fae\u670d\u52a1\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u670d\u52a1\uff0c\u5fc5\u987b\u8981\u4fdd\u8bc1\u9ad8\u53ef\u7528\u6027\uff0cApollo\u662f\u5982\u4f55\u4fdd\u8bc1\u9ad8\u53ef\u7528\u7684\u5462\uff1f</p> <p>configService\u591a\u5b9e\u4f8b\u65e0\u72b6\u6001\u90e8\u7f72\uff0c\u67d0\u53f0\u4e0b\u7ebf\u6ca1\u6709\u5f71\u54cd\uff0c\u6240\u6709\u7684configService\u90fd\u4e0b\u7ebf\u4f1a\u9020\u6210\u5ba2\u6237\u7aef\u65e0\u6cd5\u8bfb\u53d6\u6700\u65b0\u914d\u7f6e\uff0c\u4e0d\u8fc7\u53ef\u4ee5\u53bb\u672c\u5730\u7f13\u5b58\u83b7\u53d6\u914d\u7f6e\u3002</p> <p>aadminService\u591a\u5b9e\u4f8b\u65e0\u72b6\u6001\u90e8\u7f72\uff0c\u67d0\u53f0\u4e0b\u7ebf\u6ca1\u6709\u5f71\u54cd\uff0c\u6240\u6709\u90fd\u4e0b\u7ebf\u4f1a\u9020\u6210portal\u65e0\u6cd5\u66f4\u65b0\u914d\u7f6e\u3002\u540c\u7406\u6240\u6709portal\u670d\u52a1\u4e0b\u7ebf\u4e5f\u4f1a\u9020\u6210\u7528\u6237\u65e0\u6cd5\u66f4\u65b0\u914d\u7f6e\u3002</p> <p>\u6570\u636e\u5e93\u5b95\u673a\uff0c\u7528\u6237\u65e0\u6cd5\u4fee\u6539\u914d\u7f6e\uff0cconfigService\u914d\u7f6e\u6709\u7f13\u5b58\uff0c\u5ba2\u6237\u7aef\u4ecd\u53ef\u4ee5\u6765\u67e5\u8be2\u914d\u7f6e\u3002</p>"},{"location":"micro-services/apollo/#apollo_1","title":"Apollo\u7684\u76d1\u63a7","text":"<p>Apollo\u5185\u7f6e\u652f\u6301cat\uff0c\u4f46\u662f\u53ea\u6709\u5728classpath\u626b\u63cf\u5230cat\u7684\u4f9d\u8d56\u624d\u4f1a\u542f\u7528\u3002</p> <p>\u53ef\u4ee5\u5b9a\u5236\u6269\u5c55\u63a5\u5165\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u5982InfluxDB\u7b49\u3002</p> <p>\u53ef\u4ee5\u81ea\u5df1\u5b9a\u5236\u5f00\u53d1\uff0c\u8bb0\u5f55\u4e00\u4e9b\u5173\u952e\u6307\u6807\uff0c\u5982\u63a5\u5165\u5e94\u7528\u6570\u91cf\uff0c\u914d\u7f6e\u9879\u6570\u91cf\uff0c\u53d8\u66f4\u548c\u53d1\u5e03\u6570\u91cf\uff0c\u63a8\u9001\u62c9\u53d6\u6b21\u6570\uff0cConfigService\u670d\u52a1\u7684\u63a5\u53e3\u6027\u80fd\uff0cGC\uff0cCPU\u7b49</p>"},{"location":"micro-services/apollo/#3","title":"3. \u914d\u7f6e\u53d1\u5e03\u901a\u77e5\u6d41\u7a0b","text":"<p>Admin Service \u5728\u914d\u7f6e\u53d1\u5e03\u540e\uff0c\u9700\u8981\u901a\u77e5\u6240\u6709\u7684 Config Service \u6709\u914d\u7f6e\u53d1\u5e03\uff0c\u4ece\u800c Config Service \u53ef\u4ee5\u901a\u77e5\u5bf9\u5e94\u7684\u5ba2\u6237\u7aef\u6765\u62c9\u53d6\u6700\u65b0\u7684\u914d\u7f6e\u3002</p> <p>\u4ece\u6982\u5ff5\u4e0a\u6765\u770b\uff0c\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684\u6d88\u606f\u4f7f\u7528\u573a\u666f\uff0cAdmin Service \u4f5c\u4e3a producer \u53d1\u51fa\u6d88\u606f\uff0c\u5404\u4e2aConfig Service \u4f5c\u4e3a consumer \u6d88\u8d39\u6d88\u606f\u3002\u901a\u8fc7\u4e00\u4e2a\u6d88\u606f\u7ec4\u4ef6\uff08Message Queue\uff09\u5c31\u80fd\u5f88\u597d\u7684\u5b9e\u73b0 Admin Service \u548c Config Service \u7684\u89e3\u8026\u3002</p> <p>\u5728\u5b9e\u73b0\u4e0a\uff0c\u8003\u8651\u5230 Apollo \u7684\u5b9e\u9645\u4f7f\u7528\u573a\u666f\uff0c\u4ee5\u53ca\u4e3a\u4e86\u5c3d\u53ef\u80fd\u51cf\u5c11\u5916\u90e8\u4f9d\u8d56\uff0c\u6211\u4eec\u6ca1\u6709\u91c7\u7528\u5916\u90e8\u7684\u6d88\u606f\u4e2d\u95f4\u4ef6\uff0c\u800c\u662f\u901a\u8fc7\u6570\u636e\u5e93\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u6d88\u606f\u961f\u5217\u3002</p> <p>\u5b9e\u73b0\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ol> <li>Admin Service \u5728\u914d\u7f6e\u53d1\u5e03\u540e\u4f1a\u5f80 ReleaseMessage \u8868\u63d2\u5165\u4e00\u6761\u6d88\u606f\u8bb0\u5f55\uff0c\u6d88\u606f\u5185\u5bb9\u5c31\u662f\u914d\u7f6e\u53d1\u5e03\u7684 AppId+Cluster+Namespace \uff0c\u53c2\u89c1 DatabaseMessageSender \u3002</li> <li>Config Service \u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f1a\u6bcf\u79d2\u626b\u63cf\u4e00\u6b21 ReleaseMessage \u8868\uff0c\u770b\u770b\u662f\u5426\u6709\u65b0\u7684\u6d88\u606f\u8bb0\u5f55\uff0c\u53c2\u89c1 ReleaseMessageScanner \u3002</li> <li>Config Service \u5982\u679c\u53d1\u73b0\u6709\u65b0\u7684\u6d88\u606f\u8bb0\u5f55\uff0c\u90a3\u4e48\u5c31\u4f1a\u901a\u77e5\u5230\u6240\u6709\u7684\u6d88\u606f\u76d1\u542c\u5668\uff08ReleaseMessageListener\uff09\uff0c\u5982 NotificationControllerV2 \uff0c\u6d88\u606f\u76d1\u542c\u5668\u7684\u6ce8\u518c\u8fc7\u7a0b\u53c2\u89c1 ConfigServiceAutoConfiguration \u3002</li> <li>NotificationControllerV2 \u5f97\u5230\u914d\u7f6e\u53d1\u5e03\u7684 AppId+Cluster+Namespace \u540e\uff0c\u4f1a\u901a\u77e5\u5bf9\u5e94\u7684\u5ba2\u6237\u7aef\u3002</li> </ol>"},{"location":"micro-services/apollo/#1-releasemessage","title":"1. \u914d\u7f6e\u53d1\u5e03\uff0cReleaseMessage\u8868\u63d2\u5165\u4e00\u6761\u8bb0\u5f55","text":"<ol> <li> <p>\u7528\u6237\u5728\u9875\u9762\u4fee\u6539\u914d\u7f6e\u540e\uff0c\u4f1a\u901a\u8fc7portal\u670d\u52a1\u8c03\u7528adminService\u670d\u52a1\u7684ItemController.create()\u63a5\u53e3\uff0c\u4fdd\u5b58\u4fee\u6539\u540e\u6700\u65b0\u7684\u914d\u7f6e\u9879\u5230item\u8868</p> </li> <li> <p>\u7136\u540e\u70b9\u51fb\u53d1\u5e03\uff0c\u4f1a\u8c03\u7528portal\u91cc\u7684<code>ReleaseController.createRelease()</code>\u65b9\u6cd5\uff0c\u91cc\u9762\u5148\u8c03\u7528adminService\u670d\u52a1\u7684ReleaseController\uff0c\u7136\u540e\u4f1a\u53d1\u5e03event\u51fa\u53bb\uff0c\u65b9\u4fbf\u505a\u4e9bhook\u5982\u53d1\u90ae\u4ef6\uff0c\u53d1\u4e2aMQ\u6d88\u606f\u3002</p> </li> <li> <p>adminService\u670d\u52a1\u7684<code>ReleaseController.publish()</code>\u63a5\u53e3\uff1a</p> </li> <li> <p>\u5148\u53bb\u68c0\u67e5namespace\u5bf9\u5e94\u7684\u9501\u662f\u5426\u88ab\u9501\u4f4f\uff08\u6570\u636e\u5e93namespacelock\u8868\u5b9e\u73b0\u7684)\uff0c\u628a\u5bf9\u5e94\u7684items\u8f6c\u6210json\uff0c\u4fdd\u5b58\u5230Release\u548creleaseHistory\u8868\uff0c\u8fd9\u5176\u4e2d\u6d89\u53ca\u5230\u7236namespace\u548c\u5b50namespace\u7070\u5ea6\u53d1\u5e03\u7a0d\u5fae\u590d\u6742\u70b9\u3002</p> </li> <li>\u7136\u540e\u8c03\u7528<code>DatabaseMessageSender.sendMessage()</code>\u53d1\u9001\u914d\u7f6e\u53d8\u66f4\u6d88\u606f\uff0c\u4e5f\u5c31\u662f\u5728ReleaseMessage\u8868\u6dfb\u52a0\u4e00\u6761\u8bb0\u5f55\uff0c\u5982\u4e0b\u8868\u3002\u5229\u7528id\u5b57\u6bb5\u53ef\u4ee5\u552f\u4e00\u8868\u793a\u8fd9\u4e2anameSpace\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff0cclient\u53ef\u4ee5\u5728\u8bf7\u6c42\u65f6\u4f7f\u7528\u8fd9\u4e2aid\u4f5c\u4e3a\u7248\u672c\u53f7\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u914d\u7f6e\u53d8\u66f4\u3002</li> </ol> Id Message DataChange_LastTime 29 1212+default+application 2020-10-02 06:00:38 <p>\u53e6\u5916\u4e3a\u4e86\u9632\u6b62ReleaseMessage\u8868\u65e0\u9650\u589e\u957f\uff0c\u4f1a\u63d2\u4e00\u6761\u8bb0\u5f55\u5230\u963b\u585e\u961f\u5217BlockingQueue\u91cc\uff0c\u540e\u53f0\u7ebf\u7a0b\u4f1a\u53bb\u8f6e\u8be2\u53d6\u51fa\u5224\u65ad\u6e05\u7a7a\u8868\u3002</p>"},{"location":"micro-services/apollo/#2-releasemessagelistener","title":"2. \u5b9a\u65f6\u626b\u63cfReleaseMessage\u8868\uff0c\u53d1\u5e03\u53d8\u66f4\u6d88\u606f\u7ed9listener","text":"<p>ReleaseMessageScanner\u521d\u59cb\u5316\u4e86\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u7ebf\u7a0b\u6c60\uff0c\u6bcf\u96941\u79d2\u53bb\u83b7\u53d6\u6700\u65b0\u7684500\u6761\u6570\u636e\uff0c\u7136\u540e\u5faa\u73af\u53d1\u9001ReleaseMessage\u7ed9\u6bcf\u4e2a ReleaseMessageListener\u5904\u7406\u3002</p> <pre><code>@Bean\npublic ReleaseMessageScanner releaseMessageScanner() {\n    ReleaseMessageScanner releaseMessageScanner = new ReleaseMessageScanner();\n    //0. handle release message cache \u7f13\u5b58Map&lt;message, releaseMessage&gt;\n                  releaseMessageScanner.addMessageListener(releaseMessageServiceWithCache);\n    //1. handle gray release rule\n    releaseMessageScanner.addMessageListener(grayReleaseRulesHolder);\n    //2. handle server cache\n    releaseMessageScanner.addMessageListener(configService);\n    releaseMessageScanner.addMessageListener(configFileController);\n    //3. notify clients\n    releaseMessageScanner.addMessageListener(notificationControllerV2);\n    releaseMessageScanner.addMessageListener(notificationController);\n    return releaseMessageScanner;\n}\n</code></pre>"},{"location":"micro-services/apollo/#3response","title":"3.\u670d\u52a1\u7aef\u6302\u8d77\u8bf7\u6c42\uff0c\u5f02\u6b65\u8fd4\u56deresponse","text":"<p>\u5ba2\u6237\u7aef\u6bcf60\u79d2\u6765\u8c03\u7528NotificationControllerV2.pollNotification()\u63a5\u53e3\uff0c\u670d\u52a1\u7aef\u5229\u7528DeferredResult\u628a\u8bf7\u6c42\u6302\u8d7760\u79d2\uff0c\u4e0d\u7acb\u5373\u8fd4\u56deresponse\u800c\u662f\u4fdd\u5b58\u5230\u4e00\u4e2amap\u91cc\u3002\u5728listener\u7684handMessage\u4e2d\u6709\u53e6\u5916\u7684\u7ebf\u7a0b\u4e2d\u4f1a\u5728\u63a5\u6536\u5230\u76f8\u5e94\u7684\u53d8\u66f4\u6d88\u606f\u540e,\u8c03\u7528\u5bf9\u5e94\u7684DeferredResult.setResult()\uff0c\u7acb\u5373\u8fd4\u56deresponse\u3002</p>"},{"location":"micro-services/apollo/#4-apollo-client","title":"4. Apollo-client\u89e3\u6790","text":""},{"location":"micro-services/apollo/#apollo-client","title":"Apollo-client\u542f\u52a8\u6d41\u7a0b","text":"<p>spring.factories\u6587\u4ef6\u91cc\u6307\u5b9a\u4e86\u4e24\u4e2aSpring\u7684\u914d\u7f6e\u7c7b\uff1a</p> <pre><code>org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\ncom.ctrip.framework.apollo.spring.boot.ApolloAutoConfiguration\norg.springframework.context.ApplicationContextInitializer=\\\ncom.ctrip.framework.apollo.spring.boot.ApolloApplicationContextInitializer\norg.springframework.boot.env.EnvironmentPostProcessor=\\\ncom.ctrip.framework.apollo.spring.boot.ApolloApplicationContextInitializer\n</code></pre>"},{"location":"micro-services/apollo/#1-environmentapollo","title":"1. \u5728Environment\u9636\u6bb5\u6ce8\u5165apollo\u91cd\u8981\u5c5e\u6027","text":"<p>\u200b   ApolloApplicationContextInitializer implements EnvironmentPostProcessor\u63a5\u53e3\uff0c\u5b83\u7684postProcessEnvironment()\u65b9\u6cd5\u628aapollo\u7cfb\u7edf\u5c5e\u6027\uff08\u5982appId\uff09\u4ece\u73af\u5883\u53d8\u91cf\u4e2d\u52a0\u8f7d\u5230\u7cfb\u7edf\u5c5e\u6027\u91cc\u3002</p> <p>\u200b   \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u529f\u80fd\uff0c\u5982\u679c\u5f00\u542f\u4e86apollo.bootstrap.eagerLoad.enabled\uff0c\u5c31\u53bb\u6025\u5207\u7684\u521d\u59cb\u5316namespace\uff08\u5373\u4e0b\u9762\u63d0\u5230\u7684\uff09\uff0c\u5728\u65e5\u5fd7\u7cfb\u7edf\u52a0\u8f7d\u524d\u5148\u8bfb\u53d6Apollo\u914d\u7f6e\u3002</p> <pre><code>@Override\npublic void postProcessEnvironment(ConfigurableEnvironment configurableEnvironment, SpringApplication springApplication) {\n    // \u5148\u628a\u4e00\u4e9bapollo\u5fc5\u9700\u7684\u5c5e\u6027\u5148\u52a0\u8f7d\u8fdb\u6765,\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u7ba1\u4ec0\u4e48\u914d\u7f6e\u65b9\u5f0f\u90fd\u4f1a\u6267\u884c\uff0c\u6b64\u65f6\u5bb9\u5668\u8fd8\u6ca1\u542f\u52a8\n    // should always initialize system properties like app.id in the first place\n    initializeSystemProperty(configurableEnvironment);\n\n    // \u5982\u679c\u5f00\u542f\u4e86apollo.bootstrap.eagerLoad.enabled = true\n    if (bootstrapEnabled &amp;&amp; eagerLoadEnabled) {\n        // \u5148\u53bb\u6267\u884cinitialize\u65b9\u6cd5\u521d\u59cb\u5316apollo\u914d\u7f6e\uff0c\uff08\u53ef\u5b9e\u73b0\u5728\u65e5\u5fd7\u7cfb\u7edf\u52a0\u8f7d\u4e4b\u524d\u5c31\u6ce8\u5165\u5c5e\u6027\u503c\uff09\n        initialize(configurableEnvironment);\n    }\n}\n\nvoid initializeSystemProperty(ConfigurableEnvironment environment) {\n    for (String propertyName : APOLLO_SYSTEM_PROPERTIES) {\n        // \u4ece\u73af\u5883\u53d8\u91cfenvironment\u4e2d\u628a\u503c\u586b\u5145\u8fdbSystemProperty\uff0c\u76f4\u63a5\u4eceenvironment\u83b7\u53d6\u4e0d\u597d\u5417\n        String propertyValue = environment.getProperty(propertyName);\n        System.setProperty(propertyName, propertyValue);\n    }\n}\n</code></pre>"},{"location":"micro-services/apollo/#2-applicationcontextinitializerproperty-sources","title":"2. \u5728\u5bb9\u5668ApplicationContextInitializer\u9636\u6bb5\u6ce8\u518cproperty sources","text":"<p>ApplicationContextInitializer\u540d\u4e3a\u521d\u59cb\u5316ApplicationContext\uff0c\u5728ConfigurableApplicationContext.refresh()\u4e4b\u524d\u6267\u884c\uff0c\u4e00\u822c\u7528\u4e8e\u6ce8\u518cproperty sources\u6216\u8005\u6fc0\u6d3bprofiles</p> <p>ApplicationContextInitializer.initialize()\u65b9\u6cd5\u4e2d\uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\u4e86apollo.bootstrap.enabled=true\uff0c\u4f1a\u628a\u914d\u7f6e\u6587\u4ef6<code>apollo.bootstrap.namespaces=application,mq</code>\u91cc\u6307\u5b9a\u7684\u6240\u6709namespace\u2014&gt;config\u2014&gt;ConfigPropertySource\u6dfb\u52a0\u5230environment\u7684PropertySources\u4e2d\uff08name\u4e3aApolloBootstrapPropertySources\uff0c\u987a\u5e8f\u4e3a\u7b2c\u4e00\u4e2a\uff09\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\u6307\u5b9a<code>apollo.bootstrap.namespaces=application,mq</code>\uff0c\u800c\u662f\u901a\u8fc7@EnableApolloConfig(value=\"application\")\uff0c\u5219\u4e0b\u9762\u7684@EnableApolloConfig\u4f1a\u8fdb\u884c\u5904\u7406\u3002\u4e5f\u5c31\u662f\u652f\u6301\u4e24\u79cd\u65b9\u5f0f\u914d\u7f6enamespaces</p>"},{"location":"micro-services/apollo/#3-beandefinitions","title":"3. \u6ce8\u518c\u5404\u79cdBeanDefinitions","text":"<p>ApolloAutoConfiguration\u8d1f\u8d23\u81ea\u52a8\u914d\u7f6e\uff0c\u6761\u4ef6\u4e3aapollo.bootstrap.enabled=true\u4e14@ConditionalOnMissingBean(PropertySourcesProcessor.class)</p> <pre><code>@Configuration\n@ConditionalOnProperty(PropertySourcesConstants.APOLLO_BOOTSTRAP_ENABLED) // \u5f00\u542fapollo.bootstrap.enabled=true\n@ConditionalOnMissingBean(PropertySourcesProcessor.class) // \u53ea\u6709\u6ca1\u6709\u914d\u7f6ePropertySourcesProcessor\u65f6\uff0c\u624d\u4f1a\u5f00\u542f\u81ea\u52a8\u914d\u7f6e\npublic class ApolloAutoConfiguration {\n  @Bean\n  public ConfigPropertySourcesProcessor configPropertySourcesProcessor() {\n    return new ConfigPropertySourcesProcessor();\n  }\n}\n</code></pre> <p>\u5b83\u4f1a\u751f\u6210\u4e00\u4e2aBean\u5373ConfigPropertySourcesProcessor \uff0c\u5b83\u59d4\u6258ConfigPropertySourcesProcessorHelper\u6ce8\u518c\u591a\u4e2aBeanDefinition\uff0c\u6bd4\u4e0b\u9762\u63d0\u5230\u7684DefaultApolloConfigRegistrarHelper\u5c11\u6ce8\u518c\u4e86\u4e2aPropertySourcesProcessor\u3002\u56e0\u4e3aConfigPropertySourcesProcessor extends PropertySourcesProcessor\uff0c\u672c\u8eab\u5c31\u5df2\u7ecf\u662f\u4e2aPropertySourcesProcessor\u4e86\u3002</p> <pre><code>public class ConfigPropertySourcesProcessor extends PropertySourcesProcessor\n    implements BeanDefinitionRegistryPostProcessor {\n\n  private ConfigPropertySourcesProcessorHelper helper = ServiceBootstrap.loadPrimary(ConfigPropertySourcesProcessorHelper.class);\n\n  @Override\n  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {\n    helper.postProcessBeanDefinitionRegistry(registry);\n  }\n}\n</code></pre> <p>\u6ce8\u89e3\u914d\u7f6e</p> <p>\u5982\u679c\u4f7f\u7528\u4e86@EnableApolloConfig\u6ce8\u89e3\uff0c\u4e0a\u9762\u7684\u81ea\u52a8\u914d\u7f6e\u5c31\u4f1a\u5931\u6548\u3002\u5b83Import \u5b9e\u73b0\u4e86ImportBeanDefinitionRegistrar\u63a5\u53e3\u7684ApolloConfigRegistrar\uff0c\u91cc\u9762\u59d4\u6258DefaultApolloConfigRegistrarHelper\u6ce8\u518c\u591a\u4e2aBeanDefinition\uff0c\u5982\u4e0b\uff1a</p> <pre><code>@Override\npublic void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n    AnnotationAttributes attributes = AnnotationAttributes\n        .fromMap(importingClassMetadata.getAnnotationAttributes(EnableApolloConfig.class.getName()));\n    // \u89e3\u6790EnableApolloConfig\u6ce8\u89e3\u91cc\u914d\u7f6e\u7684namespaces\u3002\u751f\u4ea7\u4e2d\u4e00\u822c\u662f\u5728\u914d\u7f6e\u6587\u4ef6\u91cc\u6307\u5b9a\u8981\u83b7\u53d6\u7684namespaces\n    String[] namespaces = attributes.getStringArray(\"value\");\n    int order = attributes.getNumber(\"order\");\n PropertySourcesProcessor.addNamespaces(Lists.newArrayList(namespaces), order);\n\n    // PropertySourcesPlaceholderConfigurer\u8d1f\u8d23\u66ff\u6362PlaceHolder\u4e3a\u5bf9\u5e94\u7684\u5c5e\u6027\u503c\uff0c\u8981\u786e\u4fdd\u5148\u6267\u884c\n    Map&lt;String, Object&gt; propertySourcesPlaceholderPropertyValues = new HashMap&lt;&gt;();\n    // to make sure the default PropertySourcesPlaceholderConfigurer's priority is higher than PropertyPlaceholderConfigurer\n    propertySourcesPlaceholderPropertyValues.put(\"order\", 0);\n    BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, PropertySourcesPlaceholderConfigurer.class.getName(),\n        PropertySourcesPlaceholderConfigurer.class, propertySourcesPlaceholderPropertyValues);\n\n    // \u6ce8\u518cPropertySourcesProcessor\uff0c\u5c06@EnableApolloConfig\u6ce8\u89e3\u91cc\u914d\u7f6e\u7684namespaces\u96c6\u6210\u5230Spring\u7684PropertySources\u91cc\n    BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, PropertySourcesProcessor.class.getName(), PropertySourcesProcessor.class);\n\n    // \u6ce8\u518cApolloAnnotationProcessor\uff0c\u5b83\u8d1f\u8d23\u89e3\u6790@ApolloConfigChangeListener\u548c@ApolloConfig\n    BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ApolloAnnotationProcessor.class.getName(), ApolloAnnotationProcessor.class);\n\n    // \u6ce8\u518cSpringValueProcessor \u5b83\u8d1f\u8d23\u52a0\u8f7d\u6240\u6709\u7684SpringValue\uff0c\u89e3\u6790@Value\n    BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringValueProcessor.class.getName(),\n        SpringValueProcessor.class);\n\n    // \u6ce8\u518cSpringValueDefinitionProcessor\uff0c\u7528\u4e8exml\u914d\u7f6e\u7684bean\n    BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringValueDefinitionProcessor.class.getName(), SpringValueDefinitionProcessor.class);\n\n    // \u6ce8\u518cApolloJsonValueProcessor\uff0c\u89e3\u6790@ApolloJsonValue\n    BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ApolloJsonValueProcessor.class.getName(), ApolloJsonValueProcessor.class);\n}\n</code></pre> <p>\u4ee5\u4e0a\u7684\u6d41\u7a0b\u8bf4\u660e\u4e86\u540c\u65f6\u652f\u6301xml\u914d\u7f6e\u548cjava\u914d\u7f6e\u4e24\u79cd\u914d\u7f6e\u65b9\u5f0f\u3002</p> <p>\u5982\u679c\u662fxml\u914d\u7f6e\uff0c\u5219ApolloApplicationContextInitializer\u548cApolloAutoConfiguration\u751f\u6548\uff1b</p> <p>\u5982\u679c\u662fjava\u914d\u7f6e\u5373\u4f7f\u7528@EnableApolloConfig\uff0c\u5219ApolloAutoConfiguration\u4e0d\u518d\u53d1\u6325\u4f5c\u7528\uff0c\u5f53\u7136\u5982\u679c\u540c\u65f6\u5728xml\u548cjava\u4e2d\u90fd\u6307\u5b9a\u4e86namespace\uff0c\u4e5f\u6ca1\u95ee\u9898\u3002</p> <p></p>"},{"location":"micro-services/apollo/#_2","title":"\u83b7\u53d6\u6700\u65b0\u914d\u7f6e","text":"<p>\u5ba2\u6237\u7aef\u901a\u8fc7\u957f\u8f6e\u8be2\u548c\u5b9a\u65f6\u62c9\u53d6\u4e24\u79cd\u65b9\u5f0f\u53bb\u670d\u52a1\u7aef\u83b7\u53d6\u914d\u7f6e\uff1a</p> <p></p> <p>\u4e3a\u4ec0\u4e48\u4e0d\u5728\u63a8\u9001\u65f6\u5c31\u8fd4\u56de\u5177\u4f53\u914d\u7f6e\u4fe1\u606f\uff1f.</p> <p>\u8fd9\u6837\u53ef\u4ee5\u4fdd\u6301\u5b9e\u65f6\u548c\u8bbe\u8ba1\u4e0a\u7684\u7b80\u5355\u3002\u5982\u679c\u5728\u63a8\u9001\u4e2d\u76f4\u63a5\u8fd4\u56de\u914d\u7f6e\u4fe1\u606f\uff0c\u4f1a\u9020\u6210\u5e42\u7b49\u6027\u95ee\u9898\uff0c\u6d88\u606f\u4e22\u5931\u7684\u95ee\u9898\uff08\u76ee\u524d\u662f\u5355http\u8fde\u63a5\uff0c\u6682\u4e0d\u7528\u8003\u8651\u987a\u5e8f\uff0c\u4f46\u7ed9\u4ee5\u540e\u8bbe\u8ba1\u5982webSocket\u57cb\u5751\uff09\uff1b\u8ba1\u7b97\u4e5f\u6bd4\u8f83\u590d\u6742\uff0c\u8fd8\u53ef\u80fd\u548c\u5b9a\u65f6\u8f6e\u8be2\u4ea7\u751f\u51b2\u7a81\u9020\u6210\u53cc\u5199\u3002</p> <p>\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4fdd\u6301\u957f\u8fde\u63a5\uff0c\u5b9e\u73b0\u914d\u7f6e\u66f4\u65b0\u7684\u63a8\u9001</p> <p>\u5176\u4e2d\u957f\u8fde\u63a5\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7Http Long Polling\u5b9e\u73b0\u7684\uff0c\u5177\u4f53\u800c\u8a00\uff1a</p> <ul> <li>RemoteConfigLongPollService\u53d1\u8d77\u4e00\u4e2aHttp\u8bf7\u6c42\u5230\u670d\u52a1\u7aef\uff0c\u8d85\u65f690\u79d2</li> <li> <p>\u670d\u52a1\u7aef\u4e0d\u4f1a\u7acb\u5373\u8fd4\u56de\u7ed3\u679c\uff0c\u800c\u662f\u901a\u8fc7Spring DeferredResult\u628a\u8bf7\u6c42\u6302\u8d7760\u79d2</p> </li> <li> <p>\u5982\u679c\u572860\u79d2\u5185\u6709\u5ba2\u6237\u7aef\u5173\u5fc3\u7684\u914d\u7f6e\u53d8\u5316\uff0c\u5b9e\u73b0\u4e86ReleaseMessageListener\u63a5\u53e3\u7684NotificationControllerV2\u4f1a\u8c03\u7528\u5bf9\u5e94\u7684DeferredResult\u7684setResult\u65b9\u6cd5\uff0c\u8fd4\u56deresponse\u3002\u5ba2\u6237\u7aef\u4ece\u8fd4\u56de\u7684\u7ed3\u679c\u4e2d\u83b7\u53d6\u5230\u914d\u7f6e\u53d8\u5316\u7684namespace\u540e\uff0c\u4f1a\u7acb\u5373\u901a\u77e5\u5bf9\u5e94\u7684RemoteConfigRepository\u8bf7\u6c42\u670d\u52a1\u7aef\u83b7\u53d6\u8be5namespace\u7684\u6700\u65b0\u914d\u7f6e\u3002</p> </li> <li> <p>\u5982\u679c\u572860\u79d2\u5185\u6ca1\u6709\u5ba2\u6237\u7aef\u5173\u5fc3\u7684\u914d\u7f6e\u53d8\u5316\uff0c\u90a3\u4e48\u4f1a\u8fd4\u56deHttp\u72b6\u6001\u7801304\u7ed9\u5ba2\u6237\u7aef</p> </li> <li>\u5ba2\u6237\u7aef\u5728\u6536\u5230\u670d\u52a1\u7aef\u8bf7\u6c42\u540e\u4f1a\u7acb\u5373\u91cd\u65b0\u53d1\u8d77\u8fde\u63a5\uff0c\u56de\u5230\u7b2c\u4e00\u6b65</li> </ul> <pre><code>// \u5f00\u542f\u957f\u8f6e\u8be2\u7ebf\u7a0b\u4efb\u52a1\nm_longPollingService.submit(new Runnable() {\n    @Override\n    public void run() {\n        // \u5728\u4e0a\u9762\u5ef6\u8fdf\u4e00\u5b9a\u65f6\u5019\u540e\uff0c\u5f00\u542f\u8f6e\u8be2\n        doLongPollingRefresh(appId, cluster, dataCenter, secret);\n    }\n});\n\nprivate void doLongPollingRefresh(String appId, String cluster, String dataCenter, String secret) {\n    final Random random = new Random();\n    ServiceDTO lastServiceDto = null;\n    // \u5faa\u73af\u4e0d\u505c\u6267\u884c\uff0c\u53d1\u51fa\u957f\u8f6e\u8be2\u8bf7\u6c42\n    while (!m_longPollingStopped.get() &amp;&amp; !Thread.currentThread().isInterrupted()) {\n        if (!m_longPollRateLimiter.tryAcquire(5, TimeUnit.SECONDS)) {\n            //wait at most 5 seconds\n            try {\n                TimeUnit.SECONDS.sleep(5);\n            } catch (InterruptedException e) {\n            }\n        }\n        String url = null;\n        try {\n            // \u5982\u679clastServiceDto\u4e0d\u4e3a\u7a7a\uff0c\u5c31\u7528\u4e0a\u6b21\u7684config\u670d\u52a1\u5730\u5740\u3002\u5426\u5219\u968f\u673a\u9009\u53d6\u4e00\u4e2a\uff0c\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\n            if (lastServiceDto == null) {\n                List&lt;ServiceDTO&gt; configServices = getConfigServices();\n                // list\u4e2d\u968f\u673a\u53d6\u4e00\u4e2a random.nextInt\n                lastServiceDto = configServices.get(random.nextInt(configServices.size()));\n            }\n\n            url = assembleLongPollRefreshUrl(lastServiceDto.getHomepageUrl(), appId, cluster, dataCenter,\n                                             m_notifications);\n            logger.debug(\"Long polling from {}\", url);\n\n            HttpRequest request = new HttpRequest(url);\n            // \u8bbe\u7f6e\u5ba2\u6237\u7aef\u7684\u8fc7\u671f\u65f6\u95f4 90\u79d2\u3002\u670d\u52a1\u7aef\u4f1a60\u5185\u8fd4\u56de\u3002\u8fd9\u91cc\u4e5f\u662f\u670d\u52a1\u7aef\u4e0d\u80fd\u8d85\u8fc790\u79d2\u7684\u539f\u56e0\n            request.setReadTimeout(LONG_POLLING_READ_TIMEOUT);\n\n            // \u8fd9\u91cc\u53d1\u51fa\u4e86\u8bf7\u6c42\uff0c\u5f97\u5230response\n            final HttpResponse&lt;List&lt;ApolloConfigNotification&gt;&gt; response = m_httpUtil.doGet(request, m_responseType);\n            logger.debug(\"Long polling response: {}, url: {}\", response.getStatusCode(), url);\n            if (response.getStatusCode() == 200 &amp;&amp; response.getBody() != null) {\n                // \u53bb\u901a\u77e5\u53d8\u66f4\n                notify(lastServiceDto, response.getBody());\n            }\n\n            //try to load balance \u968f\u673a\u91cd\u7f6elastServiceDto\uff0c\n            if (response.getStatusCode() == 304 &amp;&amp; random.nextBoolean()) {\n                lastServiceDto = null;\n            }\n            m_longPollFailSchedulePolicyInSecond.success();\n        } catch (Throwable ex) {\n            try {\n                TimeUnit.SECONDS.sleep(sleepTimeInSecond);\n            } catch (InterruptedException ie) {\n            }\n        }\n    }\n}\n</code></pre> <p>\u5ba2\u6237\u7aef\u5b9a\u65f6\u62c9\u53d6\u6700\u65b0\u914d\u7f6e</p> <p>\u8fd9\u662f\u4e00\u4e2afallback\u673a\u5236\uff0c\u4e3a\u4e86\u9632\u6b62\u63a8\u9001\u673a\u5236\u5931\u6548\u5bfc\u81f4\u914d\u7f6e\u4e0d\u66f4\u65b0</p> <p>\u5ba2\u6237\u7aef\u5b9a\u65f6\u62c9\u53d6\u5e76\u4e0a\u62a5\u672c\u5730\u7248\u672c\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5bf9\u4e8e\u5b9a\u65f6\u62c9\u53d6\u7684\u64cd\u4f5c\uff0c\u670d\u52a1\u7aef\u90fd\u4f1a\u8fd4\u56de304 - Not Modified\u3002\u5b9a\u65f6\u9891\u7387\u9ed8\u8ba4\u4e3a\u6bcf5\u5206\u949f\u62c9\u53d6\u4e00\u6b21\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9aSystem Property: <code>apollo.refreshInterval</code>\u6765\u8986\u76d6\uff0c\u5355\u4f4d\u4e3a\u5206\u949f\u3002</p> <pre><code>// \u6bcf5\u5206\u949f\u6267\u884c\uff0c\u53bb\u62c9\u53d6apollo\u6700\u65b0\u914d\u7f6e\nm_executorService.scheduleAtFixedRate(\n    new Runnable() {\n        @Override\n        public void run() {\n            trySync();\n        }\n    }, m_configUtil.getRefreshInterval(), m_configUtil.getRefreshInterval(),\n    m_configUtil.getRefreshIntervalTimeUnit());\n</code></pre>"},{"location":"micro-services/apollo/#_3","title":"\u5b9e\u65f6\u66f4\u65b0\u914d\u7f6e","text":"<p>\u5148\u6765\u4e86\u89e3\u4e0b\u9762\u51e0\u4e2a\u6982\u5ff5\uff1a</p> <p>\u6211\u4eec\u5728\u4f7f\u7528apollo\u65f6\uff0c\u7ecf\u5e38\u4f7f\u7528\u5230\u4e0b\u9762\u65b9\u5f0f\u83b7\u53d6config\uff1a</p> <pre><code>Config config = ConfigService.getAppConfig(); // \u8fd9\u4e2a\u5c31\u662f\u53bb\u83b7\u53d6\u9ed8\u8ba4\u7684getConfig(\"application\")\nConfig config = ConfigService.getConfig(namespace);\n\n// \u6216\u8005\u5c5e\u6027\u6ce8\u5165\u7684\u65b9\u5f0f\u83b7\u53d6\n@ApolloConfig\nprivate Config config;\n</code></pre> <p>ConfigService\u76f8\u5f53\u4e8e\u5de5\u5177\u7c7b\uff0c\u4e3b\u8981\u63d0\u4f9b\u4e86getConfig(String namespace)\u548cgetAppConfig()\u65b9\u6cd5\u3002</p> <p>\u5b83\u59d4\u6258ConfigManager\u7684\u5b9e\u73b0\u7c7bDefaultConfigManager.Map\u4fdd\u5b58\u4e86\u6240\u6709namespace\u53ca\u5176\u5bf9\u5e94\u7684Config\uff0c\u53ef\u4ee5\u6839\u636enamespace\u8fd4\u56de\u5bf9\u5e94\u7684Config\u5b9e\u4f8b\u3002\u4e3a\u7a7a\u5219\u4f1a\u5229\u7528ConfigFactoryManager\u627e\u5230\u5bf9\u5e94\u7684ConfigFactory\u53bb\u521b\u5efanamespace\u5bf9\u5e94\u7684Config\u3002 <pre><code>public class DefaultConfigManager implements ConfigManager {\n  private ConfigFactoryManager m_factoryManager;\n\n  // \u4fdd\u5b58\u6240\u6709namespace\u53ca\u5176\u5bf9\u5e94\u7684Config\n  private Map&lt;String, Config&gt; m_configs = Maps.newConcurrentMap();\n  private Map&lt;String, ConfigFile&gt; m_configFiles = Maps.newConcurrentMap();\n\n  /**\n    * ConfigService.getConfig()\u4f1a\u59d4\u6258\u8fd9\u4e2a\u7c7b\u6765\u5bfb\u627enamespace\u5bf9\u5e94\u7684Config\uff0c\n    */\n    @Override\n    public Config getConfig(String namespace) {\n        Config config = m_configs.get(namespace);\n\n        if (config == null) {\n            synchronized (this) {\n                // \u53cc\u91cd\u68c0\u67e5\u9501\n                config = m_configs.get(namespace);\n\n                if (config == null) {\n                    ConfigFactory factory = m_factoryManager.getFactory(namespace);\n\n                    config = factory.create(namespace);\n                    m_configs.put(namespace, config);\n                }\n            }\n        }\n\n        return config;\n    }\n}\n</code></pre> <p>SPI\u673a\u5236 (Service Provider Interface)\uff0c\u4fbf\u4e8e\u7b2c\u4e09\u65b9\u6216\u63d2\u4ef6\u8fdb\u9879\u6269\u5c55\u6dfb\u52a0\u81ea\u5df1\u7684\u5b9e\u73b0\uff0c\u63d0\u9ad8\u6269\u5c55\u6027\u3002</p> <p>\u76f8\u5173\u63a5\u53e3\u4e3aConfigFactory\uff0cConfigFactoryManager\uff0cConfigRegistry\uff0c\u901a\u8fc7ConfigService\u7c7b\u63d0\u4f9b\u5916\u90e8\u63a5\u53e3\uff0c\u5177\u4f53\u6765\u8bf4\u662f\u4e3a\u6307\u5b9anamespace\u521b\u5efaConfig\u3002</p> <p>DefaultConfigFactory\u8d1f\u8d23\u4e3a\u6307\u5b9anamespace\u521b\u5efaDefaultConfig\uff0c\u4e3a\u5176\u521b\u5efa\u5bf9\u5e94\u7684configRepository\uff0c\u4e00\u822c\u662fupstream\u5173\u8054\u4e86RemoteConfigRepository\u7684LocalFileConfigRepository\u3002</p> <pre><code>public class DefaultConfigFactory implements ConfigFactory {\n  /**\n   * \u7ed9\u6307\u5b9anamespace\u521b\u5efaConfig\n   */\n  @Override\n  public Config create(String namespace) {\n    ConfigFileFormat format = determineFileFormat(namespace);\n    if (ConfigFileFormat.isPropertiesCompatible(format)) {\n      return new DefaultConfig(namespace, createPropertiesCompatibleFileConfigRepository(namespace, format));\n    }\n    // \u521b\u5efa\u4e00\u4e2a\u5173\u8054\u4e86RemoteConfigRepository\u7684LocalFileConfigRepository\n    return new DefaultConfig(namespace, new LocalFileConfigRepository(namespace, createRemoteConfigRepository(namespace)));\n  }\n}\n</code></pre> <p>\u5b9e\u4f53\u6620\u5c04\u5173\u7cfb\u4e3a\uff1a</p> <p>\u6bcf\u4e2a\u914d\u7f6e\u6587\u4ef6 \u2014&gt; namespace \u2014&gt; config  \u2014&gt; DefaultConfig \u2014&gt; LocalFileConfigRepository \u2014&gt; RemoteConfigRepository</p> <p>ConfigRepository</p> <p>\u662f\u914d\u7f6e\u9879\u6765\u6e90\u7684\u62bd\u8c61\uff0c\u8d1f\u8d23\u83b7\u53d6\u914d\u7f6e\uff0c\u5e76\u5728\u914d\u7f6e\u66f4\u65b0\u65f6\u53d1\u51fa\u901a\u77e5\u3002</p> <p></p> <p>\u521b\u5efaconfig\u65f6\u4f1a\u521b\u5efa\u5bf9\u5e94\u7684RemoteConfigRepository\uff0c\u5728\u4e3a\u6307\u5b9anamespace\u521b\u5efaRemoteConfigRepository\u65f6\uff0c\u4f1a\u521d\u59cb\u5316\u4ee5\u4e0b\u52a8\u4f5c\uff1a</p> <pre><code>public RemoteConfigRepository(String namespace) {\n    // \u521d\u59cb\u5316\u65f6\u5148\u53bb\u62c9\u53d6\u4e00\u6b21\u914d\u7f6e\n    this.trySync();\n    // \u6bcf\u96945\u5206\u949f\u53bb\u5b9a\u65f6\u62c9\u53d6\n    this.schedulePeriodicRefresh();\n    // \u6ce8\u518c\u5230RemoteConfigLongPollService\u8fdb\u884c\u957f\u8f6e\u8be2\n    this.scheduleLongPollingRefresh();\n}\n</code></pre> <p>\u5176\u4e2d\u957f\u8f6e\u8be2\u662f\u59d4\u6258\u7ed9RemoteConfigLongPollService\u7edf\u4e00\u8fdb\u884c\u7ba1\u7406\uff0c\u957f\u8f6e\u8be2\u63a5\u6536\u5230\u914d\u7f6e\u53d8\u66f4\u540e\uff08\u8fd4\u56de200\u8868\u793a\u6709\u53d8\u5316\uff09\u53bb\u901a\u77e5\u5173\u5fc3\u8be5namespace\u7684RemoteConfigRepository.onLongPollNotified()\u3002\u7136\u540eRemoteConfigRepository\u7acb\u5373\u91cd\u65b0\u53bbtrySync()\u62c9\u53d6\u914d\u7f6e\uff0c\u5728sync()\u83b7\u53d6\u5230\u53d8\u5316\u7684\u914d\u7f6e\u540e\uff0c\u4f1a\u4f9d\u6b21\u901a\u77e5\u5404\u4e2aRepositoryChangeListener\uff0clistener\u76ee\u524d\u53ea\u6709LocalFileConfigRepository\u3002</p> <p>LocalFileConfigRepository\u5728\u63a5\u6536\u5230RepositoryChange\u65f6\uff0c\u4f1a\u66ff\u6362\u6389\u7f13\u5b58\u5e76\u6301\u4e45\u5230\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u91cc\uff0c\u5e76\u4e5f\u53d1\u51fafireRepositoryChange\uff0clistener\u4e3a\u4e0b\u9762\u63d0\u5230\u7684DefaultConfig\u3002</p> <p>Config</p> <p>Config\u662f\u914d\u7f6e\u6587\u4ef6\u7684\u62bd\u8c61\uff0c\u5bf9\u5e94\u4e00\u4e2anamespace\uff0c\u8d1f\u8d23\u914d\u7f6e\u7684\u8bfb\u53d6\u67e5\u8be2\u548c\u53d8\u66f4\u901a\u77e5\u3002configFile\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u662f\u6587\u4ef6\u7ea7\u522b\u7684\uff0c\u7528\u7684\u4e0d\u591a\u4e0d\u518d\u8d58\u8ff0\u3002</p> <p></p> <p>Config\u63a5\u53e3\u7684\u62bd\u8c61\u7c7bAbstractConfig\u66b4\u9732\u4e86\u8bb8\u591a\u83b7\u53d6\u5c5e\u6027\u7684\u65b9\u6cd5\uff0c\u5e76\u505a\u4e86\u7f13\u5b58\uff0c\u8fd8\u7edf\u4e00\u6536\u53e3\u7ba1\u7406\u4e86ConfigChangeListener\u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\uff0c\u5728\u53d8\u66f4\u65f6\u8fdb\u884c\u901a\u77e5\u3002</p> <p>AbstractConfig\u76ee\u524d\u53ea\u6709\u4e00\u4e2a\u5b50\u7c7bDefaultConfig\uff0c\u4e3b\u8981\u8d1f\u8d23\u4e24\u4ef6\u4e8b\u60c5\uff1a\u4e00\u662f\u5b9e\u73b0\u4e86RepositoryChangeListener\u63a5\u53e3\uff0c\u5728onRepositoryChange\u65f6\u6765\u66f4\u65b0\u5c5e\u6027\uff1b\u4e8c\u662f\u5b9e\u9645\u8d1f\u8d23\u83b7\u53d6\u5c5e\u6027\uff08\u6309\u7167\u4f18\u5148\u7ea7\u53bb\u4e0d\u540c\u5730\u65b9\uff09</p> <p>\u603b\u7ed3\u6765\u8bf4\u4e3b\u8981\u6d41\u7a0b\u5982\u4e0b\u56fe\uff1a</p> <p></p> <p>\u5176\u4e2dDefaultConfig\u6536\u5230RepositoryChange\u6d88\u606f\uff0c\u8ba1\u7b97\u51fa\u6765\u66f4\u65b0\u7684\u914d\u7f6e\uff0c\u7136\u540efireConfigChange\u53d1\u51faConfigChangeEvent\u4e8b\u4ef6\uff0c\u901a\u77e5\u5404\u4e2alistener\u3002\u8fd9\u91cc\u7684listener\u5305\u542b\u6dfb\u52a0@ApolloConfigChangeListener\u6ce8\u89e3\u7684\uff1b\u7528\u6237\u81ea\u5df1\u5b9e\u73b0ConfigChangeListener\u63a5\u53e3\u7684\uff1b\u8fd8\u6709\u8d1f\u8d23\u5904\u7406@Value\u5c5e\u6027\u7684AutoUpdateConfigChangeListener\u3002</p> <p>apollo\u662f\u5982\u4f55\u81ea\u52a8\u66f4\u65b0Spring Placeholder\u7684@value\u7684\u5c5e\u6027\u7684\u5462\uff1f</p> <p>apollo\u5728\u542f\u52a8\u65f6\uff0c\u6ce8\u518c\u4e86\u4e00\u4e2aSpringValueProcessor\uff0c\u5b83\u7684\u7236\u7c7babstract class ApolloProcessor\u5b9e\u73b0\u4e86BeanPostProcessor\uff0c\u83b7\u53d6\u6bcf\u4e2abean\u6240\u6709\u7684Filed\u548cMethod\u5c5e\u6027\u3002\u7136\u540e\u7531\u5b50\u7c7bSpringValueProcessor\uff0c\u904d\u5386\u6bcf\u4e2aField\u4e0a\u662f\u5426\u6709Value\u6ce8\u89e3\uff0c\u83b7\u53d6placeholder\u91cc\u9762\u7684key\uff0c\u6bcf\u4e2akey\u5bf9\u5e94\u4e00\u4e2aSpringValue\u5bf9\u8c61\uff0c\u7136\u540e\u6ce8\u518c\u5230springValueRegistry\uff0c\u4e5f\u5c31\u662f\u8bf4springValueRegistry\u6301\u6709\u4e86\u6240\u6709\u7684SpringValue\u3002</p> <p>\u7136\u540eAutoUpdateConfigChangeListener\u5b9e\u73b0\u4e86ConfigChangeListener\u63a5\u53e3\uff0c\u5e76\u6301\u6709springValueRegistry\uff0c\u6240\u4ee5\u5728\u63a5\u6536\u5230DefaultConfig\u53d1\u5e03\u7684\u914d\u7f6e\u53d8\u66f4\u540e\uff0c\u5faa\u73af\u904d\u5386key\uff0c\u627e\u5230key\u5bf9\u5e94\u7684SpringValue\uff0c\u7136\u540e\u5229\u7528\u53cd\u5c04\u66f4\u65b0\u5176\u503c\u3002</p> <pre><code>public void update(Object newVal)  {\n    if (isField()) {\n      injectField(newVal);\n    } else {\n      injectMethod(newVal);\n    }\n  }\n\n  private void injectField(Object newVal) throws IllegalAccessException {\n    Object bean = beanRef.get();\n    if (bean == null) {\n      return;\n    }\n    // \u901a\u8fc7\u53cd\u5c04\u7684\u65b9\u5f0f\u76f4\u63a5\u66f4\u65b0\u503c\u3002Accessible\u5148\u8bbe\u4e3atrue\uff0c\u518d\u6539\u56de\u53bb\n    boolean accessible = field.isAccessible();\n    field.setAccessible(true);\n    field.set(bean, newVal);\n    field.setAccessible(accessible);\n  }\n\n  private void injectMethod(Object newVal)\n      throws InvocationTargetException, IllegalAccessException {\n    Object bean = beanRef.get();\n    if (bean == null) {\n      return;\n    }\n    methodParameter.getMethod().invoke(bean, newVal);\n  }\n</code></pre> <p>\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u6709\u4e00\u4e2a\u95ee\u9898\u554a\uff0capollo\u5728\u521d\u59cb\u5316\u65f6\u662f\u628a\u914d\u7f6e\u5c5e\u6027\u96c6\u6210\u5230Spring\u7684PropertySource \u4f53\u7cfb\u4e2d\u7684\uff0c\u4f46\u662f\u4e0a\u9762\u7684\u65b9\u5f0f\u5b83\u662f\u76f4\u63a5\u66f4\u65b0bean\u7684\u5c5e\u6027\u503c\uff0c\u5e76\u6ca1\u6709\u53bb\u66f4\u65b0PropertySource \u4f53\u7cfb\u4e2d\u7684\u503c\uff0c\u4e5f\u5c31\u662f\u8fd9\u65f6\u901a\u8fc7applicationContext.getEnvironment().getProperty(key)\u62ff\u5230\u7684\u8fd8\u662f\u65e7\u503c\uff08\u5df2\u9a8c\u8bc1\u786e\u8ba4\uff09</p> <p>\u4e0d\u8fc7springcloud\u63d0\u4f9b\u4e86ContextRefresher.refresh()\u65b9\u6cd5\uff0c\u91cc\u9762<code>this.context.publishEvent(new EnvironmentChangeEvent(this.context, keys));</code>\uff0cspring\u4f1a\u53bb\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e</p> <p>Apollo config\u5982\u4f55\u96c6\u6210\u5230Spring PropertySource \u4f53\u7cfb\u4e2d\uff1f</p> <p>ConfigPropertySource\u7ee7\u627f\u4e86EnumerablePropertySource\u63a5\u53e3\uff0c\u662f\u8fde\u63a5config\u548cPropertySource\u63a5\u53e3\u7684\u6865\u6881\uff08PropertySource\u63a5\u53e3\u5c31\u662f\u8981\u6c42\u5b9e\u73b0\u5176getProperty()\u83b7\u53d6\u5c5e\u6027\u65b9\u6cd5\u5373\u53ef\uff09\u3002</p> <p>\u4e00\u4e2aConfigPropertySource\u5bf9\u5e94\u4e00\u4e2aconfig\uff0cConfigPropertySourceFactory\u6ce8\u518c\u4e86\u6240\u6709\u7684ConfigPropertySource\u3002\u5728\u7cfb\u7edf\u521d\u59cb\u5316\u65f6\uff0cApolloApplicationContextInitializer\u548cPropertySourcesProcessor\u4f1a\u6839\u636eConfigPropertySourceFactory\u62ff\u5230\u6240\u6709\u7684ConfigPropertySource\uff0c\u7136\u540e\u6ce8\u518c\u5230Spring\u7684PropertySource \u91cc<code>environment.getPropertySources().addFirst(composite)</code>\u3002</p>"},{"location":"micro-services/apollo/#apollo_2","title":"\u4eceapollo\u6e90\u7801\u53ef\u4ee5\u5b66\u4e60\u501f\u9274\u4ec0\u4e48\uff1f","text":"<p>\u96c6\u6210Spring boot\uff0c\u5982\u4f55\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\uff0c\u548c@EnableApollo\uff0c\u5982\u4f55\u52a8\u6001\u6ce8\u518cBean\uff0c\u5982\u4f55\u4f7f\u7528BeanPostProcessor\uff0c\u5982\u4f55\u52a8\u6001\u4fee\u6539Bean\u7684\u5c5e\u6027\u503c\u3002</p>"},{"location":"micro-services/apollo/#spring","title":"Spring\u76f8\u5173","text":"<ul> <li>\u5982\u4f55\u5229\u7528\u6ce8\u89e3\u8d4b\u4e88\u5f53\u524d\u5b57\u6bb5\u503c</li> </ul> <pre><code>@Override\nprotected void processField(Object bean, String beanName, Field field) {\n    ApolloConfig annotation = AnnotationUtils.getAnnotation(field, ApolloConfig.class);\n    Preconditions.checkArgument(Config.class.isAssignableFrom(field.getType()),\n                                \"Invalid type: %s for field: %s, should be Config\", field.getType(), field);\n\n    // \u5c06\u81ea\u5b9a\u4e49\u6ce8\u89e3\u4e2d\u7684\u503c\u89e3\u6790\uff0c\u6ce8\u5165\u5bf9\u5e94\u5b57\u6bb5\n    String namespace = annotation.value();\n    Config config = ConfigService.getConfig(namespace);\n\n    // \u901a\u8fc7\u53cd\u5c04\u5de5\u5177\u5c06\u503c\u8d4b\u4e88\u5b57\u6bb5\n    ReflectionUtils.makeAccessible(field);\n    ReflectionUtils.setField(field, bean, config);\n}\n</code></pre> <ul> <li>\u5728\u65b9\u6cd5\u4e0a\u6dfb\u52a0\u7684\u6ce8\u89e3\uff0c\u76d1\u542c\u5230\u53d8\u66f4\u540e\u6267\u884c\u672c\u65b9\u6cd5\u3002\u7c7b\u4f3c@EventListener</li> </ul> <pre><code>// \u793a\u4f8b\n@ApolloConfigChangeListener\nprivate void onChange1(ConfigChangeEvent changeEvent) {\n    this.changeEvent1 = changeEvent;\n}\n\n@Override\nprotected void processMethod(final Object bean, String beanName, final Method method) {\n    ConfigChangeListener configChangeListener = new ConfigChangeListener() {\n      @Override\n      public void onChange(ConfigChangeEvent changeEvent) {\n        // \u4e5f\u5c31\u662f\u8bf4onChange\u65f6\u4f1a\u8c03\u7528method\n        ReflectionUtils.invokeMethod(method, bean, changeEvent);\n      }\n    }; \n}\n</code></pre>"},{"location":"micro-services/apollo/#_4","title":"\u8bbe\u8ba1\u6a21\u5f0f","text":"<ul> <li>\u89c2\u5bdf\u8005\u6a21\u5f0f</li> </ul> <p>\u4ee3\u7801\u4e2d\u4f7f\u7528\u5230\u4e86\u5927\u91cf\u7684\u89c2\u5bdf\u8005\u6a21\u5f0f\uff0c\u7528\u4ee5\u4ee3\u7801\u89e3\u8026\u3002ReleaseMessageScanner\u626b\u63cf\u5230releaseMessage\u53d8\u66f4\u540e\uff0c\u53d1\u51faevent\u3002DefaultConfig\u5728\u5224\u65adconfigChange\u540e\uff0c\u53d1\u51faevent\uff0c\u7b49\u7b49\u3002</p> <ul> <li> <p>\u6a21\u677f\u8bbe\u8ba1\u6a21\u5f0f     \u5982config\u63a5\u53e3\uff0c\u5728\u62bd\u8c61\u7c7bAbstractConfig\u5b9a\u4e49\u4e00\u4e9b\u901a\u7528\u7684\u65b9\u6cd5\uff0c\u4e2d\u95f4\u67d0\u4e9b\u5173\u952e\u7684\u5177\u4f53\u903b\u8f91\u4ea4\u7ed9\u5177\u4f53\u5b50\u7c7bDefaultConfig\u6765\u5b9e\u73b0</p> </li> <li> <p>\u5de5\u5382\u6a21\u5f0f</p> <p></p> </li> </ul>"},{"location":"micro-services/apollo/#_5","title":"\u7f16\u7801\u6280\u5de7","text":"<ul> <li>\u4f7f\u7528java\u5e95\u5c42\u7684http\u53d1\u51faHTTP\u8bf7\u6c42</li> <li>Spring\u7684DeferredResult,\u5b9e\u73b0\u5c06\u8bf7\u6c42\u6302\u8d77\uff0c\u5f02\u6b65\u8fd4\u56deresponse\u3002\u4e5f\u662f\u957f\u8f6e\u8be2\u5982\u4f55\u5b9e\u73b0\u7684\u4f8b\u5b50\uff01</li> </ul> <p>\u90e8\u95e8OSS ak\u4e4b\u524d\u4e00\u76f4\u662f\u660e\u6587\u914d\u7f6e\u5728apollo\u4e0a\uff0c\u7ba1\u7406\u4e0d\u89c4\u8303\uff0c\u4e00\u4e9b\u5f00\u53d1\u751a\u81f3\u6d4b\u8bd5\u53ef\u80fd\u4e0d\u5c0f\u5fc3\u9020\u6210\u6cc4\u6f0f\u3002\u6240\u4ee5\u9700\u8981\u5c06\u5176\u52a0\u5bc6\u7ba1\u7406\u8d77\u6765\uff0c\u5229\u7528jasypt\uff0c\u5c06\u5bc6\u6587ENC(\u5bc6\u6587)\u5199\u5728apollo\u91cc\uff0c\u5c06\u79d8\u94a5jasypt.encryptor.password\u5728\u7a0b\u5e8f\u521d\u59cb\u5316\u65f6\u6dfb\u52a0\u5230environment\u7684PropertySource\u4e2d\uff0c\u7b2c\u4e00\u4f4d\u3002\u8fd9\u6837\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\u5230\u660e\u6587\u4e86\u3002</p>"},{"location":"micro-services/apollo/#_6","title":"\u53c2\u8003\u8d44\u6599","text":"<p>Apollo\u6e90\u7801\u89e3\u6790-\u828b\u9053\u6e90\u7801</p>"},{"location":"micro-services/feign/","title":"Feign","text":"<p>feign\u662f\u58f0\u660e\u5f0f\u7684web\u5ba2\u6237\u7aef\uff0c\u4f7f\u7528\u8d77\u6765\u5f88\u65b9\u4fbf\uff0c\u7c7b\u4f3c\u4e8e Retrofit\u3002Spring Cloud OpenFeign\u662fspringboot\u901a\u8fc7\u81ea\u52a8\u914d\u7f6e\u96c6\u6210\u4e86openFeign\uff0c\u5e76\u589e\u52a0\u4e86springMVC\u7684\u6ce8\u89e3\u652f\u6301\uff0c\u4f7f\u7528\u4e86\u540c\u6837\u7684<code>HttpMessageConverters</code> \uff0c\u540c\u65f6\u548cribbon/spring cloud loadBalance\uff0c0000000000.\u9645\u4f1a\u751f\u6210\u4e00\u4e2a\u7684load-balanced http client\u3002</p> <p>spring cloud openFeign\u7684\u5b98\u65b9\u6587\u6863\u8bf4\u660e</p> <p>\u56e0\u4e3aSpring Cloud Netflix Ribbon\u5904\u4e8e\u7ef4\u62a4\u9636\u6bb5\uff0c\u6240\u4ee5\u5efa\u8bae\u4f7f\u7528springcloud loadbalance\u4ee3\u66ff\uff0c\u53ea\u9700\u8981\u8bbe\u7f6espring.cloud.loadbalancer.ribbon.enabled=false\u3002\u5b9e\u9645\u4e24\u4e2a\u90fd\u652f\u6301</p> <p>\u5982\u679c\u6574\u5408\u4e86Eureka\u7b49\u6ce8\u518c\u4e2d\u5fc3\u540e\uff0c\u4f1a\u81ea\u52a8\u6839\u636ename\u5c5e\u6027\u53bb\u6ce8\u518c\u4e2d\u5fc3\u67e5\u627e\u670d\u52a1\u5b9e\u4f8b\u4fe1\u606f\uff0c\u5982\u679c\u4e0d\u60f3\u4f7f\u7528\u53ef\u4ee5\u901a\u8fc7<code>SimpleDiscoveryClient</code>\u914d\u7f6e\u3002</p> <pre><code>/**\n * Annotation for interfaces declaring that a REST client with that interface should be\n * created (e.g. for autowiring into another component). If ribbon is available it will be\n * used to load balance the backend requests, and the load balancer can be configured\n * using a &lt;code&gt;@RibbonClient&lt;/code&gt; with the same name (i.e. value) as the feign client.\n */\npublic @interface FeignClient {\n\n    /**\n     * The name of the service with optional protocol prefix. \u548cname\u76f8\u540c\u4f5c\u7528.\n     * \u65e0\u8bbaurl\u662f\u5426\u6307\u5b9a\uff0c\u5fc5\u987b\u914d\u7f6ename\n     * \u53ef\u4ee5\u4f7f\u7528placeHolder\u7684\u5f62\u5f0f\uff0c\u5982${propertyKey}.\n     */\n    @AliasFor(\"name\")\n    String value() default \"\";\n\n    /**\n     * The service id with optional protocol prefix. Synonym for {@link #value() value}.\n     *\n     * @deprecated use {@link #name() name} instead\n     */\n    @Deprecated\n    String serviceId() default \"\";\n\n    /**\n     * The service id with optional protocol prefix. Synonym for {@link #value() value}.\n     */\n    @AliasFor(\"value\")\n    String name() default \"\";\n\n    /**\n     * Sets the &lt;code&gt;@Qualifier&lt;/code&gt; value for the feign client.\n     * \u8bbe\u7f6e\u5f53\u524dclient bean\u7684\u540d\u5b57\n     */\n    String qualifier() default \"\";\n\n    /**\n     * An absolute URL or resolvable hostname (the protocol is optional).\n     * \u7edd\u5bf9URL\u6216\u4e3b\u673a\u5730\u5740\uff0c\u53ef\u7528\u4e8e\u672c\u673a\u8054\u8c03\u65f6\u6682\u65f6\u4f7f\u7528\uff0c\n     * \u53ef\u4ee5\u4f7f\u7528placeHolder\u7684\u5f62\u5f0f\uff0c\u5982${propertyKey}.\n     */\n    String url() default \"\";\n\n    /**\n     * Whether 404s should be decoded instead of throwing FeignExceptions\n     */\n    boolean decode404() default false;\n\n    /**\n     * A custom &lt;code&gt;@Configuration&lt;/code&gt; for the feign client. Can contain override\n     * &lt;code&gt;@Bean&lt;/code&gt; definition for the pieces that make up the client, for instance\n     * {@link feign.codec.Decoder}, {@link feign.codec.Encoder}, {@link feign.Contract}.\n     * \u53ef\u4ee5\u4e3a\u5f53\u524dFeignClient\u81ea\u5b9a\u4e49Configuration\uff0c\u4f1a\u8986\u76d6FeignClientsConfiguration\u7684\u9ed8\u8ba4\u7684Decoder\uff0cEncoder\uff0cContract\n     * \u6ce8\u610f\u81ea\u5b9a\u4e49\u7684\u914d\u7f6e\u4e0d\u9700\u8981\u6dfb\u52a0@Component\uff0c\u5426\u5219\u4f1a\u5728\u6240\u6709FeignClient\u7684\u751f\u6548\n     * @see FeignClientsConfiguration for the defaults\n     */\n    Class&lt;?&gt;[] configuration() default {};\n\n    /**\n     * Fallback class for the specified Feign client interface. The fallback class must\n     * implement the interface annotated by this annotation and be a valid spring bean.\n     */\n    Class&lt;?&gt; fallback() default void.class;\n\n    /**\n     * Define a fallback factory for the specified Feign client interface. The fallback\n     * factory must produce instances of fallback classes that implement the interface\n     * annotated by {@link FeignClient}. The fallback factory must be a valid spring\n     * bean.\n     *\n     * @see feign.hystrix.FallbackFactory for details.\n     */\n    Class&lt;?&gt; fallbackFactory() default void.class;\n\n    /**\n     * \u6240\u6709\u65b9\u6cd5\u4e0a\u7684\u7edf\u4e00\u8def\u5f84\u524d\u7f00\n     */\n    String path() default \"\";\n\n    /**\n     * Whether to mark the feign proxy as a primary bean. Defaults to true.\n     */\n    boolean primary() default true;\n\n}\n</code></pre>"},{"location":"micro-services/feign/#feignclientsconfigurationfeign","title":"<code>FeignClientsConfiguration\uff0cFeign\u7684\u76f8\u5173\u914d\u7f6e</code>","text":"<p>\u9ed8\u8ba4\u63d0\u4f9b\u7684bean\u6709 DeCoder\uff0cEncoder\uff0cLogger\uff0cContract\uff0cFeign.Builder\uff0cClient</p> <p>\u6ca1\u6709\u9ed8\u8ba4\u63d0\u4f9b\uff0c\u4f46\u53ea\u8981\u63d0\u4f9b\u4e86\u4f1a\u81ea\u52a8\u52a0\u8f7d\u7684\u6709Logger.Level\uff0cRetryer\uff0cErrorDecoder Request.Options QueryMapEncoder  SetterFactory  Collection <p>\u4e3a\u5355\u72ec\u7684FeignClient\u4e2d\u6dfb\u52a0\u4e0b\u9762\u914d\u7f6e\uff0c\u5c06\u4f1a\u8986\u76d6\u9ed8\u8ba4\u7684bean\u3002\u4e5f\u53ef\u4ee5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\uff08\u4f18\u5148\uff09\u3002</p> <p>\u6dfb\u52a0@Configuration\u4f5c\u7528\u4e8e\u6240\u6709\u7684FeignClient</p> <pre><code>// @Configuration \u6dfb\u52a0\u540e\u6240\u6709\u7684FeignClient\u751f\u6548\npublic class FooConfiguration {\n    @Bean\n    public Contract feignContract() {\n        return new feign.Contract.Default();\n    }\n\n    @Bean\n    public BasicAuthRequestInterceptor basicAuthRequestInterceptor() {\n        return new BasicAuthRequestInterceptor(\"user\", \"password\");\n    }\n}\n</code></pre> <ul> <li>Contract\u89c4\u5b9a\u65b9\u6cd5\u4e0a\u54ea\u4e9b\u6ce8\u89e3\u662fvalid\u7684\uff0cspringcloud\u9ed8\u8ba4\u7684contract\u652f\u6301springmvc\u7684\u6ce8\u89e3\u800c\u4e0d\u662f\u539f\u751f\u7684Feign\u6ce8\u89e3\u3002</li> <li>\u901a\u8fc7feign.okhttp.enabled\u548cfeign.httpclient.enabled\u53ef\u4ee5\u63a7\u5236\u4f7f\u7528OkHttpClient \u8fd8\u662f ApacheHttpClient</li> <li> <p>Retry bean\u7684\u7c7b\u578b\u4e3aNEVER_RETRY\u65f6\uff0c\u5c06\u4e0d\u4f1a\u91cd\u8bd5\u3002\u9ed8\u8ba4\u7684\u4f1a\u5728IOException\uff0c\u6216\u8005DeCoder\u629b\u51fa\u53ef\u91cd\u8bd5\u7684\u5f02\u5e38\u65f6\u4f1a\u91cd\u8bd5</p> </li> <li> <p>\u6dfb\u52a0Hystrix\u7684\u4f9d\u8d56\uff0c\u5e76\u4e14\u914d\u7f6e<code>feign.hystrix.enabled=true</code>\uff0c\u4f1a\u5728\u6240\u6709\u7684\u65b9\u6cd5\u8bf7\u6c42\u65f6\uff0c\u5305\u88c5\u4e00\u4e2a\u5faa\u73af\u7684breaker\u3002</p> </li> <li> <p>\u5b9e\u9645\u5f00\u53d1\u4e2d\u57fa\u672c\u8981\u6307\u5b9afallback \uff0c\u5982\u679c\u60f3\u8981\u83b7\u5f97\u5f02\u5e38\u7684\u539f\u56e0\uff0c\u53ef\u4ee5\u4f7f\u7528<code>fallbackFactory</code> \u3002\u8fd9\u6837\u770b\u80af\u5b9a<code>fallbackFactory</code> \u5408\u9002\u70b9\uff0c\u53ef\u4ee5\u6253\u5370\u4e0b\u5f02\u5e38</p> </li> <li> <p>\u53ef\u4ee5\u4e3aRequest\u548cresponse\u5f00\u542f\u538b\u7f29\uff0c</p> </li> </ul> <p>feign.compression.request.enabled=true</p> <p>feign.compression.response.enabled=true</p> <p>feign.compression.request.mime-types=text/xml,application/xml,application/json                 feign.compression.request.min-request-size=2048</p> <ul> <li>\u9ed8\u8ba4\u5c06\u4f1a\u4f7f\u7528FeignClient\u7684\u63a5\u53e3\u521b\u5efa\u4e00\u4e2aLogger\uff0cFeign\u53ea\u54cd\u5e94Debug\u7ea7\u522b\u7684\u65e5\u5fd7\u3002</li> </ul> <p>Logger.Level\u6709</p> <p>NONE\uff0c\u9ed8\u8ba4\uff0c\u4e0d\u6253\u5370</p> <p>BASIC \u53ea\u6253\u5370request method and URL and the response status code and execution time</p> <p>HEADERS \u5728BASIC\u57fa\u7840\u4e0a\u518d\u6253\u5370request\u548cresponse\u7684\u7684header</p> <p>FULL \u4e3a\u6240\u6709\u7684request\u548cresponse\u6253\u5370headers, body, and metadata</p> <p>\u901a\u8fc7\u4e0b\u5217\u65b9\u5f0f\u5c06\u4e3a\u5355\u72ec\u7684FeignClient\u6307\u5b9a\u65e5\u5fd7\u7ea7\u522b\u3002</p> <pre><code>@Configuration\npublic class FooConfiguration {\n    @Bean\n    Logger.Level feignLoggerLevel() {\n        return Logger.Level.FULL;\n    }\n}\n</code></pre> <ul> <li>\u4f7f\u7528@SpringQueryMap Params params\u53ef\u4ee5\u7528\u4e00\u4e2apojo\u6765\u5c01\u88c5\u591a\u4e2a\u67e5\u8be2\u53c2\u6570</li> </ul>"},{"location":"micro-services/rocketMQ/","title":"\u57fa\u7840\u6982\u5ff5","text":""},{"location":"micro-services/rocketMQ/#_2","title":"\u53d1\u9001\u6d88\u606f","text":"<p>\u540c\u6b65\u53d1\u9001\uff1a\u53ea\u8981\u4e0d\u629b\u5f02\u5e38\u5c31\u662f\u6210\u529f</p> <p>\u5f02\u6b65\u53d1\u9001\uff1a</p> <p>\u5355\u5411\u53d1\u9001\uff1a\u53ea\u53d1\u9001\u8bf7\u6c42\u4e0d\u7b49\u5f85\u5e94\u7b54\uff0c\u4e0d\u4f1a\u8fdb\u884c\u91cd\u8bd5\u3002\u5f88\u5feb\uff08\u5c06\u6570\u636e\u5199\u5165\u5ba2\u6237\u7aef\u7684socket\u7f13\u51b2\u533a\u5373\u53ef\uff0c\u6b64\u8fc7\u7a0b\u8017\u65f6\u901a\u5e38\u5728\u5fae\u79d2\u7ea7\uff09\uff0c\u9002\u5408\u65e5\u5fd7\u6536\u96c6\u53ef\u9760\u6027\u4e0d\u9ad8\u7684\u573a\u666f\u3002</p> <p>producer\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a\u7ebf\u7a0b\u91cc\u8fdb\u884c\u53d1\u9001\u3002\u6d88\u606f\u53d1\u9001\u6210\u529f\u6216\u8005\u5931\u8d25\u8981\u6253\u5370\u6d88\u606f\u65e5\u5fd7\uff0c\u52a1\u5fc5\u8981\u6253\u5370SendResult\u548ckey\u5b57\u6bb5</p>"},{"location":"micro-services/rocketMQ/#_3","title":"\u6d88\u8d39\u6d88\u606f","text":"<ul> <li>\u96c6\u7fa4\u8ba2\u9605</li> </ul> <p>\u540c\u4e00\u4e2aGroup ID\u6240\u6807\u8bc6\u7684\u6240\u6709Consumer\u4e3a\u4e00\u4e2a\u96c6\u7fa4\uff0c\u4ed6\u4eec\u5e73\u5747\u5206\u644a\u6d88\u8d39\u6d88\u606f\u3002\u8fd9\u4e9b\u6d88\u8d39\u8005\u5b9e\u4f8b\u7684\u8ba2\u9605\u5173\u7cfb\u5fc5\u987b\u5b8c\u5168\u4e00\u81f4\uff1a</p> <ul> <li>\u8ba2\u9605\u7684Topic\u5fc5\u987b\u4e00\u81f4</li> <li> <p>\u8ba2\u9605\u7684Topic\u4e2d\u7684Tag\u5fc5\u987b\u4e00\u81f4\uff08\u5305\u62ecTag\u7684\u6570\u91cf\u548cTag\u7684\u987a\u5e8f\uff09</p> </li> <li> <p>\u5e7f\u64ad\u8ba2\u9605</p> </li> </ul> <p>\u540c\u4e00\u4e2aGroup ID\u6240\u6807\u8bc6\u7684\u6240\u6709Consumer\u90fd\u4f1a\u5404\u81ea\u6d88\u8d39\u67d0\u6761\u6d88\u606f\u4e00\u6b21</p> <p>\u5ba2\u6237\u7aef\u6d88\u8d39\u539f\u7406</p> <p>rocketMQ\u662f\u91c7\u7528\u6d88\u606f\u961f\u5217\u63a8\u9001push\u81f3consumer\u7684\u65b9\u5f0f\u3002\u6536\u8d39\u7248\u8fd8\u63d0\u4f9b\u4e86pull\u7684\u65b9\u5f0f\uff0c\u5373\u7531Consumer\u4e3b\u52a8\u4ece\u6d88\u606f\u961f\u5217RocketMQ\u7248\u62c9\u53d6\u6d88\u606f\uff0c\u8fd9\u6837\u53ef\u4ee5\u66f4\u52a0\u81ea\u7531\u5730\u63a7\u5236\u6d88\u606f\u62c9\u53d6\u3002</p> <p></p> <ol> <li> <p>SDK\u5ba2\u6237\u7aef\u901a\u8fc7\u957f\u8f6e\u8be2\u6279\u91cf\u62c9\u53d6\u7684\u65b9\u5f0f\u4ece\u6d88\u606f\u961f\u5217RocketMQ\u7248\u670d\u52a1\u7aef\u83b7\u53d6\u6d88\u606f\uff0c\u5c06\u62c9\u53d6\u5230\u7684\u6d88\u606f\u7f13\u5b58\u5230\u672c\u5730\u7f13\u51b2\u961f\u5217\u4e2d\u3002</p> </li> <li> <p>SDK\u5ba2\u6237\u7aef\u5c06\u672c\u5730\u7f13\u5b58\u7684\u6d88\u606f\u63d0\u4ea4\u5230\u6d88\u8d39\u7ebf\u7a0b\u4e2d\uff0c\u4f7f\u7528\u4e1a\u52a1\u6d88\u8d39\u903b\u8f91\u8fdb\u884c\u5904\u7406\u3002</p> </li> </ol>"},{"location":"micro-services/rocketMQ/#_4","title":"\u6d88\u606f\u7684\u7c7b\u578b","text":""},{"location":"micro-services/rocketMQ/#1","title":"1. \u987a\u5e8f\u6d88\u606f","text":"<p>\u200b   \u5168\u5c40\u987a\u5e8f\uff1a\u5bf9\u4e8e\u6307\u5b9a\u7684\u4e00\u4e2aTopic\uff0c\u6240\u6709\u6d88\u606f\u6309\u7167\u4e25\u683c\u7684\u5148\u5165\u5148\u51faFIFO\uff08First In First Out\uff09\u7684\u987a\u5e8f\u8fdb\u884c\u53d1\u5e03\u548c\u6d88\u8d39</p> <p>\u200b   \u5206\u533a\u987a\u5e8f\uff1a\u5bf9\u4e8e\u6307\u5b9a\u7684\u4e00\u4e2aTopic\uff0c\u6240\u6709\u6d88\u606f\u6839\u636eSharding Key\u8fdb\u884c\u5206\u533a\u3002\u540c\u4e00\u4e2a\u5206\u533a\u5185\u7684\u6d88\u606f\u6309\u7167\u4e25\u683c\u7684FIFO\u987a\u5e8f\u8fdb\u884c\u53d1\u5e03\u548c\u6d88\u8d39\u3002\u76f8\u6bd4\u5168\u5c40\u987a\u5e8f\u6d88\u606f\uff0c\u6027\u80fd\u9ad8\u5f88\u591a\u3002</p> <p>\u539f\u7406\u89e3\u6790\uff1a</p> <p>\u5728\u9ed8\u8ba4\u7684\u60c5\u51b5\u4e0b\u6d88\u606f\u53d1\u9001\u4f1a\u91c7\u53d6Round Robin\u8f6e\u8be2\u65b9\u5f0f\u628a\u6d88\u606f\u53d1\u9001\u5230\u4e0d\u540c\u7684queue(\u5206\u533a\u961f\u5217)\uff1b\u800c\u6d88\u8d39\u6d88\u606f\u7684\u65f6\u5019\u4ece\u591a\u4e2aqueue\u4e0a\u62c9\u53d6\u6d88\u606f\uff0c\u8fd9\u79cd\u60c5\u51b5\u53d1\u9001\u548c\u6d88\u8d39\u662f\u4e0d\u80fd\u4fdd\u8bc1\u987a\u5e8f\u3002\u4f46\u662f\u5982\u679c\u63a7\u5236\u53d1\u9001\u7684\u987a\u5e8f\u6d88\u606f\u53ea\u4f9d\u6b21\u53d1\u9001\u5230\u540c\u4e00\u4e2aqueue\u4e2d\uff0c\u6d88\u8d39\u7684\u65f6\u5019\u53ea\u4ece\u8fd9\u4e2aqueue\u4e0a\u4f9d\u6b21\u62c9\u53d6\uff0c\u5219\u5c31\u4fdd\u8bc1\u4e86\u987a\u5e8f\u3002\u5f53\u53d1\u9001\u548c\u6d88\u8d39\u53c2\u4e0e\u7684queue\u53ea\u6709\u4e00\u4e2a\uff0c\u5219\u662f\u5168\u5c40\u6709\u5e8f\uff1b\u5982\u679c\u591a\u4e2aqueue\u53c2\u4e0e\uff0c\u5219\u4e3a\u5206\u533a\u6709\u5e8f\uff0c\u5373\u76f8\u5bf9\u6bcf\u4e2aqueue\uff0c\u6d88\u606f\u90fd\u662f\u6709\u5e8f\u7684\u3002</p> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <ul> <li> <p>\u7528\u6237\u6ce8\u518c\u9700\u8981\u53d1\u9001\u53d1\u9a8c\u8bc1\u7801\uff0c\u4ee5\u7528\u6237ID\u4f5c\u4e3aSharding Key\uff0c\u90a3\u4e48\u540c\u4e00\u4e2a\u7528\u6237\u53d1\u9001\u7684\u6d88\u606f\u90fd\u4f1a\u6309\u7167\u53d1\u5e03\u7684\u5148\u540e\u987a\u5e8f\u6765\u6d88\u8d39</p> </li> <li> <p>\u7535\u5546\u7684\u8ba2\u5355\u521b\u5efa\uff0c\u4ee5\u8ba2\u5355ID\u4f5c\u4e3aSharding Key\uff0c\u90a3\u4e48\u540c\u4e00\u4e2a\u8ba2\u5355\u76f8\u5173\u7684\u521b\u5efa\u8ba2\u5355\u6d88\u606f\u3001\u8ba2\u5355\u652f\u4ed8\u6d88\u606f\u3001\u8ba2\u5355\u9000\u6b3e\u6d88\u606f\u3001\u8ba2\u5355\u7269\u6d41\u6d88\u606f\u90fd\u4f1a\u6309\u7167\u53d1\u5e03\u7684\u5148\u540e\u987a\u5e8f\u6765\u6d88\u8d39\u3002 \u963f\u91cc\u5df4\u5df4\u96c6\u56e2\u5185\u90e8\u7535\u5546\u7cfb\u7edf\u5747\u4f7f\u7528\u5206\u533a\u987a\u5e8f\u6d88\u606f\uff0c\u65e2\u4fdd\u8bc1\u4e1a\u52a1\u7684\u987a\u5e8f\uff0c\u540c\u65f6\u53c8\u80fd\u4fdd\u8bc1\u4e1a\u52a1\u7684\u9ad8\u6027\u80fd</p> </li> </ul> <p>\u5e38\u89c1\u95ee\u9898\uff1a</p> <ul> <li> <p>\u5efa\u8bae\u540c\u4e00\u4e2aGroup ID\u53ea\u5bf9\u5e94\u4e00\u79cd\u7c7b\u578b\u7684Topic\uff0c\u5373\u4e0d\u540c\u65f6\u7528\u4e8e\u987a\u5e8f\u6d88\u606f\u548c\u65e0\u5e8f\u6d88\u606f\u7684\u6536\u53d1\u3002</p> </li> <li> <p>\u5bf9\u4e8e\u5168\u5c40\u987a\u5e8f\u6d88\u606f\uff0c\u5efa\u8bae\u6d88\u606f\u4e0d\u8981\u6709\u963b\u585e\u3002\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u5b9e\u4f8b\uff0c\u662f\u4e3a\u4e86\u9632\u6b62\u5de5\u4f5c\u5b9e\u4f8b\u610f\u5916\u9000\u51fa\u800c\u5bfc\u81f4\u4e1a\u52a1\u4e2d\u65ad\u3002\u5f53\u5de5\u4f5c\u5b9e\u4f8b\u9000\u51fa\u65f6\uff0c\u5176\u4ed6\u5b9e\u4f8b\u53ef\u4ee5\u7acb\u5373\u63a5\u624b\u5de5\u4f5c\uff0c\u4e0d\u4f1a\u5bfc\u81f4\u4e1a\u52a1\u4e2d\u65ad\uff0c\u5b9e\u9645\u5de5\u4f5c\u7684\u53ea\u4f1a\u6709\u4e00\u4e2a\u5b9e\u4f8b\u3002</p> </li> <li> <p>\u540c\u4e00\u6761\u6d88\u606f\u662f\u5426\u53ef\u4ee5\u65e2\u662f\u987a\u5e8f\u6d88\u606f\uff0c\u53c8\u662f\u5b9a\u65f6\u6d88\u606f\u548c\u4e8b\u52a1\u6d88\u606f\uff1f</p> </li> </ul> <p>\u4e0d\u53ef\u4ee5\u3002\u987a\u5e8f\u6d88\u606f\u3001\u5b9a\u65f6\u6d88\u606f\u3001\u4e8b\u52a1\u6d88\u606f\u662f\u4e0d\u540c\u7684\u6d88\u606f\u7c7b\u578b\uff0c\u4e09\u8005\u662f\u4e92\u65a5\u5173\u7cfb\uff0c\u4e0d\u80fd\u53e0\u52a0\u5728\u4e00\u8d77\u4f7f\u7528\u3002</p> <ul> <li>\u4e3a\u4ec0\u4e48\u5168\u5c40\u987a\u5e8f\u6d88\u606f\u6027\u80fd\u4e00\u822c\uff1f</li> </ul> <p>\u5168\u5c40\u987a\u5e8f\u6d88\u606f\u662f\u4e25\u683c\u6309\u7167FIFO\u7684\u6d88\u606f\u963b\u585e\u539f\u5219\uff0c\u5373\u4e0a\u4e00\u6761\u6d88\u606f\u6ca1\u6709\u88ab\u6210\u529f\u6d88\u8d39\uff0c\u90a3\u4e48\u4e0b\u4e00\u6761\u6d88\u606f\u4f1a\u4e00\u76f4\u88ab\u5b58\u50a8\u5230Topic\u961f\u5217\u4e2d\u3002\u5982\u679c\u60f3\u63d0\u9ad8\u5168\u5c40\u987a\u5e8f\u6d88\u606f\u7684TPS\uff0c\u53ef\u4ee5\u5347\u7ea7\u5b9e\u4f8b\u914d\u7f6e\uff0c\u540c\u65f6\u6d88\u606f\u5ba2\u6237\u7aef\u5e94\u7528\u5c3d\u91cf\u51cf\u5c11\u5904\u7406\u672c\u5730\u4e1a\u52a1\u903b\u8f91\u7684\u8017\u65f6\u3002</p> <ul> <li>\u987a\u5e8f\u6d88\u606f\u652f\u6301\u54ea\u79cd\u6d88\u606f\u53d1\u9001\u65b9\u5f0f\uff1f</li> </ul> <p>\u987a\u5e8f\u6d88\u606f\u53ea\u652f\u6301\u53ef\u9760\u540c\u6b65\u53d1\u9001\u65b9\u5f0f\uff0c\u4e0d\u652f\u6301\u5f02\u6b65\u53d1\u9001\u65b9\u5f0f\uff0c\u5426\u5219\u5c06\u65e0\u6cd5\u4e25\u683c\u4fdd\u8bc1\u987a\u5e8f\u3002</p> <ul> <li>\u987a\u5e8f\u6d88\u606f\u662f\u5426\u652f\u6301\u96c6\u7fa4\u6d88\u8d39\u548c\u5e7f\u64ad\u6d88\u8d39\uff1f</li> </ul> <p>\u987a\u5e8f\u6d88\u606f\u6682\u65f6\u4ec5\u652f\u6301\u96c6\u7fa4\u6d88\u8d39\u6a21\u5f0f\uff0c\u4e0d\u652f\u6301\u5e7f\u64ad\u6d88\u8d39\u6a21\u5f0f\u3002</p>"},{"location":"micro-services/rocketMQ/#2","title":"2. \u4e8b\u52a1\u6d88\u606f","text":"<p>\u4ea4\u4e92\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <p></p> <p>\u4e8b\u52a1\u6d88\u606f\u53d1\u9001\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>\u53d1\u9001\u65b9\u5c06\u534a\u4e8b\u52a1\u6d88\u606f\u53d1\u9001\u81f3\u6d88\u606f\u961f\u5217RocketMQ\u7248\u670d\u52a1\u7aef\u3002</li> <li>\u6d88\u606f\u961f\u5217RocketMQ\u7248\u670d\u52a1\u7aef\u5c06\u6d88\u606f\u6301\u4e45\u5316\u6210\u529f\u4e4b\u540e\uff0c\u5411\u53d1\u9001\u65b9\u8fd4\u56deAck\u786e\u8ba4\u6d88\u606f\u5df2\u7ecf\u53d1\u9001\u6210\u529f\uff0c\u6b64\u65f6\u6d88\u606f\u4e3a\u534a\u4e8b\u52a1\u6d88\u606f\u3002</li> <li>\u53d1\u9001\u65b9\u5f00\u59cb\u6267\u884c\u672c\u5730\u4e8b\u52a1\u903b\u8f91\u3002</li> <li>\u53d1\u9001\u65b9\u6839\u636e\u672c\u5730\u4e8b\u52a1\u6267\u884c\u7ed3\u679c\u5411\u670d\u52a1\u7aef\u63d0\u4ea4\u4e8c\u6b21\u786e\u8ba4\uff08Commit\u6216\u662fRollback\uff09\uff0c\u670d\u52a1\u7aef\u6536\u5230Commit\u72b6\u6001\u5219\u5c06\u534a\u4e8b\u52a1\u6d88\u606f\u6807\u8bb0\u4e3a\u53ef\u6295\u9012\uff0c\u8ba2\u9605\u65b9\u6700\u7ec8\u5c06\u6536\u5230\u8be5\u6d88\u606f\uff1b\u670d\u52a1\u7aef\u6536\u5230Rollback\u72b6\u6001\u5219\u5220\u9664\u534a\u4e8b\u52a1\u6d88\u606f\uff0c\u8ba2\u9605\u65b9\u5c06\u4e0d\u4f1a\u63a5\u53d7\u8be5\u6d88\u606f\u3002</li> </ol> <p>\u4e8b\u52a1\u6d88\u606f\u56de\u67e5\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>\u5728\u65ad\u7f51\u6216\u8005\u662f\u5e94\u7528\u91cd\u542f\u7684\u7279\u6b8a\u60c5\u51b5\u4e0b\uff0c\u4e0a\u8ff0\u6b65\u9aa44\u63d0\u4ea4\u7684\u4e8c\u6b21\u786e\u8ba4\u6700\u7ec8\u672a\u5230\u8fbe\u670d\u52a1\u7aef\uff0c\u7ecf\u8fc7\u56fa\u5b9a\u65f6\u95f4\u540e\u670d\u52a1\u7aef\u5c06\u5bf9\u8be5\u6d88\u606f\u53d1\u8d77\u6d88\u606f\u56de\u67e5\u3002</li> <li>\u53d1\u9001\u65b9\u6536\u5230\u6d88\u606f\u56de\u67e5\u540e\uff0c\u9700\u8981\u68c0\u67e5\u5bf9\u5e94\u6d88\u606f\u7684\u672c\u5730\u4e8b\u52a1\u6267\u884c\u7684\u6700\u7ec8\u7ed3\u679c\u3002</li> <li>\u53d1\u9001\u65b9\u6839\u636e\u68c0\u67e5\u5f97\u5230\u7684\u672c\u5730\u4e8b\u52a1\u7684\u6700\u7ec8\u72b6\u6001\u518d\u6b21\u63d0\u4ea4\u4e8c\u6b21\u786e\u8ba4\uff0c\u670d\u52a1\u7aef\u4ecd\u6309\u7167\u6b65\u9aa44\u5bf9\u534a\u4e8b\u52a1\u6d88\u606f\u8fdb\u884c\u64cd\u4f5c\u3002</li> </ol>"},{"location":"micro-services/rocketMQ/#3","title":"3. \u5ef6\u65f6\u6d88\u606f\u548c\u5b9a\u65f6\u6d88\u606f","text":"<p>\u670d\u52a1\u7aef\u5728\u6307\u5b9a\u65f6\u95f4\u8fdb\u884c\u6295\u9012\u6d88\u606f</p> <ul> <li> <p>\u6307\u5b9a\u65f6\u95f4\u6700\u957f\u652f\u630140\u5929\uff0c\u8d85\u8fc740\u5929\u6d88\u606f\u53d1\u9001\u5c06\u5931\u8d25\u3002</p> </li> <li> <p><code>StartDeliverTime</code>\u662f\u670d\u52a1\u7aef\u5f00\u59cb\u5411\u6d88\u8d39\u7aef\u6295\u9012\u7684\u65f6\u95f4\u3002\u5982\u679c\u6d88\u8d39\u8005\u5f53\u524d\u6709\u6d88\u606f\u5806\u79ef\uff0c\u90a3\u4e48\u5b9a\u65f6\u548c\u5ef6\u65f6\u6d88\u606f\u4f1a\u6392\u5728\u5806\u79ef\u6d88\u606f\u540e\u9762\uff0c\u5c06\u4e0d\u80fd\u4e25\u683c\u6309\u7167\u914d\u7f6e\u7684\u65f6\u95f4\u8fdb\u884c\u6295\u9012\u3002</p> </li> <li> <p>\u7531\u4e8e\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u53ef\u80fd\u5b58\u5728\u65f6\u95f4\u5dee\uff0c\u6d88\u606f\u7684\u5b9e\u9645\u6295\u9012\u65f6\u95f4\u4e0e\u5ba2\u6237\u7aef\u8bbe\u7f6e\u7684\u6295\u9012\u65f6\u95f4\u4e4b\u95f4\u53ef\u80fd\u5b58\u5728\u504f\u5dee\u3002</p> </li> <li> <p>\u8bbe\u7f6e\u5b9a\u65f6\u548c\u5ef6\u65f6\u6d88\u606f\u7684\u6295\u9012\u65f6\u95f4\u540e\uff0c\u4f9d\u7136\u53d73\u5929\u7684\u6d88\u606f\u4fdd\u5b58\u65f6\u957f\u9650\u5236\u3002</p> </li> </ul> <p>\u4f8b\u5982\uff0c\u8bbe\u7f6e\u5b9a\u65f6\u6d88\u606f5\u5929\u540e\u624d\u80fd\u88ab\u6d88\u8d39\uff0c\u5982\u679c\u7b2c5\u5929\u540e\u4e00\u76f4\u6ca1\u88ab\u6d88\u8d39\uff0c\u90a3\u4e48\u8fd9\u6761\u6d88\u606f\u5c06\u5728\u7b2c8\u5929\u88ab\u5220\u9664\u3002</p> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <p>zm\u7528\u5728\u672a\u586b\u5199\u62a5\u544a\uff0c\u8bbe\u7f6e24h\u540e\u81ea\u5df1\u53d1\u7ed9\u81ea\u5df1\u89e6\u53d1\u81ea\u52a8\u751f\u6210\u62a5\u544a\u3002</p> <p>\u7535\u5546\u4ea4\u6613\u4e2d\u8d85\u65f6\u672a\u652f\u4ed8\u5173\u95ed\u8ba2\u5355\u7684\u573a\u666f\uff0c\u598230\u5206\u949f\u6295\u9012\u6d88\u606f\uff0c\u6d88\u8d39\u8005\u5224\u65ad\u662f\u5426\u652f\u4ed8\u3002</p> <p>\u67d0\u4e00\u56fa\u5b9a\u65f6\u95f4\u70b9\u5411\u5ba2\u6237\u53d1\u9001\u63d0\u9192\u6d88\u606f\u3002</p>"},{"location":"micro-services/rocketMQ/#rocketmq","title":"rocketMQ\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u524a\u5cf0\u586b\u8c37</li> </ul> <p>\u8bf8\u5982\u79d2\u6740\u3001\u62a2\u7ea2\u5305\u3001\u4f01\u4e1a\u5f00\u95e8\u7ea2\u7b49\u5927\u578b\u6d3b\u52a8\u65f6\u7686\u4f1a\u5e26\u6765\u8f83\u9ad8\u7684\u6d41\u91cf\u8109\u51b2\uff0c\u6216\u56e0\u6ca1\u505a\u76f8\u5e94\u7684\u4fdd\u62a4\u800c\u5bfc\u81f4\u7cfb\u7edf\u8d85\u8d1f\u8377\u751a\u81f3\u5d29\u6e83\uff0c\u6216\u56e0\u9650\u5236\u592a\u8fc7\u5bfc\u81f4\u8bf7\u6c42\u5927\u91cf\u5931\u8d25\u800c\u5f71\u54cd\u7528\u6237\u4f53\u9a8c\uff0c\u6d88\u606f\u961f\u5217RocketMQ\u7248\u53ef\u63d0\u4f9b\u524a\u5cf0\u586b\u8c37\u7684\u670d\u52a1\u6765\u89e3\u51b3\u8be5\u95ee\u9898\u3002</p> <ul> <li>\u5f02\u6b65\u89e3\u8026</li> </ul> <p>\u4ea4\u6613\u7cfb\u7edf\u4f5c\u4e3a\u6dd8\u5b9d\u548c\u5929\u732b\u4e3b\u7ad9\u6700\u6838\u5fc3\u7684\u7cfb\u7edf\uff0c\u6bcf\u7b14\u4ea4\u6613\u8ba2\u5355\u6570\u636e\u7684\u4ea7\u751f\u4f1a\u5f15\u8d77\u51e0\u767e\u4e2a\u4e0b\u6e38\u4e1a\u52a1\u7cfb\u7edf\u7684\u5173\u6ce8\uff0c\u5305\u62ec\u7269\u6d41\u3001\u8d2d\u7269\u8f66\u3001\u79ef\u5206\u3001\u6d41\u8ba1\u7b97\u5206\u6790\u7b49\u7b49\uff0c\u6574\u4f53\u4e1a\u52a1\u7cfb\u7edf\u5e9e\u5927\u800c\u4e14\u590d\u6742\uff0c\u6d88\u606f\u961f\u5217RocketMQ\u7248\u53ef\u5b9e\u73b0\u5f02\u6b65\u901a\u4fe1\u548c\u5e94\u7528\u89e3\u8026\uff0c\u786e\u4fdd\u4e3b\u7ad9\u4e1a\u52a1\u7684\u8fde\u7eed\u6027\u3002</p> <ul> <li>\u987a\u5e8f\u6536\u53d1</li> </ul> <p>\u7ec6\u6570\u65e5\u5e38\u4e2d\u9700\u8981\u4fdd\u8bc1\u987a\u5e8f\u7684\u5e94\u7528\u573a\u666f\u975e\u5e38\u591a\uff0c\u4f8b\u5982\u8bc1\u5238\u4ea4\u6613\u8fc7\u7a0b\u65f6\u95f4\u4f18\u5148\u539f\u5219\uff0c\u4ea4\u6613\u7cfb\u7edf\u4e2d\u7684\u8ba2\u5355\u521b\u5efa\u3001\u652f\u4ed8\u3001\u9000\u6b3e\u7b49\u6d41\u7a0b\uff0c\u822a\u73ed\u4e2d\u7684\u65c5\u5ba2\u767b\u673a\u6d88\u606f\u5904\u7406\u7b49\u7b49\u3002\u4e0e\u5148\u8fdb\u5148\u51faFIFO\uff08First In First Out\uff09\u539f\u7406\u7c7b\u4f3c\uff0c\u6d88\u606f\u961f\u5217RocketMQ\u7248\u63d0\u4f9b\u7684\u987a\u5e8f\u6d88\u606f\u5373\u4fdd\u8bc1\u6d88\u606fFIFO\u3002</p> <ul> <li>\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e00\u81f4\u6027</li> </ul> <p>\u4ea4\u6613\u7cfb\u7edf\u3001\u652f\u4ed8\u7ea2\u5305\u7b49\u573a\u666f\u9700\u8981\u786e\u4fdd\u6570\u636e\u7684\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u5927\u91cf\u5f15\u5165\u6d88\u606f\u961f\u5217RocketMQ\u7248\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u65e2\u53ef\u4ee5\u5b9e\u73b0\u7cfb\u7edf\u4e4b\u95f4\u7684\u89e3\u8026\uff0c\u53c8\u53ef\u4ee5\u4fdd\u8bc1\u6700\u7ec8\u7684\u6570\u636e\u4e00\u81f4\u6027\u3002</p> <ul> <li>\u5927\u6570\u636e\u5206\u6790</li> </ul> <p>\u6570\u636e\u5728\u201c\u6d41\u52a8\u201d\u4e2d\u4ea7\u751f\u4ef7\u503c\uff0c\u4f20\u7edf\u6570\u636e\u5206\u6790\u5927\u591a\u662f\u57fa\u4e8e\u6279\u91cf\u8ba1\u7b97\u6a21\u578b\uff0c\u800c\u65e0\u6cd5\u505a\u5230\u5b9e\u65f6\u7684\u6570\u636e\u5206\u6790\uff0c\u5229\u7528\u963f\u91cc\u4e91\u6d88\u606f\u961f\u5217RocketMQ\u7248\u4e0e\u6d41\u5f0f\u8ba1\u7b97\u5f15\u64ce\u76f8\u7ed3\u5408\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5b9e\u73b0\u4e1a\u52a1\u6570\u636e\u7684\u5b9e\u65f6\u5206\u6790\u3002</p> <ul> <li>\u5206\u5e03\u5f0f\u7f13\u5b58\u540c\u6b65</li> </ul> <p>\u5929\u732b\u53cc11\u5927\u4fc3\uff0c\u5404\u4e2a\u5206\u4f1a\u573a\u7433\u7405\u6ee1\u76ee\u7684\u5546\u54c1\u9700\u8981\u5b9e\u65f6\u611f\u77e5\u4ef7\u683c\u53d8\u5316\uff0c\u5927\u91cf\u5e76\u53d1\u8bbf\u95ee\u6570\u636e\u5e93\u5bfc\u81f4\u4f1a\u573a\u9875\u9762\u54cd\u5e94\u65f6\u95f4\u957f\uff0c\u96c6\u4e2d\u5f0f\u7f13\u5b58\u56e0\u5e26\u5bbd\u74f6\u9888\uff0c\u9650\u5236\u4e86\u5546\u54c1\u53d8\u66f4\u7684\u8bbf\u95ee\u6d41\u91cf\uff0c\u901a\u8fc7\u6d88\u606f\u961f\u5217RocketMQ\u7248\u6784\u5efa\u5206\u5e03\u5f0f\u7f13\u5b58\uff0c\u5b9e\u65f6\u901a\u77e5\u5546\u54c1\u6570\u636e\u7684\u53d8\u5316</p>"},{"location":"micro-services/rocketMQ/#_5","title":"\u9ad8\u7ea7\u7279\u6027","text":""},{"location":"micro-services/rocketMQ/#_6","title":"\u6d88\u606f\u91cd\u8bd5","text":"<p>\u987a\u5e8f\u6d88\u606f</p> <p>\u5bf9\u4e8e\u987a\u5e8f\u6d88\u606f\uff0c\u5f53\u6d88\u8d39\u8005\u6d88\u8d39\u6d88\u606f\u5931\u8d25\u540e\uff0cRocketMQ\u4f1a\u81ea\u52a8\u4e0d\u65ad\u5730\u8fdb\u884c\u6d88\u606f\u91cd\u8bd5\uff08\u6bcf\u6b21\u95f4\u9694\u65f6\u95f4\u4e3a1\u79d2\uff09\uff0c\u8fd9\u65f6\uff0c\u5e94\u7528\u4f1a\u51fa\u73b0\u6d88\u606f\u6d88\u8d39\u88ab\u963b\u585e\u7684\u60c5\u51b5\u3002\u56e0\u6b64\uff0c\u4f7f\u7528\u987a\u5e8f\u6d88\u606f\u65f6\uff0c\u52a1\u5fc5\u4fdd\u8bc1\u5e94\u7528\u80fd\u591f\u53ca\u65f6\u76d1\u63a7\u5e76\u5904\u7406\u6d88\u8d39\u5931\u8d25\u7684\u60c5\u51b5\uff0c\u907f\u514d\u963b\u585e\u73b0\u8c61\u7684\u53d1\u751f\u3002</p> <p>\u65e0\u5e8f\u6d88\u606f</p> <p>\u5bf9\u4e8e\u65e0\u5e8f\u6d88\u606f\uff0c\u53ef\u4ee5\u8fd4\u56deAction.ReconsumeLater\uff0c\u8fbe\u5230\u6d88\u606f\u91cd\u8bd5\u3002\u8fd4\u56denull\u6216\u8005\u629b\u51fa\u5f02\u5e38\u4e5f\u53ef\u4ee5\uff0c\u4f46\u662f\u63a8\u8350\u4ee3\u7801\u4e2dtry-catch\u8fd4\u56deAction.ReconsumeLater</p> <p>\u6ce8\u610f\u53ea\u9488\u5bf9\u96c6\u7fa4\u6d88\u8d39\u7684\u65b9\u5f0f\uff0c\u5e7f\u64ad\u65b9\u5f0f\u4e0d\u63d0\u4f9b\u6d88\u606f\u91cd\u8bd5\u7279\u6027\uff0c\u6d88\u8d39\u5931\u8d25\u540e\u4e0d\u518d\u8fdb\u884c\u91cd\u8bd5\uff0c\u7ee7\u7eed\u6d88\u8d39\u65b0\u7684\u6d88\u606f\u3002</p> <p>\u6d88\u606f\u91cd\u8bd5\u9ed8\u8ba416\u6b21\uff0c10s, 30s, 1m, 2m, 3m,....10m, 20m,30m,1h, 2h\uff0c\u603b\u51714\u5c0f\u65f646\u5206\u949f\uff0c\u5982\u679c\u6d88\u8d3916\u6b21\u4ecd\u662f\u5931\u8d25\uff0c\u6d88\u606f\u5c31\u4e0d\u518d\u8fdb\u884c\u6295\u9012\u3002 </p> <p>Consumer\u542f\u52a8\u7684\u65f6\u5019\u53ef\u4ee5\u8bbe\u7f6e\u6700\u5927\u91cd\u8bd5\u6b21\u6570\uff0c\u6ce8\u610f\u6d88\u606f\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u7684\u8bbe\u7f6e\u5bf9\u76f8\u540cGroup ID\u4e0b\u7684\u6240\u6709Consumer\u5b9e\u4f8b\u6709\u6548\uff0c\u4e5f\u5c31\u662f\u8bf4\u5982\u679c\u53ea\u5bf9\u76f8\u540cGroup ID\u4e0b\u4e24\u4e2aConsumer\u5b9e\u4f8b\u4e2d\u7684\u5176\u4e2d\u4e00\u4e2a\u8bbe\u7f6e\u4e86MaxReconsumeTimes\uff0c\u90a3\u4e48\u8be5\u914d\u7f6e\u5bf9\u4e24\u4e2aConsumer\u5b9e\u4f8b\u5747\u751f\u6548\uff01 \u914d\u7f6e\u91c7\u7528\u8986\u76d6\u7684\u65b9\u5f0f\u751f\u6548\uff0c\u5373\u6700\u540e\u542f\u52a8\u7684Consumer\u5b9e\u4f8b\u4f1a\u8986\u76d6\u4e4b\u524d\u7684\u542f\u52a8\u5b9e\u4f8b\u7684\u914d\u7f6e\u3002</p> <p>\u91cd\u8bd5\u539f\u7406</p> <p>RocketMQ\u4f1a\u4e3a\u6bcf\u4e2a\u6d88\u8d39\u7ec4\u90fd\u8bbe\u7f6e\u4e00\u4e2aTopic\u540d\u79f0\u4e3a\u201c%RETRY%+consumerGroup\u201d\u7684\u91cd\u8bd5\u961f\u5217\uff08\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e2aTopic\u7684\u91cd\u8bd5\u961f\u5217\u662f\u9488\u5bf9\u6d88\u8d39\u7ec4\uff0c\u800c\u4e0d\u662f\u9488\u5bf9\u6bcf\u4e2aTopic\u8bbe\u7f6e\u7684\uff09\uff0c\u7528\u4e8e\u6682\u65f6\u4fdd\u5b58\u56e0\u4e3a\u5404\u79cd\u5f02\u5e38\u800c\u5bfc\u81f4Consumer\u7aef\u65e0\u6cd5\u6d88\u8d39\u7684\u6d88\u606f\u3002\u8003\u8651\u5230\u5f02\u5e38\u6062\u590d\u8d77\u6765\u9700\u8981\u4e00\u4e9b\u65f6\u95f4\uff0c\u4f1a\u4e3a\u91cd\u8bd5\u961f\u5217\u8bbe\u7f6e\u591a\u4e2a\u91cd\u8bd5\u7ea7\u522b\uff0c\u6bcf\u4e2a\u91cd\u8bd5\u7ea7\u522b\u90fd\u6709\u4e0e\u4e4b\u5bf9\u5e94\u7684\u91cd\u65b0\u6295\u9012\u5ef6\u65f6\uff0c\u91cd\u8bd5\u6b21\u6570\u8d8a\u591a\u6295\u9012\u5ef6\u65f6\u5c31\u8d8a\u5927\u3002RocketMQ\u5bf9\u4e8e\u91cd\u8bd5\u6d88\u606f\u7684\u5904\u7406\u662f\u5148\u4fdd\u5b58\u81f3Topic\u540d\u79f0\u4e3a\u201cSCHEDULE_TOPIC_XXXX\u201d\u7684\u5ef6\u8fdf\u961f\u5217\u4e2d\uff0c\u540e\u53f0\u5b9a\u65f6\u4efb\u52a1\u6309\u7167\u5bf9\u5e94\u7684\u65f6\u95f4\u8fdb\u884cDelay\u540e\u91cd\u65b0\u4fdd\u5b58\u81f3\u201c%RETRY%+consumerGroup\u201d\u7684\u91cd\u8bd5\u961f\u5217\u4e2d\u3002</p>"},{"location":"micro-services/rocketMQ/#_7","title":"\u6d88\u8d39\u8fc7\u6ee4","text":"<p>tag\u8fc7\u6ee4\uff1atopic\u76f8\u5f53\u4e8e\u4e00\u7ea7\u5206\u7c7b\uff0ctag\u76f8\u5f53\u4e8e\u4e8c\u7ea7\u5206\u7c7b\u3002\u7ed3\u5408\u4f7f\u7528\u4f7f\u4e1a\u52a1\u7ed3\u6784\u6e05\u6670\u3002</p> <p>SQL\u8fc7\u6ee4\uff1aproducer\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5c5e\u6027\uff0cconsumer\u901a\u8fc7\u8bbe\u7f6eSQL\u8bed\u6cd5\u7684\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u6765\u8fc7\u6ee4\u6d88\u606f\u3002</p>"},{"location":"micro-services/rocketMQ/#_8","title":"\u6279\u91cf\u6d88\u8d39","text":"<p>\u6279\u91cf\u6d88\u8d39\u53ef\u4ee5\u63d0\u9ad8\u6d88\u606f\u5904\u7406\u7684\u6548\u7387\uff0c\u964d\u4f4e\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u7684\u9891\u7387\uff08\u5373\u53ef\u4ee5\u96c6\u4e2d\u4e00\u6279\u6d88\u606f\u67e5\u5176\u4ed6\u670d\u52a1\u7684\u6279\u91cf\u63a5\u53e3\uff09\u3002\u5177\u4f53\u53ef\u4ee5\u914d\u7f6e\u6700\u5927\u6d88\u606f\u6570\u91cf\u548c\u6700\u5927\u7b49\u5f85\u65f6\u957f\u3002</p> <p>\u57fa\u672c\u672f\u8bed\uff1a</p> <ul> <li>\u5206\u533a</li> </ul> <p>\u5373Topic Partition\uff0c\u7269\u7406\u4e0a\u7684\u6982\u5ff5\u3002\u6bcf\u4e2aTopic\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u5206\u533a\u3002</p> <ul> <li>\u6d88\u8d39\u4f4d\u70b9</li> </ul> <p>\u6bcf\u4e2aTopic\u4f1a\u6709\u591a\u4e2a\u5206\u533a\uff0c\u6bcf\u4e2a\u5206\u533a\u4f1a\u7edf\u8ba1\u5f53\u524d\u6d88\u606f\u7684\u603b\u6761\u6570\uff0c\u8fd9\u4e2a\u79f0\u4e3a\u6700\u5927\u4f4d\u70b9MaxOffset\uff1b\u5206\u533a\u7684\u8d77\u59cb\u4f4d\u7f6e\u5bf9\u5e94\u7684\u53eb\u505a\u8d77\u59cb\u4f4d\u70b9MinOffset\u3002\u6d88\u606f\u961f\u5217\u7684Pull Consumer\u4f1a\u6309\u987a\u5e8f\u4f9d\u6b21\u6d88\u8d39\u5206\u533a\u5185\u7684\u6bcf\u6761\u6d88\u606f\uff0c\u8bb0\u5f55\u5df2\u7ecf\u6d88\u8d39\u4e86\u7684\u6d88\u606f\u6761\u6570\uff0c\u79f0\u4e3a\u6d88\u8d39\u4f4d\u70b9ConsumerOffset\u3002\u5269\u4f59\u7684\u672a\u6d88\u8d39\u7684\u6761\u6570\uff08\u4e5f\u79f0\u4e3a\u6d88\u606f\u5806\u79ef\u91cf\uff09= \u6700\u5927\u4f4d\u70b9MaxOffset-\u6d88\u8d39\u4f4d\u70b9ConsumerOffset\u3002</p> <ul> <li>\u91cd\u7f6e\u6d88\u8d39\u4f4d\u70b9</li> </ul> <p>\u4ee5\u65f6\u95f4\u8f74\u4e3a\u5750\u6807\uff0c\u5728\u6d88\u606f\u6301\u4e45\u5316\u5b58\u50a8\u7684\u65f6\u95f4\u8303\u56f4\u5185\uff08\u9ed8\u8ba43\u5929\uff09\uff0c\u91cd\u65b0\u8bbe\u7f6eConsumer\u5bf9\u5df2\u8ba2\u9605\u7684Topic\u7684\u6d88\u8d39\u8fdb\u5ea6\uff0c\u8bbe\u7f6e\u5b8c\u6210\u540eConsumer\u5c06\u63a5\u6536\u8bbe\u5b9a\u65f6\u95f4\u70b9\u4e4b\u540e\u7531Producer\u53d1\u9001\u5230\u6d88\u606f\u961f\u5217RocketMQ\u7248\u670d\u52a1\u7aef\u7684\u6d88\u606f\u3002\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u91cd\u7f6e\u6d88\u8d39\u4f4d\u70b9\u3002</p> <ul> <li>\u6b7b\u4fe1\u961f\u5217   \u6b7b\u4fe1\u961f\u5217\u7528\u4e8e\u5904\u7406\u65e0\u6cd5\u88ab\u6b63\u5e38\u6d88\u8d39\u7684\u6d88\u606f\u3002\u5f53\u4e00\u6761\u6d88\u606f\u521d\u6b21\u6d88\u8d39\u5931\u8d25\uff0c\u6d88\u606f\u961f\u5217RocketMQ\u7248\u4f1a\u81ea\u52a8\u8fdb\u884c\u6d88\u606f\u91cd\u8bd5\uff1b\u8fbe\u5230\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u540e\uff0c\u82e5\u6d88\u8d39\u4f9d\u7136\u5931\u8d25\uff0c\u5219\u8868\u660eConsumer\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u65e0\u6cd5\u6b63\u786e\u5730\u6d88\u8d39\u8be5\u6d88\u606f\u3002\u6b64\u65f6\uff0c\u6d88\u606f\u961f\u5217RocketMQ\u7248\u4e0d\u4f1a\u7acb\u523b\u5c06\u6d88\u606f\u4e22\u5f03\uff0c\u800c\u662f\u5c06\u8fd9\u6761\u6d88\u606f\u53d1\u9001\u5230\u8be5Consumer\u5bf9\u5e94\u7684\u7279\u6b8a\u961f\u5217\u4e2d\u3002</li> </ul> <p>\u6d88\u606f\u961f\u5217RocketMQ\u7248\u5c06\u8fd9\u79cd\u6b63\u5e38\u60c5\u51b5\u4e0b\u65e0\u6cd5\u88ab\u6d88\u8d39\u7684\u6d88\u606f\u79f0\u4e3a\u6b7b\u4fe1\u6d88\u606f\uff08Dead-Letter Message\uff09\uff0c\u5c06\u5b58\u50a8\u6b7b\u4fe1\u6d88\u606f\u7684\u7279\u6b8a\u961f\u5217\u79f0\u4e3a\u6b7b\u4fe1\u961f\u5217\uff08Dead-Letter Queue\uff09\u3002\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528console\u63a7\u5236\u53f0\u5bf9\u6b7b\u4fe1\u961f\u5217\u4e2d\u7684\u6d88\u606f\u8fdb\u884c\u91cd\u53d1\u6765\u4f7f\u5f97\u6d88\u8d39\u8005\u5b9e\u4f8b\u518d\u6b21\u8fdb\u884c\u6d88\u8d39\u3002</p> <ul> <li>\u6d88\u606f\u8def\u7531</li> </ul> <p>\u6d88\u606f\u8def\u7531\u5e38\u7528\u4e8e\u4e0d\u540c\u5730\u57df\u4e4b\u95f4\u7684\u6d88\u606f\u540c\u6b65\uff0c\u4fdd\u8bc1\u5730\u57df\u4e4b\u95f4\u7684\u6570\u636e\u4e00\u81f4\u6027\u3002\u6d88\u606f\u961f\u5217RocketMQ\u7248\u7684\u5168\u7403\u6d88\u606f\u8def\u7531\u529f\u80fd\u4f9d\u6258\u963f\u91cc\u4e91\u4f18\u8d28\u57fa\u7840\u8bbe\u65bd\u5b9e\u73b0\u7684\u9ad8\u901f\u901a\u9053\u4e13\u7ebf\uff0c\u53ef\u4ee5\u9ad8\u6548\u5730\u5b9e\u73b0\u4e0d\u540c\u5730\u57df\u4e4b\u95f4\u7684\u6d88\u606f\u540c\u6b65\u590d\u5236\u3002\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u89c1\u5168\u7403\u6d88\u606f\u8def\u7531\u3002</p>"},{"location":"micro-services/rocketMQ/#_9","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"micro-services/rocketMQ/#_10","title":"\u6d88\u606f\u5e42\u7b49","text":"<p>qos:</p> <p>rocketMQ\u4fdd\u8bc1\u6d88\u606f\u81f3\u5c11\u88ab\u6d88\u8d39\u4e00\u6b21\u3002\u4e1a\u52a1\u7aef\u5e94\u8be5\u81ea\u5df1\u5904\u7406\u4fdd\u8bc1\u6d88\u606f\u5e42\u7b49\u6027\u3002</p> <p>\u53e6\u5916rockerMQ\u63d0\u4f9b\u4e86Exactly-Once\u6295\u9012\u8bed\u4e49\uff0c\u5229\u7528\u6570\u636e\u5e93\u6765\u4fdd\u8bc1\u6d88\u606f\u6709\u4e14\u4ec5\u88ab\u6d88\u8d39\u4e00\u6b21\u3002</p> <p>\u6d88\u606f\u91cd\u590d\u7684\u573a\u666f\u5982\u4e0b\uff1a</p> <ul> <li>\u53d1\u9001\u65f6\u6d88\u606f\u91cd\u590d</li> </ul> <p>\u5f53\u4e00\u6761\u6d88\u606f\u5df2\u88ab\u6210\u529f\u53d1\u9001\u5230\u670d\u52a1\u7aef\u5e76\u5b8c\u6210\u6301\u4e45\u5316\uff0c\u6b64\u65f6\u51fa\u73b0\u4e86\u7f51\u7edc\u95ea\u65ad\u6216\u8005\u5ba2\u6237\u7aef\u5b95\u673a\uff0c\u5bfc\u81f4\u670d\u52a1\u7aef\u5bf9\u5ba2\u6237\u7aef\u5e94\u7b54\u5931\u8d25\u3002 \u5982\u679c\u6b64\u65f6\u751f\u4ea7\u8005\u610f\u8bc6\u5230\u6d88\u606f\u53d1\u9001\u5931\u8d25\u5e76\u5c1d\u8bd5\u518d\u6b21\u53d1\u9001\u6d88\u606f\uff0c\u6d88\u8d39\u8005\u540e\u7eed\u4f1a\u6536\u5230\u4e24\u6761\u5185\u5bb9\u76f8\u540c\u5e76\u4e14Message ID\u4e5f\u76f8\u540c\u7684\u6d88\u606f\u3002</p> <ul> <li>\u6295\u9012\u65f6\u6d88\u606f\u91cd\u590d</li> </ul> <p>\u6d88\u606f\u6d88\u8d39\u7684\u573a\u666f\u4e0b\uff0c\u6d88\u606f\u5df2\u6295\u9012\u5230\u6d88\u8d39\u8005\u5e76\u5b8c\u6210\u4e1a\u52a1\u5904\u7406\uff0c\u5f53\u5ba2\u6237\u7aef\u7ed9\u670d\u52a1\u7aef\u53cd\u9988\u5e94\u7b54\u7684\u65f6\u5019\u7f51\u7edc\u95ea\u65ad\u3002\u4e3a\u4e86\u4fdd\u8bc1\u6d88\u606f\u81f3\u5c11\u88ab\u6d88\u8d39\u4e00\u6b21\uff0c\u6d88\u606f\u961f\u5217RocketMQ\u7248\u7684\u670d\u52a1\u7aef\u5c06\u5728\u7f51\u7edc\u6062\u590d\u540e\u518d\u6b21\u5c1d\u8bd5\u6295\u9012\u4e4b\u524d\u5df2\u88ab\u5904\u7406\u8fc7\u7684\u6d88\u606f\uff0c\u6d88\u8d39\u8005\u540e\u7eed\u4f1a\u6536\u5230\u4e24\u6761\u5185\u5bb9\u76f8\u540c\u5e76\u4e14Message ID\u4e5f\u76f8\u540c\u7684\u6d88\u606f\u3002</p> <ul> <li>\u8d1f\u8f7d\u5747\u8861\u65f6\u6d88\u606f\u91cd\u590d\uff08\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e\u7f51\u7edc\u6296\u52a8\u3001Broker\u91cd\u542f\u4ee5\u53ca\u6d88\u8d39\u8005\u5e94\u7528\u91cd\u542f\uff09</li> </ul> <p>\u5f53\u6d88\u606f\u961f\u5217RocketMQ\u7248\u7684Broker\u6216\u5ba2\u6237\u7aef\u91cd\u542f\u3001\u6269\u5bb9\u6216\u7f29\u5bb9\u65f6\uff0c\u4f1a\u89e6\u53d1Rebalance\uff0c\u6b64\u65f6\u6d88\u8d39\u8005\u53ef\u80fd\u4f1a\u6536\u5230\u91cd\u590d\u6d88\u606f\u3002</p> <p>\u56e0\u4e3a\u4e0d\u540c\u7684Message ID\u5bf9\u5e94\u7684\u6d88\u606f\u5185\u5bb9\u53ef\u80fd\u76f8\u540c\uff0c\u6709\u53ef\u80fd\u51fa\u73b0\u51b2\u7a81\uff08\u91cd\u590d\uff09\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u771f\u6b63\u5b89\u5168\u7684\u5e42\u7b49\u5904\u7406\uff0c\u4e0d\u5efa\u8bae\u4ee5Message ID\u4f5c\u4e3a\u5904\u7406\u4f9d\u636e\u3002</p> <p>\u6700\u597d\u7684\u65b9\u5f0f\u662f\u4ee5\u4e1a\u52a1\u552f\u4e00\u6807\u8bc6\u4f5c\u4e3a\u5e42\u7b49\u5904\u7406\u7684\u5173\u952e\u4f9d\u636e\uff0c\u4e1a\u52a1\u7684\u552f\u4e00\u6807\u8bc6\u8981\u8bbe\u7f6e\u5230keys\u5b57\u6bb5<code>message.setKeys(orderId);</code>\uff0c\u65b9\u4fbf\u5c06\u6765\u5b9a\u4f4d\u6d88\u606f\u4e22\u5931\u95ee\u9898\u3002\u670d\u52a1\u5668\u4f1a\u4e3a\u6bcf\u4e2a\u6d88\u606f\u521b\u5efa\u7d22\u5f15\uff08\u54c8\u5e0c\u7d22\u5f15\uff09\uff0c\u5e94\u7528\u53ef\u4ee5\u901a\u8fc7topic\u3001key\u6765\u67e5\u8be2\u8fd9\u6761\u6d88\u606f\u5185\u5bb9\uff0c\u4ee5\u53ca\u6d88\u606f\u88ab\u8c01\u6d88\u8d39\u3002\u7531\u4e8e\u662f\u54c8\u5e0c\u7d22\u5f15\uff0c\u8bf7\u52a1\u5fc5\u4fdd\u8bc1key\u5c3d\u53ef\u80fd\u552f\u4e00\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u6f5c\u5728\u7684\u54c8\u5e0c\u51b2\u7a81\u3002</p>"},{"location":"micro-services/rocketMQ/#_11","title":"\u6d88\u606f\u5806\u79ef\u548c\u6d88\u606f\u5ef6\u8fdf","text":"<p>\u5728\u6d88\u606f\u5904\u7406\u6d41\u7a0b\u4e2d\uff0c\u5982\u901a\u8fc7\u6d88\u606f\u6d88\u8d39\u901f\u5ea6\u8ddf\u4e0d\u4e0a\u751f\u4ea7\u901f\u5ea6\uff0c\u672a\u5904\u7406\u7684\u6d88\u606f\u8d8a\u6765\u8d8a\u591a\uff0c\u5c31\u4f1a\u9020\u6210\u6d88\u606f\u5806\u79ef\u3002\u6d88\u606f\u5806\u79ef\u4f1a\u9020\u6210\u6d88\u8d39\u5ef6\u8fdf\uff0c\u8fd9\u4f1a\u5bf9\u4e1a\u52a1\u9020\u6210\u8f83\u5927\u5f71\u54cd\uff0c\u6240\u4ee5\u5e94\u5c3d\u529b\u907f\u514d\u3002\u5c24\u5176\u662f\u5bf9\u5b9e\u65f6\u6027\u8981\u6c42\u8f83\u9ad8\u7684\u573a\u666f\uff0c\u5373\u4f7f\u77ed\u6682\u7684\u6d88\u606f\u5ef6\u8fdf\u4e5f\u65e0\u6cd5\u63a5\u53d7\u65f6\u66f4\u5e94\u8be5\u5173\u6ce8\u6b64\u95ee\u9898\u3002</p> <p>\u6d88\u606f\u5806\u79ef\u7684\u4e3b\u8981\u74f6\u9888\u5728\u4e8e\u5ba2\u6237\u7aef\u7684\u6d88\u8d39\u80fd\u529b\uff0c\u5373\u6d88\u8d39\u8017\u65f6\u548c\u6d88\u8d39\u5e76\u53d1\u5ea6\u3002\u60f3\u8981\u907f\u514d\u548c\u89e3\u51b3\u6d88\u606f\u5806\u79ef\u95ee\u9898\uff0c\u5fc5\u987b\u5408\u7406\u7684\u63a7\u5236\u6d88\u8d39\u8017\u65f6\u548c\u6d88\u606f\u5e76\u53d1\u5ea6\uff0c\u5176\u4e2d\u6d88\u8d39\u8017\u65f6\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e\u6d88\u8d39\u5e76\u53d1\u5ea6\uff0c\u5fc5\u987b\u5148\u4fdd\u8bc1\u6d88\u8d39\u8017\u65f6\u7684\u5408\u7406\u6027\uff0c\u518d\u8003\u8651\u6d88\u8d39\u5e76\u53d1\u5ea6\u95ee\u9898\u3002</p> <p>\u5f71\u54cd\u6d88\u8d39\u8017\u65f6\u7684\u4e3b\u8981\u5206\u4e3aCPU\u8ba1\u7b97\u548c\u5916\u90e8IO\u64cd\u4f5c\uff0c\u5176\u4e2dCPU\u8ba1\u7b97\u4e00\u822c\u76f8\u5bf9IO\u64cd\u4f5c\u90fd\u53ef\u4ee5\u5ffd\u7565\u3002IO\u64cd\u4f5c\u4e3b\u8981\u6709\u8bfb\u5199\u5916\u90e8\u6570\u636e\u5e93\uff0c\u4e0b\u6e38\u7cfb\u7edf\u8c03\u7528\u3002</p> <p>\u6d88\u8d39\u5e76\u53d1\u5ea6\u7531\u5355\u8282\u70b9\u7684\u6d88\u8d39\u7ebf\u7a0b\u6570\uff08\u9ed8\u8ba420~64\u4e2a\uff09\u548c\u8282\u70b9\u6570\u91cf\u5171\u540c\u51b3\u5b9a\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u9700\u8981\u4f18\u5148\u8c03\u6574\u5355\u8282\u70b9\u7684\u6d88\u8d39\u7ebf\u7a0b\u6570\uff0c\u82e5\u5355\u673a\u786c\u4ef6\u8d44\u6e90\u8fbe\u5230\u4e0a\u9650\uff0c\u5219\u5fc5\u987b\u901a\u8fc7\u6269\u5bb9\u8282\u70b9\u6765\u63d0\u9ad8\u6d88\u8d39\u5e76\u53d1\u5ea6\u3002\u4e0d\u80fd\u76f2\u76ee\u76f4\u63a5\u8c03\u5927\u7ebf\u7a0b\u6570\uff0c\u8bbe\u7f6e\u8fc7\u5927\u7684\u7ebf\u7a0b\u6570\u53cd\u800c\u4f1a\u5e26\u6765\u5927\u91cf\u7684\u7ebf\u7a0b\u5207\u6362\u7684\u5f00\u9500\u3002\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u5efa\u8bae\u9010\u6b65\u8c03\u5927\u7ebf\u7a0b\u7684\u5355\u4e2a\u8282\u70b9\u7684\u7ebf\u7a0b\u6570\uff0c\u5e76\u5173\u6d4b\u8282\u70b9\u7684\u7cfb\u7edf\u6307\u6807\uff0c\u5f97\u5230\u5355\u4e2a\u8282\u70b9\u6700\u4f18\u7684\u6d88\u8d39\u7ebf\u7a0b\u6570\u548c\u6d88\u606f\u541e\u5410\u91cf\uff0c\u7136\u540e\uff0c\u6839\u636e\u4e0a\u4e0b\u6e38\u94fe\u8def\u7684\u6d41\u91cf\u5cf0\u503c\u8ba1\u7b97\u51fa\u9700\u8981\u8bbe\u7f6e\u7684\u8282\u70b9\u6570\uff0c\u8282\u70b9\u6570=\u6d41\u91cf\u5cf0\u503c/\u5355\u7ebf\u7a0b\u6d88\u606f\u541e\u5410\u91cf</p>"},{"location":"micro-services/rocketMQ/#_12","title":"\u67b6\u6784\u8bbe\u8ba1","text":"<p>\u7531\u56db\u4e2a\u90e8\u5206\u7ec4\u6210\uff0c\u6bcf\u4e2a\u90fd\u53ef\u4ee5\u6a2a\u5411\u6269\u5c55\uff0c\u4e0d\u4f1a\u9020\u6210\u5355\u70b9\u6545\u969c\u3002</p> <ul> <li>Name Server\uff1a\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684Topic\u8def\u7531\u6ce8\u518c\u4e2d\u5fc3\uff0c\u652f\u6301Broker\u7684\u52a8\u6001\u6ce8\u518c\u4e0e\u53d1\u73b0\u3002Broker\u662f\u5411\u6bcf\u4e00\u53f0NameServer\u6ce8\u518c\u81ea\u5df1\u7684\u8def\u7531\u4fe1\u606f\uff0c\u6240\u4ee5\u6bcf\u4e2aName Server\u90fd\u8bb0\u5f55\u4e86\u5b8c\u6574\u7684\u8def\u7531\u4fe1\u606f\u3002\u901a\u5e38\u4e5f\u662f\u96c6\u7fa4\u90e8\u7f72\uff0c\u8282\u70b9\u4e4b\u95f4\u65e0\u4efb\u4f55\u4fe1\u606f\u540c\u6b65</li> <li>broke \u7ba1\u7406\uff1aNameServer\u63a5\u53d7Broker\u96c6\u7fa4\u7684\u6ce8\u518c\u4fe1\u606f\u5e76\u4e14\u4fdd\u5b58\u4e0b\u6765\u4f5c\u4e3a\u8def\u7531\u4fe1\u606f\u7684\u57fa\u672c\u6570\u636e\u3002\u7136\u540e\u63d0\u4f9b\u5fc3\u8df3\u68c0\u6d4b\u673a\u5236\uff0c\u68c0\u67e5Broker\u662f\u5426\u8fd8\u5b58\u6d3b</li> <li>Routing \u7ba1\u7406\uff1a\u6bcf\u4e2aNameServer\u5c06\u4fdd\u5b58\u5173\u4e8eBroker\u96c6\u7fa4\u7684\u6574\u4e2a\u8def\u7531\u4fe1\u606f\u548c\u7528\u4e8e\u5ba2\u6237\u7aef\u67e5\u8be2\u7684\u961f\u5217\u4fe1\u606f\uff0c\u7136\u540eProducer\u548cConumser\u901a\u8fc7NameServer\u5c31\u53ef\u4ee5\u77e5\u9053\u6574\u4e2aBroker\u96c6\u7fa4\u7684\u8def\u7531\u4fe1\u606f\uff0c\u4ece\u800c\u8fdb\u884c\u6d88\u606f\u7684\u6295\u9012\u548c\u6d88\u8d39</li> <li>Broker\uff1a\u4e3b\u8981\u8d1f\u8d23\u6d88\u606f\u7684\u5b58\u50a8\u3001\u6295\u9012\u548c\u67e5\u8be2\u4ee5\u53ca\u670d\u52a1\u9ad8\u53ef\u7528\u4fdd\u8bc1\u3002\u4e00\u4e2aMaster Broker\u5bf9\u5e94\u591a\u4e2aSlave Broker\u3002Broker\u542f\u52a8\u540e\u9700\u8981\u5c06\u81ea\u5df1\u6ce8\u518c\u81f3Name Server\u7684\u64cd\u4f5c\uff1b\u968f\u540e\u6bcf\u969430s\u5b9a\u671f\u5411Name Server\u4e0a\u62a5Topic\u8def\u7531\u4fe1\u606f\u3002</li> <li>\u751f\u4ea7\u8005\uff1a\u4e0eName Server\u96c6\u7fa4\u4e2d\u7684\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\uff08\u968f\u673a\uff09\u5efa\u7acb\u957f\u94fe\u63a5\uff08Keep-alive\uff09\uff0c\u5b9a\u671f\u4eceName Server\u8bfb\u53d6Topic\u8def\u7531\u4fe1\u606f\uff0c\u5e76\u5411\u63d0\u4f9bTopic\u670d\u52a1\u7684Master Broker\u5efa\u7acb\u957f\u94fe\u63a5\uff0c\u4e14\u5b9a\u65f6\u5411Master Broker\u53d1\u9001\u5fc3\u8df3\u3002</li> <li>\u6d88\u8d39\u8005\uff1a\u4e0eName Server\u96c6\u7fa4\u4e2d\u7684\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\uff08\u968f\u673a\uff09\u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u5b9a\u671f\u4eceName Server\u62c9\u53d6Topic\u8def\u7531\u4fe1\u606f\uff0c\u5e76\u5411\u63d0\u4f9bTopic\u670d\u52a1\u7684Master Broker\u3001Slave Broker\u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u4e14\u5b9a\u65f6\u5411Master Broker\u3001Slave Broker\u53d1\u9001\u5fc3\u8df3\u3002Consumer\u65e2\u53ef\u4ee5\u4eceMaster Broker\u8ba2\u9605\u6d88\u606f\uff0c\u4e5f\u53ef\u4ee5\u4eceSlave Broker\u8ba2\u9605\u6d88\u606f\uff0c\u8ba2\u9605\u89c4\u5219\u7531Broker\u914d\u7f6e\u51b3\u5b9a\u3002</li> </ul> <p>\u7ed3\u5408\u90e8\u7f72\u67b6\u6784\u56fe\uff0c\u63cf\u8ff0\u96c6\u7fa4\u5de5\u4f5c\u6d41\u7a0b\uff1a</p> <ul> <li>\u542f\u52a8NameServer\uff0cNameServer\u8d77\u6765\u540e\u76d1\u542c9876\u7aef\u53e3\uff0c\u7b49\u5f85Broker\u3001Producer\u3001Consumer\u8fde\u4e0a\u6765\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u8def\u7531\u63a7\u5236\u4e2d\u5fc3\u3002</li> <li>Broker\u542f\u52a8\uff0c\u8ddf\u6240\u6709\u7684NameServer\u4fdd\u6301\u957f\u8fde\u63a5\uff0c\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u5305\u3002\u5fc3\u8df3\u5305\u4e2d\u5305\u542b\u5f53\u524dBroker\u4fe1\u606f(IP+\u7aef\u53e3\u7b49)\u4ee5\u53ca\u5b58\u50a8\u6240\u6709Topic\u4fe1\u606f\u3002\u6ce8\u518c\u6210\u529f\u540e\uff0cNameServer\u96c6\u7fa4\u4e2d\u5c31\u6709Topic\u8ddfBroker\u7684\u6620\u5c04\u5173\u7cfb\u3002</li> <li>\u6536\u53d1\u6d88\u606f\u524d\uff0c\u5148\u521b\u5efaTopic\uff0c\u521b\u5efaTopic\u65f6\u9700\u8981\u6307\u5b9a\u8be5Topic\u8981\u5b58\u50a8\u5728\u54ea\u4e9bBroker\u4e0a\uff0c\u4e5f\u53ef\u4ee5\u5728\u53d1\u9001\u6d88\u606f\u65f6\u81ea\u52a8\u521b\u5efaTopic\u3002</li> <li>Producer\u53d1\u9001\u6d88\u606f\uff0c\u542f\u52a8\u65f6\u5148\u8ddfNameServer\u96c6\u7fa4\u4e2d\u7684\u5176\u4e2d\u4e00\u53f0\u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u5e76\u4eceNameServer\u4e2d\u83b7\u53d6\u5f53\u524d\u53d1\u9001\u7684Topic\u5b58\u5728\u54ea\u4e9bBroker\u4e0a\uff0c\u8f6e\u8be2\u4ece\u961f\u5217\u5217\u8868\u4e2d\u9009\u62e9\u4e00\u4e2a\u961f\u5217\uff0c\u7136\u540e\u4e0e\u961f\u5217\u6240\u5728\u7684Broker\u5efa\u7acb\u957f\u8fde\u63a5\u4ece\u800c\u5411Broker\u53d1\u6d88\u606f\u3002</li> <li>Consumer\u8ddfProducer\u7c7b\u4f3c\uff0c\u8ddf\u5176\u4e2d\u4e00\u53f0NameServer\u5efa\u7acb\u957f\u8fde\u63a5\uff0c\u83b7\u53d6\u5f53\u524d\u8ba2\u9605Topic\u5b58\u5728\u54ea\u4e9bBroker\u4e0a\uff0c\u7136\u540e\u76f4\u63a5\u8ddfBroker\u5efa\u7acb\u8fde\u63a5\u901a\u9053\uff0c\u5f00\u59cb\u6d88\u8d39\u6d88\u606f\u3002</li> </ul>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/","title":"\u6d88\u606f\u8fc7\u6ee4","text":"<p>RocketMQ\u5206\u5e03\u5f0f\u6d88\u606f\u961f\u5217\u7684\u6d88\u606f\u8fc7\u6ee4\u65b9\u5f0f\u6709\u522b\u4e8e\u5176\u5b83MQ\u4e2d\u95f4\u4ef6\uff0c\u662f\u5728Consumer\u7aef\u8ba2\u9605\u6d88\u606f\u65f6\u518d\u505a\u6d88\u606f\u8fc7\u6ee4\u7684\u3002RocketMQ\u8fd9\u4e48\u505a\u662f\u5728\u4e8e\u5176Producer\u7aef\u5199\u5165\u6d88\u606f\u548cConsumer\u7aef\u8ba2\u9605\u6d88\u606f\u91c7\u7528\u5206\u79bb\u5b58\u50a8\u7684\u673a\u5236\u6765\u5b9e\u73b0\u7684\uff0cConsumer\u7aef\u8ba2\u9605\u6d88\u606f\u662f\u9700\u8981\u901a\u8fc7ConsumeQueue\u8fd9\u4e2a\u6d88\u606f\u6d88\u8d39\u7684\u903b\u8f91\u961f\u5217\u62ff\u5230\u4e00\u4e2a\u7d22\u5f15\uff0c\u7136\u540e\u518d\u4eceCommitLog\u91cc\u9762\u8bfb\u53d6\u771f\u6b63\u7684\u6d88\u606f\u5b9e\u4f53\u5185\u5bb9\uff0c\u6240\u4ee5\u8bf4\u5230\u5e95\u4e5f\u662f\u8fd8\u7ed5\u4e0d\u5f00\u5176\u5b58\u50a8\u7ed3\u6784\u3002\u5176ConsumeQueue\u7684\u5b58\u50a8\u7ed3\u6784\u5982\u4e0b\uff0c\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u67098\u4e2a\u5b57\u8282\u5b58\u50a8\u7684Message Tag\u7684\u54c8\u5e0c\u503c\uff0c\u57fa\u4e8eTag\u7684\u6d88\u606f\u8fc7\u6ee4\u6b63\u5f0f\u57fa\u4e8e\u8fd9\u4e2a\u5b57\u6bb5\u503c\u7684\u3002</p> <p>\u4e3b\u8981\u652f\u6301\u5982\u4e0b2\u79cd\u7684\u8fc7\u6ee4\u65b9\u5f0f\uff1a</p> <p>(1) Tag\u8fc7\u6ee4\u65b9\u5f0f\uff1aConsumer\u7aef\u5728\u8ba2\u9605\u6d88\u606f\u65f6\u9664\u4e86\u6307\u5b9aTopic\u8fd8\u53ef\u4ee5\u6307\u5b9aTAG\uff0c\u5982\u679c\u4e00\u4e2a\u6d88\u606f\u6709\u591a\u4e2aTAG\uff0c\u53ef\u4ee5\u7528||\u5206\u9694\u3002\u5176\u4e2d\uff0cConsumer\u7aef\u4f1a\u5c06\u8fd9\u4e2a\u8ba2\u9605\u8bf7\u6c42\u6784\u5efa\u6210\u4e00\u4e2a SubscriptionData\uff0c\u53d1\u9001\u4e00\u4e2aPull\u6d88\u606f\u7684\u8bf7\u6c42\u7ed9Broker\u7aef\u3002Broker\u7aef\u4eceRocketMQ\u7684\u6587\u4ef6\u5b58\u50a8\u5c42\u2014Store\u8bfb\u53d6\u6570\u636e\u4e4b\u524d\uff0c\u4f1a\u7528\u8fd9\u4e9b\u6570\u636e\u5148\u6784\u5efa\u4e00\u4e2aMessageFilter\uff0c\u7136\u540e\u4f20\u7ed9Store\u3002Store\u4ece ConsumeQueue\u8bfb\u53d6\u5230\u4e00\u6761\u8bb0\u5f55\u540e\uff0c\u4f1a\u7528\u5b83\u8bb0\u5f55\u7684\u6d88\u606ftag hash\u503c\u53bb\u505a\u8fc7\u6ee4\uff0c\u7531\u4e8e\u5728\u670d\u52a1\u7aef\u53ea\u662f\u6839\u636ehashcode\u8fdb\u884c\u5224\u65ad\uff0c\u65e0\u6cd5\u7cbe\u786e\u5bf9tag\u539f\u59cb\u5b57\u7b26\u4e32\u8fdb\u884c\u8fc7\u6ee4\uff0c\u6545\u5728\u6d88\u606f\u6d88\u8d39\u7aef\u62c9\u53d6\u5230\u6d88\u606f\u540e\uff0c\u8fd8\u9700\u8981\u5bf9\u6d88\u606f\u7684\u539f\u59cbtag\u5b57\u7b26\u4e32\u8fdb\u884c\u6bd4\u5bf9\uff0c\u5982\u679c\u4e0d\u540c\uff0c\u5219\u4e22\u5f03\u8be5\u6d88\u606f\uff0c\u4e0d\u8fdb\u884c\u6d88\u606f\u6d88\u8d39\u3002</p> <p>(2) SQL92\u7684\u8fc7\u6ee4\u65b9\u5f0f\uff1a\u8fd9\u79cd\u65b9\u5f0f\u7684\u5927\u81f4\u505a\u6cd5\u548c\u4e0a\u9762\u7684Tag\u8fc7\u6ee4\u65b9\u5f0f\u4e00\u6837\uff0c\u53ea\u662f\u5728Store\u5c42\u7684\u5177\u4f53\u8fc7\u6ee4\u8fc7\u7a0b\u4e0d\u592a\u4e00\u6837\uff0c\u771f\u6b63\u7684 SQL expression \u7684\u6784\u5efa\u548c\u6267\u884c\u7531rocketmq-filter\u6a21\u5757\u8d1f\u8d23\u7684\u3002\u6bcf\u6b21\u8fc7\u6ee4\u90fd\u53bb\u6267\u884cSQL\u8868\u8fbe\u5f0f\u4f1a\u5f71\u54cd\u6548\u7387\uff0c\u6240\u4ee5RocketMQ\u4f7f\u7528\u4e86BloomFilter\u907f\u514d\u4e86\u6bcf\u6b21\u90fd\u53bb\u6267\u884c\u3002SQL92\u7684\u8868\u8fbe\u5f0f\u4e0a\u4e0b\u6587\u4e3a\u6d88\u606f\u7684\u5c5e\u6027\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_2","title":"\u6d88\u606f\u67e5\u8be2","text":"<p>RocketMQ\u652f\u6301\u6309\u7167\u4e0b\u9762\u4e24\u79cd\u7ef4\u5ea6\uff08\u201c\u6309\u7167Message Id\u67e5\u8be2\u6d88\u606f\u201d\u3001\u201c\u6309\u7167Message Key\u67e5\u8be2\u6d88\u606f\u201d\uff09\u8fdb\u884c\u6d88\u606f\u67e5\u8be2\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#1-offsetmsgid","title":"1. \u6309\u7167offsetMsgId\u67e5\u8be2\u6d88\u606f","text":"<p>RocketMQ\u4e2d\u7684offsetMsgId\u7684\u957f\u5ea6\u603b\u5171\u670916\u5b57\u8282\uff0c\u662f\u7531Broker\u670d\u52a1\u7aef\u5728\u5199\u5165\u6d88\u606f\u65f6\u751f\u6210\u7684\uff08\u91c7\u7528\u201dIP\u5730\u5740+Port\u7aef\u53e3\u201d\u4e0e\u201cCommitLog\u7684\u7269\u7406\u504f\u79fb\u91cf\u5730\u5740\u201d\u505a\u4e86\u4e00\u4e2a\u5b57\u7b26\u4e32\u62fc\u63a5\uff09\u3002</p> <p>\u201c\u6309\u7167MessageId\u67e5\u8be2\u6d88\u606f\u201d\u5177\u4f53\u505a\u6cd5\u662f\uff1aClient\u7aef\u4eceMessageId\u4e2d\u89e3\u6790\u51faBroker\u7684\u5730\u5740\uff08IP\u5730\u5740\u548c\u7aef\u53e3\uff09\u548cCommit Log\u7684\u504f\u79fb\u5730\u5740\u540e\u5c01\u88c5\u6210\u4e00\u4e2aRPC\u8bf7\u6c42\u540e\u901a\u8fc7Remoting\u901a\u4fe1\u5c42\u53d1\u9001\uff08\u4e1a\u52a1\u8bf7\u6c42\u7801\uff1aVIEW_MESSAGE_BY_ID\uff09\u3002Broker\u7aef\u8d70\u7684\u662fQueryMessageProcessor\uff0c\u8bfb\u53d6\u6d88\u606f\u7684\u8fc7\u7a0b\u7528\u5176\u4e2d\u7684 commitLog offset \u548c size \u53bb commitLog \u4e2d\u627e\u5230\u771f\u6b63\u7684\u8bb0\u5f55\u5e76\u89e3\u6790\u6210\u4e00\u4e2a\u5b8c\u6574\u7684\u6d88\u606f\u8fd4\u56de\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#2-message-key","title":"2. \u6309\u7167Message Key\u67e5\u8be2\u6d88\u606f","text":"<p>\u201c\u6309\u7167Message Key\u67e5\u8be2\u6d88\u606f\u201d\uff0c\u4e3b\u8981\u662f\u57fa\u4e8eRocketMQ\u7684IndexFile\u7d22\u5f15\u6587\u4ef6\u6765\u5b9e\u73b0\u7684\u3002</p> <p>IndexFile\u6587\u4ef6\u540d\u662f\u4ee5\u521b\u5efa\u65f6\u7684\u65f6\u95f4\u6233\u547d\u540d\u7684\uff0c\u6587\u4ef6\u5927\u5c0f\u662f\u56fa\u5b9a\u7684\uff0c\u7b49\u4e8e$40+500W4+2000W20= 420000040$\u5b57\u8282,\u5927\u7ea6400M\u3002\u6574\u4e2aIndex File\u7684\u7ed3\u6784\u5982\u56fe\uff0c40 Byte \u7684Header\u7528\u4e8e\u4fdd\u5b58\u4e00\u4e9b\u603b\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c Slot Table\u5e76\u4e0d\u4fdd\u5b58\u771f\u6b63\u7684\u7d22\u5f15\u6570\u636e\uff0c\u800c\u662f\u4fdd\u5b58\u6bcf\u4e2a\u69fd\u4f4d\u5bf9\u5e94\u7684\u5355\u5411\u94fe\u8868\u7684\u5934\u3002$20*2000W$\u662f\u771f\u6b63\u7684\u7d22\u5f15\u6570\u636e\uff0c\u5373\u4e00\u4e2a Index File \u53ef\u4ee5\u4fdd\u5b58 2000W\u4e2a\u7d22\u5f15\u3002</p> <p>IndexFile\u6587\u4ef6\u903b\u8f91\u7ed3\u6784\u7c7b\u4f3cJDK\u4e2dHashMap\u7684\u5b9e\u73b0\uff0c\u5982\u679c\u6d88\u606f\u8bbe\u7f6e\u4e86UNIQ_KEY\u8fd9\u4e2a\u5c5e\u6027\uff0c\u5c31\u7528 <code>topic + \u201c#\u201d + UNIQ_KEY</code>\u4f5c\u4e3akey\u6765\u505a\u5199\u5165\u64cd\u4f5c\uff0c\u5982\u679c\u6d88\u606f\u8bbe\u7f6e\u4e86KEYS\u5c5e\u6027\uff08\u591a\u4e2aKEY\u4ee5\u7a7a\u683c\u5206\u9694\uff09\uff0c\u4e5f\u4f1a\u7528 topic + \u201c#\u201d + KEY \u6765\u505a\u7d22\u5f15\u3002</p> <p>\u5176\u4e2d\u7d22\u5f15\u7ed3\u70b9\u5305\u542b\u4e86Key Hash/CommitLog Offset/Timestamp/NextIndex offset \u8fd9\u56db\u4e2a\u5b57\u6bb5\uff0c\u4e00\u517120 Byte\u3002NextIndex offset \u5373\u524d\u9762\u8bfb\u51fa\u6765\u7684 slotValue\uff0c\u5982\u679c\u6709 hash\u51b2\u7a81\uff0c\u5c31\u53ef\u4ee5\u7528\u8fd9\u4e2a\u5b57\u6bb5\u5c06\u6240\u6709\u51b2\u7a81\u7684\u7d22\u5f15\u7528\u94fe\u8868\u7684\u65b9\u5f0f\u4e32\u8d77\u6765\u4e86\u3002Timestamp\u8bb0\u5f55\u7684\u662f\u6d88\u606fstoreTimestamp\u4e4b\u95f4\u7684\u5dee\uff0c\u5e76\u4e0d\u662f\u4e00\u4e2a\u7edd\u5bf9\u7684\u65f6\u95f4\u3002</p> <p></p> <p>\u201c\u6309\u7167Message Key\u67e5\u8be2\u6d88\u606f\u201d\u7684\u65b9\u5f0f\uff0cRocketMQ\u7684\u5177\u4f53\u505a\u6cd5\u662f\uff0c\u4e3b\u8981\u901a\u8fc7Broker\u7aef\u7684QueryMessageProcessor\u4e1a\u52a1\u5904\u7406\u5668\u6765\u67e5\u8be2\uff0c\u8bfb\u53d6\u6d88\u606f\u7684\u8fc7\u7a0b\u5c31\u662f\u7528topic\u548ckey\u627e\u5230IndexFile\u7d22\u5f15\u6587\u4ef6\u4e2d\u7684\u4e00\u6761\u8bb0\u5f55\uff0c\u6839\u636e\u5176\u4e2d\u7684commitLog offset\u4eceCommitLog\u6587\u4ef6\u4e2d\u8bfb\u53d6\u6d88\u606f\u7684\u5b9e\u4f53\u5185\u5bb9\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_3","title":"\u6e90\u7801\u7ed3\u6784","text":""},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#namesrv","title":"namesrv\u670d\u52a1","text":"<p>\u628adistribution/conf\u4e0b\u7684 logback_namesrv.xml\u62f7\u8d1d\u65b0\u521b\u5efa\u7684conf\u6587\u4ef6\u5939\u4e0b\uff1b\u5728idea\u4e2d\u914d\u7f6e\u73af\u5883\u53d8\u91cf<code>ROCKETMQ_HOME=/Users/jun/work/code/github/rocketmq</code>\u7136\u540e\u542f\u52a8\u5373\u53ef\u3002</p> <p>\u542f\u52a8\u6d41\u7a0b\uff1a</p> <ol> <li> <p>\u521b\u5efaNamesrvController\uff1a\u89e3\u6790-c\u6307\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\uff08\u975e\u5fc5\u8981\uff09\uff0c-p\u6307\u5b9a\u7684\u5355\u4e2a\u5c5e\u6027\u914d\u7f6e\uff08--\u5c5e\u6027\u540d \u5c5e\u6027\u503c\uff09\uff0c\u586b\u5145\u5230NamesrvConfig\u548cNettyServerConfig\uff0c\u7136\u540e\u521b\u5efa<code>new NamesrvController(namesrvConfig, nettyServerConfig)</code></p> </li> <li> <p>\u521d\u59cb\u5316\uff1a\u521b\u5efanetty\u670d\u52a1\u7aefremotingServer\u5904\u7406\u8bf7\u6c42\uff0c\u521b\u5efa\u5fc3\u8df3\u68c0\u6d4b\u5b9a\u65f6\u4efb\u52a1\u6bcf10\u79d2\u53bb\u68c0\u6d4b2\u5206\u949f\u4e0d\u6d3b\u52a8\u7684broke\uff1b\u5b9a\u65f6\u4efb\u52a1\u6bcf10\u5206\u949f\u6253\u5370\u4e00\u6b21KV\u3002</p> </li> <li> <p>start\uff1a\u542f\u52a8netty\u670d\u52a1remotingServer</p> </li> </ol> <p>\u8def\u7531\u7ba1\u7406</p> <p>namesrv\u7684\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u6ce8\u518c\u548c\u5220\u9664broke\uff0c\u5e76\u4e3a\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u63d0\u4f9btopic\u7684\u8def\u7531\u4fe1\u606f\u67e5\u8be2\u3002</p> <p>RouteInfoManager\u4fdd\u5b58\u7740\u6240\u6709\u7684\u8def\u7531\u4fe1\u606f\uff0c\u4f7f\u7528ReadWriteLock\u4fdd\u8bc1\u5e76\u53d1\u5b89\u5168\uff0c\u4e3b\u8981\u5305\u62ec\uff1a</p> <p>\u4e00\u4e2a\u96c6\u7fa4\u662f\u53ef\u4ee5\u5305\u542b\u591a\u4e2amaster broke</p> <pre><code>// \u4e3b\u8981\u5b58\u50a8topic\u548cbrokerName\nprivate final HashMap&lt;String/* topic */, List&lt;QueueData&gt;&gt; topicQueueTable;\n// \u4e3b\u8981\u5b58\u50a8brokerName\u548c\uff08cluster\uff0c\u591a\u4e2abrokerId/brokerAddr\uff09\nprivate final HashMap&lt;String/* brokerName */, BrokerData&gt; brokerAddrTable;\nprivate final HashMap&lt;String/* clusterName */, Set&lt;String/* brokerName */&gt;&gt; clusterAddrTable;\n// \u4e3b\u8981\u5b58\u50a8brokerAddr\u548clastUpdateTimestamp\nprivate final HashMap&lt;String/* brokerAddr */, BrokerLiveInfo&gt; brokerLiveTable;\nprivate final HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;\n</code></pre> <p></p> <p>\u5fc3\u8df3\u6ce8\u518c</p> <p>broke\u7aef\u5728\u542f\u52a8BrokerController.start()\u65f6\uff0c\u5148\u4f1a\u53d1\u51fa\u4e00\u4e2a\u6ce8\u518cbroke\u8bf7\u6c42\uff0c\u7136\u540e\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1\u4ee5\u540e\u6bcf30\u79d2\uff08\u53ef\u4ee5\u914d\u7f6e10\u79d2\uff5e60\u79d2\uff09\u53d1\u51fa\u6ce8\u518c\u8bf7\u6c42\u5230\u6240\u6709\u7684namesrv\u3002namesrv\u7684DefaultRequestProcessor\u8d1f\u8d23\u5904\u7406\u6240\u6709\u7684\u8bf7\u6c42\uff0c\u5982\u679c\u8bf7\u6c42\u6307\u4ee4\u662fREGISTER_BROKER\uff0c\u5c31\u8c03\u7528RouteInfoManager.registerBroker()\u66f4\u65b0broke\u5fc3\u8df3\u4fe1\u606f\uff0c\u9700\u8981\u83b7\u53d6\u5199\u9501\u624d\u80fd\u4fee\u6539\u3002</p> <p>\u8def\u7531\u5220\u9664</p> <p>NamesrvController\u542f\u52a8\u4e86\u4e00\u4e2a\u6bcf10\u79d2\u6267\u884c\u7684\u4efb\u52a1\uff0c\u904d\u5386brokerLiveTable\uff0c\u68c0\u6d4b\u6bcf\u4e2abroke\u7684\u4e0a\u6b21lastUpdateTimestamp\u5fc3\u8df3\u65f6\u95f4\uff0c\u5982\u679c\u5df2\u7ecf\u8d85\u8fc72\u5206\u949f\u672a\u66f4\u65b0\uff0c\u5c31\u5173\u95ed\u8fde\u63a5\uff0conChannelDestroy()\u66f4\u65b0\u5404\u4e2atable\u3002\u6ce8\u610f\u540c\u6837\u8981\u5148\u83b7\u53d6\u5199\u9501\u3002</p> <p>broke\u5728\u6b63\u5e38\u5173\u95ed\u65f6\u4f1a\u89e6\u53d1BrokerController.shutdown()\uff0c\u4f1a\u53d1\u51faunregisterBrokerAll()\u8bf7\u6c42\uff0cnamesrv\u7684DefaultRequestProcessor\u6536\u5230UNREGISTER_BROKER\u7684\u8bf7\u6c42\u6307\u4ee4\u540e\uff0c\u4f1a\u8c03\u7528RouteInfoManager.unregisterBroker()\u66f4\u65b0\u5404\u4e2atable\u3002</p> <p>\u8def\u7531\u53d1\u73b0</p> <p>DefaultRequestProcessor\u6536\u5230producer\u7684GET_ROUTEINFO_BY_TOPIC\u8bf7\u6c42\u6307\u4ee4\u540e\uff0c\u4f1a\u5728RouteInfoManager.pickupTopicRouteData()\u67e5\u627etopic\u5bf9\u5e94\u7684broke\u4fe1\u606f\u3002\u8981\u83b7\u53d6\u8bfb\u9501</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#producer","title":"producer\u670d\u52a1","text":""},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#producer_1","title":"producer\u7684\u542f\u52a8","text":"<ul> <li> <p>\u5f00\u53d1\u8005\u8bbe\u7f6eDefaultMQProducer\u7684NamesrvAddr\u5730\u5740\u540e\uff0c\u8c03\u7528start()\u3002</p> </li> <li> <p><code>this.setProducerGroup(withNamespace(this.producerGroup));</code>\uff0cproducerGroup\u662f\u5c06\u76f8\u540c\u89d2\u8272\u7684\u751f\u4ea7\u8005\u5f52\u4e3a\u4e00\u7ec4\uff0c\u5728\u53d1\u9001\u4e8b\u52a1\u6d88\u606f\u65f6\uff0c\u53ef\u4ee5\u5728\u4e00\u4e2a\u751f\u4ea7\u8005\u5b9e\u4f8b\u6302\u6389\u540e\uff0c\u76f8\u540cproducerGroup\u4e0b\u7684\u5176\u4ed6\u751f\u4ea7\u8005\u5b9e\u4f8b\u7ee7\u7eed\u540c\u4e00\u4e2a\u4e8b\u52a1\u7684commit\u6216rollback\uff0c\u4f46\u662f\u4e00\u822c\u6ca1\u5fc5\u8981\u3002</p> </li> <li> <p><code>this.defaultMQProducerImpl.start();</code> DefaultMQProducer\u7684\u529f\u80fd\u662f\u59d4\u6258\u7ed9DefaultMQProducerImpl\u7c7b:</p> </li> </ul> <p>\u4e3b\u8981\u662f\u542f\u52a8MQClientInstance\uff0c\u540c\u4e00\u4e2a\u8fdb\u7a0b\u53ea\u6709\u4e00\u4e2aMQClientInstance\uff0c\u6d88\u8d39\u8005\u548c\u751f\u4ea7\u8005\u5171\u4eab\u4e4b</p> <pre><code>public void start(final boolean startFactory) throws MQClientException {\n    switch (this.serviceState) {\n      case CREATE_JUST:\n            this.serviceState = ServiceState.START_FAILED;\n\n            // \u5148\u6821\u9a8cproducerGroup\u4e0d\u80fd\u4e3a\u7a7a\uff0c\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc7255\u4e2a\u5b57\u7b26\uff0c\u4e0d\u80fd\u6709\u7279\u6b8a\u5b57\u7b26\u7b49\u3002\n            this.checkConfig();\n\n            // \u8bbe\u7f6einstanceName\u4e3a\u8fdb\u7a0bPID\n            if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) {\n                this.defaultMQProducer.changeInstanceNameToPID();\n            }\n\n            // \u521b\u5efaMQClientInstance\uff0cclientId=IP@PID\uff0cMQClientInstance\u8d1f\u8d23broke\uff0cnamesrv\u901a\u4fe1\n            // \u540c\u4e00\u4e2a\u8fdb\u7a0b\u53ea\u6709\u4e00\u4e2aMQClientInstance\uff0c\u6d88\u8d39\u8005\u548c\u751f\u4ea7\u8005\u5171\u4eab\u4e4b\n            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);\n            // \u6ce8\u518c\u5f53\u524d\u751f\u4ea7\u8005\u5230MQClientInstance\uff0c\u53ef\u80fd\u6709\u591a\u4e2agroup\u7684producer\n            boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);\n            if (!registerOK) {\n                this.serviceState = ServiceState.CREATE_JUST;\n                throw new MQClientException();\n            }\n\n            // \u5411topic\u8def\u7531\u7f13\u5b58\u8868\u91cc\u6dfb\u52a0\u4e00\u4e2a\u9ed8\u8ba4topic\uff0c\u8fd9\u4e2a\u5728\u53d1\u9001\u91cc\u4f1a\u63d0\u5230\n            this.topicPublishInfoTable.put(this.defaultMQProducer.getCreateTopicKey(), new TopicPublishInfo());\n\n            if (startFactory) {\n                // \u542f\u52a8MQClientInstance,\u5f88\u591a\u91cd\u8981\u903b\u8f91\u5728\u91cc\u9762\uff0c\u5982\u5f00\u542f\u6bcf30\u79d2\u66f4\u65b0\u8def\u7531\u4fe1\u606f\u8868\u7684\u5b9a\u65f6\u4efb\u52a1\uff0c\u7b49\u7b49\u7b49\u7b49\u3002\u3002\u3002\n                mQClientFactory.start();\n            }\n\n            log.info(\"the producer [{}] start OK\");\n            // \u6807\u8bb0\u4e3a\u8fd0\u884c\u4e2d\uff0c\u9632\u6b62\u91cd\u590d\u542f\u52a8\n            this.serviceState = ServiceState.RUNNING;\n            break;\n            // \u8fd9\u91cc\u5e94\u8be5\u662f\u7528\u6765\u5224\u65ad\u91cd\u590d\u542f\u52a8\n        case RUNNING:\n        case START_FAILED:\n        case SHUTDOWN_ALREADY:\n            throw new MQClientException(\"The producer service state not OK, maybe started once\");\n        default:\n            break;\n    }\n  // \u53d1\u9001\u5fc3\u8df3\u4fe1\u606f\u5230\u6240\u6709\u7684broke\uff0c\u4e3a\u4ec0\u4e48\uff1f\n    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n\n    this.timer.scheduleAtFixedRate(new TimerTask() {\n        @Override\n        public void run() {\n            try {\n                RequestFutureTable.scanExpiredRequest();\n            } catch (Throwable e) {\n                log.error(\"scan RequestFutureTable exception\", e);\n            }\n        }\n    }, 1000 * 3, 1000);\n}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_4","title":"\u6d88\u606f\u7684\u53d1\u9001","text":"<p>producer\u63d0\u4f9b\u4e86\u540c\u6b65\u53d1\u9001\uff0c\u5f02\u6b65\u53d1\u9001\uff0csendOneWay\u4e09\u79cd\u65b9\u5f0f\uff0c\u53e6\u5916\u53ef\u4ee5\u6307\u5b9aMessageQueue\u548c\u9009\u62e9\u7b56\u7565\uff0ctimeout\uff0c\u6279\u91cf\u53d1\u9001\u6d88\u606f\u3002</p> <p></p> <p>\u6d88\u606f\u7684\u4e09\u79cd\u53d1\u9001\u65b9\u5f0f\u6700\u7ec8\u90fd\u662f\u59d4\u6258\u7ed9\u4e86<code>DefaultMQProducerImpl.private SendResult sendDefaultImpl(Message msg,final CommunicationMode communicationMode, final SendCallback sendCallback,final long timeout)</code>\uff0ctimeout\u9ed8\u8ba43\u79d2</p> <p>\u5176\u4e2dmessage\u7684\u7ed3\u6784\u548c\u5c5e\u6027\u5982\u4e0b\uff1a</p> <p></p> <pre><code>Message{topic='juTopic', flag=0, properties={UNIQ_KEY=7F0000010DA418B4AAC2992744CA0000, WAIT=true, TAGS=TagA}, body=[72, 101, 108, 108, 97, 32, 52], transactionId='null'}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#1","title":"1. \u6d88\u606f\u6821\u9a8c","text":"<p>\u5982topicName\u4e0d\u80fd\u5305\u542b\u7279\u6b8a\u5b57\u7b26\uff0c\u4e0d\u80fd\u662f\u7cfb\u7edf\u4f7f\u7528\u7684SCHEDULE_TOPIC_XXXX\uff0c\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc7127\u4e2a\u5b57\u7b26\uff1b\u6d88\u606f\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a\uff0c\u4e0d\u80fd\u5927\u4e8e4M</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#2-topic","title":"2. \u67e5\u627etopic\u8def\u7531","text":"<p>DefaultMQProducerImpl.topicPublishInfoTable\u7f13\u5b58\u4e86\u6240\u6709topic\u7684\u8def\u7531\u4fe1\u606f\uff1a</p> <pre><code>// \u6bcf\u4e2atopic\u5bf9\u5e94\u7684\u8def\u7531\u4fe1\u606f\npublic class TopicPublishInfo {\n    private boolean orderTopic = false;\n    private boolean haveTopicRouterInfo = false;\n    // MessageQueue\uff0c\u53d1\u9001\u65f6\u5176\u5b9e\u5c31\u6307\u5b9a\u4e86\u54ea\u4e2aMessageQueue\n    private List&lt;MessageQueue&gt; messageQueueList = new ArrayList&lt;MessageQueue&gt;();\n    private volatile ThreadLocalIndex sendWhichQueue = new ThreadLocalIndex();\n    // namesrv\u8fd4\u56de\u7684\u539f\u59cb\u8def\u7531\u4fe1\u606f\uff0c\n    private TopicRouteData topicRouteData;\n}\n</code></pre> <p>\u53d1\u9001\u6d88\u606f\u65f6\u5148\u53bb\u67e5\u7f13\u5b58Table\uff0c\u6709\u5219\u8fd4\u56de\uff0c\u67e5\u8be2\u4e0d\u5230\u5c31\u59d4\u6258MQClientInstance\u53bbnamesrv\u53bb\u83b7\u53d6topic\u5bf9\u5e94\u7684\u8def\u7531\u4fe1\u606f\uff0c\u66f4\u65b0\u672c\u5730\u7f13\u5b58\u8def\u7531\u8868\u3002</p> <p>\u53e6\u5916<code>MQClientInstance.startScheduledTask()</code>\u8fd8\u4f1a\u6bcf30\u79d2\u4ecenamesrv\u66f4\u65b0\u5f53\u524d\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u5173\u5fc3\u7684topic\u8def\u7531\u4fe1\u606f</p> <pre><code>for (String topic : topicList) {\n    // \u5faa\u73af\u66f4\u65b0\u6bcf\u4e2atopic\u4fe1\u606f\n    this.updateTopicRouteInfoFromNameServer(topic);\n}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#3-messagequeue","title":"3. \u9009\u62e9\u8981\u53d1\u9001\u7684MessageQueue","text":"<p>\u9ed8\u8ba4\u7684\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662fThreadLocal\u4fdd\u5b58\u4e00\u4e2aInteger\uff0c\u6bcf\u6b21\u53d1\u9001\u9012\u589e1\uff0c\u53d6\u6a21topic\u8def\u7531\u91cc\u7684MessageQueue\uff0c\u5373\u6bcf\u6b21\u53d1\u9001\u65f6\u904d\u5386MessageQueue\u9009\u62e9\u4e00\u4e2a\u3002\u5982\u679c\u5c5e\u4e8e\u91cd\u8bd5\uff0c\u4e0d\u4f7f\u7528\u4e0a\u6b21\u5931\u8d25\u7684lastBrokerName\uff0c\u8fd9\u662f\u9ed8\u8ba4\u60c5\u51b5\u3002</p> <pre><code>public MessageQueue selectOneMessageQueue() {\n        int index = this.sendWhichQueue.getAndIncrement();\n        // \u641e\u4e00\u4e2aindex\uff0c\u6bcf\u6b21\u9012\u589e\uff0c\u53d6\u6a21messageQueue\u957f\u5ea6\uff0c\u5176\u5b9e\u5c31\u662f\u904d\u5386messageQueue\u4e86\n        int pos = Math.abs(index) % this.messageQueueList.size();\n        if (pos &lt; 0)\n            pos = 0;\n        return this.messageQueueList.get(pos);\n}\n</code></pre> <p>\u5982\u679c\u5f00\u542fsendLatencyFaultEnable\uff0c\u5219\u6839\u636e\u7ef4\u62a4\u4e86\u53d1\u9001brakeName\u5931\u8d25\u8fc7\u7684latencyFaultTolerance\u9009\u62e9\u4e00\u4e2a\u6ca1\u6709\u53d1\u9001\u5931\u8d25\u8fc7\u6216\u8005\u76f8\u5bf9\u8f83\u597d\u7684MessageQueue\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#4","title":"4. \u53d1\u9001\u6d88\u606f","text":"<p>sendKernelImpl()\u662f\u53d1\u9001\u6d88\u606f\u7684\u5185\u6838\u5b9e\u73b0\uff0c\u51c6\u5907\u4e00\u4e9b\u6d88\u606f\u53d1\u9001\u7684\u51c6\u5907\u5de5\u4f5c\uff1a\u5982createUniqID()\u751f\u6210\u6d88\u606f\u552f\u4e00uni_key\uff1b\u538b\u7f29\u8d85\u8fc74K\u7684\u6d88\u606f\uff1b\u6267\u884c\u6d88\u606f\u53d1\u9001\u7981\u6b62\u7684\u94a9\u5b50<code>this.executeCheckForbiddenHook()</code>\uff1b\u53d1\u9001\u6d88\u606f\u65f6\u7684\u94a9\u5b50<code>this.executeSendMessageHookBefore(context);</code>;</p> <p>MQClientAPIImpl()\u6700\u7ec8\u8d1f\u8d23\u53d1\u9001\u6d88\u606f</p> <p>\u6279\u91cf\u53d1\u9001\u6d88\u606f\u662f\u5c06\u5c5e\u4e8e\u540c\u4e00\u4e2atopic\u7684\u6d88\u606f\u4e00\u8d77\u6253\u5305\u53d1\u9001\uff0c\u51cf\u5c11\u7f51\u7edc\u4f20\u8f93\u6b21\u6570\uff0c\u8fd9\u8981\u4f9d\u636e\u5355\u6761\u6d88\u606f\u7684\u957f\u5ea6\uff0c\u603b\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc74M\u3002\u6279\u91cf\u53d1\u9001\u6d88\u606f\u4e5f\u5c31\u662f\u5148\u5c06\u6d88\u606f\u8fdb\u884c\u6253\u5305,\u7136\u540e\u8c03\u7528\u7684\u65b9\u6cd5\u548c\u666e\u901a\u7684\u6d88\u606f\u662f\u4e00\u6837\u7684this.defaultMQProducerImpl.send(batch(msgs), timeout)\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#broke","title":"broke\u670d\u52a1","text":"<p>\u628adistribution/conf\u4e0b\u7684broke.conf, logback_broke.xml\u62f7\u8d1d\u65b0\u521b\u5efa\u7684conf\u6587\u4ef6\u5939\u4e0b\uff1b\u5728idea\u4e2d\u914d\u7f6e\u73af\u5883\u53d8\u91cf<code>ROCKETMQ_HOME=/Users/wangjun/work/code/github/rocketmq</code>\u548c\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\u5730\u5740<code>-c /Users/wangjun/work/code/github/rocketmq/conf/broker.conf</code>\u7136\u540e\u542f\u52a8\u5373\u53ef\u3002</p> <p>Broker\u4e3b\u8981\u8d1f\u8d23\u6d88\u606f\u7684\u5b58\u50a8\u3001\u6295\u9012\u548c\u67e5\u8be2\u4ee5\u53ca\u670d\u52a1\u9ad8\u53ef\u7528\u4fdd\u8bc1\uff0c\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e9b\u529f\u80fd\uff0cBroker\u5305\u542b\u4e86\u4ee5\u4e0b\u51e0\u4e2a\u91cd\u8981\u5b50\u6a21\u5757\u3002</p> <ol> <li>Remoting Module\uff1a\u6574\u4e2aBroker\u7684\u5b9e\u4f53\uff0c\u8d1f\u8d23\u5904\u7406\u6765\u81eaclients\u7aef\u7684\u8bf7\u6c42\u3002</li> <li>Client Manager\uff1a\u8d1f\u8d23\u7ba1\u7406\u5ba2\u6237\u7aef(Producer/Consumer)\u548c\u7ef4\u62a4Consumer\u7684Topic\u8ba2\u9605\u4fe1\u606f</li> <li>Store Service\uff1a\u63d0\u4f9b\u65b9\u4fbf\u7b80\u5355\u7684API\u63a5\u53e3\u5904\u7406\u6d88\u606f\u5b58\u50a8\u5230\u7269\u7406\u786c\u76d8\u548c\u67e5\u8be2\u529f\u80fd\u3002</li> <li>HA Service\uff1a\u9ad8\u53ef\u7528\u670d\u52a1\uff0c\u63d0\u4f9bMaster Broker \u548c Slave Broker\u4e4b\u95f4\u7684\u6570\u636e\u540c\u6b65\u529f\u80fd\u3002</li> <li>Index Service\uff1a\u6839\u636e\u7279\u5b9a\u7684Message key\u5bf9\u6295\u9012\u5230Broker\u7684\u6d88\u606f\u8fdb\u884c\u7d22\u5f15\u670d\u52a1\uff0c\u4ee5\u63d0\u4f9b\u6d88\u606f\u7684\u5feb\u901f\u67e5\u8be2\u3002</li> </ol> <p></p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_5","title":"\u542f\u52a8\u6d41\u7a0b","text":"<p>\u7c7b\u4f3c\u4e8enamesrv\u7684\u542f\u52a8</p> <ol> <li>\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u521b\u5efaBrokerController\uff1a\u914d\u7f6e\u7c7b\u6709brokerConfig\uff0cnettyServerConfig\uff0cnettyClientConfig\uff0cmessageStoreConfig\uff0c\u52a0\u8f7d\u547d\u4ee4\u884c\u6307\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u6216\u5c5e\u6027</li> <li>\u521d\u59cb\u5316\uff1a</li> <li>\u542f\u52a8\uff1a</li> <li>\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1\u7ebf\u7a0b\u6c60\uff0c\u6bcf30\u79d2\uff08\u9ed8\u8ba4\uff09\u53bb\u6ce8\u518cbroke\u5230\u6240\u6709\u7684namesrv</li> </ol>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_6","title":"\u6d88\u606f\u5b58\u50a8\u6d41\u7a0b","text":"<p>\u4e3b\u8981\u903b\u8f91\u5728rocket-store\u91cc\u7684DefaultMessageStore\u7c7b\u91cc\u3002</p> <p>\u67e5\u770bDefaultMessageStore\u5b9e\u73b0\u7684MessageStore\u63a5\u53e3\u53ef\u4ee5\u770b\u51fa\u63d0\u4f9b\u4e86\u54ea\u4e9b\u529f\u80fd\uff0c\u9700\u8981\u4ed4\u7ec6\u770b\u770b\uff0c\u4ee5\u7406\u89e3DefaultMessageStore\u3002</p> <ul> <li>putMessages(), </li> <li>asyncPutMessage(),</li> <li>getMaxOffsetInQueue(), </li> <li>getMinOffsetInQueue(),</li> <li>long getCommitLogOffsetInQueue(final String topic, final int queueId, final long consumeQueueOffset);</li> <li>long getOffsetInQueueByTime(final String topic, final int queueId, final long timestamp);</li> <li>MessageExt lookMessageByOffset(final long commitLogOffset); </li> </ul> <p>\u6d88\u606f\u5b58\u50a8\u7684\u6700\u7ec8\u5165\u53e3\u65b9\u6cd5\u662fDefaultMessageStore\u7684 <code>Result putMessage(MessageExtBrokerInner msg)</code> \u65b9\u6cd5\u3002\u5165\u53c2\u63a5\u53d7\u7684\u6d88\u606f\u7c7bMessageExtBrokerInner\u76f8\u6bd4MessageExt\u591a\u4e86propertiesString\uff0ctagsCode\u4e24\u4e2a\u5c5e\u6027</p> <pre><code>/**\n* \u6d88\u606f\u5904\u7406\u7684\u91cd\u8981\u65b9\u6cd5\n*/\n@Override\npublic PutMessageResult putMessage(MessageExtBrokerInner msg) {\n    // check \u4e0d\u80fd\u662fslave\u7ed3\u70b9\uff0c\u78c1\u76d8\u662f\u5426\u53ef\u5199\uff0cpageCache\u662f\u5426busy\n    PutMessageStatus checkStoreStatus = this.checkStoreStatus();\n    if (checkStoreStatus != PutMessageStatus.PUT_OK) {\n        return new PutMessageResult(checkStoreStatus, null);\n    }\n\n    // check topic\u4e0d\u80fd\u8d85\u8fc7127\u4e2a\u5b57\u7b26, message.PropertiesString\u4e0d\u80fd\u5927\u4e8e32767\u4e2a\u5b57\u7b26\n    PutMessageStatus msgCheckStatus = this.checkMessage(msg);\n    if (msgCheckStatus == PutMessageStatus.MESSAGE_ILLEGAL) {\n        return new PutMessageResult(msgCheckStatus, null);\n    }\n\n    // \u4ea4\u7ed9commitLog\uff01\uff01\uff01\uff01\n    PutMessageResult result = this.commitLog.putMessage(msg);\n\n    // \u8bb0\u5f55\u4e0bputMessage\u8017\u65f6\u548c\u5931\u8d25\u6b21\u6570 \uff0c\u7701\u7565\u3002\u3002\u3002\n\n    return result;\n}\n</code></pre> <p>commitLog\u8d1f\u8d23\u6d88\u606f\u7684\u78c1\u76d8\u5199\u5165\uff0cHA\u540c\u6b65\u7b49\uff0c\u4e0a\u9762\u8c03\u7528commitLog.putMessage(msg)\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u5982\u679c\u662f\u5ef6\u65f6\u6d88\u606f\uff0c\u590d\u5199topic\u4e3aSCHEDULE_TOPIC_XXXX\uff0cqueueId\u5bf9\u5e94\u5176\u5ef6\u65f6\u7b49\u7ea7\uff1b</p> </li> <li> <p>\u7136\u540e\u83b7\u53d6putMessageLock\u7684\u9501\uff0c\u8fd9\u91cc\u7684\u9501\u6709\u4e24\u79cd\u5b9e\u73b0\uff0cReentrantLock\u6216\u8005\u81ea\u65cb\u9501\uff08\u57fa\u4e8eCAS\uff09\uff0c\u81ea\u65cb\u9501\u53ef\u4ee5\u5728\u7ade\u4e89\u5c11\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u3002\u4e5f\u5c31\u662f\u8bf4\u4e0b\u9762\u7684\u5199\u5165\u7f13\u51b2\u533a\u64cd\u4f5c\u662f\u4e00\u4e2a\u540c\u6b65\u64cd\u4f5c</p> </li> <li> <p>\u83b7\u53d6\u6216\u65b0\u5efamappedFile\uff0cMappedFileQueue\u5bf9\u5e94commitLog\u6587\u4ef6\uff0c\u6301\u6709mappedFile</p> </li> </ul> <p>\u5229\u7528\u7684\u662fByteBuffer\u5806\u5916\u7f13\u51b2\u533a\uff0cdoAppend\u8ffd\u52a0\u6d88\u606f\u6bd4\u8f83\u590d\u6742\uff1a</p> <p>\u627e\u5230byteBuffer\u7684\u5199\u5165\u4f4d\u7f6e\uff0c</p> <p>\u751f\u6210msgId, </p> <p>\u83b7\u53d6\u6d88\u606f\u5176topic-queueId\u627e\u5230\u5176\u5bf9\u5e94\u7684queueOffset\u3002\u5982\u679c\u662f\u4e8b\u52a1\u6d88\u606f\u4e14\u72b6\u6001\u662fPrepared\u6216Rollback\uff0c\u5c31\u4e0d\u5b58\u5165consumer queue\uff0c</p> <p>\u7136\u540e\u62fc\u63a5\u6d88\u606f\uff0c\u5982TOTALSIZE\uff0cBODYCRC\uff0cQUEUEID\uff0cQUEUEOFFSET\uff0cBORNHOST\uff0cSTORETIMESTAMP\uff0cRECONSUMETIMES\uff0c\u5f53\u7136\u6709\u6d88\u606f\u5185\u5bb9BODY\uff0cTOPIC\uff0cpropertiesData\u7b49\u7b49\uff0c\u6700\u540e\u8c03\u7528<code>byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen);</code>\u5199\u5165\u5230\u5185\u5b58\u7f13\u51b2\u533a\u4e2d</p> <pre><code>/**\n* ==========================================================\n* \u5b58\u50a8\u6d88\u606f\u7684\u91cd\u8981\u6d41\u7a0b\u65b9\u6cd5\n*/\npublic PutMessageResult putMessage(final MessageExtBrokerInner msg) {\n    // \u8bbe\u7f6eStoreTimestamp\u548cBodyCRC\u5c5e\u6027\n    msg.setStoreTimestamp(System.currentTimeMillis());\n    msg.setBodyCRC(UtilAll.crc32(msg.getBody()));\n\n    AppendMessageResult result = null;\n    StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();\n    String topic = msg.getTopic();\n    int queueId = msg.getQueueId();\n    final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());\n\n    // \u5982\u679c\u662f\u5ef6\u8fdf\u6d88\u606f \u5148\u5224\u65ad\u5982\u679c\u4e0d\u662f\u4e8b\u52a1\u6d88\u606f\u6216\u8005\u662fcommit\u6d88\u606f\u7c7b\u578b\n    if (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) {\n        // Delay Delivery\n        if (msg.getDelayTimeLevel() &gt; 0) {\n            // \u5bb9\u9519\u5904\u7406\uff0c\u4e0d\u80fd\u8d85\u8fc7\u6700\u5927\u5ef6\u8fdf\u7b49\u7ea7\n            if (msg.getDelayTimeLevel() &gt; this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) {\n                msg.setDelayTimeLevel(this.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());\n            }\n            // \uff01\uff01\uff01\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u662f\u5ef6\u8fdf\u6d88\u606f\uff0c\u66f4\u6539topic\u4e3aSCHEDULE_TOPIC_XXXX\n            topic = TopicValidator.RMQ_SYS_SCHEDULE_TOPIC;\n            // \u6bcf\u4e2adelayLevel\u5bf9\u5e94\u4e00\u4e2aqueue\n            queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());\n\n            // Backup real topic, queueId \u8bb0\u5f55\u4e0b\u539f\u59cb\u7684topic\u548cqueueID\uff0c\u4ee5\u4fbf\u5728\u5230\u671f\u6295\u9012\u65f6\u4f7f\u7528\n            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());\n            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));\n            msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));\n            msg.setTopic(topic);\n            msg.setQueueId(queueId);\n        }\n    }\n\n    MappedFile unlockMappedFile = null;\n    MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();\n\n    // !!! \u8fd9\u91cc\u5b58\u50a8\u6d88\u606f\u524d\u8981\u5148\u52a0\u9501\uff0c\u8fd9\u91cc\u7684\u9501\u6709\u4e24\u79cd\u5b9e\u73b0ReentrantLock\u6216\u8005\u81ea\u65cb\u9501\uff08\u57fa\u4e8eCAS\uff09\uff0c\u81ea\u65cb\u9501\u53ef\u4ee5\u5728\u7ade\u4e89\u5c11\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\n    putMessageLock.lock(); //spin or ReentrantLock ,depending on store config\n    try {\n        long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();\n        this.beginTimeInLock = beginLockTimestamp;\n\n        // Here settings are stored timestamp, in order to ensure an orderly global\n        // \u4e0a\u9762\u5df2\u7ecf\u8bbe\u7f6e\u4e86\u4e00\u6b21StoreTimestamp\uff0c\u8fd9\u91cc\u662f\u62ff\u5230\u9501\u4ee5\u540e\u53c8\u8bbe\u7f6e\u4e00\u6b21\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5168\u5c40\u6709\u5e8f\n        msg.setStoreTimestamp(beginLockTimestamp);\n\n        if (null == mappedFile || mappedFile.isFull()) {\n            // \u5982\u679cmappedFile\u4e3a\u7a7a\u6216\u8005\u6ee1\u4e86\uff0c\u5c31\u65b0\u521b\u5efa\u4e00\u4e2a\n            mappedFile = this.mappedFileQueue.getLastMappedFile(0); // Mark: NewFile may be cause noise\n        }\n        if (null == mappedFile) {\n            log.error(\"create mapped file1 error\");\n            beginTimeInLock = 0;\n            return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, null);\n        }\n\n        // \u5229\u7528appendMessageCallback\u53bb\u8ffd\u52a0\u6d88\u606f\u5230commitLog\n        result = mappedFile.appendMessage(msg, this.appendMessageCallback);\n        switch (result.getStatus()) {\n            case PUT_OK:\n                break;\n            case END_OF_FILE:\n                unlockMappedFile = mappedFile;\n                // Create a new file, re-write the message\n                mappedFile = this.mappedFileQueue.getLastMappedFile(0);\n                if (null == mappedFile) {\n                    // XXX: warn and notify me\n                    log.error(\"create mapped file2 error\");\n                    beginTimeInLock = 0;\n                    return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);\n                }\n                result = mappedFile.appendMessage(msg, this.appendMessageCallback);\n                break;\n            case MESSAGE_SIZE_EXCEEDED:\n            case PROPERTIES_SIZE_EXCEEDED:\n                beginTimeInLock = 0;\n                return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);\n            case UNKNOWN_ERROR:\n                beginTimeInLock = 0;\n                return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);\n            default:\n                beginTimeInLock = 0;\n                return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);\n        }\n    } finally {\n        putMessageLock.unlock();\n    }\n\n    if (elapsedTimeInLock &gt; 500) {\n        // \u5982\u679c\u4fdd\u5b58\u6d88\u606f\u8d85\u8fc7500ms\uff0c\u63d0\u9192\u4e00\u4e0b\n        log.warn(\"[NOTIFYME]putMessage in lock cost time(ms)={});\n    }\n\n    if (null != unlockMappedFile &amp;&amp; this.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) {\n        this.defaultMessageStore.unlockMappedFile(unlockMappedFile);\n    }\n\n    PutMessageResult putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result);\n\n    // Statistics\u7edf\u8ba1\u6570\u636e\uff0c\u6bcf\u4e2atopic\u53d1\u4e86\u591a\u5c11\u6761\u6d88\u606f\uff0c\u6d88\u606f\u603b\u5171\u6709\u6709\u591a\u5927\u4e86\n    storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();\n    storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());\n\n    // \u5904\u7406\u540c\u6b65\u5237\u76d8\u8fd8\u662f\u5f02\u6b65\u5237\u76d8\n    handleDiskFlush(result, putMessageResult, msg);\n    // \u5904\u7406\u540c\u6b65\u4e3b\u4ece\u590d\u5236\u8fd8\u662f\u5f02\u6b65\n    handleHA(result, putMessageResult, msg);\n\n    return putMessageResult;\n}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#consumequeueindexfile","title":"\u5206\u53d1\u6d88\u606f\u5230consumequeue\u6587\u4ef6\u548cIndexFile\u6587\u4ef6","text":"<p>\u6587\u4ef6\u653e\u5165\u5230commitLog\u540e\uff0c\u8981\u5b9e\u65f6\u66f4\u65b0\u901a\u77e5consumequeue\u6587\u4ef6\u548cIndexFile\u6587\u4ef6\uff0c\u8fd9\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u5462\uff1f</p> <p>DefaultMessageStore\u542f\u52a8\u65f6\u5f00\u542f\u4e86\u4e00\u4e2aReputMessageService\u7ebf\u7a0b\u4efb\u52a1\uff0c\u5b83\u4e0d\u505c\u7684\u6bcf\u96941ms\u5faa\u73af\u7684doReput()\uff0c\u5229\u7528reputFromOffset\u8bb0\u5f55\u4e0a\u6b21\u5728commitLog\u6d88\u8d39\u7684\u4f4d\u7f6e\uff0c\u4e0d\u505c\u7684\u4ececommitLog\u8bfb\u53d6\u6d88\u606f\u8fdb\u884c\u5206\u53d1\u3002dispatcherList\u91cc\u5206\u53d1\u7684\u5bf9\u8c61\u5373\u4e3aConsumeQueue\u548cIndex\uff0c\u4f9d\u6b21\u5c06\u6bcf\u4e2a\u6d88\u606f\u8f6c\u53d1\u7ed9ConsumeQueueService\u548cIndexService\u3002</p> <p>IndexService\u4e3a\u6d88\u606f\u521b\u5efaUniqKey\uff0c\u5e76\u4e3a\u6bcf\u4e2akey\u90fd\u521b\u5efa\u7d22\u5f15\uff0c\u683c\u5f0f\u5982topic + \"#\" + key\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a\u6d88\u606f\u4f1a\u521b\u5efa\u591a\u4e2a\u7d22\u5f15</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_7","title":"\u6d88\u606f\u5237\u76d8","text":"<p>rocketMQ\u7684\u6d88\u606f\u5b58\u50a8\u5230\u78c1\u76d8\u662f\u57fa\u4e8eJava NIO\u7684\u5185\u5b58\u6620\u5c04\u673a\u5236MappedByteBuffer\uff0c\u5b58\u50a8\u65f6\u662f\u5148\u5c06\u6d88\u606f\u8ffd\u52a0\u5230\u5185\u5b58\uff0c\u7136\u540e\u540c\u6b65\u6216\u5f02\u6b65\u7684\u5237\u5199\u5230\u78c1\u76d8</p> <p></p> <p>(1) \u540c\u6b65\u5237\u76d8\uff1a\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u53ea\u6709\u5728\u6d88\u606f\u771f\u6b63\u6301\u4e45\u5316\u81f3\u78c1\u76d8\u540eRocketMQ\u7684Broker\u7aef\u624d\u4f1a\u771f\u6b63\u8fd4\u56de\u7ed9Producer\u7aef\u4e00\u4e2a\u6210\u529f\u7684ACK\u54cd\u5e94\u3002\u540c\u6b65\u5237\u76d8\u5bf9MQ\u6d88\u606f\u53ef\u9760\u6027\u6765\u8bf4\u662f\u4e00\u79cd\u4e0d\u9519\u7684\u4fdd\u969c\uff0c\u4f46\u662f\u6027\u80fd\u4e0a\u4f1a\u6709\u8f83\u5927\u5f71\u54cd\uff0c\u4e00\u822c\u9002\u7528\u4e8e\u91d1\u878d\u4e1a\u52a1\u5e94\u7528\u8be5\u6a21\u5f0f\u8f83\u591a\u3002</p> <p>(2) \u5f02\u6b65\u5237\u76d8\uff1a\u80fd\u591f\u5145\u5206\u5229\u7528OS\u7684PageCache\u7684\u4f18\u52bf\uff0c\u53ea\u8981\u6d88\u606f\u5199\u5165PageCache\u5373\u53ef\u5c06\u6210\u529f\u7684ACK\u8fd4\u56de\u7ed9Producer\u7aef\u3002\u6d88\u606f\u5237\u76d8\u91c7\u7528\u540e\u53f0\u5f02\u6b65\u7ebf\u7a0b\u63d0\u4ea4\u7684\u65b9\u5f0f\u8fdb\u884c\uff0c\u964d\u4f4e\u4e86\u8bfb\u5199\u5ef6\u8fdf\uff0c\u63d0\u9ad8\u4e86MQ\u7684\u6027\u80fd\u548c\u541e\u5410\u91cf\u3002</p> <p>\u4e00\u822cbroke\u91c7\u7528\u591aMaster\u591aSlave\u6a21\u5f0f-\u5f02\u6b65\u590d\u5236\uff0c\u5373\u6bcf\u4e2aMaster\u914d\u7f6e\u4e00\u4e2aSlave\uff0c\u6709\u591a\u5bf9Master-Slave\uff0cHA\u91c7\u7528\u5f02\u6b65\u590d\u5236\u65b9\u5f0f\uff0c\u4e3b\u5907\u6709\u77ed\u6682\u6d88\u606f\u5ef6\u8fdf\uff08\u6beb\u79d2\u7ea7\uff09\u3002\u5982\u679cmaster\u78c1\u76d8\u635f\u574f\u4f1a\u4e22\u5931\u5c11\u91cf\u6d88\u606f\u3002\u5982\u679cmaster\u5b95\u673a\uff0c\u4ecd\u7136\u53ef\u4eceslave\u6d88\u8d39\u3002</p> <p>\u6839\u636e\u6d88\u606f\u7684topic\u548cqueueId\u627e\u5230\u5bf9\u5e94\u7684ConsumeQueue\uff0c\u7ec4\u88c5\u90a320\u4e2a\u5b57\u8282\uff0c\u5199\u5165ByteBuffer\u3002\u53ea\u8ffd\u52a0\u5230\u7269\u7406\u6587\u4ef6\u7684\u5185\u5b58\u6620\u5c04\u4e2d\uff0cConsumeQueue\u56fa\u5b9a\u4e3a\u5f02\u6b65\u5237\u76d8\u3002</p> <p>index File\u7684\u5237\u76d8\u662f\u6bcf\u5f53\u66f4\u65b0\u7d22\u5f15\u65f6\u5c06\u4e0a\u4e00\u6b21\u7684\u6539\u52a8\u5237\u5199\u5230\u78c1\u76d8\u3002ConsummerQueue\u662f\u56fa\u5b9a\u7684\u5f02\u6b65\u5237\u76d8\u3002</p> <p>\u8ffd\u52a0\u6d88\u606f\u5230commitLog\u540e\uff0c\u5904\u7406\u6d88\u606f\u5237\u76d8\u548cHA\u540c\u6b65\uff0c\u5982\u4e0b\uff1a</p> <pre><code>// \u5904\u7406\u5237\u76d8\npublic void handleDiskFlush(AppendMessageResult result, PutMessageResult putMessageResult, MessageExt messageExt) {\n    // Synchronization flush \u5982\u679c\u662f\u540c\u6b65\u5237\u76d8\n    if (FlushDiskType.SYNC_FLUSH == this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {\n        // GroupCommitService\u8d1f\u8d23\u8fdb\u884c\u5237\u76d8\n        final GroupCommitService service = (GroupCommitService) this.flushCommitLogService;\n        // \u5982\u679cproducer\u8bbe\u7f6e\u6d88\u606fWaitStoreMsgOK\uff0c\u8fd8\u8981\u7b49\u5f85\u5237\u76d8OK\u6210\u529f\u624d\u8fd4\u56de\u7ed9producer\u7aef\uff0c\u8fd9\u6837\u6700\u5b89\u5168\u4f46\u662f\u4e5f\u66f4\u6162\n        if (messageExt.isWaitStoreMsgOK()) {\n            GroupCommitRequest request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n            // \u6dfb\u52a0\u5237\u76d8\u8bf7\u6c42\uff08\u540e\u53f0\u5faa\u73af\u6bcf\u969410\u6beb\u79d2\u6279\u91cf\u5237\u76d8\u300210\u6beb\u79d2\u4e2d\u5982\u679c\u6709\u591a\u4e2a\u8bf7\u6c42\uff0c\u5219\u591a\u4e2a\u8bf7\u6c42\u4e00\u5757\u5237\u76d8\uff09\n            service.putRequest(request);\n            CompletableFuture&lt;PutMessageStatus&gt; flushOkFuture = request.future();\n            PutMessageStatus flushStatus = null;\n            try {\n                // 5\u79d2\u8d85\u65f6\n                flushStatus = flushOkFuture.get(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout(),\n                                                TimeUnit.MILLISECONDS);\n            } catch (InterruptedException | ExecutionException | TimeoutException e) {\n                //flushOK=false;\n            }\n            if (flushStatus != PutMessageStatus.PUT_OK) {\n                log.error(\"do groupcommit, wait for flush failed, topic: \" + messageExt.getTopic() + \" tags: \" + messageExt.getTags()\n                          + \" client address: \" + messageExt.getBornHostString());\n                putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);\n            }\n        } else {\n            // \u5982\u679c\u6ca1\u6709\u8bbe\u7f6eWaitStoreMsgOK\uff0c\u90a3\u5c31\u662f\u53ea\u8981\u540c\u6b65\u5237\u76d8\u5c31\u597d\u4e86\uff1f\u4e5f\u5c31\u662f\u4e07\u4e00\u540c\u6b65\u5237\u76d8\u5931\u8d25\u4e86\uff0cproducer\u4e5f\u4e0d\u77e5\u9053\u3002\n            service.wakeup();\n        }\n    }\n    // Asynchronous flush\n    else {\n        if (!this.defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) {\n            flushCommitLogService.wakeup();\n        } else {\n            commitLogService.wakeup();\n        }\n    }\n}\n</code></pre> <p>\u5f02\u6b65\u5237\u76d8\u65f6\uff0c\u5148\u5c06\u6d88\u606f\u5199\u5165\u5230\u5806\u5916\u5185\u5b58\uff0c\u7136\u540e\u7531CommitRealTimeService\u6bcf200\u6beb\u79d2\u5199\u5165\u5230commitLog\u5bf9\u5e94\u7684ByteBuffer\u4e2d\uff0c\u7136\u540eFlushRealTimeService\u6bcf500\u6beb\u79d2\u5237\u5165\u78c1\u76d8\u3002</p> <p>HA\u540c\u6b65</p> <p>broke_role\u6709\u4e09\u79cd\uff0cASYNC_MASTER\uff0cSYNC_MASTER\uff0cSLAVE</p> <pre><code>public void handleHA(AppendMessageResult result, PutMessageResult putMessageResult, MessageExt messageExt) {\n    if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) {\n        HAService service = this.defaultMessageStore.getHaService();\n        // \u5982\u679c\u5f00\u59cbWaitStoreMsgOK\uff0c\u624d\u540c\u6b65\uff1f\uff1f\n        if (messageExt.isWaitStoreMsgOK()) {\n            // Determine whether to wait\n            if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) {\n                GroupCommitRequest request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());\n                service.putRequest(request);\n                service.getWaitNotifyObject().wakeupAll();\n                PutMessageStatus replicaStatus = null;\n                try {\n                    // \u540c\u6b65\u590d\u5236\u7684\u8d85\u65f6\u65f6\u5019\u4e3a5\u79d2\n                    replicaStatus = request.future().get(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout(),\n                                                         TimeUnit.MILLISECONDS);\n                } catch (InterruptedException | ExecutionException | TimeoutException e) {\n                }\n                if (replicaStatus != PutMessageStatus.PUT_OK) {\n                    log.error(\"do sync transfer other node, wait return, but failed, topic: \" + messageExt.getTopic() + \" tags: \"\n                              + messageExt.getTags() + \" client address: \" + messageExt.getBornHostNameString());\n                    putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);\n                }\n            }\n            // Slave problem\n            else {\n                // Tell the producer, slave not available\n                putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_8","title":"\u6d88\u606f\u5b58\u50a8\u6587\u4ef6","text":"<p>\u6d88\u606f\u5b58\u50a8\u662fRocketMQ\u4e2d\u6700\u4e3a\u590d\u6742\u548c\u6700\u4e3a\u91cd\u8981\u7684\u4e00\u90e8\u5206\uff0c\u4e0b\u9762\u5c06\u5206\u522b\u4eceRocketMQ\u7684\u6d88\u606f\u5b58\u50a8\u6574\u4f53\u67b6\u6784\u3001PageCache\u4e0eMmap\u5185\u5b58\u6620\u5c04\u4ee5\u53caRocketMQ\u4e2d\u4e24\u79cd\u4e0d\u540c\u7684\u5237\u76d8\u65b9\u5f0f\u4e09\u65b9\u9762\u6765\u5206\u522b\u5c55\u5f00\u53d9\u8ff0</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#1_1","title":"1.\u6d88\u606f\u5b58\u50a8\u7684\u6574\u4f53\u67b6\u6784","text":"<p>\u4e3b\u8981\u6709\u4e09\u4e2a\u548c\u6d88\u606f\u5b58\u50a8\u6709\u5173\u7684\u6587\u4ef6</p> <p></p> <p>(1) CommitLog\uff1a\u6d88\u606f\u4e3b\u4f53\u4ee5\u53ca\u5143\u6570\u636e\u7684\u5b58\u50a8\u4e3b\u4f53\uff0c\u5355\u4e2a\u6587\u4ef6\u5927\u5c0f\u9ed8\u8ba41G \u3002\u6587\u4ef6\u540d\u957f\u5ea6\u4e3a20\u4f4d\uff0c\u7528\u5176\u6587\u4ef6\u4e2d\u7b2c\u4e00\u4e2a\u6d88\u606f\u7684\u504f\u79fb\u91cf\u6765\u8868\u793a\u6587\u4ef6\u540d\uff0c\u6bd4\u598200000000000000000000\u4ee3\u8868\u4e86\u7b2c\u4e00\u4e2a\u6587\u4ef6\uff0c\u8d77\u59cb\u504f\u79fb\u91cf\u4e3a0\uff1b\u6d88\u606f\u4e3b\u8981\u662f\u987a\u5e8f\u5199\u5165\u65e5\u5fd7\u6587\u4ef6\uff0c\u5f53\u7b2c\u4e00\u4e2a\u6587\u4ef6\u5199\u6ee1\u4e86\uff0c\u7b2c\u4e8c\u4e2a\u6587\u4ef6\u540d\u4e3a00000000001073741824\uff0c\u8d77\u59cb\u504f\u79fb\u91cf\u4e3a1073741824\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002\u6ce8\u610f\u5199\u5165\u7684\u6d88\u606f\u5185\u5bb9\u662f\u4e0d\u5b9a\u957f\u7684</p> <p>(2) ConsumeQueue\uff1a\u903b\u8f91\u6d88\u8d39\u961f\u5217\uff0c\u5f15\u5165\u7684\u76ee\u7684\u4e3b\u8981\u662f\u63d0\u9ad8\u6d88\u606f\u6d88\u8d39\u7684\u6027\u80fd\uff0c\u6d88\u606f\u6d88\u8d39\u662f\u9488\u5bf9topic\u8fdb\u884c\u7684\uff0c\u5982\u679c\u8981\u904d\u5386commitlog\u6587\u4ef6\u4e2d\u6839\u636etopic\u68c0\u7d22\u6d88\u606f\u662f\u975e\u5e38\u4f4e\u6548\u7684\u3002Consumer\u5373\u53ef\u6839\u636eConsumeQueue\u6765\u67e5\u627e\u5f85\u6d88\u8d39\u7684\u6d88\u606f\u3002</p> <p>consumequeue\u6587\u4ef6\u53ef\u4ee5\u770b\u6210\u662f\u57fa\u4e8etopic\u7684commitlog\u7d22\u5f15\u6587\u4ef6\uff0c\u6545consumequeue\u6587\u4ef6\u7684\u7ec4\u7ec7\u65b9\u5f0f\u5982\u4e0b\uff1atopic/queue/file\u4e09\u5c42\u7ec4\u7ec7\u7ed3\u6784\uff0c\u5177\u4f53\u5b58\u50a8\u8def\u5f84\u4e3a\uff1a<code>$HOME/store/consumequeue/{topic}/{queueId}/{fileName}</code>\u3002</p> <p>consumequeue\u6587\u4ef6\u91c7\u53d6\u5b9a\u957f\u8bbe\u8ba1\uff0c\u6bcf\u4e00\u4e2a\u6761\u76ee\u517120\u4e2a\u5b57\u8282\uff0c\u5206\u522b\u4e3a8\u5b57\u8282\u7684commitlog\u7269\u7406\u504f\u79fb\u91cf\u30014\u5b57\u8282\u7684\u6d88\u606f\u957f\u5ea6\u30018\u5b57\u8282tag hashcode\uff0c\u5355\u4e2a\u6587\u4ef6\u753130W\u4e2a\u6761\u76ee\u7ec4\u6210\uff08\u6307\u541130\u4e07\u6761\u6d88\u606f\uff09\uff0c\u53ef\u4ee5\u50cf\u6570\u7ec4\u4e00\u6837\u968f\u673a\u8bbf\u95ee\u6bcf\u4e00\u4e2a\u6761\u76ee\uff0c\u6bcf\u4e2aConsumeQueue\u6587\u4ef6\u5927\u5c0f\u7ea65.72M = \uff088 + 8 + 4\uff09* 300000 \uff1b</p> <p>(3) IndexFile\uff1aIndexFile\uff08\u7d22\u5f15\u6587\u4ef6\uff09\u63d0\u4f9b\u4e86\u4e00\u79cd\u53ef\u4ee5\u901a\u8fc7key\u6216\u65f6\u95f4\u533a\u95f4\u6765\u67e5\u8be2\u6d88\u606f\u7684\u65b9\u6cd5\u3002Index\u6587\u4ef6\u7684\u5b58\u50a8\u4f4d\u7f6e\u662f\uff1a<code>$HOME \\store\\index${fileName}</code>\uff0cfileName\u662f\u4ee5\u521b\u5efa\u65f6\u7684\u65f6\u95f4\u6233\u547d\u540d\u7684\uff0c\u56fa\u5b9a\u7684\u5355\u4e2aIndexFile\u6587\u4ef6\u5927\u5c0f\u7ea6\u4e3a400M\uff0c\u4e00\u4e2aIndexFile\u53ef\u4ee5\u4fdd\u5b58 2000W\u4e2a\u7d22\u5f15\uff0cIndexFile\u7684\u5e95\u5c42\u5b58\u50a8\u8bbe\u8ba1\u4e3a\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5b9e\u73b0HashMap\u7ed3\u6784\uff0c\u6545rocketmq\u7684\u7d22\u5f15\u6587\u4ef6\u5176\u5e95\u5c42\u5b9e\u73b0\u4e3ahash\u7d22\u5f15\u3002</p> <p>(4) abort\u6587\u4ef6\u8868\u793abroke\u662f\u5426\u6b63\u5e38\u5173\u95ed\uff0cbroke\u6b63\u5e38\u5173\u95ed\u65f6\u4f1a\u5220\u9664\u6389abort\u6587\u4ef6\u3002\u4e5f\u5c31\u662f\u8bf4broke\u5173\u95ed\u540e\u5982\u679c\u5b58\u5728abort\u6587\u4ef6\uff0c\u8bf4\u660e\u975e\u6b63\u5e38\u5173\u95ed\u3002</p> <p>(5) checkpoint\u6587\u4ef6\u5b58\u50a8\u7684\u662fCommitLog\u6587\u4ef6\u6700\u540e\u4e00\u6b21\u5237\u76d8\u7684\u65f6\u95f4\u6233\uff0cConsumeQueue\u6587\u4ef6\u548cindexFile\u6587\u4ef6\u7684\u6700\u540e\u4e00\u6b21\u5237\u76d8\u65f6\u95f4\uff0c\u7528\u4e8e\u7a0b\u5e8f\u5d29\u6e83\u6062\u590d\u65f6\u4f7f\u7528</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#2","title":"2. \u9875\u7f13\u5b58\u4e0e\u5185\u5b58\u6620\u5c04","text":"<p>ConsumeQueue\u6587\u4ef6\u5b58\u50a8\u7684\u6570\u636e\u8f83\u5c11\uff0c\u5e76\u4e14\u53ef\u4ee5\u987a\u5e8f\u8bfb\u53d6\uff0c\u5728page cache\u673a\u5236\u7684\u9884\u8bfb\u53d6\u4f5c\u7528\u4e0b\uff0cConsumeQueue\u6587\u4ef6\u7684\u8bfb\u6027\u80fd\u51e0\u4e4e\u63a5\u8fd1\u8bfb\u5185\u5b58\uff0c\u5373\u4f7f\u5728\u6709\u6d88\u606f\u5806\u79ef\u60c5\u51b5\u4e0b\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u6027\u80fd\u3002</p> <p>\u9875\u7f13\u5b58\uff08PageCache)\u662fOS\u5bf9\u6587\u4ef6\u7684\u7f13\u5b58\uff0c\u7528\u4e8e\u52a0\u901f\u5bf9\u6587\u4ef6\u7684\u8bfb\u5199\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u7a0b\u5e8f\u5bf9\u6587\u4ef6\u8fdb\u884c\u987a\u5e8f\u8bfb\u5199\u7684\u901f\u5ea6\u51e0\u4e4e\u63a5\u8fd1\u4e8e\u5185\u5b58\u7684\u8bfb\u5199\u901f\u5ea6\uff0c\u4e3b\u8981\u539f\u56e0\u5c31\u662f\u7531\u4e8eOS\u4f7f\u7528PageCache\u673a\u5236\u5bf9\u8bfb\u5199\u8bbf\u95ee\u64cd\u4f5c\u8fdb\u884c\u4e86\u6027\u80fd\u4f18\u5316\uff0c\u5c06\u4e00\u90e8\u5206\u7684\u5185\u5b58\u7528\u4f5cPageCache\u3002\u5bf9\u4e8e\u6570\u636e\u7684\u5199\u5165\uff0cOS\u4f1a\u5148\u5199\u5165\u81f3Cache\u5185\uff0c\u968f\u540e\u901a\u8fc7\u5f02\u6b65\u7684\u65b9\u5f0f\u7531pdflush\u5185\u6838\u7ebf\u7a0b\u5c06Cache\u5185\u7684\u6570\u636e\u5237\u76d8\u81f3\u7269\u7406\u78c1\u76d8\u4e0a\u3002\u5bf9\u4e8e\u6570\u636e\u7684\u8bfb\u53d6\uff0c\u5982\u679c\u4e00\u6b21\u8bfb\u53d6\u6587\u4ef6\u65f6\u51fa\u73b0\u672a\u547d\u4e2dPageCache\u7684\u60c5\u51b5\uff0cOS\u4ece\u7269\u7406\u78c1\u76d8\u4e0a\u8bbf\u95ee\u8bfb\u53d6\u6587\u4ef6\u7684\u540c\u65f6\uff0c\u4f1a\u987a\u5e8f\u5bf9\u5176\u4ed6\u76f8\u90bb\u5757\u7684\u6570\u636e\u6587\u4ef6\u8fdb\u884c\u9884\u8bfb\u53d6\u3002</p> <p></p> <p>\u5bf9\u4e8eCommitLog\u6587\u4ef6\u6765\u8bf4\uff0c\u4f1a\u4ea7\u751f\u8f83\u591a\u7684\u968f\u673a\u8bbf\u95ee\u8bfb\u53d6\uff0c\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\u3002\u5982\u679c\u9009\u62e9\u5408\u9002\u7684\u7cfb\u7edfIO\u8c03\u5ea6\u7b97\u6cd5\uff0c\u6bd4\u5982\u8bbe\u7f6e\u8c03\u5ea6\u7b97\u6cd5\u4e3a\u201cDeadline\u201d\uff08\u6b64\u65f6\u5757\u5b58\u50a8\u91c7\u7528SSD\u7684\u8bdd\uff09\uff0c\u968f\u673a\u8bfb\u7684\u6027\u80fd\u4e5f\u4f1a\u6709\u6240\u63d0\u5347\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_9","title":"\u5185\u5b58\u6620\u5c04","text":"<p>rocketmq\u4f7f\u7528\u5185\u5b58\u6620\u5c04\u6765\u63d0\u9ad8IO\u8bbf\u95ee\u6027\u80fd\uff0cCommitLog\u6587\u4ef6\uff0cConsumeQueue\u6587\u4ef6\uff0cIndexFile\u6587\u4ef6\u90fd\u8bbe\u8ba1\u6210\u4e86\u56fa\u5b9a\u957f\u5ea6\u5927\u5c0f\u3002</p> <p>FileChannel\u8868\u793a\u8fde\u63a5\u5230\u6587\u4ef6\u7684\u7ba1\u9053\uff0c\u662f\u4f7f\u7528\u6807\u51c6Java IO\u8bfb\u53d6\u6587\u4ef6\u7684\u4e00\u79cd\u66ff\u4ee3\u65b9\u6848\uff1bByteBuffer\u662f\u5b57\u8282\u7f13\u51b2\u533a\uff0cMappedByteBuffer\u662f\u5176\u5b50\u7c7b\u3002\u7f13\u51b2\u533a\u4e0e\u901a\u9053\u4e00\u8d77\u5de5\u4f5c\uff0c\u5c06\u78c1\u76d8\u4e0a\u7684\u7269\u7406\u6587\u4ef6\u76f4\u63a5\u6620\u5c04\u5230\u7528\u6237\u6001\u7684\u5185\u5b58\u5730\u5740\u4e2d\uff0c\u51cf\u5c11\u4e86\u4f20\u7edfIO\u5c06\u78c1\u76d8\u6587\u4ef6\u6570\u636e\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7f13\u51b2\u533a\u548c\u7528\u6237\u7f13\u51b2\u533a\u4e4b\u95f4\u62f7\u8d1d\u7684\u6027\u80fd\u5f00\u9500\u3002\u4e5f\u79f0\u96f6\u62f7\u8d1d\u6280\u672f\u6216\u76f4\u63a5\u5185\u5b58\u6280\u672f</p> <p>\u4f7f\u7528MappedFileQueue\u548cMappedFile\u5c01\u88c5\u6587\u4ef6\uff0cMappedFile\u53ef\u4ee5\u770b\u4f5c\u662f\u6587\u4ef6\u5728\u5185\u5b58\u7684\u6620\u5c04\uff0cMappedFileQueue\u662f\u6587\u4ef6\u5939\u3002</p> <pre><code>public class MappedFileQueue {\n    // \u6587\u4ef6\u7684\u5b58\u50a8\u76ee\u5f55\uff0c\u5305\u62ecCommitLog\u6587\u4ef6\uff0cConsumeQueue\u6587\u4ef6\uff0cIndexFile\u6587\u4ef6\n    private final String storePath;\n\n    // \u5355\u4e2a\u6587\u4ef6\u7684\u5b58\u50a8\u5927\u5c0f\uff0cCommitLog\u6587\u4ef6\u9ed8\u8ba4\u662f1G\uff0c\n    private final int mappedFileSize;\n\n    // \u6301\u6709\u591a\u4e2aMappedFile\u6587\u4ef6\n    private final CopyOnWriteArrayList&lt;MappedFile&gt; mappedFiles = new CopyOnWriteArrayList&lt;MappedFile&gt;();\n\n    // \u7528\u4e8e\u5f53\u524dMappedFile\u5199\u6ee1\u540e\uff0c\u521b\u5efa\u65b0\u7684\n    private final AllocateMappedFileService allocateMappedFileService;\n\n    // \u5f53\u524d\u5237\u76d8\u6307\u9488\uff0c\u8868\u793a\u8be5\u6307\u9488\u4e4b\u524d\u7684\u6570\u636e\u90fd\u5168\u90e8\u6301\u4e45\u5316\u5230\u78c1\u76d8\u4e86\n    private long flushedWhere = 0;\n\n    // \u5f53\u524d\u6570\u636e\u63d0\u4ea4\u6307\u9488\uff0c\u5185\u5b58\u4e2dByteBuffer\u5f53\u524d\u5199\u6307\u9488\u3002\u663e\u7136\u8be5\u503c\u4f1a\u5927\u4e8e\u7b49\u4e8eflushedWhere\n    private long committedWhere = 0;\n\n    // \u6839\u636e\u65f6\u95f4\u6233\u6765\u67e5\u627eMappedFile\n    public MappedFile getMappedFileByTime(final long timestamp) {}\n\n    // \u6839\u636e\u6d88\u606f\u504f\u79fb\u91cf\u6765\u67e5\u627eMappedFile\n    public MappedFile findMappedFileByOffset(final long offset, final boolean returnFirstOnNotFound) {}\n\n    // \u83b7\u53d6\u5f53\u524d\u6587\u4ef6\u7684\u5199\u6307\u9488\n    public long getMaxWrotePosition() {\n        MappedFile mappedFile = getLastMappedFile();\n        if (mappedFile != null) {\n            return mappedFile.getFileFromOffset() + mappedFile.getWrotePosition();\n        }\n        return 0;\n    }\n}\n</code></pre> <p>MappedFile\u662f\u7269\u7406\u6587\u4ef6\u7684\u5185\u5b58\u6620\u5c04\u7ba1\u7406\u7c7b\uff0c</p> <pre><code>public class MappedFile extends ReferenceResource {\n    // \u7cfb\u7edf\u7684\u9875\u5927\u5c0f 4K\n    public static final int OS_PAGE_SIZE = 1024 * 4;\n\n    // \u5f53\u524d\u865a\u62df\u673a\u4e2dMappedFile\u5185\u5b58\u7684\u5927\u5c0f\n    private static final AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY = new AtomicLong(0);\n    // \u5f53\u524dJVM\u4e2dMappedFile\u7684\u4e2a\u6570\n    private static final AtomicInteger TOTAL_MAPPED_FILES = new AtomicInteger(0);\n\n    // \u8be5\u6587\u4ef6\u5f53\u524d\u7684\u5199\u6307\u9488\uff0c\u4ece0\u5f00\u59cb\n    protected final AtomicInteger wrotePosition = new AtomicInteger(0);\n    // \u8be5\u6587\u4ef6\u5f53\u524d\u7684\u63d0\u4ea4\u6307\u9488\u3002\u5982\u679c\u5f00\u542fTransientStorePool\uff0c\u5219\u6570\u636e\u4f1a\u5148\u5b58\u50a8\u5728TransientStorePool\u6216\u8005\u8bf4ByteBuffer\u4e2d\n    // \u7136\u540e\u518d\u63d0\u4ea4\u5230\u5185\u5b58\u6620\u5c04ByteBuffer\u4e2d\uff0c\u518d\u5237\u5199\u5230\u78c1\u76d8\n    protected final AtomicInteger committedPosition = new AtomicInteger(0);\n    // \u8be5\u6307\u9488\u4e4b\u524d\u7684\u6570\u636e\u90fd\u5df2\u7ecf\u6301\u4e45\u5316\u5230\u786c\u76d8\n    private final AtomicInteger flushedPosition = new AtomicInteger(0);\n\n    // \u6587\u4ef6\u5927\u5c0f\n    protected int fileSize;\n    private String fileName;\n    private long fileFromOffset;\n    private File file;\n\n    // \u5806\u5185\u5b58ByteBuffer\uff0c\u5982\u679c\u4e0d\u4e3a\u7a7a\uff0c\u6570\u636e\u4f1a\u5148\u5b58\u50a8\u5230\u5728\u8be5ByteBuffer\u4e2d\uff0c\u7136\u540e\u518d\u63d0\u4ea4\u5230\u5185\u5b58\u6620\u5c04\u6587\u4ef6mappedByteBuffer\u4e2d\n    // Message will put to here first, and then reput to FileChannel if writeBuffer is not null.\n    protected ByteBuffer writeBuffer = null;\n    // \u5806\u6682\u5b58\u6c60\uff0c\u5f00\u542fTransientStorePoolEnable\u65f6\u4e0d\u4e3a\u7a7a\n    protected TransientStorePool transientStorePool = null;\n\n    / \u6587\u4ef6\u901a\u9053\n    protected FileChannel fileChannel;\n    // \u7269\u7406\u6587\u4ef6\u7684\u5185\u5b58\u6620\u5c04\u533a\u57df\n    private MappedByteBuffer mappedByteBuffer;\n\n    // \u6587\u4ef6\u6700\u540e\u4e00\u6b21\u5199\u5165\u7684\u65f6\u95f4\u6233\n    private volatile long storeTimestamp = 0;\n    // \u662f\u5426\u662fMappedFileQueue\u7684\u7b2c\u4e00\u4e2a\u6587\u4ef6\n    private boolean firstCreateInQueue = false;\n\n    /**\n    * \u521d\u59cb\u5316\u903b\u8f91\n    */\n    public void init(final String fileName, final int fileSize,\n        final TransientStorePool transientStorePool) throws IOException {\n\n        init(fileName, fileSize);\n        // \u521b\u5efatransientStorePool\n        this.writeBuffer = transientStorePool.borrowBuffer();\n        this.transientStorePool = transientStorePool;\n    }\n\n    private void init(final String fileName, final int fileSize) throws IOException {\n        this.fileName = fileName;\n        this.fileSize = fileSize;\n        this.file = new File(fileName);\n        // fileName\u5373\u662f\u521d\u59cb\u504f\u79fb\u91cf\n        this.fileFromOffset = Long.parseLong(this.file.getName());\n\n        ensureDirOK(this.file.getParent());\n\n        try {\n            // \u521b\u5efa\u7269\u7406\u6587\u4ef6file\u7684fileChannel\uff0c\u7136\u540e\u521b\u5efa\u5bf9\u5e94\u7684mappedByteBuffer\n            this.fileChannel = new RandomAccessFile(this.file, \"rw\").getChannel();\n            this.mappedByteBuffer = this.fileChannel.map(MapMode.READ_WRITE, 0, fileSize);\n\n            TOTAL_MAPPED_VIRTUAL_MEMORY.addAndGet(fileSize);\n            TOTAL_MAPPED_FILES.incrementAndGet();\n            ok = true;\n        } catch (FileNotFoundException e) {\n            throw e;\n        } \n    }\n\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230rocketMq\u521b\u5efa\u4e86\u4e00\u4e2a\u5355\u72ec\u7684TransientStorePool\uff08TransientStorePool\u9ed8\u8ba4\u521b\u5efa5\u4e2a\u5927\u5c0f1G\u7684ByteBuffer\uff0c\u5e76\u9501\u5b9a\u907f\u514d\u88ab\u5185\u5b58\u4ea4\u6362\uff09\u7528\u6765\u4e34\u65f6\u5b58\u50a8\u6570\u636e\uff0c\u5982\u679c\u5f00\u542f\u540e\uff0c\u6570\u636e\u4f1a\u5148\u5199\u5165\u8be5\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u7531commit\u7ebf\u7a0b\u5b9a\u65f6\u5c06\u6570\u636e\u4ece\u8be5\u5185\u5b58\u590d\u5236\u5230\u7269\u7406\u6587\u4ef6\u6620\u5c04\u7684mappedByteBuffer\u4e2d\uff0c\u5f15\u5165\u8be5\u673a\u5236\u7684\u539f\u56e0\u662f\u63d0\u4f9b\u5185\u5b58\u9501\u5b9a\uff0c\u5c06\u5f53\u524d\u5806\u5916\u5185\u5b58\u4e00\u76f4\u9501\u5b9a\u5728\u5185\u5b58\u4e2d\uff0c\u907f\u514d\u88ab\u8fdb\u7a0b\u5c06\u5185\u5b58\u4ea4\u6362\u5230\u78c1\u76d8\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_10","title":"\u8fc7\u671f\u6587\u4ef6\u5220\u9664\u673a\u5236","text":"<p>rocketmq\u662f\u57fa\u4e8e\u5185\u5b58\u6620\u5c04\u673a\u5236\u7684\uff0c\u542f\u52a8\u65f6\u4f1a\u52a0\u8f7d\u76ee\u5f55\u4e0b\u6240\u6709\u7684CommitLog\u548cConsumeQueue\u6587\u4ef6\uff0c\u56e0\u6b64\u4e3a\u4e86\u907f\u514d\u5185\u5b58\u548c\u78c1\u76d8\u7684\u6d6a\u8d39\uff0c\u9700\u8981\u5b9a\u671f\u8fdb\u884c\u5220\u9664\u3002rocketmq\u662f\u987a\u5e8f\u5199\u5165\uff0c\u5728\u4e0b\u4e00\u4e2a\u6587\u4ef6\u521b\u5efa\u540e\uff0c\u4e0a\u4e00\u4e2a\u6587\u4ef6\u4e0d\u4f1a\u518d\u88ab\u66f4\u65b0\u3002\u673a\u5236\u662f\uff0c\u5982\u679c\u4e00\u4e2a\u6587\u4ef6\u5728\u4e00\u5b9a\u65f6\u95f4\uff08\u9ed8\u8ba472\u5c0f\u65f6\uff09\u5185\u6ca1\u6709\u88ab\u6d88\u8d39\uff0c\u5c31\u8ba4\u4e3a\u662f\u8fc7\u671f\u6587\u4ef6\u8981\u88ab\u5220\u9664\uff0c\u4e0d\u4f1a\u5173\u5fc3\u4e0a\u9762\u6d88\u606f\u662f\u5426\u88ab\u5168\u90e8\u6d88\u8d39\u3002</p> <p>DefaultMessageStore\u6dfb\u52a0\u4e86\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf10\u79d2\u53bb\u68c0\u67e5\u6e05\u9664 DefaultMessageStore.this.cleanFilesPeriodically()</p> <pre><code>private void cleanFilesPeriodically() {\n    this.cleanCommitLogService.run();\n    this.cleanConsumeQueueService.run();\n}\n</code></pre> <p>\u5177\u4f53\u5220\u9664\u6587\u4ef6\uff0c\u4f1a\u5728\u6bcf\u5929\u51cc\u66684\u70b9\uff0c\u6216\u8005\u78c1\u76d8\u7a7a\u95f4\u4e0d\u591f\u7528\uff0c\u6216\u8005\u9884\u7559\u7684\u624b\u52a8\u5220\u9664\u63a5\u53e3</p> <pre><code>private void deleteExpiredFiles() {\n    int deleteCount = 0;\n    // \u6587\u4ef6\u4fdd\u7559\u7684\u65f6\u95f4\n    long fileReservedTime = DefaultMessageStore.this.getMessageStoreConfig().getFileReservedTime();\n    // \u5220\u9664\u7269\u7406\u6587\u4ef6\u7684\u95f4\u9694\n    int deletePhysicFilesInterval = DefaultMessageStore.this.getMessageStoreConfig().getDeleteCommitLogFilesInterval();\n    int destroyMapedFileIntervalForcibly = DefaultMessageStore.this.getMessageStoreConfig().getDestroyMapedFileIntervalForcibly();\n\n    // \u662f\u54264\u70b9\u4e86\n    boolean timeup = this.isTimeToDelete();\n    // \u662f\u5426\u78c1\u76d8\u7a7a\u95f4\u5feb\u6ee1\u4e86\n    boolean spacefull = this.isSpaceToDelete();\n    boolean manualDelete = this.manualDeleteFileSeveralTimes &gt; 0;\n\n    // \u53ea\u8981\u6ee1\u8db31\u4e2a\uff0c\u5c31\u6267\u884c\u5220\u9664\u6587\u4ef6\n    if (timeup || spacefull || manualDelete) {\n\n        if (manualDelete)\n            this.manualDeleteFileSeveralTimes--;\n\n        boolean cleanAtOnce = DefaultMessageStore.this.getMessageStoreConfig().isCleanFileForciblyEnable() &amp;&amp; this.cleanImmediately;\n\n        log.info(\"begin to delete before {} hours file. timeup:\");\n\n        fileReservedTime *= 60 * 60 * 1000;\n\n        deleteCount = DefaultMessageStore.this.commitLog.deleteExpiredFile(fileReservedTime, deletePhysicFilesInterval, destroyMapedFileIntervalForcibly, cleanAtOnce);\n    }\n}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_11","title":"\u4e8b\u52a1\u6d88\u606f","text":"<p>producer\u53d1\u9001\u4e8b\u52a1\u6d88\u606f\uff0c\u5982\u679c\u53d1\u9001\u6210\u529f\u5c31\u6267\u884c\u672c\u5730\u4e8b\u52a1<code>localTransactionState = transactionListener.executeLocalTransaction(msg, arg);</code>\uff0c\u7136\u540e\u5c06\u672c\u5730\u4e8b\u52a1\u7684\u6267\u884c\u72b6\u6001\u544a\u77e5broker\u3002</p> <p>broker\u670d\u52a1\u7aef\uff1a\u5982\u679c\u662f\u534a\u4e8b\u52a1\u6d88\u606f\u5c31\u59d4\u6258\u7ed9TransactionalMessageBridge\uff0c\u5b83\u4f1a\u4fee\u6539\u534a\u4e8b\u52a1\u6d88\u606f\u7684Topic\uff0c\u7981\u6b62\u5176\u88ab\u6d88\u8d39\u3002\u8fd9\u91cc\u770b\u5230\u6240\u6709\u534a\u4e8b\u52a1\u6d88\u606f\u90fd\u88ab\u653e\u5230\"RMQ_SYS_TRANS_HALF_TOPIC\"\u540c\u4e00\u4e2aqueue\u91cc</p> <pre><code> private MessageExtBrokerInner parseHalfMessageInner(MessageExtBrokerInner msgInner) {\n     MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_REAL_TOPIC, msgInner.getTopic());\n     MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_REAL_QUEUE_ID,\n                                 String.valueOf(msgInner.getQueueId()));\n     msgInner.setSysFlag(\n         MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), MessageSysFlag.TRANSACTION_NOT_TYPE));\n     // \u4fee\u6539Topic\uff0c\u4e0d\u6295\u9012\u5230queue\n     msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic());\n     msgInner.setQueueId(0);\n     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties()));\n     return msgInner;\n }\n</code></pre> <p>\u4e4b\u540e\u5728\u8ffd\u52a0\u5230commitLog\u4e2d\u65f6\uff0c\u5982\u679c\u662f\u534a\u4e8b\u52a1PREPARED_TYPE\u6d88\u606f\u6216\u8005ROLLBACK_TYPE\u56de\u6eda\u6d88\u606f\uff0c\u5c31\u628a\u5bf9\u5e94\u961f\u5217\u7684queueOffset\u8bbe\u7f6e\u4e3a0\uff0c\u7981\u6b62\u8fdb\u884c\u6d88\u8d39\u3002</p> <pre><code>// Transaction messages that require special handling\nfinal int tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());\nswitch (tranType) {\n        // Prepared and Rollback message is not consumed, will not enter the consumer queue\n        // \u4e8b\u52a1\u72b6\u6001\u5982\u679c\u662fPrepared\u6216Rollback\uff0c\u5c31\u4e0d\u8fdb\u5165consumer queue\n    case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n    case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n        queueOffset = 0L;\n        break;\n    case MessageSysFlag.TRANSACTION_NOT_TYPE:\n    case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n    default:\n        break;\n}\n</code></pre> <p>\u4e4b\u540e\u5728\u5206\u53d1\u6d88\u606f\u7ed9CommitLogDispatcherBuildConsumeQueue\u65f6\uff0c\u5982\u679c\u662f\u534a\u4e8b\u52a1\u6d88\u606f\u6216\u8005\u56de\u6eda\u72b6\u6001\u4e5f\u4e0d\u8fdb\u884c\u5904\u7406\uff1a</p> <pre><code>class CommitLogDispatcherBuildConsumeQueue implements CommitLogDispatcher {\n    @Override\n    public void dispatch(DispatchRequest request) {\n        final int tranType = MessageSysFlag.getTransactionValue(request.getSysFlag());\n        switch (tranType) {\n            case MessageSysFlag.TRANSACTION_NOT_TYPE:\n            case MessageSysFlag.TRANSACTION_COMMIT_TYPE:\n                DefaultMessageStore.this.putMessagePositionInfo(request);\n                break;\n            case MessageSysFlag.TRANSACTION_PREPARED_TYPE:\n            case MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:\n                break;\n        }\n    }\n}\n</code></pre> <p>\u53e6\u5916\u6709\u7ebf\u7a0b\u4efb\u52a1TransactionalMessageCheckService\uff0c\u628a\"RMQ_SYS_TRANS_HALF_TOPIC\"\u91cc\u6240\u6709\u6d88\u606f\u62ff\u51fa\u6765\u56de\u67e5\uff0c\u6bcf60\u79d2check\u4e00\u6b21\uff0c\u62ff\u5230\"RMQ_SYS_TRANS_HALF_TOPIC\"\u4e0b\u6240\u6709\u7684MessageQueue\uff0c\u4f9d\u6b21check\uff0c\u5f00\u542f\u7ebf\u7a0b\u8c03\u7528client\u56de\u67e5\u6d88\u606f\u72b6\u6001\uff0cAbstractTransactionalMessageCheckListener\u8d1f\u8d23\u63a5\u53d7</p> <p>XA\u534f\u8bae\u662f\u4e00\u79cd\u5206\u5e03\u5f0f\u4e8b\u52a1\u89e3\u51b3\u65b9\u6848\uff0c\u662f\u5178\u578b\u7684\u4e24\u9636\u6bb5\u63d0\u4ea4\u65b9\u6848\u3002\u4f5c\u4e3a\u4e00\u79cd\u901a\u7528\u7684\u63a5\u53e3\u6807\u51c6</p> <p>TC\uff1a\u4e8b\u52a1\u534f\u8c03\u8005\uff0c\u9a71\u52a8\u5168\u5c40\u4e8b\u52a1\u7684\u63d0\u4ea4\u6216\u56de\u6eda</p> <p>TM\uff1a\u4e8b\u52a1\u7ba1\u7406\u5668\uff0c\u662f\u5168\u5c40\u4e8b\u52a1\u7684\u53d1\u8d77\u8005\uff0c\u5e76\u8d1f\u8d23\u5168\u5c40\u4e8b\u52a1\u7684\u63d0\u4ea4\u6216\u56de\u6eda</p> <p>RM\uff1a\u8d44\u6e90\u7ba1\u7406\u5668\uff0c\u7ba1\u7406\u5206\u652f\u4e8b\u52a1\u7684\u8d44\u6e90\uff0c\u8d1f\u8d23\u5206\u652f\u4e8b\u52a1\u7684\u63d0\u4ea4\u56de\u6eda</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_12","title":"\u5b9a\u65f6\u6d88\u606f","text":"<p>ScheduleMessageService\u8d1f\u8d23\u5b9a\u65f6\u6d88\u606f\u7684\u5904\u7406\uff0c\u901a\u8fc7\u521b\u5efa\u4e00\u4e2atimer\u7ebf\u7a0b\uff0c\u9996\u6b21\u5ef6\u8fdf1\u79d2\uff0c\u628a\u6240\u6709\u5ef6\u8fdf\u7ea7\u522b\u961f\u5217\u7684\u6d88\u606f\u653e\u5165\u3002</p> <pre><code>// \u5b9a\u65f6\u6d88\u606f\u542f\u52a8\npublic void start() {\n    if (started.compareAndSet(false, true)) {\n        // \u521b\u5efatimer\u5b9a\u65f6\u5668\n        this.timer = new Timer(\"ScheduleMessageTimerThread\", true);\n        for (Map.Entry&lt;Integer, Long&gt; entry : this.delayLevelTable.entrySet()) {\n            Integer level = entry.getKey();\n            Long timeDelay = entry.getValue();\n            Long offset = this.offsetTable.get(level);\n            if (null == offset) {\n                offset = 0L;\n            }\n\n            if (timeDelay != null) {\n                // FIRST_DELAY_TIME\u9996\u6b211\u79d2\n                this.timer.schedule(new DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);\n            }\n        }\n\n        // \u6bcf10\u79d2\u8fdb\u884c\u6301\u4e45\u5316\n        this.timer.scheduleAtFixedRate(new TimerTask() {\n\n            @Override\n            public void run() {\n                try {\n                    if (started.get()) ScheduleMessageService.this.persist();\n                } catch (Throwable e) {\n                    log.error(\"scheduleAtFixedRate flush exception\", e);\n                }\n            }\n        }, 10000, this.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());\n    }\n}\n</code></pre> <p>\u5b9a\u65f6\u5230\u4e86\u4e4b\u540e\uff0c\u5c31\u4f1a\u518d\u6b21\u653e\u5165MessageStore\u3002</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#consumer","title":"consumer\u670d\u52a1","text":""},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#consumer_1","title":"consumer\u542f\u52a8\u6d41\u7a0b","text":"<p>this.consumerGroup\u662f\u5426\u9700\u8981\u6dfb\u52a0namespace\u3002\u5b9e\u9645\u7684\u542f\u52a8\u903b\u8f91\u4e5f\u5728<code>this.defaultMQPushConsumerImpl.start();</code>\u91cc</p> <pre><code>public synchronized void start() throws MQClientException {\n    switch (this.serviceState) {\n            // \u68c0\u67e5\u5404\u79cd\u5c5e\u6027\u662f\u5426\u4e3a\u7a7a\uff0c\u662f\u5426\u6ee1\u8db3\u89c4\u5219\n            this.checkConfig();\n\n            // \u590d\u5236\u8ba2\u9605\u4fe1\u606f\u7ed9rebalanceImpl\uff0c\u5176\u4e2d\u96c6\u7fa4\u6a21\u5f0f\u7684\u6d88\u8d39\u7ec4\u8fd8\u8981\u8ba2\u9605\u4e00\u4e2a\u91cd\u8bd5\u4e3b\u9898`%RETRY% + topic`\n            this.copySubscription();\n\n            // \u83b7\u53d6\u540c\u4e00\u8fdb\u7a0b\u4e2d\u5171\u7528\u7684mQClientFactory\n            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQPushConsumer, this.rpcHook);\n\n            // rebalanceImpl\n            this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());\n            this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());\nthis.rebalanceImpl.setAllocateMessageQueueStrategy(this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());\n            this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);\n\n            this.pullAPIWrapper = new PullAPIWrapper(\n                mQClientFactory,this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());\n            this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);\n\n            if (this.defaultMQPushConsumer.getOffsetStore() != null) {\n                this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();\n            } else {\n                switch (this.defaultMQPushConsumer.getMessageModel()) {\n                    case BROADCASTING:\n                        // \u5e7f\u64ad\u6a21\u5f0f\uff0c\u6d88\u8d39\u8fdb\u5ea6\u5b58\u50a8\u5728\u672c\u5730\n                        this.offsetStore = new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());\n                        break;\n                    case CLUSTERING:\n                        // \u96c6\u7fa4\u6a21\u5f0f\uff0c\u6d88\u8d39\u8fdb\u5ea6\u5b58\u50a8\u5728broke\n                        this.offsetStore = new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());\n                        break;\n                    default:\n                        break;\n                }\n                this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);\n            }\n            this.offsetStore.load();\n\n            // \u987a\u5e8f\u6d88\u606f\u8fd8\u662f\n            if (this.getMessageListenerInner() instanceof MessageListenerOrderly) {\n                this.consumeOrderly = true;\n                this.consumeMessageService =\n                    new ConsumeMessageOrderlyService(this, (MessageListenerOrderly) this.getMessageListenerInner());\n            } else if (this.getMessageListenerInner() instanceof MessageListenerConcurrently) {\n                this.consumeOrderly = false;\n                this.consumeMessageService =\n                    new ConsumeMessageConcurrentlyService(this, (MessageListenerConcurrently) this.getMessageListenerInner());\n            }\n\n            this.consumeMessageService.start();\n\n            // \u6ce8\u518cdefaultMQPushConsumer\u5230mQClientFactory\n            boolean registerOK = mQClientFactory.registerConsumer(this.defaultMQPushConsumer.getConsumerGroup(), this);\n\n            mQClientFactory.start();\n            log.info(\"the consumer [{}] start OK.\", this.defaultMQPushConsumer.getConsumerGroup());\n    }\n\n    this.updateTopicSubscribeInfoWhenSubscriptionChanged();\n    this.mQClientFactory.checkClientInBroker();\n    // \u53d1\u9001\u5fc3\u8df3\u7ed9\u6240\u6709broker\n    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n    // \u7acb\u5373\u91cd\u65b0\u5206\u914d\u8d1f\u8f7d\n    this.mQClientFactory.rebalanceImmediately();\n}\n</code></pre>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_13","title":"\u62c9\u53d6\u6d88\u606f","text":"<p>\u6d88\u8d39\u6d88\u606f\u6709\u4e24\u79cd\u6a21\u5f0f\uff1a</p> <p></p> <p>\u4e00\u822c\u9ed8\u8ba4\u4f7f\u7528push\u6a21\u5f0f\uff0c\u5176\u5b9e\u5e95\u5c42\u4e5f\u662f\u57fa\u4e8e\u957f\u8f6e\u8be2\u7684\u62c9\u3002\u5b9e\u9645\u7684\u5de5\u4f5c\u59d4\u6258\u7ed9DefaultMQPushConsumerImpl\u7c7b\u5b9e\u73b0\u3002</p> <p></p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#pullmessageservice","title":"PullMessageService\u5faa\u73af\u89e6\u53d1\u6d88\u606f\u62c9\u53d6","text":"<p>PullMessageService\u662f\u6d88\u606f\u62c9\u53d6\u670d\u52a1\u7ebf\u7a0b\uff08\u53ea\u6709\u4e00\u4e2a\uff0cMQClientInstance\u542f\u52a8\u65f6\u542f\u52a8\u4e86\u5b83\uff09\uff0c\u4f1a\u4e0d\u65ad\u5730\u4ece\u961f\u5217\u4e2d\u83b7\u53d6PullRequest\uff0c\u7136\u540e\u8c03\u7528\u5bf9\u5e94DefaultMQPushConsumerImpl\u53bb\u62c9\u53d6\u6d88\u606f</p> <pre><code>@Override\npublic void run() {\n    while (!this.isStopped()) {\n        try {\n            // \u4eceLinkedBlockingQueue\u961f\u5217\u4e2d\u53d6\uff0ctake\u4f1a\u963b\u585e\u7b49\u5f85\n            PullRequest pullRequest = this.pullRequestQueue.take();\n            final MQConsumerInner consumer = this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());\n        if (consumer != null) {\n            // \u4ea4\u7ed9\u5bf9\u5e94\u7684DefaultMQPushConsumerImpl\u53bb\u62c9\u53d6\u6d88\u606f\n            DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;\n            impl.pullMessage(pullRequest);\n        } \n    }\n\n    log.info(this.getServiceName() + \" service end\");\n}\n</code></pre> <p>\u4e3b\u8981\u6709\u4e24\u4e2a\u5730\u65b9\u6dfb\u52a0PullRequest\uff0c\u9996\u6b21\u662f\u5728rebalanceImpl\u4e2d\u521b\u5efa\u65f6\u6dfb\u52a0\uff1b\u53e6\u5916\u6bcf\u6b21\u5728\u6267\u884cPullRequest\u540e\u4f1a\u518d\u6b21\u6dfb\u52a0\u5230pullRequestQueue\u4e2d\u3002</p> <pre><code>public class PullRequest {\n    private String consumerGroup;\n    private MessageQueue messageQueue;\n    // \u4ecebroke\u62c9\u5230\u7684\u6d88\u606f\u5148\u5b58\u5165processQueue\uff0c\u7136\u540e\u518d\u63d0\u4ea4\u7ed9\u6d88\u8d39\u7ebf\u7a0b\u5904\u7406\n    private ProcessQueue processQueue;\n    // \u5f85\u62c9\u53d6\u7684\u6d88\u606f\u504f\u79fb\u91cf\n    private long nextOffset;\n    private boolean lockedFirst = false;\n}\n</code></pre> <p>ProcessQueue\u662fMessageQueue\u5728\u6d88\u8d39\u7aef\u7684\u5feb\u7167\u3002PullMessageService\u6bcf\u6b21\u4ecebroke\u9ed8\u8ba4\u62c9\u53d632\u6761\u6d88\u606f\uff0c\u7136\u540e\u987a\u5e8f\u5b58\u653e\u5728ProcessQueue\u4e2d\uff0cPullMessageService\u7136\u540e\u5c06\u6d88\u606f\u63d0\u4ea4\u7ed9\u6d88\u8d39\u7ebf\u7a0b\u6c60\uff0c\u6210\u529f\u6d88\u8d39\u540e\u4eceProcessQueue\u4e2d\u79fb\u9664\u3002</p> <p>DefaultMQPushConsumerImpl\u5982\u4f55\u8fdb\u884c\u62c9\u53d6\u6d88\u606f\u5462\uff1f</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#defaultmqpushconsumerimpl","title":"DefaultMQPushConsumerImpl\u8d1f\u8d23\u62c9\u53d6\u6d88\u606f","text":"<pre><code>#DefaultMQPushConsumerImpl\n/**\n* \u4ecebroke\u62c9\u53d6\u6d88\u606f\n* \u62c9\u53d6\u4e0d\u7ba1\u5931\u8d25\u6216\u6210\u529f\uff0c\u4f1a\u518d\u6b21\u628aPullRequest\u653e\u5165\u961f\u5217\n*/\npublic void pullMessage(final PullRequest pullRequest) {\n    pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());\n\n    if (this.isPause()) {\n        // \u5ef6\u8fdf1\u79d2\u540e\u518d\u6b21\u653e\u5165pullRequest\n        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);\n        return;\n    }\n\n    long cachedMessageCount = processQueue.getMsgCount().get();\n    long cachedMessageSizeInMiB = processQueue.getMsgSize().get() / (1024 * 1024);\n    // \u6d88\u606f\u6d41\u63a7\u3002\u5982\u679cprocessQueue\u961f\u5217\u4e2d\u7684\u6d88\u606f\u6570\u76ee\u8d85\u8fc71000\uff0c\u5c31\u653e\u5f03\u672c\u6b21\u62c9\u53d6\u4efb\u52a1\n    if (cachedMessageCount &gt; this.defaultMQPushConsumer.getPullThresholdForQueue()) {\n        // \u4e0b\u4e00\u4e2apullRequest \u5ef6\u8fdf50\u6beb\u79d2\n        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);\n        return;\n    }\n\n    // \u5982\u679c\u961f\u5217\u4e2d\u6d88\u606fbody\u5927\u5c0f\u8d85\u8fc7100M\uff0c\n    if (cachedMessageSizeInMiB &gt; this.defaultMQPushConsumer.getPullThresholdSizeForQueue()) {\n        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);\n        return;\n    }\n\n    if (!this.consumeOrderly) {\n        // \u4e0d\u662f\u987a\u5e8f\u6d88\u606f\u65f6\uff0c\u5982\u679c\u961f\u5217\u4e2d\u6d88\u606f\u7684\u6700\u5927\u504f\u79fb\u91cf\u548c\u6700\u5c0f\u504f\u79fb\u91cf\u8d85\u8fc72000\uff0c\u8fdb\u884c\u6d41\u63a7\u3002\u4e3b\u8981\u62c5\u5fc3\u5982\u679c\u4e00\u6761\u6d88\u606f\u6d88\u8d39\u963b\u585e\uff0c\u4f1a\u6709\n        if (processQueue.getMaxSpan() &gt; this.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) {\n            this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);\n        }\n    } else {\n        if (processQueue.isLocked()) {\n            if (!pullRequest.isLockedFirst()) {\n                final long offset = this.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());\n                boolean brokerBusy = offset &lt; pullRequest.getNextOffset();\n                log.info(\"the first time to pull message, so fix offset from broker\");\n\n                pullRequest.setLockedFirst(true);\n                pullRequest.setNextOffset(offset);\n            }\n        } else {\n            this.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);\n            log.info(\"pull message later because not locked in broker, {}\", pullRequest);\n            return;\n        }\n    }\n\n    // \u5177\u4f53\u7684\u6d88\u606f\u62c9\u53d6\u6d41\u7a0b\u8f83\u4e3a\u590d\u6742\uff0c\u770b\u56fe\u5427\n    final SubscriptionData subscriptionData = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());\n\n\n}\n</code></pre> <p>broker\u670d\u52a1\u7aef\u7684PullMessageProcessor.processRequest()\u8d1f\u8d23\u67e5\u8be2\u6d88\u606f\u8fdb\u884c\u8fd4\u56de</p> <p>\u62c9\u53d6\u957f\u8f6e\u8be2\u6a21\u5f0f\u5206\u6790</p> <p>rocketmq\u5e76\u6ca1\u6709\u771f\u6b63\u5b9e\u73b0push\u6d88\u606f\uff0c\u800c\u662f\u6d88\u8d39\u8005\u4e3b\u52a8\u5faa\u73af\u5411broke\u62c9\u53d6\u6d88\u606f\u3002</p> <p>broker\u7aef\u5982\u679c\u4ecemessageStore\u53d1\u73b0\u6ca1\u6709\u65b0\u6d88\u606f\u5230\u8fbe\uff0c\u5c31\u521b\u5efa\u4e00\u4e2a\u8bf7\u6c42\u7531PullRequestHoldService\u6302\u8d77\uff0c\u7136\u540ePullRequestHoldService\u6bcf5\u79d2\u68c0\u67e5\u4e00\u6b21\u6d88\u8d39\u662f\u5426\u5230\u8fbe\uff08\u5982\u679c\u4e0d\u5f00\u542f\u957f\u8f6e\u8be2\u5c31\u662f1\u79d2\uff09\uff0c\u5982\u679c\u6709\u65b0\u6d88\u606f\u5230\u8fbe\u5c31\u8fdb\u884c\u6d88\u606f\u8fc7\u6ee4\u5224\u65ad\uff0c\u5426\u5219\u7b49\u5f8515\u79d2\u540e\u8d85\u65f6\u8fd4\u56de\u7ed9\u6d88\u8d39\u8005\u6ca1\u6709\u6d88\u606f\u3002\u53e6\u5916ReputMessage.doReput()\u4e5f\u4f1a\u5728\u6d88\u606f\u8fbe\u5230\u65f6\u901a\u77e5listener\uff0c</p> <p>\u83b7\u53d6\u5230\u6d88\u606f\u540e\u653e\u5165\u5230processQueue.putMessage(pullResult.getMsgFoundList());</p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#client","title":"\u5b9a\u65f6\u91cd\u65b0\u5206\u914d\u6d88\u8d39client","text":"<p>\u540c\u4e00\u6d88\u8d39\u96c6\u7fa4\u5185\u7684\u591a\u4e2a\u6d88\u8d39\u8005\u5982\u4f55\u8d1f\u8f7dtopic\u4e0b\u7684\u591a\u4e2aconsumerqueue\u5462\uff0c\u5982\u679c\u6709\u65b0\u7684\u6d88\u8d39\u8005\u52a0\u5165\uff0c\u5982\u4f55\u91cd\u65b0\u5206\u914d\u5462\uff1f</p> <p>\u8fd9\u662f\u7531RebalanceService\u7ebf\u7a0b\u7c7b\u89e6\u53d1\uff0c\u6bcf20\u79d2\u8fdb\u884c\u4e00\u6b21\u91cd\u5206\u914d<code>this.mqClientFactory.doRebalance();</code>\uff1b\u7136\u540e\u904d\u5386\u6bcf\u4e2a\u6d88\u8d39\u8005\uff0c\u8c03\u7528\u5176\u5185\u90e8RebalanceImpl\u7684doRebalance\u65b9\u6cd5\uff1b\u7136\u540e\u518d\u9488\u5bf9\u6bcf\u4e2a\u8ba2\u9605\u7684topic\uff0c\u8fdb\u884c\u91cd\u5206\u914d<code>rebalanceByTopic(topic, isOrder);</code>.</p> <pre><code>private void rebalanceByTopic(final String topic, final boolean isOrder) {\n    switch (messageModel) {\n        case BROADCASTING: {\n            Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic);\n            if (mqSet != null) {\n                boolean changed = this.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);\n                if (changed) {\n                    this.messageQueueChanged(topic, mqSet, mqSet);\n                    log.info(\"messageQueueChanged {} {} {} {}\",\n                             consumerGroup,\n                             topic,\n                             mqSet,\n                             mqSet);\n                }\n            } else {\n                log.warn(\"doRebalance, {}, but the topic[{}] not exist.\", consumerGroup, topic);\n            }\n            break;\n        }\n        case CLUSTERING: {\n            Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic);\n            // \u4ecebroke\u83b7\u53d6\u6240\u6709\u7684\u6d88\u8d39\u8005\u5ba2\u6237\u7aefID\n            List&lt;String&gt; cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);\n\n            if (mqSet != null &amp;&amp; cidAll != null) {\n                List&lt;MessageQueue&gt; mqAll = new ArrayList&lt;MessageQueue&gt;();\n                mqAll.addAll(mqSet);\n\n                // \u6392\u5e8f\uff0c\u4fdd\u8bc1\u5404\u4e2a\u6d88\u8d39\u8005\u5904\u7406\u7684\u524d\u63d0\u662f\u4e00\u6837\u7684\n                Collections.sort(mqAll);\n                Collections.sort(cidAll);\n\n                // \u8c03\u7528\u5206\u914d\u7b56\u7565\u8fdb\u884c\u5206\u914d\uff0c\u63a8\u8350\u4f7f\u7528AllocateMessageQueueAveragely\u548cAllocateMessageQueueAveragelyByCircle\n                AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;\n                List&lt;MessageQueue&gt; allocateResult = null;\n                try {\n                    allocateResult = strategy.allocate(\n                        this.consumerGroup,\n                        this.mQClientFactory.getClientId(),\n                        mqAll,\n                        cidAll);\n                } catch (Throwable e) {\n                    log.error(\"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}\", strategy.getName(),\n                              e);\n                    return;\n                }\n\n                Set&lt;MessageQueue&gt; allocateResultSet = new HashSet&lt;MessageQueue&gt;();\n                if (allocateResult != null) {\n                    allocateResultSet.addAll(allocateResult);\n                }\n\n                // \u5bf9\u6bd4\u6d88\u606f\u961f\u5217\u662f\u5426\u53d1\u751f\u53d8\u5316\n                boolean changed = this.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);\n                if (changed) {\n                    log.info(\n                        \"rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}\",\n                        strategy.getName(), consumerGroup, topic, this.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),\n                        allocateResultSet.size(), allocateResultSet);\n                    // \u5982\u679c\u6539\u53d8\u4e86\uff0c\u91cd\u65b0\u521b\u5efa\u961f\u5217 pullRequest\u7b49\uff0c\u903b\u8f91\u590d\u6742\n                    this.messageQueueChanged(topic, mqSet, allocateResultSet);\n                }\n            }\n            break;\n        }\n        default:\n            break;\n    }\n}\n</code></pre> <p></p>"},{"location":"micro-services/rocketMQ%E8%AE%BE%E8%AE%A1/#_14","title":"\u6d88\u8d39\u6d88\u606f","text":"<p>DefaultMQPushConsumerImpl\u5728\u62c9\u53d6\u5230\u6d88\u606f\u540e\u653e\u5165processQueue\uff0c\u7136\u540e\u4ea4\u7ed9consumeMessageService\u5904\u7406\uff1a</p> <pre><code>// \u521b\u5efa\u4e00\u4e2aRunnable\u4efb\u52a1\nConsumeRequest consumeRequest = new ConsumeRequest(msgs, processQueue, messageQueue);\ntry {\n    // \u7136\u540e\u63d0\u4ea4\u5230\u6d88\u8d39\u7ebf\u7a0b\u6c60\n    this.consumeExecutor.submit(consumeRequest);\n} catch (RejectedExecutionException e) {\n    this.submitConsumeRequestLater(consumeRequest);\n}\n</code></pre> <p>ConsumeRequest\u662f\u4e00\u4e2aRunnable\u4efb\u52a1\uff0c\u653e\u5165\u5230\u7ebf\u7a0b\u6c60\u7b49\u5f85\u6267\u884c\u3002\u662f\u5426\u6709\u94a9\u5b50\uff0c\u6839\u636e\u8fd4\u56destatus\u51b3\u5b9areturnType</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/","title":"\u5206\u5e03\u5f0f\u7cfb\u7edf","text":"<p>IaaS\uff0cPaaS\uff0cSaaS \u7684\u533a\u522b</p> <ul> <li>IaaS\uff1a\u57fa\u7840\u8bbe\u65bd\u670d\u52a1\uff0cInfrastructure-as-a-service</li> <li>PaaS\uff1a\u5e73\u53f0\u670d\u52a1\uff0cPlatform-as-a-service</li> <li>SaaS\uff1a\u8f6f\u4ef6\u670d\u52a1\uff0cSoftware-as-a-service</li> </ul>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#_1","title":"\u5206\u5e03\u5f0f\u7cfb\u7edf","text":"<p>\u96c6\u4e2d\u5f0f\u7cfb\u7edf\u662f\u8fdb\u884c\u5355\u673a\u90e8\u7f72\uff0c\u96be\u4ee5\u7ef4\u62a4\uff0c\u6269\u5c55\u6027\u5dee\uff0c\u786c\u4ef6\u80fd\u529b\u53d7\u9650\u3002</p> <p>\u5206\u5e03\u5f0f\u7cfb\u7edf\u662f\u4e00\u4e2a\u786c\u4ef6\u6216\u8f6f\u4ef6\u7ec4\u4ef6\u5206\u5e03\u5728\u4e0d\u540c\u7684\u7f51\u7edc\u8ba1\u7b97\u673a\u4e0a\uff0c\u5f7c\u6b64\u4e4b\u95f4\u4ec5\u4ec5\u901a\u8fc7\u6d88\u606f\u4f20\u9012\u8fdb\u884c\u901a\u4fe1\u548c\u534f\u8c03\u7684\u7cfb\u7edf\u3002</p> <p>\u5206\u5e03\u5f0f\u548c\u5fae\u670d\u52a1</p> <p>\u73b0\u5728\u6d41\u884c\u7684\u5fae\u670d\u52a1\u662f\u62c6\u5206\u6210\u4e00\u4e2a\u4e2a\u72ec\u7acb\u7684\u8f83\u5c0f\u5355\u5143\u3002\u5206\u5e03\u5f0f\u662f\u90e8\u7f72\u5206\u6563\u5728\u4e0d\u540c\u7684\u673a\u5668\u4e0a\uff0c\u4e00\u4e2a\u670d\u52a1\u53ef\u80fd\u8d1f\u8d23\u597d\u51e0\u4e2a\u529f\u80fd\u3002\u751f\u4ea7\u73af\u5883\u4e0b\u7684\u5fae\u670d\u52a1\u80af\u5b9a\u662f\u5206\u5e03\u5f0f\u90e8\u7f72\u7684\uff0c\u4f46\u662f\u5206\u5e03\u5f0f\u90e8\u7f72\u7684\u5e94\u7528\u4e0d\u4e00\u5b9a\u662f\u5fae\u670d\u52a1\u67b6\u6784\u7684\uff0c\u6bd4\u5982\u96c6\u7fa4\u90e8\u7f72\uff0c\u5b83\u662f\u628a\u76f8\u540c\u5e94\u7528\u590d\u5236\u5230\u4e0d\u540c\u670d\u52a1\u5668\u4e0a\uff0c\u4f46\u662f\u903b\u8f91\u529f\u80fd\u4e0a\u8fd8\u662f\u5355\u4f53\u5e94\u7528\u3002</p> <p>\u5fae\u670d\u52a1\u91cd\u5728\u89e3\u8026\u5408\uff0c\u4f7f\u6bcf\u4e2a\u6a21\u5757\u90fd\u72ec\u7acb\uff0c\u4fbf\u4e8e\u5feb\u901f\u8fed\u4ee3\u548c\u6269\u5c55\u3002\u5206\u5e03\u5f0f\u91cd\u5728\u964d\u4f4e\u5bf9\u5355\u4e2a\u5e94\u7528\u7684\u786c\u4ef6\u8d44\u6e90\u538b\u529b\u3002\u5206\u5e03\u5f0f\u670d\u52a1\u6700\u540e\u90fd\u4f1a\u5411\u5fae\u670d\u52a1\u67b6\u6784\u6f14\u5316\uff0c\u8fd9\u662f\u4e00\u79cd\u8d8b\u52bf\u3002</p> <p>\u73b0\u5728\u7684\u7f51\u7ad9\u670d\u52a1\u57fa\u672c\u90fd\u662f\u5206\u5e03\u5f0f\u90e8\u7f72\uff0c\u91c7\u7528\u4e00\u7ec4\u8ba1\u7b97\u673a\u5171\u540c\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u5c06\u5e94\u7528\u6216\u670d\u52a1\u8fdb\u884c\u5206\u5272\uff0c\u8fdb\u884c\u5206\u5e03\u5f0f\u90e8\u7f72\uff0c\u5e76\u4e14\u590d\u7528\u4e00\u4e9b\u901a\u7528\u7684\u670d\u52a1\u6a21\u5757\uff0c\u670d\u52a1\u4e4b\u95f4\u901a\u8fc7HTTP/MQ\u8c03\u7528\u6765\u5b9e\u73b0\u901a\u4fe1\u3002\u8fd9\u6837\u7684\u597d\u5904\u662f\u53ef\u4ee5\u5229\u7528\u65b0\u7684\u786c\u4ef6\u63d0\u9ad8\u5e76\u53d1\u80fd\u529b\uff0c\u6269\u5c55\u6027\u5f3a\u3002</p> <p>\u5206\u5e03\u5f0f\u4f1a\u5e26\u6765\u5f88\u591a\u95ee\u9898\uff1a\u5982\u5206\u5e03\u5f0f\u5b58\u50a8\u4f1a\u6bd4\u8f83\u9ebb\u70e6\uff0c\u9700\u8981\u642d\u5efa\u5206\u5e03\u5f0f\u6570\u636e\u5e93\uff0c\u8bfb\u5199\u5206\u79bb\u7b49</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#cap","title":"CAP\u7406\u8bba","text":"<p>CAP\u7406\u8bba\u662f\u5f00\u53d1\u6216\u8bbe\u8ba1\u5206\u5e03\u5f0f\u7cfb\u7edf\u65f6\u79bb\u4e0d\u5f00\u7684\u6982\u5ff5\uff0c\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u6700\u591a\u53ea\u80fd\u540c\u65f6\u6ee1\u8db3\u4e0b\u9762\u4e09\u9879\u4e2d\u7684\u4e24\u9879</p> <p>\u5f3a\u4e00\u81f4\u6027Consistency</p> <p>\u53ef\u7528\u6027Availability</p> <p>\u5206\u533a\u5bb9\u9519\u6027Partition tolerance</p> <p></p> <p>\u7f51\u7edc\u4e2d\u6709\u4e24\u4e2a\u8282\u70b9N1\u548cN2\uff0c\u53ef\u4ee5\u7b80\u5355\u7684\u7406\u89e3N1\u548cN2\u5206\u522b\u662f\u4e24\u53f0\u8ba1\u7b97\u673a\uff0c\u4ed6\u4eec\u4e4b\u95f4\u7f51\u7edc\u53ef\u4ee5\u8fde\u901a\uff0cN1\u4e2d\u6709\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8fA\uff0c\u548c\u4e00\u4e2a\u6570\u636e\u5e93V\uff0cN2\u4e5f\u6709\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8fB\u548c\u4e00\u4e2a\u6570\u636e\u5e93V\u3002\u73b0\u5728\uff0cA\u548cB\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u4e24\u4e2a\u90e8\u5206\uff0cV\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u6570\u636e\u5b58\u50a8\u7684\u4e24\u4e2a\u5b50\u6570\u636e\u5e93\u3002</p> <ul> <li>\u5728\u6ee1\u8db3\u4e00\u81f4\u6027\u7684\u65f6\u5019\uff0cN1\u548cN2\u4e2d\u7684\u6570\u636e\u662f\u4e00\u6837\u7684\uff0cV0=V0\u3002</li> <li>\u5728\u6ee1\u8db3\u53ef\u7528\u6027\u7684\u65f6\u5019\uff0c\u7528\u6237\u4e0d\u7ba1\u662f\u8bf7\u6c42N1\u6216\u8005N2\uff0c\u90fd\u4f1a\u5f97\u5230\u7acb\u5373\u54cd\u5e94\u3002</li> <li>\u5728\u6ee1\u8db3\u5206\u533a\u5bb9\u9519\u6027\u7684\u60c5\u51b5\u4e0b\uff0cN1\u548cN2\u6709\u4efb\u4f55\u4e00\u65b9\u5b95\u673a\uff0c\u6216\u8005\u7f51\u7edc\u4e0d\u901a\u7684\u65f6\u5019\uff0c\u90fd\u4e0d\u4f1a\u5f71\u54cdN1\u548cN2\u5f7c\u6b64\u4e4b\u95f4\u7684\u6b63\u5e38\u8fd0\u4f5c\u3002</li> </ul>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#c","title":"\u5f3a\u4e00\u81f4\u6027C","text":"<p>\u4e00\u81f4\u6027\u6307\u201call nodes see the same data at the same time\u201d\uff0c\u5373\u66f4\u65b0\u64cd\u4f5c\u6210\u529f\u5e76\u8fd4\u56de\u5ba2\u6237\u7aef\u5b8c\u6210\u540e\uff0c\u6240\u6709\u8282\u70b9\u5728\u540c\u4e00\u65f6\u95f4\u7684\u6570\u636e\u5b8c\u5168\u4e00\u81f4\u3002CAP\u91cc\u7684\u4e00\u81f4\u6027\u6307\u7684\u662f\u5f3a\u4e00\u81f4\u6027\u3002</p> <p>\u5206\u5e03\u5f0f\u7684\u4e00\u81f4\u6027</p> <p>\u5bf9\u4e8e\u4e00\u81f4\u6027\uff0c\u53ef\u4ee5\u5206\u4e3a\u4ece\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4e24\u4e2a\u4e0d\u540c\u7684\u89c6\u89d2\u3002\u4ece\u5ba2\u6237\u7aef\u6765\u770b\uff0c\u4e00\u81f4\u6027\u4e3b\u8981\u6307\u7684\u662f\u591a\u5e76\u53d1\u8bbf\u95ee\u65f6\u66f4\u65b0\u8fc7\u7684\u6570\u636e\u5982\u4f55\u83b7\u53d6\u7684\u95ee\u9898\u3002\u4ece\u670d\u52a1\u7aef\u6765\u770b\uff0c\u5219\u662f\u66f4\u65b0\u5982\u4f55\u590d\u5236\u5206\u5e03\u5230\u6574\u4e2a\u7cfb\u7edf\uff0c\u4ee5\u4fdd\u8bc1\u6570\u636e\u6700\u7ec8\u4e00\u81f4\u3002</p> <p>\u4e00\u81f4\u6027\u662f\u56e0\u4e3a\u6709\u5e76\u53d1\u8bfb\u5199\u624d\u6709\u7684\u95ee\u9898\uff0c\u56e0\u6b64\u5728\u7406\u89e3\u4e00\u81f4\u6027\u7684\u95ee\u9898\u65f6\uff0c\u4e00\u5b9a\u8981\u6ce8\u610f\u7ed3\u5408\u8003\u8651\u5e76\u53d1\u8bfb\u5199\u7684\u573a\u666f\u3002</p> <p>\u4ece\u5ba2\u6237\u7aef\u89d2\u5ea6\uff0c\u591a\u8fdb\u7a0b\u5e76\u53d1\u8bbf\u95ee\u65f6\uff0c\u66f4\u65b0\u8fc7\u7684\u6570\u636e\u5728\u4e0d\u540c\u8fdb\u7a0b\u5982\u4f55\u83b7\u53d6\u7684\u4e0d\u540c\u7b56\u7565\uff0c\u51b3\u5b9a\u4e86\u4e0d\u540c\u7684\u4e00\u81f4\u6027\u3002</p> <p>\u4e09\u79cd\u4e00\u81f4\u6027\u7b56\u7565</p> <p>\u5bf9\u4e8e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u8981\u6c42\u66f4\u65b0\u8fc7\u7684\u6570\u636e\u80fd\u88ab\u540e\u7eed\u7684\u8bbf\u95ee\u90fd\u80fd\u770b\u5230\uff0c\u8fd9\u662f\u5f3a\u4e00\u81f4\u6027\u3002</p> <p>\u5982\u679c\u80fd\u5bb9\u5fcd\u540e\u7eed\u7684\u90e8\u5206\u6216\u8005\u5168\u90e8\u8bbf\u95ee\u4e0d\u5230\uff0c\u5219\u662f\u5f31\u4e00\u81f4\u6027\u3002</p> <p>\u5982\u679c\u7ecf\u8fc7\u4e00\u6bb5\u65f6\u95f4\u540e\u8981\u6c42\u80fd\u8bbf\u95ee\u5230\u66f4\u65b0\u540e\u7684\u6570\u636e\uff0c\u5219\u662f\u6700\u7ec8\u4e00\u81f4\u6027\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#a","title":"\u53ef\u7528\u6027A","text":"<p>\u53ef\u7528\u6027\u6307\u201cReads and writes always succeed\u201d\uff0c\u5373\u670d\u52a1\u4e00\u76f4\u53ef\u7528\uff0c\u800c\u4e14\u662f\u6b63\u5e38\u54cd\u5e94\u65f6\u95f4\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u53ef\u7528\u6027\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\uff0c\u6bcf\u4e00\u4e2a\u975e\u6545\u969c\u7684\u8282\u70b9\u5fc5\u987b\u5bf9\u6bcf\u4e00\u4e2a\u8bf7\u6c42\u4f5c\u51fa\u54cd\u5e94\u3002\u6240\u4ee5\uff0c\u4e00\u822c\u6211\u4eec\u5728\u8861\u91cf\u4e00\u4e2a\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u7684\u65f6\u5019\uff0c\u90fd\u662f\u901a\u8fc7\u505c\u673a\u65f6\u95f4\u6765\u8ba1\u7b97\u7684\u3002</p> \u53ef\u7528\u6027\u5206\u7c7b \u53ef\u7528\u6c34\u5e73\uff08%\uff09 \u5e74\u53ef\u5bb9\u5fcd\u505c\u673a\u65f6\u95f4 \u5bb9\u9519\u53ef\u7528\u6027 99.9999 &lt;1 min \u6781\u9ad8\u53ef\u7528\u6027 99.999 &lt;5 min \u5177\u6709\u6545\u969c\u81ea\u52a8\u6062\u590d\u80fd\u529b\u7684\u53ef\u7528\u6027 99.99 &lt;53 min \u9ad8\u53ef\u7528\u6027 99.9 &lt;8.8h \u5546\u54c1\u53ef\u7528\u6027 99 &lt;43.8 min <p>\u901a\u5e38\u6211\u4eec\u63cf\u8ff0\u4e00\u4e2a\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u65f6\uff0c\u6211\u4eec\u8bf4\u6dd8\u5b9d\u7684\u7cfb\u7edf\u53ef\u7528\u6027\u53ef\u4ee5\u8fbe\u52305\u4e2a9\uff0c\u610f\u601d\u5c31\u662f\u8bf4\u4ed6\u7684\u53ef\u7528\u6c34\u5e73\u662f99.999%\uff0c\u5373\u5168\u5e74\u505c\u673a\u65f6\u95f4\u4e0d\u8d85\u8fc7 <code>(1-0.99999)*365*24*60 = 5.256 min</code>\uff0c\u8fd9\u662f\u4e00\u4e2a\u6781\u9ad8\u7684\u8981\u6c42\u3002</p> <p>\u597d\u7684\u53ef\u7528\u6027\u4e3b\u8981\u662f\u6307\u7cfb\u7edf\u80fd\u591f\u5f88\u597d\u7684\u4e3a\u7528\u6237\u670d\u52a1\uff0c\u4e0d\u51fa\u73b0\u7528\u6237\u64cd\u4f5c\u5931\u8d25\u6216\u8005\u8bbf\u95ee\u8d85\u65f6\u7b49\u7528\u6237\u4f53\u9a8c\u4e0d\u597d\u7684\u60c5\u51b5\u3002\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\uff0c\u4e0a\u4e0b\u6e38\u8bbe\u8ba1\u5f88\u591a\u7cfb\u7edf\u5982\u8d1f\u8f7d\u5747\u8861\u3001WEB\u670d\u52a1\u5668\u3001\u5e94\u7528\u4ee3\u7801\u3001\u6570\u636e\u5e93\u670d\u52a1\u5668\u7b49\uff0c\u4efb\u4f55\u4e00\u4e2a\u8282\u70b9\u7684\u4e0d\u7a33\u5b9a\u90fd\u53ef\u4ee5\u5f71\u54cd\u53ef\u7528\u6027\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#p","title":"\u5206\u533a\u5bb9\u9519\u6027P","text":"<p>\u5206\u533a\u5bb9\u9519\u6027\u6307\u201cthe system continues to operate despite arbitrary message loss or failure of part of the system\u201d\uff0c\u5373\u5c3d\u7ba1\u4efb\u610f\u4e22\u5931\u4fe1\u606f\u6216\u7cfb\u7edf\u7684\u4e00\u90e8\u5206\u53d1\u751f\u6545\u969c\uff0c\u7cfb\u7edf\u4ecd\u80fd\u7ee7\u7eed\u8fd0\u884c\u3002</p> <p>\u5206\u533a\u5bb9\u9519\u6027\u548c\u6269\u5c55\u6027\u7d27\u5bc6\u76f8\u5173\u3002\u5728\u5206\u5e03\u5f0f\u5e94\u7528\u4e2d\uff0c\u53ef\u80fd\u56e0\u4e3a\u4e00\u4e9b\u5206\u5e03\u5f0f\u7684\u539f\u56e0\u5bfc\u81f4\u7cfb\u7edf\u65e0\u6cd5\u6b63\u5e38\u8fd0\u8f6c\u3002\u597d\u7684\u5206\u533a\u5bb9\u9519\u6027\u8981\u6c42\u80fd\u591f\u4f7f\u5e94\u7528\u867d\u7136\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\uff0c\u800c\u770b\u4e0a\u53bb\u5374\u597d\u50cf\u662f\u5728\u4e00\u4e2a\u53ef\u4ee5\u8fd0\u8f6c\u6b63\u5e38\u7684\u6574\u4f53\u3002\u6bd4\u5982\u73b0\u5728\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u6709\u67d0\u4e2a\u6216\u8005\u51e0\u4e2a\u673a\u5668\u5b95\u6389\u4e86\uff0c\u5176\u4ed6\u5269\u4e0b\u7684\u673a\u5668\u8fd8\u80fd\u591f\u6b63\u5e38\u8fd0\u8f6c\u6ee1\u8db3\u7cfb\u7edf\u9700\u6c42\uff0c\u6216\u8005\u662f\u673a\u5668\u4e4b\u95f4\u6709\u7f51\u7edc\u5f02\u5e38\uff0c\u5c06\u5206\u5e03\u5f0f\u7cfb\u7edf\u5206\u9694\u672a\u72ec\u7acb\u7684\u51e0\u4e2a\u90e8\u5206\uff0c\u5404\u4e2a\u90e8\u5206\u8fd8\u80fd\u7ef4\u6301\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u8fd0\u4f5c\uff0c\u8fd9\u6837\u5c31\u5177\u6709\u597d\u7684\u5206\u533a\u5bb9\u9519\u6027\u3002</p> <p>\u7b80\u5355\u70b9\u8bf4\uff0c\u5c31\u662f\u5728\u7f51\u7edc\u4e2d\u65ad\uff0c\u6d88\u606f\u4e22\u5931\u7684\u60c5\u51b5\u4e0b\uff0c\u7cfb\u7edf\u5982\u679c\u8fd8\u80fd\u6b63\u5e38\u5de5\u4f5c\uff0c\u5c31\u662f\u6709\u6bd4\u8f83\u597d\u7684\u5206\u533a\u5bb9\u9519\u6027\u3002</p> <p>CAP\u7406\u8bba</p> <p>\u901a\u8fc7CAP\u7406\u8bba\u53ca\u524d\u9762\u7684\u8bc1\u660e\uff0c\u6211\u4eec\u77e5\u9053\u65e0\u6cd5\u540c\u65f6\u6ee1\u8db3\u4e00\u81f4\u6027\u3001\u53ef\u7528\u6027\u548c\u5206\u533a\u5bb9\u9519\u6027\u8fd9\u4e09\u4e2a\u7279\u6027\uff0c\u90a3\u8981\u820d\u5f03\u54ea\u4e2a\u5462\uff1f</p> <p>\u6211\u4eec\u5206\u4e09\u79cd\u60c5\u51b5\u6765\u9610\u8ff0\u4e00\u4e0b\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#ca-without-p","title":"CA without P","text":"<p>\u8fd9\u79cd\u60c5\u51b5\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u51e0\u4e4e\u662f\u4e0d\u5b58\u5728\u7684\u3002\u9996\u5148\u5728\u5206\u5e03\u5f0f\u73af\u5883\u4e0b\uff0c\u7f51\u7edc\u5206\u533a\u662f\u4e00\u4e2a\u81ea\u7136\u7684\u4e8b\u5b9e\u3002\u56e0\u4e3a\u5206\u533a\u662f\u5fc5\u7136\u7684\uff0c\u6240\u4ee5\u5982\u679c\u820d\u5f03P\uff0c\u610f\u5473\u7740\u8981\u820d\u5f03\u5206\u5e03\u5f0f\u7cfb\u7edf\u3002\u90a3\u4e5f\u5c31\u6ca1\u6709\u5fc5\u8981\u518d\u8ba8\u8bbaCAP\u7406\u8bba\u4e86\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u5728\u524d\u9762\u7684CAP\u8bc1\u660e\u4e2d\uff0c\u6211\u4eec\u4ee5\u7cfb\u7edf\u6ee1\u8db3P\u4e3a\u524d\u63d0\u8bba\u8ff0\u4e86\u65e0\u6cd5\u540c\u65f6\u6ee1\u8db3C\u548cA\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u719f\u77e5\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u5982My Sql\u548cOracle\u5c31\u662f\u4fdd\u8bc1\u4e86\u53ef\u7528\u6027\u548c\u6570\u636e\u4e00\u81f4\u6027\uff0c\u4f46\u662f\u4ed6\u5e76\u4e0d\u662f\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u3002\u4e00\u65e6\u5173\u7cfb\u578b\u6570\u636e\u5e93\u8981\u8003\u8651\u4e3b\u5907\u540c\u6b65\u3001\u96c6\u7fa4\u90e8\u7f72\u7b49\u5c31\u5fc5\u987b\u8981\u628aP\u4e5f\u8003\u8651\u8fdb\u6765\u3002</p> <p>Google\u7684\u7ecf\u9a8c\u4e2d\u5f97\u5230\u7684\u7ed3\u8bba\u662f\uff0c\u65e0\u6cd5\u901a\u8fc7\u964d\u4f4eCA\u6765\u63d0\u5347P\u3002\u8981\u60f3\u63d0\u5347\u7cfb\u7edf\u7684\u5206\u533a\u5bb9\u9519\u6027\uff0c\u9700\u8981\u901a\u8fc7\u63d0\u5347\u57fa\u7840\u8bbe\u65bd\u7684\u7a33\u5b9a\u6027\u6765\u4fdd\u969c\u3002\u6240\u4ee5\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u6765\u8bf4\u3002P\u662f\u4e00\u4e2a\u57fa\u672c\u8981\u6c42\uff0c\u53ea\u80fd\u5728CA\u4e24\u8005\u4e4b\u95f4\u505a\u6743\u8861\uff0c\u5e76\u4e14\u8981\u60f3\u5c3d\u529e\u6cd5\u63d0\u5347P\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#cp-without-a","title":"CP without A","text":"<p>\u5982\u679c\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e0d\u8981\u6c42\u5f3a\u7684\u53ef\u7528\u6027\uff0c\u5373\u5bb9\u8bb8\u7cfb\u7edf\u505c\u673a\u6216\u8005\u957f\u65f6\u95f4\u65e0\u54cd\u5e94\u7684\u8bdd\uff0c\u5c31\u53ef\u4ee5\u5728CAP\u4e09\u8005\u4e2d\u4fdd\u969cCP\u800c\u820d\u5f03A\u3002\u4e00\u4e2a\u4fdd\u8bc1\u4e86CP\u800c\u4e00\u4e2a\u820d\u5f03\u4e86A\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\uff0c\u4e00\u65e6\u53d1\u751f\u7f51\u7edc\u6545\u969c\u6216\u8005\u6d88\u606f\u4e22\u5931\u7b49\u60c5\u51b5\uff0c\u5c31\u8981\u727a\u7272\u7528\u6237\u7684\u4f53\u9a8c\uff0c\u7b49\u5f85\u6240\u6709\u6570\u636e\u5168\u90e8\u4e00\u81f4\u4e86\u4e4b\u540e\u518d\u8ba9\u7528\u6237\u8bbf\u95ee\u7cfb\u7edf\u3002</p> <p>\u8bbe\u8ba1\u6210CP\u7684\u7cfb\u7edf\u5176\u5b9e\u4e5f\u4e0d\u5c11\uff0c\u5176\u4e2d\u6700\u5178\u578b\u7684\u5c31\u662f\u5f88\u591a\u5206\u5e03\u5f0f\u6570\u636e\u5e93\uff0c\u5982Redis\u3001HBase\u7b49\uff0c\u8fd8\u6709\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u5e38\u7528\u7684Zookeeper\uff0c\u4ed6\u4eec\u90fd\u662f\u8bbe\u8ba1\u6210CP\u7684\u3002\u5728\u53d1\u751f\u6781\u7aef\u60c5\u51b5\u65f6\uff0c\u4f18\u5148\u4fdd\u8bc1\u6570\u636e\u7684\u5f3a\u4e00\u81f4\u6027\uff0c\u4ee3\u4ef7\u5c31\u662f\u820d\u5f03\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u3002</p> <p>\u65e0\u8bba\u662f\u50cfRedis\u3001HBase\u8fd9\u79cd\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u8fd8\u662f\u50cfZookeeper\u8fd9\u79cd\u5206\u5e03\u5f0f\u534f\u8c03\u7ec4\u4ef6\u3002\u6570\u636e\u7684\u4e00\u81f4\u6027\u662f\u4ed6\u4eec\u6700\u6700\u57fa\u672c\u7684\u8981\u6c42\u3002\u4e00\u4e2a\u8fde\u6570\u636e\u4e00\u81f4\u6027\u90fd\u4fdd\u8bc1\u4e0d\u4e86\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u8981\u4ed6\u6709\u4f55\u7528\uff1f</p> <p>ZooKeeper\u662f\u4e2aCP\uff08\u4e00\u81f4\u6027+\u5206\u533a\u5bb9\u9519\u6027\uff09\u7684\uff0c\u5373\u4efb\u4f55\u65f6\u523b\u5bf9ZooKeeper\u7684\u8bbf\u95ee\u8bf7\u6c42\u80fd\u5f97\u5230\u4e00\u81f4\u7684\u6570\u636e\u7ed3\u679c\uff0c\u540c\u65f6\u7cfb\u7edf\u5bf9\u7f51\u7edc\u5206\u5272\u5177\u5907\u5bb9\u9519\u6027\u3002\u4f46\u662f\u5b83\u4e0d\u80fd\u4fdd\u8bc1\u6bcf\u6b21\u670d\u52a1\u8bf7\u6c42\u7684\u53ef\u7528\u6027\uff0c\u4e5f\u5c31\u662f\u5728\u6781\u7aef\u73af\u5883\u4e0b\uff0cZooKeeper\u53ef\u80fd\u4f1a\u4e22\u5f03\u4e00\u4e9b\u8bf7\u6c42\uff0c\u6d88\u8d39\u8005\u7a0b\u5e8f\u9700\u8981\u91cd\u65b0\u8bf7\u6c42\u624d\u80fd\u83b7\u5f97\u7ed3\u679c\u3002ZooKeeper\u662f\u5206\u5e03\u5f0f\u534f\u8c03\u670d\u52a1\uff0c\u5b83\u7684\u804c\u8d23\u662f\u4fdd\u8bc1\u6570\u636e\u5728\u5176\u7ba1\u8f96\u4e0b\u7684\u6240\u6709\u670d\u52a1\u4e4b\u95f4\u4fdd\u6301\u540c\u6b65\u3001\u4e00\u81f4\u3002\u6240\u4ee5\u5c31\u4e0d\u96be\u7406\u89e3\u4e3a\u4ec0\u4e48ZooKeeper\u88ab\u8bbe\u8ba1\u6210CP\u800c\u4e0d\u662fAP\u7279\u6027\u7684\u4e86\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#ap-wihtout-c","title":"AP wihtout C","text":"<p>\u8981\u9ad8\u53ef\u7528\u5e76\u5141\u8bb8\u5206\u533a\uff0c\u5219\u9700\u653e\u5f03\u4e00\u81f4\u6027\u3002\u4e00\u65e6\u7f51\u7edc\u95ee\u9898\u53d1\u751f\uff0c\u8282\u70b9\u4e4b\u95f4\u53ef\u80fd\u4f1a\u5931\u53bb\u8054\u7cfb\u3002\u4e3a\u4e86\u4fdd\u8bc1\u9ad8\u53ef\u7528\uff0c\u9700\u8981\u5728\u7528\u6237\u8bbf\u95ee\u65f6\u53ef\u4ee5\u9a6c\u4e0a\u5f97\u5230\u8fd4\u56de\uff0c\u5219\u6bcf\u4e2a\u8282\u70b9\u53ea\u80fd\u7528\u672c\u5730\u6570\u636e\u63d0\u4f9b\u670d\u52a1\uff0c\u800c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u5168\u5c40\u6570\u636e\u7684\u4e0d\u4e00\u81f4\u6027\u3002</p> <p>\u8fd9\u79cd\u820d\u5f03\u5f3a\u4e00\u81f4\u6027\u800c\u4fdd\u8bc1\u7cfb\u7edf\u7684\u5206\u533a\u5bb9\u9519\u6027\u548c\u53ef\u7528\u6027\u7684\u573a\u666f\u548c\u6848\u4f8b\u975e\u5e38\u591a\u3002\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u53ef\u7528\u6027\u7684\u65f6\u5019\u8bf4\u5230\u8fc7\uff0c\u5f88\u591a\u7cfb\u7edf\u5728\u53ef\u7528\u6027\u65b9\u9762\u4f1a\u505a\u5f88\u591a\u4e8b\u60c5\u6765\u4fdd\u8bc1\u7cfb\u7edf\u7684\u5168\u5e74\u53ef\u7528\u6027\u53ef\u4ee5\u8fbe\u5230N\u4e2a9\uff0c\u6240\u4ee5\uff0c\u5bf9\u4e8e\u5f88\u591a\u4e1a\u52a1\u7cfb\u7edf\u6765\u8bf4\uff0c\u6bd4\u5982\u6dd8\u5b9d\u7684\u8d2d\u7269\uff0c12306\u7684\u4e70\u7968\u3002\u90fd\u662f\u5728\u53ef\u7528\u6027\u548c\u4e00\u81f4\u6027\u4e4b\u95f4\u820d\u5f03\u4e86\u4e00\u81f4\u6027\u800c\u9009\u62e9\u53ef\u7528\u6027\u3002</p> <p>\u4f60\u572812306\u4e70\u7968\u7684\u65f6\u5019\u80af\u5b9a\u9047\u5230\u8fc7\u8fd9\u79cd\u573a\u666f\uff0c\u5f53\u4f60\u8d2d\u4e70\u7684\u65f6\u5019\u63d0\u793a\u4f60\u662f\u6709\u7968\u7684\uff08\u4f46\u662f\u53ef\u80fd\u5b9e\u9645\u5df2\u7ecf\u6ca1\u7968\u4e86\uff09\uff0c\u4f60\u4e5f\u6b63\u5e38\u7684\u53bb\u8f93\u5165\u9a8c\u8bc1\u7801\uff0c\u4e0b\u5355\u4e86\u3002\u4f46\u662f\u8fc7\u4e86\u4e00\u4f1a\u7cfb\u7edf\u63d0\u793a\u4f60\u4e0b\u5355\u5931\u8d25\uff0c\u4f59\u7968\u4e0d\u8db3\u3002\u8fd9\u5176\u5b9e\u5c31\u662f\u5148\u5728\u53ef\u7528\u6027\u65b9\u9762\u4fdd\u8bc1\u7cfb\u7edf\u53ef\u4ee5\u6b63\u5e38\u7684\u670d\u52a1\uff0c\u7136\u540e\u5728\u6570\u636e\u7684\u4e00\u81f4\u6027\u65b9\u9762\u505a\u4e86\u4e9b\u727a\u7272\uff0c\u4f1a\u5f71\u54cd\u4e00\u4e9b\u7528\u6237\u4f53\u9a8c\uff0c\u4f46\u662f\u4e5f\u4e0d\u81f3\u4e8e\u9020\u6210\u7528\u6237\u6d41\u7a0b\u7684\u4e25\u91cd\u963b\u585e\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u8bf4\u5f88\u591a\u7f51\u7ad9\u727a\u7272\u4e86\u4e00\u81f4\u6027\uff0c\u9009\u62e9\u4e86\u53ef\u7528\u6027\uff0c\u8fd9\u5176\u5b9e\u4e5f\u4e0d\u51c6\u786e\u7684\u3002\u5c31\u6bd4\u5982\u4e0a\u9762\u7684\u4e70\u7968\u7684\u4f8b\u5b50\uff0c\u5176\u5b9e\u820d\u5f03\u7684\u53ea\u662f\u5f3a\u4e00\u81f4\u6027\u3002\u9000\u800c\u6c42\u5176\u6b21\u4fdd\u8bc1\u4e86\u6700\u7ec8\u4e00\u81f4\u6027\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u867d\u7136\u4e0b\u5355\u7684\u77ac\u95f4\uff0c\u5173\u4e8e\u8f66\u7968\u7684\u5e93\u5b58\u53ef\u80fd\u5b58\u5728\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\uff0c\u4f46\u662f\u8fc7\u4e86\u4e00\u6bb5\u65f6\u95f4\uff0c\u8fd8\u662f\u8981\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u6027\u7684\u3002</p> <p>\u5bf9\u4e8e\u591a\u6570\u5927\u578b\u4e92\u8054\u7f51\u5e94\u7528\u7684\u573a\u666f\uff0c\u4e3b\u673a\u4f17\u591a\u3001\u90e8\u7f72\u5206\u6563\uff0c\u800c\u4e14\u73b0\u5728\u7684\u96c6\u7fa4\u89c4\u6a21\u8d8a\u6765\u8d8a\u5927\uff0c\u6240\u4ee5\u8282\u70b9\u6545\u969c\u3001\u7f51\u7edc\u6545\u969c\u662f\u5e38\u6001\uff0c\u800c\u4e14\u8981\u4fdd\u8bc1\u670d\u52a1\u53ef\u7528\u6027\u8fbe\u5230N\u4e2a9\uff0c\u5373\u4fdd\u8bc1P\u548cA\uff0c\u820d\u5f03C\uff08\u9000\u800c\u6c42\u5176\u6b21\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u6027\uff09\u3002\u867d\u7136\u67d0\u4e9b\u5730\u65b9\u4f1a\u5f71\u54cd\u5ba2\u6237\u4f53\u9a8c\uff0c\u4f46\u6ca1\u8fbe\u5230\u9020\u6210\u7528\u6237\u6d41\u7a0b\u7684\u4e25\u91cd\u7a0b\u5ea6\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#_2","title":"\u9002\u5408\u7684\u624d\u662f\u6700\u597d\u7684","text":"<p>\u4e0a\u9762\u4ecb\u7ecd\u4e86\u5982\u4f55CAP\u4e2d\u6743\u8861\u53ca\u53d6\u820d\u4ee5\u53ca\u5178\u578b\u7684\u6848\u4f8b\u3002\u5b70\u4f18\u5b70\u7565\uff0c\u6ca1\u6709\u5b9a\u8bba\uff0c\u53ea\u80fd\u6839\u636e\u573a\u666f\u5b9a\u593a\uff0c\u9002\u5408\u7684\u624d\u662f\u6700\u597d\u7684\u3002</p> <p>\u5bf9\u4e8e\u6d89\u53ca\u5230\u94b1\u8d22\u8fd9\u6837\u4e0d\u80fd\u6709\u4e00\u4e1d\u8ba9\u6b65\u7684\u573a\u666f\uff0cC\u5fc5\u987b\u4fdd\u8bc1\u3002\u7f51\u7edc\u53d1\u751f\u6545\u969c\u5b81\u53ef\u505c\u6b62\u670d\u52a1\uff0c\u820d\u5f03A\u3002\u6bd4\u5982\u524d\u51e0\u5e74\u652f\u4ed8\u5b9d\u5149\u7f06\u88ab\u6316\u65ad\u7684\u4e8b\u4ef6\uff0c\u5728\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u652f\u4ed8\u5b9d\u5c31\u5728\u53ef\u7528\u6027\u548c\u6570\u636e\u4e00\u81f4\u6027\u4e4b\u95f4\u9009\u62e9\u4e86\u6570\u636e\u4e00\u81f4\u6027\uff0c\u7528\u6237\u611f\u53d7\u5230\u7684\u662f\u652f\u4ed8\u5b9d\u7cfb\u7edf\u957f\u65f6\u95f4\u5b95\u673a\uff0c\u4f46\u662f\u5176\u5b9e\u80cc\u540e\u662f\u65e0\u6570\u7684\u5de5\u7a0b\u5e08\u5728\u6062\u590d\u6570\u636e\uff0c\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002</p> <p>\u5bf9\u4e8e\u5176\u4ed6\u573a\u666f\uff0c\u6bd4\u8f83\u666e\u904d\u7684\u505a\u6cd5\u662f\u9009\u62e9\u53ef\u7528\u6027\u548c\u5206\u533a\u5bb9\u9519\u6027\uff0c\u820d\u5f03\u5f3a\u4e00\u81f4\u6027\uff0c\u9000\u800c\u6c42\u5176\u6b21\u4f7f\u7528\u6700\u7ec8\u4e00\u81f4\u6027\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u5b89\u5168\u3002\u8fd9\u5176\u5b9e\u662f\u5206\u5e03\u5f0f\u9886\u57df\u7684\u53e6\u5916\u4e00\u4e2a\u7406\u8bba\u2014\u2014BASE\u7406\u8bba\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#base","title":"BASE\u7406\u8bba","text":"<p>eBay\u7684\u67b6\u6784\u5e08Dan Pritchett\u6e90\u4e8e\u5bf9\u5927\u89c4\u6a21\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u5b9e\u8df5\u603b\u7ed3\uff0c\u5728ACM\u4e0a\u53d1\u8868\u6587\u7ae0\u63d0\u51faBASE\u7406\u8bba\uff0cBASE\u7406\u8bba\u662f\u5bf9CAP\u7406\u8bba\u7684\u5ef6\u4f38\uff0c\u6838\u5fc3\u601d\u60f3\u662f\u5373\u4f7f\u65e0\u6cd5\u505a\u5230\u5f3a\u4e00\u81f4\u6027\uff08Strong Consistency\uff0cCAP\u7684\u4e00\u81f4\u6027\u5c31\u662f\u5f3a\u4e00\u81f4\u6027\uff09\uff0c\u4f46\u5e94\u7528\u53ef\u4ee5\u91c7\u7528\u9002\u5408\u7684\u65b9\u5f0f\u8fbe\u5230\u6700\u7ec8\u4e00\u81f4\u6027\uff08Eventual Consitency\uff09\u3002</p> <p>BASE\u662f\u6307\u57fa\u672c\u53ef\u7528\uff08Basically Available\uff09\u3001\u8f6f\u72b6\u6001\uff08 Soft State\uff09\u3001\u6700\u7ec8\u4e00\u81f4\u6027\uff08 Eventual Consistency\uff09\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#basically-available","title":"\u57fa\u672c\u53ef\u7528\uff08Basically Available\uff09","text":"<p>\u57fa\u672c\u53ef\u7528\u662f\u6307\u5206\u5e03\u5f0f\u7cfb\u7edf\u5728\u51fa\u73b0\u6545\u969c\u7684\u65f6\u5019\uff0c\u5141\u8bb8\u635f\u5931\u90e8\u5206\u53ef\u7528\u6027\uff0c\u5373\u4fdd\u8bc1\u6838\u5fc3\u53ef\u7528\u3002</p> <p>\u7535\u5546\u5927\u4fc3\u65f6\uff0c\u4e3a\u4e86\u5e94\u5bf9\u8bbf\u95ee\u91cf\u6fc0\u589e\uff0c\u90e8\u5206\u7528\u6237\u53ef\u80fd\u4f1a\u88ab\u5f15\u5bfc\u5230\u964d\u7ea7\u9875\u9762\uff0c\u670d\u52a1\u5c42\u4e5f\u53ef\u80fd\u53ea\u63d0\u4f9b\u964d\u7ea7\u670d\u52a1\u3002\u8fd9\u5c31\u662f\u635f\u5931\u90e8\u5206\u53ef\u7528\u6027\u7684\u4f53\u73b0\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#soft-state","title":"\u8f6f\u72b6\u6001\uff08 Soft State\uff09","text":"<p>\u8f6f\u72b6\u6001\u662f\u6307\u5141\u8bb8\u7cfb\u7edf\u5b58\u5728\u4e2d\u95f4\u72b6\u6001\uff0c\u800c\u8be5\u4e2d\u95f4\u72b6\u6001\u4e0d\u4f1a\u5f71\u54cd\u7cfb\u7edf\u6574\u4f53\u53ef\u7528\u6027\u3002\u5206\u5e03\u5f0f\u5b58\u50a8\u4e2d\u4e00\u822c\u4e00\u4efd\u6570\u636e\u81f3\u5c11\u4f1a\u6709\u4e09\u4e2a\u526f\u672c\uff0c\u5141\u8bb8\u4e0d\u540c\u8282\u70b9\u95f4\u526f\u672c\u540c\u6b65\u7684\u5ef6\u65f6\u5c31\u662f\u8f6f\u72b6\u6001\u7684\u4f53\u73b0\u3002mysql replication\u7684\u5f02\u6b65\u590d\u5236\u4e5f\u662f\u4e00\u79cd\u4f53\u73b0\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#eventual-consistency","title":"\u6700\u7ec8\u4e00\u81f4\u6027\uff08 Eventual Consistency\uff09","text":"<p>\u6700\u7ec8\u4e00\u81f4\u6027\u662f\u6307\u7cfb\u7edf\u4e2d\u7684\u6240\u6709\u6570\u636e\u526f\u672c\u7ecf\u8fc7\u4e00\u5b9a\u65f6\u95f4\u540e\uff0c\u6700\u7ec8\u80fd\u591f\u8fbe\u5230\u4e00\u81f4\u7684\u72b6\u6001\u3002\u5f31\u4e00\u81f4\u6027\u548c\u5f3a\u4e00\u81f4\u6027\u76f8\u53cd\uff0c\u6700\u7ec8\u4e00\u81f4\u6027\u662f\u5f31\u4e00\u81f4\u6027\u7684\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#_3","title":"\u5206\u5e03\u5f0f\u4e8b\u52a1\u89e3\u51b3\u65b9\u6848","text":"<p>\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u57fa\u672c\u662f\u6307\u6570\u636e\u7684\u4e00\u81f4\u6027\uff0c\u5355\u673a\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7\u4e8b\u52a1\u548c\u9501\u4fdd\u8bc1\u6570\u636e\u7684ACID\u3002\u800c\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0c\u591a\u4e2a\u8282\u70b9\u7cfb\u7edf\u4e3a\u4e86\u4fdd\u6301\u6570\u636e\u7684\u4e00\u81f4\u548c\u9ad8\u53ef\u7528\uff0c\u4f1a\u5c06\u6570\u636e\u4fdd\u7559\u5728\u4e0d\u540c\u673a\u5668\u4e0a\u7684\u591a\u4e2a\u526f\u672c\u3002\u7531\u4e8e\u7f51\u7edc\u5ef6\u65f6,\u88ab\u8c03\u7528\u65b9\u51fa\u9519\u7b49\u539f\u56e0\u5f88\u5bb9\u6613\u5b58\u5728\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p> <p>CAP\u7406\u8bba\u544a\u8bc9\u6211\u4eec\u4efb\u4f55\u5206\u5e03\u5f0f\u7cfb\u7edf\u90fd\u65e0\u6cd5\u540c\u65f6\u6ee1\u8db3CAP\u4e09\u4e2a\u57fa\u672c\u9700\u6c42\uff0c\u4f46\u662f\u65e0\u8bba\u5982\u4f55\u53d6\u820d\uff0c\u90fd\u4e0d\u80fd\u5f7b\u5e95\u653e\u5f03\u4e00\u81f4\u6027\uff0c\u4e0d\u7136\u6570\u636e\u5c31\u662f\u4e0d\u53ef\u4fe1\u7684\uff0c\u8fd9\u4e2a\u7cfb\u7edf\u4e5f\u5c31\u6ca1\u5565\u610f\u4e49\u548c\u4ef7\u503c\u4e86\u3002CAP\u7406\u8bba\u4e2d\u7684\u4e00\u81f4\u6027\u6307\u7684\u662f\u5f3a\u4e00\u81f4\u6027\uff0c\u8fd8\u6709\u5f31\u4e00\u81f4\u6027\uff0c\u6700\u7ec8\u4e00\u81f4\u6027\u662f\u5f31\u4e00\u81f4\u6027\u7684\u7279\u4f8b\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u79cd\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u95ee\u9898\uff0c\u524d\u4eba\u5728\u6027\u80fd\u548c\u6570\u636e\u4e00\u81f4\u6027\u7684\u53cd\u53cd\u590d\u590d\u6743\u8861\u8fc7\u7a0b\u4e2d\u603b\u7ed3\u4e86\u8bb8\u591a\u5178\u578b\u7684\u534f\u8bae\u548c\u7b97\u6cd5\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#xa","title":"XA\u89c4\u8303","text":"<p>XA\u662f\u7531X/Open\u7ec4\u7ec7\u63d0\u51fa\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u89c4\u8303\u3002XA\u89c4\u8303\u4e3b\u8981\u5b9a\u4e49\u4e86\uff08\u5168\u5c40\uff09\u4e8b\u52a1\u7ba1\u7406\u5668\uff08Transaction Manager\uff09\u548c\uff08\u5c40\u90e8\uff09\u8d44\u6e90\u7ba1\u7406\u5668\uff08Resource Manager\uff09\u4e4b\u95f4\u7684\u63a5\u53e3\uff0c\u7531\u6570\u636e\u5e93\u5382\u5546\u63d0\u4f9b\u3002\u5b83\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u89d2\u8272\uff1a\u5e94\u7528\u7a0b\u5e8fAP\uff0c\u4e8b\u52a1\u7ba1\u7406\u5668TM\uff0c\u8d44\u6e90\u7ba1\u7406\u5668RM\uff08\u6570\u636e\u5e93\uff09\u3002</p> <p></p> <p>\u57fa\u4e8e\u5b9a\u4e49\u7684XA\u63a5\u53e3\u89c4\u8303\uff0c\u884d\u751f\u51fa\u4e24\u9636\u6bb5\u63d0\u4ea4\u548c\u4e09\u9636\u6bb5\u63d0\u4ea4\u534f\u8bae\uff0c\u662f\u5b9e\u73b0XA\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u5173\u952e\uff0c\u4fdd\u8bc1\u4e86\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u539f\u5b50\u6027\uff0c\u8981\u4e48\u90fd\u6210\u529f\u8981\u4e48\u90fd\u5931\u8d25\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#2pc","title":"\u4e24\u9636\u6bb5\u63d0\u4ea42PC","text":"<p>\u4e24\u9636\u6bb5\u63d0\u4ea4\u7684\u7b97\u6cd5\u57fa\u672c\u601d\u8def\u662f\uff1a</p> <ul> <li>\u51c6\u5907\u9636\u6bb5</li> <li>\u534f\u8c03\u8005\u5411\u6240\u6709\u7684\u53c2\u4e0e\u8005\u53d1\u9001\u4e8b\u52a1\u6267\u884c\u8bf7\u6c42\uff0c\u5e76\u7b49\u5f85\u53c2\u4e0e\u8005\u53cd\u9988\u4e8b\u52a1\u6267\u884c\u7ed3\u679c\uff1b</li> <li>\u4e8b\u52a1\u53c2\u4e0e\u8005\u6536\u5230\u8bf7\u6c42\u4e4b\u540e\uff0c\u6267\u884c\u4e8b\u52a1\u4f46\u4e0d\u63d0\u4ea4\uff0c\u5e76\u8bb0\u5f55\u4e8b\u52a1\u65e5\u5fd7\uff1b</li> <li> <p>\u53c2\u4e0e\u8005\u5c06\u81ea\u5df1\u4e8b\u52a1\u6267\u884c\u60c5\u51b5\u53cd\u9988\u7ed9\u534f\u8c03\u8005\uff0c\u540c\u65f6\u963b\u585e\u7b49\u5f85\u534f\u8c03\u8005\u7684\u540e\u7eed\u6307\u4ee4\u3002</p> </li> <li> <p>\u63d0\u4ea4</p> </li> </ul> <p>\u6240\u6709\u7684\u53c2\u4e0e\u8005\u90fd\u56de\u590d\u80fd\u591f\u6b63\u5e38\u6267\u884c\u4e8b\u52a1\uff1a\u534f\u8c03\u8005\u5c06\u5411\u6240\u6709\u7684\u53c2\u4e0e\u8005\u53d1\u51fa\u63d0\u4ea4\u901a\u77e5\uff1b</p> <p></p> <p>\u4e00\u4e2a\u6216\u591a\u4e2a\u53c2\u4e0e\u8005\u56de\u590d\u4e8b\u52a1\u6267\u884c\u5931\u8d25\u6216\u8005\u534f\u8c03\u8005\u7b49\u5f85\u8d85\u65f6\uff1a\u534f\u8c03\u8005\u53d1\u51fa\u56de\u6eda\u901a\u77e5\u3002</p> <p></p> <p>\u4e24\u9636\u6bb5\u63d0\u4ea4\u539f\u7406\u7b80\u5355\uff0c\u4f46\u662f\u5b58\u5728\u5f88\u591a\u7f3a\u70b9\uff1a</p> <ul> <li> <p>\u534f\u8c03\u8005\u5355\u70b9\u6545\u969c</p> </li> <li> <p>\u53c2\u4e0e\u8005\u540c\u6b65\u963b\u585e</p> </li> </ul> <p>\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u53c2\u4e0e\u8005\u5728\u51c6\u5907\u9636\u6bb5\u6267\u884c\u5e76\u56de\u590d\u7ed3\u679c\u7ed9\u534f\u8c03\u8005\u540e\u5c31\u8981\u7b49\u5f85\u534f\u8c03\u8005\u7684\u6700\u7ec8\u51b3\u7b56\uff0c\u671f\u95f4\u5904\u4e8e\u963b\u585e\u72b6\u6001\u800c\u4e0d\u80fd\u4ece\u4e8b\u5176\u4ed6\u64cd\u4f5c\uff0c\u8fd9\u6837\u6548\u7387\u6781\u5176\u4f4e\u4e0b\u3002</p> <ul> <li>\u53ef\u80fd\u6570\u636e\u4e0d\u4e00\u81f4</li> </ul> <p>\u4f8b\u5982TM\u53d1\u51facommit\u901a\u77e5\u540e\uff0c\u524d\u4e24\u4e2aRM\u6267\u884c\u6210\u529f\uff0c\u7b2c\u4e09\u4e2aRM\u7531\u4e8e\u7f51\u7edc\u9519\u8bef\u6216\u8005\u672c\u8eab\u9519\u8bef\u6ca1\u6709\u6536\u5230commit\u901a\u77e5\uff0c\u5c31\u4f1a\u4e00\u76f4\u963b\u585e\u5e76\u5bfc\u81f4\u6570\u636e\u4e0d\u4e00\u81f4\u3002</p> <p>\u6240\u4ee5\u5728\u6b64\u57fa\u7840\u4e0a\u4f5c\u4e86\u6539\u8fdb\uff0c\u5f15\u5165\u4e86\u4e09\u9636\u6bb5\u63d0\u4ea4</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#3pc","title":"\u4e09\u9636\u6bb5\u63d0\u4ea43PC","text":"<p>\u4e09\u9636\u6bb5\u63d0\u4ea4\u6709\u4e24\u4e2a\u6539\u52a8\u70b9 1.\u5f15\u5165\u53c2\u4e0e\u8005\u8d85\u65f6\u673a\u5236\uff0c2.\u589e\u52a0\u4e00\u4e2a\u9636\u6bb5</p> <ol> <li>canCommit: </li> </ol> <p>\u534f\u8c03\u8005\u4f1a\u53bb\u8be2\u95ee\u5404\u4e2a\u53c2\u4e0e\u8005\u662f\u5426\u80fd\u591f\u6b63\u5e38\u6267\u884c\u4e8b\u52a1\uff0c\u53c2\u4e0e\u8005\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u56de\u590d\u4e00\u4e2a\u9884\u4f30\u503c\uff0c\u76f8\u5bf9\u4e8e\u771f\u6b63\u7684\u6267\u884c\u4e8b\u52a1\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u8f7b\u91cf\u7684</p> <ol> <li>preCommit: </li> </ol> <p>\u5982\u679c\u53c2\u4e0e\u8005canCommit\u90fd\u8fd4\u56deYes\uff1a\u534f\u8c03\u8005\u5c31\u5411\u6240\u6709\u53c2\u4e0e\u8005\u53d1\u51fa\u4e8b\u52a1\u6267\u884c\u7684\u901a\u77e5\uff0c\u53c2\u4e0e\u8005\u6267\u884c\u4e8b\u52a1\u4f46\u5e76\u4e0d\u63d0\u4ea4\uff0c\u5c06\u6267\u884c\u60c5\u51b5\u8fd4\u56de\u534f\u8c03\u8005\uff1b</p> <p>\u5982\u679c\u5b58\u5728\u53c2\u4e0e\u8005canCommit\u8fd4\u56de\u5426\u5b9a\u6d88\u606f\u6216\u8005\u534f\u8c03\u8005\u7b49\u5f85\u8d85\u65f6\uff1a\u534f\u8c03\u8005\u5c31\u4f1a\u8ba4\u4e3a\u4e8b\u52a1\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\uff0c\u4e8e\u662f\u53d1\u51faabort\u901a\u77e5\u3002</p> <p></p> <ol> <li>doCommit:  </li> </ol> <p>\u5982\u679c\u7b2c\u4e8c\u9636\u6bb5\u4e8b\u52a1\u672a\u4e2d\u65ad\uff0c\u90a3\u4e48\u672c\u9636\u6bb5\u534f\u8c03\u8005\u5c06\u4f1a\u4f9d\u636e\u5404\u4e2a\u53c2\u4e0e\u8005\u7684\u8fd4\u56de\u7684\u4e8b\u52a1\u6267\u884c\u7ed3\u679c\u6765\u51b3\u5b9a\u63d0\u4ea4\u6216\u56de\u6eda\u4e8b\u52a1\uff1a</p> <p>\u5982\u679c\u6240\u6709\u53c2\u4e0e\u8005\u90fd\u8fd4\u56de\u80fd\u6b63\u5e38\u6267\u884c\u4e8b\u52a1\uff1a\u534f\u8c03\u8005\u5c31\u53d1\u51facommit\u901a\u77e5\uff0c\u53c2\u4e0e\u8005\u63d0\u4ea4\u4e8b\u52a1\uff0c\u91ca\u653e\u8d44\u6e90\uff1b</p> <p>\u5982\u679c\u4e00\u4e2a\u6216\u591a\u4e2a\u53c2\u4e0e\u8005\u8fd4\u56de\u6267\u884c\u4e8b\u52a1\u5931\u8d25\u6216\u8005\u534f\u8c03\u8005\u7b49\u5f85\u8d85\u65f6\uff1a\u534f\u8c03\u8005\u8ba4\u4e3a\u4e8b\u52a1\u65e0\u6cd5\u6210\u529f\u6267\u884c\uff0c\u4e8e\u662f\u53d1\u51fa\u56de\u6eda\u901a\u77e5</p> <p></p> <p>\u200b           \u5982\u679c\u672c\u9636\u6bb5\u53c2\u4e0e\u8005\u8fdf\u8fdf\u6536\u4e0d\u5230\u534f\u8c03\u8005\u7684\u6d88\u606f\uff0c\u4e0d\u4f1a\u9677\u5165\u963b\u585e\uff0c\u800c\u662f\u5728\u7b49\u5f85\u8d85\u65f6\u540e\u6267\u884c           commit\u3002</p> <p>3PC\u76f8\u5bf9\u4e8e2PC\u6709\u4ec0\u4e48\u4e0d\u540c\uff1f</p> <p>\u591a\u4e86can_commit\u9636\u6bb5\uff0c\u5148\u8fdb\u884c\u9884\u68c0\u67e5\uff08\u5982\u679c\u6709\u4e0d\u6ee1\u8db3\u5c31\u4e0d\u5360\u7528\u8d44\u6e90\uff09\uff0c\u51cf\u5c11\u4e86\u4e0d\u5fc5\u8981\u7684\u8d44\u6e90\u6d6a\u8d39\uff082PC\u662f\u76f4\u63a5\u5360\u7528\uff09\uff1b</p> <p>2PC\u53ea\u6709\u534f\u8c03\u8005\u8d85\u65f6\uff0c\u53d1\u51fa\u56de\u6eda\u6307\u4ee4\uff1b3PC\u5f15\u5165\u53c2\u4e0e\u8005\u8d85\u65f6\uff0c\u53c2\u4e0e\u8005\u5728do_commit\u9636\u6bb5\u8d85\u65f6\u9ed8\u8ba4\u63d0\u4ea4\uff0c\u89e3\u51b3\u4e86\u534f\u8c03\u8005\u5355\u70b9\u6545\u969c\u7684\u95ee\u9898\uff0c</p> <p>\u4f46\u662f3PC\u4ecd\u7136\u5b58\u5728\u7f3a\u70b9\uff1a</p> <ul> <li>\u4e5f\u53ef\u80fd\u5b58\u5728\u6570\u636e\u4e0d\u4e00\u81f4\u95ee\u9898\uff1a</li> </ul> <p>\u7531\u4e8e\u7f51\u7edc\u539f\u56e0\uff0c\u534f\u8c03\u8005\u53d1\u9001\u7684rollback\u54cd\u5e94\u6ca1\u6709\u53ca\u65f6\u88ab\u53c2\u4e0e\u8005\u63a5\u6536\u5230\uff0c\u90a3\u4e48\u53c2\u4e0e\u8005\u5728\u7b49\u5f85\u8d85\u65f6\u4e4b\u540e\u6267\u884c\u4e86commit\u64cd\u4f5c\u3002\u8fd9\u6837\u5c31\u548c\u5176\u4ed6\u63a5\u5230rollback\u547d\u4ee4\u5e76\u6267\u884c\u56de\u6eda\u7684\u53c2\u4e0e\u8005\u4e4b\u95f4\u5b58\u5728\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5</p> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0c\u65e0\u8bba\u662f\u4e8c\u9636\u6bb5\u63d0\u4ea4\u8fd8\u662f\u4e09\u9636\u6bb5\u63d0\u4ea4\u90fd\u65e0\u6cd5\u5f7b\u5e95\u89e3\u51b3\u5206\u5e03\u5f0f\u7684\u4e00\u81f4\u6027\u95ee\u9898\u3002Google Chubby\u7684\u4f5c\u8005Mike Burrows\u8bf4\u8fc7\uff0c <code>there is only one consensus protocol, and that\u2019s Paxos\u201d \u2013 all other approaches are just broken versions of Paxos.</code> \u610f\u5373\u4e16\u4e0a\u53ea\u6709\u4e00\u79cd\u4e00\u81f4\u6027\u7b97\u6cd5\uff0c\u90a3\u5c31\u662fPaxos\uff0c\u6240\u6709\u5176\u4ed6\u4e00\u81f4\u6027\u7b97\u6cd5\u90fd\u662fPaxos\u7b97\u6cd5\u7684\u4e0d\u5b8c\u6574\u7248\u3002\u540e\u9762\u7684\u6587\u7ae0\u4f1a\u4ecb\u7ecd\u8fd9\u4e2a\u516c\u8ba4\u4e3a\u96be\u4e8e\u7406\u89e3\u4f46\u662f\u884c\u4e4b\u6709\u6548\u7684Paxos\u7b97\u6cd5\u3002</p> <p>2\u9636\u6bb5\u63d0\u4ea4\u548c3\u9636\u6bb5\u63d0\u4ea4\u5b9e\u9645\u5728\u4e1a\u754c\u7528\u7684\u5e76\u4e0d\u591a\uff0c\u5b9e\u73b0\u590d\u6742\uff0c\u5bf9\u4e1a\u52a1\u4fb5\u5165\u5927\u3002\u800c\u4e14\u66f4\u591a\u7684\u662f\u9488\u5bf9\u7684\u8de8\u6570\u636e\u5e93\u7684\uff1f\uff1f</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#_4","title":"\u4e1a\u754c\u6210\u719f\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u65b9\u6848","text":"<p>\u76ee\u524d\u4e1a\u5185\uff0c\u4e3b\u8981\u7528\u6765\u89e3\u51b3\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u65b9\u6848\u5c31\u662f\u4f7f\u7528\u67d4\u6027\u4e8b\u52a1\u3002\u76f8\u5bf9\u4e8eACID\uff0c\u4fdd\u8bc1\u7684\u662f\u57fa\u672c\u53ef\u7528\uff0c\u6700\u7ec8\u4e00\u81f4\u3002</p> <ul> <li>\u539f\u5b50\u6027\uff1a\u4e25\u683c\u9075\u5faa</li> <li>\u4e00\u81f4\u6027\uff1a\u4e8b\u52a1\u5b8c\u6210\u540e\u7684\u4e00\u81f4\u6027\u4e25\u683c\u9075\u5faa\uff1b\u4e8b\u52a1\u4e2d\u7684\u4e00\u81f4\u6027\u53ef\u9002\u5f53\u653e\u5bbd</li> <li>\u9694\u79bb\u6027\uff1a\u5e76\u884c\u4e8b\u52a1\u95f4\u4e0d\u53ef\u5f71\u54cd\uff1b\u4e8b\u52a1\u4e2d\u95f4\u7ed3\u679c\u53ef\u89c1\u6027\u5141\u8bb8\u5b89\u5168\u653e\u5bbd</li> <li>\u6301\u4e45\u6027\uff1a\u4e25\u683c\u9075\u5faa</li> </ul> <p>\u67d4\u6027\u4e8b\u52a1\u6700\u4e3b\u8981\u7684\u6709\u4ee5\u4e0b\u4e09\u79cd\u7c7b\u578b\uff1a\u5f02\u6b65\u786e\u4fdd\u578b\u3001\u8865\u507f\u578b\u3001\u6700\u5927\u52aa\u529b\u901a\u77e5\u578b\u3002\u8fd9\u4e09\u79cd\u7c7b\u578b\u90fd\u6709\u5bf9\u5e94\u7684\u5b9e\u73b0\uff0c\u9002\u7528\u4e8e\u4e0d\u540c\u7684\u573a\u666f\uff0c\u90fd\u4f9d\u8d56\u4e8e\u4e00\u4e9b\u57fa\u672c\u7684\u63a5\u53e3\u3002</p> <p>\u5e42\u7b49\u64cd\u4f5c\u3001\u53ef\u8865\u507f\u64cd\u4f5c\u3001\u53ef\u67e5\u8be2\u64cd\u4f5c\u548cTCC\u64cd\u4f5c</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#tcc","title":"TCC\u89e3\u51b3\u65b9\u6848","text":"<p>TCC\uff08try-confirm-cancel\uff09\uff0c\u5148\u6267\u884ctry\u64cd\u4f5c\uff0c\u5404\u4e2a\u53c2\u4e0e\u8005\u8fdb\u884c\u8d44\u6e90\u7684\u9884\u7559\uff0c\u5982\u679c\u90fd\u6210\u529f\u5c31\u8fdb\u884cconfirm\uff0c\u5982\u679c\u6709\u5931\u8d25\u7684\u5c31cancel\u3002\u5982\u679c\u53d1\u9001confirm\u6216\u8005cancel\u8d85\u65f6\uff0c  \u8981\u8fdb\u884c\u4e0d\u65ad\u91cd\u8bd5\u3002</p> <p>\u611f\u89c9TCC\u7c7b\u4f3c\u4e8e2PC\uff0c\u53ea\u4e0d\u8fc72PC\u66f4\u52a0\u9488\u5bf9\u4e8e\u4e24\u4e2a\u6570\u636e\u5e93\u5c42\u9762\u7684\uff0c\u89c4\u5b9a\u6570\u636e\u5e93\u8981\u5b9e\u73b0\u534f\u8bae\u63a5\u53e3\uff0c\u800cTCC\u5c5e\u4e8e\u5e94\u7528\u5c42\u9762\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/#_5","title":"\u6700\u7ec8\u4e00\u81f4\u6027\uff08\u6d88\u606f\u4e2d\u95f4\u4ef6\uff09","text":"<p>\u4e5f\u5c31\u662f\u67d0\u5e94\u7528\u6267\u884c\u672c\u5730\u4e8b\u52a1\uff0c\u7136\u540e\u53d1\u9001\u6d88\u606f\u51fa\u53bb\u3002\u5176\u4ed6\u7cfb\u7edf\u6d88\u8d39\u6d88\u606f\u6267\u884c\u4e8b\u52a1\u3002</p> <p>\u5982\u4f55\u4fdd\u8bc1\u672c\u5730\u4e8b\u52a1\u548c\u53d1\u9001\u6d88\u606f\u6210\u529f\u539f\u5b50\u6027\u5462\uff1f</p> <ul> <li>\u672c\u5730\u4e8b\u52a1\u6267\u884c\u6210\u529f\uff0c\u7136\u540e\u5199\u5165\u6d88\u606f\u8868\uff0c\u8fd9\u4e24\u4e2a\u8868\u53ef\u4ee5\u672c\u5730\u4e8b\u52a1\u63a7\u5236\u3002\u5b9a\u65f6\u4efb\u52a1\u626b\u63cf\u6d88\u606f\u8868\u53d1\u9001\u6d88\u606f\uff0c\u5931\u8d25\u5c31\u8fdb\u884c\u91cd\u8bd5\u3002\u6d88\u8d39\u65b9\u8981\u6ce8\u610f\u5e42\u7b49\u3002</li> <li>\u5229\u7528rocketMQ\u7684\u4e8b\u52a1\u6d88\u606f\u3002\u5176\u5b9e\u5c31\u662f\u5728mq\u670d\u52a1\u65b9\u5b9e\u73b0\u4e86\u6d88\u606f\u7684\u626b\u63cf\uff0c</li> </ul> <p>\u7279\u70b9\uff1a\u5f02\u6b65\u7684</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/","title":"\u5206\u5e03\u5f0f\u9501","text":"<p>\u5206\u5e03\u5f0f\u9501\u4e3b\u8981\u7528\u6765\u5728\u5206\u5e03\u5f0f\u591a\u5b9e\u4f8b\u90e8\u7f72\u4e0b\uff0c\u4fdd\u8bc1\u4e00\u4e2a\u65b9\u6cd5\u5728\u67d0\u4e00\u65f6\u95f4\u5185\u53ea\u80fd\u88ab\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u3002\u5206\u5e03\u5f0f\u9501\u7684\u5b9e\u73b0\u65b9\u6848\u4e3b\u8981\u6709</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#_1","title":"\u57fa\u4e8e\u6570\u636e\u5e93\u8868","text":"<p>\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u662f\u76f4\u63a5\u521b\u5efa\u4e00\u5f20\u9501\u8868\uff0c\u5f53\u6211\u4eec\u8981\u9501\u4f4f\u67d0\u4e2a\u65b9\u6cd5\u6216\u8d44\u6e90\u65f6\uff0c\u6211\u4eec\u5c31\u5728\u8be5\u8868\u4e2d\u589e\u52a0\u4e00\u6761\u8bb0\u5f55\uff0c\u60f3\u8981\u91ca\u653e\u9501\u7684\u65f6\u5019\u5c31\u5220\u9664\u8fd9\u6761\u8bb0\u5f55\u3002</p> <p>\u521b\u5efa\u8fd9\u6837\u4e00\u5f20\u6570\u636e\u5e93\u8868\uff1a</p> <pre><code>CREATE TABLE `methodLock` (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '\u4e3b\u952e',\n  `method_name` varchar(64) NOT NULL DEFAULT '' COMMENT '\u9501\u5b9a\u7684\u65b9\u6cd5\u540d',\n  `desc` varchar(1024) NOT NULL DEFAULT '\u5907\u6ce8\u4fe1\u606f',\n  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '\u4fdd\u5b58\u6570\u636e\u65f6\u95f4\uff0c\u81ea\u52a8\u751f\u6210',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uidx_method_name` (`method_name `) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='\u9501\u5b9a\u4e2d\u7684\u65b9\u6cd5';\n</code></pre> <p>\u5f53\u6211\u4eec\u60f3\u8981\u9501\u4f4f\u67d0\u4e2a\u65b9\u6cd5\u65f6\uff0c\u6267\u884c\u4ee5\u4e0bSQL\uff1a</p> <pre><code>insert into methodLock(method_name,desc) values (\u2018method_name\u2019,\u2018desc\u2019)\n</code></pre> <p>\u56e0\u4e3a\u6211\u4eec\u5bf9<code>method_name</code>\u505a\u4e86\u552f\u4e00\u6027\u7ea6\u675f\uff0c\u8fd9\u91cc\u5982\u679c\u6709\u591a\u4e2a\u8bf7\u6c42\u540c\u65f6\u63d0\u4ea4\u5230\u6570\u636e\u5e93\u7684\u8bdd\uff0c\u6570\u636e\u5e93\u4f1a\u4fdd\u8bc1\u53ea\u6709\u4e00\u4e2a\u64cd\u4f5c\u53ef\u4ee5\u6210\u529f\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba4\u4e3a\u64cd\u4f5c\u6210\u529f\u7684\u90a3\u4e2a\u7ebf\u7a0b\u83b7\u5f97\u4e86\u8be5\u65b9\u6cd5\u7684\u9501\uff0c\u53ef\u4ee5\u6267\u884c\u65b9\u6cd5\u4f53\u5185\u5bb9\u3002</p> <p>\u5f53\u65b9\u6cd5\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u60f3\u8981\u91ca\u653e\u9501\u7684\u8bdd\uff0c\u9700\u8981\u6267\u884c\u4ee5\u4e0bSql:</p> <pre><code>delete from methodLock where method_name ='method_name'\n</code></pre> <p>\u4e0a\u9762\u8fd9\u79cd\u7b80\u5355\u7684\u5b9e\u73b0\u6709\u4ee5\u4e0b\u51e0\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u8fd9\u628a\u9501\u5f3a\u4f9d\u8d56\u6570\u636e\u5e93\u7684\u53ef\u7528\u6027\uff0c\u6570\u636e\u5e93\u662f\u4e00\u4e2a\u5355\u70b9\uff0c\u4e00\u65e6\u6570\u636e\u5e93\u6302\u6389\uff0c\u4f1a\u5bfc\u81f4\u4e1a\u52a1\u7cfb\u7edf\u4e0d\u53ef\u7528\u3002</li> </ol> <p>\u641e\u4e24\u4e2a\u6570\u636e\u5e93\uff0c\u53cc\u5411\u540c\u6b65\u3002\u4e00\u65e6\u6302\u6389\u5feb\u901f\u5207\u6362\u5230\u5907\u5e93\u4e0a\u3002    </p> <ol> <li>\u8fd9\u628a\u9501\u6ca1\u6709\u5931\u6548\u65f6\u95f4\uff0c\u4e00\u65e6\u89e3\u9501\u64cd\u4f5c\u5931\u8d25\uff0c\u5c31\u4f1a\u5bfc\u81f4\u9501\u8bb0\u5f55\u4e00\u76f4\u5728\u6570\u636e\u5e93\u4e2d\uff0c\u5176\u4ed6\u7ebf\u7a0b\u65e0\u6cd5\u518d\u83b7\u5f97\u5230\u9501\u3002</li> </ol> <p>\u200b    \u6ca1\u6709\u5931\u6548\u65f6\u95f4\uff1f\u53ea\u8981\u505a\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u9694\u4e00\u5b9a\u65f6\u95f4\u628a\u6570\u636e\u5e93\u4e2d\u7684\u8d85\u65f6\u6570\u636e\u6e05\u7406\u4e00\u904d\u3002</p> <ol> <li>\u8fd9\u628a\u9501\u53ea\u80fd\u662f\u975e\u963b\u585e\u7684\uff0c\u56e0\u4e3a\u6570\u636e\u7684insert\u64cd\u4f5c\uff0c\u4e00\u65e6\u63d2\u5165\u5931\u8d25\u5c31\u4f1a\u76f4\u63a5\u62a5\u9519\u3002\u6ca1\u6709\u83b7\u5f97\u9501\u7684\u7ebf\u7a0b\u5e76\u4e0d\u4f1a\u8fdb\u5165\u6392\u961f\u961f\u5217\uff0c\u8981\u60f3\u518d\u6b21\u83b7\u5f97\u9501\u5c31\u8981\u518d\u6b21\u89e6\u53d1\u83b7\u5f97\u9501\u64cd\u4f5c\u3002</li> </ol> <p>\u641e\u4e00\u4e2awhile\u5faa\u73af\uff0c\u76f4\u5230insert\u6210\u529f\u518d\u8fd4\u56de\u6210\u529f\u3002</p> <ol> <li>\u8fd9\u628a\u9501\u662f\u975e\u91cd\u5165\u7684\uff0c\u540c\u4e00\u4e2a\u7ebf\u7a0b\u5728\u6ca1\u6709\u91ca\u653e\u9501\u4e4b\u524d\u65e0\u6cd5\u518d\u6b21\u83b7\u5f97\u8be5\u9501\u3002\u56e0\u4e3a\u6570\u636e\u4e2d\u6570\u636e\u5df2\u7ecf\u5b58\u5728\u4e86\u3002</li> </ol> <p>\u200b    \u5728\u6570\u636e\u5e93\u8868\u4e2d\u52a0\u4e2a\u5b57\u6bb5\uff0c\u8bb0\u5f55\u5f53\u524d\u83b7\u5f97\u9501\u7684\u673a\u5668\u7684\u4e3b\u673a\u4fe1\u606f\u548c\u7ebf\u7a0b\u4fe1\u606f\uff0c\u90a3\u4e48\u4e0b\u6b21\u518d\u83b7\u53d6\u9501\u7684\u65f6\u5019\u5148\u67e5\u8be2\u6570\u636e\u5e93\uff0c\u5982\u679c\u5f53\u524d\u673a\u5668\u7684\u4e3b\u673a\u4fe1\u606f\u548c\u7ebf\u7a0b\u4fe1\u606f\u5728\u6570\u636e\u5e93\u53ef\u4ee5\u67e5\u5230\u7684\u8bdd\uff0c\u76f4\u63a5\u628a\u9501\u5206\u914d\u7ed9\u4ed6\u5c31\u53ef\u4ee5\u4e86\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#_2","title":"\u57fa\u4e8e\u6570\u636e\u5e93\u6392\u4ed6\u9501","text":"<p>\u9664\u4e86\u53ef\u4ee5\u901a\u8fc7\u589e\u5220\u64cd\u4f5c\u6570\u636e\u8868\u4e2d\u7684\u8bb0\u5f55\u4ee5\u5916\uff0c\u5176\u5b9e\u8fd8\u53ef\u4ee5\u501f\u52a9\u6570\u636e\u4e2d\u81ea\u5e26\u7684\u9501\u6765\u5b9e\u73b0\u5206\u5e03\u5f0f\u7684\u9501\u3002</p> <p>\u6211\u4eec\u8fd8\u7528\u521a\u521a\u521b\u5efa\u7684\u90a3\u5f20\u6570\u636e\u5e93\u8868\u3002\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u5e93InnoDB\u5f15\u64ce\u7684\u6392\u4ed6\u9501\u6765\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u3002\uff1a</p> <pre><code>public boolean lock(){\n    connection.setAutoCommit(false)\n    while(true){\n        try{\n            result = select * from methodLock where method_name=xxx for update;\n            if(result==null){\n                return true;\n            }\n        }catch(Exception e){\n        }\n        sleep(1000);\n    }\n    return false;\n}\n</code></pre> <p>\u5728\u67e5\u8be2\u8bed\u53e5\u540e\u9762\u589e\u52a0<code>for update</code>\uff0c\u6570\u636e\u5e93\u4f1a\u5728\u67e5\u8be2\u8fc7\u7a0b\u4e2d\u7ed9\u6570\u636e\u5e93\u8868\u589e\u52a0\u6392\u4ed6\u9501</p> <p>\u8fd9\u91cc\u518d\u591a\u63d0\u4e00\u53e5\uff0cInnoDB\u5f15\u64ce\u5728\u52a0\u9501\u7684\u65f6\u5019\uff0c\u53ea\u6709\u901a\u8fc7\u7d22\u5f15\u8fdb\u884c\u68c0\u7d22\u7684\u65f6\u5019\u624d\u4f1a\u4f7f\u7528\u884c\u7ea7\u9501\uff0c\u5426\u5219\u4f1a\u4f7f\u7528\u8868\u7ea7\u9501\u3002\u8fd9\u91cc\u6211\u4eec\u5e0c\u671b\u4f7f\u7528\u884c\u7ea7\u9501\uff0c\u5c31\u8981\u7ed9method_name\u6dfb\u52a0\u7d22\u5f15\uff0c\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e2a\u7d22\u5f15\u4e00\u5b9a\u8981\u521b\u5efa\u6210\u552f\u4e00\u7d22\u5f15\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u591a\u4e2a\u91cd\u8f7d\u65b9\u6cd5\u4e4b\u95f4\u65e0\u6cd5\u540c\u65f6\u88ab\u8bbf\u95ee\u7684\u95ee\u9898\u3002\u91cd\u8f7d\u65b9\u6cd5\u7684\u8bdd\u5efa\u8bae\u628a\u53c2\u6570\u7c7b\u578b\u4e5f\u52a0\u4e0a\uff09\u3002\u5f53\u67d0\u6761\u8bb0\u5f55\u88ab\u52a0\u4e0a\u6392\u4ed6\u9501\u4e4b\u540e\uff0c\u5176\u4ed6\u7ebf\u7a0b\u65e0\u6cd5\u518d\u5728\u8be5\u884c\u8bb0\u5f55\u4e0a\u589e\u52a0\u6392\u4ed6\u9501\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u83b7\u5f97\u6392\u5b83\u9501\u7684\u7ebf\u7a0b\u5373\u53ef\u83b7\u5f97\u5206\u5e03\u5f0f\u9501\uff0c\u5f53\u83b7\u53d6\u5230\u9501\u4e4b\u540e\uff0c\u53ef\u4ee5\u6267\u884c\u65b9\u6cd5\u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u6267\u884c\u5b8c\u65b9\u6cd5\u4e4b\u540e\uff0c\u518d\u901a\u8fc7\u4ee5\u4e0b\u65b9\u6cd5\u89e3\u9501\uff1a</p> <pre><code>public void unlock(){\n    connection.commit();\n}\n</code></pre> <p>\u901a\u8fc7<code>connection.commit()</code>\u64cd\u4f5c\u6765\u91ca\u653e\u9501\u3002</p> <p>\u8fd9\u79cd\u65b9\u6cd5\u53ef\u4ee5\u6709\u6548\u7684\u89e3\u51b3\u4e0a\u9762\u63d0\u5230\u7684\u65e0\u6cd5\u91ca\u653e\u9501\u548c\u963b\u585e\u9501\u7684\u95ee\u9898\u3002</p> <ul> <li>\u963b\u585e\u9501\uff1f <code>for update</code>\u8bed\u53e5\u4f1a\u5728\u6267\u884c\u6210\u529f\u540e\u7acb\u5373\u8fd4\u56de\uff0c\u5728\u6267\u884c\u5931\u8d25\u65f6\u4e00\u76f4\u5904\u4e8e\u963b\u585e\u72b6\u6001\uff0c\u76f4\u5230\u6210\u529f\u3002</li> <li>\u9501\u5b9a\u4e4b\u540e\u670d\u52a1\u5b95\u673a\uff0c\u65e0\u6cd5\u91ca\u653e\uff1f\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u670d\u52a1\u5b95\u673a\u4e4b\u540e\u6570\u636e\u5e93\u4f1a\u81ea\u5df1\u628a\u9501\u91ca\u653e\u6389\u3002</li> </ul> <p>\u4f46\u662f\u8fd8\u662f\u65e0\u6cd5\u76f4\u63a5\u89e3\u51b3\u6570\u636e\u5e93\u5355\u70b9\u548c\u53ef\u91cd\u5165\u95ee\u9898\u3002</p> <p>\u8fd9\u91cc\u8fd8\u53ef\u80fd\u5b58\u5728\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff0c\u867d\u7136\u6211\u4eec\u5bf9<code>method_name</code> \u4f7f\u7528\u4e86\u552f\u4e00\u7d22\u5f15\uff0c\u5e76\u4e14\u663e\u793a\u4f7f\u7528<code>for update</code>\u6765\u4f7f\u7528\u884c\u7ea7\u9501\u3002\u4f46\u662f\uff0cMySql\u4f1a\u5bf9\u67e5\u8be2\u8fdb\u884c\u4f18\u5316\uff0c\u5373\u4fbf\u5728\u6761\u4ef6\u4e2d\u4f7f\u7528\u4e86\u7d22\u5f15\u5b57\u6bb5\uff0c\u4f46\u662f\u5426\u4f7f\u7528\u7d22\u5f15\u6765\u68c0\u7d22\u6570\u636e\u662f\u7531 MySQL \u901a\u8fc7\u5224\u65ad\u4e0d\u540c\u6267\u884c\u8ba1\u5212\u7684\u4ee3\u4ef7\u6765\u51b3\u5b9a\u7684\uff0c\u5982\u679c MySQL \u8ba4\u4e3a\u5168\u8868\u626b\u6548\u7387\u66f4\u9ad8\uff0c\u6bd4\u5982\u5bf9\u4e00\u4e9b\u5f88\u5c0f\u7684\u8868\uff0c\u5b83\u5c31\u4e0d\u4f1a\u4f7f\u7528\u7d22\u5f15\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b InnoDB \u5c06\u4f7f\u7528\u8868\u9501\uff0c\u800c\u4e0d\u662f\u884c\u9501\u3002\u5982\u679c\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5\u5c31\u60b2\u5267\u4e86\u3002\u3002\u3002</p> <p>\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u6211\u4eec\u8981\u4f7f\u7528\u6392\u4ed6\u9501\u6765\u8fdb\u884c\u5206\u5e03\u5f0f\u9501\u7684lock\uff0c\u90a3\u4e48\u4e00\u4e2a\u6392\u4ed6\u9501\u957f\u65f6\u95f4\u4e0d\u63d0\u4ea4\uff0c\u5c31\u4f1a\u5360\u7528\u6570\u636e\u5e93\u8fde\u63a5\u3002\u4e00\u65e6\u7c7b\u4f3c\u7684\u8fde\u63a5\u53d8\u5f97\u591a\u4e86\uff0c\u5c31\u53ef\u80fd\u628a\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u6491\u7206</p> <p>\u603b\u7ed3\u4e00\u4e0b\u4f7f\u7528\u6570\u636e\u5e93\u6765\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u7684\u65b9\u5f0f\uff0c\u8fd9\u4e24\u79cd\u65b9\u5f0f\u90fd\u662f\u4f9d\u8d56\u6570\u636e\u5e93\u7684\u4e00\u5f20\u8868\uff0c\u4e00\u79cd\u662f\u901a\u8fc7\u8868\u4e2d\u7684\u8bb0\u5f55\u7684\u5b58\u5728\u60c5\u51b5\u786e\u5b9a\u5f53\u524d\u662f\u5426\u6709\u9501\u5b58\u5728\uff0c\u53e6\u5916\u4e00\u79cd\u662f\u901a\u8fc7\u6570\u636e\u5e93\u7684\u6392\u4ed6\u9501\u6765\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u3002</p> <p>\u6570\u636e\u5e93\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u7684\u4f18\u70b9</p> <p>\u76f4\u63a5\u501f\u52a9\u6570\u636e\u5e93\uff0c\u5bb9\u6613\u7406\u89e3\u3002</p> <p>\u6570\u636e\u5e93\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u7684\u7f3a\u70b9</p> <p>\u4f1a\u6709\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u5728\u89e3\u51b3\u95ee\u9898\u7684\u8fc7\u7a0b\u4e2d\u4f1a\u4f7f\u6574\u4e2a\u65b9\u6848\u53d8\u5f97\u8d8a\u6765\u8d8a\u590d\u6742\u3002</p> <p>\u64cd\u4f5c\u6570\u636e\u5e93\u9700\u8981\u4e00\u5b9a\u7684\u5f00\u9500\uff0c\u6027\u80fd\u95ee\u9898\u9700\u8981\u8003\u8651\u3002</p> <p>\u4f7f\u7528\u6570\u636e\u5e93\u7684\u884c\u7ea7\u9501\u5e76\u4e0d\u4e00\u5b9a\u9760\u8c31\uff0c\u5c24\u5176\u662f\u5f53\u6211\u4eec\u7684\u9501\u8868\u5e76\u4e0d\u5927\u7684\u65f6\u5019\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#2-redis","title":"2. \u57fa\u4e8eredis\u7684\u5206\u5e03\u5f0f\u9501","text":"<p>\u53ef\u4ee5\u81ea\u5df1\u5b9e\u73b0</p> <pre><code>import org.aspectj.lang.ProceedingJoinPoint;\nimport org.aspectj.lang.annotation.Around;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.reflect.MethodSignature;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.data.redis.connection.RedisStringCommands;\nimport org.springframework.data.redis.core.RedisCallback;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.data.redis.core.types.Expiration;\nimport org.springframework.stereotype.Component;\nimport java.lang.reflect.Method;\nimport java.nio.charset.Charset;\nimport java.util.Objects;\nimport java.util.UUID;\nimport java.util.concurrent.TimeUnit;\n@Aspect \n@Component \npublic class RedisLockAop {\n\n    private final Logger logger = LoggerFactory.getLogger(RedisLockAop.class);\n\n    private static final Charset UTF8 = Charset.forName(\"UTF-8\");\n\n    private final StringRedisTemplate stringRedisTemplate;\n\n    public RedisLockAop(StringRedisTemplate stringRedisTemplate) {\n        this.stringRedisTemplate = stringRedisTemplate;\n    }\n\n\n    @Around(\"@annotation(*.service.frame.annotation.RedisLock)\")\n    public Object interceptor(ProceedingJoinPoint pjp) {\n        /* \u62fc\u63a5lock key */\n        MethodSignature signature = (MethodSignature) pjp.getSignature();\n        Method method = signature.getMethod();\n        final String lockKey = \"redisLock:\" + pjp.getSignature().getDeclaringTypeName() + \":\" + method.getName();\n        String requestId = UUID.randomUUID().toString();\n        RedisLock redisLock = method.getAnnotation(RedisLock.class);\n\n        if (!lock(redisLock, lockKey, requestId)) {\n            throw new IoTException(ApiCode.REQUEST_FREQUENCY);\n        }\n\n        try {\n            return pjp.proceed();\n        } catch (Throwable throwable) {\n            logger.error(\"aop method execute failed\", throwable);\n            throw new IoTException(ApiCode.FAIL);\n        } finally {\n            unlock(lockKey, requestId);\n        }\n    }\n\n\n    /**\n     * \u52a0\u9501\n     *\n     */\n    private boolean lock(RedisLock lock, String lockKey, String requestId) {\n        long end = System.currentTimeMillis() + lock.timeout() * 1000;\n        while (System.currentTimeMillis() &lt; end) {\n            if (tryLock(lockKey, requestId, lock.expire(), lock.timeUnit())) {\n                return true;\n            } else {\n                try {\n                    logger.info(\"waiting for acquiring lock\");\n                    TimeUnit.MILLISECONDS.sleep(200);\n                } catch (InterruptedException e) {\n                    logger.error(\"redis lock occurs interrupted exception.\", e);\n                }\n            }\n        }\n        return false;\n    }\n\n    /**\n     * \u89e3\u9501\n     */\n    private void unlock(String lockKey, String requestId) {\n        releaseLock(lockKey, requestId);\n    }\n\n    /**\n     * \u83b7\u53d6\u5206\u5e03\u5f0f\u9501\uff0c\u539f\u5b50\u64cd\u4f5c\n     *\n     * @param lockKey   \u52a0\u9501key\n     * @param requestId \u52a0\u9501\u8bf7\u6c42\u552f\u4e00ID, \u53ef\u4ee5\u4f7f\u7528UUID.randomUUID().toString();\n     * @param expire    \u8fc7\u671f\u65f6\u95f4\n     * @param timeUnit  \u65f6\u95f4\u5355\u4f4d\n     * @return\n     */\n    private boolean tryLock(String lockKey, String requestId, long expire, TimeUnit timeUnit) {\n        try {\n            RedisCallback&lt;Boolean&gt; callback = (connection) -&gt; connection.set(lockKey.getBytes(UTF8), requestId.getBytes(UTF8),                                                                            \n                                                                             Expiration.seconds(timeUnit.toSeconds(expire)), RedisStringCommands.SetOption.SET_IF_ABSENT);\n            return stringRedisTemplate.execute(callback);\n        } catch (Exception e) {\n            logger.error(\"redis lock error.\", e);\n        }\n        return false;\n    }\n\n    /**\n     * \u91ca\u653e\u9501\n     *\n     * @param lockKey   \u52a0\u9501key\n     * @param requestId \u52a0\u9501\u8bf7\u6c42\u552f\u4e00ID\n     * @return\n     */\n    private boolean releaseLock(String lockKey, String requestId) {\n        String value = stringRedisTemplate.opsForValue().get(lockKey);\n        if (Objects.equals(value, requestId)) {\n            stringRedisTemplate.delete(lockKey);\n            return true;\n        }\n        logger.error(\"release redis lock failed, lockKey: {}, requestId: {}.\", lockKey, requestId);\n        return false;\n    }\n\n}\n</code></pre> <p>\u53ef\u4ee5\u6ee1\u8db3\u963b\u585e\u5f0f\uff0c\u81ea\u52a8\u5931\u6548\uff0c\u53ef\u91cd\u5165\u7684\u9700\u6c42\u3002</p> <p>\u8bbe\u7f6etimeout\u662f\u4e3a\u4e86\u963b\u585e\u5f0f\u7684\u83b7\u53d6\u9501\uff1b</p> <p>\u8bbe\u7f6eexpire\u662f\u4e3a\u4e86\u9632\u6b62\u673a\u5668down\u6389\u6ca1\u6709\u4e3b\u52a8\u53bb\u91ca\u653e\u5220\u9664\u9501\uff0c\u6240\u4ee5\u9700\u8981\u9501\u81ea\u52a8\u5931\u6548\uff1b\u4f46\u662f\u4e5f\u4e0d\u80fd\u8bbe\u7f6e\u7684\u8fc7\u4e8e\u5927\uff0c\u5426\u5219\u67d0\u53f0\u673a\u5668\u83b7\u53d6\u9501\u540edown\u6389\uff0c\u5176\u4ed6\u673a\u5668\u8981\u8fc75\u5206\u949f\u624d\u80fd\u518d\u6b21\u83b7\u53d6\u9501\uff0c\u5927\u5927\u5f71\u54cd\u4e1a\u52a1\uff01</p> <p>\u8bbe\u7f6erequestId\u662f\u4e3a\u4e86\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\uff0c\u67d0\u7ebf\u7a0b\u67d0\u6b21\u6267\u884c\u4e86\u5f88\u4e45\uff0c\u9501\u8d85\u8fc7\u4e86expire\u81ea\u52a8\u5931\u6548\uff0c\u7136\u540e\u7b2c\u4e8c\u4e2a\u7ebf\u7a0b\u83b7\u53d6\u9501\uff0c\u4f46\u662f\u8fd8\u6ca1\u6267\u884c\u5b8c\uff0c\u6b63\u597d\u7b2c\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u5b8c\u628a\u9501\u91ca\u653e\u6389\uff01\u8fd9\u6837\u9ad8\u5e76\u53d1\u4e0b\u8fde\u9501\u7684\u5bfc\u81f4\u9501\u88ab\u524d\u4e00\u4e2a\u7ebf\u7a0b\u91ca\u653e\u6389\uff0c\u9020\u6210\u9501\u5931\u6548\u3002</p> <p>\u53e6\u5916\u5982\u679c\u4efb\u52a1\u8d85\u65f6\u6709\u53ef\u80fd\u83b7\u53d6\u9501\u540e\u7a81\u7136\u8981\u6267\u884c\u5f88\u4e45\uff0c\u8d85\u8fc7\u9884\u4f30\u7684timeout\u3002\u9700\u8981\u53e6\u5916\u7ebf\u7a0b\u7eed\u547d\u3002\u73b0\u6709\u6846\u67b6redission\uff0c\u540e\u53f0\u4f7f\u7528lua\u811a\u672c\uff0c\u5e76\u4e141/3\u65f6\u95f4\u4e3a\u8fd9\u628a\u9501\u5ef6\u957f\u65f6\u95f4\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#redlock","title":"redLock\u7b97\u6cd5\u89e3\u51b3\u5355\u70b9\u6545\u969c","text":"<p>\u5728Redis\u7684master\u8282\u70b9\u4e0a\u62ff\u5230\u4e86\u9501\uff0c\u4f46\u662f\u8fd9\u4e2a\u52a0\u9501\u7684key\u8fd8\u6ca1\u6709\u540c\u6b65\u5230slave\u8282\u70b9\u3002master\u6545\u969c\uff0c\u53d1\u751f\u6545\u969c\u8f6c\u79fb\uff0cslave\u8282\u70b9\u5347\u7ea7\u4e3amaster\u8282\u70b9\uff0c\u5bfc\u81f4\u9501\u4e22\u5931\u3002\u600e\u4e48\u529e\uff1f\u9762\u8bd5\u91cd\u70b9</p> <p>redLock\u5b98\u65b9\u8bf4\u660e</p> <p>\u5728\u7b97\u6cd5\u7684\u5206\u5e03\u5f0f\u7248\u672c\u4e2d\uff0c\u6211\u4eec\u5047\u8bbe\u6211\u4eec\u6709 N \u4e2a Redis \u4e3b\u8282\u70b9\u3002\u8fd9\u4e9b\u8282\u70b9\u662f\u5b8c\u5168\u72ec\u7acb\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u4e0d\u4f7f\u7528\u590d\u5236\u6216\u4efb\u4f55\u5176\u4ed6\u9690\u5f0f\u534f\u8c03\u7cfb\u7edf\u3002\u6211\u4eec\u5df2\u7ecf\u63cf\u8ff0\u4e86\u5982\u4f55\u5728\u5355\u4e2a\u5b9e\u4f8b\u4e2d\u5b89\u5168\u5730\u83b7\u53d6\u548c\u91ca\u653e\u9501\u3002\u6211\u4eec\u7406\u6240\u5f53\u7136\u5730\u8ba4\u4e3a\u7b97\u6cd5\u4f1a\u5728\u5355\u4e2a\u5b9e\u4f8b\u4e2d\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u6765\u83b7\u53d6\u548c\u91ca\u653e\u9501\u3002\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u8bbe\u7f6e\u4e86 N=5\uff0c\u8fd9\u662f\u4e00\u4e2a\u5408\u7406\u7684\u503c\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5728\u4e0d\u540c\u7684\u8ba1\u7b97\u673a\u6216\u865a\u62df\u673a\u4e0a\u8fd0\u884c 5 \u4e2a Redis \u4e3b\u8282\u70b9\uff0c\u4ee5\u786e\u4fdd\u5b83\u4eec\u4ee5\u51e0\u4e4e\u72ec\u7acb\u7684\u65b9\u5f0f\u5931\u8d25\u3002</p> <p>\u4e3a\u4e86\u83b7\u53d6\u9501\uff0c\u5ba2\u6237\u7aef\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ol> <li>\u5b83\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u83b7\u53d6\u5f53\u524d\u65f6\u95f4\u3002</li> <li>\u5b83\u5c1d\u8bd5\u987a\u5e8f\u83b7\u53d6\u6240\u6709 N \u4e2a\u5b9e\u4f8b\u4e2d\u7684\u9501\uff0c\u5728\u6240\u6709\u5b9e\u4f8b\u4e2d\u4f7f\u7528\u76f8\u540c\u7684\u952e\u540d\u548c\u968f\u673a\u503c\u3002\u5728\u7b2c 2 \u6b65\u4e2d\uff0c\u5728\u6bcf\u4e2a\u5b9e\u4f8b\u4e2d\u8bbe\u7f6e\u9501\u65f6\uff0c\u5ba2\u6237\u7aef\u4f7f\u7528\u4e00\u4e2a\u8d85\u65f6\u65f6\u95f4\uff0c\u8be5\u8d85\u65f6\u65f6\u95f4\u4e0e\u603b\u9501\u81ea\u52a8\u91ca\u653e\u65f6\u95f4\u76f8\u6bd4\u8f83\u5c0f\uff0c\u4ee5\u4fbf\u83b7\u53d6\u5b83\u3002\u4f8b\u5982\uff0c\u5982\u679c\u81ea\u52a8\u91ca\u653e\u65f6\u95f4\u4e3a 10 \u79d2\uff0c\u5219\u8d85\u65f6\u53ef\u80fd\u57285-50 \u6beb\u79d2\u8303\u56f4\u5185\u3002\u8fd9\u53ef\u4ee5\u9632\u6b62\u5ba2\u6237\u7aef\u957f\u65f6\u95f4\u5904\u4e8e\u963b\u585e\u72b6\u6001\uff0c\u8bd5\u56fe\u4e0e\u5173\u95ed\u7684 Redis \u8282\u70b9\u5bf9\u8bdd\uff1a\u5982\u679c\u5b9e\u4f8b\u4e0d\u53ef\u7528\uff0c\u6211\u4eec\u5e94\u8be5\u5c3d\u5feb\u5c1d\u8bd5\u4e0e\u4e0b\u4e00\u4e2a\u5b9e\u4f8b\u5bf9\u8bdd\u3002</li> <li>\u5ba2\u6237\u7aef\u901a\u8fc7\u4ece\u5f53\u524d\u65f6\u95f4\u4e2d\u51cf\u53bb\u6b65\u9aa4 1 \u4e2d\u83b7\u5f97\u7684\u65f6\u95f4\u6233\u6765\u8ba1\u7b97\u83b7\u53d6\u9501\u6240\u7528\u7684\u65f6\u95f4\u3002 \u5f53\u4e14\u4ec5\u5f53\u5ba2\u6237\u7aef\u80fd\u591f\u5728\u5927\u591a\u6570\u5b9e\u4f8b\uff08\u81f3\u5c11 3 \u4e2a\uff09\u4e2d\u83b7\u53d6\u9501\uff0c\u5e76\u4e14\u83b7\u53d6\u9501\u6240\u7528\u7684\u603b\u65f6\u95f4\u5c0f\u4e8e\u9501\u6709\u6548\u65f6\u95f4\uff0c\u5219\u8ba4\u4e3a\u8be5\u9501\u5df2\u83b7\u53d6\u3002</li> <li>\u5982\u679c\u83b7\u5f97\u4e86\u9501\uff0c\u5219\u5176\u6709\u6548\u65f6\u95f4\u88ab\u89c6\u4e3a\u521d\u59cb\u6709\u6548\u65f6\u95f4\u51cf\u53bb\u7ecf\u8fc7\u7684\u65f6\u95f4\uff0c\u5982\u6b65\u9aa4 3 \u4e2d\u8ba1\u7b97\u7684\u90a3\u6837\u3002</li> <li>\u5982\u679c\u5ba2\u6237\u7aef\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\u83b7\u53d6\u9501\u5931\u8d25\uff08\u6216\u8005\u5b83\u65e0\u6cd5\u9501\u5b9a N/2+1 \u4e2a\u5b9e\u4f8b\u6216\u6709\u6548\u65f6\u95f4\u4e3a\u8d1f\uff09\uff0c\u5b83\u5c06\u5c1d\u8bd5\u89e3\u9501\u6240\u6709\u5b9e\u4f8b\uff08\u5373\u4f7f\u662f\u5b83\u8ba4\u4e3a\u6ca1\u6709\u9501\u5b9a\u7684\u5b9e\u4f8b\uff09\u80fd\u591f\u9501\u5b9a\uff09\u3002</li> </ol> <p>redlock\u5206\u6790</p> <p>redisson\u4e5f\u652f\u6301redlock\u7684\u7b97\u6cd5\uff0c\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>Config config1 = new Config();\nconfig1.useSingleServer().setAddress(\"redis://100.100.0.1:5378\")\n        .setPassword(\"root\").setDatabase(0);\nRedissonClient redissonClient1 = Redisson.create(config1);\n\nConfig config2 = new Config();\nconfig2.useSingleServer().setAddress(\"redis://100.100.0.1:5379\")\n        .setPassword(\"root\").setDatabase(0);\nRedissonClient redissonClient2 = Redisson.create(config2);\n\nConfig config3 = new Config();\nconfig3.useSingleServer().setAddress(\"redis://100.100.0.1:5380\")\n        .setPassword(\"root\").setDatabase(0);\nRedissonClient redissonClient3 = Redisson.create(config3);\n\nString resourceName = \"REDLOCK\";\n\nRLock lock1 = redissonClient1.getLock(resourceName);\nRLock lock2 = redissonClient2.getLock(resourceName);\nRLock lock3 = redissonClient3.getLock(resourceName);\nRedissonRedLock redLock = new RedissonRedLock(lock1, lock2, lock3);\nboolean isLock;\ntry {\n    // isLock = redLock.tryLock();\n    // 500ms\u62ff\u4e0d\u5230\u9501, \u5c31\u8ba4\u4e3a\u83b7\u53d6\u9501\u5931\u8d25\u300210000ms\u537310s\u662f\u9501\u5931\u6548\u65f6\u95f4\u3002\n    isLock = redLock.tryLock(500, 10000, TimeUnit.MILLISECONDS);\n    System.out.println(\"isLock = \"+isLock);\n    if (isLock) {\n        //TODO \u8fd9\u91cc\u5199\u4e1a\u52a1\u903b\u8f91\n    }\n} catch (Exception e) {\n} finally {\n    // \u65e0\u8bba\u5982\u4f55, \u6700\u540e\u90fd\u8981\u89e3\u9501\n    redLock.unlock();\n}\n</code></pre> <p>redission\u6e90\u7801\u7b80\u5355\u7406\u89e3\u5c31\u662f\u5faa\u73af\u7684\u53d6\u5404\u4e2a\u4e3b\u8282\u70b9\u83b7\u53d6\u9501\uff0c\u5224\u65ad\u5982\u679c\u6210\u529f\u83b7\u53d6\u8d85\u8fc7n/2+1\uff0c\u5c31\u8ba4\u4e3a\u52a0\u9501\u6210\u529f\uff0c\u5426\u5219\u5faa\u73af\u5411\u5404\u4e2a\u4e3b\u8282\u70b9\u91ca\u653e\u9501\u3002</p> <pre><code>public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException {\n    long newLeaseTime = -1;\n    if (leaseTime != -1) {\n        // \u5982\u679c\u7b49\u5f85\u65f6\u95f4\u8bbe\u7f6e\u4e86\uff0c\u90a3\u4e48\u5c06\u7b49\u5f85\u65f6\u95f4 * 2\n        newLeaseTime = unit.toMillis(waitTime)*2;\n    }\n\n    // time\u4e3a\u5f53\u524d\u65f6\u95f4\u6233\n    long time = System.currentTimeMillis();\n    long remainTime = -1;\n    if (waitTime != -1) {\n        remainTime = unit.toMillis(waitTime);\n    }\n    // \u8ba1\u7b97\u9501\u7684\u7b49\u5f85\u65f6\u95f4\uff0cRedLock\u4e2d\uff1a\u5982\u679cremainTime=-1\uff0c\u90a3\u4e48lockWaitTime\u4e3a1\n    long lockWaitTime = calcLockWaitTime(remainTime);\n\n    // RedLock\u4e2dfailedLocksLimit\u5373\u4e3an/2 + 1\n    int failedLocksLimit = failedLocksLimit();\n    List&lt;RLock&gt; acquiredLocks = new ArrayList&lt;RLock&gt;(locks.size());\n    // \u5faa\u73af\u6bcf\u4e2aredis\u5ba2\u6237\u7aef\uff0c\u53bb\u83b7\u53d6\u9501\n    for (ListIterator&lt;RLock&gt; iterator = locks.listIterator(); iterator.hasNext();) {\n        RLock lock = iterator.next();\n        boolean lockAcquired;\n        try {\n            // \u8c03\u7528tryLock\u65b9\u6cd5\u53bb\u83b7\u53d6\u9501\uff0c\u5982\u679c\u83b7\u53d6\u9501\u6210\u529f\uff0c\u5219lockAcquired=true\n            if (waitTime == -1 &amp;&amp; leaseTime == -1) {\n                lockAcquired = lock.tryLock();\n            } else {\n                //\u8fd9\u91cc\u4e5f\u4f1a\u6709\u9501\u7eed\u7ea6\u7684\u95ee\u9898\u3002\n                long awaitTime = Math.min(lockWaitTime, remainTime);\n                lockAcquired = lock.tryLock(awaitTime, newLeaseTime, TimeUnit.MILLISECONDS);\n            }\n        } catch (Exception e) {\n            lockAcquired = false;\n        }\n\n        // \u5982\u679c\u83b7\u53d6\u9501\u6210\u529f\uff0c\u5c06\u9501\u52a0\u5165\u5230list\u96c6\u5408\u4e2d\n        if (lockAcquired) {\n            acquiredLocks.add(lock);\n        } else {\n            // \u5982\u679c\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u5224\u65ad\u5931\u8d25\u6b21\u6570\u662f\u5426\u7b49\u4e8e\u5931\u8d25\u7684\u9650\u5236\u6b21\u6570\n            // \u6bd4\u5982\uff0c3\u4e2aredis\u5ba2\u6237\u7aef\uff0c\u6700\u591a\u53ea\u80fd\u5931\u8d251\u6b21\n            // \u8fd9\u91cclocks.size = 3, 3-x=1\uff0c\u8bf4\u660e\u53ea\u8981\u6210\u529f\u4e862\u6b21\u5c31\u53ef\u4ee5\u76f4\u63a5break\u6389\u5faa\u73af\n            if (locks.size() - acquiredLocks.size() == failedLocksLimit()) {\n                break;\n            }\n\n            // \u5982\u679c\u6700\u5927\u5931\u8d25\u6b21\u6570\u7b49\u4e8e0\n            if (failedLocksLimit == 0) {\n                // \u91ca\u653e\u6240\u6709\u7684\u9501\uff0cRedLock\u52a0\u9501\u5931\u8d25\n                unlockInner(acquiredLocks);\n                if (waitTime == -1 &amp;&amp; leaseTime == -1) {\n                    return false;\n                }\n                failedLocksLimit = failedLocksLimit();\n                acquiredLocks.clear();\n                // \u91cd\u7f6e\u8fed\u4ee3\u5668 \u91cd\u8bd5\u518d\u6b21\u83b7\u53d6\u9501\n                while (iterator.hasPrevious()) {\n                    iterator.previous();\n                }\n            } else {\n                // \u5931\u8d25\u7684\u9650\u5236\u6b21\u6570\u51cf\u4e00\n                // \u6bd4\u59823\u4e2aredis\u5b9e\u4f8b\uff0c\u6700\u5927\u7684\u9650\u5236\u6b21\u6570\u662f1\uff0c\u5982\u679c\u904d\u5386\u7b2c\u4e00\u4e2aredis\u5b9e\u4f8b\uff0c\u5931\u8d25\u4e86\uff0c\u90a3\u4e48failedLocksLimit\u4f1a\u51cf\u62100\n                // \u5982\u679cfailedLocksLimit\u5c31\u4f1a\u8d70\u4e0a\u9762\u7684if\u903b\u8f91\uff0c\u91ca\u653e\u6240\u6709\u7684\u9501\uff0c\u7136\u540e\u8fd4\u56defalse\n                failedLocksLimit--;\n            }\n        }\n\n        if (remainTime != -1) {\n            remainTime -= (System.currentTimeMillis() - time);\n            time = System.currentTimeMillis();\n            if (remainTime &lt;= 0) {\n                unlockInner(acquiredLocks);\n                return false;\n            }\n        }\n    }\n\n    if (leaseTime != -1) {\n        List&lt;RFuture&lt;Boolean&gt;&gt; futures = new ArrayList&lt;RFuture&lt;Boolean&gt;&gt;(acquiredLocks.size());\n        for (RLock rLock : acquiredLocks) {\n            RFuture&lt;Boolean&gt; future = rLock.expireAsync(unit.toMillis(leaseTime), TimeUnit.MILLISECONDS);\n            futures.add(future);\n        }\n\n        for (RFuture&lt;Boolean&gt; rFuture : futures) {\n            rFuture.syncUninterruptibly();\n        }\n    }\n\n    return true;\n}\n</code></pre>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#3-zookeeper","title":"3. \u57fa\u4e8ezookeeper","text":"<p>\u975e\u5e38\u597d\uff0c\u5e76\u4e14\u4e5f\u6709\u73b0\u6210\u7684\u6846\u67b6Curator\u5b9e\u73b0\uff0c\u57fa\u672c\u552f\u4e00\u7684\u7f3a\u70b9\u5c31\u662f\u6027\u80fd\u4e0d\u9ad8</p> <p>\u57fa\u4e8ezookeeper\u4e34\u65f6\u6709\u5e8f\u8282\u70b9\u53ef\u4ee5\u5b9e\u73b0\u7684\u5206\u5e03\u5f0f\u9501\u3002</p> <p>\u5927\u81f4\u601d\u60f3\u5373\u4e3a\uff1a\u6bcf\u4e2a\u5ba2\u6237\u7aef\u5bf9\u67d0\u4e2a\u65b9\u6cd5\u52a0\u9501\u65f6\uff0c\u5728zookeeper\u4e0a\u7684\u4e0e\u8be5\u65b9\u6cd5\u5bf9\u5e94\u7684\u6307\u5b9a\u8282\u70b9\u7684\u76ee\u5f55\u4e0b\uff0c\u751f\u6210\u4e00\u4e2a\u552f\u4e00\u7684\u77ac\u65f6\u6709\u5e8f\u8282\u70b9\u3002 \u5224\u65ad\u662f\u5426\u83b7\u53d6\u9501\u7684\u65b9\u5f0f\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5224\u65ad\u6709\u5e8f\u8282\u70b9\u4e2d\u5e8f\u53f7\u6700\u5c0f\u7684\u4e00\u4e2a\u3002 \u5f53\u91ca\u653e\u9501\u7684\u65f6\u5019\uff0c\u53ea\u9700\u5c06\u8fd9\u4e2a\u77ac\u65f6\u8282\u70b9\u5220\u9664\u5373\u53ef\u3002\u540c\u65f6\uff0c\u5176\u53ef\u4ee5\u907f\u514d\u670d\u52a1\u5b95\u673a\u5bfc\u81f4\u7684\u9501\u65e0\u6cd5\u91ca\u653e\uff0c\u800c\u4ea7\u751f\u7684\u6b7b\u9501\u95ee\u9898\u3002</p> <p>\u6765\u770b\u4e0bZookeeper\u80fd\u4e0d\u80fd\u89e3\u51b3\u524d\u9762\u63d0\u5230\u7684\u95ee\u9898\u3002</p> <ul> <li>\u9501\u65e0\u6cd5\u91ca\u653e\uff1f\u4f7f\u7528Zookeeper\u53ef\u4ee5\u6709\u6548\u7684\u89e3\u51b3\u9501\u65e0\u6cd5\u91ca\u653e\u7684\u95ee\u9898\uff0c\u56e0\u4e3a\u5728\u521b\u5efa\u9501\u7684\u65f6\u5019\uff0c\u5ba2\u6237\u7aef\u4f1a\u5728ZK\u4e2d\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u8282\u70b9\uff0c\u4e00\u65e6\u5ba2\u6237\u7aef\u83b7\u53d6\u5230\u9501\u4e4b\u540e\u7a81\u7136\u6302\u6389\uff08Session\u8fde\u63a5\u65ad\u5f00\uff09\uff0c\u90a3\u4e48\u8fd9\u4e2a\u4e34\u65f6\u8282\u70b9\u5c31\u4f1a\u81ea\u52a8\u5220\u9664\u6389\u3002\u5176\u4ed6\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u518d\u6b21\u83b7\u5f97\u9501\u3002</li> <li>\u975e\u963b\u585e\u9501\uff1f\u4f7f\u7528Zookeeper\u53ef\u4ee5\u5b9e\u73b0\u963b\u585e\u7684\u9501\uff0c\u5ba2\u6237\u7aef\u53ef\u4ee5\u901a\u8fc7\u5728ZK\u4e2d\u521b\u5efa\u987a\u5e8f\u8282\u70b9\uff0c\u5e76\u4e14\u5728\u8282\u70b9\u4e0a\u7ed1\u5b9a\u76d1\u542c\u5668\uff0c\u4e00\u65e6\u8282\u70b9\u6709\u53d8\u5316\uff0cZookeeper\u4f1a\u901a\u77e5\u5ba2\u6237\u7aef\uff0c\u5ba2\u6237\u7aef\u53ef\u4ee5\u68c0\u67e5\u81ea\u5df1\u521b\u5efa\u7684\u8282\u70b9\u662f\u4e0d\u662f\u5f53\u524d\u6240\u6709\u8282\u70b9\u4e2d\u5e8f\u53f7\u6700\u5c0f\u7684\uff0c\u5982\u679c\u662f\uff0c\u90a3\u4e48\u81ea\u5df1\u5c31\u83b7\u53d6\u5230\u9501\uff0c\u4fbf\u53ef\u4ee5\u6267\u884c\u4e1a\u52a1\u903b\u8f91\u4e86\u3002</li> <li>\u4e0d\u53ef\u91cd\u5165\uff1f\u4f7f\u7528Zookeeper\u4e5f\u53ef\u4ee5\u6709\u6548\u7684\u89e3\u51b3\u4e0d\u53ef\u91cd\u5165\u7684\u95ee\u9898\uff0c\u5ba2\u6237\u7aef\u5728\u521b\u5efa\u8282\u70b9\u7684\u65f6\u5019\uff0c\u628a\u5f53\u524d\u5ba2\u6237\u7aef\u7684\u4e3b\u673a\u4fe1\u606f\u548c\u7ebf\u7a0b\u4fe1\u606f\u76f4\u63a5\u5199\u5165\u5230\u8282\u70b9\u4e2d\uff0c\u4e0b\u6b21\u60f3\u8981\u83b7\u53d6\u9501\u7684\u65f6\u5019\u548c\u5f53\u524d\u6700\u5c0f\u7684\u8282\u70b9\u4e2d\u7684\u6570\u636e\u6bd4\u5bf9\u4e00\u4e0b\u5c31\u53ef\u4ee5\u4e86\u3002\u5982\u679c\u548c\u81ea\u5df1\u7684\u4fe1\u606f\u4e00\u6837\uff0c\u90a3\u4e48\u81ea\u5df1\u76f4\u63a5\u83b7\u53d6\u5230\u9501\uff0c\u5982\u679c\u4e0d\u4e00\u6837\u5c31\u518d\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u7684\u987a\u5e8f\u8282\u70b9\uff0c\u53c2\u4e0e\u6392\u961f\u3002</li> <li>\u5355\u70b9\u95ee\u9898\uff1f\u4f7f\u7528Zookeeper\u53ef\u4ee5\u6709\u6548\u7684\u89e3\u51b3\u5355\u70b9\u95ee\u9898\uff0cZK\u662f\u96c6\u7fa4\u90e8\u7f72\u7684\uff0c\u53ea\u8981\u96c6\u7fa4\u4e2d\u6709\u534a\u6570\u4ee5\u4e0a\u7684\u673a\u5668\u5b58\u6d3b\uff0c\u5c31\u53ef\u4ee5\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002</li> </ul> <p>\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528zookeeper\u7b2c\u4e09\u65b9\u5e93Curator\u5ba2\u6237\u7aef\uff0c\u8fd9\u4e2a\u5ba2\u6237\u7aef\u4e2d\u5c01\u88c5\u4e86\u4e00\u4e2a\u53ef\u91cd\u5165\u7684\u9501\u670d\u52a1\u3002Curator\u63d0\u4f9b\u7684InterProcessMutex\u662f\u5206\u5e03\u5f0f\u9501\u7684\u5b9e\u73b0\u3002acquire\u65b9\u6cd5\u7528\u6237\u83b7\u53d6\u9501\uff0crelease\u65b9\u6cd5\u7528\u4e8e\u91ca\u653e\u9501\u3002</p> <p>Zookeeper\u5b9e\u73b0\u7684\u5206\u5e03\u5f0f\u9501\u5176\u5b9e\u5b58\u5728\u4e00\u4e2a\u7f3a\u70b9\uff0c\u90a3\u5c31\u662f\u6027\u80fd\u4e0a\u53ef\u80fd\u5e76\u6ca1\u6709\u7f13\u5b58\u670d\u52a1\u90a3\u4e48\u9ad8\u3002\u56e0\u4e3a\u6bcf\u6b21\u5728\u521b\u5efa\u9501\u548c\u91ca\u653e\u9501\u7684\u8fc7\u7a0b\u4e2d\uff0c\u90fd\u8981\u52a8\u6001\u521b\u5efa\u3001\u9500\u6bc1\u77ac\u65f6\u8282\u70b9\u6765\u5b9e\u73b0\u9501\u529f\u80fd\u3002ZK\u4e2d\u521b\u5efa\u548c\u5220\u9664\u8282\u70b9\u53ea\u80fd\u901a\u8fc7Leader\u670d\u52a1\u5668\u6765\u6267\u884c\uff0c\u7136\u540e\u5c06\u6570\u636e\u540c\u4e0d\u5230\u6240\u6709\u7684Follower\u673a\u5668\u4e0a\u3002</p> <p>\u5176\u5b9e\uff0c\u4f7f\u7528Zookeeper\u4e5f\u6709\u53ef\u80fd\u5e26\u6765\u5e76\u53d1\u95ee\u9898\uff0c\u53ea\u662f\u5e76\u4e0d\u5e38\u89c1\u800c\u5df2\u3002\u8003\u8651\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u7531\u4e8e\u7f51\u7edc\u6296\u52a8\uff0c\u5ba2\u6237\u7aef\u53efZK\u96c6\u7fa4\u7684session\u8fde\u63a5\u65ad\u4e86\uff0c\u90a3\u4e48zk\u4ee5\u4e3a\u5ba2\u6237\u7aef\u6302\u4e86\uff0c\u5c31\u4f1a\u5220\u9664\u4e34\u65f6\u8282\u70b9\uff0c\u8fd9\u65f6\u5019\u5176\u4ed6\u5ba2\u6237\u7aef\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u5206\u5e03\u5f0f\u9501\u4e86\u3002\u5c31\u53ef\u80fd\u4ea7\u751f\u5e76\u53d1\u95ee\u9898\u3002\u8fd9\u4e2a\u95ee\u9898\u4e0d\u5e38\u89c1\u662f\u56e0\u4e3azk\u6709\u91cd\u8bd5\u673a\u5236\uff0c\u4e00\u65e6zk\u96c6\u7fa4\u68c0\u6d4b\u4e0d\u5230\u5ba2\u6237\u7aef\u7684\u5fc3\u8df3\uff0c\u5c31\u4f1a\u91cd\u8bd5\uff0cCurator\u5ba2\u6237\u7aef\u652f\u6301\u591a\u79cd\u91cd\u8bd5\u7b56\u7565\u3002\u591a\u6b21\u91cd\u8bd5\u4e4b\u540e\u8fd8\u4e0d\u884c\u7684\u8bdd\u624d\u4f1a\u5220\u9664\u4e34\u65f6\u8282\u70b9\u3002\uff08\u6240\u4ee5\uff0c\u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684\u91cd\u8bd5\u7b56\u7565\u4e5f\u6bd4\u8f83\u91cd\u8981\uff0c\u8981\u5728\u9501\u7684\u7c92\u5ea6\u548c\u5e76\u53d1\u4e4b\u95f4\u627e\u4e00\u4e2a\u5e73\u8861)</p> <p>\u4f7f\u7528Zookeeper\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u7684\u4f18\u70b9</p> <p>\u6709\u6548\u7684\u89e3\u51b3\u5355\u70b9\u95ee\u9898\uff0c\u4e0d\u53ef\u91cd\u5165\u95ee\u9898\uff0c\u975e\u963b\u585e\u95ee\u9898\u4ee5\u53ca\u9501\u65e0\u6cd5\u91ca\u653e\u7684\u95ee\u9898\u3002\u5b9e\u73b0\u8d77\u6765\u8f83\u4e3a\u7b80\u5355\u3002</p> <p>\u4f7f\u7528Zookeeper\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u7684\u7f3a\u70b9</p> <p>\u6027\u80fd\u4e0a\u4e0d\u5982\u4f7f\u7528\u7f13\u5b58\u5b9e\u73b0\u5206\u5e03\u5f0f\u9501\u3002 \u9700\u8981\u5bf9ZK\u7684\u539f\u7406\u6709\u6240\u4e86\u89e3\u3002\u5e76\u4e14\u9700\u8981\u5f15\u5165zookeeper\u3002</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#_3","title":"\u4e09\u79cd\u65b9\u6848\u7684\u6bd4\u8f83","text":"<p>\u4e0a\u9762\u51e0\u79cd\u65b9\u5f0f\uff0c\u54ea\u79cd\u65b9\u5f0f\u90fd\u65e0\u6cd5\u505a\u5230\u5b8c\u7f8e\u3002\u5c31\u50cfCAP\u4e00\u6837\uff0c\u5728\u590d\u6742\u6027\u3001\u53ef\u9760\u6027\u3001\u6027\u80fd\u7b49\u65b9\u9762\u65e0\u6cd5\u540c\u65f6\u6ee1\u8db3\uff0c\u6240\u4ee5\uff0c\u6839\u636e\u4e0d\u540c\u7684\u5e94\u7528\u573a\u666f\u9009\u62e9\u6700\u9002\u5408\u81ea\u5df1\u7684\u624d\u662f\u738b\u9053\u3002</p> <p>\u4ece\u5b9e\u73b0\u7684\u96be\u6613\u7a0b\u5ea6\u89d2\u5ea6\uff08\u4ece\u4f4e\u5230\u9ad8\uff09</p> <p>\u6570\u636e\u5e93 &gt; \u7f13\u5b58 &gt; Zookeeper</p> <p>\u4ece\u6027\u80fd\u89d2\u5ea6\uff08\u4ece\u9ad8\u5230\u4f4e\uff09</p> <p>\u7f13\u5b58 &gt; Zookeeper &gt;= \u6570\u636e\u5e93</p> <p>\u4ece\u53ef\u9760\u6027\u89d2\u5ea6\uff08\u4ece\u9ad8\u5230\u4f4e\uff09</p> <p>Zookeeper &gt; \u7f13\u5b58 &gt; \u6570\u636e\u5e93</p>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#id","title":"\u5206\u5e03\u5f0fID","text":""},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#segment","title":"Segment","text":"<p>\u7279\u70b9</p> <ul> <li>\u9ad8\u6027\u80fd\u3001\u4f4e\u5ef6\u8fdf</li> <li>\u5f31\u4f9d\u8d56DB,\u83b7\u53d6\u4e0b\u4e00\u4e2a\u53f7\u6bb5\u65f6\u624d\u4f1a\u4f7f\u7528,\u5373\u4f7fDB\u6216\u8005Server\u5168\u6302,Client\u7aef\u7f13\u5b58\u7684Segment\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e00\u6bb5\u65f6\u95f4</li> <li>\u5355db\u6a21\u5f0f\u4fdd\u8bc1\u4e0b\u4e00\u4e2aid\u4e00\u5b9a\u6bd4\u4e0a\u4e00\u4e2aid\u5927,\u5373\u5355\u8c03\u9012\u589e;\u591aDB\u6a21\u5f0fID\u5448\u5168\u5c40\u9012\u589e,\u4f46\u59cb\u7ec8\u552f\u4e00,\u5373\u5168\u5c40\u9012\u589e</li> </ul> <p>\u7f3a\u70b9</p> <ul> <li>\u670d\u52a1\u91cd\u542f\u4f1a\u4e22\u5931\u53f7\u6bb5,\u9020\u6210ID\u4e0d\u8fde\u7eed,\u4f46\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00</li> <li>ID\u53ef\u9884\u6d4b,\u5b58\u5728\u6cc4\u6f0f\u53d1\u53f7\u6570\u91cf\u7684\u98ce\u9669</li> <li>\u4e0d\u5efa\u8bae\u76f4\u63a5\u5916\u663e</li> </ul> <p>\u573a\u666f</p> <ul> <li>\u6570\u636e\u552f\u4e00\u6027\u5173\u8054ID,\u4e0d\u5efa\u8bae\u76f4\u63a5\u7528\u505a\u4e3b\u952e</li> </ul>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#snowflow","title":"Snowflow","text":"<p>\u7279\u70b9</p> <ul> <li>\u9ad8\u6027\u80fd\u3001\u4f4e\u5ef6\u8fdf\u3001\u53bb\u4e2d\u5fc3\u5316\u3001\u6309\u65f6\u95f4\u6709\u5e8f</li> <li>\u751f\u6210ID\u56fa\u5b9a64\u4f4d</li> <li>\u4e0e\u6307\u5b9a\u65e5\u671f\u7684\u65f6\u95f4\u5dee\uff08\u6beb\u79d2\u7ea7\uff09\uff0c41\u4f4d\uff0c\u591f\u752869\u5e74</li> <li>\u96c6\u7fa4ID \u673a\u5668ID\uff0c 10\u4f4d\uff0c\u6700\u591a\u652f\u63011024\u53f0\u673a\u5668</li> <li>\u5e8f\u5217\uff0c12\u4f4d\uff0c\u6bcf\u53f0\u673a\u5668\u6bcf\u6beb\u79d2\u5185\u6700\u591a\u4ea7\u751f4096\u4e2a\u5e8f\u5217\u53f7</li> </ul> <p>\u7f3a\u70b9</p> <ul> <li>\u5f3a\u4f9d\u8d56\u65f6\u949f,\u8981\u6c42\u673a\u5668\u65f6\u949f\u540c\u6b65</li> </ul> <p>\u573a\u666f</p> <ul> <li>\u5206\u5e03\u5f0f\u5e94\u7528\u73af\u5883\u7684\u6570\u636e\u4e3b\u952e</li> </ul>"},{"location":"micro-services/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/#_4","title":"\u5e42\u7b49\u95ee\u9898\u600e\u4e48\u89e3\u51b3\uff1f","text":"<ul> <li>select \u548cdelete\u57fa\u672c\u6709\u5929\u7136\u7684\u5e42\u7b49\u6027</li> <li>\u901a\u8fc7\u6570\u636e\u5e93\u7684\u552f\u4e00\u7d22\u5f15\u3002\u5982\u679c\u6570\u636e\u5e93\u5df2\u7ecf\u6709\u4e86\uff0c\u5c31\u4e0d\u518d\u521b\u5efa\u3002</li> <li>\u901a\u8fc7token\uff0c\u6bd4\u5982\u9632\u6b62\u9875\u9762\u91cd\u590d\u63d0\u4ea4\u3002\u4e5f\u5c31\u662f\u9875\u9762\u8981\u5148\u5411\u670d\u52a1\u7aef\u7533\u8bf7\u4e00\u4e2atoken</li> <li>\u901a\u8fc7\u7528\u6237ID+\u8bbe\u5907\u53f7+\u65f6\u95f4\u6233\u751f\u6210traceId </li> </ul>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/","title":"\u76d1\u63a7\u4e2d\u5fc3","text":"<p>APM(Application Performance Management)\u5e94\u7528\u6027\u80fd\u7ba1\u7406\u5e73\u53f0</p> <p>\u5b83\u6709\u5f88\u591a\u7684\u5b9e\u73b0\uff0c\u5305\u62ecpinpoint\uff0cZipkin\uff0cSkywalking\uff0ccat\u3002</p> <p>\u8c37\u6b4c\u521a\u5f00\u59cb\u63d0\u51fa\u4e00\u4e2a\u89c4\u8303\uff0c\u5373Open Tracing\uff0c\u4e3b\u8981\u6709\u4e24\u4e2a\u6982\u5ff5\uff0ctrace\u548cspan\u3002\u4e00\u4e2atrace\u7531\u591a\u4e2aspan\u987a\u5e8f\u548c\u5d4c\u5957\u6784\u6210\uff0c\u5c31\u662f\u90a3\u4e2a\u6267\u884c\u8fc7\u7a0b\u8272\u5757\u56fe\u3002span\u662f\u4e00\u4e2a\u6267\u884c\u903b\u8f91\u5355\u5143\uff0c\u5305\u542b\u4e00\u4e9b\u5c5e\u6027\uff1a\u591a\u4e2akey-value\u7684tags\uff0clogs\uff0c\u5f00\u59cb\u65f6\u95f4\u548c\u7ed3\u675f\u65f6\u95f4\uff0c\u8fd9\u4e9b\u5c5e\u6027\u53ef\u4ee5\u5c55\u793a\u6267\u884c\u903b\u8f91\u4e2d\u7684\u4e30\u5bcc\u4fe1\u606f\u3002</p>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#1-cat","title":"1. cat","text":"<p>zm\u96c6\u6210\u4e86 cat\u548cSkywalking\uff0ccat\u7684\u4f18\u52bf\u5c31\u662f\u62a5\u8868\u5f3a\u5927\uff0c\u4e14\u5b9e\u65f6\u6027\u597d\uff0c\u6bcf\u5c0f\u65f6\u7edf\u8ba1\u4e00\u6b21\u62a5\u8868\u3002</p> <p>\u4f46\u662fcat\u9700\u8981\u5728\u4ee3\u7801\u4e2d\u57cb\u70b9\uff0c\u4fb5\u5165\u6027\u5927\uff0c\u57cb\u70b9\u652f\u6301\u8303\u56f4\uff1a\u2460\u652f\u6301URL()http)\u3001mybatis\u3001logback\u3001@Service\u6ce8\u89e3\u7c7b\u3001feign\u3001restTemplate\u57cb\u70b9\uff1b \u2461\u652f\u6301springboot1.x\u548c2.x\u7248\u672c\uff1b \u2462\u589e\u52a0@CatTracing\u3001@IgnoreCatTracing\u6ce8\u89e3\uff0c\u7528\u4e8ecat\u7684aop\u65e5\u5fd7\u3002</p> <ul> <li>Transaction \u9002\u5408\u8bb0\u5f55\u8de8\u8d8a\u7cfb\u7edf\u8fb9\u754c\u7684\u7a0b\u5e8f\u8bbf\u95ee\u884c\u4e3a,\u6bd4\u5982\u8fdc\u7a0b\u8c03\u7528\uff0c\u6570\u636e\u5e93\u8c03\u7528\uff0c\u4e5f\u9002\u5408\u6267\u884c\u65f6\u95f4\u8f83\u957f\u7684\u4e1a\u52a1\u903b\u8f91\u76d1\u63a7\uff0cTransaction\u7528\u6765\u8bb0\u5f55\u4e00\u6bb5\u4ee3\u7801\u7684\u6267\u884c\u65f6\u95f4\u548c\u6b21\u6570\u3002\u53ef\u4ee5\u770b\u5230\u6309\u7c7b\u578b\u67e5\u770b\u8c03\u7528\u6b21\u6570\uff0c\u8c03\u7528\u65f6\u957f\uff0c95\u7ebf\uff0c99\u7ebf\uff0cQPS\u7b49\u4fe1\u606f\uff0c\u70b9\u51fblogview\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff0c</li> </ul> <p>\u5e38\u7528Transaction\u7c7b\u578b: 1.System:\u7cfb\u7edf\uff0cJVM\u7b49\u6570\u636e\uff1b2.URL:Controller\u5c42\u8c03\u7528\uff1b3.Service:\u4f7f\u7528@Service\u6ce8\u89e3\u7684\u7c7b\u7684\u8c03\u7528 \uff1b4.SQL:\u4f7f\u7528mybatis\u6846\u67b6\u7684\u8c03\u7528 \uff1b5.Cache.Redis:redis\u8c03\u7528\uff1b6.RemoteCall:\u670d\u52a1\u95f4\u8c03\u7528\uff1b7.ServiceProvider:\u670d\u52a1\u63d0\u4f9b\u65b9\u88ab\u8c03\u7528</p> <p></p> <ul> <li>Event \u7528\u6765\u8bb0\u5f55\u4e00\u4ef6\u4e8b\u53d1\u751f\u7684\u6b21\u6570\uff0c\u6bd4\u5982\u8bb0\u5f55\u7cfb\u7edf\u5f02\u5e38\uff0c\u5b83\u548ctransaction\u76f8\u6bd4\u7f3a\u5c11\u4e86\u65f6\u95f4\u7684\u7edf\u8ba1\uff0c\u5f00\u9500\u6bd4transaction\u8981\u5c0f\u3002\u548cTransaction\u7c7b\u4f3c\uff0c\u4f46\u662f\u884c\u7ea7\u4ee3\u7801\u7684\u8c03\u7528\u60c5\u51b5</li> </ul> <p></p> <ul> <li>Heartbeat \u8868\u793a\u7a0b\u5e8f\u5185\u5b9a\u671f\u4ea7\u751f\u7684\u7edf\u8ba1\u4fe1\u606f, \u5982CPU\u5229\u7528\u7387, \u5185\u5b58\u5229\u7528\u7387, \u8fde\u63a5\u6c60\u72b6\u6001, \u7cfb\u7edf\u8d1f\u8f7d\u7b49\u3002</li> </ul> <p></p> <ul> <li>\u70b9\u51fbProblem\uff0c\u67e5\u770b\u5f02\u5e38\u62a5\u9519\u4fe1\u606f</li> </ul> <p></p>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#2-skywalking","title":"2. Skywalking","text":"<p>SkyWalking\u662f\u4e00\u4e2a\u9488\u5bf9\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u5e94\u7528\u6027\u80fd\u76d1\u63a7\uff08Application Performance Monitor\uff0cAPM\uff09\u548c\u53ef\u89c2\u6d4b\u6027\u5206\u6790\u5e73\u53f0\uff08Observability Analysis Platform\uff0cOAP\uff09\u3002\u5b83\u63d0\u4f9b\u4e86\u591a\u7ef4\u5ea6\u5e94\u7528\u6027\u80fd\u5206\u6790\u624b\u6bb5\uff0c\u4ece\u5206\u5e03\u5f0f\u62d3\u6251\u56fe\u5230\u5e94\u7528\u6027\u80fd\u6307\u6807\u3001Trace\u3001\u65e5\u5fd7\u7684\u5173\u8054\u5206\u6790\u4e0e\u544a\u8b66\u3002</p> <p>\u8fd9\u91cc\u9996\u5148\u8981\u5f3a\u8c03\u7684\u662f\uff0cSkyWalking\u9488\u5bf9\u7684\u662f\u5fae\u670d\u52a1\u548c\u5206\u5e03\u5f0f\u670d\u52a1\uff0c\u5305\u62ec\u73b0\u5728\u7684\u5bb9\u5668\u5316\u3002\u5728\u8fd9\u6837\u7684\u73af\u5883\u4e2d\uff0c\u5e94\u7528\u95f4\u4f9d\u8d56\u5173\u7cfb\u590d\u6742\u591a\u53d8\uff0c\u65e0\u8bba\u662f\u8bbe\u8ba1\u3001\u5f00\u53d1\u8fd8\u662f\u8fd0\u7ef4\u56e2\u961f\uff0c\u90fd\u4e0d\u5177\u5907\u5bf9\u7cfb\u7edf\u5b9e\u9645\u5173\u7cfb\u548c\u8fd0\u884c\u60c5\u51b5\u7684\u7406\u89e3\u80fd\u529b\u3002\u4e3b\u6d41\u5927\u578b\u4f01\u4e1a\u7684\u5185\u90e8\u7cfb\u7edf\u90fd\u6709\u51e0\u5341\u4e2a\u5b50\u7cfb\u7edf\uff0c\u5176\u4e2d\u6709\u4e0a\u767e\u4e2a\u670d\u52a1\u548c\u4e0a\u5343\u4e2a\u5b9e\u4f8b\u5728\u8fd0\u884c\uff0c\u7406\u89e3\u8fd9\u5957\u7cfb\u7edf\u7684\u4f9d\u8d56\u5173\u7cfb\u662fSkyWalking\u8981\u89e3\u51b3\u7684\u7b2c\u4e00\u5927\u95ee\u9898\u3002</p> <p>\u540c\u65f6\uff0c\u968f\u7740\u6280\u672f\u7684\u9769\u65b0\u548c\u8fdb\u6b65\uff0c\u5206\u5e03\u5f0f\u6846\u67b6\u5c42\u51fa\u4e0d\u7a77\uff0c\u4ee5Spring Cloud\u3001gRPC\u3001Dubbo\u4e3a\u4ee3\u8868\u7684\u591a\u8bed\u8a00RPC\u6846\u67b6\u662f\u5f53\u4eca\u7684\u4e3b\u6d41\uff0c\u4ee5Istio+Envoy\u4e3a\u4ee3\u8868\u7684Service Mesh\u662f\u672a\u6765\u53d1\u5c55\u7684\u65b9\u5411\u3002\u7edf\u4e00\u7684\u76d1\u63a7\u5e73\u53f0\uff0c\u5bf9\u4e8e\u7528\u6237\u7406\u89e3\u590d\u6742\u7684\u5206\u5e03\u5f0f\u67b6\u6784\u4f1a\u8d77\u5230\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528\u3002</p> <p>\u6700\u91cd\u8981\u7684\u662f\uff0cSkyWalking\u4fdd\u8bc1\u4e86\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u9ad8\u538b\u529b\u60c5\u51b5\u4e0b\u7684\u53ef\u7528\u6027\u3002\u5e38\u89c4\u767e\u4ebf\u7ea7\u522b\u7684\u5904\u7406\u80fd\u529b\u3001\u8f7b\u91cf\u7ea7\u3001\u53ef\u63d2\u62d4\u3001\u65b9\u4fbf\u5b9a\u5236\uff0c\u662fSkyWalking\u5728\u77ed\u77ed3\u5e74\u65f6\u95f4\u5185\u5f97\u5230\u5e7f\u6cdb\u5e94\u7528\u7684\u4e3b\u8981\u539f\u56e0\u3002</p>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#javaagent","title":"javaagent\u7b80\u4ecb","text":"<p>SkyWalking\u63a2\u9488\u5728\u4f7f\u7528\u4e0a\u662f\u65e0\u4ee3\u7801\u4fb5\u5165\u7684\uff0c\u800c\u8fd9\u79cd\u65e0\u4fb5\u5165\u7684\u81ea\u52a8\u57cb\u70b9\u57fa\u4e8eJava\u7684JavaAgent\u6280\u672f\u3002 \u542f\u52a8\u65f6\u52a0\u8f7d\u7684JavaAgent\uff08\u4ee5\u4e0b\u6240\u8bf4\u7684JavaAgent\u5747\u4ee3\u8868\u542f\u52a8\u65f6\u52a0\u8f7d\u7684JavaAgent\uff09\u662fJDK1.5\u4e4b\u540e\u5f15\u5165\u7684\u65b0\u7279\u6027\uff0c\u6b64\u7279\u6027\u4e3a\u7528\u6237\u63d0\u4f9b\u4e86\u5728JVM\u5c06\u5b57\u8282\u7801\u6587\u4ef6\u8bfb\u5165\u5185\u5b58\u4e4b\u540e\uff0c\u4f7f\u7528\u5bf9\u5e94\u7684\u5b57\u8282\u6d41\u5728Java\u5806\u4e2d\u751f\u6210\u4e00\u4e2aClass\u5bf9\u8c61\u4e4b\u524d\uff0c\u5bf9\u5176\u5b57\u8282\u7801\u8fdb\u884c\u4fee\u6539\u7684\u80fd\u529b\uff0c\u800cJVM\u4e5f\u4f1a\u4f7f\u7528\u7528\u6237\u4fee\u6539\u8fc7\u7684\u5b57\u8282\u7801\u8fdb\u884cClass\u5bf9\u8c61\u7684\u521b\u5efa\u3002 SkyWalking\u63a2\u9488\u4f9d\u8d56\u4e8eJavaAgent\u5728\u4e00\u4e9b\u7279\u6b8a\u70b9\uff08\u67d0\u4e2a\u7c7b\u7684\u67d0\u4e9b\u65b9\u6cd5\uff09\u62e6\u622a\u5bf9\u5e94\u7684\u5b57\u8282\u7801\u6570\u636e\u5e76\u8fdb\u884cAOP\u4fee\u6539\u3002\u5f53\u67d0\u4e2a\u8c03\u7528\u94fe\u8def\u8fd0\u884c\u81f3\u5df2\u7ecf\u88abSkyWalking\u4ee3\u7406\u8fc7\u7684\u65b9\u6cd5\u65f6\uff0cSkyWalking\u4f1a\u901a\u8fc7\u4ee3\u7406\u903b\u8f91\u8fdb\u884c\u8fd9\u4e9b\u5173\u952e\u8282\u70b9\u4fe1\u606f\u7684\u6536\u96c6\u3001\u4f20\u9012\u548c\u4e0a\u62a5\uff0c\u4ece\u800c\u8fd8\u539f\u51fa\u6574\u4e2a\u5206\u5e03\u5f0f\u94fe\u8def\u3002</p> <p></p> <p>\u5f53\u67d0\u4e2a\u7c7b\u7684\u5b57\u8282\u7801\u88abJVM\u8f7d\u5165\u5185\u5b58\u4e4b\u540e\uff0cJVM\u4f1a\u89e6\u53d1\u4e00\u4e2aClassFileLoadHook\u4e8b\u4ef6\uff0cJVM\u4f1a\u4f9d\u6b21\u904d\u5386\u6240\u6709\u7684instrumentation\u5b9e\u4f8b\u5e76\u6267\u884c\u5176\u4e2d\u6240\u6709\u7684ClassFileTransformer\u7684transform\u65b9\u6cd5\u3002\u8fd9\u4e9binstrumentation\u5b9e\u4f8b\u4e2d\u7684ClassFileTransformer\u5c31\u662f\u6211\u4eec\u5728JavaAgent\u4e2d\u6dfb\u52a0\u7684\u81ea\u5b9a\u4e49\u903b\u8f91\u3002</p>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#_1","title":"\u66f4\u65b0\u65e5\u5fd7","text":"<ul> <li> <p>Agent\u65b0\u589e\u963f\u91cc\u4e91OSS\u63d2\u4ef6\u3001RocketMQ\u63d2\u4ef6</p> </li> <li> <p>Agent\u65b0\u589eXXL-JOB\u63d2\u4ef6</p> </li> <li>\u6307\u6807\u53ca\u94fe\u8def\u67e5\u8be2\u901f\u5ea6\u4f18\u5316</li> <li>\u652f\u6301Agent\u5f02\u5e38\u65e5\u5fd7\u544a\u8b66</li> <li>s\u5bf9REST\u98ce\u683c\u7684URL\u8fdb\u884c\u683c\u5f0f\u5316</li> <li>Java Agent\u4f7f\u7528Kafka\u8fdb\u884cSegment\u6570\u636e\u4e0a\u62a5</li> <li>\u7b80\u5316Agent\uff0c\u79fb\u9664\u516c\u53f8\u7528\u4e0d\u5230\u7684Agent\u63d2\u4ef6</li> <li>Agent\u65b0\u589eBeacon\u63d2\u4ef6</li> <li>OAP\u91c7\u6837\u903b\u8f91\u4f18\u5316</li> <li>UI\u652f\u6301\u670d\u52a1\u6536\u85cf</li> <li>\u65b0\u589e\u6392\u884c\u699c\u9875\u9762</li> <li>\u652f\u6301\u4e3b\u52a8\u544a\u8b66</li> <li>\u652f\u6301NodeJS\u670d\u52a1\u63a5\u5165</li> </ul>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#3-bistoury","title":"3. Bistoury","text":"<p>\u53ef\u4ee5\u5728\u7ebf\u8c03\u8bd5\uff0c\u592a\u725b\u4e86\uff01</p> <p></p> <p>https://github.com/qunarcorp/bistoury/blob/master/docs/cn/debug.md</p>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#4-async-profiler","title":"4. async-profiler","text":"<p>async-profiler \u662f\u4e00\u6b3e Java \u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u539f\u7406\u662f\u57fa\u4e8e HotSpot \u7684 API\uff0c\u4ee5\u5fae\u4e4e\u5176\u5fae\u7684\u6027\u80fd\u5f00\u9500\u6536\u96c6\u7a0b\u5e8f\u8fd0\u884c\u4e2d\u7684\u5806\u6808\u4fe1\u606f\u3001\u5185\u5b58\u5206\u914d\u7b49\u4fe1\u606f\u8fdb\u884c\u5206\u6790\u3002</p> <p>async-profile \u76ee\u524d\u652f\u6301 Linux \u548c macOS \u5e73\u53f0\uff08macOS \u4e0b\u53ea\u80fd\u5206\u6790\u7528\u6237\u7a7a\u95f4\u7684\u4ee3\u7801\uff09\u3002</p> <p>async-profiler \u5de5\u5177\u5728\u91c7\u6837\u540e\u53ef\u4ee5\u751f\u6210\u91c7\u6837\u7ed3\u679c\u7684\u65e5\u5fd7\u62a5\u544a\uff0c\u4e5f\u53ef\u4ee5\u751f\u6210 SVG \u683c\u5f0f\u7684\u706b\u7130\u56fe\u3002</p>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#_2","title":"\u5982\u4f55\u5b89\u88c5","text":"<pre><code># \u5207\u6362\u5230 root \u7528\u6237\nsudo su\n\n# \u8fdb\u5165 /usr/local \u76ee\u5f55\uff08\u2606\u2606\u2606\u8fd9\u4e00\u6b65\u5f88\u91cd\u8981\uff0c\u5efa\u8bae\u5927\u5bb6\u90fd\u5b89\u88c5\u5728\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u2606\u2606\u2606\uff09\ncd /usr/local\n\n# \u4ece OSS \u4e0b\u8f7d\u8d44\u6e90\nwget https://zm-web-data.oss-cn-hangzhou-internal.aliyuncs.com/doc/xdE7WFSyFX1qQpzjWSYXFX/async-profiler-1.8.3-linux-x64.tar.gz\n\n# \u89e3\u538b\u8d44\u6e90\u5230\u5f53\u524d\u76ee\u5f55\ntar -zxvf async-profiler-1.8.3-linux-x64.tar.gz\n\n# \u8fdb\u5165\u5de5\u4f5c\u76ee\u5f55\ncd async-profiler-1.8.3-linux-x64\n</code></pre>"},{"location":"micro-services/%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83/#_3","title":"\u4f7f\u7528\uff1a","text":"<p>jps\u67e5\u770bPID</p> <p>\u7136\u540eCPU\u6027\u80fd\u5206\u6790\uff1a</p> <pre><code># \u5bf9 CPU \u8fdb\u884c 30s \u7684\u6027\u80fd\u5206\u6790\uff0c\u5e76\u5728 tmp \u76ee\u5f55\uff08\u8c03\u6574\u76ee\u5f55\u4f4d\u7f6e\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u751f\u6210\u7ed3\u679c\u6587\u4ef6\uff09\u4e0b\u751f\u6210\u91c7\u6837\u7ed3\u679c\u7684\u65e5\u5fd7\u62a5\u544a cpu1.txt\nsh profiler.sh -e cpu -d 30 -f /tmp/cpu1.txt PID\n\n# \u5bf9 CPU \u8fdb\u884c 60s \u7684\u6027\u80fd\u5206\u6790\uff0c\u5e76\u5728 tmp \u76ee\u5f55\uff08\u8c03\u6574\u76ee\u5f55\u4f4d\u7f6e\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u751f\u6210\u7ed3\u679c\u6587\u4ef6\uff09\u4e0b\u751f\u6210\u91c7\u6837\u7ed3\u679c\u7684\u706b\u7130\u56fe cpu1.svg\uff08\u4e0b\u8f7d\u5230\u672c\u5730\u7535\u8111\uff0c\u5e76\u62d6\u62fd\u5230 Chrome \u6d4f\u89c8\u5668\u4e2d\u5373\u53ef\u6253\u5f00\uff09\nsh profiler.sh -e cpu -d 60 -f /tmp/cpu1.svg PID\n\n# \u4e0b\u8f7d\u5230\u672c\u5730\u7535\u8111\uff0c\u7528 Chrome \u6d4f\u89c8\u5668\u67e5\u770b\nsz /tmp/cpu1.svg\n</code></pre> <p>\u706b\u7130\u56fe\u91cc\uff0c\u6a2a\u6761\u8d8a\u957f\uff0c\u4ee3\u8868\u4f7f\u7528\u7684\u8d8a\u591a\uff0c\u4ece\u4e0b\u5230\u4e0a\u662f\u8c03\u7528\u5806\u6808\u4fe1\u606f\u3002</p> <p>HEAP\u5185\u5b58\u5206\u6790\uff1a</p> <pre><code># \u5bf9 Heap \u5185\u5b58\u8fdb\u884c 30s \u5206\u6790\uff0c\u5e76\u5728 tmp \u76ee\u5f55\uff08\u8c03\u6574\u76ee\u5f55\u4f4d\u7f6e\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u751f\u6210\u7ed3\u679c\u6587\u4ef6\uff09\u4e0b\u751f\u6210\u91c7\u6837\u7ed3\u679c\u7684\u65e5\u5fd7\u62a5\u544a heap1.txt\nsh profiler.sh -e alloc -d 30 -f /tmp/heap1.txt PID\n\n# \u76f4\u63a5\u5728\u670d\u52a1\u5668\u4e0a\u67e5\u770b\u7ed3\u679c\nvi heap1.txt\n\n# \u5bf9 Heap \u5185\u5b58\u8fdb\u884c 60s \u5206\u6790\uff0c\u5e76\u5728 tmp \u76ee\u5f55\uff08\u8c03\u6574\u76ee\u5f55\u4f4d\u7f6e\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u751f\u6210\u7ed3\u679c\u6587\u4ef6\uff09\u4e0b\u751f\u6210\u91c7\u6837\u7ed3\u679c\u7684\u706b\u7130\u56fe heap1.svg\uff08\u4e0b\u8f7d\u5230\u672c\u5730\u7535\u8111\uff0c\u5e76\u62d6\u62fd\u5230 Chrome \u6d4f\u89c8\u5668\u4e2d\u5373\u53ef\u6253\u5f00\uff09\nsh profiler.sh -e alloc -d 60 -f /tmp/heap1.svg PID\n\n# \u4e0b\u8f7d\u5230\u672c\u5730\u7535\u8111\uff0c\u7528 Chrome \u6d4f\u89c8\u5668\u67e5\u770b\nsz /tmp/heap1.svg\n</code></pre> <p>\u4f9d\u65e7\u662f\u6a2a\u6761\u8d8a\u957f\uff0c\u4ee3\u8868\u4f7f\u7528\u7684\u8d8a\u591a\uff0c\u4ece\u4e0b\u5230\u4e0a\u662f\u8c03\u7528\u5806\u6808\u4fe1\u606f</p>"},{"location":"note/hik/","title":"\u52a0\u5bc6","text":""},{"location":"note/hik/#dh","title":"DH\u79d8\u94a5\u4ea4\u6362\u7b97\u6cd5","text":"<p>\u4f5c\u7528\u5c31\u662f\u5c06\u5bf9\u79f0\u52a0\u5bc6\u7684\u79d8\u94a5\uff0c\u901a\u8fc7\u975e\u5bf9\u79f0\u7b97\u6cd5\u6765\u8fdb\u884c\u4ea4\u6362\u3002\uff08\u975e\u5bf9\u79f0\u52a0\u5bc6\u7b97\u6cd5\u6027\u80fd\u6bd4\u8f83\u4f4e\uff09</p> <p>1.\u8c03\u7528\u7aefA\uff0c\u4ea7\u751fP\uff0cg,publicKey\uff0cprivateKey\uff0c\u652f\u6301\u7684AES\u52a0\u5bc6\u7b97\u6cd5\u5217\u8868\uff0cP\uff0cg,publicKey\u7ed9B\uff08\u901a\u8fc7Token\u6765\u68c0\u9a8c\u8eab\u4efd\uff09\u3002</p> <p>2.\u88ab\u8c03\u7528\u7aef\u901a\u8fc7P,g\u4ea7\u751f\u81ea\u5df1\u7684publicKeyB\uff0cprivateKeyB\uff0c\u7136\u540e\u7ed3\u5408publicKeyA\uff0c\u6765\u751f\u6210\u4e00\u4e2a\u79d8\u94a5\uff08\u79d8\u94a5+\u5411\u91cf\u4e24\u90e8\u5206\uff09\u3002\u5229\u7528\u79d8\u94a5\u52a0\u5bc6\u6570\u636e\u5f62\u6210\u5bc6\u6587s(data).\u7136\u540e\u4f20\u8f93publicKeyB\uff0c\u5bc6\u6587\uff0cAES\u7b97\u6cd5\u7ed9A</p> <p>3.\u8c03\u7528\u7aefA\u901a\u8fc7publicKeyB\u7ed3\u5408\u81ea\u5df1\u7684privateKeyA\u6765\u751f\u6210\u79d8\u94a5\uff08\u79d8\u94a5+\u5411\u91cf\u4e24\u90e8\u5206\uff0c\u540cB\u4e2d\u7684\u79d8\u94a5\u4e00\u81f4\uff09\uff0c\u5229\u7528\u8fd9\u4e2a\u79d8\u94a5\u89e3\u5bc6B\u4f20\u8fc7\u6765\u7684\u5bc6\u6587\uff0c\u5c31\u53ef\u4ee5\u62ff\u5230\u6570\u636e\u4e86\u3002</p> <p>\u6ce8\uff1a\u5728\u7b2c\u4e8c\u6b65\u8fd8\u53ef\u4ee5\u4f20\u4e00\u4e2aExpireTime\u8fc7\u671f\u65f6\u95f4\uff0c\u4f1a\u8bddID\uff0c\u8fd9\u6837\u62ff\u8fd9\u4e2a\u4f1a\u8bddID\u5728\u8fc7\u671f\u65f6\u95f4\u4e4b\u524d\u90fd\u53ef\u4ee5\u8fdb\u884c\u5b89\u5168\u7684\u6570\u636e\u4f20\u9012\u3002</p> <p>A\u76f4\u63a5\u8c03\u7528B\u7684\u6570\u636e\uff0cB\u76f4\u63a5\u5728\u54cd\u5e94\u4e2d\u8fd4\u56de\u5bc6\u6587\u3002\u8fd8\u6709\u4e00\u79cd\u662fA\u8981\u8bbe\u7f6e\u654f\u611f\u6570\u636e\uff0c\u5c31\u9700\u8981\u5148\u548cB\u5efa\u7acb\u8fde\u63a5\u62ff\u5230\u79d8\u94a5\uff0c\u518d\u4f20\u9012\u6570\u636e\u3002\u8fd9\u4e24\u79cd\u60c5\u51b5\u6709\u6240\u533a\u522b\uff0c\u8981\u6ce8\u610f\u3002B\u8981\u4e3b\u52a8\u63a8\u9001\u6570\u636e\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u63d0\u524d\u5efa\u7acb\u4f1a\u8bddID\uff0c\u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\uff0c\u5728\u8fd9\u671f\u95f4\u53ef\u4ee5\u8fdb\u884c\u4e3b\u52a8\u63a8\u9001\u6570\u636e\u3002</p>"},{"location":"note/hik/#digital-digest","title":"\u6570\u5b57\u6458\u8981\uff08Digital Digest\uff09","text":"<p>\u6570\u5b57\u6458\u8981Message Digest\u7528\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u548c\u5b8c\u6574\u6027</p> <p>MD5\u4e00\u822c\u7528\u6765\u505a\u6570\u5b57\u6458\u8981\u3002\u628a\u539f\u6587\u548c\u539f\u6587\u7684MD5\u4e32\u4e00\u8d77\u53d1\u9001\u7ed9\u63a5\u6536\u65b9\uff0c\u63a5\u6536\u65b9\u5bf9\u539f\u6587\u8fdb\u884cMD5\uff0c\u7136\u540e\u548c\u63a5\u6536\u5230\u7684MD5\u4e32\u8fdb\u884c\u6bd4\u8f83\uff0c\u786e\u8ba4\u539f\u6587\u662f\u5426\u88ab\u7be1\u6539\uff08MD5\u7684\u7279\u6027\uff0c\u53ea\u8981\u539f\u6587\u6709\u4e00\u70b9\u70b9\u6539\u53d8\uff0cMD5\u7ed3\u679c\u5c31\u4f1a\u5927\u4e0d\u76f8\u540c\uff09\u3002\u6bd4\u8f83\u6d41\u884c\u7684\u8fd8\u6709sha-1\uff0cHAVAL</p>"},{"location":"note/hik/#digital-signature","title":"\u7b7e\u540d\uff08Digital Signature\uff09","text":"<p>\u7b7e\u540d\u7528\u6765\u7528\u6765\u786e\u8ba4\u53d1\u9001\u65b9\u7684\u8eab\u4efd\uff0c\u786e\u5b9e\u662f\u67d0\u4eba\u53d1\u51fa\u7684\uff0c\u4e0d\u53ef\u62b5\u8d56\u3002</p> <p>RSA\u53ef\u4ee5\u7528\u6765\u505a\u6570\u5b57\u7b7e\u540d\u3002\u53d1\u9001\u65b9\u5c06\u539f\u6587\u7684\u6458\u8981\u518d\u7528\u79c1\u94a5\u52a0\u5bc6\uff0c\u5f62\u6210\u7b7e\u540d\uff0c\u63a5\u6536\u65b9\u63a5\u53d7\u4fe1\u606f\u540e\u5c06\u7b7e\u540d\u5229\u7528\u53d1\u9001\u65b9\u7684\u516c\u94a5\u89e3\u5bc6\uff0c\u8bc1\u5b9e\u8fd9\u4e2a\u6d88\u606f\u786e\u5b9e\u662f\u53d1\u9001\u65b9\u53d1\u51fa\u6765\u7684\uff0c\u5e76\u5c06\u89e3\u5bc6\u7684\u6458\u8981\u8fdb\u884c\u6bd4\u8f83\uff0c\u8bc1\u660e\u4fe1\u606f\u6ca1\u6709\u88ab\u7be1\u6539\u3002</p> <p>\u4f46\u662f\u4e00\u822c\u5fae\u4fe1\uff0c\u652f\u4ed8\u5b9d\u63a5\u53e3\u90fd\u662f\u7528MD5\u52a0\u4e0a\u79d8\u94a5\u8fdb\u884c\u6570\u5b57\u7b7e\u540d\u3002</p>"},{"location":"note/hik/#_2","title":"\u5bf9\u79f0\u52a0\u5bc6\u548c\u975e\u5bf9\u79f0\u52a0\u5bc6","text":"<p>\u52a0\u5bc6\u7528\u6765\u52a0\u5bc6\u539f\u6587\uff0c\u89e3\u5bc6\u5bc6\u6587\u5f97\u5230\u539f\u6587\uff0c\u5206\u4e3a\u5bf9\u79f0\u52a0\u5bc6\u548c\u975e\u5bf9\u79f0\u52a0\u5bc6</p> <p>\u5bf9\u79f0\u52a0\u5bc6\u7684\u4ee3\u8868\u7b97\u6cd5\u662fAES\u7b97\u6cd5\u3002\u4f7f\u7528\u4e00\u4e2a\u79d8\u94a5key\uff0c\u4f46\u662f\u8fd9\u4e2akey\u7684\u4f20\u8f93\u5f88\u96be\u786e\u4fdd\u5b89\u5168\uff0c\u8fd9\u662f\u4ed6\u7684\u552f\u4e00\u7f3a\u70b9\u3002</p> <p>\u975e\u5bf9\u79f0\u52a0\u5bc6\u7684\u7b97\u6cd5\u662fRSA\u7b97\u6cd5\uff0cRSA\u7b97\u6cd5\u53ef\u4ee5\u7528\u6765\u52a0\u5bc6\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u505a\u7b7e\u540d\uff08\u6d41\u7a0b\u6709\u70b9\u76f8\u53cd\uff09\u3002\u4f46\u662fRSA\u52a0\u5bc6\u7b97\u6cd5\u975e\u5e38\u6162\uff0c\u6027\u80fd\u6bd4\u5bf9\u79f0\u52a0\u5bc6\u6162\u4e09\u4e2a\u6570\u91cf\u7ea7\uff0c\u6240\u4ee5\u9002\u7528\u5c0f\u6570\u636e\u91cf\u7684\u4f20\u8f93\uff0c\u5982\u53ef\u4ee5\u7528\u6765\u4f20\u9012\u5bf9\u79f0\u52a0\u5bc6\u7b97\u6cd5\u7684\u79d8\u94a5\u3002DH\u79d8\u94a5\u4ea4\u6362\u7b97\u6cd5\u4e5f\u53ef\u4ee5\u7528\u6765\u4ea4\u6362\u5bf9\u79f0\u52a0\u5bc6\u7b97\u6cd5\u7684\u79d8\u94a5\u3002</p>"},{"location":"note/hik/#base64","title":"Base64\u7f16\u7801","text":"<p>\u662f\u7528\u6765\u5728\u4e00\u4e9b\u53ea\u9002\u5408\u6587\u672c\u4f20\u8f93\u534f\u8bae\u7684\u60c5\u51b5\u4f20\u8f93\u4e8c\u8fdb\u5236\u6d41\u7b49\u4e0d\u53ef\u89c1\u5b57\u7b26\uff0c\u5373\u5c06\u4e0d\u53ef\u89c1\u5b57\u7b26\u8fdb\u884cBase64\u7f16\u7801\u8f6c\u53d8\u4e3a\u53ef\u89c1\u7684\u5b57\u7b26\uff08ASCII\u768464\u4e2a\u5b57\u7b26\uff09\uff0c\u7136\u540e\u8fdb\u884c\u4f20\u8f93\u3002\u5e76\u4e0d\u662f\u52a0\u5bc6\u7b97\u6cd5\uff0c\u53ef\u4ee5\u5f88\u8f7b\u677e\u7684\u8fdb\u884c\u7f16\u7801\uff0c\u89e3\u7801\u3002</p> <p>encrypt\u52a0\u5bc6 decrypt\u89e3\u5bc6</p>"},{"location":"note/hik/#web","title":"Web\u524d\u540e\u7aef\u654f\u611f\u6570\u636e\u4f20\u8f93","text":"<p>\u5e73\u53f0\u5728\u542f\u52a8\u65f6\uff0c\u81ea\u52a8\u968f\u673a\u751f\u6210\u4e00\u5bf9RSA\u516c\u79c1\u94a5\uff0c\u5c06\u79c1\u94a5\u7f13\u5b58\u4e8e\u670d\u52a1\u7aef\uff0c\u5c06\u516c\u94a5\u4ee5\u63a5\u53e3\u5f62\u5f0f\u516c\u5f00\u3002 \u524d\u7aef\u9996\u5148\u8bf7\u6c42\u670d\u52a1\u7aef\u516c\u94a5\u83b7\u53d6\u63a5\u53e3\u5e76\u7f13\u5b58\uff0c\u5728\u4e4b\u540e\u6d89\u53ca\u654f\u611f\u6570\u636e\u63d0\u4ea4\u524d\uff0c\u4f7f\u7528\u516c\u94a5\u52a0\u5bc6\u6570\u636e\uff0c\u5e76\u8fdb\u884cBase64\u7f16\u7801\u540e\u63d0\u4ea4\uff1b\u540e\u7aef\u83b7\u53d6\u52a0\u5bc6\u540e\u6570\u636e\uff0c\u4f7f\u7528Base64\u89e3\u7801\uff0c\u518d\u5229\u7528\u79c1\u94a5\u89e3\u5bc6\u83b7\u53d6\u660e\u6587\u6570\u636e</p>"},{"location":"note/hik/#_3","title":"\u516c\u53f8\u767b\u5f55\u52a0\u5bc6\u6d41\u7a0b","text":"<p>Md5\u52a0\u5bc6 SHA\u52a0\u5bc6 \u6311\u6218\u7801 \u76d0\u503c Cas\u8ba4\u8bc1</p> <p>\u7528\u6237\u767b\u5f55\u8f93\u5165\u7528\u6237\u540d\u5bc6\u7801\uff0c\u8c03\u7528getSalt\uff08\u643a\u5e26\u7528\u6237\u540d\uff09\uff0c\u8fd4\u56de\u76d0\u503c\uff0c\u6311\u6218\u7801\uff0c\u52a0\u5bc6\u7b97\u6cd5\uff0c\u7136\u540e\u524d\u7aef\u52a0\u5bc6SHA256\uff08SHA256(password+salt\uff09+challengeCode)\uff0c\u751f\u6210\u5bc6\u6587\u53bb\u540e\u53f0\u9a8c\u8bc1\u3002\u540e\u53f0\u4ece\u6570\u636e\u5e93\u53d6\u51fa\u5bc6\u7801\u548c\u76d0\u503c\uff0c\u7ed3\u5408\u6311\u6218\u7801\u751f\u6210\u5bc6\u6587\uff0c\u4e0e\u524d\u53f0\u751f\u6210\u7684\u6bd4\u5bf9\uff0c\u76f8\u540c\u5219\u53bbcas\u5355\u70b9\u767b\u5f55\u83b7\u53d6TGT</p> <p>\u767b\u5f55\u65f6\u8f93\u9519\u5bc6\u7801\u4e24\u6b21\u540e\u8981\u8fdb\u884c\u9a8c\u8bc1\u7801\u6821\u9a8c\uff0c\u4e94\u6b21\u540e\u8981\u9501\u5b9aip\u3002\u6ce8\u610f\u5468\u5251\u63d0\u51fa\u8981\u5148\u5bf9\u9a8c\u8bc1\u7801\u8fdb\u884c\u6821\u9a8c\uff08\u8fd9\u4e0d\u5c5e\u4e8e\u4e1a\u52a1\u6821\u9a8c\uff09\uff0c\u7136\u540e\u518d\u5bf9ip\u6821\u9a8c\uff08\u662f\u5426\u9501\u5b9a\uff0c\u662f\u5426\u5728\u9650\u5236\u533a\u95f4\uff09\uff0c\u8fd9\u53ef\u4ee5\u9632\u6b62\u66b4\u529b\u653b\u51fb\uff0c\u8282\u7701\u6d41\u91cf\uff08\u4e0d\u80fd\u9ad8\u9891\u8f93\u5165\u9a8c\u8bc1\u7801\uff09\u3002\u6210\u529f\u540e\u8bb0\u5f97\u6e05\u9664\u767b\u5f55\u5931\u8d25\u4fe1\u606f\u3002</p> <p>\u516c\u53f8\u7684\u670d\u52a1\u95f4\u8ba4\u8bc1\u7684token\u751f\u6210\u548c\u914d\u7f6e\u6587\u4ef6\u91cc\u7684\u5bc6\u7801\u91c7\u7528AES\u52a0\u5bc6\u7136\u540ebase64\u7f16\u7801\uff0c\u8c03\u7528\u7684\u5e95\u5c42native\u7684\u65b9\u6cd5\u3002\u5171\u4eab\u79d8\u94a5\u5e94\u8be5\u662f\u6839\u636e\u6388\u6743\u6587\u4ef6\u7684\u4e1c\u897f\u751f\u6210\u4f20\u8f93\u3002\u654f\u611f\u6570\u636e\u4f20\u8f93\uff0c\u5305\u62ec\u83b7\u53d6\u548c\u53d1\u9001\u3002\u91c7\u7528\u7684DH\u79d8\u94a5\u4ea4\u6362\u6280\u672f\u5148\u4ea4\u6362\u79d8\u94a5\u3002</p>"},{"location":"note/hik/#_4","title":"\u5185\u90e8\u670d\u52a1\u95f4\u8c03\u7528","text":"<p>\u4ece\u7269\u7406\u7f51\u7edc\u4e0a\u5bf9\u5916\u7f51\u662f\u9694\u79bb\u7684\uff0c\u5185\u90e8\u7684\u8ba4\u8bc1\u673a\u5236\u76f8\u5bf9\u505a\u5230\u8f7b\u91cf\uff0c\u5177\u4f53\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ol> <li>\u4e3a\u6bcf\u4e00\u4e2a\u5185\u90e8\u670d\u52a1\u5206\u914d\u552f\u4e00\u670d\u52a1\u6807\u8bc6\uff1b</li> <li>\u6240\u6709\u5185\u90e8\u670d\u52a1\u90fd\u5171\u4eab\u4e00\u4e2a\u79d8\u94a5\uff1b</li> <li>\u670d\u52a1\u8c03\u7528\u65b9\u53d1\u8d77\u8bf7\u6c42\u65f6\uff0c\u4f7f\u7528\u201c\u88ab\u8c03\u7528\u65b9\u5e94\u7528\u6807\u8bc6\u201d + \u201c\u5171\u4eab\u79d8\u94a5\u201d + \u5f53\u524d\u65f6\u95f4\uff08\u7cbe\u786e\u5230\u5c0f\u65f6\uff09\uff0c\u5f97\u5230\u4e00\u4e2a\u62fc\u63a5\u5b57\u7b26\u4e32\uff0c\u518d\u5bf9\u8be5\u5b57\u7b26\u4e32\u8fdb\u884cMD5\u751f\u6210\u6458\u8981\uff0c\u5e26\u5165\u5230\u8bf7\u6c42\u5934\u4e2d\uff0c\u8bb0\u4e3aToken\u3002</li> <li>\u670d\u52a1\u63d0\u4f9b\u65b9\u6821\u9a8c\u8bf7\u6c42\u5934\u4e2d\u7684Token\uff0c\u4f7f\u7528\u51e0\u4e2a\u56e0\u5b50\u7ecf\u8fc7\u76f8\u540c\u7b97\u6cd5\u751f\u6210\u6458\u8981\uff0c\u5bf9Token\u8fdb\u884c\u6bd4\u5bf9\uff0c\u76f8\u540c\u5219\u8ba4\u8bc1\u901a\u8fc7\uff1b</li> </ol>"},{"location":"note/hik/#_5","title":"\u8981\u70b9","text":""},{"location":"note/hik/#maven","title":"maven\u6253\u5305","text":"<p>idea\u7684maven\u63d2\u4ef6\u53ef\u4ee5\u6253\u5305</p> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u884cmaven\u547d\u4ee4\u6765\u6253\u5305\uff0c\u5177\u4f53\u53ef\u4ee5\u767e\u5ea6\u3002</p> <p>svn\u4e0a\u6709install.bat\u5f88\u597d\u7528\uff0c\u53ef\u4ee5\u76f4\u63a5\u70b9\u51fb\u8fd0\u884c\u6253\u5305\uff0c\u975e\u5e38\u597d\u7528\u3002\u5185\u5bb9\u4e3a</p> <pre><code>call mvn -Dmaven.test.skip=true clean package\n</code></pre> <p>\u4f1a\u81ea\u52a8\u9000\u51fa\uff0c\u5728exit\u9000\u51fa\u65f6\uff0c\u6574\u4e2a\u811a\u672c\u8fdb\u7a0b\u4f1a\u7ed3\u675f\u3002</p>"},{"location":"note/hik/#tomcatwar","title":"tomcat\u4e0b\u653e\u4e24\u4e2awar\u5305","text":"<p>1.tomcat\u4e0b\u6709\u4e24\u4e2awar\u5305\u65f6\uff0cwar\u5305\u7684\u540d\u5b57\u5c31\u662f\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0c\u5f88\u65b9\u4fbf\u3002</p> <p>2.\u597d\u50cf\u4e5f\u53ef\u4ee5\u53bbserfver.xml\u914d\u7f6e\uff0c</p>"},{"location":"note/hik/#_6","title":"\u51fa\u73b0\u95ee\u9898\u7684\u7ec4\u4ef6\uff1a","text":"<p>\u7531\u4e8e\u4e0a\u8ff0\u539f\u56e0\u662f\u5bfc\u81f4tomca\u963b\u585e\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u7279\u63d0\u4f9b\u6392\u67e5\u65b9\u6cd5\u548c\u6392\u67e5\u539f\u7406\u4ee5\u5907\u4e0d\u65f6\u4e4b\u9700\uff1a</p> <p>1\u3001\u4f7f\u7528jstack [pid] &gt; stack.txt \u8f93\u51fa\u6808\u4fe1\u606f 2\u3001\u68c0\u67e5\u662f\u5426\u5b58\u5728\u6b7b\u9501 3\u3001\u68c0\u67e5startStop\u7ebf\u7a0b\u662f\u5426\u662f\u7761\u7720\u72b6\u6001\u6216\u8005\u963b\u585e\u72b6\u6001 4\u3001\u68c0\u67e5startStop\u7ebf\u7a0b\u5728\u54ea\u4e2a\u65b9\u6cd5\u5185\u963b\u585e\u6216\u8005\u7761\u7720\u4e86 5\u3001\u5206\u6790\u4ee3\u7801\u5bfb\u627e\u539f\u56e0</p> <p>\u6392\u67e5\u539f\u7406\u80cc\u666f\u4ecb\u7ecd\uff1a</p> <p>tomcat\u90e8\u5206\u77e5\u8bc6\uff1a</p> <p>tomcat\u542f\u52a8\u65f6\u4f7f\u7528callable\u591a\u7ebf\u7a0b\u53bb\u521d\u59cb\u5316\u6bcf\u4e2aservlet\uff0c\u591a\u7ebf\u7a0b\u7684\u540d\u79f0\u662f\u4e2d\u5305\u542bstartStop\u5b57\u7b26\u4e32\uff0c</p> <p>servlet\u521d\u59cb\u5316\u6210\u529f\u540e\u4f1a\u6253\u5370\u7c7b\u4f3c\u4e8e\u4e00\u4e0b\u65e5\u5fd7</p> <p>13-Jan-2020 19:46:32.249 \u4fe1\u606f [localhost-startStop-26] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/opt/hik/web/components/tomcat85linux64.1/webapps/fpfas] has finished in [56,183] ms</p> <p>tomcat\u542f\u52a8\u6210\u529f\u540e\u4f1a\u6253\u5370</p> <p>16-Jan-2020 20:12:10.893 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 175421 ms</p> <p>\u5f53startStop\u7ebf\u7a0b\u963b\u585e\uff0c\u7b2c\u4e8c\u6761\u65e5\u5fd7\u4e0d\u4f1a\u6253\u5370\u3002\u56e0\u4e3atomcat\u662f\u901a\u8fc7callable\u7ebf\u7a0b\u7684get\u65b9\u6cd5\u5224\u65adservlet\u662f\u5426\u542f\u52a8\u5b8c\u6210\uff0c \u4e00\u65e6startStop\u7ebf\u7a0b\u963b\u585e\uff0c\u4f1a\u5bfc\u81f4tomcat\u4e00\u76f4\u7b49\u5f85\u542f\u52a8\u7ebf\u7a0b\u7ed3\u675f\u3002</p> <p>spring\u7684bean\u52a0\u8f7d\u77e5\u8bc6\uff1a</p> <p>@Scope\u5373bean\u7684\u4f5c\u7528\u57df\u4e0d\u540c\u4ee3\u7406\u7c7b\u7684\u4e0d\u540c\u72b6\u6001\uff0c\u4ee5\u53ca\u4ee3\u7406\u7c7b\u7684\u52a8\u6001\u52a0\u8f7d\u3002bean\u7684\u521d\u59cb\u5316\u7684\u6d41\u7a0b\u3002</p> <p>\u5904\u7406\u610f\u89c1\uff1a \u6309\u76ee\u524d\u5df2\u53d1\u73b0\u7684\u963b\u585e\u95ee\u9898,\u63d0\u4f9b\u5982\u4e0b\u5904\u7406\u610f\u89c1\u3002</p> <p>1\u3001\u5c06@PostConstruct\u6ce8\u89e3\uff0c\u6539\u4e3a\u5b9e\u73b0ApplionRunner\u63a5\u53e3\u3001\u6216\u8005\u63a5\u542c\u9879\u76ee\u542f\u52a8\u4e8b\u4ef6@EventListener(classes  </p> <p>2\u3001\u4e0d\u8981\u5728@Bean\u65b9\u6cd5\u5185\u4f7f\u7528\u8fdc\u7a0b\u8c03\u7528</p> <p>\u533a\u522b\u5728\u4e8e</p> <p>\u4fee\u6539\u524d\u5f53\u5355\u4e2abean\u52a0\u8f7d\u6210\u529f\u540e\u5c31\u6267\u884c\u88ab\u6ce8\u89e3\u7684\u4ee3\u7801\uff0c \u4fee\u6539\u540e\u6240\u6709bean\u52a0\u8f7d\u6210\u529f\u540e\u624d\u540c\u6837\u7684\u4ee3\u7801\uff0c\u7ed5\u5f00\u591a\u7ebf\u7a0b\u521d\u59cb\u5316spring\u7684bean\u3002</p> <pre><code>VM Flags:\n-XX:CICompilerCount=2 \n-XX:ConcGCThreads=2 \n-XX:G1ConcRefinementThreads=2 \n-XX:G1HeapRegionSize=1048576 \n-XX:G1ReservePercent=10 \n-XX:GCDrainStackTargetSize=64 \n-XX:+HeapDumpOnOutOfMemoryError \n-XX:HeapDumpPath=/opt/hik/web/components/tomcat85linux64.2/dump \n-XX:InitialHeapSize=1073741824 \n-XX:InitiatingHeapOccupancyPercent=70 \n-XX:MarkStackSize=4194304 \n-XX:MaxDirectMemorySize=67108864 \n-XX:MaxHeapSize=2684354560 \n-XX:MaxNewSize=1610612736 \n-XX:MinHeapDeltaBytes=1048576 \n-XX:NonNMethodCodeHeapSize=5825164 \n-XX:NonProfiledCodeHeapSize=122916538 \n-XX:ParallelGCThreads=2 \n-XX:ProfiledCodeHeapSize=122916538 \n-XX:ReservedCodeCacheSize=251658240 \n-XX:+SegmentedCodeCache \n-XX:ThreadStackSize=512 \n-XX:+UseCompressedClassPointers \n-XX:+UseCompressedOops \n-XX:+UseG1GC\n</code></pre>"},{"location":"note/hik/#rabbitmq","title":"rabbitMQ","text":"<p>\u53c2\u6570\u914d\u7f6e\uff1a</p> <pre><code>spring.rabbitmq.host=localhost\n\nspring.rabbitmq.port=5672\n\nspring.rabbitmq.http.port=15672\n\nspring.rabbitmq.username=iotadmin\n\nspring.rabbitmq.password=passw0rd\n\nspring.rabbitmq.virtual-host=iotdev\n\nrabbitmq.simple.consumer=1\n\nrabbitmq.simple.maxconsumer=3\n\nrabbitmq.simple.prefetchcount=30\n\nrabbitmq.simple.threadpool=3\n\nrabbitmq.listener.consumer=1\n\nrabbitmq.listener.maxconsumer=10\n\nrabbitmq.listener.prefetchcount=100\n\nrabbitmq.listener.threadpool=10\n</code></pre> <p>rabbitmq\u7684\u53d1\u5e03\u8005\u786e\u8ba4\u673a\u5236 confirm\u548creturnback\u76d1\u542c\u3002\u53c2\u8003\u8fd9\u91cc \u6d88\u606f\u53ef\u4ee5\u53d1\u9001\u5230Exchange\u65f6Ack\u4e3atrue\uff0c\u5426\u5219\u4e3afalse\u3002 \u5982\u679c\u6d88\u606f\u65e0\u6cd5\u53d1\u9001\u5230\u6307\u5b9a\u7684\u6d88\u606f\u961f\u5217\u90a3\u4e48ReturnCallBack\u56de\u8c03\u65b9\u6cd5\u4f1a\u88ab\u8c03\u7528\uff0csetMandatory\u5fc5\u987b\u4e3atrue\u3002\u4e0d\u8fc7\u8fd9\u79cd\u589e\u52a0\u4e86\u751f\u4ea7\u65b9\u7684\u903b\u8f91\uff0c\u4e00\u822c\u8bbe\u7f6e\u5907\u4efd\u961f\u5217</p> <p>mq\u6d88\u8d39\u7aef\u4e00\u65e6\u6302\u6389\u4e4b\u540e\uff0c\u961f\u5217\u4e2d\u4f1a\u5927\u91cf\u5806\u79ef\u6d88\u606f\u4e3a\u88ab\u6d88\u8d39\uff0c\u6d88\u8d39\u7aef\u91cd\u542f\u540e\u8fd8\u4f1a\u53bb\u6d88\u8d39\uff0c\u4f46\u5df2\u7ecf\u8d85\u65f6\u4e0d\u5e94\u8be5\u518d\u6d88\u8d39\u4e86\u3002</p> <p>\u6dfb\u52a0\u4e00\u4e2a\u65f6\u95f4\u6233\uff0c\u6d88\u8d39\u7aef\u8fdb\u884c\u5224\u65ad\uff0c\u5982\u679c\u8d85\u65f6\u5c31\u4e0d\u518d\u6d88\u8d39\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u7c7b\u95ee\u9898\u3002</p> <p>rabbitmq\u4f7f\u7528\u7ebf\u7a0b\u5171\u4eab\u6280\u672f\uff0c\u591a\u4e2achannel\u5171\u4eab\u4e00\u4e9b\u7ebf\u7a0b\u3002\u8be6\u7ec6\u67e5\u770b\u591a\u4e2achannel\u5171\u4eab\u7ebf\u7a0b\u6c60 \u548c \u5982\u4f55\u914d\u7f6e\u591a\u4e2a\u6d88\u8d39\u8005\u7ebf\u7a0b</p>"},{"location":"note/hik/#_7","title":"\u6052\u5927\u9879\u76ee\u4e2d\u4f60\u8ba4\u4e3a\u6709\u4f55\u4e0d\u8db3\uff1f\u4e5f\u5c31\u662f\u4f60\u8ba4\u4e3a\u5fae\u670d\u52a1\u67b6\u6784\u6709\u4f55\u7f3a\u70b9\uff1f","text":"<p>1.\u5bf9\u8fd0\u7ef4\u548c\u6d4b\u8bd5\u6765\u8bf4\u66f4\u52a0\u590d\u6742\uff0c\u8981\u6c42\u8fd0\u7ef4\u8f83\u9ad8\u7684\u6280\u672f\u6c34\u5e73\uff0c\u56e0\u4e3a\u90e8\u7f72\u66f4\u52a0\u590d\u6742\u8981\u7406\u6e05\u7ec4\u4ef6\u95f4\u7684\u4f9d\u8d56\uff0c\u4e00\u4e2a\u529f\u80fd\u7684\u5b9e\u73b0\u6d89\u53ca\u5230\u591a\u4e2a\u7ec4\u4ef6\u65f6\uff0c\u90e8\u7f72\u65f6\u90fd\u8981\u90e8\u7f72\uff0c\u5f88\u5bb9\u6613\u6f0f\u6389\uff0c\u4ece\u4e00\u5f00\u59cb\u4e00\u5b9a\u8981\u6784\u5efa\u8d77\u81ea\u52a8\u5316\u6d4b\u8bd5\u548c\u81ea\u52a8\u5316\u90e8\u7f72\u3002\u591a\u4e2adocker\u90e8\u7f72\u3002\u5bf9\u6d4b\u8bd5\u6765\u8bf4\uff0c\u4e00\u6761\u7528\u4f8b\u6d89\u53ca\u5230\u591a\u4e2a\u7ec4\u4ef6\u7684\u4f1a\u6bd4\u8f83\u6c9f\u901a\u56f0\u96be\uff0c\u5b9a\u4f4d\u95ee\u9898\u7684\u65f6\u5019\u4e5f\u5f88\u9ebb\u70e6\u3002</p> <p>2.\u62c6\u5206\u4e86\u670d\u52a1\uff0c\u4f46\u662f\u4e1a\u52a1\u903b\u8f91\u4ece\u4ee3\u7801\u4e0a\u7684\u4f9d\u8d56\u53d8\u6210\u4e86\u7ec4\u4ef6\u95f4\u901a\u4fe1\u7684\u4f9d\u8d56\uff0c\u63a5\u53e3\u8bbe\u8ba1\u8981\u975e\u5e38\u8c28\u614e\u9075\u5faa\u4e00\u5b9a\u7684\u539f\u5219\u8fdb\u884c\u5b8c\u5584\u7684\u7ba1\u7406\uff0c\u5426\u5219\u4e00\u4e2a\u63a5\u53e3\u6539\u53d8\u5f71\u54cd\u591a\u4e2a\u7ec4\u4ef6\uff0c\u6781\u5927\u5f71\u54cd\u5f00\u53d1\u6548\u7387\u3002\u6052\u5927\u662f\u901a\u8fc7client\u5c01\u88c5httpclient\u63a5\u53e3\uff0cmq\u8c03\u7528\u3002</p> <p>3.\u62c6\u5206\u670d\u52a1\u540e\uff0c\u591a\u4e2a\u7ec4\u4ef6\u72ec\u7acb\u90e8\u7f72\u5404\u81ea\u8fdb\u7a0b\u5185\uff0c\u6784\u6210\u4e86\u5206\u5e03\u5f0f\u73af\u5883\uff0c\u6709\u4e9b\u60c5\u51b5\u4e0b\u7684\u8003\u8651\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u7f51\u7edc\u5ef6\u8fdf\uff0c\u8fd8\u6709\u5f02\u6b65\u6d88\u606f\u901a\u4fe1\u95ee\u9898\u5c31\u8981\u8003\u8651\u89e3\u51b3\u3002</p> <p>4.\u7cfb\u7edf\u7684\u7ef4\u62a4\u590d\u6742\u5ea6\u5927\u5927\u63d0\u5347\uff0c\u7cfb\u7edf\u4e2d\u51fa\u73b0\u6545\u969c\u7684\u9891\u7387\u5927\u5927\u63d0\u5347\uff0c\u867d\u7136\u6709\u9ad8\u53ef\u7528\u673a\u5236\u7684\u4fdd\u969c\uff0c\u4f46\u662f\u4e5f\u9700\u8981\u505a\u597d\u826f\u597d\u7684\u81ea\u52a8\u5316\u76d1\u63a7\uff0c\u4e0d\u65ad\u6536\u96c6\u5404\u4e2a\u7ec4\u4ef6\u670d\u52a1\u60c5\u51b5\uff0c\u53ca\u65f6\u53d1\u73b0\u5904\u7406\u95ee\u9898\u3002</p>"},{"location":"note/hik/#_8","title":"\u6052\u5927\u9879\u76ee\u5f00\u53d1\u5de5\u5177\uff1a","text":"<p>\u9879\u76ee\u7ba1\u7406\u5e73\u53f0\uff1a\u5f00\u59cb\u662fredmine\uff0c\u8fdb\u5165\u5f00\u53d1\u9636\u6bb5\u540e\u8f6c\u4e3ajira\u3002 Wiki</p> <p>\u7248\u672c\u7ba1\u7406\u670d\u52a1\u5668\uff1agitlab \u53ef\u89c6\u5316git\u7ba1\u7406\u5f00\u6e90\u9879\u76ee</p> <p>\u9879\u76ee\u8ba1\u5212\u5de5\u5177\uff1aProjects 2013 \u67b6\u6784\u5de5\u5177 visio</p> <p>\u5e73\u53f0\u8fd0\u884c\u73af\u5883\u662fubantu\uff0c\u4e00\u79cdlinux\u5f00\u6e90\u514d\u8d39\u7cfb\u7edf</p> <p>\u524d\u7aef\u6846\u67b6\u4f7f\u7528vue.js\uff08\u8fd8\u6709react\u548cangularJS\u53ef\u4ee5\u7528\uff09\u3002\u524d\u540e\u7aef\u5b8c\u5168\u5206\u79bb\uff0c\u9759\u6001\u6587\u4ef6\u653e\u5728nginx\u4e0b\u9762\u3002</p>"},{"location":"note/hik/#_9","title":"\u6570\u636e\u5e93\u5e8f\u5217","text":"<p>serial\u5185\u90e8\u5176\u5b9e\u5e2e\u52a9\u6211\u4eec\u5b9e\u73b0\u4e86:</p> <p>\u521b\u5efa\u4e86\u4e00\u4e2asequence,\u540d\u5b57\u662f\u8868\u540d\u5b57\u6bb5\u540dseq</p> <p>\u8bbe\u7f6eid\u5b57\u6bb5\u4e3aNOT NULL DEFAULT nextval('\u6b64sequence')</p> <p>\u5173\u8054\u6b64sequence\u5230\u76f8\u5173\u5b57\u6bb5.\u56e0\u4e3a\u8fd9\u4e2asequence\u5173\u8054\u5728\u8868\u7684\u5b57\u6bb5\u4e0a,\u6240\u4ee5\u5220\u9664\u8868\u5b57\u6bb5\u4f1a\u4e00\u8d77\u5220\u9664,\u9664\u975eowner\u6ca1\u6709\u6307\u5b9a</p> <p>serial\u7c7b\u578b\u67093\u4e2d,smallserial,serial,bigserial,\u5e95\u5c42\u5206\u522b\u5bf9\u5e94smallint,integer,bigint,\u5206\u522b\u53602bit,4bit,8bit.</p>"},{"location":"note/hik/#gpucpu","title":"GPU\u548cCPU\u5bf9\u6bd4","text":"<ul> <li>\u7531\u4e8eCPU\u9700\u8981\u5f88\u5f3a\u7684\u901a\u7528\u6027\u6765\u5904\u7406\u5404\u79cd\u4e0d\u540c\u7684\u6570\u636e\u7c7b\u578b\uff0c\u540c\u65f6\u6709\u9700\u8981\u903b\u8f91\u5224\u65ad\u53c8\u9700\u8981\u5f15\u5165\u5927\u91cf\u7684\u5206\u652f\u8df3\u8f6c\u548c\u4e2d\u65ad\u7684\u5904\u7406\u3002\u8fd9\u4e9b\u90fd\u4f7f\u5f97CPU\u7684\u5185\u90e8\u7ed3\u6784\u5f02\u5e38\u590d\u6742\uff0cCPU\u4e0d\u4ec5\u88abCache\u5360\u636e\u4e86\u5927\u91cf\u7a7a\u95f4\uff0c\u800c\u4e14\u8fd8\u6709\u5f88\u590d\u6742\u7684\u63a7\u5236\u903b\u8f91\u548c\u4f18\u5316\u7535\u8def\u3002\u76f8\u6bd4\u4e4b\u4e0b\u8ba1\u7b97\u80fd\u529b\u53ea\u662fCPU\u5f88\u5c0f\u7684\u4e00\u90e8\u5206\u3002 GPU\u9762\u5bf9\u7684\u5219\u662f\u7c7b\u578b\u9ad8\u5ea6\u7edf\u4e00\uff0c\u76f8\u4e92\u65e0\u4f9d\u8d56\u76843\u5927\u89c4\u6a21\u6570\u636e\u548c\u4e0d\u9700\u8981\u88ab\u6253\u65ad\u7684\u7eaf\u51c0\u7684\u73af\u5883\uff0cGPU\u57fa\u4e8e\u5927\u7684\u541e\u5410\u91cf\u8bbe\u8ba1\uff0c\u91c7\u7528\u4e86\u6570\u91cf\u4f17\u591a\u7684\u8ba1\u7b97\u5355\u5143\u548c\u8d85\u957f\u7684\u6d41\u6c34\u7ebf\uff0c\u4f46\u53ea\u6709\u7b80\u5355\u7684\u63a7\u5236\u903b\u8f91\u5e76\u7701\u53bb\u4e86Cache,\u8ba1\u7b97\u80fd\u529b\u7a81\u51fa\u3002\u7efc\u4e0a\u6240\u8ff0\uff0cCPU\u64c5\u957f\u7684\u662f\u903b\u8f91\u63a7\u5236\uff0c\u4e32\u884c\u7684\u8fd0\u7b97\uff0cGPU\u64c5\u957f\u7684\u662f\u5927\u89c4\u6a21\u7684\u5e76\u53d1\u8fd0\u7b97\u3002</li> </ul> <p>9.\u6700\u667a\u80fd\u7684\u5730\u65b9\u5c31\u4f53\u73b0\u5728\u5404\u4e2a\u6444\u50cf\u5934\u7684\u529f\u80fd\u3002\u4eba\u5458\u5f98\u5f8a \u4eba\u8138\u8bc6\u522b \u4eba\u4f53\u68c0\u6d4b \u91cd\u70b9\u4eba\u5458 \u4e1a\u4e3b \u8bbf\u5ba2 \u964c\u751f\u4eba \u3002\u4e1a\u4e3b\u53ef\u4ee5\u65b9\u4fbf\u7684\u5f00\u95e8\u547c\u68af\uff0c\u8bbf\u5ba2\u53ef\u4ee5\u5728\u83b7\u5f97\u6743\u9650\u540e\u4e00\u5b9a\u65f6\u95f4\u5185\u5f00\u95e8\u547c\u68af\uff0c\u8d70\u5230\u6307\u8def\u724c\u524d\uff0c\u6307\u8def\u724c\u4eba\u8138\u8bc6\u522b\u7ed9\u4f60\u6307\u793a\u65b9\u5411\u3002\u53ef\u4ee5\u8ddf\u8e2a\u91cd\u70b9\u4e1a\u4e3b\u4ea4\u7269\u4e1a\u8d39\uff0c\u5feb\u9012\u7b49\u3002\u53ef\u4ee5\u8bc6\u522b\u4e00\u4e9b\u4eba \u8f66\u7684\u6765\u8bbf\u6b21\u6570\u3002</p> <p>10.\u4e24\u4e2a\u7ebf\u7a0b\u6536\u5230\u8054\u52a8\u89c4\u5219\u7136\u540e\u53bb\u6293\u56fe\uff0c\u53ef\u4ee5\u5728\u53d1\u9001\u6293\u56fe\u547d\u4ee4\u65f6 \u52a0\u9501\uff0crennternlock\u7136\u540esleep(2000)</p>"},{"location":"note/hik/#_10","title":"\u4eba\u8138\u56fe\u7247\u8bc6\u522b\u65b9\u6848","text":"<p>\u5efa\u7acb\u597d\u4eba\u8138\u5e93\u540e\uff0c\u4f20\u5165\u4eba\u8138\u56fe\u7247\u8bc6\u522b\u6709\u4e09\u79cd\u65b9\u6848\u53ef\u9009</p> <ol> <li>\u767e\u5ea6\u4eba\u8138\u8bc6\u522b \u4f20\u5165\u4e00\u5f20\u56fe\u7247\u5373\u53ef\u8fd4\u56de\u7ed3\u679c</li> <li>\u963f\u91cc\u7684\u4eba\u8138\u8bc6\u522b\u53ea\u80fd\u4f20\u5165\u4e24\u5f20\u56fe\u7247\uff0c\u6bd4\u8f83\u662f\u5426\u4e3a\u540c\u4e00\u4eba</li> <li>face recongnition\u662f\u6765\u6e90\u7684\u8bc6\u522b\u7b97\u6cd5\uff0c\u8bc6\u522b\u5ea6\u8f83\u5dee\uff0c\u4e5f\u53ea\u80fd\u4f20\u5165\u4e24\u5f20\u7167\u7247\u6765\u6bd4\u8f83</li> </ol>"},{"location":"note/hik/#_11","title":"\u5176\u4ed6","text":"<ul> <li> <p>win10\u5220\u9664\u9700\u8981\u6743\u9650\u7684\u6587\u4ef6\u5939\uff1a\u53ef\u4ee5\u53c2\u8003\uff1ahttp://www.xitongzhijia.net/xtjc/20161115/87360.html\u3002</p> </li> <li> <p>\u4f7f\u7528 gradle init --type pom \u5373\u53ef\u5c06maven\u9879\u76ee\u8f6c\u6362\u4e3agradle\u9879\u76ee</p> </li> <li> <p>webflux\u54cd\u5e94\u5f0f\u53d8\u6210 \u5f02\u6b65\u7684\u975e\u963b\u585e\u7684\u54cd\u5e94\u5f0f\u6d41 https://blog.csdn.net/get_set/article/details/79480233</p> </li> <li> <p>\u96c6\u7fa4\u591a\u5b9e\u4f8b\u7684\u4efb\u52a1\u6267\u884c\u4e3a\u907f\u514d\u9519\u8bef \u53ef\u4ee5\u5728redis\u4e2d</p> </li> <li> <p>jsonutil\u7684\u8f6cjson\u7684\u65f6\u5019\uff0c\u662f\u6839\u636eget\u65b9\u6cd5\u6765\u5224\u65ad\u7684\uff0c\u6240\u4ee5\u4e0d\u80fd\u6709\u989d\u5916\u7684get\u65b9\u6cd5</p> </li> <li> <p>aop\u5b9e\u73b0\u65b9\u6cd5\u65e5\u5fd7\u8bb0\u5f55\uff0c\u53c2\u8003cas\u5b9e\u73b0</p> </li> <li> <p>\u8981\u52a0\u7d27\u5b66\u4e60tomcat nginx\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u4e86\u89e3war\u5305\u7b49\u7684\u751f\u6210\u7ed3\u6784\u3002</p> </li> <li> <p>openresty\u662f\u57fa\u4e8enginx\u7684\u5feb\u901f\u5f00\u53d1web\u7684\u6846\u67b6\uff0c\u6027\u80fd\u975e\u5e38\u597d\uff0c\u5e76\u53d1\u8f7b\u677e\u4e0a\u4e00\u4e07\uff0c\u53ef\u4ee5\u628a\u4e00\u4e9b\u4e0d\u592a\u590d\u6742\u7684\u4e1a\u52a1\u653e\u5230nginx\u5c42\u3002</p> </li> <li> <p>gogs\u6bd4gitlab\u5b89\u88c5\u7b80\u5355\uff0c\u529f\u80fd\u5dee\u4e0d\u591a\u3002\u662f\u56fd\u4eba\u5199\u7684\u5f00\u6e90\u4ea7\u54c1\uff0c\u9002\u5408\u81ea\u5df1\u6258\u7ba1\u6216\u5c0f\u9879\u76ee\u3002</p> </li> <li> <p>\u6279\u91cf\u66f4\u65b0\u7684\u5c0f\u65b9\u6cd5</p> </li> </ul> <p>\u573a\u666f:\u4f20\u5165\u901a\u9053\u5bf9\u8c61\u96c6\u5408\uff0c\u8981\u6839\u636eindexCode\u548cVersion\u53bb\u4fee\u6539status\u5b57\u6bb5\u7684\u503c\u3002</p> <p>\u65b9\u6cd5\uff1a<code>update channel set status =1 where indexCode || \"_\" || version in &lt;forEach/&gt;</code> \u5faa\u73af\u91cc\u4f20\u5165\u7684\u662f\u62fc\u597d\u7684indexCode_version\u5b57\u7b26\u4e32\u3002</p> <ul> <li> <p>\u8bb0\u4f4fproxy_pass \u5730\u5740\u7684\u6700\u540e\u4e00\u4e2a\u659c\u6760\u662f\u5173\u952e \u8bbf\u95ee/netdata/xxx/bbb\u65f6\uff0c\u5982\u679c\u4ee3\u7406\u5730\u5740\u6700\u540e3\u6709/\uff0c\u90a3\u4e48\u4f1a\u8f6c\u53d1\u5230http://localhost:19999/xxx/bbb; \u8bbf\u95ee /netdata/xxx/bbb\u65f6\uff0c\u5982\u679c\u4ee3\u7406\u5730\u5740\u6700\u540e\u6ca1\u6709/\uff0c\u90a3\u4e48\u4f1a\u8f6c\u53d1\u5230http://localhost:19999/netdat...</p> </li> <li> <p>acunetix\u7a0b\u5e8f\u5e73\u53f0\u6f0f\u6d1e\u626b\u63cf\u5de5\u5177\uff0c\u767e\u5ea6awvs\u3002\u767b\u5f55\u53ef\u4ee5\u5f55\u64ad\uff0c\u4ece\u800c\u521b\u5efa\u811a\u672c\u6765\u6a21\u62df\u767b\u5f55</p> </li> <li> <p>wireshark\u6293\u5305\u4f53\u4f1a\u4e09\u6b21\u63e1\u624b\u56db\u6b21\u6325\u624b</p> </li> <li> <p>\u7528\u6237\u9700\u6c42 \u4ea7\u54c1\u9700\u6c42 \u8bbe\u8ba1\u4ea4\u4e92\u56fe\uff0c\u603b\u4f53\u8bbe\u8ba1 \u6982\u8981\u8bbe\u8ba1\uff0cUCD\u6548\u679c\u56fe\uff0c\u8be6\u7ec6\u5f00\u53d1\u8ba1\u5212</p> </li> <li> <p>\u6d77\u5eb7\u65e5\u5fd7\u662f\u5728\u4ee3\u7801\u91cc\u786c\u7f16\u5199\u903b\u8f91\uff0c\u7136\u540e\u4f1a\u653e\u5230\u4e00\u4e2a\u957f\u5ea6\u4e3a10000\u7684BLOCKINGQUEUE\u91cc\u3002\u8fd9\u4e2a\u961f\u5217\u4f1a\u5728\u7c7b\u52a0\u8f7d\u65f6\u521d\u59cb\u5316\u597d\u3002</p> </li> <li> <p>apache common\u7684utils\u5199\u7684\u5f88\u597d\uff0c\u5982\u679c\u80fd\u770b\u4e00\u904d\u5c31\u5389\u5bb3\u4e86\u3002</p> </li> <li> <p>xml\u8bed\u8a00\uff1a extention markup language \uff0c\u53ef\u6269\u5c55\u7684\u6807\u8bb0\u8bed\u8a00\u3002\u6709\u4e24\u79cd\u89e3\u6790\u65b9\u5f0f\uff0cDOM\u89e3\u6790\u662f\u5c06\u6587\u6863\u4e00\u6b21\u6027\u7684\u52a0\u8f7d\u8fdb\u5185\u5b58\uff0c\u5f62\u6210\u6811\u578b\u7ed3\u6784\u518d\u89e3\u6790\u3002\u5982\u679c\u6587\u6863\u7279\u522b\u5927\uff0c\u5bb9\u6613\u5bfc\u81f4\u5185\u5b58\u6ea2\u51fa\uff0c\u4f46\u662f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5bf9xml\u8fdb\u884c\u7f16\u8f91\u3002SAX\u89e3\u6790\u662f\u4e8b\u4ef6\u9a71\u52a8\u7684\u65b9\u5f0f\uff0c\u4e00\u884c\u4e00\u884c\u7684\u89e3\u6790\uff0c\u4e0d\u80fd\u5bf9\u6587\u6863\u8fdb\u884c\u589e\u5220\u6539\u7684\u64cd\u4f5c\uff0c\u4f46\u662f\u5f53\u6587\u6863\u7279\u522b\u5927\u65f6\u4e0d\u4f1a\u5bfc\u81f4\u5185\u5b58\u6ea2\u51fa\u3002XML\u7ea6\u675f\u6709DTD\u548cschema\u7ea6\u675f\u3002\u73b0\u5728\u90fd\u662f\u4f7f\u7528schema\u7ea6\u675f\u4e86\u3002</p> </li> <li> <p>1.DTD\u8bed\u6cd5\u662f\u81ea\u6210\u4e00\u4f53\u7684.Schema\u8bed\u6cd5\u5c31\u662fXML\u7684\u8bed\u6cd5.</p> </li> <li> <ul> <li>2.Schema\u7684\u8bed\u6cd5\u5c31\u662fXML\u7684\u8bed\u6cd5\u6240\u4ee5\u66f4\u5bb9\u6613\u88ab\u89e3\u6790\u5668\u6240\u89e3\u6790.</li> </ul> </li> <li>3.Schema\u652f\u6301\u540d\u79f0\u7a7a\u95f4.</li> <li> <p>4.Schema\u6709\u6bd4DTD\u66f4\u52a0\u5f3a\u5927\u7684\u8bed\u4e49\u548c\u8bed\u6cd5\u7684\u7ea6\u675f.</p> </li> <li> <p>\u5e38\u89c1\u7684web\u670d\u52a1\u5668\uff1aApache webSphere\uff08IBM\u516c\u53f8\u7814\u53d1,\u6536\u8d39\u7684\u5927\u578b\u670d\u52a1\u5668\u8f6f\u4ef6\uff09 WebLogic\uff08BEA\u516c\u53f8\u7814\u53d1,\u6536\u8d39\u7684\u5927\u578b\u670d\u52a1\u5668\u8f6f\u4ef6\uff09 Tomcat \uff08Apache\u7ec4\u7ec7\u7814\u53d1,\u514d\u8d39\u7684\u5c0f\u578b\u7684\u670d\u52a1\u5668\u8f6f\u4ef6\uff09 JBoss</p> </li> <li> <p>\u6211\u4eb2\u81ea\u6bd4\u8f83\u4e86\u4e0b\u4e24\u79cd\u4ee3\u7406\u65b9\u5f0f\u7684\u6027\u80fd\u5dee\u8ddd\uff0c\u57281.6\u548c1.7\u7684\u65f6\u5019\uff0cJDK\u52a8\u6001\u4ee3\u7406\u7684\u901f\u5ea6\u8981\u6bd4CGLib\u52a8\u6001\u4ee3\u7406\u7684\u901f\u5ea6\u8981\u6162\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u6559\u79d1\u4e66\u4e0a\u768410\u500d\u5dee\u8ddd\uff0c\u5728JDK1.8\u7684\u65f6\u5019\uff0cJDK\u52a8\u6001\u4ee3\u7406\u7684\u901f\u5ea6\u5df2\u7ecf\u6bd4CGLib\u52a8\u6001\u4ee3\u7406\u7684\u901f\u5ea6\u5feb\u5f88\u591a\u4e86\uff0c\u5e0c\u671b\u5c0f\u4f19\u4f34\u5728\u9047\u5230\u8fd9\u4e2a\u95ee\u9898\u7684\u65f6\u5019\u80fd\u591f\u6709\u7684\u653e\u77e2\uff01</p> </li> <li> <p>http1.1\u7684\u7279\u70b9\u662f\u957f\u8fde\u63a5\uff0c\u800c\u4e14\u73b0\u5728\u51e0\u4e4e\u90fd\u662f1.1</p> </li> <li> <p>\u4e3a\u4ec0\u4e48\u524d\u6bb5\u7684\u8bf7\u6c42\u90fd\u5e26\u4e00\u4e2a\u65f6\u95f4\u6233\uff1f\u600e\u4e48\u89e3\u51b3\u91cd\u590d\u63d0\u4ea4\uff1f \u7528\u6237\u70b9\u51fb\u4e00\u6b21\u540e\u53ea\u6709\u7b49\u540e\u53f0\u8fd4\u56de\u4e86\u7ed3\u679c\u624d\u5141\u8bb8\u70b9\u51fb\u4e0b\u4e00\u6b21\uff01</p> </li> <li> <p>foreach\u5faa\u73af\u600e\u4e48\u8df3\u51fa\u53bb \u5728foreach\u91ccreturn\u7684\u4f5c\u7528\u548ccontinue\u4e00\u6837</p> </li> <li> <p>1.\u53ea\u60f3\u53d6\u51fa\u67d0\u4e00\u4e2a\u5bf9\u8c61\uff0c\u53ef\u8f6c\u6210map.jsonObject\u53d6\u503c</p> </li> </ul> <pre><code>LinkedHashMap linkedHashMap = (LinkedHashMap) triggerClientImpl.queryTriggerByEventKey(triggerDto).getData();\nTriggerDto triggerResDto = new JSONObject(linkedHashMap).toJavaObject(TriggerDto.class);\n</code></pre> <ul> <li> <p>\u6d77\u5eb7\u5b9a\u65f6\u4efb\u52a1\uff0c\u4f1a\u76d1\u542ccontextrefreshedEvent\u4e8b\u4ef6\uff0c\u7136\u540e\u53bb\u5f00\u542f\u5b9a\u65f6\u4efb\u52a1\uff0c\u5229\u7528scheduler\u7684api\u6765\u6dfb\u52a0\uff0c\u4fee\u6539\uff0c\u5220\u9664\u4efb\u52a1\uff0c\u8fd8\u6709trigger\u7b49</p> </li> <li> <p>get\u8bf7\u6c42\u4e5f\u53ef\u4ee5\u7528\u4e00\u4e2a\u5bf9\u8c61\u6765\u63a5\u53d7\u53c2\u6570\uff0c\u524d\u9762\u4e0d\u7528\u4efb\u4f55\u6ce8\u89e3</p> </li> <li> <p>h_mxc</p> </li> <li> <p>IBM\u7684\u5b66\u4e60\u91cc\u90fd\u662f\u9ad8\u8d28\u91cf\u7684\u6587\u7ae0\u597d\u597d\u8ba1\u5212\u5b66\u4e60</p> </li> <li> <p>\u65f6\u95f4\u540c\u6b65\u3002NTP\u662f\u7f51\u7edc\u65f6\u95f4\u534f\u8bae(Network Time Protocol)\uff0c\u5b83\u662f\u7528\u6765\u540c\u6b65\u7f51\u7edc\u4e2d\u5404\u4e2a\u8ba1\u7b97\u673a\u7684\u65f6\u95f4\u7684\u534f\u8bae</p> </li> <li> <p>Rest\u63a5\u53e3\u3002\u5fc5\u987b\u8981\u6709\u670d\u52a1\u540d\u548c\u7248\u672c\u53f7 \u8d44\u6e90\u7f16\u53f7IndexCode\u3002\u5982https\uff1a//127.0.0.1/userService/v1.0/getUSer/1242</p> </li> <li> <p>\u53c2\u6570\u6821\u9a8c\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u4e0d\u6d89\u53cadao\u5c42\u7684\u6821\u9a8c\u90fd\u653e\u5230controller\u5c42\u3002 \u53ef\u4ee5\u62e6\u622a\u5230\u8fbecontroller\u65b9\u6cd5\u7684\u8bf7\u6c42\uff0c\u5229\u7528@validated\u6ce8\u89e3\u6765\u8fdb\u884c\u53c2\u6570\u7684\u6821\u9a8c\uff0c\u4e0d\u5408\u6cd5\u53ef\u4ee5\u76f4\u63a5\u629b\u51fa\u5f02\u5e38\uff0c\u5728\u7edf\u4e00\u5f02\u5e38\u5904\u7406\u5668\u4e2d\u5904\u7406\uff0c\u8fd4\u56de\u9700\u8981\u7684\u4fe1\u606f\u3002spring validate\u5c31\u662f\u5b9e\u73b0\u4e86\u8fd9\u4e2a\u529f\u80fd\u7684\u6846\u67b6\u3002</p> </li> <li> <p>\u8fde\u63a5\u8fdc\u7a0b\u4e3b\u673a\u53ef\u4ee5\u7528serity CRT,\u4e5f\u53ef\u4ee5\u7528XSheel\u3002</p> </li> <li> <p>\u5378\u8f7d\u670d\u52a1\u3002\u5728\u547d\u4ee4\u884c\u901a\u8fc7 sc delete \u670d\u52a1\u540d\u5c31\u53ef\u4ee5\u5378\u8f7d\u7535\u8111\u4e0a\u7684\u670d\u52a1\u3002\u670d\u52a1\u540d\u53ef\u4ee5\u901a\u8fc7services.msc\uff0c\u53f3\u952e\u70b9\u51fb\u76f8\u5e94\u7684\u670d\u52a1\u53ef\u4ee5\u67e5\u770b\u670d\u52a1\u540d</p> </li> <li> <p>\u5982\u4f55\u5728\u4f7f\u7528andLike\uff08\u201cname\",\"%\"+name+\"%\"\uff09\u9632\u6b62sql\u6ce8\u5165\u7684\u95ee\u9898,\u9700\u8981\u5c06name\u5b57\u6bb5\u8fdb\u884c\u5de5\u5177\u7c7b\u8fdb\u884c\u8fc7\u6ee4\u548c%\u3002\u5de5\u5177\u7c7b\u4e2d\u8fdb\u884csql.replace(\"\",\"/_\").replace(\"%\",\"/%\")\u8fc7\u6ee4\u3002\u7136\u540eandLike\uff08\u201dname\",\"%\"+name+\"%\"\uff09\u5c31\u53ef\u4ee5\u9632\u6b62sql\u6ce8\u5165\u4e86\u3002</p> </li> <li> <p>\u6d77\u5eb7\u56fe\u7247\u670d\u52a1\u5668\u7528\u7684\u662f\u81ea\u5df1\u5f00\u53d1\u7684pss\uff0c\u540e\u6765\u53d8\u6210pstore\u56fe\u7247\u670d\u52a1\u5668\u3002\u5f00\u6e90\u7684\u6709fastDFS\u3002</p> </li> <li> <p>easyexcel\u5728poi\u7684\u57fa\u7840\u4e0a\u505a\u4e86\u4e8c\u6b21\u4f18\u5316\uff0c\u89e3\u51b3\u4e86poi\u7684\u5185\u5b58\u5360\u7528\u95ee\u9898\uff0c\u89e3\u51b3\u4e86poi\u7684\u5e76\u53d1\u9020\u6210\u7684\u62a5\u9519\u95ee\u9898\u3002\u5728\u5927\u6570\u636e\u91cf\u7684\u60c5\u51b5\u4e0b\u5bfc\u5165\u5bfc\u51fa\u6027\u80fd\u8f83\u5f3a\u6392\u67e5\u51fa\u4e00\u4e2a\u7ec4\u4ef6\u6982\u7387\u6027\u6b7b\u9501\u95ee\u9898\uff0c\u5bfc\u81f4\u7684tomcat\u542f\u52a8\u963b\u585e\u3002</p> </li> <li> <p>\u8bed\u8a00\u56fd\u9645\u5316\u672c\u5730\u5316\u8981\u8003\u8651\u957f\u5ea6\uff0c\u897f\u65b9\u8bed\u4f1a\u663e\u793a\u4e0d\u4e0b\u3002\u800c\u4e14\uff0c\u6709\u4e9b\u8bed\u8a00\u662f\u4ece\u53f3\u5230\u5de6\u7684\uff0c\u9700\u8981\u955c\u9762\u663e\u793a</p> </li> </ul>"},{"location":"note/hik/#career","title":"career","text":"<p>2017.9.13\u5165\u804c\u3002</p> <p>12.4\u5230\u5e7f\u5dde\u53c2\u4e0e\u6052\u5927\u9879\u76ee\uff0c6.9\u7ed3\u675f\u3002</p> <p>11.22\u65e5 \u67b6\u6784\u8bbe\u8ba1\u5b8c\u6210</p> <p>12.08\u65e5 \u6280\u672f\u9a8c\u8bc1\u521d\u6b65\u5b8c\u6210 1</p> <p>2.28\u65e5 POC1\u6b63\u5f0f\u9000\u51fa\u6d4b\u8bd5 </p> <p>02.10\u65e5 POC2\u6b63\u5f0f\u9000\u51fa\u6d4b\u8bd5 </p> <p>03.22\u65e5 POC3\u6b63\u5f0f\u9000\u51fa\u6d4b\u8bd5</p> <p>6.15\u53c2\u4e0e\u5b9a\u5236\u9879\u76ee \u91cd\u5e86\u767e\u8d27\u5546\u573a \u548c\u9648\u53f729\u3002\u8981\u6c426.25\u90e8\u7f72\u5230\u9879\u76ee\u73b0\u573a</p> <p>7.18\u524d\u5b8c\u6210\u7acb\u4f53\u9632\u63a7\u6a21\u5757\u7684\u5f00\u53d1\uff0c7\u6708\u5e95Ar\u8bbe\u5907\u7acb\u4f53\u9632\u63a7\u6a21\u5757\u8981\u968f\u7740\u4ea7\u54c1\u5356\u51fa\u53bb</p> <p>8\u67089\u6708\u5b8c\u6210\u533a\u57df\u5165\u4fb5\u7684\u5f00\u53d1\uff0c\u4ece\u4ea7\u54c1\u9700\u6c42\u6587\u6863\uff0c\u603b\u4f53\u8bbe\u8ba1\uff0c\u6982\u8981\u8bbe\u8ba1\uff0c\u4ea4\u4e92\uff0c\u6548\u679c\u56fe\u90fd\u53c2\u4e0e\u4e86\u5176\u4e2d\uff0c\uff08\u524d\u671f\u5206\u914d\u4e86\u4e09\u4e2a\u4eba\uff09\u4f46\u7531\u4e8e\u4eba\u5458\u7d27\u5f20\u72ec\u7acb\u5b8c\u6210\u4ee3\u7801\u7684\u7f16\u5199</p>"},{"location":"note/rr/","title":"Rr","text":"<ul> <li> <p>\u4e3a\u4e86\u51cf\u5c11\u6bcf\u6b21\u4e0a\u7ebf\u524d\u6d4b\u8bd5\u7684\u5de5\u4f5c\u91cf\uff0c\u6709\u4e00\u4e9b\u57fa\u7840\u548c\u91cd\u8981\u7684\u529f\u80fd\uff0c\u5fc5\u987b\u8981\u6d4b\u8bd5\uff0c\u5982\u8bbe\u5907\u7684\u914d\u7f51\uff0c\u623f\u95f4\u4f53\u7cfb\uff0c\u5206\u4eab\uff0c\u8bbe\u5907\u7684\u544a\u8b66\uff0c\u8bbe\u5907\u7684\u5347\u7ea7\u8fd9\u4e9b\uff0c\u6a21\u62df\u8bbe\u5907\u548c\u624b\u673a\u7aef\u5230\u7aef\u7684\u3002\u6211\u7528python \u57fa\u4e8epytest \u5199\u4e86\u6d4b\u8bd5\u7c7b\uff0c\u4e3b\u8981\u57fa\u4e8e\u4e3b\u5e72\u7684\u4e1a\u52a1\u6d41\u7a0b\uff0c\u4e5f\u5c31\u662f\u628a\u6d4b\u8bd5\u7684test case \u62ff\u8fc7\u6765\uff0c\u6d4b\u8bd5\u6574\u4e2a\u4e1a\u52a1\u6d41\u7a0b\uff0c\u51cf\u5c11\u6d4b\u8bd5\u6bcf\u6b21\u4e0a\u7ebf\u524d\u7684\u5de5\u4f5c\u91cf\u3002\u4ee5\u524d\u6d4b\u8bd5\u8981\u4e00\u5929\u591a\uff0c\u73b0\u5728\u57fa\u4e8e\u6211\u7684\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u4eba\u5458\u534a\u5929\u5c31\u53ef\u4ee5\u51c6\u5907\u4e0a\u7ebf\u4e86\u3002\u57fa\u672c\u8986\u76d6\u4e8690%\u7684\u573a\u666f\uff0c\u6709\u4e9b\u6ce8\u518c\u90ae\u7bb1\uff0c\u9a8c\u8bc1\u7801\u7684\u6ca1\u6cd5\u6d4b\u8bd5\u3002 \u6574\u4e2a\u6d4b\u8bd5\u7c7b\u603b\u51715\u4e2a\u533a\uff0c\u8017\u65f6600\u591a\u79d2\uff0cretry\uff0c\u8fde\u63a5mq\u63a5\u53d7\u6d88\u606f\uff0c\u89e3\u5bc6\u7b49\u3002\u9886\u5bfc\u90e8\u7f72\u5230jekins\uff0c\u6bcf\u5929\u6267\u884c\u4e00\u6b21\uff0c\u6d4b\u8bd5\u62a5\u544a\u53d1\u90ae\u4ef6\u51fa\u6765\uff0c\u5c31\u662f\u8fd9\u6837\u4e00\u4e2a\u6d41\u7a0b</p> </li> <li> <p>header\u5934\u6dfb\u52a0\u65f6\u95f4\u6233\u548cnonce \uff0csha\u7b97\u6cd5\u9632\u6b62\u91cd\u653e\u653b\u51fb\uff0c\u53ea\u5141\u8bb85\u5206\u949f\u5185\u7684\u8bf7\u6c42\u3002\u6309\u7167restful \u98ce\u683c\u3002</p> </li> <li> <p>\u7f8e\u533aemqx\u6302\u4e86\uff0c\u81ea\u52a8\u6062\u590d\uff0c\u4e00\u4e2a\u662f\u673a\u5668\u8d28\u91cf\u4e0d\u597d\uff0c\u7136\u540e\u589e\u52a0\u673a\u5668\u5457\u3002elb\u81ea\u52a8\u628a\u8fde\u63a5\u6570\u8f6c\u5230\u53e6\u4e00\u53f0\u673a\u5668\u4e0a</p> </li> <li> <p>\u63a8\u9001push\u6d88\u606f\u5230\u624b\u673a\u7aef\uff0cpush\u5c31\u662f\u7cfb\u7edf\u901a\u77e5\u3002\u82f9\u679cAPNS\u3002FCM \u8c37\u6b4c\u7684firebase Umeng</p> </li> <li> <p>\u5e76\u53d1\u7f16\u7a0b\u7684semphore\u7684\u4f7f\u7528\u5904\uff0c\u6bd4\u5982\u63a8\u9001apns \u65f6\u63a7\u5236\u4e0b\u540c\u65f6\u7684\u4e2a\u6570\uff0c\u9632\u6b62\u5185\u5b58\u6ea2\u51fa\u3002mq\u6d88\u606f\u5904\u7406</p> </li> <li> <p>\u666e\u7f57\u7c73\u4fee\u65af\u505a\u76d1\u63a7\uff0c\u53ef\u4ee5\u76d1\u63a7\u591a\u4e2a\u8f6f\u4ef6\u5982redismysql,linux\u8fd8\u6709\u81ea\u5df1\u670d\u52a1\u7684\u8fd0\u884c\u72b6\u6001 .</p> </li> <li> <p>grafana \u8fdb\u884c\u6027\u80fd\u7684\u76d1\u63a7\uff0c</p> </li> <li> <p>superset\u505a\u4e1a\u52a1\u903b\u8f91\u7684\u76d1\u63a7.\u6bcf\u5929\u53d1\u90ae\u4ef6\u901a\u77e5\u76f8\u5173\u7684\u8d1f\u8d23\u4ebajedis\u8fde\u63a5db2\u6570\u636e\u5e93\uff0c\u7136\u540e\u518dget\u65f6\u4f1a\u88ab\u91cd\u7f6e\u4e3a\u9ed8\u8ba4\u7684db0\uff0c\u5bfc\u81f4get \u5931\u8d25\u3002nginx \u4f1a\u5c06http\u7684post\u8bf7\u6c42\u8f6c\u4e3aget\uff0c\u5f88\u795e\u5947\uff0c\u4f46\u662fhttps \u5c31\u6ca1\u95ee\u9898\u3002crdb \u8d1f\u8d23\u591a\u4e2a\u65f6\u533a\u4e4b\u95f4\u6570\u636e\u5e93\u540c\u6b65\u7528\u7684okhttp3\uff0c\u7136\u540e\u7528retrite \u5229\u7528\u6ce8\u89e3\u6765\u5b9e\u73b0\u3002kafka\u8bbe\u7f6e\u7684\u6279\u91cf\u83b7\u53d6\u4e3atrue \uff0c\u4f46\u662f\u6ce8\u89e3\u76d1\u542c\u7684\u5355\u4e2amessage \uff0c\u800c\u4e0d\u662flist\uff0c\u6240\u4ee5\u6781\u7aef\u9891\u7e41\u60c5\u51b5\u4e0b\u4f1a\u4e22\u6d88\u606f</p> </li> <li> <p>\u4e92\u8054\u7f51\u8981\u8003\u8651\u7684\u4e8b\u60c5\u5f88\u591a\uff0c\u50cf\u662f\u7f51\u7edc\u6296\u52a8\u771f\u7684\u5b58\u5728\uff0c\u4e00\u4e2a\u6708\u6765\u90a3\u4e48\u4e09\u56db\u6b21\uff0c\u628a\u4eba\u5413\u6b7b\u3002\u8fd9\u8fb9\u6709\u826f\u597d\u7684\u76d1\u63a7\u548c\u6d4b\u8bd5e2e\uff0c\u51fa\u73b0\u95ee\u9898\uff0c\u9489\u9489\u65e5\u5fd7\u62a5\u9519\u63d0\u9192\uff0c\u8fc7\u4e00\u4f1a\u5c31\u597d\u4e86\u3002\u627e\u91d1\u5c71\u4e91\u548c\u963f\u91cc\u4e91\uff0c\u4eba\u5bb6\u5c31\u8bf4\u662f\u7f51\u7edc\u6ce2\u52a8</p> </li> <li> <p>\u8fd8\u6709\u9047\u5230\u6709\u4eba\u7528\u5404\u79cd\u7684\u8bf7\u6c42\u65b9\u5f0f\u6765\u653b\u51fb\uff0c\u9886\u5bfc\u540e\u6765\u51b3\u5b9a\u7528slb \u63d0\u4f9b\u7684\u6765\u5c4f\u853d\u6389\u8bf7\u6c42\u65b9\u5f0f\u6027\u80fd\u6d4b\u8bd5\u4f7f\u7528locustio \uff0cmqtt \u4f7f\u7528eqmx \uff0c\u4ee3\u7801\u5f00\u53d1\u4f7f\u7528github \uff0c\u9ed1\u82f9\u679c\u7cfb\u7edf</p> </li> <li> <p>import \u6ce8\u89e3\u7684\u4f5c\u7528\uff0cgradle\u7684\u4f7f\u7528</p> </li> <li> <p>listutils.patition\u7528\u6765\u5206\u6279\u63d2\u5165\uff0c\u4e0d\u7528\u81ea\u5df1\u53bb\u5206\u96c6\u5408\u3002pg\u7684upset\u662f\u6307\u6279\u91cf\u63d2\u5165\u65f6\u53ef\u4ee5on conflict do nothing returning xmin\uff0c\u552f\u4e00\u7d22\u5f15\u51b2\u7a81\u65f6\u4e0d\u62a5\u9519\u56de\u6eda\u4e8b\u52a1\uff0c\u800c\u4e14\u53ef\u4ee5\u8fd4\u56de\u5b9e\u9645\u63d2\u5165\u7684\u884c\u6570\uff0cxmin\u8868\u793a\u63d2\u5165\u7684\u4e8b\u52a1\u53f7\uff0c\u66f4\u65b0\u65f6\u4e3a0\u3002\u6ce8\u610f\u8fd9\u65f6mybatis \u7684\u6ce8\u89e3\u8981\u4f7f\u7528select\u800c\u4e0d\u80fdinsert\uff0c\u5426\u5219\u62ff\u4e0d\u5230\u8fd4\u56de\u7684list\u3002</p> </li> <li> <p>corturn\u5b9e\u73b0\u89c6\u9891\u7684\u4f20\u8f93\uff0c\u76d1\u63a7\u6d41\u91cf\u54ea\u4e2a\u5730\u533a\u89c2\u770b\u89c6\u9891\u591a\u9a8c\u8bc1\u7801\u7528\u7684captcha</p> </li> <li> <p>\u9489\u9489\u56e0\u4e3a\u65e5\u5fd7\u62a5\u9519\u592a\u591a\u9891\u7e41\uff0c\u6709\u4e9b\u9519\u8bef\u5c31\u6ca1\u63d0\u793a\uff0c\u5751\uff01\u4e1a\u52a1\u7684\u9891\u7e41\u7684\u7a7a\u6307\u9488\u5f02\u5e38\u628a502bad gateway \u7f51\u5173\u5f02\u5e38\u7ed9\u6324\u6389\u4e86\uff0c\u5e78\u4e8f\u67e5\u627eelk\u65e5\u5fd7\u770b\u5230\u4e86\u3002\u4e91\u670d\u52a1\u5668\u63d0\u4f9b\u7684\u8d1f\u8f7d\u5747\u8861emqx \uff0c</p> </li> </ul> <p># code review</p> <p>\u603b\u4f53\u8bbe\u8ba1\uff1a</p> <p>1.\u5982\u5f00\u59cb\u662fephyra-manager\u8c03\u7528commander\uff0c\u7136\u540e\u8c03\u7528messenger\u7684\u6d41\u7a0b\uff0c\u5bf9\u6a21\u5757\u5212\u4e3a\u53ca\u6a21\u5757\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u4e0d\u6e05\u6670</p> <p>2.ephyra\u8c03\u7528messenger\uff0c\u5f00\u59cb\u8bbe\u8ba1\u7684\u901a\u8fc7mq\u524a\u5cf0\uff0c\u4f46\u8fd9\u6837\u5f15\u5165\u4e86kafka\u6a21\u5757\uff0c\u4e0d\u5408\u7406\u3002</p> <ul> <li> <p>\u7c7b\u90fd\u6709\u81ea\u5df1\u7684\u804c\u8d23\u4e0e\u529f\u80fd\uff0c\u4e0d\u80fd\u4e3a\u4e86\u4e4b\u524d\u7684\u4ee3\u7801\uff0c\u5c31\u628a\u65b0\u529f\u80fd\u653e\u5728\u4e4b\u524d\u7684\u7c7b\u91cc\u3002\u7c7b\u592a\u5927\u4e86\u4e5f\u8981\u6ce8\u610f\u62c6\u5206\uff0c\u4fdd\u6301\u7c7b\u7684\u7b80\u6d01\u4e0e\u6e05\u6670\u6027</p> </li> <li> <p>naming\u548clog\u4e0d\u8981\u5f88\u5947\u602a\uff0c\u6ce8\u610f\u903b\u8f91\u7684\u6b63\u786e\u3002</p> </li> <li> <p>\u5982\u4f55\u8bb0\u5f55\u65e5\u5fd7\u9700\u8981\u4ed4\u7ec6\u8003\u8651\u3002\u6027\u80fd\u53ef\u80fd\u51fa\u73b0\u95ee\u9898\u7684\u5730\u65b9\u8981\u524d\u540e\u8bb0\u5f55\uff0c\u51fa\u73b0\u5206\u652f\u7684\u5173\u952e\u5730\u65b9\u8981\u8bb0\u5f55\uff0c\u64cd\u4f5c\u7ed3\u679c\uff0c\u9519\u8bef\u4fe1\u606f\u53ca\u8981\u8c03\u7528\u5176\u4ed6\u7cfb\u7edfAPI\u7684\u5730\u65b9\u7b49\u53cd\u6b63\u662f\u5173\u952e\u7684\u5730\u65b9\u8981\u8bb0\u5f55\u3002\u65e5\u5fd7\u4e5f\u8981\u5199\u7684\u6e05\u6670\u70b9\uff0c\u4e00\u4e2a\u65b9\u6cd5\u662f\u4e09\u4e2a\u6708\u540e\u6216\u8005\u522b\u4eba\u770b\u65e5\u5fd7\u80fd\u770b\u61c2\u5565\u610f\u601d\u5417</p> </li> <li> <p>\u6ce8\u610f\u5408\u9002\u7684\u65b9\u6cd5\u62bd\u53d6\u5b9a\u4e49\uff0c\u4e0d\u8981hard code\uff0c\u65b9\u6cd5\u4fbf\u4e8e\u6d4b\u8bd5\u3002\u5982\u5224\u65ad\u5f53\u524d\u533a\u57df\u662f\u5426\u662f\u7f8e\u56fd\uff0c\u4e0d\u8981hard code\uff0c\u62bd\u53d6\u4e2a\u65b9\u6cd5\u5c31\u5f88\u5408\u9002</p> </li> <li> <p>sql\u8bed\u53e5\u90fd\u4fdd\u6301\u5168\u90e8\u5927\u5199\uff0cjoin\u8054\u7ed3\u67e5\u8be2\u65f6\uff0cselect \u54ea\u4e2a\u5c31\u628a\u54ea\u4e2a\u8868\u653e\u5728\u524d\u9762\uff0c\u5e76\u4e14\u6bcf\u4e2a\u5b57\u6bb5\u90fd\u8981\u6ce8\u660e\u662f\u54ea\u4e2a\u8868\u7684</p> </li> <li> <p>\u91cd\u70b9\u4e5f\u8981\u628a\u63e1\uff0c\u4e0d\u8981\u60f3\u592a\u591a\uff0c\u4e1a\u52a1\u4e0a\u4fdd\u8bc1\u4e0d\u4f1a\u51fa\u73b0\u7684\u95ee\u9898\u4e0d\u5fc5\u8003\u8651\u3002\u9000\u4e00\u6b65\u5373\u4f7f\u51fa\u95ee\u9898\u4e86\u62a5\u9519\u4e5f\u53ef\u4ee5\u63a5\u53d7\u3002</p> </li> <li> <p>\u4f7f\u7528stream\u65f6\u6700\u597d\u628a\u6bcf\u4e2a\u6d41\u64cd\u4f5c\u5206\u884c\u5199\uff0c\u8fd9\u6837\u54ea\u4e00\u6b65\u6d41\u64cd\u4f5c\u51fa\u95ee\u9898\uff0c\u65b9\u4fbf\u5728\u65e5\u5fd7\u91cc\u67e5\u770b\u54ea\u4e00\u884c\u51fa\u73b0\u9519\u8bef</p> </li> <li> <p>\u5408\u9002\u7684\u5730\u65b9\u53ef\u4ee5\u4f7f\u7528BeanUtils\uff0c\u51cf\u5c11\u4ee3\u7801\u91cd\u590d</p> </li> </ul> <p>#  </p>"},{"location":"note/zm/","title":"Zm","text":"<p>\u7cfb\u7edf\u67b6\u6784\u56fe\u5982\u4e0b\uff1a</p> <p></p>"},{"location":"note/zm/#solar","title":"\u57fa\u7840\u67b6\u6784Solar","text":"<p>Solar\u4f5c\u4e3a\u4e0b\u4e00\u4ee3\u57fa\u7840\u5fae\u670d\u52a1\u4f53\u7cfb\uff0c2019\u5e7411\u6708\u5f00\u59cb\u7b79\u5212\uff0c2020\u5e741\u67084\u65e5\u63a8\u51fa\u7b2c\u4e00\u7248\uff0c2020\u5e744\u670815\u65e5\u53d1\u5e031.2.0 &amp; 2.2.0\u91cc\u7a0b\u7891\u7a33\u5b9a\u7248\uff0c\u517c\u5bb9Spring Cloud Edgware\u7248\u3001Finchley\u7248\u3001Greenwich\u7248\u3001Hoxton\u7248\u672c\u3002</p> <p>\u57fa\u4e8e\u4e09\u5c42\u4f53\u7cfb\u800c\u6784\u5efa</p> <ul> <li>\u57fa\u7840\u516c\u5171\u7ec4\u4ef6\u3002Solar\u7684\u57fa\u7840\u7ec4\u4ef6\uff0c\u57fa\u7840\u516c\u5171\u7ec4\u4ef6\u4e00\u822c\u5448\u539f\u5b50\u5c42\u9762\u7684\u72ec\u7acb\u5b58\u5728\uff0c\u7ec4\u4ef6\u95f4\u4e5f\u53ef\u9002\u5f53\u8026\u5408\uff0c\u57fa\u672c\u4e0a\u53ef\u8fbe\u5230\u4e00\u4e2a\u7ec4\u4ef6\u88ab\u79fb\u9664\uff0c\u4e0d\u5f71\u54cd\u53e6\u5916\u4e00\u4e2a\u7ec4\u4ef6\u7684\u8fd0\u884c\u7684\u7279\u5f81</li> <li>\u57fa\u7840\u516c\u5171\u6846\u67b6\u3002Solar\u7684\u57fa\u7840\u6846\u67b6\uff0c\u4f9d\u6258Spring     Cloud\u670d\u52a1\u4f53\u7cfb\uff0c\u4ee5\u6846\u67b6\u5f62\u5f0f\u5bf9\u5916\u66b4\u9732\u3002\u5b83\u7684\u53e6\u5916\u4e00\u4e2a\u91cd\u8981\u7279\u5f81\uff0c\u662f\u5bf9\u57fa\u7840\u516c\u5171\u7ec4\u4ef6\u7684\u805a\u5408\uff0c\u4e00\u79cd\u201c\u642d\u79ef\u6728\u201d\u7684\u65b9\u5f0f\u8fdb\u884c\u6784\u5efa</li> <li>\u57fa\u7840\u516c\u5171\u670d\u52a1\u3002Solar\u7684\u57fa\u7840\u670d\u52a1\uff0c\u4ee5\u516c\u5171\u670d\u52a1\u5f62\u5f0f\u5bf9\u5916\u66b4\u9732\u3002\u5b83\u7684\u53e6\u5916\u4e00\u4e2a\u91cd\u8981\u7279\u5f81\uff0c\u662f\u5bf9\u57fa\u7840\u516c\u5171\u7ec4\u4ef6\u7684\u4f7f\u7528\uff0c\u5b83\u662fSolar\u6846\u67b6\u536b\u661f\u73af\u7ed5\u5f0f\u7684\u7ec4\u6210\u90e8\u5206</li> </ul> <p>Solar\u57fa\u4e8eSpring Cloud\u6280\u672f\u6808\uff0c\u652f\u6301Eureka\u6ce8\u518c\u4e2d\u5fc3\u3001Apollo\u914d\u7f6e\u4e2d\u5fc3\u3001Zuul\u7f51\u5173\u30012\u4e2a\u9650\u6d41\u7194\u65ad\u964d\u7ea7\u7ec4\u4ef6\uff08Sentinel\u3001Hystrix\uff09\u7b49\uff0cSkywalking + Opentracing\u548cCAT\u7684APM\u8c03\u7528\u94fe\u76d1\u63a7\uff0cPrometheus + Grafana\u6307\u6807\u76d1\u63a7\uff0cKibana\u65e5\u5fd7\u76d1\u63a7\u7b49\uff0c\u5177\u6709\u4f01\u4e1a\u7ea7\u7684\u63d2\u4ef6\u5f15\u5165\u3001\u5f00\u7bb1\u5373\u7528\u7279\u5f81\u3002\u5b83\u5305\u542b\u51e0\u5927\u6838\u5fc3\u6a21\u5757\uff1a</p> <ul> <li>\u5168\u94fe\u8def\u7070\u5ea6\u84dd\u7eff\u53d1\u5e03\u667a\u80fd\u5316&amp;DevOps\u53d1\u5e03\u5e73\u53f0\u96c6\u6210</li> <li>Zuul\u7f51\u5173\u52a8\u6001\u8fc7\u6ee4\u8f6c\u53d1\u7070\u5ea6\u84dd\u7eff&amp; Furion \u7edf\u4e00\u63a7\u5236\u53f0</li> <li>Sentinel\u5168\u94fe\u8def\u7194\u65ad\u9650\u6d41\u964d\u7ea7\u6743\u9650\u548c\u81ea\u7814\u529f\u80fd</li> <li>Apollo &amp; Eureka &amp; VI &amp; Sensitive &amp; EventBus &amp; Agent &amp;XXL-Job\u7b49\u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6</li> <li>Docker CI &amp; \u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li>\u670d\u52a1\u548c\u7f51\u5173\u4e00\u952e\u811a\u624b\u67b6</li> <li>\u76d1\u63a7\u4e09\u8981\u7d20\uff0cTracer\uff08Skywalking     &amp; CAT\uff09\uff0cMetrics \uff08\u591a\u7ef4\u5ea6\u7684\u4e1a\u52a1\u6307\u6807\u76d1\u63a7\uff09\uff0cLogger\uff08MDC\uff0cKibana &amp; ES &amp; GOHANGOUT\u7b49\u7684ELK\u65e5\u5fd7\u96c6\u7fa4\uff09</li> <li>\u6253\u901a\u57fa\u7840\u6570\u636e\u4e2d\u95f4\u4ef6\uff0cMySQL\uff08ShardingSphere\uff09&amp;     RocketMQ &amp; MongoDB &amp; Redis</li> <li>\u652f\u6301\u5927\u6570\u636e\u5e73\u53f0\uff0cKafka&amp; Elastic Search &amp; InfluxDB</li> <li>\u63a5\u5165GPM\u76d1\u63a7\u5e73\u53f0\uff0cPrometheus     &amp; Grafana &amp; InfluxDB &amp; AlarmCenter \uff08\u8fd0\u7ef4\u3001\u90ae\u4ef6\u3001\u9489\u9489\u673a\u5668\u4eba\u548c\u638c\u63a7APP\u544a\u8b66\uff09</li> <li>\u63a5\u5165\u963f\u91cc\u4e91\uff0cOSS\u652f\u6491</li> </ul>"},{"location":"note/zm/#solarv231","title":"SolarV2.3.1","text":"<p>Solar Foundation\u57fa\u4e8eSpring Cloud Edgware\u548cGreenwich\u7248\u800c\u6253\u9020\u7684\u5fae\u670d\u52a1\u4f53\u7cfb\uff0c\u5b83\u96c6\u6210Nacos/Eureka\u53cc\u6ce8\u518c\u4e2d\u5fc3\u3001Apollo\u914d\u7f6e\u4e2d\u5fc3\u3001Sentinel/Hystrix\u53cc\u9650\u6d41\u7194\u65ad\u3001SkyWalking + OpenTracing/CAT\u53cc\u57cb\u70b9\u76d1\u63a7\u3001Prometheus + Grafana\u6307\u6807\u76d1\u63a7\u3001Kibana\u65e5\u5fd7\u76d1\u63a7\u3001Metrics\u4e1a\u52a1\u76d1\u63a7\u7b49\u7ec4\u4ef6\uff0c\u6574\u5408DevOps\u53d1\u5e03\u5e73\u53f0\uff0c\u57fa\u4e8eZuul\u7f51\u5173\u5b9e\u65bd\u84dd\u7eff\u7070\u5ea6\u53d1\u5e03\u3001\u5b50\u73af\u5883\u9694\u79bb\u3001\u52a8\u6001\u8fc7\u6ee4\u8f6c\u53d1\u8def\u7531\u7b49\u529f\u80fd\uff0c\u57fa\u4e8e\u638c\u63a7\u548c\u9489\u9489\u673a\u5668\u4eba\u5b9e\u65bd\u544a\u8b66\u529f\u80fd\uff0c\u63d0\u4f9bDev CI\u81ea\u52a8\u5316\u4e00\u952e\u90e8\u7f72\u548c\u6d4b\u8bd5\u5de5\u5177\uff0c\u63d0\u4f9b\u7f51\u5173\u548c\u5fae\u670d\u52a1\u811a\u624b\u67b6\u4e00\u952e\u751f\u6210\u5de5\u5177</p> <p>\u5e73\u6ed1\u6539\u9020\u548c\u8fc1\u79fb\u5fae\u670d\u52a1\u5230Nacos\u6ce8\u518c\u4e2d\u5fc3\uff0c\u622a\u6b622020-07-23\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u63a5\u5165Solar\u5fae\u670d\u52a1\u4f53\u7cfb\uff08Nacos SDK + Eureka SDK\uff09\uff0c\u4e1a\u52a1\u670d\u52a1\u6570\u8fbe\u5230\u8fbe\u5230131\u4e2a\uff0c\u5b9e\u4f8b\u6570287\u4e2a\uff08\u5176\u4e2dNacos SDK\u5230\u8fbe183\u4e2a\uff09</p> <p></p>"},{"location":"note/zm/#_1","title":"\u76d1\u63a7\u4f53\u7cfb","text":"<p>SaaS\uff08\u8f6f\u4ef6\u5373\u670d\u52a1\uff09\uff0cPaaS\uff08\u5e73\u53f0\u5373\u670d\u52a1\uff09\u548cIaaS\uff08\u57fa\u7840\u67b6\u6784\u5373\u670d\u52a1\uff09</p> <p></p>"},{"location":"note/zm/#chaos","title":"Chaos\u7f51\u5173","text":"<p>Chaos\u7f51\u5173\uff0c\u6df7\u6c8c\u6d4b\u8bd51.0\u7248\u672c\uff0c\u5b9e\u73b0\u4e86\u7f51\u5173\u548c\u670d\u52a1\u63a5\u53e3\u5c42\u9762\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u6709\u6548\u9a8c\u8bc11v1\u6838\u5fc3\u548c\u975e\u6838\u5fc3\u4f9d\u8d56\u670d\u52a1\u7684\u5bb9\u9519\u80fd\u529b\uff0c\u6d4b\u8bd5\u6838\u5fc3\u4e1a\u52a1\u662f\u5426\u5065\u58ee\uff0c\u80fd\u6709\u6548\u9a8c\u8bc1\u6838\u5fc3\u548c\u975e\u6838\u5fc3\u4e1a\u52a1\u515c\u5e95\u7b56\u7565\u662f\u5426\u751f\u6548\uff0c\u80fd\u5927\u5e45\u5ea6\u63d0\u5347\u4e86\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u3002</p> <p>2.0\u5c06\u4f1a\u548cchaosblade\u7ed3\u5408\u8fdb\u4e00\u6b65\u6269\u5c55\u6545\u969c\u6ce8\u5165\u7684\u7c7b\u578b\uff0c\u8986\u76d6\u4f8b\u5982CPU\u6ee1\u8f7d\uff0c\u78c1\u76d8IO\u9ad8\uff0c\u7f51\u7edc\u5ef6\u8fdf\u8d85\u65f6\u7b49\u7ebf\u4e0a\u91cd\u8981\u8282\u70b9Paas\u5c42\u7684\u5bb9\u9519\u80fd\u529b\uff0c\u5e76\u4e14\u80fd\u591f\u8fdb\u884c\u7ebf\u4e0a\u5168\u8282\u70b9\u7684\u6545\u969c\u6f14\u7ec3\uff0c\u5bf9\u76d1\u63a7\u544a\u8b66\u7684\u53ca\u65f6\u6027\uff0c\u5bf9\u5458\u5de5\u91cd\u5927\u7ebf\u4e0a\u6545\u969c\u7684\u5904\u7406\u80fd\u529b\u8fdb\u884c\u953b\u70bc\uff0c\u4ece\u800c\u8fdb\u4e00\u6b65\u51cf\u5c11\u7ebf\u4e0a\u91cd\u5927\u6545\u969c\u7684\u53d1\u751f\u3002</p> <p></p>"},{"location":"note/zm/#_2","title":"\u53d1\u5e03\u7cfb\u7edf","text":"<p>\u516c\u53f8\u5206\u4e3a\u5bb9\u5668\u548c\u865a\u62df\u673a\u53d1\u5e03\u3002</p> <p>\u5bb9\u5668\u53d1\u5e03\u7684\u8fd0\u884c\u73af\u5883\u5305\u62ecjar\u5305\u7248\u672c\uff0c\u5916\u7f51\u6743\u9650\uff0c\u5b9e\u4f8b\u89c4\u683c\uff0cJVM\u542f\u52a8\u53c2\u6570\uff0c\u6bcf\u6b21\u91cd\u542f\uff0c\u6269\u5bb9\uff0c\u8fd9\u4e9b\u90fd\u4e0d\u4f1a\u6539\u53d8\uff0c\u4f46\u4e0d\u5305\u62ecApollo\u914d\u7f6e\u3002</p> <p>\u5bb9\u5668\u53ef\u4ee5\u65b9\u4fbf\u7684\u6269\u7f29\u5bb9\uff0c\u7533\u8bf7\u5916\u7f51\u6743\u9650\uff0c\u4fee\u6539\u5b9e\u4f8b\u914d\u7f6e\u3002\u7279\u6b8a\u60c5\u51b5\u53ef\u4ee5\u7533\u8bf7\u57df\u540d\u7ed9\u5176\u4ed6\u670d\u52a1\u8c03\u7528\uff08\u901a\u5e38\u8d70nacos\uff09\uff1b\u4e5f\u63d0\u4f9b\u4e86web terminal\u65b9\u4fbf\u8fdb\u5165\u5bb9\u5668\uff0c\u7528\u6765\u5bfc\u51fa\u6587\u4ef6\u7b49\uff1b\u8fd8\u53ef\u4ee5\u4f7f\u7528Bistoury\u8fdb\u884c\u7ebf\u4e0a\u95ee\u9898\u8bca\u65ad\u3002</p> <p>\u5bb9\u5668\u8fd0\u884c\u65f6\u4e0d\u80fd\u7ed1\u5b9a\u56fa\u5b9aIP\uff0c\u4f46\u662f\u901a\u5e38\u53ef\u4ee5\u7ed1\u5b9a\u57df\u540d\u6765\u89e3\u51b3\u3002</p>"},{"location":"note/zm/#_3","title":"\u53d1\u5e03\u8fc7\u7a0b","text":"<p>\u5728 TARS \u7684\u751f\u4ea7\u53d1\u5e03\u6a21\u5f0f\u91c7\u7528\u91d1\u4e1d\u96c0\u7684\u6eda\u52a8\u53d1\u5e03\uff0c\u6240\u6709\u5728\u5e94\u7528\u53d1\u5e03\u524d\u6211\u4eec\u4f1a\u4ece\u5f85\u53d1\u5e03\u7684\u4e00\u7ec4\u673a\u5668\u4e2d\u9009\u51fa\u4e00\u53f0\u6216\u591a\u53f0\u4f5c\u4e3a\u91d1\u4e1d\u96c0(canary)\uff0c\u5373\u5821\u5792\u673a\u3002</p> <p>\u53ea\u6709\u5821\u5792\u673a\u53d1\u5e03\u6210\u529f\u540e\uff0c\u624d\u4f1a\u5141\u8bb8\u8fdb\u884c\u540e\u7eed\u7684\u6eda\u52a8\u53d1\u5e03\u3002\u5821\u5792\u673a\u53d1\u5e03\u4f5c\u4e3a\u5e94\u7528\u751f\u4ea7\u7070\u5ea6\u7684\u4e00\u90e8\u5206\uff0c\u5206\u4e3a somking \u9636\u6bb5\u548c baking \u9636\u6bb5\uff0c\u4e14\u4e24\u4e2a\u9636\u6bb5\u662f\u4e25\u683c\u53d7\u63a7\u7684\uff0c\u7ed3\u5408\u8fd9\u4e24\u4e2a\u9636\u6bb5\uff0c\u6211\u4eec\u8fdb\u4e00\u6b65\u964d\u4f4e\u65b0\u7248\u672c\u4e0a\u7ebf\u7684\u751f\u4ea7\u98ce\u9669\uff0c\u8ba9\u540e\u7eed\u7684\u6eda\u52a8\u53d1\u5e03\u66f4\u5b89\u5168\u3002</p> <p>smoking \u7684\u9a8c\u8bc1\u662f\u5728\u9694\u7edd\u751f\u4ea7\u6d41\u91cf\u7684\u73af\u5883\u4e0b\u8fdb\u884c\u7684\uff0c\u800c baking \u65f6\u5821\u5792\u673a\u5df2\u7ecf\u63a5\u5165\u751f\u4ea7\u6d41\u91cf\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4\u5982\u679c\u6b64\u65f6\u6709\u8bf7\u6c42\u5931\u8d25\uff0c\u662f\u4f1a\u9020\u6210\u751f\u4ea7\u635f\u5931\u7684\u3002\u5728 baking \u9636\u6bb5\uff0c\u751f\u4ea7\u53d1\u5e03\u4eba\u5458\u5e94\u8be5\u901a\u8fc7\u5176\u4ed6\u8f85\u52a9\u5de5\u5177\uff0c\u5982\u65e5\u5fd7\uff0c\u76d1\u63a7\u7b49\u6765\u76d1\u7763\u5821\u5792\u673a\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u5982\u679c\u53d1\u73b0\u5f02\u5e38\uff0c\u53ef\u4ee5\u76f4\u63a5\u56de\u6eda\u7248\u672c\uff0c\u6b64\u65f6\u65b9\u80fd\u6700\u5c0f\u5316\u63a7\u5236\u4f4f\u6545\u969c\u89c4\u6a21\u3002</p> <p>\u6211\u70b9\u51fb\u53d1\u5e03\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u4e24\u4e2a\u5b9e\u4f8b\uff1f</p> <p>\u5bb9\u5668\u7684\u53d1\u5e03\u65b9\u5f0f\u662f\u6eda\u52a8\u53d1\u5e03(rolling update)\u4e0d\u540c\u4e8e\u865a\u673a\uff0c\u901a\u8fc7\u5148\u542f\u52a8\u65b0\u7684\u5b9e\u4f8b\uff0c\u518d\u9500\u6bc1\u8001\u7248\u672c\u7684\u5b9e\u4f8b\uff08\u865a\u673a\u662f\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u5148\u628a\u8001\u7248\u672c\u7684\u8fdb\u884c\u4e2d\u6b62\uff0c\u518d\u542f\u52a8\u65b0\u7248\u672c\u7684\u8fdb\u7a0b\uff09\u3002\u8fd9\u79cd\u542f\u52a8\u65b9\u5f0f\u5145\u5206\u5229\u7528\u4e86\u5bb9\u5668\u7684\u4f18\u70b9\uff0c \u53ef\u4ee5\u66f4\u597d\u5730\u5b9e\u73b0\u65e0\u635f\u53d1\u5e03\u3002</p> <p>\u6240\u4ee5\u5728\u65b0\u7248\u672c\u7684\u5b9e\u4f8b\u542f\u52a8\u6210\u529f\u4e4b\u524d\uff0c\u4f1a\u540c\u65f6\u5b58\u5728\u4e24\u4e2a\u5b9e\u4f8b\uff0c\u4e00\u4e2a\u662f\u65e7\u7248\u672c\u7684\u5b9e\u4f8b\uff0c\u4e3a running \u72b6\u6001\uff0c\u4e00\u4e2a\u662f\u5f53\u524d\u65b0\u7684\u53d1\u5e03\u7248\u672c\u7684\u5b9e\u4f8b\uff0c\u72b6\u6001\u4e3a pending, \u5f53\u53d1\u5e03\u6210\u529f\u540e\uff0c\u65e7\u7248\u672c\u7684\u5b9e\u4f8b\u624d\u4f1a\u9500\u6bc1\u3002\u82e5\u53d1\u5e03\u5931\u8d25\uff0c\u5e76\u4e0d\u4f1a\u9500\u6bc1\u65e7\u7248\u672c\u7684\u5b9e\u4f8b\u3002</p> <p>JDK\u7248\u672c\u95ee\u9898</p> <p>\u73b0\u5728z m\u4f7f\u7528\u7684 JDK \u7248\u672c\u7edf\u4e00\u4e3a java8u131\uff0c \u8be5\u7248\u672c\u5728\u5bb9\u5668\u573a\u666f\u4e0b\u6709\u90e8\u5206\u529f\u80fd\u7f3a\u5931\uff0c\u6bd4\u5982\uff1a</p> <ol> <li>\u65e0\u6cd5\u6b63\u786e\u8bc6\u522b\u5bb9\u5668\u7684\u5185\u5b58\u9650\u5236\u3002JVM \u5728\u5bb9\u5668\u91cc\u9762\u8bc6\u522b\u5230\u7684\u662f\u5bbf\u4e3b\u673a\u7684\u5185\u5b58\uff0c\u9ed8\u8ba4\u4f1a\u4f7f\u7528 1/4 \u7684\u5bbf\u4e3b\u673a\u5185\u5b58\u3002\u8fd9\u6837\u4f1a\u8fdc\u8fdc\u5927\u4e8e\u5bb9\u5668\u89c4\u683c\u9650\u5236\u7684\u5185\u5b58\uff0c\u5bfc\u81f4\u5bbf\u4e3b\u673a\u5185\u5b58\u7206\u4e86\uff0c\u6700\u7ec8\u5bfc\u81f4\u5bb9\u5668\u81ea\u52a8\u91cd\u542f\u3002\u8fd9\u4e2a\u95ee\u9898\u5728\u53ef\u4ee5\u901a\u8fc7\u5728 JVM \u4e2d\u52a0\u5165 -XX:+UnlockExperimentalVMOptions     -XX:+UseCGroupMemoryLimitForHeap \u5f97\u5230\u89e3\u51b3\uff0c\u901a\u8fc7 CD \u5e73\u53f0\u6253\u7684\u5bb9\u5668\u955c\u50cf\u6211\u4eec\u4f1a\u7edf\u4e00\u52a0\u4e0a\u4ee5\u4e0a\u4e24\u4e2a JVM \u53c2\u6570\u3002</li> <li>\u65e0\u6cd5\u6b63\u786e\u8bc6\u522b\u5bb9\u5668\u7684 CPU \u6838\u6570\u3002JVM \u5728\u5bb9\u5668\u91cc\u9762\u8bc6\u522b\u5230 CPU \u6838\u6570\u4e5f\u662f\u5bbf\u4e3b\u673a\u7684\uff0c\u5bfc\u81f4\u4ee3\u7801 Runtime.getRuntime().availableProcessors() \u83b7\u53d6 JVM \u865a\u62df\u673a\u53ef\u7528\u6838\u6570\u4e0d\u662f\u671f\u671b\u7684\u503c\u3002 \u5982\u679c\u7a0b\u5e8f\u6309\u5bbf\u4e3b\u673a\u6838\u6570\u8fdb\u884c\u5de5\u4f5c\uff0c\u9664\u4e86\u5f71\u54cd\u81ea\u8eab\u670d\u52a1\u4ee5\u5916\uff0c\u8fd8\u6709\u53ef\u80fd\u56e0\u4e3a\u8d44\u6e90\u5360\u7528\u8fc7\u591a\u5bfc\u81f4\u5bb9\u5668\u5bbf\u4e3b\u673a\u6545\u969c\u3002</li> </ol> <p>\u5728 JDK8u212 \u4e4b\u540e\u7684 Java \u5bf9\u5bb9\u5668\u7684\u652f\u6301\u5c31\u6bd4\u8f83\u597d\u4e86\uff0c\u53ef\u4ee5\u6b63\u786e\u8bc6\u522b\u5230\u5bb9\u5668\u91cc\u9762\u7684\u5185\u5b58\u548cCPU\u6570\u91cf\u3002\u4f46\u662f\u5347\u7ea7 JDK \u5bf9\u670d\u52a1\u6765\u8bf4\u5c5e\u4e8e\u91cd\u5927\u53d8\u66f4\uff0c\u56e0\u6b64\u6211\u4eec\u5efa\u8bae\u6709\u4ee5\u4e0a\u95ee\u9898\u7684\u670d\u52a1\u5347\u7ea7\u5230\u6700\u4f4e\u53ef\u7528\u7248\u672c JDK8u191\uff0c\u4fdd\u8bc1 jdk \u7684\u6539\u52a8\u5c3d\u53ef\u80fd\u5c0f\u3002</p>"},{"location":"note/zm/#_4","title":"\u5b50\u73af\u5883","text":"<p>\u56e0\u4e3a\u6d4b\u8bd5\u73af\u5883\u53ea\u6709\u4e00\u5957\uff0c\u5982\u679c\u6709\u591a\u4e2a\u9700\u6c42\u8981\u6d4b\uff0c\u5c31\u4f1a\u4ea7\u751f\u51b2\u7a81\u3002\u6240\u4ee5\u63d0\u4f9b\u4e86\u5b50\u73af\u5883\u7684\u529f\u80fd\uff0c\u5b50\u73af\u5883\u53ef\u4ee5\u6709\u591a\u5957\uff0c\u76f8\u5bf9\u7684\u4e3b\u73af\u5883\u5c31\u662fFAT\u73af\u5883\u3002</p> <p>\u5b50\u73af\u5883\u94fe\u8def\u9694\u79bb\u539f\u7406\u662f\u901a\u8fc7\u5728 http \u8bf7\u6c42\u5934\u91cc\u52a0\u585e\u5934\u73af\u5883\u6807\u7b7e\uff0c\u4e0d\u540c\u4e0e Java \u5e94\u7528\u901a\u8fc7 Solar \u6846\u67b6\u585e\u5934\uff0cH5 \u662f\u57fa\u4e8e Nginx \u5b9e\u73b0\u7684\u3002\u7f51\u5173\u6765\u8bc6\u522b\u8bf7\u6c42\u5934\u8fdb\u884c\u8f6c\u53d1\u5230\u76f8\u5e94\u7684\u5b50\u73af\u5883</p> <p></p>"},{"location":"note/zm/#zm-jar","title":"zm jar\u5305\u89c4\u8303","text":"<ul> <li><code>SNAPSHOT</code> \u7248\u672c\u5305\u5efa\u8bae\u547d\u540d\u98ce\u683c: 1.0.0-SNAPSHOT</li> <li><code>RELEASE</code> \u7248\u672c\u5efa\u8bae\u547d\u540d\u98ce\u683c: 1.0.0 \u6216 1.0.0.RELEASE</li> <li><code>RELEASE</code> \u7248\u672c\u4e0d\u80fd Redeploy\uff0c\u5373\u4e00\u4e2a\u7248\u672c\u53ea\u80fd deploy \u4e00\u6b21\u3002\u5982\u6709\u4fee\u6539\u5fc5\u987b\u5347\u7ea7\u7248\u672c\u53f7</li> <li><code>RELEASE</code> \u7248\u672c\u548c <code>SNAPSHOT</code> \u7248\u672c\u90fd\u4e0d\u5141\u8bb8deploy\u540e\u5220\u9664, \u73b0\u5df2\u56de\u6536dev2\u5220\u9664\u6743\u9650</li> <li><code>SNAPSHOT</code> \u7248\u672c\u4e0d\u5141\u8bb8\u4e0a\u751f\u4ea7\u73af\u5883</li> </ul>"},{"location":"note/zm/#_5","title":"\u5e03\u9686\u8fc7\u6ee4\u5668","text":"<p>\u5b66\u751f\u6bcf\u5929\u8981\u5b8c\u6210\u4efb\u52a1\uff0c\u6bcf\u4e2a\u4efb\u52a1\u5b8c\u6210\u53ef\u4ee5\u9886\u53d6\u80fd\u91cf\u679c\uff0c\u4f46\u662f\u8fd9\u4e2atoast\u63d0\u793a\u4e00\u5929\u53ea\u63d0\u793a\u4e00\u6b21\u3002\u591a\u7aef\u8981\u4fdd\u6301\u7edf\u4e00\uff0c\u524d\u7aef\u662f\u6ca1\u6cd5\u63a7\u5236\u7684\uff0c\u6240\u4ee5\u540e\u7aef\u6839\u636euserId\uff0ctaskId\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5f53\u5929\u8fc7\u671f\u3002\u4f7f\u7528redission\u7684\u5e03\u9686\u8fc7\u6ee4\u5668\u6765\u5b9e\u73b0</p> <pre><code>    @Resource\n    private RedissonClient redissonClient;\n\n    /**\n         * \u67e5\u8be2\u5f53\u5929\u662f\u5426\u5df2\u7ecf\u67e5\u8be2\u8fc7\uff0c\u5982\u679c\u67e5\u8fc7\u5c31\u4e0d\u518d\u63d0\u793a\u7528\u6237\u4efb\u52a1toast\n         *\n         * @param userId\n         * @param taskId\n         * @return true-\u5df2\u7ecf\u67e5\u8be2\u8fc7\uff0cfalse-\u6ca1\u6709\u67e5\u8be2\u8fc7\n         */\n    public boolean checkCurrentDateIsQueried(Integer userId, Integer taskId) {\n        String key = \"\" + userId + \"_\" + taskId;\n        RBloomFilter bloomFilter = this.getLocalDateBloomFilter();\n        boolean contains = bloomFilter.contains(key);\n        if (!contains) {\n            bloomFilter.add(key);\n        }\n        return contains;\n    }\n\n    /**\n     * \u83b7\u53d6\u5f53\u5929\u7684\u5e03\u9686\u8fc7\u6ee4\u5668\n     */\n    private RBloomFilter getLocalDateBloomFilter() {\n        String bloomFilterName = \"taskEnergy\" + LocalDate.now().toString();\n        RBloomFilter bloomFilter = redissonClient.getBloomFilter(bloomFilterName);\n        if (bloomFilter.isExists()) {\n            return bloomFilter;\n        }\n        bloomFilter.tryInit(Long.parseLong(taskEnergyBloomFilterExpectedInsertions), 0.01);\n        // \u5f53\u5929\u96f6\u70b9\u8fc7\u671f\n        long epochMilli = LocalDateTime.of(LocalDate.now(), LocalTime.MAX).toInstant(ZoneOffset.of(\"+8\")).toEpochMilli();\n        bloomFilter.expireAt(epochMilli);\n        return bloomFilter;\n    }\n</code></pre>"},{"location":"note/zm/#_6","title":"\u6570\u636e\u5e93","text":""},{"location":"note/zm/#_7","title":"\u65e5\u5fd7","text":"<pre><code>&lt;?xmlversion=\"1.0\"encoding=\"UTF-8\"?&gt;\n&lt;configurationdebug=\"false\"&gt;\n\n&lt;definename=\"appId\"class=\"com.zm.arch.logger.component.common.AppIdDefiner\"/&gt;\n\n&lt;springPropertyscope=\"context\"name=\"springAppName\"source=\"spring.application.name\"/&gt;\n\n&lt;springPropertyscope=\"context\"name=\"logSwitch\"source=\"port.http.server\"/&gt;\n\n&lt;!--logmaxFileSize--&gt;\n&lt;springPropertyscope=\"context\"name=\"MAX_FILE_SIZE\"source=\"spring.logback.max-file-size\"defaultValue=\"100MB\"/&gt;\n\n&lt;!--logmaxIndex--&gt;\n&lt;springPropertyscope=\"context\"name=\"MAX_INDEX\"source=\"spring.logback.max-index\"defaultValue=\"5\"/&gt;\n\n&lt;springPropertyscope=\"context\"name=\"MASK_FIELDS\"source=\"log.mask.fields\"defaultValue=\"message,input_param,output_param,header_param\"/&gt;\n\n&lt;springPropertyscope=\"context\"name=\"MASK_REGEX_TYPES\"source=\"log.mask.regex.types\"defaultValue=\"mobile\"/&gt;\n\n&lt;springPropertyscope=\"context\"name=\"MASK_REGEX_MATCH_MAX_DEPTH\"source=\"log.mask.regex.match.max.depth\"defaultValue=\"12\"/&gt;\n\n&lt;springPropertyscope=\"context\"name=\"MASK_REGEX_MATCH_MAX_LENGTH\"source=\"log.mask.regex.match.max.length\"defaultValue=\"2048\"/&gt;\n\n&lt;conversionRuleconversionWord=\"hostAddress\"\nconverterClass=\"com.zm.arch.logger.component.common.HostAddressConvert\"/&gt;\n\n&lt;!--logbasepath--&gt;\n&lt;propertyname=\"LOG_HOME\"value=\"/opt/logs/${appId}/applog\"/&gt;\n\n&lt;!--STDOUT\u8f93\u51fa\u683c\u5f0f--&gt;\n&lt;propertyname=\"MAX_FILE_SIZE\"\nvalue='%d{yyyy-MM-ddHH:mm:ss.SSS}|%X{X-CAT-ROOT-ID:-}|%X{X-CAT-PARENT-ID:-}|%X{X-CAT-ID:-}|${springAppName:-}|[%thread]|%-5level|%logger{50}-%msg%n'/&gt;\n\n&lt;!--INFO\u8f93\u51fa\u683c\u5f0f--&gt;\n&lt;propertyname=\"INFO_PATTERN\"value='{\n\"host\":\"%hostAddress\",\n\"time\":\"%d{yyyy-MM-ddHH:mm:ss.SSSZ}\",\n\"catRootId\":\"%X{X-CAT-ROOT-ID:-}\",\n\"catParentId\":\"%X{X-CAT-PARENT-ID:-}\",\n\"catId\":\"%X{X-CAT-ID:-}\",\n\"service\":\"${springAppName:-}\",\n\"appId\":\"%X{n-d-service-app-id}\",\n\"serviceId\":\"%X{n-d-service-id}\",\n\"serviceVersion\":\"%X{n-d-service-version}\",\n\"serviceRegion\":\"%X{n-d-service-region}\",\n\"serviceEnv\":\"%X{n-d-service-env}\",\n\"swTraceId\":\"%X{trace-id}\",\n\"level\":\"%level\",\n\"class\":\"%logger\",\n\"message\":\"%message%n%exception{10}\"\n}'/&gt;\n\n&lt;!--WARN\u8f93\u51fa\u683c\u5f0f--&gt;\n&lt;propertyname=\"WARN_PATTERN\"value='{\n\"host\":\"%hostAddress\",\n\"time\":\"%d{yyyy-MM-ddHH:mm:ss.SSSZ}\",\n\"catRootId\":\"%X{X-CAT-ROOT-ID:-}\",\n\"catParentId\":\"%X{X-CAT-PARENT-ID:-}\",\n\"catId\":\"%X{X-CAT-ID:-}\",\n\"service\":\"${springAppName:-}\",\n\"appId\":\"%X{n-d-service-app-id}\",\n\"serviceId\":\"%X{n-d-service-id}\",\n\"serviceVersion\":\"%X{n-d-service-version}\",\n\"serviceRegion\":\"%X{n-d-service-region}\",\n\"serviceEnv\":\"%X{n-d-service-env}\",\n\"swTraceId\":\"%X{trace-id}\",\n\"level\":\"%level\",\n\"class\":\"%logger\",\n\"message\":\"%message%n%exception{10}\"\n}'/&gt;\n\n&lt;!--ERROR\u8f93\u51fa\u683c\u5f0f--&gt;\n&lt;propertyname=\"ERROR_PATTERN\"value='{\n\"host\":\"%hostAddress\",\n\"time\":\"%d{yyyy-MM-ddHH:mm:ss.SSSZ}\",\n\"catRootId\":\"%X{X-CAT-ROOT-ID:-}\",\n\"catParentId\":\"%X{X-CAT-PARENT-ID:-}\",\n\"catId\":\"%X{X-CAT-ID:-}\",\n\"service\":\"${springAppName:-}\",\n\"appId\":\"%X{n-d-service-app-id}\",\n\"serviceId\":\"%X{n-d-service-id}\",\n\"serviceVersion\":\"%X{n-d-service-version}\",\n\"serviceRegion\":\"%X{n-d-service-region}\",\n\"serviceEnv\":\"%X{n-d-service-env}\",\n\"swTraceId\":\"%X{trace-id}\",\n\"level\":\"%level\",\n\"class\":\"%logger\",\n\"message\":\"%message%n%exception{10}\"\n}'/&gt;\n\n&lt;includeresource=\"logback/error-appender.xml\"/&gt;\n&lt;includeresource=\"logback/info-appender.xml\"/&gt;\n&lt;includeresource=\"logback/warn-appender.xml\"/&gt;\n&lt;includeresource=\"logback/stdout-appender.xml\"/&gt;\n&lt;includeresource=\"logback/api-appender.xml\"/&gt;\n&lt;includeresource=\"logback/client-appender.xml\"/&gt;\n\n\n&lt;!--\u65e5\u5fd7\u8f93\u51fa\u7ea7\u522b--&gt;\n&lt;rootlevel=\"INFO\"&gt;\n&lt;appender-refref=\"BASE-FILE-INFO\"/&gt;\n&lt;appender-refref=\"BASE-FILE-WARN\"/&gt;\n&lt;appender-refref=\"BASE-FILE-ERROR\"/&gt;\n&lt;ifcondition='isNull(\"logSwitch\")'&gt;\n&lt;then&gt;\n&lt;appender-refref=\"STDOUT\"/&gt;\n&lt;/then&gt;\n&lt;/if&gt;\n&lt;/root&gt;\n\n&lt;/configuration&gt;\n</code></pre> <p>Jar\u5305\u91cc:</p> <p>INFO\u522b\u914d\u7f6e\uff1a</p> <pre><code>&lt;included&gt;\n\n&lt;!--rootfile--&gt;\n&lt;appendername=\"BASE-FILE-INFO-SYNC\"class=\"ch.qos.logback.core.rolling.RollingFileAppender\"&gt;\n&lt;file&gt;${LOG_HOME}/info.log&lt;/file&gt;\n&lt;rollingPolicyclass=\"ch.qos.logback.core.rolling.FixedWindowRollingPolicy\"&gt;\n&lt;fileNamePattern&gt;${LOG_HOME}/info.%i.log&lt;/fileNamePattern&gt;\n&lt;minIndex&gt;1&lt;/minIndex&gt;\n&lt;maxIndex&gt;${MAX_INDEX}&lt;/maxIndex&gt;\n&lt;/rollingPolicy&gt;\n&lt;triggeringPolicyclass=\"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy\"&gt;\n&lt;maxFileSize&gt;${MAX_FILE_SIZE}&lt;/maxFileSize&gt;\n&lt;/triggeringPolicy&gt;\n&lt;encoderclass=\"net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder\"&gt;\n&lt;jsonGeneratorDecoratorclass=\"com.zm.arch.logger.component.desensitization.RegexMaskingJsonGeneratorDecorator\"&gt;\n&lt;valueMask&gt;\n&lt;paths&gt;${MASK_FIELDS}&lt;/paths&gt;\n&lt;values&gt;${MASK_REGEX_TYPES}&lt;/values&gt;\n&lt;maxDepth&gt;${MASK_REGEX_MATCH_MAX_DEPTH}&lt;/maxDepth&gt;\n&lt;maxLength&gt;${MASK_REGEX_MATCH_MAX_LENGTH}&lt;/maxLength&gt;\n&lt;/valueMask&gt;\n&lt;/jsonGeneratorDecorator&gt;\n&lt;providers&gt;\n&lt;pattern&gt;\n&lt;pattern&gt;${INFO_PATTERN}&lt;/pattern&gt;\n&lt;/pattern&gt;\n&lt;/providers&gt;\n&lt;/encoder&gt;\n&lt;filterclass=\"ch.qos.logback.classic.filter.LevelFilter\"&gt;\n&lt;level&gt;INFO&lt;/level&gt;\n&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;\n&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;\n&lt;/filter&gt;\n&lt;/appender&gt;\n\n&lt;!--\u5f02\u6b65\u8f93\u51fa--&gt;\n&lt;appendername=\"BASE-FILE-INFO\"class=\"ch.qos.logback.classic.AsyncAppender\"&gt;\n&lt;!--\u4e0d\u4e22\u5931\u65e5\u5fd7--&gt;\n&lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;\n&lt;!--\u66f4\u6539\u9ed8\u8ba4\u7684\u961f\u5217\u7684\u6df1\u5ea6,\u8be5\u503c\u4f1a\u5f71\u54cd\u6027\u80fd.\u9ed8\u8ba4\u503c\u4e3a256--&gt;\n&lt;queueSize&gt;256&lt;/queueSize&gt;\n&lt;!--\u6dfb\u52a0\u9644\u52a0\u7684appender,\u6700\u591a\u53ea\u80fd\u6dfb\u52a0\u4e00\u4e2a--&gt;\n&lt;appender-refref=\"BASE-FILE-INFO-SYNC\"/&gt;\n&lt;/appender&gt;\n\n&lt;/included&gt;\n</code></pre> <p>error\u7ea7\u522b\u914d\u7f6e\uff1a</p> <pre><code>&lt;included&gt;\n\n&lt;appendername=\"BASE-FILE-ERROR-SYNC\"class=\"ch.qos.logback.core.rolling.RollingFileAppender\"&gt;\n&lt;file&gt;${LOG_HOME}/error.log&lt;/file&gt;\n&lt;rollingPolicyclass=\"ch.qos.logback.core.rolling.FixedWindowRollingPolicy\"&gt;\n&lt;fileNamePattern&gt;${LOG_HOME}/error.%i.log&lt;/fileNamePattern&gt;\n&lt;minIndex&gt;1&lt;/minIndex&gt;\n&lt;maxIndex&gt;${MAX_INDEX}&lt;/maxIndex&gt;\n&lt;/rollingPolicy&gt;\n&lt;triggeringPolicyclass=\"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy\"&gt;\n&lt;maxFileSize&gt;${MAX_FILE_SIZE}&lt;/maxFileSize&gt;\n&lt;/triggeringPolicy&gt;\n&lt;encoderclass=\"net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder\"&gt;\n&lt;jsonGeneratorDecoratorclass=\"com.zm.arch.logger.component.desensitization.RegexMaskingJsonGeneratorDecorator\"&gt;\n&lt;valueMask&gt;\n&lt;paths&gt;${MASK_FIELDS}&lt;/paths&gt;\n&lt;values&gt;${MASK_REGEX_TYPES}&lt;/values&gt;\n&lt;maxDepth&gt;${MASK_REGEX_MATCH_MAX_DEPTH}&lt;/maxDepth&gt;\n&lt;maxLength&gt;${MASK_REGEX_MATCH_MAX_LENGTH}&lt;/maxLength&gt;\n&lt;/valueMask&gt;\n&lt;/jsonGeneratorDecorator&gt;\n&lt;providers&gt;\n&lt;pattern&gt;\n&lt;pattern&gt;${ERROR_PATTERN}&lt;/pattern&gt;\n&lt;/pattern&gt;\n&lt;/providers&gt;\n&lt;/encoder&gt;\n&lt;filterclass=\"ch.qos.logback.classic.filter.LevelFilter\"&gt;\n&lt;level&gt;ERROR&lt;/level&gt;\n&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;\n&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;\n&lt;/filter&gt;\n&lt;/appender&gt;\n\n&lt;!--\u5f02\u6b65\u8f93\u51fa--&gt;\n&lt;appendername=\"BASE-FILE-ERROR\"class=\"ch.qos.logback.classic.AsyncAppender\"&gt;\n&lt;!--\u4e0d\u4e22\u5931\u65e5\u5fd7--&gt;\n&lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;\n&lt;!--\u66f4\u6539\u9ed8\u8ba4\u7684\u961f\u5217\u7684\u6df1\u5ea6,\u8be5\u503c\u4f1a\u5f71\u54cd\u6027\u80fd.\u9ed8\u8ba4\u503c\u4e3a256--&gt;\n&lt;queueSize&gt;256&lt;/queueSize&gt;\n&lt;!--\u6dfb\u52a0\u9644\u52a0\u7684appender,\u6700\u591a\u53ea\u80fd\u6dfb\u52a0\u4e00\u4e2a--&gt;\n&lt;appender-refref=\"BASE-FILE-ERROR-SYNC\"/&gt;\n&lt;/appender&gt;\n\n&lt;/included&gt;\n</code></pre>"},{"location":"note/zm/#jvm","title":"JVM\u53c2\u6570","text":"<pre><code>{\n\"Xms\": \"-Xms5734m\",\n\"Xmx\": \"-Xmx5734m\",\n\"XX:PermSize\": \"-XX:PermSize=256M\",\n\"XX:MaxNewSize\": \"-XX:MaxNewSize=1536m\",\n\"XX:MaxPermSize\": \"-XX:MaxPermSize=256m\",\n\"Djava.awt.headless\": \"-Djava.awt.headless=true\",\n\"prometheus\": \"-javaagent:/usr/jmx_prometheus/jmx_prometheus_javaagent-0.11.1.jar=9150:/usr/jmx_prometheus/config.yaml\",\n\"skywalking\": \"-javaagent:/usr/skywalking-apm/skywalking-agent-2.5.0-RELEASE/skywalking-agent.jar\",\n\"Dskywalking.agent.service_name\": \"-Dskywalking.agent.service_name=client-hub-chat@10118\"\n}\n</code></pre> <p>https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html</p> <p>\u5806\u53c2\u6570\uff1a</p> \u53c2\u6570 \u63cf\u8ff0 -Xms \u8bbe\u7f6eJVM\u542f\u52a8\u65f6\u5806\u7684\u521d\u59cb\u5316\u5927\u5c0f\u3002 -Xmx \u8bbe\u7f6e\u5806\u6700\u5927\u503c\u3002 -Xmn \u8bbe\u7f6e\u5e74\u8f7b\u4ee3\u7684\u7a7a\u95f4\u5927\u5c0f\uff0c\u5269\u4e0b\u7684\u4e3a\u8001\u5e74\u4ee3\u7684\u7a7a\u95f4\u5927\u5c0f\u3002 -XX:PermGen \u8bbe\u7f6e\u6c38\u4e45\u4ee3\u5185\u5b58\u7684\u521d\u59cb\u5316\u5927\u5c0f\u3002 -XX:SurvivorRatio \u63d0\u4f9bEden\u533a\u548csurvivor\u533a\u7684\u7a7a\u95f4\u6bd4\u4f8b\u3002\u6bd4\u5982\uff0c\u5982\u679c\u5e74\u8f7b\u4ee3\u7684\u5927\u5c0f\u4e3a10m\u5e76\u4e14VM\u5f00\u5173\u662f-XX:SurvivorRatio=2\uff0c\u90a3\u4e48\u5c06\u4f1a\u4fdd\u75595m\u5185\u5b58\u7ed9Eden\u533a\u548c\u6bcf\u4e2aSurvivor\u533a\u5206\u914d2.5m\u5185\u5b58\u3002\u9ed8\u8ba4\u6bd4\u4f8b\u662f8\u3002 -XX:NewRatio \u63d0\u4f9b\u5e74\u8001\u4ee3\u548c\u5e74\u8f7b\u4ee3\u7684\u6bd4\u4f8b\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u662f2\u3002"},{"location":"note/zm/#_8","title":"\u524d\u7aef\u7070\u5ea6\u53d1\u5e03","text":"<p>\u4e4b\u524d\u901a\u8fc7\u7070\u5ea6\u673a\u5668\u7684\u65b9\u5f0f\uff0c\u9700\u8981\u7533\u8bf7\u65b0\u57df\u540d\u3002</p> <p>\u76ee\u524d\u7f51\u5173\u673a\u5668\u53bb\u5e749\u53f0\u4eca\u5e7415\u53f0\uff0c\u65e2\u8d1f\u8d23\u7f51\u5173\u8f6c\u53d1\uff0c\u4e5f\u90e8\u7f72\u524d\u7aef\u3002\u6240\u4ee5nginx \u8981\u8f6c\u53d1\u672c\u5730\u7684\u524d\u7aef\u4ee3\u7801\uff0c\u8fd8\u8981\u8d1f\u8d23\u8f6c\u53d1\u540e\u7aef\u63a5\u53e3\u3002 </p> <p>\u8981\u628a\u524d\u7aef\u9879\u76ee\u62c6\u51fa\u53bb\uff0c\u4e0d\u8981\u548c\u7f51\u5173\u653e\u5728\u4e00\u8d77\uff0c\u4e24\u53f0\u5c31\u8db3\u591f\u4e86\u3002\u518d\u52a0\u4e0a\u524d\u7aef\u6587\u4ef6CDN \u5904\u7406\u3002</p> <p>\u539f\u7406\uff1a</p> <p>\u524d\u7aef\u4e00\u53f0\u673a\u5668\u90e8\u7f72\u4e86\u4e24\u5957\u4e0d\u540c\u7248\u672c\u524d\u7aef\u4ee3\u7801\uff0c\u63a5\u53e3\u8bf7\u6c42\u8fc7\u6765\u540e\uff0c\u53bb\u5229\u7528apollo\u7684\u914d\u7f6e\uff0c\u62c9\u5230\u5bf9\u5e94\u5e94\u7528\u7684\u914d\u7f6e\uff0clua \u811a\u672c\uff0c\u7136\u540e\u6839\u636enginx \u89c4\u5219\u53bb\u627e\u5230\u5bf9\u5e94\u7684location \u76ee\u5f55\u3002\u79d2\u7ea7\u751f\u6548</p> <p>\u6839\u636e\u624b\u673a\u7cfb\u7edf\u7248\u672c\u914d\u7f6e</p> <p>\u6839\u636e\u53c2\u6570\u5982cookie \uff0cquery \u53c2\u6570\u6765\u914d\u7f6e</p> <p>\u6839\u636eip \u53bb\u5339\u914d\uff0c\u6027\u80fd\u4f1a\u964d\u4f4e\uff0c\u628a\u524d\u7aef\u4ece\u7f51\u5173\u673a\u5668\u62c6\u51fa\u53bb\u4f1a\u597d\u70b9\u3002\u6709\u7684\u751a\u81f3\u628a\u79c1\u57dfip \u66b4\u9732\u51fa\u53bb</p> <p>\u524d\u540e\u7aef\u4e00\u8d77\u7070\u5ea6\u7684\u60c5\u51b5\u5f88\u5c11\uff0c\u6240\u4ee5\u53ea\u8003\u8651\u5404\u81ea\u5355\u72ec\u7070\u5ea6\u7684</p>"},{"location":"note/zm/#_9","title":"\u5176\u4ed6","text":"<p>nacos\u4e0a\u670d\u52a1960\u591a\u4e2a\uff0c\u5b9e\u4f8b3000\u591a\u4e2a\u3002</p> <p>Apollo\u5e94\u8be5\u662f\u6ce8\u518c\u5728nacos\u4e0a\u4e86\uff0c\u90e8\u7f72\u4e865\u4e2a\u5b9e\u4f8b</p> <p></p>"},{"location":"tools/github/","title":"Github","text":"<p>@\u7528\u6237\u540d\u53ef\u4ee5\u53d1\u9001\u90ae\u4ef6\u901a\u77e5\u5bf9\u5e94\u7684\u4eba\uff0c\u4e5f\u53ef\u4ee5@\u7ec4\u7ec7/\u56e2\u961f\u540d\uff0c\u56e2\u961f\u6240\u6709\u4eba\u90fd\u53ef\u4ee5\u6536\u5230\u901a\u77e5\u3002</p> <p>#issueID \u53ef\u4ee5\u751f\u6210\u6307\u5411issue\u7684\u94fe\u63a5\uff0c\u53ef\u4ee5\u5199\u5728\u63d0\u4ea4\u4fe1\u606f\u91cc\uff0c\u53ef\u4ee5\u5199\u5728pull request\u4e2d</p>"},{"location":"tools/github/#pull-request","title":"pull request:","text":"<p>\u63a5\u53d7pr\uff1a</p> <p>\u53ef\u4ee5\u76f4\u63a5\u5728\u7f51\u9875\u8fdb\u884c\u5ba1\u67e5\uff0cmerge</p> <p>\u4e5f\u53ef\u4ee5\u4e0b\u8f7d\u5230\u672c\u5730\u3002\u5148git remote add \u8fdc\u7a0b\u4ed3\u5e93\uff0c\u7136\u540e\u521b\u5efa\u7528\u4e8e\u68c0\u67e5\u7684\u65b0\u5206\u652f\u5982pr1\uff0cmerge \u8fdc\u7a0b/work\uff0c\u67e5\u770b\u662f\u5426\u6709\u95ee\u9898\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u95ee\u9898\uff0c\u5c31\u5207\u56de\u4e3b\u5206\u652f\uff0cmerge \u8fdc\u7a0b/work \u3002</p>"},{"location":"tools/github/#github","title":"\u5c06GitHub\u5f15\u5165\u4f01\u4e1a\uff1a","text":"<p>\u53ef\u4ee5\u7701\u53bb\u642d\u5efa\u670d\u52a1\u5668\u7684\u6210\u672c\uff0c\u5229\u4e8e\u7a0b\u5e8f\u5458\u5feb\u901f\u4e0a\u624b\u3002</p> <p>\u4f46\u662f\u8981\u6ce8\u610f\u7ef4\u62a4\u65f6\u95f4\u548c\u6545\u969c\u4fe1\u606f\uff0c\u5b98\u7f51\u535a\u5ba2\u4e0a\u6709\u53d1\u5e03\u3002</p> <p>\u4e5f\u53ef\u4ee5\u5f15\u5165GitHub Enterprise</p> <p>\u9002\u5408\u62e5\u6709\u5927\u91cf\u7a0b\u5e8f\u5458\uff0c\u548c\u5df2\u6709\u670d\u52a1\u5668\uff0c\u6216\u8005\u4e0d\u613f\u610f\u6e90\u4ee3\u7801\u5916\u7f51\u6d41\u4f20\u7684\u3002</p> <p>\u9700\u8981\u82b1\u94b1\uff0c\u800c\u4e14\u53ef\u80fd\u53d1\u751f\u6545\u969c\uff0c\u867d\u7136\u5ba2\u670d\u56de\u590d\u5f88\u5feb\u3002</p> <p>\u56fd\u5185\u6bd4\u8f83\u6d41\u884cgitlab</p>"},{"location":"tools/github/#gist","title":"Gist","text":"<p>\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u65e5\u5fd7\uff0c\u4ee3\u7801\u7247\u6bb5\uff0c\u5b9e\u4f8b\u4ee3\u7801\u7b49\uff0c\u5e76\u4e14\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u8fdb\u884c\u5206\u4eab\u3002\u8bb0\u5f55\u5386\u53f2\u7248\u672c</p> <p>\u53ef\u4ee5\u56fd\u5185\u7528\u4e0d\u4e86\u3002</p>"},{"location":"tools/maven/","title":"1. \u5982\u4f55\u53d1\u5e03\u9879\u76ee\u5230\u79c1\u670d","text":"<p>\u5728pom\u6587\u4ef6\u91cc\u914d\u7f6e\u5982\u4e0b</p> <pre><code>&lt;distributionManagement&gt;\n  &lt;repository&gt;\n    &lt;id&gt;releases&lt;/id&gt;\n    &lt;url&gt;http://localhost:8081/nexus/content/repositories/releases&lt;/url&gt;\n  &lt;/repository&gt;\n &lt;snapshotRepository&gt;\n    &lt;id&gt;snapshots&lt;/id&gt;\n    &lt;url&gt;http://localhost:8081/nexus/content/repositories/snapshots&lt;/url&gt;\n  &lt;/snapshotRepository&gt;\n&lt;/distributionManagement&gt;\n</code></pre> <p>\u5728setting.conf\u914d\u7f6e\u5982\u4e0b</p> <pre><code>&lt;server&gt;  \n  &lt;id&gt;releases&lt;/id&gt;  \n  &lt;username&gt;admin&lt;/username&gt;  \n  &lt;password&gt;admin123&lt;/password&gt;  \n&lt;/server&gt;  \n&lt;server&gt;  \n  &lt;id&gt;snapshots&lt;/id&gt;  \n  &lt;username&gt;admin&lt;/username&gt;  \n  &lt;password&gt;admin123&lt;/password&gt;  \n&lt;/server&gt;  \n</code></pre> <p>\u7136\u540emvn deploy</p>"},{"location":"tools/maven/#2","title":"2. \u53d1\u5e03\u6e90\u7801\u5230\u4ed3\u5e93","text":"<pre><code>&lt;!-- \u8fd9\u4e2a\u63d2\u4ef6\u53ef\u4ee5\u5728\u53d1\u5e03jar\u5305\u5230\u4ed3\u5e93\u65f6\u5c06\u6e90\u7801\u4e5f\u4e0a\u4f20\u5230\u4ed3\u5e93--&gt;\n&lt;plugin&gt;\n  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n  &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;\n  &lt;executions&gt;\n    &lt;execution&gt;\n      &lt;id&gt;attach-sources&lt;/id&gt;\n      &lt;goals&gt;\n        &lt;goal&gt;jar&lt;/goal&gt;\n      &lt;/goals&gt;\n    &lt;/execution&gt;\n  &lt;/executions&gt;\n&lt;/plugin&gt;\n</code></pre>"},{"location":"tools/maven/#_1","title":"\u57fa\u672c\u6982\u5ff5","text":"<p>repository \u7b80\u5355\u70b9\u6765\u8bf4\u5c31\u662f\u4e2a\u4ed3\u5e93\u3002maven\u91cc\u6709\u4e24\u79cd\u4ed3\u5e93\uff0c\u672c\u5730\u4ed3\u5e93\u548c\u8fdc\u7a0b\u4ed3\u5e93\u3002\u8fdc\u7a0b\u4ed3\u5e93\u76f8\u5f53\u4e8e\u516c\u5171\u7684\u4ed3\u5e93\uff0c\u5927\u5bb6\u90fd\u80fd\u770b\u5230\u3002\u672c\u5730\u4ed3\u5e93\u662f\u4f60\u672c\u5730\u7684\u4e00\u4e2a\u5c71\u5be8\u7248\uff0c\u53ea\u6709\u4f60\u770b\u7684\u5230\uff0c\u4e3b\u8981\u8d77\u7f13\u5b58\u4f5c\u7528\u3002\u5f53\u4f60\u5411\u4ed3\u5e93\u8bf7\u6c42\u63d2\u4ef6\u6216\u4f9d\u8d56\u7684\u65f6\u5019\uff0c\u4f1a\u5148\u68c0\u67e5\u672c\u5730\u4ed3\u5e93\u91cc\u662f\u5426\u6709\u3002\u5982\u679c\u6709\u5219\u76f4\u63a5\u8fd4\u56de\uff0c\u5426\u5219\u4f1a\u5411\u8fdc\u7a0b\u4ed3\u5e93\u8bf7\u6c42\uff0c\u5e76\u505a\u7f13\u5b58\u3002\u4f60\u4e5f\u53ef\u4ee5\u628a\u4f60\u505a\u7684\u4e1c\u897f\u4e0a\u4f20\u5230\u672c\u5730\u4ed3\u5e93\u7ed9\u4f60\u672c\u5730\u81ea\u5df1\u7528\uff0c\u6216\u4e0a\u4f20\u5230\u8fdc\u7a0b\u4ed3\u5e93\uff0c\u4f9b\u5927\u5bb6\u4f7f\u7528\u3002</p> <p>\u4e2d\u592e\u4ed3\u5e93https://repo1.maven.org/maven2/\u53bb\u8bf7\u6c42\u63d2\u4ef6\u548c\u4f9d\u8d56\u5305\u3002</p> <p>mirror\u5c31\u662f\u955c\u50cf\uff0c\u4e3b\u8981\u63d0\u4f9b\u4e00\u4e2a\u65b9\u4fbf\u5730\u5207\u6362\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\u7684\u9014\u5f84\u3002</p> <p>\u5982\u60f3\u8981\u5229\u7528\u963f\u91cc\u4e91\u7684\u955c\u50cf\u5b9e\u73b0\u52a0\u901f\u8bbf\u95ee\uff0c\u5373\u53ef\u4ee5\u7ed9id\u4e3acentral\u7684\u8fdc\u7a0b\u4ed3\u5e93\u505a\u4e2a\u955c\u50cf\u3002\u4ee5\u540e\u5411central\u8fd9\u4e2a\u4ed3\u5e93\u53d1\u7684\u8bf7\u6c42\u90fd\u4f1a\u53d1\u5230http://maven.aliyun.com/nexus/content/groups/public/\u800c\u4e0d\u662f\u53bb\u4e2d\u592e\u4ed3\u5e93\u4e86\u3002</p> <pre><code>&lt;mirror&gt;\n  &lt;id&gt;alimaven&lt;/id&gt;  \n  &lt;name&gt;aliyun maven&lt;/name&gt;  \n  &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;  \n  &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;  \n&lt;/mirror&gt;\n</code></pre> <p><code>&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</code>\u91cc\u662f\u8981\u66ff\u4ee3\u7684\u4ed3\u5e93\u7684id\u3002\u5982\u679c\u586b*\uff0c\u5c31\u4f1a\u66ff\u4ee3\u6240\u6709\u4ed3\u5e93\u3002</p>"},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/","title":"\u4ee3\u7801\u6574\u6d01\u4e4b\u9053","text":"<p>\u4ec0\u4e48\u662f\u597d\u7684\u4ee3\u7801\uff1f</p> <p>\u7b80\u5355\uff0c\u53ef\u8bfb\u6027\u5f3a\uff0c\u5177\u5907\u53ef\u6d4b\u6027\uff0c\u53ef\u6301\u7eed\u91cd\u6784\u3002</p> <p>SOLID</p> <p></p> <p>\u4ec0\u4e48\u662f\u574f\u7684\u4ee3\u7801\uff1f</p> <ul> <li>\u8fc7\u5927\u7684\u7c7b\uff1b</li> <li>\u96be\u4e8e\u7406\u89e3\u96be\u4e8e\u9605\u8bfb\uff0c\u547d\u540d\u6df7\u4e71\uff0c\u7ed3\u6784\u6df7\u4e71\uff0c</li> <li> <p>\u8fc7\u957f\u7684\u65b9\u6cd5\u51fd\u6570\uff0c\u8fc7\u957f\u7684\u53c2\u6570\u5217\uff0c\u4e34\u65f6\u53d8\u91cf\u8fc7\u591a\uff0c\u4e0d\u5229\u4e8e\u7406\u89e3\u548c\u62bd\u53d6\uff1b\u91cd\u590d\u4ee3\u7801</p> </li> <li> <p>\u4e00\u4e2a\u7c7b\u5927\u91cf\u5f15\u7528\u4e86\u53e6\u4e00\u4e2a\u7c7b\u7684\u6570\u636e\uff1b</p> </li> <li>\u8fc7\u5ea6\u8bbe\u8ba1\uff0c\u8fc7\u591a\u7684\u62bd\u8c61\u3002\u5f00\u59cb\u5e94\u8be5\u7b80\u5355\u8bbe\u8ba1\uff0c\u53d8\u5316\u6765\u7684\u65f6\u5019\u518d\u91cd\u6784</li> </ul>"},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/#_2","title":"\u547d\u540d\u7684\u6574\u6d01","text":"<p>\u547d\u540d\u662f\u4e00\u4ef6\u96be\u4e8b\uff0c\u53ef\u4ee5\u8feb\u4f7f\u4f60\u53bb\u601d\u8003\u4f60\u7684\u7c7b\u5230\u5e95\u8981\u5b9e\u73b0\u4ec0\u4e48\u529f\u80fd\u3002</p> <p>Java\u5e38\u89c1\u547d\u540d\u89c4\u8303\uff1a\u5305\u540d\u5c0f\u5199\uff0c\u53d8\u91cf/\u65b9\u6cd5\u540d\u9a7c\u5cf0\uff0c\u5e38\u91cf\u5927\u5199\uff0c\u679a\u4e3e\u503c\u5927\u5199</p> <p>\u547d\u540d\u539f\u5219\uff1a\u89c1\u540d\u77e5\u610f\uff0c\u907f\u514d\u8bef\u62a5(Strin[] accountList)\uff0c\u8bfb\u5f97\u51fa\u6765\uff0c\u7ea6\u5b9a\u4fd7\u6210(DNS,avg,min)\uff0c\u7edf\u4e00\u89c4\u8303</p> <p>\u547d\u540d\u5de5\u5177\uff1ahttps://unbug.github.io/codelf/</p> <p></p>"},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/#_3","title":"\u7c7b\u7684\u6574\u6d01","text":"<p>\u4f18\u5148\u8003\u8651\u4f7f\u7528\u7ec4\u5408\uff0c\u800c\u4e0d\u662f\u7ee7\u627f\uff01\uff01</p> <p>\u5982coffe\u7c7b\uff0c\u65b0\u589e\u5de7\u514b\u529bcoffee\uff0c\u65e0\u7cd6coffee\uff0c\u65e0\u7cd6\u5de7\u514b\u529bcoffee\u3002\u7ee7\u627f\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u591a\u7ee7\u627f\uff0c\u6700\u91cd\u8981\u7684\u4e0d\u597d\u7406\u89e3\uff0c\u5c24\u5176\u662fdebug\u65f6\u6765\u56de\u8df3\u8f6c\u3002</p>"},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/#_4","title":"\u51fd\u6570\u7684\u6574\u6d01","text":"<ul> <li>\u5408\u7406\u7684\u53c2\u6570\uff1a\u5c3d\u91cf\u96f6\u53c2\u6570\uff0c\u53c2\u6570\u8d8a\u591a\u8d8a\u4e0d\u597d\u7406\u89e3\uff1b\u907f\u514d\u4e09\u4e2a\u53c2\u6570\u4ee5\u4e0a\uff0c\u8fc7\u591a\u5c31\u5e94\u8be5\u5c01\u88c5\u6210\u5bf9\u8c61</li> <li>\u4fdd\u6301\u540c\u4e00\u5c42\u7ea7\uff1alocal,remote\uff0c\u4e0d\u80fdlocal2\uff0clocal2\uff0cremote\u3002</li> <li>\u907f\u514d\u526f\u4f5c\u7528\uff1a\u4e0d\u80fd\u5728isExired()\u91cc\u505a\u5982\u679c\u8fc7\u671f\u5c31\u5220\u9664\u7684\u903b\u8f91\uff0c\u5982\u679c\u8981\u505a\u5e94\u8be5\u6539\u6210delKeyIfExpired( )</li> <li>\u5f02\u5e38\u4ee3\u66ff\u9519\u8fd4\u56de\u7801\u3002\u6709\u65f6\u53ef\u4ee5\u5ffd\u7565\u5f02\u5e38\uff0c\u4f46\u662f\u4e00\u5b9a\u8981\u52a0\u6ce8\u91ca wont happend,ignore\u7b49\u8868\u660e\u4e0d\u662f\u5fd8\u4e86\uff0c\u800c\u4e14\u771f\u7684\u4e0d\u4f1a\u53d1\u751f\u3002\u629b\u51fa\u5f02\u5e38\u65f6\u5c3d\u91cf\u5177\u4f53\u5f02\u5e38\uff1b\u4e5f\u4e0d\u8981\u7528\u5f02\u5e38\u6765\u63a7\u5236\u6d41\u7a0b</li> </ul>"},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/#_5","title":"\u6ce8\u91ca\u7684\u6574\u6d01","text":"<p>\u5e9f\u8bdd\uff0c\u751a\u81f3\u9519\u8bef\u7684\u6ce8\u91ca</p>"},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/#_6","title":"\u683c\u5f0f\u7684\u6574\u6d01","text":""},{"location":"tools/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81/#_7","title":"\u5355\u5143\u6d4b\u8bd5","text":"<p>\u5176\u5b9e\u5199\u5355\u5143\u6d4b\u8bd5\u5f88\u96be\uff0c\u5199\u51fa\u6ee1\u8db3\u81ea\u52a8\u5316\uff0c\u72ec\u7acb\u6027\uff0c\u53ef\u91cd\u590d\uff08\u4e0d\u4f9d\u8d56\u5916\u90e8\u73af\u5883\uff0c\u7f51\u7edc\uff0c\u4e2d\u95f4\u7b49\uff09\u7684\u6d4b\u8bd5\u4ee3\u7801\u5f88\u96be</p>"}]}